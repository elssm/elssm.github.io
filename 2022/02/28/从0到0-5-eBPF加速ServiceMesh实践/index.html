<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Cloud Security,">










<meta name="description" content="环境准备Docker安装安装依赖12sudo apt updatesudo apt install apt-transport-https ca-certificates curl gnupg-agent software-properties-common 导入存储库的GPG密钥1curl -fsSL https://download.docker.com/linux/ubuntu/gpg |">
<meta name="keywords" content="Cloud Security">
<meta property="og:type" content="article">
<meta property="og:title" content="从0到0.5:eBPF加速ServiceMesh实践">
<meta property="og:url" content="elssm.github.io/2022/02/28/从0到0-5-eBPF加速ServiceMesh实践/index.html">
<meta property="og:site_name" content="ELSSM&#39;s Blog">
<meta property="og:description" content="环境准备Docker安装安装依赖12sudo apt updatesudo apt install apt-transport-https ca-certificates curl gnupg-agent software-properties-common 导入存储库的GPG密钥1curl -fsSL https://download.docker.com/linux/ubuntu/gpg |">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="/2022/02/28/从0到0-5-eBPF加速ServiceMesh实践/1.png">
<meta property="og:image" content="/2022/02/28/从0到0-5-eBPF加速ServiceMesh实践/2.png">
<meta property="og:updated_time" content="2022-03-08T03:16:03.067Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从0到0.5:eBPF加速ServiceMesh实践">
<meta name="twitter:description" content="环境准备Docker安装安装依赖12sudo apt updatesudo apt install apt-transport-https ca-certificates curl gnupg-agent software-properties-common 导入存储库的GPG密钥1curl -fsSL https://download.docker.com/linux/ubuntu/gpg |">
<meta name="twitter:image" content="/2022/02/28/从0到0-5-eBPF加速ServiceMesh实践/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="elssm.github.io/2022/02/28/从0到0-5-eBPF加速ServiceMesh实践/">





  <title>从0到0.5:eBPF加速ServiceMesh实践 | ELSSM's Blog</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ELSSM's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="elssm.github.io/2022/02/28/从0到0-5-eBPF加速ServiceMesh实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Elssm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/author2.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ELSSM's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">从0到0.5:eBPF加速ServiceMesh实践</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-02-28T13:06:42+08:00">
                2022-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h4><h5 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h5><h6 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install apt-transport-https ca-certificates curl gnupg-agent software-properties-common</span><br></pre></td></tr></table></figure>
<h6 id="导入存储库的GPG密钥"><a href="#导入存储库的GPG密钥" class="headerlink" title="导入存储库的GPG密钥"></a>导入存储库的GPG密钥</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure>
<h6 id="添加Docker-APT存储库到系统"><a href="#添加Docker-APT存储库到系统" class="headerlink" title="添加Docker APT存储库到系统"></a>添加Docker APT存储库到系统</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"</span><br></pre></td></tr></table></figure>
<h6 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
<p>docker版本：20.10.12</p>
<p>查看docker服务启动状况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# systemctl status docker</span><br><span class="line">● docker.service - Docker Application Container Engine</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled</span><br><span class="line">   Active: active (running) since Thu 2022-02-10 07:23:33 UTC; 10min ago</span><br><span class="line">     Docs: https://docs.docker.com</span><br><span class="line"> Main PID: 2663 (dockerd)</span><br><span class="line">    Tasks: 9</span><br><span class="line">   CGroup: /system.slice/docker.service</span><br><span class="line">           └─2663 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.so</span><br><span class="line"></span><br><span class="line">Feb 10 07:23:32 ubuntu dockerd[2663]: time="2022-02-10T07:23:32.763625795Z" level=warn</span><br><span class="line">Feb 10 07:23:32 ubuntu dockerd[2663]: time="2022-02-10T07:23:32.763656800Z" level=warn</span><br><span class="line">Feb 10 07:23:32 ubuntu dockerd[2663]: time="2022-02-10T07:23:32.763676563Z" level=warn</span><br><span class="line">Feb 10 07:23:32 ubuntu dockerd[2663]: time="2022-02-10T07:23:32.764235662Z" level=info</span><br><span class="line">Feb 10 07:23:32 ubuntu dockerd[2663]: time="2022-02-10T07:23:32.961536719Z" level=info</span><br><span class="line">Feb 10 07:23:33 ubuntu dockerd[2663]: time="2022-02-10T07:23:33.039790463Z" level=info</span><br><span class="line">Feb 10 07:23:33 ubuntu dockerd[2663]: time="2022-02-10T07:23:33.070305288Z" level=info</span><br><span class="line">Feb 10 07:23:33 ubuntu dockerd[2663]: time="2022-02-10T07:23:33.070463909Z" level=info</span><br><span class="line">Feb 10 07:23:33 ubuntu systemd[1]: Started Docker Application Container Engine.</span><br></pre></td></tr></table></figure>
<h5 id="Kubernetes安装"><a href="#Kubernetes安装" class="headerlink" title="Kubernetes安装"></a>Kubernetes安装</h5><h6 id="安装https工具使得apt支持ssl传输"><a href="#安装https工具使得apt支持ssl传输" class="headerlink" title="安装https工具使得apt支持ssl传输"></a>安装https工具使得apt支持ssl传输</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br></pre></td></tr></table></figure>
<h6 id="使用阿里云的源"><a href="#使用阿里云的源" class="headerlink" title="使用阿里云的源"></a>使用阿里云的源</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -</span><br><span class="line">echo "deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main" &gt; /etc/apt/sources.list.d/kubernetes.list</span><br></pre></td></tr></table></figure>
<h6 id="或使用中科大的源"><a href="#或使用中科大的源" class="headerlink" title="或使用中科大的源"></a>或使用中科大的源</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">deb http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial main</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>更新apt报错如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  The following signatures couldn't be verified because the public key is not available: NO_PUBKEY FEEA9169307EA071 NO_PUBKEY 8B57C5C2836F4BEB</span><br><span class="line">Reading package lists... Done</span><br><span class="line">W: GPG error: http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY FEEA9169307EA071 NO_PUBKEY 8B57C5C2836F4BEB</span><br><span class="line">E: The repository 'http://mirrors.ustc.edu.cn/kubernetes/apt kubernetes-xenial InRelease' is not signed.</span><br><span class="line">N: Updating from such a repository can't be done securely, and is therefore disabled by default.</span><br><span class="line">N: See apt-secure(8) manpage for repository creation and user configuration details.</span><br></pre></td></tr></table></figure>
<p>报错提示我们需要制作一个key，其中<code>836F4BEB</code>是<code>NO_PUBKEY</code>的后八位</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg --keyserver keyserver.ubuntu.com --recv-keys 836F4BEB</span><br><span class="line">gpg --export --armor  836F4BEB | sudo apt-key add -</span><br></pre></td></tr></table></figure>
<p>之后重新<code>apt-get update</code>即可</p>
<h6 id="下载相关工具"><a href="#下载相关工具" class="headerlink" title="下载相关工具"></a>下载相关工具</h6><p>修改docker的<code>daemon.json</code>，将cgroup驱动和k8s设置为一致</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu1:~# cat /etc/docker/daemon.json</span><br><span class="line">    &#123;</span><br><span class="line">        "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">        "registry-mirrors": [</span><br><span class="line">        "https://docker.mirrors.ustc.edu.cn/",</span><br><span class="line">        "https://hub-mirror.c.163.com"],</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install -y kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>
<h6 id="查看k8s版本"><a href="#查看k8s版本" class="headerlink" title="查看k8s版本"></a>查看k8s版本</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl version</span><br><span class="line">Client Version: version.Info&#123;Major:"1", Minor:"23", GitVersion:"v1.23.3", GitCommit:"816c97ab8cff8a1c72eccca1026f7820e93e0d25", GitTreeState:"clean", BuildDate:"2022-01-25T21:25:17Z", GoVersion:"go1.17.6", Compiler:"gc", Platform:"linux/amd64"&#125;</span><br><span class="line">Server Version: version.Info&#123;Major:"1", Minor:"23", GitVersion:"v1.23.3", GitCommit:"816c97ab8cff8a1c72eccca1026f7820e93e0d25", GitTreeState:"clean", BuildDate:"2022-01-25T21:19:12Z", GoVersion:"go1.17.6", Compiler:"gc", Platform:"linux/amd64"&#125;</span><br></pre></td></tr></table></figure>
<h6 id="初始化master节点"><a href="#初始化master节点" class="headerlink" title="初始化master节点"></a>初始化master节点</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">--apiserver-advertise-address=192.168.19.84 \</span><br><span class="line">--image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>
<h6 id="配置kubectl工具"><a href="#配置kubectl工具" class="headerlink" title="配置kubectl工具"></a>配置kubectl工具</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<h6 id="查看节点状态"><a href="#查看节点状态" class="headerlink" title="查看节点状态"></a>查看节点状态</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl get nodes</span><br><span class="line">NAME     STATUS     ROLES                  AGE   VERSION</span><br><span class="line">ubuntu   NotReady   control-plane,master   15m   v1.23.3</span><br></pre></td></tr></table></figure>
<p>状态显示为<code>NotReady</code>，查看日志，发现没有安装网络插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# journalctl -u kubelet -f</span><br><span class="line">-- Logs begin at Mon 2020-02-24 09:48:27 UTC. --</span><br><span class="line">Feb 10 08:08:58 ubuntu kubelet[11230]: I0210 08:08:58.892005   11230 cni.go:240] "Unable to update cni config" err="no networks found in /etc/cni/net.d"</span><br></pre></td></tr></table></figure>
<h6 id="安装pod插件flannel"><a href="#安装pod插件flannel" class="headerlink" title="安装pod插件flannel"></a>安装pod插件flannel</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">Warning: policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+</span><br><span class="line">podsecuritypolicy.policy/psp.flannel.unprivileged created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.apps/kube-flannel-ds created</span><br></pre></td></tr></table></figure>
<h6 id="再次查看节点状态"><a href="#再次查看节点状态" class="headerlink" title="再次查看节点状态"></a>再次查看节点状态</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES                  AGE   VERSION</span><br><span class="line">ubuntu   Ready    control-plane,master   18m   v1.23.3</span><br></pre></td></tr></table></figure>
<h6 id="允许master部署pod"><a href="#允许master部署pod" class="headerlink" title="允许master部署pod"></a>允许master部署pod</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>
<h4 id="服务网格"><a href="#服务网格" class="headerlink" title="服务网格"></a>服务网格</h4><p>服务网格是一个专注于处理服务间通信的基础设施层，它负责在现代云原生应用组成的复杂网络拓扑中可靠的传递请求</p>
<p>服务网格特点</p>
<ul>
<li>轻量级的网络代理</li>
<li>应用无感知</li>
<li>应用之间的流量由服务网格接管</li>
<li>服务间的调用可能出现的超时、重试、监控、追踪等工作下沉到服务网格层处理</li>
</ul>
<p>网格一般由数据平面和控制平面组成，数据平面负责在服务中部署一个sidecar的请求代理，控制平面负责请求代理之间的交互，以及用户与请求代理的交互。</p>
<h5 id="Istio"><a href="#Istio" class="headerlink" title="Istio"></a>Istio</h5><p>通过负载均衡、service-to-service身份验证、监视等方法，Istio可以轻松地创建部署服务网格，而服务代码更改很少或没有更改，我们可以在整个环境中部署一个特殊的sidecar代理来为服务添加Istio支持，该代理可以拦截微服务之间的所有网络通信，然后使用其控制平面功能来配置和管理Istio，其中包括：</p>
<ul>
<li>HTTP、gRPC、WebSocket和TCP流量的自动负载平衡</li>
<li>使用丰富的路由规则、重试、故障转移和故障注入对流量欣慰进行细粒度控制</li>
<li>支持访问控制、速率限制和配额的可插拔策略层和配置API</li>
<li>集群内所有流量的自动度量、日志和跟踪，包括集群入口和出口</li>
<li>在具有强大的基于身份的身份验证和授权的集群中实现安全的服务到服务通信</li>
</ul>
<p>Istio的核心功能</p>
<h6 id="流量管理"><a href="#流量管理" class="headerlink" title="流量管理"></a>流量管理</h6><p>Istio的简单规则配置和流量路由允许控制服务之间的流量和API调用流，Istio简化了服务级属性(如断路器，超时和重试)的配置，并且简化了设置重要任务(如A/B测试，金丝雀测试和按百分比划分的分阶段测试)的工作。有了过呢好的流量可视性和开箱即用故障恢复功能，可以在问题产生之前捕获问题，使调用更可靠，网络更健壮。</p>
<h6 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h6><p>Istio的安全功能使开发人员可以专注于应用程序级别的安全。Istio提供了底层的安全通信通道，并按比例管理服务通信的身份验证、授权和加密。通过Istio，服务通信在缺省情况下是安全的。允许在不同的协议和运行时之间一致地实施策略。</p>
<h6 id="观察"><a href="#观察" class="headerlink" title="观察"></a>观察</h6><p>Isio的见状跟踪、监视和日志功能使得我们可以更加深入了解服务网格部署。通过Istio的监视功能，可以真正理解服务性能如何影响上游和下游的事情。而它的自定义仪表板提供了对所有服务的性能的可见性。</p>
<h5 id="安装Istio"><a href="#安装Istio" class="headerlink" title="安装Istio"></a>安装Istio</h5><p>安装文档地址：<a href="https://istio.io/latest/docs/setup/getting-started/" target="_blank" rel="noopener">https://istio.io/latest/docs/setup/getting-started/</a></p>
<h6 id="下载1-11-6版本"><a href="#下载1-11-6版本" class="headerlink" title="下载1.11.6版本"></a>下载1.11.6版本</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.11.6 sh -</span><br></pre></td></tr></table></figure>
<h6 id="进入到下载目录"><a href="#进入到下载目录" class="headerlink" title="进入到下载目录"></a>进入到下载目录</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd istio-1.11.6/</span><br></pre></td></tr></table></figure>
<h6 id="添加istioctl客户端到路径"><a href="#添加istioctl客户端到路径" class="headerlink" title="添加istioctl客户端到路径"></a>添加istioctl客户端到路径</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PWD/bin:$PATH</span><br></pre></td></tr></table></figure>
<h6 id="查看Istio部署模式"><a href="#查看Istio部署模式" class="headerlink" title="查看Istio部署模式"></a>查看Istio部署模式</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/istio-1.11.6# istioctl profile list</span><br><span class="line">Istio configuration profiles:</span><br><span class="line">    default</span><br><span class="line">    demo</span><br><span class="line">    empty</span><br><span class="line">    external</span><br><span class="line">    minimal</span><br><span class="line">    openshift</span><br><span class="line">    preview</span><br><span class="line">    remote</span><br></pre></td></tr></table></figure>
<h6 id="设置部署模式为demo"><a href="#设置部署模式为demo" class="headerlink" title="设置部署模式为demo"></a>设置部署模式为demo</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istioctl manifest apply --set profile=demo</span><br></pre></td></tr></table></figure>
<h6 id="添加命名空间的标签"><a href="#添加命名空间的标签" class="headerlink" title="添加命名空间的标签"></a>添加命名空间的标签</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl label namespace default istio-injection=enabled</span><br><span class="line">namespace/default labeled</span><br></pre></td></tr></table></figure>
<h5 id="部署案例应用"><a href="#部署案例应用" class="headerlink" title="部署案例应用"></a>部署案例应用</h5><h6 id="部署bookinfo案例"><a href="#部署bookinfo案例" class="headerlink" title="部署bookinfo案例"></a>部署bookinfo案例</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/istio-1.11.6# kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml</span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br><span class="line">deployment.apps/productpage-v1 created</span><br></pre></td></tr></table></figure>
<h6 id="查看pod情况"><a href="#查看pod情况" class="headerlink" title="查看pod情况"></a>查看pod情况</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/istio-1.11.6# kubectl get pods</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-5498c86cf5-bhv2h       2/2     Running   0          13m</span><br><span class="line">productpage-v1-65b75f6885-p6k2w   2/2     Running   0          13m</span><br><span class="line">ratings-v1-b477cf6cf-k84kr        2/2     Running   0          13m</span><br><span class="line">reviews-v1-79d546878f-q6f62       2/2     Running   0          13m</span><br><span class="line">reviews-v2-548c57f459-cqq2r       2/2     Running   0          13m</span><br><span class="line">reviews-v3-6dd79655b9-gr42h       2/2     Running   0          13m</span><br></pre></td></tr></table></figure>
<h6 id="检查运行是否正常"><a href="#检查运行是否正常" class="headerlink" title="检查运行是否正常"></a>检查运行是否正常</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/istio-1.11.6# kubectl exec "$(kubectl get pod -l app=ratings -o jsonpath='&#123;.items[0].metadata.name&#125;')" -c ratings -- curl -sS productpage:9080/productpage | grep -o "&lt;title&gt;.*&lt;/title&gt;"</span><br><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br></pre></td></tr></table></figure>
<h5 id="开启外部访问"><a href="#开启外部访问" class="headerlink" title="开启外部访问"></a>开启外部访问</h5><h6 id="关联Istio网关"><a href="#关联Istio网关" class="headerlink" title="关联Istio网关"></a>关联Istio网关</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</span><br></pre></td></tr></table></figure>
<h6 id="查看服务外部访问方式"><a href="#查看服务外部访问方式" class="headerlink" title="查看服务外部访问方式"></a>查看服务外部访问方式</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/istio-1.11.6# kubectl get svc istio-ingressgateway -n istio-system</span><br><span class="line">NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                                                                      AGE</span><br><span class="line">istio-ingressgateway   LoadBalancer   10.96.244.67   &lt;none&gt;        15021:32085/TCP,80:31356/TCP,443:31869/TCP,31400:31862/TCP,15443:31190/TCP</span><br></pre></td></tr></table></figure>
<h6 id="修改访问方式为NodePort"><a href="#修改访问方式为NodePort" class="headerlink" title="修改访问方式为NodePort"></a>修改访问方式为NodePort</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc istio-ingressgateway -n istio-system</span><br></pre></td></tr></table></figure>
<h6 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/istio-1.11.6# curl 192.168.19.85:31356/productpage</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br><span class="line">&lt;meta charset="utf-8"&gt;</span><br><span class="line">&lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;</span><br><span class="line">&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Latest compiled and minified CSS --&gt;</span><br><span class="line">&lt;link rel="stylesheet" href="static/bootstrap/css/bootstrap.min.css"&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- Optional theme --&gt;</span><br><span class="line">&lt;link rel="stylesheet" href="static/bootstrap/css/bootstrap-theme.min.css"&gt;</span><br><span class="line"></span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br></pre></td></tr></table></figure>
<h4 id="ebpf加速ServiceMesh实验"><a href="#ebpf加速ServiceMesh实验" class="headerlink" title="ebpf加速ServiceMesh实验"></a>ebpf加速ServiceMesh实验</h4><p>代码地址：<a href="https://github.com/merbridge/merbridge" target="_blank" rel="noopener">https://github.com/merbridge/merbridge</a></p>
<h5 id="升级内核"><a href="#升级内核" class="headerlink" title="升级内核"></a>升级内核</h5><p>实验要求内核版本&gt;=5.7，首先我们还是通过命令查询指定版本的Linux镜像包，发现没有找到可用的版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# apt-cache search linux| grep 5.8</span><br></pre></td></tr></table></figure>
<p>因此我们直接去官方下载</p>
<p>地址：<a href="https://kernel.ubuntu.com/~kernel-ppa/mainline/" target="_blank" rel="noopener">https://kernel.ubuntu.com/~kernel-ppa/mainline/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget -c https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.8/amd64/linux-headers-5.8.0-050800-generic_5.8.0-050800.202008022230_amd64.deb</span><br><span class="line">wget -c https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.8/amd64/linux-headers-5.8.0-050800_5.8.0-050800.202008022230_all.deb</span><br><span class="line">wget -c https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.8/amd64/linux-image-unsigned-5.8.0-050800-generic_5.8.0-050800.202008022230_amd64.deb</span><br><span class="line">wget -c https://kernel.ubuntu.com/~kernel-ppa/mainline/v5.8/amd64/linux-modules-5.8.0-050800-generic_5.8.0-050800.202008022230_amd64.deb</span><br></pre></td></tr></table></figure>
<p>安装内核Deb软件包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# sudo dpkg -i *.deb</span><br></pre></td></tr></table></figure>
<p>安装结束后，重新启动系统后查看内核版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# uname -r</span><br><span class="line">5.8.0-050800-generic</span><br></pre></td></tr></table></figure>
<h5 id="相关版本说明"><a href="#相关版本说明" class="headerlink" title="相关版本说明"></a>相关版本说明</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# docker version</span><br><span class="line">Client: Docker Engine - Community</span><br><span class="line"> Version:           20.10.12</span><br><span class="line">root@ubuntu:~# kubectl version</span><br><span class="line">Client Version: version.Info&#123;Major:"1", Minor:"23", GitVersion:"v1.23.3", GitCommit:"816c97ab8cff8a1c72eccca1026f7820e93e0d25", GitTreeState:"clean", BuildDate:"2022-01-25T21:25:17Z", GoVersion:"go1.17.6", Compiler:"gc", Platform:"linux/amd64"&#125;</span><br><span class="line">Server Version: version.Info&#123;Major:"1", Minor:"23", GitVersion:"v1.23.3", GitCommit:"816c97ab8cff8a1c72eccca1026f7820e93e0d25", GitTreeState:"clean", BuildDate:"2022-01-25T21:19:12Z", GoVersion:"go1.17.6", Compiler:"gc", Platform:"linux/amd64"&#125;</span><br><span class="line">root@ubuntu:~# lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description:    Ubuntu 20.04 LTS</span><br><span class="line">Release:        20.04</span><br><span class="line">Codename:       focal</span><br><span class="line">root@ubuntu:~# uname -r</span><br><span class="line">5.8.0-050800-generic</span><br></pre></td></tr></table></figure>
<h5 id="yaml文件apply之前的ebpf数据"><a href="#yaml文件apply之前的ebpf数据" class="headerlink" title="yaml文件apply之前的ebpf数据"></a>yaml文件apply之前的ebpf数据</h5><p>列出系统中所有cgroup上的附加程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# bpftool cgroup tree</span><br><span class="line">CgroupPath</span><br><span class="line">ID       AttachType      AttachFlags     Name</span><br><span class="line">/sys/fs/cgroup/unified/system.slice/systemd-udevd.service</span><br><span class="line">    21       ingress</span><br><span class="line">    20       egress</span><br><span class="line">/sys/fs/cgroup/unified/system.slice/systemd-journald.service</span><br><span class="line">    19       ingress</span><br><span class="line">    18       egress</span><br><span class="line">/sys/fs/cgroup/unified/system.slice/systemd-logind.service</span><br><span class="line">    23       ingress</span><br><span class="line">    22       egress</span><br></pre></td></tr></table></figure>
<p>查看系统中已经加载的所有BPF程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# bpftool prog show</span><br><span class="line">18: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">19: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">20: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">21: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">22: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">23: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br></pre></td></tr></table></figure>
<h5 id="merbridge安装"><a href="#merbridge安装" class="headerlink" title="merbridge安装"></a>merbridge安装</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl apply -f https://raw.githubusercontent.com/merbridge/merbridge/main/deploy/all-in-one.yaml</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/merbridge created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/merbridge created</span><br><span class="line">serviceaccount/merbridge created</span><br><span class="line">daemonset.apps/merbridge created</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl get pods -n istio-system</span><br><span class="line">NAME                                    READY   STATUS     RESTARTS   AGE</span><br><span class="line">istio-egressgateway-79bb75fcf9-7plxw    1/1     Running    0          17h</span><br><span class="line">istio-ingressgateway-84bfcfd895-ktbcg   1/1     Running    0          17h</span><br><span class="line">istiod-6c5cfd79db-4ww7r                 1/1     Running    0          17h</span><br><span class="line">merbridge-75rr6                         0/1     Init:0/1   0          2m57s</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl get pods -n istio-system</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">istio-egressgateway-79bb75fcf9-7plxw    1/1     Running   0          19h</span><br><span class="line">istio-ingressgateway-84bfcfd895-ktbcg   1/1     Running   0          19h</span><br><span class="line">istiod-6c5cfd79db-4ww7r                 1/1     Running   0          19h</span><br><span class="line">merbridge-75rr6                        1/1     Running   0          12m</span><br></pre></td></tr></table></figure>
<p>再次查看系统中所有 cgroup 上的附加程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# bpftool cgroup tree</span><br><span class="line">CgroupPath</span><br><span class="line">ID       AttachType      AttachFlags     Name</span><br><span class="line">/sys/fs/cgroup/unified</span><br><span class="line">31       sock_ops                        mb_sockops</span><br><span class="line">43       bind4                           mb_bind</span><br><span class="line">27       connect4                        mb_sock4_connec</span><br><span class="line">35       getsockopt                      mb_get_sockopt</span><br><span class="line">/sys/fs/cgroup/unified/system.slice/systemd-udevd.service</span><br><span class="line">    21       ingress</span><br><span class="line">    20       egress</span><br><span class="line">/sys/fs/cgroup/unified/system.slice/systemd-journald.service</span><br><span class="line">    19       ingress</span><br><span class="line">    18       egress</span><br><span class="line">/sys/fs/cgroup/unified/system.slice/systemd-logind.service</span><br><span class="line">    23       ingress</span><br><span class="line">    22       egress</span><br></pre></td></tr></table></figure>
<p>再次查看系统中已经加载的所有 BPF 程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# bpftool prog show</span><br><span class="line">18: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">19: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">20: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">21: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">22: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">23: cgroup_skb  tag 6deef7357e7b4530  gpl</span><br><span class="line">        loaded_at 2022-02-17T08:35:47+0000  uid 0</span><br><span class="line">        xlated 64B  jited 66B  memlock 4096B</span><br><span class="line">27: cgroup_sock_addr  name mb_sock4_connec  tag 52444be6f9070ca0  gpl</span><br><span class="line">        loaded_at 2022-02-17T09:32:53+0000  uid 0</span><br><span class="line">        xlated 2336B  jited 1329B  memlock 4096B  map_ids 1,2,3,7</span><br><span class="line">        btf_id 3</span><br><span class="line">31: sock_ops  name mb_sockops  tag 92e9974a3364b015  gpl</span><br><span class="line">        loaded_at 2022-02-17T09:32:53+0000  uid 0</span><br><span class="line">        xlated 1272B  jited 704B  memlock 4096B  map_ids 1,3,8,9</span><br><span class="line">        btf_id 6</span><br><span class="line">35: cgroup_sockopt  name mb_get_sockopt  tag d2a89e73318e6dc2  gpl</span><br><span class="line">        loaded_at 2022-02-17T09:32:53+0000  uid 0</span><br><span class="line">        xlated 864B  jited 509B  memlock 4096B  map_ids 8</span><br><span class="line">        btf_id 9</span><br><span class="line">39: sk_msg  name mb_msg_redir  tag 95e99118f09830d0  gpl</span><br><span class="line">        loaded_at 2022-02-17T09:32:53+0000  uid 0</span><br><span class="line">        xlated 376B  jited 237B  memlock 4096B  map_ids 9</span><br><span class="line">        btf_id 12</span><br><span class="line">43: cgroup_sock_addr  name mb_bind  tag 57cd311f2e27366b  gpl</span><br><span class="line">        loaded_at 2022-02-17T09:32:53+0000  uid 0</span><br><span class="line">        xlated 16B  jited 40B  memlock 4096B</span><br><span class="line">        btf_id 15</span><br></pre></td></tr></table></figure>
<p>发现ebpf程序已经成功加载进内核</p>
<h5 id="确认ebpf程序生效"><a href="#确认ebpf程序生效" class="headerlink" title="确认ebpf程序生效"></a>确认ebpf程序生效</h5><p>yaml文件开启<code>debug</code>模式</p>
<p>打开日志追踪</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /sys/kernel/debug/tracing/tracing_on</span><br></pre></td></tr></table></figure>
<p>再次访问<code>192.168.19.84:31356/productpage</code></p>
<p>使用<code>cat /sys/kernel/debug/tracing/trace_pipe</code>查看输出</p>
<p><img src="/2022/02/28/从0到0-5-eBPF加速ServiceMesh实践/1.png" alt="1"></p>
<h5 id="tps测试如下"><a href="#tps测试如下" class="headerlink" title="tps测试如下"></a>tps测试如下</h5><p>其中85是没有部署merbridge的，即没有通过ebpf加速。84是经过ebpf加速的，可以看到经过ebpf加速之后tps增加了一倍。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/wrk-master# ./wrk -c1000 --latency http://192.168.19.85:31356/productpage</span><br><span class="line">Running 10s test @ http://192.168.19.85:31356/productpage</span><br><span class="line">  2 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     1.19s   402.47ms   1.96s    77.78%</span><br><span class="line">    Req/Sec    14.47     12.03    50.00     78.95%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.21s</span><br><span class="line">     75%    1.34s</span><br><span class="line">     90%    1.77s</span><br><span class="line">     99%    1.96s</span><br><span class="line">  111 requests in 10.04s, 544.62KB read</span><br><span class="line"></span><br><span class="line">root@ubuntu:~/wrk-master# ./wrk -c1000 --latency http://192.168.19.84:31356/productpage</span><br><span class="line">Running 10s test @ http://192.168.19.84:31356/productpage</span><br><span class="line">  2 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     1.52s   367.79ms   1.98s    80.85%</span><br><span class="line">    Req/Sec    17.94     18.18   140.00     89.08%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.61s</span><br><span class="line">     75%    1.72s</span><br><span class="line">     90%    1.85s</span><br><span class="line">     99%    1.98s</span><br><span class="line">  243 requests in 10.02s, 1.17MB read</span><br></pre></td></tr></table></figure>
<h4 id="集群测试"><a href="#集群测试" class="headerlink" title="集群测试"></a>集群测试</h4><p>集群测试分为两组</p>
<ul>
<li>没有经过merbridge加速：<code>192.168.19.85和192.168.19.83</code></li>
<li>经过merbridge加速：<code>192.168.19.84和192.168.19.82</code></li>
</ul>
<p>master节点分别是<code>192.168.19.85和192.168.19.84</code></p>
<h5 id="slave节点配置"><a href="#slave节点配置" class="headerlink" title="slave节点配置"></a>slave节点配置</h5><p>1.安装docker和k8s工具，这里不再赘述</p>
<p>2.将从节点加入主节点</p>
<p>主节点查看令牌，没有则需要创建令牌</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubeadm token list</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubeadm token create</span><br></pre></td></tr></table></figure>
<p>如果没有 <code>--discovery-token-ca-cert-hash</code> 的值，则可以通过在控制平面节点上执行以下命令来获取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~<span class="comment"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | \</span></span><br><span class="line">   openssl dgst -sha256 -hex | sed <span class="string">'s/^.* //'</span></span><br></pre></td></tr></table></figure>
<p>3.从节点执行<code>kubeadm join</code>命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu1:/etc/kubernetes# swapoff -a</span><br><span class="line">root@ubuntu1:/etc/kubernetes# kubeadm join --token 11sf7j.b46h7ej8l01pddgj 192.168.19.85:6443 --discovery-token-ca-cert-hash sha256:dde9c1d26f1d6178203ed03e6e3e0df6c0d926aa60fba0f0a4e2a88b47b95a69</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Reading configuration from the cluster...</span><br><span class="line">[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'</span><br><span class="line">W0222 09:41:45.561758    4675 utils.go:69] The recommended value for "resolvConf" in "KubeletConfiguration" is: /run/systemd/resolve/resolv.conf; the provided value is: /run/systemd/resolve/resolv.conf</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"</span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run 'kubectl get nodes' on the control-plane to see this node join the cluster.</span><br></pre></td></tr></table></figure>
<p>4.主节点查看nodes情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/etc/kubernetes# kubectl get nodes</span><br><span class="line">NAME      STATUS   ROLES                  AGE     VERSION</span><br><span class="line">ubuntu    Ready    control-plane,master   12d     v1.23.3</span><br><span class="line">ubuntu1   Ready    &lt;none&gt;                 2m46s   v1.23.4</span><br></pre></td></tr></table></figure>
<p>5.查看pod的分布情况</p>
<p>192.168.19.85</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl get pod --all-namespaces -o wide</span><br><span class="line">NAMESPACE      NAME                                    READY   STATUS    RESTARTS       AGE   IP              NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">default        details-v1-5498c86cf5-bhv2h             2/2     Running   26 (40h ago)   12d   10.244.0.175    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        helloworld-v1-fdb8c8c58-gh4sf           2/2     Running   0              39h   10.244.1.4      ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        helloworld-v2-5b46bc9f84-glxpg          2/2     Running   0              39h   10.244.1.3      ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        productpage-v1-65b75f6885-p6k2w         2/2     Running   26 (40h ago)   12d   10.244.0.171    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        ratings-v1-b477cf6cf-k84kr              2/2     Running   26 (40h ago)   12d   10.244.0.179    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        reviews-v1-79d546878f-q6f62             2/2     Running   26 (40h ago)   12d   10.244.0.168    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        reviews-v2-548c57f459-cqq2r             2/2     Running   26 (40h ago)   12d   10.244.0.180    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        reviews-v3-6dd79655b9-gr42h             2/2     Running   26 (40h ago)   12d   10.244.0.173    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        sleep-698cfc4445-k8ncb                  2/2     Running   0              39h   10.244.1.2      ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istio-system   istio-egressgateway-79bb75fcf9-z6pqt    1/1     Running   13 (40h ago)   12d   10.244.0.178    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istio-system   istio-ingressgateway-84bfcfd895-cdkwd   1/1     Running   13 (40h ago)   12d   10.244.0.176    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istio-system   istiod-6c5cfd79db-8nqqb                 1/1     Running   14 (40h ago)   12d   10.244.0.174    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    coredns-6d8c4cb4d-8xrmh                 1/1     Running   15 (40h ago)   13d   10.244.0.169    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    coredns-6d8c4cb4d-cv77n                 1/1     Running   14 (40h ago)   13d   10.244.0.181    ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    etcd-ubuntu                             1/1     Running   16 (40h ago)   13d   192.168.19.85   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-apiserver-ubuntu                   1/1     Running   14 (40h ago)   13d   192.168.19.85   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-controller-manager-ubuntu          1/1     Running   14 (40h ago)   13d   192.168.19.85   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-flannel-ds-87xdz                   1/1     Running   18 (40h ago)   13d   192.168.19.85   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-flannel-ds-drk55                   1/1     Running   0              40h   192.168.19.83   ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-proxy-9rwc5                        1/1     Running   0              40h   192.168.19.83   ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-proxy-qkcxz                        1/1     Running   14 (40h ago)   13d   192.168.19.85   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-scheduler-ubuntu                   1/1     Running   14 (40h ago)   13d   192.168.19.85   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>192.168.19.84</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl get pod --all-namespaces -o wide</span><br><span class="line">NAMESPACE      NAME                                    READY   STATUS    RESTARTS      AGE     IP              NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">default        details-v1-5498c86cf5-7qwql             2/2     Running   2 (23h ago)   6d16h   10.244.0.34     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        helloworld-v1-fdb8c8c58-28pm4           2/2     Running   0             22h     10.244.1.5      ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        helloworld-v2-5b46bc9f84-rs5ch          2/2     Running   0             22h     10.244.1.6      ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        productpage-v1-65b75f6885-kt88j         2/2     Running   2 (23h ago)   6d16h   10.244.0.31     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        ratings-v1-b477cf6cf-8bdk9              2/2     Running   2 (23h ago)   6d16h   10.244.0.35     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        reviews-v1-79d546878f-nf4xd             2/2     Running   2 (23h ago)   6d16h   10.244.0.25     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        reviews-v2-548c57f459-sdjzs             2/2     Running   2 (23h ago)   6d16h   10.244.0.24     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        reviews-v3-6dd79655b9-p6vdg             2/2     Running   2 (23h ago)   6d16h   10.244.0.26     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">default        sleep-698cfc4445-qncjl                  2/2     Running   0             22h     10.244.1.4      ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istio-system   istio-egressgateway-79bb75fcf9-7plxw    1/1     Running   1 (23h ago)   6d17h   10.244.0.29     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istio-system   istio-ingressgateway-84bfcfd895-ktbcg   1/1     Running   1 (23h ago)   6d17h   10.244.0.32     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istio-system   istiod-6c5cfd79db-4ww7r                 1/1     Running   1 (23h ago)   6d17h   10.244.0.23     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istio-system   merbridge-9kmsk                         1/1     Running   1 (23h ago)   5d21h   10.244.0.28     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">istio-system   merbridge-jqt9x                         1/1     Running   7 (23h ago)   23h     10.244.1.3      ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    coredns-6d8c4cb4d-87slm                 1/1     Running   1 (23h ago)   6d17h   10.244.0.36     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    coredns-6d8c4cb4d-ld7cp                 1/1     Running   1 (23h ago)   6d17h   10.244.0.33     ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    etcd-ubuntu                             1/1     Running   4 (23h ago)   6d17h   192.168.19.84   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-apiserver-ubuntu                   1/1     Running   4 (23h ago)   6d17h   192.168.19.84   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-controller-manager-ubuntu          1/1     Running   4 (23h ago)   6d17h   192.168.19.84   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-flannel-ds-7lvxj                   1/1     Running   1 (23h ago)   23h     192.168.19.82   ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-flannel-ds-fqtst                   1/1     Running   1 (23h ago)   6d16h   192.168.19.84   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-proxy-9kwsc                        1/1     Running   1 (23h ago)   23h     192.168.19.82   ubuntu1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-proxy-p8nw9                        1/1     Running   1 (23h ago)   6d17h   192.168.19.84   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system    kube-scheduler-ubuntu                   1/1     Running   4 (23h ago)   6d17h   192.168.19.84   ubuntu    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h5 id="外部向pod发送请求"><a href="#外部向pod发送请求" class="headerlink" title="外部向pod发送请求"></a>外部向pod发送请求</h5><h6 id="集群内"><a href="#集群内" class="headerlink" title="集群内"></a>集群内</h6><p>在node为<code>192.168.19.85</code>的机器上向node为<code>192.168.19.83</code>机器上的pod发送请求(没有merbridge加速)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# wrk -c1000 --latency http://192.168.19.83:31356/productpage</span><br><span class="line">Running 10s test @ http://192.168.19.83:31356/productpage</span><br><span class="line">  2 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     1.62s   294.11ms   1.97s    66.67%</span><br><span class="line">    Req/Sec     9.85      8.67    50.00     78.87%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.73s</span><br><span class="line">     75%    1.85s</span><br><span class="line">     90%    1.97s</span><br><span class="line">     99%    1.97s</span><br><span class="line">  108 requests in 10.07s, 530.88KB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 99</span><br><span class="line">Requests/sec:     10.72</span><br><span class="line">Transfer/sec:     52.72KB</span><br></pre></td></tr></table></figure>
<p>在node为<code>192.168.19.84</code>的机器上向node为<code>192.168.19.82</code>机器上的pod发送请求(有merbridge加速)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# wrk -c1000 --latency http://192.168.19.82:31356/productpage</span><br><span class="line">Running 10s test @ http://192.168.19.82:31356/productpage</span><br><span class="line">  2 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     1.65s   252.43ms   1.99s    53.33%</span><br><span class="line">    Req/Sec    20.50     14.91    70.00     67.33%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.71s</span><br><span class="line">     75%    1.92s</span><br><span class="line">     90%    1.97s</span><br><span class="line">     99%    1.99s</span><br><span class="line">  233 requests in 10.10s, 1.12MB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 218</span><br><span class="line">Requests/sec:     23.08</span><br><span class="line">Transfer/sec:    113.95KB</span><br></pre></td></tr></table></figure>
<h6 id="集群间"><a href="#集群间" class="headerlink" title="集群间"></a>集群间</h6><p>在node为<code>192.168.19.85</code>的机器上向node为<code>192.168.19.84</code>机器上的pod发送请求(其中84上部署了merbridge加速)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# wrk -c1000 --latency http://192.168.19.84:31356/productpage</span><br><span class="line">Running 10s test @ http://192.168.19.84:31356/productpage</span><br><span class="line">  2 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     1.54s   365.46ms   1.96s    70.00%</span><br><span class="line">    Req/Sec    16.30     11.91    60.00     72.84%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.79s</span><br><span class="line">     75%    1.88s</span><br><span class="line">     90%    1.95s</span><br><span class="line">     99%    1.96s</span><br><span class="line">  157 requests in 10.10s, 770.66KB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 137</span><br><span class="line">Requests/sec:     15.55</span><br><span class="line">Transfer/sec:     76.33KB</span><br></pre></td></tr></table></figure>
<p>在node为<code>192.168.19.84</code>的机器上向node为<code>192.168.19.85</code>机器上的pod发送请求(其中85没有部署merbridge加速)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# wrk -c1000 --latency http://192.168.19.85:31356/productpage</span><br><span class="line">Running 10s test @ http://192.168.19.85:31356/productpage</span><br><span class="line">  2 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     1.23s   671.98ms   1.82s   100.00%</span><br><span class="line">    Req/Sec    10.85      7.15    30.00     50.85%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.80s</span><br><span class="line">     75%    1.82s</span><br><span class="line">     90%    1.82s</span><br><span class="line">     99%    1.82s</span><br><span class="line">  84 requests in 10.10s, 412.15KB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 80</span><br><span class="line">Requests/sec:      8.32</span><br><span class="line">Transfer/sec:     40.81KB</span><br></pre></td></tr></table></figure>
<h5 id="同一node下pod间发送请求"><a href="#同一node下pod间发送请求" class="headerlink" title="同一node下pod间发送请求"></a>同一node下pod间发送请求</h5><h6 id="pod内安装wrk"><a href="#pod内安装wrk" class="headerlink" title="pod内安装wrk"></a>pod内安装wrk</h6><p>进入pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it &lt;pod-name&gt; /bin/sh</span><br></pre></td></tr></table></figure>
<p>安装wrk压测工具发现无法执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/ $ ls</span><br><span class="line">bin            dev            etc            lib            mnt            proc           run            srv            tmp            var</span><br><span class="line">cacert.pem     entrypoint.sh  home           media          opt            root           sbin           sys            usr</span><br><span class="line">/ $ sudo</span><br><span class="line">/bin/sh: sudo: not found</span><br><span class="line">/ $ apt</span><br><span class="line">/bin/sh: apt: not found</span><br></pre></td></tr></table></figure>
<p>解决办法：<a href="https://stackoverflow.com/questions/45142855/bin-sh-apt-get-not-found" target="_blank" rel="noopener">https://stackoverflow.com/questions/45142855/bin-sh-apt-get-not-found</a></p>
<p>通过docker以root身份进入容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it --user=root &lt;CONTAINER ID&gt; /bin/sh</span><br></pre></td></tr></table></figure>
<p>使用apk命令安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/ # apk update</span><br><span class="line">/ # apk add Package</span><br><span class="line">这里需要安装的package如下</span><br><span class="line">- gcc</span><br><span class="line">- make</span><br><span class="line">- automake</span><br><span class="line">- autoconf</span><br><span class="line">- libtool</span><br><span class="line">- linux-headers</span><br><span class="line">- libc-dev</span><br></pre></td></tr></table></figure>
<p>在wrk目录下执行make</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/tmp/wrk-master # make</span><br></pre></td></tr></table></figure>
<p>在名为<code>sleep-698cfc4445-k8ncb</code>的pod下，对名为<code>helloworld-v1-fdb8c8c58-gh4sf</code>的pod发起请求。这两个pod同属于<code>192.168.19.83</code>节点，在该node下没有部署merbridge加速</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/tmp/wrk-master # wrk -c10000 --latency http://10.101.180.145:5000</span><br><span class="line">Running 10s test @ http://10.101.180.145:5000</span><br><span class="line">  2 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   757.70ms  403.53ms   1.54s    51.72%</span><br><span class="line">    Req/Sec    20.85     30.78   170.00     94.87%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%  724.43ms</span><br><span class="line">     75%    1.09s</span><br><span class="line">     90%    1.31s</span><br><span class="line">     99%    1.54s</span><br><span class="line">  136 requests in 10.22s, 52.28KB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 107</span><br><span class="line">  Non-2xx or 3xx responses: 136</span><br><span class="line">Requests/sec:     13.31</span><br><span class="line">Transfer/sec:      5.12KB</span><br></pre></td></tr></table></figure>
<p>在名为<code>sleep-698cfc4445-qncjl</code>的pod下，对名为<code>helloworld-v1-fdb8c8c58-28pm4</code>的pod发起请求。这两个pod同属于<code>192.168.19.82</code>节点，在该node部署了merbridge加速</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/tmp/wrk-master # wrk -c10000 --latency http://10.101.187.77:5000</span><br><span class="line">Running 10s test @ http://10.101.187.77:5000</span><br><span class="line">  2 threads and 10000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     1.91s    20.63ms   1.98s    82.22%</span><br><span class="line">    Req/Sec    78.02     96.83   495.00     86.67%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.92s</span><br><span class="line">     75%    1.92s</span><br><span class="line">     90%    1.92s</span><br><span class="line">     99%    1.98s</span><br><span class="line">  461 requests in 10.10s, 177.23KB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 416</span><br><span class="line">  Non-2xx or 3xx responses: 461</span><br><span class="line">Requests/sec:     45.67</span><br><span class="line">Transfer/sec:     17.56KB</span><br></pre></td></tr></table></figure>
<h5 id="不同node下pod间发送请求"><a href="#不同node下pod间发送请求" class="headerlink" title="不同node下pod间发送请求"></a>不同node下pod间发送请求</h5><p>在node为<code>192.168.19.83名为sleep-698cfc4445-k8ncb</code>的pod下，对node为<code>192.168.19.85名为productpage-v1-65b75f6885-p6k2w</code>的pod发起请求。这两个pod不属于同一个node下，在该集群下没有部署merbridge加速</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/ $ wrk -c1000 --latency http://192.168.19.85:31356/productpage</span><br><span class="line">Running 10s test @ http://192.168.19.85:31356/productpage</span><br><span class="line">  2 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     1.69s     0.00us   1.69s   100.00%</span><br><span class="line">    Req/Sec     5.98      4.32    20.00     75.47%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.69s</span><br><span class="line">     75%    1.69s</span><br><span class="line">     90%    1.69s</span><br><span class="line">     99%    1.69s</span><br><span class="line">  62 requests in 10.04s, 304.85KB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 61</span><br><span class="line">Requests/sec:      6.17</span><br><span class="line">Transfer/sec:     30.35KB</span><br></pre></td></tr></table></figure>
<p>在node为<code>192.168.19.82名为sleep-698cfc4445-qncjl</code>的pod下，对node为<code>192.168.19.84名为productpage-v1-65b75f6885-kt88j</code>的pod发起请求。这两个pod不属于同一个node下，在该集群下部署了merbridge加速</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/ $ wrk -c1000 --latency http://192.168.19.84:31356/productpage</span><br><span class="line">Running 10s test @ http://192.168.19.84:31356/productpage</span><br><span class="line">  2 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency     1.48s   258.10ms   1.80s    83.33%</span><br><span class="line">    Req/Sec    15.02     14.04    90.00     84.54%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%    1.58s</span><br><span class="line">     75%    1.64s</span><br><span class="line">     90%    1.69s</span><br><span class="line">     99%    1.80s</span><br><span class="line">  188 requests in 10.08s, 0.90MB read</span><br><span class="line">  Socket errors: connect 0, read 0, write 0, timeout 158</span><br><span class="line">Requests/sec:     18.66</span><br><span class="line">Transfer/sec:     91.41KB</span><br></pre></td></tr></table></figure>
<h5 id="拓展：从控制平面节点以外的计算机控制集群"><a href="#拓展：从控制平面节点以外的计算机控制集群" class="headerlink" title="拓展：从控制平面节点以外的计算机控制集群"></a>拓展：从控制平面节点以外的计算机控制集群</h5><p>从节点查看pod报错如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl get pod</span><br><span class="line">The connection to the server localhost:8080 was refused - did you specify the right host or port?</span><br></pre></td></tr></table></figure>
<p>出现这个问题的原因是kubectl命令需要使用<code>kubernetes-admin</code>来运行，解决方法如下，将主节点中的<code>/etc/kubernetes/admin.conf</code>文件拷贝到从节点相同目录下，然后配置环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# echo "export KUBECONFIG=/etc/kubernetes/admin.conf" &gt;&gt; ~/.bash_profile</span><br><span class="line">root@ubuntu:~# source ~/.bash_profile</span><br></pre></td></tr></table></figure>
<p>再次查看pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl get pods</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-5498c86cf5-bhv2h       2/2     Running   24         11d</span><br><span class="line">helloworld-v1-fdb8c8c58-9nqw8     2/2     Running   0          5d</span><br><span class="line">helloworld-v2-5b46bc9f84-gdzvl    2/2     Running   0          5d</span><br><span class="line">productpage-v1-65b75f6885-p6k2w   2/2     Running   24         11d</span><br><span class="line">ratings-v1-b477cf6cf-k84kr        2/2     Running   24         11d</span><br><span class="line">reviews-v1-79d546878f-q6f62       2/2     Running   24         11d</span><br><span class="line">reviews-v2-548c57f459-cqq2r       2/2     Running   24         11d</span><br><span class="line">reviews-v3-6dd79655b9-gr42h       2/2     Running   24         11d</span><br><span class="line">sleep-698cfc4445-8nncn            2/2     Running   0          5d1h</span><br></pre></td></tr></table></figure>
<h4 id="merbridge-yaml文件解析-istio"><a href="#merbridge-yaml文件解析-istio" class="headerlink" title="merbridge yaml文件解析(istio)"></a>merbridge yaml文件解析(istio)</h4><p><a href="https://github.com/merbridge/merbridge/blob/main/deploy/all-in-one.yaml" target="_blank" rel="noopener">https://github.com/merbridge/merbridge/blob/main/deploy/all-in-one.yaml</a></p>
<p>第一段，创建对象类别，这里是集群角色</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1 #创建该对象所使用的 Kubernetes API 的版本</span><br><span class="line">kind: ClusterRole #想要创建对象的类别</span><br><span class="line">metadata: #帮助唯一性标识对象的一些数据</span><br><span class="line">  labels:</span><br><span class="line">    app: merbridge</span><br><span class="line">  name: merbridge</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: #空字符串表明使用core API group</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs: #对资源对象执行的操作</span><br><span class="line">  - list</span><br><span class="line">  - get</span><br><span class="line">  - watch</span><br></pre></td></tr></table></figure>
<p>第二段，在集群范围执行授权，这里对集群角色权限进行绑定</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding #在集群范围执行授权</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: merbridge</span><br><span class="line">  name: merbridge</span><br><span class="line">roleRef: #指定与某 Role 或 ClusterRole 的绑定关系</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole # 此字段必须是 Role 或 ClusterRole</span><br><span class="line">  name: merbridge # 此字段必须与你要绑定的 Role 或 ClusterRole 的名称匹配</span><br><span class="line">subjects: #用来尝试操作集群的对象</span><br><span class="line">- kind: ServiceAccount #为Pod中的进程和外部用户提供身份信息</span><br><span class="line">  name: merbridge</span><br><span class="line">  namespace: istio-system</span><br></pre></td></tr></table></figure>
<p>第三段，为pod指定服务账户，命名空间为<code>istio-system</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: merbridge</span><br><span class="line">  name: merbridge</span><br><span class="line">  namespace: istio-system</span><br></pre></td></tr></table></figure>
<p>第四段创建DaemonSet类型的pod。我们将内容拆为两部分说明</p>
<p><code>initContainers</code></p>
<p>首先我们看一下<code>initContainers</code>的挂载卷，需要说明的是，使用卷时, 在 <code>.spec.volumes</code> 字段中设置为 Pod 提供的卷，并在 <code>.spec.containers[*].volumeMounts</code> 字段中声明卷在容器中的挂载位置。因此我们先看一下<code>.spec.volumes</code>字段，如下所示</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">      - hostPath: </span><br><span class="line">          path: /sys/fs</span><br><span class="line">        name: sys-fs</span><br><span class="line">      - hostPath:</span><br><span class="line">          path: /proc</span><br><span class="line">        name: host-proc</span><br><span class="line">      - emptyDir: &#123;&#125; </span><br><span class="line">        name: host-ips</span><br></pre></td></tr></table></figure>
<p>这里用到了两种存储卷类型，分别是<code>hostPath</code>和<code>emptyDir</code>。对于<code>hostPath</code>类型，会映射node文件系统中的文件或者目录到pod里。而对于<code>emptyDir</code>类型，K8s会在Node上自动分配一个目录，因此无需指定宿主机Node上对应的目录文件。</p>
<p>接着我们回到<code>initContainers</code>中。看到<code>initContainers</code>有两个<code>mountPath</code>。用到了<code>.spec.volumes</code>下的<code>host-ips</code>和<code>host-proc</code>，挂载路径为容器中的<code>/host/ips</code>和<code>/host/proc</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">initContainers: #Init容器是一种特殊容器，在Pod内的应用容器启动之前运行</span><br><span class="line">      - image: ghcr.io/merbridge/merbridge:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: init</span><br><span class="line">        args:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - nsenter --net=/host/proc/1/ns/net ip -o addr | awk '&#123;print $4&#125;' | tee /host/ips/ips.txt</span><br><span class="line">        resources: </span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 50Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 300m</span><br><span class="line">            memory: 50Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: true</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - mountPath: /host/ips </span><br><span class="line">            name: host-ips</span><br><span class="line">          - mountPath: /host/proc</span><br><span class="line">            name: host-proc</span><br></pre></td></tr></table></figure>
<p>挂载完成后，我们看一下执行参数。这里用到了<code>nsenter</code>命令。nsenter命令是一个可以在指定进程的命令空间下运行指定程序的命令。它位于util-linux包中。<br>具体使用可参考如下连接：<a href="https://juejin.cn/post/7038531145113452581" target="_blank" rel="noopener">https://juejin.cn/post/7038531145113452581</a><br><code>--net</code>进入<code>net</code>命令空间，并指定了文件的命令空间。<code>nsenter --net=/host/proc/1/ns/net ip -o addr</code>命令可以查看主机的ip地址信息。在主机上测试如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# nsenter --net=/proc/1/ns/net ip -o addr</span><br><span class="line">1: lo    inet 127.0.0.1/8 scope host lo\       valid_lft forever preferred_lft forever</span><br><span class="line">1: lo    inet6 ::1/128 scope host \       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160    inet 192.168.19.84/16 brd 192.168.255.255 scope global ens160\       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens160    inet6 fe80::250:56ff:fe82:8bd7/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0\       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0    inet6 fe80::42:8aff:fe54:fa57/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">4: flannel.1    inet 10.244.0.0/32 scope global flannel.1\       valid_lft forever preferred_lft forever</span><br><span class="line">4: flannel.1    inet6 fe80::e4a0:b4ff:fe2e:2c1f/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">5: cni0    inet 10.244.0.1/24 brd 10.244.0.255 scope global cni0\       valid_lft forever preferred_lft forever</span><br><span class="line">5: cni0    inet6 fe80::a4b8:52ff:fef8:6b8a/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">6: vethffb04bf6    inet6 fe80::24c6:d7ff:fe20:b8b7/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">7: vethf2b12fbf    inet6 fe80::e83b:a4ff:fe7b:7321/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">8: vethec8e53c3    inet6 fe80::d44b:31ff:fe17:a41c/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">9: vethfa223ce0    inet6 fe80::5855:4fff:feef:92f0/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">10: vethcbd6c656    inet6 fe80::c09c:62ff:fe21:df97/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">11: vethf18457c5    inet6 fe80::b8ba:35ff:fe1f:505f/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">12: veth4bbafc0f    inet6 fe80::186e:7aff:fe98:59e4/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">13: veth2757e288    inet6 fe80::4cb5:dff:fea6:d245/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">14: veth40c1c447    inet6 fe80::4468:7bff:fe40:6b09/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">15: vethc01359c4    inet6 fe80::61:aeff:fece:58ee/64 scope link \       valid_lft forever preferred_lft forever</span><br><span class="line">16: vethf3f6e93e    inet6 fe80::30ee:22ff:fee8:2fee/64 scope link \       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>
<p>这里有人可能会想为什么不直接使用<code>ip -o addr</code>呢，从下面结果看到这两条命令的执行结果是一样的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# ip -o addr | awk '&#123;print $4&#125;'</span><br><span class="line">127.0.0.1/8</span><br><span class="line">::1/128</span><br><span class="line">192.168.19.84/16</span><br><span class="line">fe80::250:56ff:fe82:8bd7/64</span><br><span class="line">172.17.0.1/16</span><br><span class="line">fe80::42:8aff:fe54:fa57/64</span><br><span class="line">10.244.0.0/32</span><br><span class="line">fe80::e4a0:b4ff:fe2e:2c1f/64</span><br><span class="line">10.244.0.1/24</span><br><span class="line">fe80::a4b8:52ff:fef8:6b8a/64</span><br><span class="line">fe80::24c6:d7ff:fe20:b8b7/64</span><br><span class="line">fe80::e83b:a4ff:fe7b:7321/64</span><br><span class="line">fe80::d44b:31ff:fe17:a41c/64</span><br><span class="line">fe80::5855:4fff:feef:92f0/64</span><br><span class="line">fe80::c09c:62ff:fe21:df97/64</span><br><span class="line">fe80::b8ba:35ff:fe1f:505f/64</span><br><span class="line">fe80::186e:7aff:fe98:59e4/64</span><br><span class="line">fe80::4cb5:dff:fea6:d245/64</span><br><span class="line">fe80::4468:7bff:fe40:6b09/64</span><br><span class="line">fe80::61:aeff:fece:58ee/64</span><br><span class="line">fe80::30ee:22ff:fee8:2fee/64</span><br><span class="line">root@ubuntu:~# nsenter --net=/proc/1/ns/net ip -o addr | awk '&#123;print $4&#125;'</span><br><span class="line">127.0.0.1/8</span><br><span class="line">::1/128</span><br><span class="line">192.168.19.84/16</span><br><span class="line">fe80::250:56ff:fe82:8bd7/64</span><br><span class="line">172.17.0.1/16</span><br><span class="line">fe80::42:8aff:fe54:fa57/64</span><br><span class="line">10.244.0.0/32</span><br><span class="line">fe80::e4a0:b4ff:fe2e:2c1f/64</span><br><span class="line">10.244.0.1/24</span><br><span class="line">fe80::a4b8:52ff:fef8:6b8a/64</span><br><span class="line">fe80::24c6:d7ff:fe20:b8b7/64</span><br><span class="line">fe80::e83b:a4ff:fe7b:7321/64</span><br><span class="line">fe80::d44b:31ff:fe17:a41c/64</span><br><span class="line">fe80::5855:4fff:feef:92f0/64</span><br><span class="line">fe80::c09c:62ff:fe21:df97/64</span><br><span class="line">fe80::b8ba:35ff:fe1f:505f/64</span><br><span class="line">fe80::186e:7aff:fe98:59e4/64</span><br><span class="line">fe80::4cb5:dff:fea6:d245/64</span><br><span class="line">fe80::4468:7bff:fe40:6b09/64</span><br><span class="line">fe80::61:aeff:fece:58ee/64</span><br><span class="line">fe80::30ee:22ff:fee8:2fee/64</span><br></pre></td></tr></table></figure>
<p>需要提一点的是，nsenter命令一个最典型的用途就是进入容器的网络命令空间。相当多的容器为了轻量级，是不包含较为基础的命令的，比如说<code>ip address</code>，<code>ping</code>，<code>telnet</code>，<code>ss</code>，<code>tcpdump</code>等等命令，这就给调试容器网络带来相当大的困扰。</p>
<p><code>awk &#39;{print $4}&#39;</code>，这句命令是对每行按照空格或TAB分割，输出第四项</p>
<p>awk用法：<a href="https://www.runoob.com/linux/linux-comm-awk.html" target="_blank" rel="noopener">https://www.runoob.com/linux/linux-comm-awk.html</a></p>
<p>主机测试如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# nsenter --net=/proc/1/ns/net ip -o addr | awk '&#123;print $4&#125;'</span><br><span class="line">127.0.0.1/8</span><br><span class="line">::1/128</span><br><span class="line">192.168.19.84/16</span><br><span class="line">fe80::250:56ff:fe82:8bd7/64</span><br><span class="line">172.17.0.1/16</span><br><span class="line">fe80::42:8aff:fe54:fa57/64</span><br><span class="line">10.244.0.0/32</span><br><span class="line">fe80::e4a0:b4ff:fe2e:2c1f/64</span><br><span class="line">10.244.0.1/24</span><br><span class="line">fe80::a4b8:52ff:fef8:6b8a/64</span><br><span class="line">fe80::24c6:d7ff:fe20:b8b7/64</span><br><span class="line">fe80::e83b:a4ff:fe7b:7321/64</span><br><span class="line">fe80::d44b:31ff:fe17:a41c/64</span><br><span class="line">fe80::5855:4fff:feef:92f0/64</span><br><span class="line">fe80::c09c:62ff:fe21:df97/64</span><br><span class="line">fe80::b8ba:35ff:fe1f:505f/64</span><br><span class="line">fe80::186e:7aff:fe98:59e4/64</span><br><span class="line">fe80::4cb5:dff:fea6:d245/64</span><br><span class="line">fe80::4468:7bff:fe40:6b09/64</span><br><span class="line">fe80::61:aeff:fece:58ee/64</span><br><span class="line">fe80::30ee:22ff:fee8:2fee/64</span><br></pre></td></tr></table></figure>
<p>之后通过tee命令将结果写入到<code>/host/ips/ips.txt</code>中。</p>
<p>从这里我们就可以看到，初始化容器的作用就是获取主机的ip地址信息，并将结果存入到<code>ips.txt</code>中。 Init 容器初始化完毕后就会自动终止，但是 Init 容器初始化结果会保留到应用容器和sidecar容器中。</p>
<p><code>containers</code></p>
<p><code>containers</code>和初始化容器的镜像是相同的。<code>containers</code>中也有两个<code>mountPath</code>。用到了<code>.spec.volumes</code>下的<code>host-ips</code>和<code>sys-fs</code>，挂载路径为容器中的<code>/host/ips</code>和<code>/sys/fs</code>，通过<code>securityContext</code>定义了容器需要特权模式运行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">containers:</span><br><span class="line">      - image: ghcr.io/merbridge/merbridge:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: merbridge</span><br><span class="line">        args: #为容器设置启动时要执行的命令和参数</span><br><span class="line">        - /app/mbctl</span><br><span class="line">        - -m</span><br><span class="line">        - istio</span><br><span class="line">        - --ips-file</span><br><span class="line">        - /host/ips/ips.txt</span><br><span class="line">        lifecycle: </span><br><span class="line">          preStop: </span><br><span class="line">            exec:</span><br><span class="line">              command: </span><br><span class="line">              - make</span><br><span class="line">              - -k</span><br><span class="line">              - clean</span><br><span class="line">        resources: </span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 300m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        securityContext: </span><br><span class="line">          privileged: true</span><br><span class="line">        volumeMounts: </span><br><span class="line">          - mountPath: /sys/fs</span><br><span class="line">            name: sys-fs</span><br><span class="line">          - mountPath: /host/ips</span><br><span class="line">            name: host-ips</span><br></pre></td></tr></table></figure>
<p>看一下该容器中的执行参数。通过源码我们看到<code>-m</code>是服务网格的模式，当前所支持的是<code>istio</code>和<code>linkerd</code>。这里我们使用的是<code>istio</code>，<code>--ips-file</code>是当前节点的ip信息的文件名，即在<code>initContainers</code>中我们将ip信息写入的路径<code>/host/ips/ips.txt</code>。</p>
<p><code>lifecycle</code>字段是管理容器在运行前和关闭前的一些动作。其中<code>preStop</code>是容器被终止前的任务，用于优雅关闭应用程序、通知其他系统。这里在容器被终止前执行<code>make clean</code>用于清除之前编译的可执行文件及配置文件。</p>
<p>第五段，pod相应策略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dnsPolicy: ClusterFirst #针对每个Pod设置DNS的策略,ClusterFirst为默认配置</span><br><span class="line">nodeSelector: #约束一个Pod只能在特定的节点上运行</span><br><span class="line">  kubernetes.io/os: linux</span><br><span class="line">priorityClassName: system-node-critical #将Pod标记为关键性</span><br><span class="line">restartPolicy: Always</span><br><span class="line">serviceAccount: merbridge</span><br><span class="line">serviceAccountName: merbridge</span><br><span class="line">tolerations: #应用于Pod上的，允许Pod调度到带有与之匹配的污点的节点上。</span><br><span class="line">- key: CriticalAddonsOnly #允许pod被重新调度</span><br><span class="line">  operator: Exists</span><br><span class="line">- operator: Exists</span><br></pre></td></tr></table></figure>
<h4 id="eBPF程序分析"><a href="#eBPF程序分析" class="headerlink" title="eBPF程序分析"></a>eBPF程序分析</h4><h5 id="helpers-h"><a href="#helpers-h" class="headerlink" title="helpers.h"></a><code>helpers.h</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf_common.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/swab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __BYTE_ORDER__ == __ORDER_LITTLE_ENDIAN__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bpf_htons(x) __builtin_bswap16(x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bpf_htonl(x) __builtin_bswap32(x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> __BYTE_ORDER__ == __ORDER_BIG_ENDIAN__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bpf_htons(x) (x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bpf_htonl(x) (x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">"__BYTE_ORDER__ error"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __section</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __section(NAME) __attribute__((section(NAME), used))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//存储socket信息的映射表</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> &#123;</span></span><br><span class="line">    __u32 type;</span><br><span class="line">    __u32 key_size;</span><br><span class="line">    __u32 value_size;</span><br><span class="line">    __u32 max_entries;</span><br><span class="line">    __u32 map_flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取组id</span></span><br><span class="line"><span class="keyword">static</span> __u64 (*bpf_get_current_pid_tgid)() = (<span class="keyword">void</span> *)</span><br><span class="line">    BPF_FUNC_get_current_pid_tgid;</span><br><span class="line"><span class="comment">//获取uid</span></span><br><span class="line"><span class="keyword">static</span> __u64 (*bpf_get_current_uid_gid)() = (<span class="keyword">void</span> *)</span><br><span class="line">    BPF_FUNC_get_current_uid_gid;</span><br><span class="line"><span class="comment">//根据用户定义的输出，将BPF程序产生的对应日志消息保存在用来跟踪内核的文件夹</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">void</span> <span class="params">(*bpf_trace_printk)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, <span class="keyword">int</span> fmt_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                                ...)</span> </span>= (<span class="keyword">void</span> *)BPF_FUNC_trace_printk;</span><br><span class="line"><span class="comment">//用当前进程名字填充第一个参数地址</span></span><br><span class="line"><span class="keyword">static</span> __u64 (*bpf_get_current_comm)(<span class="keyword">void</span> *buf, __u32 size_of_buf) = (<span class="keyword">void</span> *)</span><br><span class="line">    BPF_FUNC_get_current_comm;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取套接字的cookie，套接字通过bpf_sock_ops获得</span></span><br><span class="line"><span class="keyword">static</span> __u64 (*bpf_get_socket_cookie_ops)(struct bpf_sock_ops *skops) = (<span class="keyword">void</span> *)</span><br><span class="line">    BPF_FUNC_get_socket_cookie;</span><br><span class="line"><span class="comment">//获取套接字的cookie，套接字通过bpf_sock_addr获得</span></span><br><span class="line"><span class="keyword">static</span> __u64 (*bpf_get_socket_cookie_addr)(struct bpf_sock_addr *ctx) = (<span class="keyword">void</span> *)</span><br><span class="line">    BPF_FUNC_get_socket_cookie;</span><br><span class="line"><span class="comment">//在bpf_map中查找与key关联的条目</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *(*bpf_map_lookup_elem)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">const</span> <span class="keyword">void</span> *key) =</span><br><span class="line">    (<span class="keyword">void</span> *)BPF_FUNC_map_lookup_elem;</span><br><span class="line"><span class="comment">//添加或更新map中key关联的条目</span></span><br><span class="line"><span class="keyword">static</span> __u64 (*bpf_map_update_elem)(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">const</span> <span class="keyword">void</span> *key,</span><br><span class="line">                                    <span class="keyword">const</span> <span class="keyword">void</span> *value, __u64 flags) = (<span class="keyword">void</span> *)</span><br><span class="line">    BPF_FUNC_map_update_elem;</span><br><span class="line"><span class="comment">//在子网络名称空间netns中查找与TCP套接字匹配的元组</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">bpf_sock</span> *(*<span class="title">bpf_sk_lookup_tcp</span>)(</span></span><br><span class="line"><span class="class">    <span class="title">void</span> *<span class="title">ctx</span>, <span class="title">struct</span> <span class="title">bpf_sock_tuple</span> *<span class="title">tuple</span>, __<span class="title">u32</span> <span class="title">tuple_size</span>, __<span class="title">u64</span> <span class="title">netns</span>,</span></span><br><span class="line"><span class="class">    __<span class="title">u64</span> <span class="title">flags</span>) = (<span class="title">void</span> *)<span class="title">BPF_FUNC_sk_lookup_tcp</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">long</span> <span class="params">(*bpf_sk_release)</span><span class="params">(struct bpf_sock *sock)</span> </span>= (<span class="keyword">void</span> *)</span><br><span class="line">    BPF_FUNC_sk_release;</span><br><span class="line"><span class="comment">//添加或更新引用套接字的sockhash map</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">long</span> <span class="params">(*bpf_sock_hash_update)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    struct bpf_sock_ops *skops, struct bpf_map *<span class="built_in">map</span>, <span class="keyword">void</span> *key,</span></span></span><br><span class="line"><span class="function"><span class="params">    __u64 flags)</span> </span>= (<span class="keyword">void</span> *)BPF_FUNC_sock_hash_update;</span><br><span class="line"><span class="comment">//消息重定向</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">long</span> <span class="params">(*bpf_msg_redirect_hash)</span><span class="params">(struct sk_msg_md *md, struct bpf_map *<span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">void</span> *key, __u64 flags)</span> </span>= (<span class="keyword">void</span> *)</span><br><span class="line">    BPF_FUNC_msg_redirect_hash;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> PRINTNL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRINT_SUFFIX <span class="meta-string">"\n"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PRINT_SUFFIX <span class="meta-string">""</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> printk</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> printk(fmt, ...)                                                       \</span></span><br><span class="line">    (&#123;                                                                         \</span><br><span class="line">        <span class="keyword">char</span> ____fmt[] = fmt PRINT_SUFFIX;                                     \</span><br><span class="line">        bpf_trace_printk(____fmt, <span class="keyword">sizeof</span>(____fmt), ##__VA_ARGS__);             \</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> DEBUG</span></span><br><span class="line"><span class="comment">// do nothing</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> debugf(fmt, ...) (&#123;&#125;)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="comment">// only print traceing in debug mode</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> debugf</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> debugf(fmt, ...)                                                       \</span></span><br><span class="line">    (&#123;                                                                         \</span><br><span class="line">        <span class="keyword">char</span> ____fmt[] = <span class="string">"[debug] "</span> fmt PRINT_SUFFIX;                          \</span><br><span class="line">        bpf_trace_printk(____fmt, <span class="keyword">sizeof</span>(____fmt), ##__VA_ARGS__);             \</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">is_port_listen_current_ns</span><span class="params">(<span class="keyword">void</span> *ctx, __u16 port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_sock_tuple</span> <span class="title">tuple</span> = &#123;</span>&#125;;</span><br><span class="line">    tuple.ipv4.dport = bpf_htons(port);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bpf_sock</span> *<span class="title">s</span> = <span class="title">bpf_sk_lookup_tcp</span>(<span class="title">ctx</span>, &amp;<span class="title">tuple</span>, <span class="title">sizeof</span>(<span class="title">tuple</span>.<span class="title">ipv4</span>),</span></span><br><span class="line"><span class="class">                                           <span class="title">BPF_F_CURRENT_NETNS</span>, 0);</span></span><br><span class="line">    <span class="keyword">if</span> (s) &#123;</span><br><span class="line">        bpf_sk_release(s);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//存储源信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">origin_info</span> &#123;</span></span><br><span class="line">    __u32 pid;</span><br><span class="line">    __u32 ip;</span><br><span class="line">    __u16 port;</span><br><span class="line">    <span class="comment">// last bit means that ip of process is detected.</span></span><br><span class="line">    __u16 flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//存储源ip 目的ip 源端口和目的端口</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pair</span> &#123;</span></span><br><span class="line">    __u32 sip;</span><br><span class="line">    __u32 dip;</span><br><span class="line">    __u16 sport;</span><br><span class="line">    __u16 dport;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="maps-h"><a href="#maps-h" class="headerlink" title="maps.h"></a><code>maps.h</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"helpers.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//保存原始目的地址信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> __<span class="title">section</span>("<span class="title">maps</span>") <span class="title">cookie_original_dst</span> = &#123;</span></span><br><span class="line">    .type = BPF_MAP_TYPE_LRU_HASH,</span><br><span class="line">    .key_size = <span class="keyword">sizeof</span>(__u32),</span><br><span class="line">    .value_size = <span class="keyword">sizeof</span>(struct origin_info),</span><br><span class="line">    .max_entries = <span class="number">65535</span>,</span><br><span class="line">    .map_flags = <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存当前节点中的pod的ip信息,将已经注入Sidecar的Pod IP地址写入local_pod_ips</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> __<span class="title">section</span>("<span class="title">maps</span>") <span class="title">local_pod_ips</span> = &#123;</span></span><br><span class="line">    .type = BPF_MAP_TYPE_HASH,</span><br><span class="line">    .key_size = <span class="keyword">sizeof</span>(__u32),</span><br><span class="line">    .value_size = <span class="keyword">sizeof</span>(__u32),</span><br><span class="line">    .max_entries = <span class="number">1024</span>,</span><br><span class="line">    .map_flags = <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存envoy的ip地址</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> __<span class="title">section</span>("<span class="title">maps</span>") <span class="title">process_ip</span> = &#123;</span></span><br><span class="line">    .type = BPF_MAP_TYPE_LRU_HASH,</span><br><span class="line">    .key_size = <span class="keyword">sizeof</span>(__u32),</span><br><span class="line">    .value_size = <span class="keyword">sizeof</span>(__u32),</span><br><span class="line">    .max_entries = <span class="number">1024</span>,</span><br><span class="line">    .map_flags = <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存四元组信息和对应的原始目的地址</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> __<span class="title">section</span>("<span class="title">maps</span>") <span class="title">pair_original_dst</span> = &#123;</span></span><br><span class="line">    .type = BPF_MAP_TYPE_LRU_HASH,</span><br><span class="line">    .key_size = <span class="keyword">sizeof</span>(struct pair),</span><br><span class="line">    .value_size = <span class="keyword">sizeof</span>(struct origin_info),</span><br><span class="line">    .max_entries = <span class="number">65535</span>,</span><br><span class="line">    .map_flags = <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存当前sock和四元组信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map</span> __<span class="title">section</span>("<span class="title">maps</span>") <span class="title">sock_pair_map</span> = &#123;</span></span><br><span class="line">    .type = BPF_MAP_TYPE_SOCKHASH,</span><br><span class="line">    .key_size = <span class="keyword">sizeof</span>(struct pair),</span><br><span class="line">    .value_size = <span class="keyword">sizeof</span>(__u32),</span><br><span class="line">    .max_entries = <span class="number">65535</span>,</span><br><span class="line">    .map_flags = <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="mb-bind-c"><a href="#mb-bind-c" class="headerlink" title="mb_bind.c"></a><code>mb_bind.c</code></h5><p>劫持 bind 系统调用并修改地址。目前该项目支持<code>Istio</code>和<code>linkerd</code>，<code>mb_bind.c</code>程序会判断<code>mesh</code>的类型是否为<code>linkerd</code>，如果是会将监听地址从<code>127.0.0.1:4140</code>变为<code>0.0.0.0:4140</code>，<code>4140</code>端口是<code>linkerd</code>的出站流量重定向端口。</p>
<p>在<code>mb_connect.c</code>中，作者为了避免四元组产生冲突，将目的地址修改为<code>127.x.y.z</code>而不是<code>127.0.0.1</code>，而在<code>linkerd</code>源码中是不允许修改的，如下图所示</p>
<p><img src="/2022/02/28/从0到0-5-eBPF加速ServiceMesh实践/2.png" alt="2"></p>
<p>针对该代码的具体细则可参考链接：<a href="https://github.com/linkerd/linkerd2-proxy/pull/1442" target="_blank" rel="noopener">https://github.com/linkerd/linkerd2-proxy/pull/1442</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/helpers.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/mesh.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__section(<span class="string">"cgroup/bind4"</span>) <span class="function"><span class="keyword">int</span> <span class="title">mb_bind</span><span class="params">(struct bpf_sock_addr *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> MESH != LINKERD</span></span><br><span class="line">    <span class="comment">// only works on linkerd</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;user_ip4 == <span class="number">0x0100007f</span> &amp;&amp;</span><br><span class="line">        ctx-&gt;user_port == bpf_htons(OUT_REDIRECT_PORT)) &#123;</span><br><span class="line">        __u64 uid = bpf_get_current_uid_gid() &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">        <span class="keyword">if</span> (uid == SIDECAR_USER_ID) &#123;</span><br><span class="line">            printk(<span class="string">"change bind address from 127.0.0.1:%d to 0.0.0.0:%d"</span>,</span><br><span class="line">                   OUT_REDIRECT_PORT, OUT_REDIRECT_PORT);</span><br><span class="line">            ctx-&gt;user_ip4 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> ____license[] __section(<span class="string">"license"</span>) = <span class="string">"GPL"</span>;</span><br><span class="line"><span class="keyword">int</span> _version __section(<span class="string">"version"</span>) = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h5 id="mb-connect-c"><a href="#mb-connect-c" class="headerlink" title="mb_connect.c"></a><code>mb_connect.c</code></h5><p>劫持<code>connect</code>系统调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/helpers.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/maps.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/mesh.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> __u32 outip = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">__section(<span class="string">"cgroup/connect4"</span>) <span class="function"><span class="keyword">int</span> <span class="title">mb_sock4_connect</span><span class="params">(struct bpf_sock_addr *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// init，处理TCP流量</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;protocol != IPPROTO_TCP) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    __u32 pid = bpf_get_current_pid_tgid() &gt;&gt; <span class="number">32</span>; <span class="comment">// tgid</span></span><br><span class="line">    __u64 uid = bpf_get_current_uid_gid() &amp; <span class="number">0xffffffff</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断端口是否在监听当前的netns，以istio为例，OUT_REDIRECT_PORT是15001</span></span><br><span class="line">    <span class="comment">//如果15001端口没有监听当前ns，则绕过，只需要处理istio管理的pod间流量</span></span><br><span class="line">    <span class="keyword">if</span> (!is_port_listen_current_ns(ctx, OUT_REDIRECT_PORT)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//istio-proxy用户身份 uid为1337</span></span><br><span class="line">    <span class="comment">//1.如果uid不是1337</span></span><br><span class="line">    <span class="keyword">if</span> (uid != SIDECAR_USER_ID) &#123;</span><br><span class="line">        <span class="comment">//1.1进一步判断如果应用调用的是本地即127开头的话，则绕过</span></span><br><span class="line">        <span class="keyword">if</span> ((ctx-&gt;user_ip4 &amp; <span class="number">0xff</span>) == <span class="number">0x7f</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.2.uid不是1337且应用没有调用本地</span></span><br><span class="line">        debugf(<span class="string">"call from user container: ip: 0x%x, port: %d"</span>, ctx-&gt;user_ip4,</span><br><span class="line">               bpf_htons(ctx-&gt;user_port));</span><br><span class="line">        <span class="comment">//需要重定向到envoy处理</span></span><br><span class="line">        __u64 cookie = bpf_get_socket_cookie_addr(ctx); <span class="comment">//获取当前netns的cookie</span></span><br><span class="line">        <span class="comment">//定义原始目的地址信息</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">origin_info</span> <span class="title">origin</span> = &#123;</span></span><br><span class="line">            .ip = ctx-&gt;user_ip4,</span><br><span class="line">            .port = ctx-&gt;user_port,</span><br><span class="line">            .pid = pid,</span><br><span class="line">            .flags = <span class="number">1</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将cookie和源地址信息更新到cookie_original_dst中，更新成功返回0，失败返回负值</span></span><br><span class="line">        <span class="keyword">if</span> (bpf_map_update_elem(&amp;cookie_original_dst, &amp;cookie, &amp;origin,</span><br><span class="line">                                BPF_ANY)) &#123;</span><br><span class="line">            printk(<span class="string">"write cookie_original_dst failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//应用向外发起连接时，将目标地址修改为 127.x.y.z:15001</span></span><br><span class="line">        <span class="comment">//之所以在connect时，修改目的地址为127.x.y.z而不是127.0.0.1</span></span><br><span class="line">        <span class="comment">//是因为在不同的Pod中，可能产生冲突的四元组，使用此方式即可巧妙地避开冲突</span></span><br><span class="line">        ctx-&gt;user_ip4 = bpf_htonl(<span class="number">0x7f800000</span> | (outip++));</span><br><span class="line">        <span class="keyword">if</span> (outip &gt;&gt; <span class="number">20</span>) &#123;</span><br><span class="line">            outip = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ctx-&gt;user_port = bpf_htons(OUT_REDIRECT_PORT);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//uid=1337</span></span><br><span class="line">        <span class="comment">//2.从envoy到其他的情况</span></span><br><span class="line">        debugf(<span class="string">"call from sidecar container: ip: 0x%x, port: %d"</span>, ctx-&gt;user_ip4,</span><br><span class="line">               bpf_htons(ctx-&gt;user_port));</span><br><span class="line">        __u32 ip = ctx-&gt;user_ip4;</span><br><span class="line">        <span class="keyword">if</span> (!bpf_map_lookup_elem(&amp;local_pod_ips, &amp;ip)) &#123;</span><br><span class="line">            <span class="comment">//2.1.目的ip没有在节点中，绕过</span></span><br><span class="line">            debugf(<span class="string">"dest ip: 0x%x not in this node, bypass"</span>, ctx-&gt;user_ip4);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.2.目的地址在当前节点，但是不在当前pod</span></span><br><span class="line">        __u64 cookie = bpf_get_socket_cookie_addr(ctx); <span class="comment">//获取当前netns的cookie</span></span><br><span class="line">        <span class="comment">//定义原始目的地址信息</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">origin_info</span> <span class="title">origin</span> = &#123;</span></span><br><span class="line">            .ip = ctx-&gt;user_ip4,</span><br><span class="line">            .port = ctx-&gt;user_port,</span><br><span class="line">            .pid = pid,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//在process_ip中查找pid信息，process_ip中存储envoy的ip地址</span></span><br><span class="line">        <span class="keyword">void</span> *curr_ip = bpf_map_lookup_elem(&amp;process_ip, &amp;pid);</span><br><span class="line">        <span class="comment">//2.2.1如果存在则属于envoy到其他envoy</span></span><br><span class="line">        <span class="keyword">if</span> (curr_ip) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*(__u32 *)curr_ip != ctx-&gt;user_ip4) &#123;</span><br><span class="line">                debugf(<span class="string">"enovy to other, rewrite dst port from %d to %d"</span>,</span><br><span class="line">                       ctx-&gt;user_port, IN_REDIRECT_PORT);</span><br><span class="line">                ctx-&gt;user_port = bpf_htons(IN_REDIRECT_PORT);</span><br><span class="line">            &#125;</span><br><span class="line">            origin.flags |= <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  <span class="comment">// 2.2.2.envoy到应用程序，不用重写</span></span><br><span class="line">            origin.flags = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_RECONNECT</span></span><br><span class="line">            <span class="comment">// envoy to envoy</span></span><br><span class="line">            <span class="comment">// try redirect to 15006</span></span><br><span class="line">            <span class="comment">// but it may cause error if it is envoy call self pod,</span></span><br><span class="line">            <span class="comment">// in this case, we can read src and dst ip in sockops,</span></span><br><span class="line">            <span class="comment">// if src is equals dst, it means envoy call self pod,</span></span><br><span class="line">            <span class="comment">// we should reject this traffic in sockops,</span></span><br><span class="line">            <span class="comment">// envoy will create a new connection to self pod.</span></span><br><span class="line">            ctx-&gt;user_port = bpf_htons(IN_REDIRECT_PORT);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bpf_map_update_elem(&amp;cookie_original_dst, &amp;cookie, &amp;origin,</span><br><span class="line">                                BPF_NOEXIST)) &#123;</span><br><span class="line">            printk(<span class="string">"update cookie origin failed"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> ____license[] __section(<span class="string">"license"</span>) = <span class="string">"GPL"</span>;</span><br><span class="line"><span class="keyword">int</span> _version __section(<span class="string">"version"</span>) = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h5 id="mb-get-sockopts-c"><a href="#mb-get-sockopts-c" class="headerlink" title="mb_get_sockopts.c"></a><code>mb_get_sockopts.c</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/helpers.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/maps.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_OPS_BUFF_LENGTH 4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SO_ORIGINAL_DST 80 <span class="comment">//80是ORIGINAL_DST在内核中的编号</span></span></span><br><span class="line"></span><br><span class="line">__section(<span class="string">"cgroup/getsockopt"</span>) <span class="function"><span class="keyword">int</span> <span class="title">mb_get_sockopt</span><span class="params">(struct bpf_sockopt *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//ebpf无法处理大于4096字节的数据</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;optlen &gt; MAX_OPS_BUFF_LENGTH) &#123;</span><br><span class="line">        debugf(<span class="string">"optname: %d, force set optlen to %d, original optlen %d is too "</span></span><br><span class="line">               <span class="string">"high"</span>,</span><br><span class="line">               ctx-&gt;optname, MAX_OPS_BUFF_LENGTH, ctx-&gt;optlen);</span><br><span class="line">        ctx-&gt;optlen = MAX_OPS_BUFF_LENGTH;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//代理把TCP连接拦截下来之后，并不知道原来的目标地址是什么，从而无法实现转发</span></span><br><span class="line">    <span class="comment">//Envoy收到连接之后会调用getsockopt获取原始目的信息</span></span><br><span class="line">    <span class="comment">//get_sockopts程序会根据四元组信息从pair_original_dst取出原始目的地址并返回给Envoy，由此连接完全建立</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;optname == SO_ORIGINAL_DST) &#123;</span><br><span class="line">        <span class="comment">//定义四元组结构体信息</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pair</span> <span class="title">p</span> = &#123;</span></span><br><span class="line">            .dip = ctx-&gt;sk-&gt;src_ip4,</span><br><span class="line">            .dport = bpf_htons(ctx-&gt;sk-&gt;src_port),</span><br><span class="line">            .sip = ctx-&gt;sk-&gt;dst_ip4,</span><br><span class="line">            .sport = bpf_htons(ctx-&gt;sk-&gt;dst_port),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//根据四元组信息从pair_original_dst取出原始目的地址并返回</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">origin_info</span> *<span class="title">origin</span> =</span></span><br><span class="line"><span class="class">            <span class="title">bpf_map_lookup_elem</span>(&amp;<span class="title">pair_original_dst</span>, &amp;<span class="title">p</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (origin) &#123; <span class="comment">// 重写原始目的地址</span></span><br><span class="line">            ctx-&gt;optlen = (__s32)<span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">            <span class="comment">//边界检查</span></span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">void</span> *)((struct sockaddr_in *)ctx-&gt;optval + <span class="number">1</span>) &gt;</span><br><span class="line">                ctx-&gt;optval_end) &#123;</span><br><span class="line">                printk(<span class="string">"optname: %d: invalid getsockopt optval"</span>, ctx-&gt;optname);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将系统调用返回值重置为零</span></span><br><span class="line">            ctx-&gt;retval = <span class="number">0</span>;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sa</span> = &#123;</span></span><br><span class="line">                .sin_family = ctx-&gt;sk-&gt;family,</span><br><span class="line">                .sin_addr.s_addr = origin-&gt;ip,</span><br><span class="line">                .sin_port = origin-&gt;port,</span><br><span class="line">            &#125;;</span><br><span class="line">            *(struct sockaddr_in *)ctx-&gt;optval = sa;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> ____license[] __section(<span class="string">"license"</span>) = <span class="string">"GPL"</span>;</span><br><span class="line"><span class="keyword">int</span> _version __section(<span class="string">"version"</span>) = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h5 id="mb-redir-c"><a href="#mb-redir-c" class="headerlink" title="mb_redir.c"></a><code>mb_redir.c</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/helpers.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/maps.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="comment">//在socket发起 sendmsg 系统调用时触发执行</span></span><br><span class="line">__section(<span class="string">"sk_msg"</span>) </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mb_msg_redir</span><span class="params">(struct sk_msg_md *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//这里的结构体就是sock_pair_map中的key</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pair</span> <span class="title">p</span> = &#123;</span></span><br><span class="line">        .sip = msg-&gt;local_ip4,</span><br><span class="line">        .sport = msg-&gt;local_port,</span><br><span class="line">        .dip = msg-&gt;remote_ip4,</span><br><span class="line">        .dport = msg-&gt;remote_port &gt;&gt; <span class="number">16</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//根据四元组信息，从sock_pair_map中读取sock</span></span><br><span class="line">    <span class="comment">//然后通过bpf_msg_redirect_hash直接转发，加速请求</span></span><br><span class="line">    <span class="keyword">long</span> ret = bpf_msg_redirect_hash(msg, &amp;sock_pair_map, &amp;p, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        debugf(<span class="string">"redirect %d bytes with eBPF successfully"</span>, msg-&gt;size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> ____license[] __section(<span class="string">"license"</span>) = <span class="string">"GPL"</span>;</span><br><span class="line"><span class="keyword">int</span> _version __section(<span class="string">"version"</span>) = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><code>bpf_msg_redirect_hash</code>参数解析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bpf_msg_redirect_hash(msg, &amp;sock_pair_map, &amp;p, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>msg：用户可访问的待发送数据的元信息</li>
<li>sock_pair_map：这个BPF程序attach到的<code>sockhash map</code></li>
<li>p：在<code>map</code>中索引用的<code>key</code></li>
<li>0：<code>BPF_F_INGRESS</code>，放到对端的哪个<code>queue</code></li>
</ul>
<h5 id="mb-sockops-c"><a href="#mb-sockops-c" class="headerlink" title="mb_sockops.c"></a><code>mb_sockops.c</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/helpers.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/maps.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"headers/mesh.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">sockops_ipv4</span><span class="params">(struct bpf_sock_ops *skops)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//获取当前netns的cookie</span></span><br><span class="line">    __u64 cookie = bpf_get_socket_cookie_ops(skops);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在cookie_original_dst查找与cookie相关的条目</span></span><br><span class="line">    <span class="keyword">void</span> *dst = bpf_map_lookup_elem(&amp;cookie_original_dst, &amp;cookie);</span><br><span class="line">    <span class="comment">//如果存在cookie</span></span><br><span class="line">    <span class="keyword">if</span> (dst) &#123;</span><br><span class="line">        <span class="comment">//dd保存原始目的信息</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">origin_info</span> <span class="title">dd</span> = *(<span class="title">struct</span> <span class="title">origin_info</span> *)<span class="title">dst</span>;</span></span><br><span class="line">        <span class="keyword">if</span> (!(dd.flags &amp; <span class="number">1</span>)) &#123;</span><br><span class="line">            __u32 pid = dd.pid;</span><br><span class="line">            <span class="comment">// 判断源IP和目的地址IP是否一致</span></span><br><span class="line">            <span class="keyword">if</span> (skops-&gt;local_ip4 == <span class="number">100663423</span> ||</span><br><span class="line">                skops-&gt;local_ip4 == skops-&gt;remote_ip4) &#123;</span><br><span class="line">                <span class="comment">//如果一致，代表发送了错误的请求</span></span><br><span class="line">                __u32 ip = skops-&gt;remote_ip4;</span><br><span class="line">                debugf(<span class="string">"detected process %d's ip is %d"</span>, pid, ip);</span><br><span class="line">                <span class="comment">//并将当前的ProcessID和IP信息写入process_ip这个map</span></span><br><span class="line">                bpf_map_update_elem(&amp;process_ip, &amp;pid, &amp;ip, BPF_ANY);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_RECONNECT</span></span><br><span class="line">                <span class="comment">//bpf_htons:主机序到网络序</span></span><br><span class="line">                <span class="comment">//判断远程端口是不是15006端口，如果是的话则丢弃这个连接</span></span><br><span class="line">                <span class="keyword">if</span> (skops-&gt;remote_port &gt;&gt; <span class="number">16</span> == bpf_htons(IN_REDIRECT_PORT)) &#123;</span><br><span class="line">                    printk(<span class="string">"incorrect connection: cookie=%d"</span>, cookie);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// envoy to envoy</span></span><br><span class="line">                __u32 ip = skops-&gt;local_ip4;</span><br><span class="line">                <span class="comment">//将当前的ProcessID和IP信息写入process_ip这个map</span></span><br><span class="line">                bpf_map_update_elem(&amp;process_ip, &amp;pid, &amp;ip, BPF_ANY);</span><br><span class="line">                debugf(<span class="string">"detected process %d's ip is %d"</span>, pid, ip);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// get_sockopts can read pid and cookie,</span></span><br><span class="line">        <span class="comment">// we should write a new map named pair_original_dst</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pair</span> <span class="title">p</span> = &#123;</span></span><br><span class="line">            .sip = skops-&gt;local_ip4,</span><br><span class="line">            .sport = skops-&gt;local_port,</span><br><span class="line">            .dip = skops-&gt;remote_ip4,</span><br><span class="line">            .dport = skops-&gt;remote_port &gt;&gt; <span class="number">16</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将四元组信息和对应的原始目的地址写入pair_original_dst中</span></span><br><span class="line">        bpf_map_update_elem(&amp;pair_original_dst, &amp;p, &amp;dd, BPF_NOEXIST);</span><br><span class="line">        <span class="comment">//将当前sock和四元组保存在sock_pair_map中</span></span><br><span class="line">        bpf_sock_hash_update(skops, &amp;sock_pair_map, &amp;p, BPF_NOEXIST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//监听socket事件</span></span><br><span class="line">__section(<span class="string">"sockops"</span>) <span class="function"><span class="keyword">int</span> <span class="title">mb_sockops</span><span class="params">(struct bpf_sock_ops *skops)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __u32 family, op;</span><br><span class="line">    family = skops-&gt;family;</span><br><span class="line">    op = skops-&gt;op;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (op) &#123;</span><br><span class="line">    <span class="comment">// case BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB://被动建连</span></span><br><span class="line">    <span class="keyword">case</span> BPF_SOCK_OPS_ACTIVE_ESTABLISHED_CB:  <span class="comment">// 主动建连</span></span><br><span class="line">        <span class="keyword">if</span> (family == <span class="number">2</span>) &#123; <span class="comment">// AFI_NET, we dont include socket.h, because it may</span></span><br><span class="line">                           <span class="comment">// cause an import error.</span></span><br><span class="line">            <span class="keyword">if</span> (sockops_ipv4(skops)) <span class="comment">//记录socket信息到sockmap</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> ____license[] __section(<span class="string">"license"</span>) = <span class="string">"GPL"</span>;</span><br><span class="line"><span class="keyword">int</span> _version __section(<span class="string">"version"</span>) = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h4 id="启用cgroupv2产生的问题"><a href="#启用cgroupv2产生的问题" class="headerlink" title="启用cgroupv2产生的问题"></a>启用cgroupv2产生的问题</h4><h5 id="如何启动cgroupv2"><a href="#如何启动cgroupv2" class="headerlink" title="如何启动cgroupv2"></a>如何启动cgroupv2</h5><p>调整<code>grub linux</code>内核引导参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/default/grub</span><br></pre></td></tr></table></figure>
<p>修改<code>GRUB_CMDLINE_LINUX</code>为<code>systemd.unified_cgroup_hierarchy=1</code></p>
<p>更新<code>grub</code>并重启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-grub</span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>
<p>判断是否启用cgroupv2</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~$ cat /sys/fs/cgroup/cgroup.controllers</span><br><span class="line">cpuset cpu io memory hugetlb pids rdma</span><br></pre></td></tr></table></figure>
<p>在没有启用<code>cgroupv2</code>时，拉取<code>merbridge</code>镜像之后，执行<code>docker run</code>指令会报如下错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# docker run -it --privileged 605389bb6641</span><br><span class="line">[ -f bpf/mb_connect.c ] &amp;&amp; make -C bpf load || make -C bpf load-from-obj</span><br><span class="line">make[1]: Entering directory '/app/bpf'</span><br><span class="line">Makefile:29: *** It looks like your system does not have cgroupv2 enabled, or the automatic recognition fails. Please enable cgroupv2, or specify the path of cgroupv2 manually via CGROUP2_PATH parameter..  Stop.</span><br><span class="line">make[1]: Leaving directory '/app/bpf'</span><br><span class="line">make[1]: Entering directory '/app/bpf'</span><br><span class="line">Makefile:29: *** It looks like your system does not have cgroupv2 enabled, or the automatic recognition fails. Please enable cgroupv2, or specify the path of cgroupv2 manually via CGROUP2_PATH parameter..  Stop.</span><br><span class="line">make[1]: Leaving directory '/app/bpf'</span><br><span class="line">make: *** [Makefile:3: load] Error 2</span><br><span class="line">panic: unexpected exit code: 2, err: exit status 2</span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">main.main()</span><br><span class="line">        /app/cmd/mbctl/main.go:68 +0x725</span><br></pre></td></tr></table></figure>
<p>启用<code>cgroupv2</code>之后，<code>docker run</code>执行正常，可是k8s运行yaml会失败，查看pod报错如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# kubectl get pods -n istio-system</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS      AGE</span><br><span class="line">istio-egressgateway-79bb75fcf9-lttmn    1/1     Running   1             3h10m</span><br><span class="line">istio-ingressgateway-84bfcfd895-p4wbx   1/1     Running   1             3h10m</span><br><span class="line">istiod-6c5cfd79db-vqvws                 1/1     Running   1             3h12m</span><br><span class="line">merbridge-9dhf2                         0/1     Error     1 (15s ago)   23s</span><br><span class="line">root@ubuntu:~# kubectl logs merbridge-9dhf2 -n istio-system</span><br><span class="line">[ -f bpf/mb_connect.c ] &amp;&amp; make -C bpf load || make -C bpf load-from-obj</span><br><span class="line">make[1]: Entering directory '/app/bpf'</span><br><span class="line">clang -O2 -g  -Wall -target bpf -I/usr/include/x86_64-linux-gnu  -DMESH=1 -DUSE_RECONNECT -c mb_connect.c -o mb_connect.o</span><br><span class="line">clang -O2 -g  -Wall -target bpf -I/usr/include/x86_64-linux-gnu  -DMESH=1 -DUSE_RECONNECT -c mb_get_sockopts.c -o mb_get_sockopts.o</span><br><span class="line">clang -O2 -g  -Wall -target bpf -I/usr/include/x86_64-linux-gnu  -DMESH=1 -DUSE_RECONNECT -c mb_redir.c -o mb_redir.o</span><br><span class="line">clang -O2 -g  -Wall -target bpf -I/usr/include/x86_64-linux-gnu  -DMESH=1 -DUSE_RECONNECT -c mb_sockops.c -o mb_sockops.o</span><br><span class="line">clang -O2 -g  -Wall -target bpf -I/usr/include/x86_64-linux-gnu  -DMESH=1 -DUSE_RECONNECT -c mb_bind.c -o mb_bind.o</span><br><span class="line">[ -f /sys/fs/bpf/cookie_original_dst ] || sudo bpftool map create /sys/fs/bpf/cookie_original_dst type lru_hash key 4 value 12 entries 65535 name cookie_original_dst</span><br><span class="line">[ -f /sys/fs/bpf/local_pod_ips ] || sudo bpftool map create /sys/fs/bpf/local_pod_ips type hash key 4 value 4 entries 1024 name local_pod_ips</span><br><span class="line">[ -f /sys/fs/bpf/process_ip ] || sudo bpftool map create /sys/fs/bpf/process_ip type lru_hash key 4 value 4 entries 1024 name process_ip</span><br><span class="line">sudo bpftool prog load mb_connect.o /sys/fs/bpf/connect \</span><br><span class="line">        map name cookie_original_dst pinned /sys/fs/bpf/cookie_original_dst \</span><br><span class="line">        map name local_pod_ips pinned /sys/fs/bpf/local_pod_ips \</span><br><span class="line">        map name process_ip pinned /sys/fs/bpf/process_ip</span><br><span class="line">sudo bpftool cgroup attach /sys/fs/cgroup /sys/fs/cgroup/unified connect4 pinned /sys/fs/bpf/connect</span><br><span class="line">Error: invalid attach type</span><br><span class="line">make[1]: *** [Makefile:90: load-connect] Error 255</span><br><span class="line">make[1]: Leaving directory '/app/bpf'</span><br><span class="line">make[1]: Entering directory '/app/bpf'</span><br><span class="line">[ -f /sys/fs/bpf/cookie_original_dst ] || sudo bpftool map create /sys/fs/bpf/cookie_original_dst type lru_hash key 4 value 12 entries 65535 name cookie_original_dst</span><br><span class="line">[ -f /sys/fs/bpf/local_pod_ips ] || sudo bpftool map create /sys/fs/bpf/local_pod_ips type hash key 4 value 4 entries 1024 name local_pod_ips</span><br><span class="line">[ -f /sys/fs/bpf/process_ip ] || sudo bpftool map create /sys/fs/bpf/process_ip type lru_hash key 4 value 4 entries 1024 name process_ip</span><br><span class="line">sudo bpftool prog load mb_connect.o /sys/fs/bpf/connect \</span><br><span class="line">        map name cookie_original_dst pinned /sys/fs/bpf/cookie_original_dst \</span><br><span class="line">        map name local_pod_ips pinned /sys/fs/bpf/local_pod_ips \</span><br><span class="line">        map name process_ip pinned /sys/fs/bpf/process_ip</span><br><span class="line">Error: failed to pin program cgroup/connect4</span><br><span class="line">make[1]: *** [Makefile:89: load-connect] Error 255</span><br><span class="line">make[1]: Leaving directory '/app/bpf'</span><br><span class="line">make: *** [Makefile:3: load] Error 2</span><br><span class="line">panic: unexpected exit code: 2, err: exit status 2</span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">main.main()</span><br><span class="line">        /app/cmd/mbctl/main.go:68 +0x725</span><br></pre></td></tr></table></figure>
<p>最后发现，cgroup v2 是单一层级树，因此只有一个挂载点即<code>/sys/fs/cgroup/unified</code></p>
<p><a href="https://github.com/merbridge/merbridge/issues/60" target="_blank" rel="noopener">https://github.com/merbridge/merbridge/issues/60</a></p>
<h4 id="iptables注入解析"><a href="#iptables注入解析" class="headerlink" title="iptables注入解析"></a>iptables注入解析</h4><p>查看<code>productpage</code> pod的<code>istio-proxy</code>容器中的进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# docker top `docker ps|grep "istio-proxy_productpage"|cut -d " " -f1`</span><br><span class="line">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class="line">1337                9391                9369                0                   Feb16               ?                   00:03:14            /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --proxyLogLevel=warning --proxyComponentLogLevel=misc:error --log_output_level=default:info --concurrency 2</span><br><span class="line">1337                10017               9391                0                   Feb16               ?                   00:18:42            /usr/local/bin/envoy -c etc/istio/proxy/envoy-rev0.json --restart-epoch 0 --drain-time-s 45 --drain-strategy immediate --parent-shutdown-time-s 60 --local-address-ip-version v4 --bootstrap-version 3 --file-flush-interval-msec 1000 --disable-hot-restart --log-format %Y-%m-%dT%T.%fZ?%l?envoy %n?%v -l warning --component-log-level misc:error --concurrency 2</span><br></pre></td></tr></table></figure>
<p>nsenter进入sidecar容器的命名空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~# nsenter -n --target 9391</span><br></pre></td></tr></table></figure>
<p>在该进程的命名空间下查看其 iptables 规则链</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看NAT表中规则配置的详细信息</span></span><br><span class="line">root@ubuntu:~# iptables -t nat -L -v</span><br><span class="line"><span class="meta">#</span><span class="bash">PREROUTING链：用于目标地址转换，将所有入站TCP流量跳转到ISTIO_INBOUND链上</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 215K packets, 13M bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> 216K   13M ISTIO_INBOUND  tcp  --  any    any     anywhere             anywhere</span><br><span class="line"><span class="meta">#</span><span class="bash">INPUT链：处理输入数据包，非TCP流量将继续走OUTPUT链</span></span><br><span class="line">Chain INPUT (policy ACCEPT 216K packets, 13M bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"><span class="meta">#</span><span class="bash">OUTPUT链：将所有出站数据包跳转到ISTIO_OUTPUT链上</span></span><br><span class="line">Chain OUTPUT (policy ACCEPT 25827 packets, 2191K bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> 7274  436K ISTIO_OUTPUT  tcp  --  any    any     anywhere             anywhere</span><br><span class="line"><span class="meta">#</span><span class="bash">POSTROUTING链：所有数据包流出网卡时都要先进入POSTROUTING链，内核根据数据包目的地判断是否转发</span></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 29847 packets, 2432K bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"><span class="meta">#</span><span class="bash">ISTIO_INBOUND链：将所有入站流量重定向到ISTIO_IN_REDIRECT链上</span></span><br><span class="line">Chain ISTIO_INBOUND (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line">    0     0 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15008</span><br><span class="line">    0     0 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh</span><br><span class="line">    0     0 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15090</span><br><span class="line"> 215K   13M RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15021</span><br><span class="line">    0     0 RETURN     tcp  --  any    any     anywhere             anywhere             tcp dpt:15020</span><br><span class="line"> 1256 75360 ISTIO_IN_REDIRECT  tcp  --  any    any     anywhere             anywhere</span><br><span class="line"><span class="meta">#</span><span class="bash">ISTIO_IN_REDIRECT链：将所有的入站流量跳转到本地的15006端口，至此成功的拦截了流量到sidecar中</span></span><br><span class="line">Chain ISTIO_IN_REDIRECT (3 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> 1256 75360 REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15006</span><br><span class="line"><span class="meta">#</span><span class="bash">ISTIO_OUTPUT链：选择需要重定向到Envoy（即本地） 的出站流量</span></span><br><span class="line">Chain ISTIO_OUTPUT (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> 2479  149K RETURN     all  --  any    lo      127.0.0.6            anywhere</span><br><span class="line">    0     0 ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner UID match 1337</span><br><span class="line">    0     0 RETURN     all  --  any    lo      anywhere             anywhere             ! owner UID match 1337</span><br><span class="line">  775 46500 RETURN     all  --  any    any     anywhere             anywhere             owner UID match 1337</span><br><span class="line">    0     0 ISTIO_IN_REDIRECT  all  --  any    lo      anywhere            !localhost            owner GID match 1337</span><br><span class="line">    0     0 RETURN     all  --  any    lo      anywhere             anywhere             ! owner GID match 1337</span><br><span class="line">    0     0 RETURN     all  --  any    any     anywhere             anywhere             owner GID match 1337</span><br><span class="line">    0     0 RETURN     all  --  any    any     anywhere             localhost</span><br><span class="line"> 4020  241K ISTIO_REDIRECT  all  --  any    any     anywhere             anywhere</span><br><span class="line"><span class="meta">#</span><span class="bash">ISTIO_REDIRECT链：将所有流量重定向到Sidecar（即本地）的15001端口</span></span><br><span class="line">Chain ISTIO_REDIRECT (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br><span class="line"> 4020  241K REDIRECT   tcp  --  any    any     anywhere             anywhere             redir ports 15001</span><br></pre></td></tr></table></figure>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://istio.io/latest/zh/docs/" target="_blank" rel="noopener">https://istio.io/latest/zh/docs/</a></li>
<li><a href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md" target="_blank" rel="noopener">https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md</a></li>
<li><a href="https://arthurchiao.art/blog/cgroupv2-zh/" target="_blank" rel="noopener">https://arthurchiao.art/blog/cgroupv2-zh/</a></li>
<li><a href="https://arthurchiao.art/blog/bpf-advanced-notes-1-zh/" target="_blank" rel="noopener">https://arthurchiao.art/blog/bpf-advanced-notes-1-zh/</a></li>
<li><a href="https://www.zsythink.net/archives/1199" target="_blank" rel="noopener">https://www.zsythink.net/archives/1199</a></li>
<li><a href="https://github.com/istio/istio/tree/master/samples" target="_blank" rel="noopener">https://github.com/istio/istio/tree/master/samples</a></li>
<li><a href="https://jimmysong.io/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/" target="_blank" rel="noopener">https://jimmysong.io/blog/envoy-sidecar-injection-in-istio-service-mesh-deep-dive/</a></li>
<li><a href="https://buaq.net/go-78524.html" target="_blank" rel="noopener">https://buaq.net/go-78524.html</a></li>
<li><a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/</a></li>
<li><a href="https://manpages.ubuntu.com/manpages/focal/man7/bpf-helpers.7.html" target="_blank" rel="noopener">https://manpages.ubuntu.com/manpages/focal/man7/bpf-helpers.7.html</a></li>
<li><a href="https://github.com/torvalds/linux/blob/master/tools/testing/selftests/bpf/progs/sockopt_sk.c" target="_blank" rel="noopener">https://github.com/torvalds/linux/blob/master/tools/testing/selftests/bpf/progs/sockopt_sk.c</a></li>
<li><a href="https://github.com/torvalds/linux/blob/cfb92440ee71adcc2105b0890bb01ac3cddb8507/include/uapi/linux/netfilter_ipv4.h#L52" target="_blank" rel="noopener">https://github.com/torvalds/linux/blob/cfb92440ee71adcc2105b0890bb01ac3cddb8507/include/uapi/linux/netfilter_ipv4.h#L52</a></li>
<li><a href="https://www.cnblogs.com/tencent-cloud-native/p/15696518.html" target="_blank" rel="noopener">https://www.cnblogs.com/tencent-cloud-native/p/15696518.html</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Cloud-Security/" rel="tag"># Cloud Security</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/01/21/浅入浅出eBPF/" rel="next" title="浅入浅出eBPF">
                <i class="fa fa-chevron-left"></i> 浅入浅出eBPF
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/03/18/略知一二之Cilium/" rel="prev" title="略知一二之Cilium">
                略知一二之Cilium <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/author2.png" alt="Elssm">
            
              <p class="site-author-name" itemprop="name">Elssm</p>
              <p class="site-description motion-element" itemprop="description">Web/Cloud/ML Security  Adversarial Training</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">86</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/elssm" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://leetcode.cn/u/elssm/" target="_blank" title="Leetcode">
                      
                        <i class="fa fa-fw fa-globe"></i>Leetcode</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#环境准备"><span class="nav-number">1.</span> <span class="nav-text">环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Docker安装"><span class="nav-number">1.1.</span> <span class="nav-text">Docker安装</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#安装依赖"><span class="nav-number">1.1.1.</span> <span class="nav-text">安装依赖</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#导入存储库的GPG密钥"><span class="nav-number">1.1.2.</span> <span class="nav-text">导入存储库的GPG密钥</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#添加Docker-APT存储库到系统"><span class="nav-number">1.1.3.</span> <span class="nav-text">添加Docker APT存储库到系统</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#安装Docker"><span class="nav-number">1.1.4.</span> <span class="nav-text">安装Docker</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Kubernetes安装"><span class="nav-number">1.2.</span> <span class="nav-text">Kubernetes安装</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#安装https工具使得apt支持ssl传输"><span class="nav-number">1.2.1.</span> <span class="nav-text">安装https工具使得apt支持ssl传输</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#使用阿里云的源"><span class="nav-number">1.2.2.</span> <span class="nav-text">使用阿里云的源</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#或使用中科大的源"><span class="nav-number">1.2.3.</span> <span class="nav-text">或使用中科大的源</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#下载相关工具"><span class="nav-number">1.2.4.</span> <span class="nav-text">下载相关工具</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#查看k8s版本"><span class="nav-number">1.2.5.</span> <span class="nav-text">查看k8s版本</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#初始化master节点"><span class="nav-number">1.2.6.</span> <span class="nav-text">初始化master节点</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#配置kubectl工具"><span class="nav-number">1.2.7.</span> <span class="nav-text">配置kubectl工具</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#查看节点状态"><span class="nav-number">1.2.8.</span> <span class="nav-text">查看节点状态</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#安装pod插件flannel"><span class="nav-number">1.2.9.</span> <span class="nav-text">安装pod插件flannel</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#再次查看节点状态"><span class="nav-number">1.2.10.</span> <span class="nav-text">再次查看节点状态</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#允许master部署pod"><span class="nav-number">1.2.11.</span> <span class="nav-text">允许master部署pod</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务网格"><span class="nav-number">2.</span> <span class="nav-text">服务网格</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Istio"><span class="nav-number">2.1.</span> <span class="nav-text">Istio</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#流量管理"><span class="nav-number">2.1.1.</span> <span class="nav-text">流量管理</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#安全"><span class="nav-number">2.1.2.</span> <span class="nav-text">安全</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#观察"><span class="nav-number">2.1.3.</span> <span class="nav-text">观察</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Istio"><span class="nav-number">2.2.</span> <span class="nav-text">安装Istio</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#下载1-11-6版本"><span class="nav-number">2.2.1.</span> <span class="nav-text">下载1.11.6版本</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#进入到下载目录"><span class="nav-number">2.2.2.</span> <span class="nav-text">进入到下载目录</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#添加istioctl客户端到路径"><span class="nav-number">2.2.3.</span> <span class="nav-text">添加istioctl客户端到路径</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#查看Istio部署模式"><span class="nav-number">2.2.4.</span> <span class="nav-text">查看Istio部署模式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#设置部署模式为demo"><span class="nav-number">2.2.5.</span> <span class="nav-text">设置部署模式为demo</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#添加命名空间的标签"><span class="nav-number">2.2.6.</span> <span class="nav-text">添加命名空间的标签</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#部署案例应用"><span class="nav-number">2.3.</span> <span class="nav-text">部署案例应用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#部署bookinfo案例"><span class="nav-number">2.3.1.</span> <span class="nav-text">部署bookinfo案例</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#查看pod情况"><span class="nav-number">2.3.2.</span> <span class="nav-text">查看pod情况</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#检查运行是否正常"><span class="nav-number">2.3.3.</span> <span class="nav-text">检查运行是否正常</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#开启外部访问"><span class="nav-number">2.4.</span> <span class="nav-text">开启外部访问</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#关联Istio网关"><span class="nav-number">2.4.1.</span> <span class="nav-text">关联Istio网关</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#查看服务外部访问方式"><span class="nav-number">2.4.2.</span> <span class="nav-text">查看服务外部访问方式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#修改访问方式为NodePort"><span class="nav-number">2.4.3.</span> <span class="nav-text">修改访问方式为NodePort</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#访问测试"><span class="nav-number">2.4.4.</span> <span class="nav-text">访问测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ebpf加速ServiceMesh实验"><span class="nav-number">3.</span> <span class="nav-text">ebpf加速ServiceMesh实验</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#升级内核"><span class="nav-number">3.1.</span> <span class="nav-text">升级内核</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#相关版本说明"><span class="nav-number">3.2.</span> <span class="nav-text">相关版本说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#yaml文件apply之前的ebpf数据"><span class="nav-number">3.3.</span> <span class="nav-text">yaml文件apply之前的ebpf数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#merbridge安装"><span class="nav-number">3.4.</span> <span class="nav-text">merbridge安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#确认ebpf程序生效"><span class="nav-number">3.5.</span> <span class="nav-text">确认ebpf程序生效</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#tps测试如下"><span class="nav-number">3.6.</span> <span class="nav-text">tps测试如下</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群测试"><span class="nav-number">4.</span> <span class="nav-text">集群测试</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#slave节点配置"><span class="nav-number">4.1.</span> <span class="nav-text">slave节点配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#外部向pod发送请求"><span class="nav-number">4.2.</span> <span class="nav-text">外部向pod发送请求</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#集群内"><span class="nav-number">4.2.1.</span> <span class="nav-text">集群内</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#集群间"><span class="nav-number">4.2.2.</span> <span class="nav-text">集群间</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#同一node下pod间发送请求"><span class="nav-number">4.3.</span> <span class="nav-text">同一node下pod间发送请求</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#pod内安装wrk"><span class="nav-number">4.3.1.</span> <span class="nav-text">pod内安装wrk</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#不同node下pod间发送请求"><span class="nav-number">4.4.</span> <span class="nav-text">不同node下pod间发送请求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#拓展：从控制平面节点以外的计算机控制集群"><span class="nav-number">4.5.</span> <span class="nav-text">拓展：从控制平面节点以外的计算机控制集群</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#merbridge-yaml文件解析-istio"><span class="nav-number">5.</span> <span class="nav-text">merbridge yaml文件解析(istio)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eBPF程序分析"><span class="nav-number">6.</span> <span class="nav-text">eBPF程序分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#helpers-h"><span class="nav-number">6.1.</span> <span class="nav-text">helpers.h</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#maps-h"><span class="nav-number">6.2.</span> <span class="nav-text">maps.h</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mb-bind-c"><span class="nav-number">6.3.</span> <span class="nav-text">mb_bind.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mb-connect-c"><span class="nav-number">6.4.</span> <span class="nav-text">mb_connect.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mb-get-sockopts-c"><span class="nav-number">6.5.</span> <span class="nav-text">mb_get_sockopts.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mb-redir-c"><span class="nav-number">6.6.</span> <span class="nav-text">mb_redir.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mb-sockops-c"><span class="nav-number">6.7.</span> <span class="nav-text">mb_sockops.c</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启用cgroupv2产生的问题"><span class="nav-number">7.</span> <span class="nav-text">启用cgroupv2产生的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#如何启动cgroupv2"><span class="nav-number">7.1.</span> <span class="nav-text">如何启动cgroupv2</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#iptables注入解析"><span class="nav-number">8.</span> <span class="nav-text">iptables注入解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考"><span class="nav-number">9.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Elssm</span>

  
</div>






  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div>



<span id="busuanzi_container_site_pv" class="theme-info">
&nbsp;&nbsp;|&nbsp;&nbsp;本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
  <span id="busuanzi_container_site_uv" class="theme-info">
&nbsp;&nbsp;|&nbsp;&nbsp;本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->



  


  




	





  





  












  





  

  

  

  
  

  
  


  

  

</body>
</html>
