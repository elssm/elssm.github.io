<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Linux,">










<meta name="description" content="前言最近因为一些原因开始学习eBPF，后续也将持续学习eBPF的一些具体应用。 BPF发展史 BPF介绍BPF(伯克利包过滤器)，也称为cBPF，在1992年提出，目的是为了提供一种过滤包的方法，并且要避免从内核空间到用户空间的无用的数据包复制行为。最初，BPF是在BSD内核实现的， 后来，由于其出色的设计思想，其他操作系统也将其引入, 包括Linux。 BPF架构如下图所示，从图中可以看到，BP">
<meta name="keywords" content="Linux">
<meta property="og:type" content="article">
<meta property="og:title" content="浅入浅出eBPF">
<meta property="og:url" content="elssm.github.io/2022/01/21/浅入浅出eBPF/index.html">
<meta property="og:site_name" content="ELSSM">
<meta property="og:description" content="前言最近因为一些原因开始学习eBPF，后续也将持续学习eBPF的一些具体应用。 BPF发展史 BPF介绍BPF(伯克利包过滤器)，也称为cBPF，在1992年提出，目的是为了提供一种过滤包的方法，并且要避免从内核空间到用户空间的无用的数据包复制行为。最初，BPF是在BSD内核实现的， 后来，由于其出色的设计思想，其他操作系统也将其引入, 包括Linux。 BPF架构如下图所示，从图中可以看到，BP">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="/2022/01/21/浅入浅出eBPF/3.jpeg">
<meta property="og:image" content="/2022/01/21/浅入浅出eBPF/1.png">
<meta property="og:image" content="/2022/01/21/浅入浅出eBPF/2.png">
<meta property="og:image" content="/2022/01/21/浅入浅出eBPF/5.png">
<meta property="og:image" content="/2022/01/21/浅入浅出eBPF/4.png">
<meta property="og:updated_time" content="2022-01-21T08:21:43.190Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浅入浅出eBPF">
<meta name="twitter:description" content="前言最近因为一些原因开始学习eBPF，后续也将持续学习eBPF的一些具体应用。 BPF发展史 BPF介绍BPF(伯克利包过滤器)，也称为cBPF，在1992年提出，目的是为了提供一种过滤包的方法，并且要避免从内核空间到用户空间的无用的数据包复制行为。最初，BPF是在BSD内核实现的， 后来，由于其出色的设计思想，其他操作系统也将其引入, 包括Linux。 BPF架构如下图所示，从图中可以看到，BP">
<meta name="twitter:image" content="/2022/01/21/浅入浅出eBPF/3.jpeg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="elssm.github.io/2022/01/21/浅入浅出eBPF/">





  <title>浅入浅出eBPF | ELSSM</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ELSSM</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="elssm.github.io/2022/01/21/浅入浅出eBPF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="elssm">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/author1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ELSSM">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">浅入浅出eBPF</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-01-21T09:19:21+08:00">
                2022-01-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>最近因为一些原因开始学习eBPF，后续也将持续学习eBPF的一些具体应用。</p>
<h4 id="BPF发展史"><a href="#BPF发展史" class="headerlink" title="BPF发展史"></a>BPF发展史</h4><p><img src="/2022/01/21/浅入浅出eBPF/3.jpeg" alt="3"></p>
<h4 id="BPF介绍"><a href="#BPF介绍" class="headerlink" title="BPF介绍"></a>BPF介绍</h4><p>BPF(伯克利包过滤器)，也称为cBPF，在1992年提出，目的是为了提供一种过滤包的方法，并且要避免从内核空间到用户空间的无用的数据包复制行为。最初，BPF是在BSD内核实现的， 后来，由于其出色的设计思想，其他操作系统也将其引入, 包括Linux。</p>
<p>BPF架构如下图所示，从图中可以看到，BPF是作为内核报文传输路径的一个旁路存在，当报文到达内核驱动程序后，内核在将报文上送协议栈的同时，会额外将报文的副本交给BPF，之后报文会经过BPF内部逻辑的过滤。</p>
<p><img src="/2022/01/21/浅入浅出eBPF/1.png" alt="1"></p>
<h4 id="eBPF介绍"><a href="#eBPF介绍" class="headerlink" title="eBPF介绍"></a>eBPF介绍</h4><p>eBPF是扩展的BPF，2014 年初，Alexei Starovoitov 实现了 eBPF（extended Berkeley Packet Filter）。经过重新设计，eBPF 演进为一个通用执行引擎，可基于此开发性能分析工具、软件定义网络等诸多场景。eBPF 最早出现在 3.18 内核中，此后原来的 BPF 就被称为经典 BPF，缩写 cBPF（classic BPF），cBPF 现在已经基本废弃。现在，Linux 内核只运行 eBPF，内核会将加载的 cBPF 字节码透明地转换成 eBPF 再执行。</p>
<p>从eBPF官网摘录下段文字说明</p>
<p>eBPF is a revolutionary technology with origins in the Linux kernel that can run sandboxed programs in an operating system kernel. It is used to safely and efficiently extend the capabilities of the kernel without requiring to change kernel source code or load kernel modules.（一项革新性技术！！！有苹果发布会内味。起源于Linux内核，可以在操作系统内核中运行沙箱程序，被用来安全的扩展内核功能，不用去更改内核源码或加载内核模块）</p>
<p>Historically, the operating system has always been an ideal place to implement observability, security, and networking functionality due to the kernel’s privileged ability to oversee and control the entire system. At the same time, an operating system kernel is hard to evolve due to its central role and high requirement towards stability and security. The rate of innovation at the operating system level has thus traditionally been lower compared to functionality implemented outside of the operating system.（操作系统一直是实现可观测性、安全性和网络功能的最佳场所，因为内核具有监视和控制整个系统的权限。同时，由于其核心作用和对于稳定性和安全性的高要求，使得它很难进化。因此，和在操作系统之外实现的功能相比，操作系统级别的创新率就会偏低）</p>
<p>eBPF changes this formula fundamentally. By allowing to run sandboxed programs within the operating system, application developers can run eBPF programs to add additional capabilities to the operating system at runtime. The operating system then guarantees safety and execution efficiency as if natively compiled with the aid of a Just-In-Time (JIT) compiler and verification engine. This has led to a wave of eBPF-based projects covering a wide array of use cases, including next-generation networking, observability, and security functionality.（eBPF从根本上改变了这个功能，通过允许在操作系统内运行沙箱程序，应用开发者可以通过运行eBPF程序在操作系统运行时添加额外功能。操作系统会保证安全性和执行效率，就像在JIT编译器和验证器的帮助下进行本机编译一样。接着就出现了一系列基于eBPF的项目，例如下一代网络、可观察性和安全功能等）</p>
<p>Today, eBPF is used extensively to drive a wide variety of use cases: Providing high-performance networking and load-balancing in modern data centers and cloud native environments, extracting fine-grained security observability data at low overhead, helping application developers trace applications, providing insights for performance troubleshooting, preventive application and container runtime security enforcement, and much more. The possibilities are endless, and the innovation that eBPF is unlocked has only just begun.（今天，eBPF被用于驱动各种各样的用例，例如在数据中心和云本机环境提供高性能网络和负载均衡、以较低的开销提取细粒度安全可观测性数据、帮助应用程序开发人员跟踪应用程序、为性能故障排除提供一些方法，预防应用程序和容器运行时的安全实施等等，eBPF有无限可能，eBPF才刚刚开始）</p>
<h4 id="eBPF对比cBPF"><a href="#eBPF对比cBPF" class="headerlink" title="eBPF对比cBPF"></a>eBPF对比cBPF</h4><p><strong>eBPF</strong>相对于<strong>cBPF</strong>的增强如下:</p>
<ul>
<li>处理器原生指令集建模，因此更接近底层处理器架构， 性能相比cBPF提升4倍</li>
<li>指令集从33个扩展到了114多个，依然保持了足够的简洁</li>
<li>寄存器从2个32位寄存器扩展到了11个 64 位的寄存器 (其中1个只读的栈指针)</li>
<li>引入 bpf_call 指令和寄存器传参约定，实现零(额外)开销内核函数调用</li>
<li>虚拟机的最大栈空间是 512 字节(cBPF 为 16 个字节)</li>
<li>引入了 map 结构，用于用户空间程序与内核中的 eBPF 程序数据交换</li>
<li>最大指令数初期为 4096，现在已经将这个限制放大到了100万条</li>
</ul>
<h4 id="eBPF工作机制"><a href="#eBPF工作机制" class="headerlink" title="eBPF工作机制"></a>eBPF工作机制</h4><p><img src="/2022/01/21/浅入浅出eBPF/2.png" alt="2"></p>
<p>eBPF分为用户空间和内核空间，用户空间和内核空间的交互有两种方式</p>
<ul>
<li>BPF map：用于将内核中实现的统计摘要信息（比如测量延迟、堆栈信息）等回传至用户空间</li>
<li>perf-event：用于将内核采集的事件实时发送至用户空间，用户空间程序实时读取分析</li>
</ul>
<p>eBPF的工作逻辑是</p>
<ul>
<li>BPF程序通过<code>LLVM/Clang</code>编译成eBPF定义的字节码<code>prog.bpf</code></li>
<li>通过bpf系统调用将bpf字节码指令传入内核</li>
<li>经过验证器检验字节码的安全性<ul>
<li>加载eBPF程序的进程具有所需的权限，除非启用了非特权eBPF，否则只有特权进程才能加载eBPF程序</li>
<li>程序不会崩溃或以其它方式损坏系统</li>
<li>程序始终可以运行完成</li>
</ul>
</li>
<li>在确认字节码安全后将其加载对应的内核模块执行，在BPF虚拟机中会判断是否开启JIT(即时编译)，如果开启了JIT，则会通过JIT解释器将程序字节码转为特定的机器码执行，如果没有开启JIT，则通过内核解释器执行</li>
</ul>
<p>eBPF观测技术相关的程序类型有<code>kprobes</code>、<code>uporbes</code>、<code>tracepoint</code>、<code>perf_event</code></p>
<ul>
<li>kprobes：实现内核中动态跟踪。kprobes可以跟踪到Linux内核中的函数入口或返回点，但是不是稳定ABI接口，可能会因为内核版本变化导致，导致跟踪失效。理论上可以跟踪到所有导出的符号<code>/proc/kallsyms</code>。</li>
<li>uprobes：用户级别的动态跟踪。与kprobes类似，只是跟踪的函数为用户程序中的函数。</li>
<li>tracepoints：内核中静态跟踪。tracepoints是内核开发人员维护的跟踪点，能够提供稳定的ABI接口，但是由于是研发人员维护，数量和场景可能受限。</li>
<li>perf_events：定时采样和PMC。</li>
</ul>
<h4 id="eBPF使用场景"><a href="#eBPF使用场景" class="headerlink" title="eBPF使用场景"></a>eBPF使用场景</h4><ul>
<li>系统性能监控/分析工具：能够实现性能监控工具、分析工具等常用的系统分析工具，比如 sysstate 工具集，里面提供了 vmstate，pidstat 等多种工具，一些常用的 top、netstat（netstat 可被 SS 替换掉），uptime、iostat 等这些工具多数都是从 /proc、/sys、/dev 中获取的会对系统产生一定的开销，不适合频繁的调用。比如在使用 top 的时候通过 cpu 排序可以看到 top cpu 占用也是挺高的，使用 eBPF 可以在开销相对小的情况下获取系统信息，定时将 eBPF 采集的数据 copy 到用户态，然后将其发送到分析监控平台。</li>
<li>用户程序活体分析：做用户程序活体分析，比如 openresty 中 lua 火焰图绘制，程序内存使用监控，cdn 服务异常请求分析，程序运行状态的查看，这些操作都可以在程序无感的情况下做到，可以有效提供服务质量。</li>
<li>防御攻击：比如 DDoS 攻击，DDoS 攻击主要是在第七层、第三层以及第四层。第七层的攻击如 http 攻击，需要应用服务这边处理。第四层攻击，如 tcp syn 可以通过 iptable 拒绝异常的 ip，当然前提是能发现以及难点是如何区分正常流量和攻击流量，简单的防攻击会导致一些误伤，另外 tcp syn 也可以通过内核参数保护应用服务。第 3 层攻击，如 icmp。对于攻击一般会通过一些特殊的途径去发现攻击，而攻击的防御则可以通过 XDP 直接在网络包未到网络栈之前就处理掉，性能非常的优秀。</li>
<li>流控：可以控制网络传输速率，比如 tc。</li>
<li>替换 iptable：在 k8s 中iptable的规则往往会相当庞大，而iptable规则越多，性能也越差，使用eBPF就可以解决</li>
<li>服务调优：在cdn服务中难免会出现一些指标突刺的情况，这种突刺拉高整体的指标，对于这种突刺时常会因为找不到切入点而无从下手，eBPF存在这种潜力能帮助分析解决该问题，当eBPF发现网络抖动，会主动采集当时应用的运行状态。</li>
</ul>
<h4 id="eBPF-hooks"><a href="#eBPF-hooks" class="headerlink" title="eBPF hooks"></a>eBPF hooks</h4><p>eBPF hooks即eBPF钩子，指的是在内核中哪些地方可以加载eBPF程序，在目前的Linux内核中已经有近10中钩子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kernel functions（kprobes）</span><br><span class="line">userspace functions（uprobes）</span><br><span class="line">system calls</span><br><span class="line">fentry/fexit</span><br><span class="line">Tracepoints</span><br><span class="line">network devices（tc/xdp）</span><br><span class="line">network routes</span><br><span class="line">TCP congestion algorithms</span><br><span class="line">sockets（data level）</span><br></pre></td></tr></table></figure>
<h4 id="eBPF-Map"><a href="#eBPF-Map" class="headerlink" title="eBPF Map"></a>eBPF Map</h4><p>在eBPF中可以利用map在eBPF程序调用之间保存状态信息，也可以利用map在用户态程序和内核之间共享数据等。内核提供了一个系统调用<code>bpf()</code>，以让用户态程序可以根据使用场景来创建合适的map。这个系统调用会返回一个关联了这个map对象的文件描述符，后续用户态程序可以用这个文件描述符来对相应的map对象进行一些操作，如查询、更新和删除，这部分的接口在<code>tools/lib/bpf/bpf.h</code>中定义了。关于这个<code>bpf()</code>系统调用以及map操作接口的详细信息，可以参考相关资料，其中<code>bpf()</code>系统调用相关的信息可以在<code>man page</code>中找到，而map操作相关的接口可以在 <code>tools/lib/bpf/bpf.h</code> 中看到具体的实现。</p>
<p>eBPF支持的map类型如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">BPF_MAP_TYPE_HASH：哈希表</span><br><span class="line">BPF_MAP_TYPE_ARRAY：数组映射，已针对快速查找速度进行了优化，通常用于计数器</span><br><span class="line">BPF_MAP_TYPE_PROG_ARRAY：对应eBPF程序的文件描述符数组；用于实现跳转表和子程序以处理特定的数据包协议</span><br><span class="line">BPF_MAP_TYPE_PERCPU_ARRAY：每个CPU的阵列，用于实现延迟的直方图</span><br><span class="line">BPF_MAP_TYPE_PERF_EVENT_ARRAY：存储指向struct perf_event的指针，用于读取和存储perf事件计数器</span><br><span class="line">BPF_MAP_TYPE_CGROUP_ARRAY：存储指向控制组的指针</span><br><span class="line">BPF_MAP_TYPE_PERCPU_HASH：每个CPU的哈希表</span><br><span class="line">BPF_MAP_TYPE_LRU_HASH：仅保留最近使用项目的哈希表</span><br><span class="line">BPF_MAP_TYPE_LRU_PERCPU_HASH：每个CPU的哈希表，仅保留最近使用的项目</span><br><span class="line">BPF_MAP_TYPE_LPM_TRIE：最长前缀匹配树，适用于将IP地址匹配到某个范围</span><br><span class="line">BPF_MAP_TYPE_STACK_TRACE：存储堆栈跟踪</span><br><span class="line">BPF_MAP_TYPE_ARRAY_OF_MAPS：地图中地图数据结构</span><br><span class="line">BPF_MAP_TYPE_HASH_OF_MAPS：地图中地图数据结构</span><br><span class="line">BPF_MAP_TYPE_DEVICE_MAP：用于存储和查找网络设备引用</span><br><span class="line">BPF_MAP_TYPE_SOCKET_MAP：存储和查找套接字，并允许使用BPF辅助函数进行套接字重定向</span><br></pre></td></tr></table></figure>
<h4 id="eBPF-Helper-Function"><a href="#eBPF-Helper-Function" class="headerlink" title="eBPF Helper Function"></a>eBPF Helper Function</h4><p>eBPF程序不能调用任意内核函数。如果允许这样做，会将eBPF程序绑定到特定的内核版本，并且会使程序的兼容性复杂化。相反，eBPF程序可以对helper函数进行函数调用，helper函数是内核提供的一种稳定的API。</p>
<p><img src="/2022/01/21/浅入浅出eBPF/5.png" alt="5"></p>
<p>一些可用于辅助调用的例子有</p>
<ul>
<li>生成随机数</li>
<li>获取当前时间和日期</li>
<li>eBPF map访问</li>
<li>获取进程/cgroup上下文</li>
<li>操作网络数据包和转发逻辑</li>
</ul>
<h4 id="BCC"><a href="#BCC" class="headerlink" title="BCC"></a>BCC</h4><h5 id="bcc介绍"><a href="#bcc介绍" class="headerlink" title="bcc介绍"></a>bcc介绍</h5><p>源码地址：<a href="https://github.com/iovisor/bcc" target="_blank" rel="noopener">https://github.com/iovisor/bcc</a></p>
<p>BCC工具全称BPF Compiler Collection (BCC)，是一个很强大的库，强大的内核分析工具eBPF就是基于bcc开发的，利用这个库可以从底层获取操作系统性能信息，网络性能信息等许多与内核交互的信息。bcc使得bpf程序更容易被书写，bcc使用 Python和Lua，虽然核心依旧是一部分C语言代码（BPF C代码）。但是我们很快就可以体验了，这比手动安装 C 语言依赖、编译、插入内核要方便的多。</p>
<h5 id="bcc-tools安装"><a href="#bcc-tools安装" class="headerlink" title="bcc-tools安装"></a>bcc-tools安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install bcc-tools</span><br></pre></td></tr></table></figure>
<h5 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h5><p>代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">BPF(text=<span class="string">'int kprobe__sys_clone(void *ctx)&#123;bpf_trace_printk("Hello,World!\\n"); return 0;&#125;'</span>).trace_print()</span><br></pre></td></tr></table></figure>
<p>执行如下</p>
<p><img src="/2022/01/21/浅入浅出eBPF/4.png" alt="4"></p>
<p>分析如下</p>
<ul>
<li><p>text定义了一个嵌入的用C语言写的BPF程序</p>
</li>
<li><p><code>kprobe__sys_clone()</code>是一个通过内核探针(kprobe)进行内核动态跟踪的快捷方式。如果一个C函数名开头为<code>kprobe__</code>，则后面部分实际为设备的内核函数名，这里是<code>sys_clone()</code></p>
</li>
<li><p><code>bpf_trace_printk()</code>用于<code>printf()</code>到<code>trace_pipe</code>。一般用来快速调试</p>
</li>
<li><p><code>return 0</code>用来关闭凭证</p>
</li>
<li><p><code>.trace_print()</code>，一个bcc实例会通过这个读取<code>trace_pipe</code>并打印</p>
</li>
</ul>
<p>未完待续。。。</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://ebpf.io/what-is-ebpf/" target="_blank" rel="noopener">https://ebpf.io/what-is-ebpf/</a></li>
<li><a href="https://www.dazhuanlan.com/lganlan/topics/1072521" target="_blank" rel="noopener">https://www.dazhuanlan.com/lganlan/topics/1072521</a></li>
<li><a href="https://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/" target="_blank" rel="noopener">https://arthurchiao.art/blog/cilium-bpf-xdp-reference-guide-zh/</a></li>
<li><a href="https://jishuin.proginn.com/p/763bfbd6368e" target="_blank" rel="noopener">https://jishuin.proginn.com/p/763bfbd6368e</a></li>
<li><a href="https://forsworns.github.io/zh/blogs/20210311/" target="_blank" rel="noopener">https://forsworns.github.io/zh/blogs/20210311/</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/01/16/Leetcode第276场周赛write-up/" rel="next" title="Leetcode第276场周赛write up">
                <i class="fa fa-chevron-left"></i> Leetcode第276场周赛write up
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/author1.png" alt="elssm">
            
              <p class="site-author-name" itemprop="name">elssm</p>
              <p class="site-description motion-element" itemprop="description">web安全 对抗攻击 go/python</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">67</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/elssm" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://elssm.lofter.com" target="_blank" title="Lofter">
                      
                        <i class="fa fa-fw fa-globe"></i>Lofter</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BPF发展史"><span class="nav-number">2.</span> <span class="nav-text">BPF发展史</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BPF介绍"><span class="nav-number">3.</span> <span class="nav-text">BPF介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eBPF介绍"><span class="nav-number">4.</span> <span class="nav-text">eBPF介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eBPF对比cBPF"><span class="nav-number">5.</span> <span class="nav-text">eBPF对比cBPF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eBPF工作机制"><span class="nav-number">6.</span> <span class="nav-text">eBPF工作机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eBPF使用场景"><span class="nav-number">7.</span> <span class="nav-text">eBPF使用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eBPF-hooks"><span class="nav-number">8.</span> <span class="nav-text">eBPF hooks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eBPF-Map"><span class="nav-number">9.</span> <span class="nav-text">eBPF Map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eBPF-Helper-Function"><span class="nav-number">10.</span> <span class="nav-text">eBPF Helper Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BCC"><span class="nav-number">11.</span> <span class="nav-text">BCC</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#bcc介绍"><span class="nav-number">11.1.</span> <span class="nav-text">bcc介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bcc-tools安装"><span class="nav-number">11.2.</span> <span class="nav-text">bcc-tools安装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HelloWorld"><span class="nav-number">11.3.</span> <span class="nav-text">HelloWorld</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考"><span class="nav-number">12.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">elssm</span>

  
</div>






  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div>



<span id="busuanzi_container_site_pv" class="theme-info">
&nbsp;&nbsp;|&nbsp;&nbsp;本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
  <span id="busuanzi_container_site_uv" class="theme-info">
&nbsp;&nbsp;|&nbsp;&nbsp;本站访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->



  


  




	





  





  












  





  

  

  

  
  

  
  


  

  

</body>
</html>
